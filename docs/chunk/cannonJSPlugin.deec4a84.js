import{L as A}from"./precisionDate.1704d4c6.js";import{Vector3 as y,Matrix as J,Quaternion as P}from"./math.vector.560c6bc4.js";import{V as O}from"./math.plane.7ea68d04.js";import{P as d}from"./physicsImpostor.c9d13e49.js";import{P as B}from"./physicsJoint.0bac1769.js";import{P as w}from"./physicsEngine.af082a14.js";import"./performanceConfigurator.ee04355d.js";import"./arrayTools.49279cc5.js";import"./decorators.5af14a95.js";import"./math.color.d29cb8ed.js";import"./abstractMesh.d4d5c19c.js";import"./engine.535c373a.js";import"./perfCounter.4442bbd7.js";import"./engine.dynamicBuffer.fe9de623.js";import"./node.3cceef8b.js";import"./math.axis.43721c0c.js";import"./scene.7f90ce88.js";import"./lightConstants.176abcb0.js";import"./boundingInfo.26e5828d.js";import"./math.functions.3c8565ae.js";import"./mesh.51493cf6.js";import"./material.ddd1f5e1.js";import"./materialHelper.8edca65e.js";import"./thinMaterialHelper.ab1f33f5.js";var R=function(){function n(){this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=y.Zero(),this._hitPointWorld=y.Zero(),this._rayFromWorld=y.Zero(),this._rayToWorld=y.Zero()}return Object.defineProperty(n.prototype,"hasHit",{get:function(){return this._hasHit},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"hitDistance",{get:function(){return this._hitDistance},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"hitNormalWorld",{get:function(){return this._hitNormalWorld},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"hitPointWorld",{get:function(){return this._hitPointWorld},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rayFromWorld",{get:function(){return this._rayFromWorld},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rayToWorld",{get:function(){return this._rayToWorld},enumerable:!1,configurable:!0}),n.prototype.setHitData=function(t,e){this._hasHit=!0,this._hitNormalWorld=new y(t.x,t.y,t.z),this._hitPointWorld=new y(e.x,e.y,e.z)},n.prototype.setHitDistance=function(t){this._hitDistance=t},n.prototype.calculateHitDistance=function(){this._hitDistance=y.Distance(this._rayFromWorld,this._hitPointWorld)},n.prototype.reset=function(t,e){t===void 0&&(t=y.Zero()),e===void 0&&(e=y.Zero()),this._rayFromWorld=t,this._rayToWorld=e,this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=y.Zero(),this._hitPointWorld=y.Zero()},n}(),Q=function(){function n(t,e,i){if(t===void 0&&(t=!0),e===void 0&&(e=10),i===void 0&&(i=CANNON),this._useDeltaForWorldStep=t,this.name="CannonJSPlugin",this._physicsMaterials=new Array,this._fixedTimeStep=1/60,this._physicsBodiesToRemoveAfterStep=new Array,this._firstFrame=!0,this._tmpQuaternion=new P,this._minus90X=new P(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new P(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=y.Zero(),this._tmpDeltaPosition=y.Zero(),this._tmpUnityRotation=new P,this.BJSCANNON=i,!this.isSupported()){A.Error("CannonJS is not available. Please make sure you included the js file.");return}this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=e,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new R}return n.prototype.setGravity=function(t){var e=t;this.world.gravity.set(e.x,e.y,e.z)},n.prototype.setTimeStep=function(t){this._fixedTimeStep=t},n.prototype.getTimeStep=function(){return this._fixedTimeStep},n.prototype.executeStep=function(t,e){if(this._firstFrame){this._firstFrame=!1;for(var i=0,r=e;i<r.length;i++){var o=r[i];o.type==d.HeightmapImpostor||o.type===d.PlaneImpostor||o.beforeStep()}}this.world.step(this._useDeltaForWorldStep?t:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()},n.prototype._removeMarkedPhysicsBodiesFromWorld=function(){var t=this;this._physicsBodiesToRemoveAfterStep.length>0&&(this._physicsBodiesToRemoveAfterStep.forEach(function(e){typeof t.world.removeBody=="function"?t.world.removeBody(e):t.world.remove(e)}),this._physicsBodiesToRemoveAfterStep.length=0)},n.prototype.applyImpulse=function(t,e,i){var r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),o=new this.BJSCANNON.Vec3(e.x,e.y,e.z);t.physicsBody.applyImpulse(o,r)},n.prototype.applyForce=function(t,e,i){var r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),o=new this.BJSCANNON.Vec3(e.x,e.y,e.z);t.physicsBody.applyForce(o,r)},n.prototype.generatePhysicsBody=function(t){if(this._removeMarkedPhysicsBodiesFromWorld(),t.parent){t.physicsBody&&(this.removePhysicsBody(t),t.forceUpdate());return}if(t.isBodyInitRequired()){var e=this._createShape(t);if(!e){A.Warn("It was not possible to create a physics body for this object.");return}var i=t.physicsBody;i&&this.removePhysicsBody(t);var r=this._addMaterial("mat-"+t.uniqueId,t.getParam("friction"),t.getParam("restitution")),o={mass:t.getParam("mass"),material:r},s=t.getParam("nativeOptions");for(var a in s)Object.prototype.hasOwnProperty.call(s,a)&&(o[a]=s[a]);t.physicsBody=new this.BJSCANNON.Body(o),t.physicsBody.addEventListener("collide",t.onCollide),this.world.addEventListener("preStep",t.beforeStep),this.world.addEventListener("postStep",t.afterStep),t.physicsBody.addShape(e),typeof this.world.addBody=="function"?this.world.addBody(t.physicsBody):this.world.add(t.physicsBody),i&&["force","torque","velocity","angularVelocity"].forEach(function(p){var h=i[p];t.physicsBody[p].set(h.x,h.y,h.z)}),this._processChildMeshes(t)}this._updatePhysicsBodyTransformation(t)},n.prototype._processChildMeshes=function(t){var e=this,i=t.object.getChildMeshes?t.object.getChildMeshes(!0):[],r=t.object.rotationQuaternion;if(r?r.conjugateToRef(this._tmpQuaternion):this._tmpQuaternion.set(0,0,0,1),i.length){var o=function(s){if(!!s.rotationQuaternion){var a=s.getPhysicsImpostor();if(a){var p=a.parent;if(p!==t&&s.parent){var h=s.getAbsolutePosition().subtract(s.parent.getAbsolutePosition()),v=s.rotationQuaternion.multiply(e._tmpQuaternion);a.physicsBody&&(e.removePhysicsBody(a),a.physicsBody=null),a.parent=t,a.resetUpdateFlags(),t.physicsBody.addShape(e._createShape(a),new e.BJSCANNON.Vec3(h.x,h.y,h.z),new e.BJSCANNON.Quaternion(v.x,v.y,v.z,v.w)),t.physicsBody.mass+=a.getParam("mass")}}s.getChildMeshes(!0).filter(function(l){return!!l.physicsImpostor}).forEach(o)}};i.filter(function(s){return!!s.physicsImpostor}).forEach(o)}},n.prototype.removePhysicsBody=function(t){t.physicsBody.removeEventListener("collide",t.onCollide),this.world.removeEventListener("preStep",t.beforeStep),this.world.removeEventListener("postStep",t.afterStep),this._physicsBodiesToRemoveAfterStep.indexOf(t.physicsBody)===-1&&this._physicsBodiesToRemoveAfterStep.push(t.physicsBody)},n.prototype.generateJoint=function(t){var e=t.mainImpostor.physicsBody,i=t.connectedImpostor.physicsBody;if(!(!e||!i)){var r,o=t.joint.jointData,s={pivotA:o.mainPivot?new this.BJSCANNON.Vec3().set(o.mainPivot.x,o.mainPivot.y,o.mainPivot.z):null,pivotB:o.connectedPivot?new this.BJSCANNON.Vec3().set(o.connectedPivot.x,o.connectedPivot.y,o.connectedPivot.z):null,axisA:o.mainAxis?new this.BJSCANNON.Vec3().set(o.mainAxis.x,o.mainAxis.y,o.mainAxis.z):null,axisB:o.connectedAxis?new this.BJSCANNON.Vec3().set(o.connectedAxis.x,o.connectedAxis.y,o.connectedAxis.z):null,maxForce:o.nativeParams.maxForce,collideConnected:!!o.collision};switch(t.joint.type){case B.HingeJoint:case B.Hinge2Joint:r=new this.BJSCANNON.HingeConstraint(e,i,s);break;case B.DistanceJoint:r=new this.BJSCANNON.DistanceConstraint(e,i,o.maxDistance||2);break;case B.SpringJoint:{var a=o;r=new this.BJSCANNON.Spring(e,i,{restLength:a.length,stiffness:a.stiffness,damping:a.damping,localAnchorA:s.pivotA,localAnchorB:s.pivotB});break}case B.LockJoint:r=new this.BJSCANNON.LockConstraint(e,i,s);break;case B.PointToPointJoint:case B.BallAndSocketJoint:default:r=new this.BJSCANNON.PointToPointConstraint(e,s.pivotA,i,s.pivotB,s.maxForce);break}r.collideConnected=!!o.collision,t.joint.physicsJoint=r,t.joint.type!==B.SpringJoint?this.world.addConstraint(r):(t.joint.jointData.forceApplicationCallback=t.joint.jointData.forceApplicationCallback||function(){r.applyForce()},t.mainImpostor.registerAfterPhysicsStep(t.joint.jointData.forceApplicationCallback))}},n.prototype.removeJoint=function(t){t.joint.type!==B.SpringJoint?this.world.removeConstraint(t.joint.physicsJoint):t.mainImpostor.unregisterAfterPhysicsStep(t.joint.jointData.forceApplicationCallback)},n.prototype._addMaterial=function(t,e,i){var r,o;for(r=0;r<this._physicsMaterials.length;r++)if(o=this._physicsMaterials[r],o.friction===e&&o.restitution===i)return o;var s=new this.BJSCANNON.Material(t);return s.friction=e,s.restitution=i,this._physicsMaterials.push(s),s},n.prototype._checkWithEpsilon=function(t){return t<w.Epsilon?w.Epsilon:t},n.prototype._createShape=function(t){var e=t.object,i,r=t.getObjectExtents();switch(t.type){case d.SphereImpostor:{var o=r.x,s=r.y,a=r.z;i=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(o),this._checkWithEpsilon(s),this._checkWithEpsilon(a))/2);break}case d.CylinderImpostor:{var p=t.getParam("nativeOptions");p||(p={});var h=p.radiusTop!==void 0?p.radiusTop:this._checkWithEpsilon(r.x)/2,v=p.radiusBottom!==void 0?p.radiusBottom:this._checkWithEpsilon(r.x)/2,l=p.height!==void 0?p.height:this._checkWithEpsilon(r.y),m=p.numSegments!==void 0?p.numSegments:16;i=new this.BJSCANNON.Cylinder(h,v,l,m);var f=new this.BJSCANNON.Quaternion;f.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);var c=new this.BJSCANNON.Vec3(0,0,0);i.transformAllPoints(c,f);break}case d.BoxImpostor:{var u=r.scale(.5);i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(u.x),this._checkWithEpsilon(u.y),this._checkWithEpsilon(u.z)));break}case d.PlaneImpostor:A.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),i=new this.BJSCANNON.Plane;break;case d.MeshImpostor:{var g=e.getVerticesData?e.getVerticesData(O.PositionKind):[],N=e.getIndices?e.getIndices():[];if(!g){A.Warn("Tried to create a MeshImpostor for an object without vertices. This will fail.");return}var _=e.position.clone(),x=e.rotation&&e.rotation.clone(),C=e.rotationQuaternion&&e.rotationQuaternion.clone();e.position.copyFromFloats(0,0,0),e.rotation&&e.rotation.copyFromFloats(0,0,0),e.rotationQuaternion&&e.rotationQuaternion.copyFrom(t.getParentsRotation()),e.rotationQuaternion&&e.parent&&e.rotationQuaternion.conjugateInPlace();var M=e.computeWorldMatrix(!0),W=new Array,S=void 0;for(S=0;S<g.length;S+=3)y.TransformCoordinates(y.FromArray(g,S),M).toArray(W,S);A.Warn("MeshImpostor only collides against spheres."),i=new this.BJSCANNON.Trimesh(W,N),e.position.copyFrom(_),x&&e.rotation&&e.rotation.copyFrom(x),C&&e.rotationQuaternion&&e.rotationQuaternion.copyFrom(C);break}case d.HeightmapImpostor:{var F=e.position.clone(),b=e.rotation&&e.rotation.clone(),z=e.rotationQuaternion&&e.rotationQuaternion.clone();e.position.copyFromFloats(0,0,0),e.rotation&&e.rotation.copyFromFloats(0,0,0),e.rotationQuaternion&&e.rotationQuaternion.copyFrom(t.getParentsRotation()),e.rotationQuaternion&&e.parent&&e.rotationQuaternion.conjugateInPlace(),e.rotationQuaternion&&e.rotationQuaternion.multiplyInPlace(this._minus90X),i=this._createHeightmap(e),e.position.copyFrom(F),b&&e.rotation&&e.rotation.copyFrom(b),z&&e.rotationQuaternion&&e.rotationQuaternion.copyFrom(z),e.computeWorldMatrix(!0);break}case d.ParticleImpostor:i=new this.BJSCANNON.Particle;break;case d.NoImpostor:i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0));break}return i},n.prototype._createHeightmap=function(t,e){var i=t.getVerticesData(O.PositionKind),r=t.computeWorldMatrix(!0),o=new Array,s;for(s=0;s<i.length;s+=3)y.TransformCoordinates(y.FromArray(i,s),r).toArray(o,s);i=o;for(var a=new Array,p=e||~~(Math.sqrt(i.length/3)-1),h=t.getBoundingInfo(),v=Math.min(h.boundingBox.extendSizeWorld.x,h.boundingBox.extendSizeWorld.y),l=h.boundingBox.extendSizeWorld.z,m=v*2/p,f=0;f<i.length;f=f+3){var c=Math.round(i[f+0]/m+p/2),u=Math.round((i[f+1]/m-p/2)*-1),g=-i[f+2]+l;a[c]||(a[c]=[]),a[c][u]||(a[c][u]=g),a[c][u]=Math.max(g,a[c][u])}for(var c=0;c<=p;++c){if(!a[c]){for(var N=1;!a[(c+N)%p];)N++;a[c]=a[(c+N)%p].slice()}for(var u=0;u<=p;++u)if(!a[c][u]){for(var N=1,_=void 0;_===void 0;)_=a[c][(u+N++)%p];a[c][u]=_}}var x=new this.BJSCANNON.Heightfield(a,{elementSize:m});return x.minY=l,x},n.prototype._updatePhysicsBodyTransformation=function(t){var e=t.object;if(e.computeWorldMatrix&&e.computeWorldMatrix(!0),!!e.getBoundingInfo()){var i=t.getObjectCenter();this._tmpDeltaPosition.copyFrom(e.getAbsolutePivotPoint().subtract(i)),this._tmpDeltaPosition.divideInPlace(t.object.scaling),this._tmpPosition.copyFrom(i);var r=e.rotationQuaternion;if(!!r){if((t.type===d.PlaneImpostor||t.type===d.HeightmapImpostor)&&(r=r.multiply(this._minus90X),t.setDeltaRotation(this._plus90X)),t.type===d.HeightmapImpostor){var o=e,s=o.getBoundingInfo(),a=o.rotationQuaternion;o.rotationQuaternion=this._tmpUnityRotation,o.computeWorldMatrix(!0);var p=i.clone(),h=o.getPivotMatrix();h?h=h.clone():h=J.Identity();var v=J.Translation(s.boundingBox.extendSizeWorld.x,0,-s.boundingBox.extendSizeWorld.z);o.setPreTransformMatrix(v),o.computeWorldMatrix(!0),s=o.getBoundingInfo();var l=s.boundingBox.centerWorld.subtract(i).subtract(o.position).negate();this._tmpPosition.copyFromFloats(l.x,l.y-s.boundingBox.extendSizeWorld.y,l.z),this._tmpDeltaPosition.copyFrom(s.boundingBox.centerWorld.subtract(p)),this._tmpDeltaPosition.y+=s.boundingBox.extendSizeWorld.y,o.rotationQuaternion=a,o.setPreTransformMatrix(h),o.computeWorldMatrix(!0)}else t.type===d.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);t.setDeltaPosition(this._tmpDeltaPosition),t.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),t.physicsBody.quaternion.set(r.x,r.y,r.z,r.w)}}},n.prototype.setTransformationFromPhysicsBody=function(t){if(t.object.position.set(t.physicsBody.position.x,t.physicsBody.position.y,t.physicsBody.position.z),t.object.rotationQuaternion){var e=t.physicsBody.quaternion;t.object.rotationQuaternion.set(e.x,e.y,e.z,e.w)}},n.prototype.setPhysicsBodyTransformation=function(t,e,i){t.physicsBody.position.set(e.x,e.y,e.z),t.physicsBody.quaternion.set(i.x,i.y,i.z,i.w)},n.prototype.isSupported=function(){return this.BJSCANNON!==void 0},n.prototype.setLinearVelocity=function(t,e){t.physicsBody.velocity.set(e.x,e.y,e.z)},n.prototype.setAngularVelocity=function(t,e){t.physicsBody.angularVelocity.set(e.x,e.y,e.z)},n.prototype.getLinearVelocity=function(t){var e=t.physicsBody.velocity;return e?new y(e.x,e.y,e.z):null},n.prototype.getAngularVelocity=function(t){var e=t.physicsBody.angularVelocity;return e?new y(e.x,e.y,e.z):null},n.prototype.setBodyMass=function(t,e){t.physicsBody.mass=e,t.physicsBody.updateMassProperties()},n.prototype.getBodyMass=function(t){return t.physicsBody.mass},n.prototype.getBodyFriction=function(t){return t.physicsBody.material.friction},n.prototype.setBodyFriction=function(t,e){t.physicsBody.material.friction=e},n.prototype.getBodyRestitution=function(t){return t.physicsBody.material.restitution},n.prototype.setBodyRestitution=function(t,e){t.physicsBody.material.restitution=e},n.prototype.sleepBody=function(t){t.physicsBody.sleep()},n.prototype.wakeUpBody=function(t){t.physicsBody.wakeUp()},n.prototype.updateDistanceJoint=function(t,e){t.physicsJoint.distance=e},n.prototype.setMotor=function(t,e,i,r){r||(t.physicsJoint.enableMotor(),t.physicsJoint.setMotorSpeed(e),i&&this.setLimit(t,i))},n.prototype.setLimit=function(t,e,i){t.physicsJoint.motorEquation.maxForce=i,t.physicsJoint.motorEquation.minForce=e===void 0?-e:e},n.prototype.syncMeshWithImpostor=function(t,e){var i=e.physicsBody;t.position.x=i.position.x,t.position.y=i.position.y,t.position.z=i.position.z,t.rotationQuaternion&&(t.rotationQuaternion.x=i.quaternion.x,t.rotationQuaternion.y=i.quaternion.y,t.rotationQuaternion.z=i.quaternion.z,t.rotationQuaternion.w=i.quaternion.w)},n.prototype.getRadius=function(t){var e=t.physicsBody.shapes[0];return e.boundingSphereRadius},n.prototype.getBoxSizeToRef=function(t,e){var i=t.physicsBody.shapes[0];e.x=i.halfExtents.x*2,e.y=i.halfExtents.y*2,e.z=i.halfExtents.z*2},n.prototype.dispose=function(){},n.prototype._extendNamespace=function(){var t=new this.BJSCANNON.Vec3,e=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(i,r,o){if(o=o||10,r=r||0,r===0)this.internalStep(i),this.time+=i;else{var s=Math.floor((this.time+r)/i)-Math.floor(this.time/i);s=Math.min(s,o)||1;for(var a=performance.now(),p=0;p!==s&&(this.internalStep(i),!(performance.now()-a>i*1e3));p++);this.time+=r;for(var h=this.time%i,v=h/i,l=t,m=this.bodies,f=0;f!==m.length;f++){var c=m[f];c.type!==e.Body.STATIC&&c.sleepState!==e.Body.SLEEPING?(c.position.vsub(c.previousPosition,l),l.scale(v,l),c.position.vadd(l,c.interpolatedPosition)):(c.interpolatedPosition.set(c.position.x,c.position.y,c.position.z),c.interpolatedQuaternion.set(c.quaternion.x,c.quaternion.y,c.quaternion.z,c.quaternion.w))}}}},n.prototype.raycast=function(t,e){return this._cannonRaycastResult.reset(),this.world.raycastClosest(t,e,{},this._cannonRaycastResult),this._raycastResult.reset(t,e),this._cannonRaycastResult.hasHit&&(this._raycastResult.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),this._raycastResult.setHitDistance(this._cannonRaycastResult.distance)),this._raycastResult},n}();w.DefaultPluginFactory=function(){return new Q};export{Q as CannonJSPlugin};
