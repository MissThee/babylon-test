import{ad as N,_ as $,ab as B,ac as oe,L as X,u as Y,af as fe,j as V,m as de,O as y,V as F,ag as j,M as D,a1 as M,w as ne,S as K,G as pe,e as O,g as R,ah as ce,k as le,p as W,t as he,Z as _e,a as C,b as ge,C as se}from"./test1.990751a6.js";import{L as ae}from"./light.40a4b08b.js";import{M as L}from"./materialHelper.19d69264.js";import{T as m}from"./clipPlaneVertex.58e6a1d5.js";import{E as ve}from"./effectFallbacks.db57095f.js";var Se=function(){function i(e,t,r,n){this._textures=null,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this._isMulti=e,this._isCube=t,this._size=r,this._engine=n,this._depthStencilTexture=null}return Object.defineProperty(i.prototype,"depthStencilTexture",{get:function(){return this._depthStencilTexture},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"depthStencilTextureWithStencil",{get:function(){return this._depthStencilTextureWithStencil},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isCube",{get:function(){return this._isCube},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isMulti",{get:function(){return this._isMulti},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"is2DArray",{get:function(){return this.layers>0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"size",{get:function(){return this.width},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"width",{get:function(){return this._size.width||this._size},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"height",{get:function(){return this._size.height||this._size},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"layers",{get:function(){return this._size.layers||0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"texture",{get:function(){var e,t;return(t=(e=this._textures)===null||e===void 0?void 0:e[0])!==null&&t!==void 0?t:null},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"textures",{get:function(){return this._textures},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"samples",{get:function(){var e,t;return(t=(e=this.texture)===null||e===void 0?void 0:e.samples)!==null&&t!==void 0?t:1},enumerable:!1,configurable:!0}),i.prototype.setSamples=function(e,t,r){return t===void 0&&(t=!0),r===void 0&&(r=!1),this.samples===e&&!r?e:this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e)},i.prototype.setTextures=function(e){Array.isArray(e)?this._textures=e:e?this._textures=[e]:this._textures=null},i.prototype.setTexture=function(e,t,r){t===void 0&&(t=0),r===void 0&&(r=!0),this._textures||(this._textures=[]),this._textures[t]&&r&&this._textures[t].dispose(),this._textures[t]=e},i.prototype.createDepthStencilTexture=function(e,t,r,n,s){var a;return e===void 0&&(e=0),t===void 0&&(t=!0),r===void 0&&(r=!1),n===void 0&&(n=1),s===void 0&&(s=14),(a=this._depthStencilTexture)===null||a===void 0||a.dispose(),this._depthStencilTextureWithStencil=r,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:r,isCube:this._isCube,samples:n,depthTextureFormat:s},this),this._depthStencilTexture},i.prototype._shareDepth=function(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,this._depthStencilTexture.incrementReferences())},i.prototype._swapAndDie=function(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)},i.prototype._cloneRenderTargetWrapper=function(){var e,t,r,n,s,a,o=null;if(this._isMulti){var h=this.textures;if(h&&h.length>0){var l=!1,p=h.length,c=h[h.length-1]._source;(c===N.Depth||c===N.DepthStencil)&&(l=!0,p--);for(var _=[],f=[],d=0;d<p;++d){var v=h[d];_.push(v.samplingMode),f.push(v.type)}var S={samplingModes:_,generateMipMaps:h[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:l,types:f,textureCount:p},g={width:this.width,height:this.height};o=this._engine.createMultipleRenderTarget(g,S)}}else{var b={};if(b.generateDepthBuffer=this._generateDepthBuffer,b.generateMipMaps=(t=(e=this.texture)===null||e===void 0?void 0:e.generateMipMaps)!==null&&t!==void 0?t:!1,b.generateStencilBuffer=this._generateStencilBuffer,b.samplingMode=(r=this.texture)===null||r===void 0?void 0:r.samplingMode,b.type=(n=this.texture)===null||n===void 0?void 0:n.type,b.format=(s=this.texture)===null||s===void 0?void 0:s.format,this.isCube)o=this._engine.createRenderTargetCubeTexture(this.width,b);else{var g={width:this.width,height:this.height,layers:this.is2DArray?(a=this.texture)===null||a===void 0?void 0:a.depth:void 0};o=this._engine.createRenderTargetTexture(g,b)}o.texture.isReady=!0}return o},i.prototype._swapRenderTargetWrapper=function(e){if(this._textures&&e._textures)for(var t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null},i.prototype._rebuild=function(){var e=this._cloneRenderTargetWrapper();if(!!e){if(this._depthStencilTexture){var t=this._depthStencilTexture.samplingMode,r=t===2||t===3||t===11;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,r,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}},i.prototype.releaseTextures=function(){var e,t;if(this._textures)for(var r=0;(t=r<((e=this._textures)===null||e===void 0?void 0:e.length))!==null&&t!==void 0&&t;++r)this._textures[r].dispose();this._textures=null},i.prototype.dispose=function(e){var t;e===void 0&&(e=!1),e||((t=this._depthStencilTexture)===null||t===void 0||t.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)},i}(),be=function(i){$(e,i);function e(t,r,n,s,a){var o=i.call(this,t,r,n,s)||this;return o._framebuffer=null,o._depthStencilBuffer=null,o._MSAAFramebuffer=null,o._colorTextureArray=null,o._depthStencilTextureArray=null,o._context=a,o}return e.prototype._cloneRenderTargetWrapper=function(){var t=null;return this._colorTextureArray&&this._depthStencilTextureArray?(t=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),t.texture.isReady=!0):t=i.prototype._cloneRenderTargetWrapper.call(this),t},e.prototype._swapRenderTargetWrapper=function(t){i.prototype._swapRenderTargetWrapper.call(this,t),t._framebuffer=this._framebuffer,t._depthStencilBuffer=this._depthStencilBuffer,t._MSAAFramebuffer=this._MSAAFramebuffer,t._colorTextureArray=this._colorTextureArray,t._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null},e.prototype._shareDepth=function(t){i.prototype._shareDepth.call(this,t);var r=this._context,n=this._depthStencilBuffer,s=t._framebuffer;t._depthStencilBuffer&&r.deleteRenderbuffer(t._depthStencilBuffer),t._depthStencilBuffer=this._depthStencilBuffer,this._engine._bindUnboundFramebuffer(s),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,n),this._engine._bindUnboundFramebuffer(null)},e.prototype._bindTextureRenderTarget=function(t,r,n,s){if(r===void 0&&(r=0),n===void 0&&(n=-1),s===void 0&&(s=0),!!t._hardwareTexture){var a=this._context,o=this._framebuffer,h=this._engine._currentFramebuffer;this._engine._bindUnboundFramebuffer(o);var l=a[this._engine.webGLVersion>1?"COLOR_ATTACHMENT"+r:"COLOR_ATTACHMENT"+r+"_WEBGL"],p=n!==-1?a.TEXTURE_CUBE_MAP_POSITIVE_X+n:a.TEXTURE_2D;a.framebufferTexture2D(a.FRAMEBUFFER,l,p,t._hardwareTexture.underlyingResource,s),this._engine._bindUnboundFramebuffer(h)}},e.prototype.setTexture=function(t,r,n){r===void 0&&(r=0),n===void 0&&(n=!0),i.prototype.setTexture.call(this,t,r,n),this._bindTextureRenderTarget(t,r)},e.prototype.dispose=function(t){t===void 0&&(t=!1);var r=this._context;t||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(r.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(r.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(r.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),i.prototype.dispose.call(this,t)},e}(Se);B.prototype._createHardwareRenderTargetWrapper=function(i,e,t){var r=new be(i,e,t,this,this._gl);return this._renderTargetWrapperCache.push(r),r};B.prototype.createRenderTargetTexture=function(i,e){var t=this._createHardwareRenderTargetWrapper(!1,!1,i),r={};e!==void 0&&typeof e=="object"?(r.generateDepthBuffer=!!e.generateDepthBuffer,r.generateStencilBuffer=!!e.generateStencilBuffer,r.noColorTarget=!!e.noColorTarget):(r.generateDepthBuffer=!0,r.generateStencilBuffer=!1,r.noColorTarget=!1);var n=r.noColorTarget?null:this._createInternalTexture(i,e,!0,N.RenderTarget),s=i.width||i,a=i.height||i,o=this._currentFramebuffer,h=this._gl,l=h.createFramebuffer();return this._bindUnboundFramebuffer(l),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(!!r.generateStencilBuffer,r.generateDepthBuffer,s,a),n&&!n.is2DArray&&h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,n._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(o),t._framebuffer=l,t._generateDepthBuffer=r.generateDepthBuffer,t._generateStencilBuffer=!!r.generateStencilBuffer,t.setTextures(n),t};B.prototype.createDepthStencilTexture=function(i,e,t){if(e.isCube){var r=i.width||i;return this._createDepthStencilCubeTexture(r,e,t)}else return this._createDepthStencilTexture(i,e,t)};B.prototype._createDepthStencilTexture=function(i,e,t){var r=this._gl,n=i.layers||0,s=n!==0?r.TEXTURE_2D_ARRAY:r.TEXTURE_2D,a=new oe(this,N.DepthStencil);if(!this._caps.depthTextureExtension)return X.Error("Depth texture is not supported by your browser or hardware."),a;var o=Y({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},e);if(this._bindTextureDirectly(s,a,!0),this._setupDepthStencilTexture(a,i,o.generateStencil,o.comparisonFunction===0?!1:o.bilinearFiltering,o.comparisonFunction),o.depthTextureFormat!==void 0){if(o.depthTextureFormat!==15&&o.depthTextureFormat!==16&&o.depthTextureFormat!==17&&o.depthTextureFormat!==13&&o.depthTextureFormat!==14&&o.depthTextureFormat!==18)return X.Error("Depth texture format is not supported."),a;a.format=o.depthTextureFormat}else a.format=o.generateStencil?13:16;var h=a.format===17||a.format===13||a.format===18;t._depthStencilTexture=a,t._depthStencilTextureWithStencil=h;var l=r.UNSIGNED_INT;a.format===15?l=r.UNSIGNED_SHORT:a.format===17||a.format===13?l=r.UNSIGNED_INT_24_8:a.format===14?l=r.FLOAT:a.format===18&&(l=r.FLOAT_32_UNSIGNED_INT_24_8_REV);var p=h?r.DEPTH_STENCIL:r.DEPTH_COMPONENT,c=p;this.webGLVersion>1&&(a.format===15?c=r.DEPTH_COMPONENT16:a.format===16?c=r.DEPTH_COMPONENT24:a.format===17||a.format===13?c=r.DEPTH24_STENCIL8:a.format===14?c=r.DEPTH_COMPONENT32F:a.format===18&&(c=r.DEPTH32F_STENCIL8)),a.is2DArray?r.texImage3D(s,0,c,a.width,a.height,n,0,p,l,null):r.texImage2D(s,0,c,a.width,a.height,0,p,l,null),this._bindTextureDirectly(s,null),this._internalTexturesCache.push(a);var _=t;if(_._depthStencilBuffer){var f=this._currentFramebuffer;this._bindUnboundFramebuffer(_._framebuffer),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,null),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,null),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.STENCIL_ATTACHMENT,r.RENDERBUFFER,null),this._bindUnboundFramebuffer(f),r.deleteRenderbuffer(_._depthStencilBuffer),_._depthStencilBuffer=null}return a};B.prototype.updateRenderTargetTextureSampleCount=function(i,e){if(this.webGLVersion<2||!i||!i.texture)return 1;if(i.samples===e)return e;var t=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),i._depthStencilBuffer&&(t.deleteRenderbuffer(i._depthStencilBuffer),i._depthStencilBuffer=null),i._MSAAFramebuffer&&(t.deleteFramebuffer(i._MSAAFramebuffer),i._MSAAFramebuffer=null);var r=i.texture._hardwareTexture;if(r._MSAARenderBuffer&&(t.deleteRenderbuffer(r._MSAARenderBuffer),r._MSAARenderBuffer=null),e>1&&t.renderbufferStorageMultisample){var n=t.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");i._MSAAFramebuffer=n,this._bindUnboundFramebuffer(i._MSAAFramebuffer);var s=this._createRenderBuffer(i.texture.width,i.texture.height,e,-1,this._getRGBAMultiSampleBufferFormat(i.texture.type),t.COLOR_ATTACHMENT0,!1);if(!s)throw new Error("Unable to create multi sampled framebuffer");r._MSAARenderBuffer=s}else this._bindUnboundFramebuffer(i._framebuffer);return i.texture.samples=e,i._depthStencilBuffer=this._setupFramebufferDepthAttachments(i._generateStencilBuffer,i._generateDepthBuffer,i.texture.width,i.texture.height,e),this._bindUnboundFramebuffer(null),e};B.prototype.createRenderTargetCubeTexture=function(i,e){var t=this._createHardwareRenderTargetWrapper(!1,!0,i),r=Y({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5},e);r.generateStencilBuffer=r.generateDepthBuffer&&r.generateStencilBuffer,(r.type===1&&!this._caps.textureFloatLinearFiltering||r.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(r.samplingMode=1);var n=this._gl,s=new oe(this,N.RenderTarget);this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,s,!0);var a=this._getSamplingParameters(r.samplingMode,r.generateMipMaps);r.type===1&&!this._caps.textureFloat&&(r.type=0,X.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MAG_FILTER,a.mag),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MIN_FILTER,a.min),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);for(var o=0;o<6;o++)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+o,0,this._getRGBABufferInternalSizedFormat(r.type,r.format),i,i,0,this._getInternalFormat(r.format),this._getWebGLTextureType(r.type),null);var h=n.createFramebuffer();return this._bindUnboundFramebuffer(h),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(r.generateStencilBuffer,r.generateDepthBuffer,i,i),r.generateMipMaps&&n.generateMipmap(n.TEXTURE_CUBE_MAP),this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),t._framebuffer=h,t._generateDepthBuffer=r.generateDepthBuffer,t._generateStencilBuffer=r.generateStencilBuffer,s.width=i,s.height=i,s.isReady=!0,s.isCube=!0,s.samples=1,s.generateMipMaps=r.generateMipMaps,s.samplingMode=r.samplingMode,s.type=r.type,s.format=r.format,this._internalTexturesCache.push(s),t.setTextures(s),t};var U=function(i){$(e,i);function e(t,r,n,s,a,o,h,l,p,c,_,f,d,v,S,g,b){a===void 0&&(a=!0),o===void 0&&(o=0),h===void 0&&(h=!1),l===void 0&&(l=m.TRILINEAR_SAMPLINGMODE),p===void 0&&(p=!0),c===void 0&&(c=!1),_===void 0&&(_=!1),f===void 0&&(f=5),d===void 0&&(d=!1),g===void 0&&(g=!1),b===void 0&&(b=!1);var u=this,T;if(u=i.call(this,null,n,!s,void 0,l,void 0,void 0,void 0,void 0,f)||this,u.renderParticles=!0,u.renderSprites=!1,u.ignoreCameraViewport=!1,u.onBeforeBindObservable=new y,u.onAfterUnbindObservable=new y,u.onBeforeRenderObservable=new y,u.onAfterRenderObservable=new y,u.onClearObservable=new y,u.onResizeObservable=new y,u._cleared=!1,u.skipInitialClear=!1,u._currentRefreshId=-1,u._refreshRate=1,u._samples=1,u._canRescale=!0,u._renderTarget=null,u.boundingBoxPosition=F.Zero(),n=u.getScene(),!n)return u;var E=u.getScene().getEngine();return u._coordinatesMode=m.PROJECTION_MODE,u.renderList=new Array,u.name=t,u.isRenderTarget=!0,u._initialSizeParameter=r,u._renderPassIds=[],u._isCubeData=h,u._processSizeParameter(r),u.renderPassId=u._renderPassIds[0],u._resizeObserver=E.onResizeObservable.add(function(){}),u._generateMipMaps=!!s,u._doNotChangeAspectRatio=a,u._renderingManager=new j(n),u._renderingManager._useSceneAutoClearSetup=!0,_||(u._renderTargetOptions={generateMipMaps:s,type:o,format:(T=u._format)!==null&&T!==void 0?T:void 0,samplingMode:u.samplingMode,generateDepthBuffer:p,generateStencilBuffer:c,samples:v,creationFlags:S,noColorTarget:g,useSRGBBuffer:b},u.samplingMode===m.NEAREST_SAMPLINGMODE&&(u.wrapU=m.CLAMP_ADDRESSMODE,u.wrapV=m.CLAMP_ADDRESSMODE),d||(h?(u._renderTarget=n.getEngine().createRenderTargetCubeTexture(u.getRenderSize(),u._renderTargetOptions),u.coordinatesMode=m.INVCUBIC_MODE,u._textureMatrix=D.Identity()):u._renderTarget=n.getEngine().createRenderTargetTexture(u._size,u._renderTargetOptions),u._texture=u._renderTarget.texture,v!==void 0&&(u.samples=v))),u}return Object.defineProperty(e.prototype,"renderList",{get:function(){return this._renderList},set:function(t){this._renderList=t,this._renderList&&this._hookArray(this._renderList)},enumerable:!1,configurable:!0}),e.prototype._hookArray=function(t){var r=this,n=t.push;t.push=function(){for(var a,o=[],h=0;h<arguments.length;h++)o[h]=arguments[h];var l=t.length===0,p=n.apply(t,o);return l&&((a=r.getScene())===null||a===void 0||a.meshes.forEach(function(c){c._markSubMeshesAsLightDirty()})),p};var s=t.splice;t.splice=function(a,o){var h,l=s.apply(t,[a,o]);return t.length===0&&((h=r.getScene())===null||h===void 0||h.meshes.forEach(function(p){p._markSubMeshesAsLightDirty()})),l}},Object.defineProperty(e.prototype,"postProcesses",{get:function(){return this._postProcesses},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_prePassEnabled",{get:function(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onAfterUnbind",{set:function(t){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onBeforeRender",{set:function(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onAfterRender",{set:function(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onClear",{set:function(t){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderPassIds",{get:function(){return this._renderPassIds},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentRefreshId",{get:function(){return this._currentRefreshId},enumerable:!1,configurable:!0}),e.prototype.setMaterialForRendering=function(t,r){var n;Array.isArray(t)?n=t:n=[t];for(var s=0;s<n.length;++s)for(var a=0;a<this._renderPassIds.length;++a)n[s].setMaterialForRenderPass(this._renderPassIds[a],r!==void 0?Array.isArray(r)?r[a]:r:void 0)},Object.defineProperty(e.prototype,"renderTargetOptions",{get:function(){return this._renderTargetOptions},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderTarget",{get:function(){return this._renderTarget},enumerable:!1,configurable:!0}),e.prototype._onRatioRescale=function(){this._sizeRatio&&this.resize(this._initialSizeParameter)},Object.defineProperty(e.prototype,"boundingBoxSize",{get:function(){return this._boundingBoxSize},set:function(t){if(!(this._boundingBoxSize&&this._boundingBoxSize.equals(t))){this._boundingBoxSize=t;var r=this.getScene();r&&r.markAllMaterialsAsDirty(1)}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthStencilTexture",{get:function(){var t,r;return(r=(t=this._renderTarget)===null||t===void 0?void 0:t._depthStencilTexture)!==null&&r!==void 0?r:null},enumerable:!1,configurable:!0}),e.prototype.createDepthStencilTexture=function(t,r,n,s,a){var o;t===void 0&&(t=0),r===void 0&&(r=!0),n===void 0&&(n=!1),s===void 0&&(s=1),a===void 0&&(a=14),(o=this._renderTarget)===null||o===void 0||o.createDepthStencilTexture(t,r,n,s,a)},e.prototype._releaseRenderPassId=function(){if(this._scene)for(var t=this._scene.getEngine(),r=0;r<this._renderPassIds.length;++r)t.releaseRenderPassId(this._renderPassIds[r]);this._renderPassIds=[]},e.prototype._createRenderPassId=function(){this._releaseRenderPassId();for(var t=this._scene.getEngine(),r=this._isCubeData?6:this.getRenderLayers()||1,n=0;n<r;++n)this._renderPassIds[n]=t.createRenderPassId("RenderTargetTexture - ".concat(this.name,"#").concat(n))},e.prototype._processSizeParameter=function(t){if(t.ratio){this._sizeRatio=t.ratio;var r=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(r.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(r.getRenderHeight(),this._sizeRatio)}}else this._size=t;this._createRenderPassId()},Object.defineProperty(e.prototype,"samples",{get:function(){var t,r;return(r=(t=this._renderTarget)===null||t===void 0?void 0:t.samples)!==null&&r!==void 0?r:this._samples},set:function(t){this._renderTarget&&(this._samples=this._renderTarget.setSamples(t))},enumerable:!1,configurable:!0}),e.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1},Object.defineProperty(e.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(t){this._refreshRate=t,this.resetRefreshCounter()},enumerable:!1,configurable:!0}),e.prototype.addPostProcess=function(t){if(!this._postProcessManager){var r=this.getScene();if(!r)return;this._postProcessManager=new fe(r),this._postProcesses=new Array}this._postProcesses.push(t),this._postProcesses[0].autoClear=!1},e.prototype.clearPostProcesses=function(t){if(t===void 0&&(t=!1),!!this._postProcesses){if(t)for(var r=0,n=this._postProcesses;r<n.length;r++){var s=n[r];s.dispose()}this._postProcesses=[]}},e.prototype.removePostProcess=function(t){if(!!this._postProcesses){var r=this._postProcesses.indexOf(t);r!==-1&&(this._postProcesses.splice(r,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}},e.prototype._shouldRender=function(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)},e.prototype.getRenderSize=function(){return this.getRenderWidth()},e.prototype.getRenderWidth=function(){return this._size.width?this._size.width:this._size},e.prototype.getRenderHeight=function(){return this._size.width?this._size.height:this._size},e.prototype.getRenderLayers=function(){var t=this._size.layers;return t||0},e.prototype.disableRescaling=function(){this._canRescale=!1},Object.defineProperty(e.prototype,"canRescale",{get:function(){return this._canRescale},enumerable:!1,configurable:!0}),e.prototype.scale=function(t){var r=Math.max(1,this.getRenderSize()*t);this.resize(r)},e.prototype.getReflectionTextureMatrix=function(){return this.isCube?this._textureMatrix:i.prototype.getReflectionTextureMatrix.call(this)},e.prototype.resize=function(t){var r,n=this.isCube;(r=this._renderTarget)===null||r===void 0||r.dispose(),this._renderTarget=null;var s=this.getScene();!s||(this._processSizeParameter(t),n?this._renderTarget=s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._renderTarget=s.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))},e.prototype.render=function(t,r){t===void 0&&(t=!1),r===void 0&&(r=!1),this._render(t,r)},e.prototype.isReadyForRendering=function(){return this._render(!1,!1,!0)},e.prototype._render=function(t,r,n){var s;t===void 0&&(t=!1),r===void 0&&(r=!1),n===void 0&&(n=!1);var a=this.getScene();if(!a)return n;var o=a.getEngine();if(this.useCameraPostProcesses!==void 0&&(t=this.useCameraPostProcesses),this._waitingRenderList){this.renderList=[];for(var h=0;h<this._waitingRenderList.length;h++){var l=this._waitingRenderList[h],p=a.getMeshById(l);p&&this.renderList.push(p)}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];var c=this.getScene();if(!c)return n;for(var _=c.meshes,h=0;h<_.length;h++){var p=_[h];this.renderListPredicate(p)&&this.renderList.push(p)}}var f=o.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);var d=(s=this.activeCamera)!==null&&s!==void 0?s:a.activeCamera;d&&(d!==a.activeCamera&&a.setTransformMatrix(d.getViewMatrix(),d.getProjectionMatrix(!0)),o.setViewport(d.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;var v=n;if(n){a.getViewMatrix()||a.updateTransformMatrix();for(var b=this.is2DArray?this.getRenderLayers():this.isCube?6:1,S=0;S<b&&v;S++){var u=null,T=this.renderList?this.renderList:a.getActiveMeshes().data,E=this.renderList?this.renderList.length:a.getActiveMeshes().length;o.currentRenderPassId=this._renderPassIds[S],this.onBeforeRenderObservable.notifyObservers(S),this.getCustomRenderList&&(u=this.getCustomRenderList(S,T,E)),u||(u=T),this._doNotChangeAspectRatio||a.updateTransformMatrix(!0);for(var x=0;x<u.length&&v;++x){var p=u[x];if(!(!p.isEnabled()||p.isBlocked||!p.isVisible||!p.subMeshes)){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(p,this.refreshRate)){v=!1;break}}else if(!p.isReady(!0)){v=!1;break}}}this.onAfterRenderObservable.notifyObservers(S)}}else if(this.is2DArray)for(var S=0;S<this.getRenderLayers();S++)this._renderToTarget(0,t,r,S,d),a.incrementRenderId(),a.resetCachedMaterial();else if(this.isCube)for(var g=0;g<6;g++)this._renderToTarget(g,t,r,void 0,d),a.incrementRenderId(),a.resetCachedMaterial();else this._renderToTarget(0,t,r,void 0,d);return this.onAfterUnbindObservable.notifyObservers(this),o.currentRenderPassId=f,a.activeCamera&&((a.getEngine().scenes.length>1||this.activeCamera&&this.activeCamera!==a.activeCamera)&&a.setTransformMatrix(a.activeCamera.getViewMatrix(),a.activeCamera.getProjectionMatrix(!0)),o.setViewport(a.activeCamera.viewport)),a.resetCachedMaterial(),v},e.prototype._bestReflectionRenderTargetDimension=function(t,r){var n=128,s=t*r,a=V.NearestPOT(s+n*n/(n+s));return Math.min(V.FloorPOT(t),a)},e.prototype._prepareRenderingManager=function(t,r,n,s){var a=this.getScene();if(!!a){this._renderingManager.reset();for(var o=a.getRenderId(),h=0;h<r;h++){var l=t[h];if(l&&!l.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(l,this.refreshRate)){this.resetRefreshCounter();continue}}else if(!l.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}if(!l._internalAbstractMeshDataInfo._currentLODIsUpToDate&&a.activeCamera&&(l._internalAbstractMeshDataInfo._currentLOD=a.customLODSelector?a.customLODSelector(l,this.activeCamera||a.activeCamera):l.getLOD(this.activeCamera||a.activeCamera),l._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!l._internalAbstractMeshDataInfo._currentLOD)continue;var p=l._internalAbstractMeshDataInfo._currentLOD;p._preActivateForIntermediateRendering(o);var c=void 0;if(s&&n?c=(l.layerMask&n.layerMask)===0:c=!1,l.isEnabled()&&l.isVisible&&l.subMeshes&&!c&&(p!==l&&p._activate(o,!0),l._activate(o,!0)&&l.subMeshes.length)){l.isAnInstance?l._internalAbstractMeshDataInfo._actAsRegularMesh&&(p=l):p._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,p._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(var _=0;_<p.subMeshes.length;_++){var f=p.subMeshes[_];this._renderingManager.dispatch(f,p)}}}}for(var d=0;d<a.particleSystems.length;d++){var v=a.particleSystems[d],S=v.emitter;!v.isStarted()||!S||!S.position||!S.isEnabled()||t.indexOf(S)>=0&&this._renderingManager.dispatchParticles(v)}}},e.prototype._bindFrameBuffer=function(t,r){t===void 0&&(t=0),r===void 0&&(r=0);var n=this.getScene();if(!!n){var s=n.getEngine();this._renderTarget&&s.bindFramebuffer(this._renderTarget,this.isCube?t:void 0,void 0,void 0,this.ignoreCameraViewport,0,r)}},e.prototype._unbindFrameBuffer=function(t,r){var n=this;!this._renderTarget||t.unBindFramebuffer(this._renderTarget,this.isCube,function(){n.onAfterRenderObservable.notifyObservers(r)})},e.prototype._prepareFrame=function(t,r,n,s){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!s||!t.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(r,n)},e.prototype._renderToTarget=function(t,r,n,s,a){var o,h,l,p,c,_;s===void 0&&(s=0),a===void 0&&(a=null);var f=this.getScene();if(!!f){var d=f.getEngine();(o=d._debugPushGroup)===null||o===void 0||o.call(d,"render to face #".concat(t," layer #").concat(s),1),this._prepareFrame(f,t,s,r),this.is2DArray?(d.currentRenderPassId=this._renderPassIds[s],this.onBeforeRenderObservable.notifyObservers(s)):(d.currentRenderPassId=this._renderPassIds[t],this.onBeforeRenderObservable.notifyObservers(t));var v=d.snapshotRendering&&d.snapshotRenderingMode===1;if(v)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(d):this.skipInitialClear||d.clear(this.clearColor||f.clearColor,!0,!0,!0);else{var S=null,g=this.renderList?this.renderList:f.getActiveMeshes().data,b=this.renderList?this.renderList.length:f.getActiveMeshes().length;this.getCustomRenderList&&(S=this.getCustomRenderList(this.is2DArray?s:t,g,b)),S?this._prepareRenderingManager(S,S.length,a,!1):(this._defaultRenderListPrepared||(this._prepareRenderingManager(g,b,a,!this.renderList),this._defaultRenderListPrepared=!0),S=g);for(var u=0,T=f._beforeRenderTargetClearStage;u<T.length;u++){var E=T[u];E.action(this,t,s)}this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(d):this.skipInitialClear||d.clear(this.clearColor||f.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||f.updateTransformMatrix(!0);for(var x=0,P=f._beforeRenderTargetDrawStage;x<P.length;x++){var E=P[x];E.action(this,t,s)}this._renderingManager.render(this.customRenderFunction,S,this.renderParticles,this.renderSprites);for(var A=0,w=f._afterRenderTargetDrawStage;A<w.length;A++){var E=w[A];E.action(this,t,s)}var I=(l=(h=this._texture)===null||h===void 0?void 0:h.generateMipMaps)!==null&&l!==void 0?l:!1;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,(p=this._renderTarget)!==null&&p!==void 0?p:void 0,t,this._postProcesses,this.ignoreCameraViewport):r&&f.postProcessManager._finalizeFrame(!1,(c=this._renderTarget)!==null&&c!==void 0?c:void 0,t),this._texture&&(this._texture.generateMipMaps=I),this._doNotChangeAspectRatio||f.updateTransformMatrix(!0),n&&de.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),d)}this._unbindFrameBuffer(d,t),this._texture&&this.isCube&&t===5&&d.generateMipMapsForCubemap(this._texture),(_=d._debugPopGroup)===null||_===void 0||_.call(d,1)}},e.prototype.setRenderingOrder=function(t,r,n,s){r===void 0&&(r=null),n===void 0&&(n=null),s===void 0&&(s=null),this._renderingManager.setRenderingOrder(t,r,n,s)},e.prototype.setRenderingAutoClearDepthStencil=function(t,r){this._renderingManager.setRenderingAutoClearDepthStencil(t,r),this._renderingManager._useSceneAutoClearSetup=!1},e.prototype.clone=function(){var t=this.getSize(),r=new e(this.name,t,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return r.hasAlpha=this.hasAlpha,r.level=this.level,r.coordinatesMode=this.coordinatesMode,this.renderList&&(r.renderList=this.renderList.slice(0)),r},e.prototype.serialize=function(){if(!this.name)return null;var t=i.prototype.serialize.call(this);if(t.renderTargetSize=this.getRenderSize(),t.renderList=[],this.renderList)for(var r=0;r<this.renderList.length;r++)t.renderList.push(this.renderList[r].id);return t},e.prototype.disposeFramebufferObjects=function(){var t;(t=this._renderTarget)===null||t===void 0||t.dispose(!0)},e.prototype.releaseInternalTexture=function(){var t;(t=this._renderTarget)===null||t===void 0||t.releaseTextures(),this._texture=null},e.prototype.dispose=function(){var t;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;var r=this.getScene();if(!!r){var n=r.customRenderTargets.indexOf(this);n>=0&&r.customRenderTargets.splice(n,1);for(var s=0,a=r.cameras;s<a.length;s++){var o=a[s];n=o.customRenderTargets.indexOf(this),n>=0&&o.customRenderTargets.splice(n,1)}(t=this._renderTarget)===null||t===void 0||t.dispose(),this._renderTarget=null,this._texture=null,i.prototype.dispose.call(this)}},e.prototype._rebuild=function(){this.refreshRate===e.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=e.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()},e.prototype.freeRenderingGroups=function(){this._renderingManager&&this._renderingManager.freeRenderingGroups()},e.prototype.getViewCount=function(){return 1},e.REFRESHRATE_RENDER_ONCE=0,e.REFRESHRATE_RENDER_ONEVERYFRAME=1,e.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,e}(m);m._CreateRenderTargetTexture=function(i,e,t,r,n){return new U(i,e,t,r)};var Te="postprocessVertexShader",Me=`attribute vec2 position;
uniform vec2 scale;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd)*scale;
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;M.ShadersStore[Te]=Me;var Q=function(){function i(e,t,r,n,s,a,o,h,l,p,c,_,f,d,v){o===void 0&&(o=1),p===void 0&&(p=null),c===void 0&&(c=0),_===void 0&&(_="postprocess"),d===void 0&&(d=!1),v===void 0&&(v=5),this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.alphaMode=0,this.animations=new Array,this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new ne(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new W(1,1),this._texelSize=W.Zero(),this.onActivateObservable=new y,this.onSizeChangedObservable=new y,this.onApplyObservable=new y,this.onBeforeRenderObservable=new y,this.onAfterRenderObservable=new y,this.name=e,a!=null?(this._camera=a,this._scene=a.getScene(),a.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):h&&(this._engine=h,this._engine.postProcesses.push(this)),this._options=s,this.renderTargetSamplingMode=o||1,this._reusable=l||!1,this._textureType=c,this._textureFormat=v,this._samplers=n||[],this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=_,this._parameters=r||[],this._parameters.push("scale"),this._indexParameters=f,this._drawWrapper=new he(this._engine),d||this.updateEffect(p)}return Object.defineProperty(i.prototype,"samples",{get:function(){return this._samples},set:function(e){var t=this;this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(function(r){r.samples!==t._samples&&t._engine.updateRenderTargetTextureSampleCount(r,t._samples)})},enumerable:!1,configurable:!0}),i.prototype.getEffectName=function(){return this._fragmentUrl},Object.defineProperty(i.prototype,"onActivate",{set:function(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onSizeChanged",{set:function(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onApply",{set:function(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onBeforeRender",{set:function(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onAfterRender",{set:function(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"inputTexture",{get:function(){return this._textures.data[this._currentRenderTextureInd]},set:function(e){this._forcedOutputTexture=e},enumerable:!1,configurable:!0}),i.prototype.restoreDefaultInputTexture=function(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())},i.prototype.getCamera=function(){return this._camera},Object.defineProperty(i.prototype,"texelSize",{get:function(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)},enumerable:!1,configurable:!0}),i.prototype.getClassName=function(){return"PostProcess"},i.prototype.getEngine=function(){return this._engine},i.prototype.getEffect=function(){return this._drawWrapper.effect},i.prototype.shareOutputWith=function(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this},i.prototype.useOwnOutput=function(){this._textures.length==0&&(this._textures=new ne(2)),this._shareOutputWithPostProcess=null},i.prototype.updateEffect=function(e,t,r,n,s,a,o,h){e===void 0&&(e=null),t===void 0&&(t=null),r===void 0&&(r=null),this._postProcessDefines=e,this._drawWrapper.effect=this._engine.createEffect({vertex:o!=null?o:this._vertexUrl,fragment:h!=null?h:this._fragmentUrl},["position"],t||this._parameters,r||this._samplers,e!==null?e:"",void 0,s,a,n||this._indexParameters)},i.prototype.isReusable=function(){return this._reusable},i.prototype.markTextureDirty=function(){this.width=-1},i.prototype._createRenderTargetTexture=function(e,t,r){r===void 0&&(r=0);for(var n=0;n<this._textureCache.length;n++)if(this._textureCache[n].texture.width===e.width&&this._textureCache[n].texture.height===e.height&&this._textureCache[n].postProcessChannel===r&&this._textureCache[n].texture._generateDepthBuffer===t.generateDepthBuffer)return this._textureCache[n].texture;var s=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:s,postProcessChannel:r,lastUsedRenderId:-1}),s},i.prototype._flushTextureCache=function(){for(var e=this._renderId,t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){for(var r=!1,n=0;n<this._textures.length;n++)if(this._textures.data[n]===this._textureCache[t].texture){r=!0;break}r||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}},i.prototype._resize=function(e,t,r,n,s){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;for(var a=null,o=0;o<r._postProcesses.length;o++)if(r._postProcesses[o]!==null){a=r._postProcesses[o];break}var h={width:this.width,height:this.height},l={generateMipMaps:n,generateDepthBuffer:s||a===this,generateStencilBuffer:(s||a===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat};this._textures.push(this._createRenderTargetTexture(h,l,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(h,l,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)},i.prototype.activate=function(e,t,r){var n=this,s,a;t===void 0&&(t=null),e=e||this._camera;var o=e.getScene(),h=o.getEngine(),l=h.getCaps().maxTextureSize,p=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0,c=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0,_=e.parent;_&&(_.leftCamera==e||_.rightCamera==e)&&(p/=2);var f=this._options.width||p,d=this._options.height||c,v=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){var S=h.currentViewport;S&&(f*=S.width,d*=S.height)}(v||this.alwaysForcePOT)&&(this._options.width||(f=h.needPOTTextures?V.GetExponentOfTwo(f,l,this.scaleMode):f),this._options.height||(d=h.needPOTTextures?V.GetExponentOfTwo(d,l,this.scaleMode):d)),(this.width!==f||this.height!==d)&&this._resize(f,d,e,v,r),this._textures.forEach(function(T){T.samples!==n.samples&&n._engine.updateRenderTargetTextureSampleCount(T,n.samples)}),this._flushTextureCache(),this._renderId++}var g;if(this._shareOutputWithPostProcess)g=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)g=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{g=this.inputTexture;for(var b=void 0,u=0;u<this._textureCache.length;u++)if(this._textureCache[u].texture===g){b=this._textureCache[u];break}b&&(b.lastUsedRenderId=this._renderId)}return this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(p/f,c/d),this._engine.bindFramebuffer(g,0,p,c,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(g,0,void 0,void 0,this.forceFullscreenViewport)),(a=(s=this._engine)._debugInsertMarker)===null||a===void 0||a.call(s,"post process ".concat(this.name," input")),this.onActivateObservable.notifyObservers(e),this.autoClear&&this.alphaMode===0&&this._engine.clear(this.clearColor?this.clearColor:o.clearColor,o._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),g},Object.defineProperty(i.prototype,"isSupported",{get:function(){return this._drawWrapper.effect.isSupported},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"aspectRatio",{get:function(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height},enumerable:!1,configurable:!0}),i.prototype.isReady=function(){var e,t;return(t=(e=this._drawWrapper.effect)===null||e===void 0?void 0:e.isReady())!==null&&t!==void 0?t:!1},i.prototype.apply=function(){var e;if(!(!((e=this._drawWrapper.effect)===null||e===void 0)&&e.isReady()))return null;this._engine.enableEffect(this._drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a);var t;return this._shareOutputWithPostProcess?t=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?t=this._forcedOutputTexture:t=this.inputTexture,this.externalTextureSamplerBinding||this._drawWrapper.effect._bindTexture("textureSampler",t==null?void 0:t.texture),this._drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._drawWrapper.effect),this._drawWrapper.effect},i.prototype._disposeTextures=function(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()},i.prototype._disposeTextureCache=function(){for(var e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0},i.prototype.setPrePassRenderer=function(e){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1},i.prototype.dispose=function(e){e=e||this._camera,this._disposeTextures();var t;if(this._scene&&(t=this._scene.postProcesses.indexOf(this),t!==-1&&this._scene.postProcesses.splice(t,1)),this._parentContainer){var r=this._parentContainer.postProcesses.indexOf(this);r>-1&&this._parentContainer.postProcesses.splice(r,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),t!==-1&&this._engine.postProcesses.splice(t,1),!!e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),t===0&&e._postProcesses.length>0){var n=this._camera._getFirstPostProcess();n&&n.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}},i.prototype.serialize=function(){var e=K.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e},i.prototype.clone=function(){var e=this.serialize();e._engine=this._engine,e.cameraId=null;var t=i.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null},i.Parse=function(e,t,r){var n=pe(e.customType);if(!n||!n._Parse)return null;var s=t?t.getCameraById(e.cameraId):null;return n._Parse(e,s,t,r)},i._Parse=function(e,t,r,n){return K.Parse(function(){return new i(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat)},e,r,n)},O([R()],i.prototype,"uniqueId",void 0),O([R()],i.prototype,"name",void 0),O([R()],i.prototype,"width",void 0),O([R()],i.prototype,"height",void 0),O([R()],i.prototype,"renderTargetSamplingMode",void 0),O([ce()],i.prototype,"clearColor",void 0),O([R()],i.prototype,"autoClear",void 0),O([R()],i.prototype,"alphaMode",void 0),O([R()],i.prototype,"alphaConstants",void 0),O([R()],i.prototype,"enablePixelPerfectMode",void 0),O([R()],i.prototype,"forceFullscreenViewport",void 0),O([R()],i.prototype,"scaleMode",void 0),O([R()],i.prototype,"alwaysForcePOT",void 0),O([R("samples")],i.prototype,"_samples",void 0),O([R()],i.prototype,"adaptScaleToCurrentViewport",void 0),i}();le("BABYLON.PostProcess",Q);var me="kernelBlurVaryingDeclaration",Ee="varying vec2 sampleCoord{X};";M.IncludesShadersStore[me]=Ee;var xe="packingFunctions",Pe=`vec4 pack(float depth)
{
const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);
const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);
vec4 res=fract(depth*bit_shift);
res-=res.xxyz*bit_mask;
return res;
}
float unpack(vec4 color)
{
const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);
return dot(color,bit_shift);
}`;M.IncludesShadersStore[xe]=Pe;var Oe="kernelBlurFragment",Re=`#ifdef DOF
factor=sampleCoC(sampleCoord{X}); 
computedWeight=KERNEL_WEIGHT{X}*factor;
sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;
#endif
`;M.IncludesShadersStore[Oe]=Re;var ye="kernelBlurFragment2",Ae=`#ifdef DOF
factor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});
computedWeight=KERNEL_DEP_WEIGHT{X}*factor;
sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif
`;M.IncludesShadersStore[ye]=Ae;var Ce="kernelBlurPixelShader",Fe=`uniform sampler2D textureSampler;
uniform vec2 delta;
varying vec2 sampleCenter;
#ifdef DOF
uniform sampler2D circleOfConfusionSampler;
uniform vec2 cameraMinMaxZ;
float sampleDistance(in vec2 offset) {
float depth=texture2D(circleOfConfusionSampler,offset).g; 
return cameraMinMaxZ.x+(cameraMinMaxZ.y-cameraMinMaxZ.x)*depth; 
}
float sampleCoC(in vec2 offset) {
float coc=texture2D(circleOfConfusionSampler,offset).r; 
return coc; 
}
#endif
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#ifdef PACKEDFLOAT
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
float computedWeight=0.0;
#ifdef PACKEDFLOAT 
float blend=0.;
#else
vec4 blend=vec4(0.);
#endif
#ifdef DOF
float sumOfWeights=CENTER_WEIGHT; 
float factor=0.0;
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;
#else
blend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;
#endif
#endif
#include<kernelBlurFragment>[0..varyingCount]
#include<kernelBlurFragment2>[0..depCount]
#ifdef PACKEDFLOAT
gl_FragColor=pack(blend);
#else
gl_FragColor=blend;
#endif
#ifdef DOF
gl_FragColor/=sumOfWeights;
#endif
}`;M.ShadersStore[Ce]=Fe;var we="kernelBlurVertex",De="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";M.IncludesShadersStore[we]=De;var Be="kernelBlurVertexShader",Ie=`attribute vec2 position;
uniform vec2 delta;
varying vec2 sampleCenter;
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
sampleCenter=(position*madd+madd);
#include<kernelBlurVertex>[0..varyingCount]
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;M.ShadersStore[Be]=Ie;var G=function(i){$(e,i);function e(t,r,n,s,a,o,h,l,p,c,_){o===void 0&&(o=m.BILINEAR_SAMPLINGMODE),p===void 0&&(p=0),c===void 0&&(c=""),_===void 0&&(_=!1);var f=i.call(this,t,"kernelBlur",["delta","direction","cameraMinMaxZ"],["circleOfConfusionSampler"],s,a,o,h,l,null,p,"kernelBlur",{varyingCount:0,depCount:0},!0)||this;return f._blockCompilation=_,f._packedFloat=!1,f._staticDefines="",f._staticDefines=c,f.direction=r,f.onApplyObservable.add(function(d){f._outputTexture?d.setFloat2("delta",1/f._outputTexture.width*f.direction.x,1/f._outputTexture.height*f.direction.y):d.setFloat2("delta",1/f.width*f.direction.x,1/f.height*f.direction.y)}),f.kernel=n,f}return Object.defineProperty(e.prototype,"kernel",{get:function(){return this._idealKernel},set:function(t){this._idealKernel!==t&&(t=Math.max(t,1),this._idealKernel=t,this._kernel=this._nearestBestKernel(t),this._blockCompilation||this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"packedFloat",{get:function(){return this._packedFloat},set:function(t){this._packedFloat!==t&&(this._packedFloat=t,this._blockCompilation||this._updateParameters())},enumerable:!1,configurable:!0}),e.prototype.getClassName=function(){return"BlurPostProcess"},e.prototype.updateEffect=function(t,r,n,s,a,o){this._updateParameters(a,o)},e.prototype._updateParameters=function(t,r){for(var n=this._kernel,s=(n-1)/2,a=[],o=[],h=0,l=0;l<n;l++){var p=l/(n-1),c=this._gaussianWeight(p*2-1);a[l]=l-s,o[l]=c,h+=c}for(var l=0;l<o.length;l++)o[l]/=h;for(var _=[],f=[],d=[],l=0;l<=s;l+=2){var v=Math.min(l+1,Math.floor(s)),S=l===v;if(S)d.push({o:a[l],w:o[l]});else{var g=v===s,b=o[l]+o[v]*(g?.5:1),u=a[l]+1/(1+o[l]/o[v]);u===0?(d.push({o:a[l],w:o[l]}),d.push({o:a[l+1],w:o[l+1]})):(d.push({o:u,w:b}),d.push({o:-u,w:b}))}}for(var l=0;l<d.length;l++)f[l]=d[l].o,_[l]=d[l].w;a=f,o=_;var T=this.getEngine().getCaps().maxVaryingVectors,E=Math.max(T,0)-1,x=Math.min(a.length,E),P="";P+=this._staticDefines,this._staticDefines.indexOf("DOF")!=-1&&(P+="#define CENTER_WEIGHT ".concat(this._glslFloat(o[x-1]),`\r
`),x--);for(var l=0;l<x;l++)P+="#define KERNEL_OFFSET".concat(l," ").concat(this._glslFloat(a[l]),`\r
`),P+="#define KERNEL_WEIGHT".concat(l," ").concat(this._glslFloat(o[l]),`\r
`);for(var A=0,l=E;l<a.length;l++)P+="#define KERNEL_DEP_OFFSET".concat(A," ").concat(this._glslFloat(a[l]),`\r
`),P+="#define KERNEL_DEP_WEIGHT".concat(A," ").concat(this._glslFloat(o[l]),`\r
`),A++;this.packedFloat&&(P+="#define PACKEDFLOAT 1"),this._blockCompilation=!1,i.prototype.updateEffect.call(this,P,null,null,{varyingCount:x,depCount:A},t,r)},e.prototype._nearestBestKernel=function(t){for(var r=Math.round(t),n=0,s=[r,r-1,r+1,r-2,r+2];n<s.length;n++){var a=s[n];if(a%2!==0&&Math.floor(a/2)%2===0&&a>0)return Math.max(a,3)}return Math.max(r,3)},e.prototype._gaussianWeight=function(t){var r=.3333333333333333,n=Math.sqrt(2*Math.PI)*r,s=-(t*t/(2*r*r)),a=1/n*Math.exp(s);return a},e.prototype._glslFloat=function(t,r){return r===void 0&&(r=8),t.toFixed(r).replace(/0+$/,"")},e._Parse=function(t,r,n,s){return K.Parse(function(){return new e(t.name,t.direction,t.kernel,t.options,r,t.renderTargetSamplingMode,n.getEngine(),t.reusable,t.textureType,void 0,!1)},t,n,s)},O([R("kernel")],e.prototype,"_kernel",void 0),O([R("packedFloat")],e.prototype,"_packedFloat",void 0),O([_e()],e.prototype,"direction",void 0),e}(Q);le("BABYLON.BlurPostProcess",G);var Le="bayerDitherFunctions",Ne=`float bayerDither2(vec2 _P) {
return mod(2.0*_P.y+_P.x+1.0,4.0);
}
float bayerDither4(vec2 _P) {
vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5*mod(_P,4.0)); 
return 4.0*bayerDither2(P1)+bayerDither2(P2);
}
float bayerDither8(vec2 _P) {
vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5 *mod(_P,4.0)); 
vec2 P4=floor(0.25*mod(_P,8.0)); 
return 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);
}
`;M.IncludesShadersStore[Le]=Ne;var Ue="shadowMapFragmentExtraDeclaration",Ve=`#if SM_FLOAT==0
#include<packingFunctions>
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#include<bayerDitherFunctions>
uniform float softTransparentShadowSM;
#endif
varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
uniform vec3 lightDataSM;
varying vec3 vPositionWSM;
#endif
uniform vec3 biasAndScaleSM;
uniform vec2 depthValuesSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;M.IncludesShadersStore[Ue]=Ve;var We="shadowMapFragment",ze=`float depthSM=vDepthMetricSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
#if SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
depthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
depthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_FragDepth=clamp(1.0-depthSM,0.0,1.0);
#else
gl_FragDepth=clamp(depthSM,0.0,1.0); 
#endif
#elif SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#if SM_ESM==1
depthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);
#endif
#if SM_FLOAT==1
gl_FragColor=vec4(depthSM,1.0,1.0,1.0);
#else
gl_FragColor=pack(depthSM);
#endif
return;`;M.IncludesShadersStore[We]=ze;var He="shadowMapPixelShader",ke=`#include<shadowMapFragmentExtraDeclaration>
#ifdef ALPHATEST
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEST
float alphaFromAlphaTexture=texture2D(diffuseSampler,vUV).a;
if (alphaFromAlphaTexture<ALPHATESTVALUE)
discard;
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#ifdef ALPHATEST
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alphaFromAlphaTexture) discard;
#else
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM) discard;
#endif
#endif
#include<shadowMapFragment>
}`;M.ShadersStore[He]=ke;var Xe="sceneVertexDeclaration",je=`uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform mat4 view;
uniform mat4 projection;
uniform vec4 vEyePosition;
`;M.IncludesShadersStore[Xe]=je;var Ke="meshVertexDeclaration",Ge=`uniform mat4 world;
uniform float visibility;
`;M.IncludesShadersStore[Ke]=Ge;var $e="shadowMapVertexDeclaration",Ye=`#include<sceneVertexDeclaration>
#include<meshVertexDeclaration>
`;M.IncludesShadersStore[$e]=Ye;var Qe="shadowMapUboDeclaration",Ze=`layout(std140,column_major) uniform;
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;M.IncludesShadersStore[Qe]=Ze;var qe="shadowMapVertexExtraDeclaration",Je=`#if SM_NORMALBIAS==1
uniform vec3 lightDataSM;
#endif
uniform vec3 biasAndScaleSM;
uniform vec2 depthValuesSM;
varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
varying vec3 vPositionWSM;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;M.IncludesShadersStore[qe]=Je;var et="shadowMapVertexNormalBias",tt=`#if SM_NORMALBIAS==1
#if SM_DIRECTIONINLIGHTDATA==1
vec3 worldLightDirSM=normalize(-lightDataSM.xyz);
#else
vec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;
vec3 worldLightDirSM=normalize(directionToLightSM);
#endif
float ndlSM=dot(vNormalW,worldLightDirSM);
float sinNLSM=sqrt(1.0-ndlSM*ndlSM);
float normalBiasSM=biasAndScaleSM.y*sinNLSM;
worldPos.xyz-=vNormalW*normalBiasSM;
#endif
`;M.IncludesShadersStore[et]=tt;var rt="shadowMapVertexMetric",it=`#if SM_USEDISTANCE==1
vPositionWSM=worldPos.xyz;
#endif
#if SM_DEPTHTEXTURE==1
#ifdef IS_NDC_HALF_ZRANGE
#define BIASFACTOR 0.5
#else
#define BIASFACTOR 1.0
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#else
gl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#endif
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
zSM=gl_Position.z;
gl_Position.z=0.0;
#elif SM_USEDISTANCE==0
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
vDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
`;M.IncludesShadersStore[rt]=it;var nt="shadowMapVertexShader",st=`attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef INSTANCES
attribute vec4 world0;
attribute vec4 world1;
attribute vec4 world2;
attribute vec4 world3;
#endif
#include<helperFunctions>
#include<__decl__shadowMapVertex>
#ifdef ALPHATEST
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<shadowMapVertexExtraDeclaration>
#include<clipPlaneVertexDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normWorldSM=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));
vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vec3 vNormalW=normalize(normWorldSM*normalUpdated);
#endif
#endif
#include<shadowMapVertexNormalBias>
gl_Position=viewProjection*worldPos;
#include<shadowMapVertexMetric>
#ifdef ALPHATEST
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
}`;M.ShadersStore[nt]=st;var at="depthBoxBlurPixelShader",ot=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 screenSize;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec4 colorDepth=vec4(0.0);
for (int x=-OFFSET; x<=OFFSET; x++)
for (int y=-OFFSET; y<=OFFSET; y++)
colorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);
gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));
}`;M.ShadersStore[at]=ot;var lt="shadowMapFragmentSoftTransparentShadow",ht=`#if SM_SOFTTRANSPARENTSHADOW==1
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alpha) discard;
#endif
`;M.IncludesShadersStore[lt]=ht;var ut=function(){function i(e,t,r){this.onBeforeShadowMapRenderObservable=new y,this.onAfterShadowMapRenderObservable=new y,this.onBeforeShadowMapRenderMeshObservable=new y,this.onAfterShadowMapRenderMeshObservable=new y,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=i.FILTER_NONE,this._filteringQuality=i.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this.forceBackFacesOnly=!1,this._lightDirection=F.Zero(),this._viewMatrix=D.Zero(),this._projectionMatrix=D.Zero(),this._transformMatrix=D.Zero(),this._cachedPosition=new F(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new F(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=D.Identity(),this._mapSize=e,this._light=t,this._scene=t.getScene(),t._shadowGenerator=this,this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer('Scene for Shadow Generator (light "'.concat(this._light.name,'")')))),i._SceneComponentInitialization(this._scene);var n=this._scene.getEngine().getCaps();r?n.textureFloatRender&&n.textureFloatLinearFiltering?this._textureType=1:n.textureHalfFloatRender&&n.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:n.textureHalfFloatRender&&n.textureHalfFloatLinearFiltering?this._textureType=2:n.textureFloatRender&&n.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}return Object.defineProperty(i.prototype,"bias",{get:function(){return this._bias},set:function(e){this._bias=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"normalBias",{get:function(){return this._normalBias},set:function(e){this._normalBias=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"blurBoxOffset",{get:function(){return this._blurBoxOffset},set:function(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"blurScale",{get:function(){return this._blurScale},set:function(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"blurKernel",{get:function(){return this._blurKernel},set:function(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"useKernelBlur",{get:function(){return this._useKernelBlur},set:function(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"depthScale",{get:function(){return this._depthScale!==void 0?this._depthScale:this._light.getDepthScale()},set:function(e){this._depthScale=e},enumerable:!1,configurable:!0}),i.prototype._validateFilter=function(e){return e},Object.defineProperty(i.prototype,"filter",{get:function(){return this._filter},set:function(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===i.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=!0;return}else if(e===i.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=!0;return}else if(e===i.FILTER_PCF||e===i.FILTER_PCSS){this.usePoissonSampling=!0;return}}if((e===i.FILTER_PCF||e===i.FILTER_PCSS)&&!this._scene.getEngine()._features.supportShadowSamplers){this.usePoissonSampling=!0;return}this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"usePoissonSampling",{get:function(){return this.filter===i.FILTER_POISSONSAMPLING},set:function(e){var t=this._validateFilter(i.FILTER_POISSONSAMPLING);!e&&this.filter!==i.FILTER_POISSONSAMPLING||(this.filter=e?t:i.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"useExponentialShadowMap",{get:function(){return this.filter===i.FILTER_EXPONENTIALSHADOWMAP},set:function(e){var t=this._validateFilter(i.FILTER_EXPONENTIALSHADOWMAP);!e&&this.filter!==i.FILTER_EXPONENTIALSHADOWMAP||(this.filter=e?t:i.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"useBlurExponentialShadowMap",{get:function(){return this.filter===i.FILTER_BLUREXPONENTIALSHADOWMAP},set:function(e){var t=this._validateFilter(i.FILTER_BLUREXPONENTIALSHADOWMAP);!e&&this.filter!==i.FILTER_BLUREXPONENTIALSHADOWMAP||(this.filter=e?t:i.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"useCloseExponentialShadowMap",{get:function(){return this.filter===i.FILTER_CLOSEEXPONENTIALSHADOWMAP},set:function(e){var t=this._validateFilter(i.FILTER_CLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==i.FILTER_CLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:i.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"useBlurCloseExponentialShadowMap",{get:function(){return this.filter===i.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP},set:function(e){var t=this._validateFilter(i.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==i.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:i.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"usePercentageCloserFiltering",{get:function(){return this.filter===i.FILTER_PCF},set:function(e){var t=this._validateFilter(i.FILTER_PCF);!e&&this.filter!==i.FILTER_PCF||(this.filter=e?t:i.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"filteringQuality",{get:function(){return this._filteringQuality},set:function(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"useContactHardeningShadow",{get:function(){return this.filter===i.FILTER_PCSS},set:function(e){var t=this._validateFilter(i.FILTER_PCSS);!e&&this.filter!==i.FILTER_PCSS||(this.filter=e?t:i.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"contactHardeningLightSizeUVRatio",{get:function(){return this._contactHardeningLightSizeUVRatio},set:function(e){this._contactHardeningLightSizeUVRatio=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"darkness",{get:function(){return this._darkness},set:function(e){this.setDarkness(e)},enumerable:!1,configurable:!0}),i.prototype.getDarkness=function(){return this._darkness},i.prototype.setDarkness=function(e){return e>=1?this._darkness=1:e<=0?this._darkness=0:this._darkness=e,this},Object.defineProperty(i.prototype,"transparencyShadow",{get:function(){return this._transparencyShadow},set:function(e){this.setTransparencyShadow(e)},enumerable:!1,configurable:!0}),i.prototype.setTransparencyShadow=function(e){return this._transparencyShadow=e,this},i.prototype.getShadowMap=function(){return this._shadowMap},i.prototype.getShadowMapForRendering=function(){return this._shadowMap2?this._shadowMap2:this._shadowMap},i.prototype.getClassName=function(){return i.CLASSNAME},i.prototype.addShadowCaster=function(e,t){if(t===void 0&&(t=!0),!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),this._shadowMap.renderList.indexOf(e)===-1&&this._shadowMap.renderList.push(e),t)for(var r=0,n=e.getChildMeshes();r<n.length;r++){var s=n[r];this._shadowMap.renderList.indexOf(s)===-1&&this._shadowMap.renderList.push(s)}return this},i.prototype.removeShadowCaster=function(e,t){if(t===void 0&&(t=!0),!this._shadowMap||!this._shadowMap.renderList)return this;var r=this._shadowMap.renderList.indexOf(e);if(r!==-1&&this._shadowMap.renderList.splice(r,1),t)for(var n=0,s=e.getChildren();n<s.length;n++){var a=s[n];this.removeShadowCaster(a)}return this},i.prototype.getLight=function(){return this._light},Object.defineProperty(i.prototype,"mapSize",{get:function(){return this._mapSize},set:function(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()},enumerable:!1,configurable:!0}),i.prototype._initializeGenerator=function(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()},i.prototype._createTargetRenderTexture=function(){var e=this._scene.getEngine();e._features.supportDepthStencilTexture?(this._shadowMap=new U(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0)):this._shadowMap=new U(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube())},i.prototype._initializeShadowMap=function(){var e=this;if(this._createTargetRenderTexture(),this._shadowMap!==null){this._shadowMap.wrapU=m.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=m.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(m.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=this._renderForShadowMap.bind(this),this._shadowMap.customIsReadyFunction=function(){return!0};var t=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(function(){var a;e._currentSceneUBO=e._scene.getSceneUniformBuffer(),(a=t._debugPushGroup)===null||a===void 0||a.call(t,"shadow map generation for pass id ".concat(t.currentRenderPassId),1)}),this._shadowMap.onBeforeRenderObservable.add(function(a){e._sceneUBOs&&e._scene.setSceneUniformBuffer(e._sceneUBOs[0]),e._currentFaceIndex=a,e._filter===i.FILTER_PCF&&t.setColorWrite(!1),e.getTransformMatrix(),e._scene.setTransformMatrix(e._viewMatrix,e._projectionMatrix),e._useUBO&&(e._scene.getSceneUniformBuffer().unbindEffect(),e._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(function(){var a,o;if(e._sceneUBOs&&e._scene.setSceneUniformBuffer(e._currentSceneUBO),e._scene.updateTransformMatrix(),e._filter===i.FILTER_PCF&&t.setColorWrite(!0),!e.useBlurExponentialShadowMap&&!e.useBlurCloseExponentialShadowMap){(a=t._debugPopGroup)===null||a===void 0||a.call(t,1);return}var h=e.getShadowMapForRendering();h&&(e._scene.postProcessManager.directRender(e._blurPostProcesses,h.renderTarget,!0),t.unBindFramebuffer(h.renderTarget,!0),(o=t._debugPopGroup)===null||o===void 0||o.call(t,1))});var r=new se(0,0,0,0),n=new se(1,1,1,1);this._shadowMap.onClearObservable.add(function(a){e._filter===i.FILTER_PCF?a.clear(n,!1,!0,!1):e.useExponentialShadowMap||e.useBlurExponentialShadowMap?a.clear(r,!0,!0,!1):a.clear(n,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(function(a){e._storedUniqueId=e._shadowMap.uniqueId,e._mapSize=a.getRenderSize(),e._light._markMeshesAsLightDirty(),e.recreateShadowMap()});for(var s=j.MIN_RENDERINGGROUPS;s<j.MAX_RENDERINGGROUPS;s++)this._shadowMap.setRenderingAutoClearDepthStencil(s,!1)}},i.prototype._initializeBlurRTTAndPostProcesses=function(){var e=this,t=this._scene.getEngine(),r=this._mapSize/this.blurScale;(!this.useKernelBlur||this.blurScale!==1)&&(this._shadowMap2=new U(this._light.name+"_shadowMap2",r,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=m.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=m.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(m.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new G(this._light.name+"KernelBlurX",new W(1,0),this.blurKernel,1,null,m.BILINEAR_SAMPLINGMODE,t,!1,this._textureType),this._kernelBlurXPostprocess.width=r,this._kernelBlurXPostprocess.height=r,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(function(n){n.setTexture("textureSampler",e._shadowMap)}),this._kernelBlurYPostprocess=new G(this._light.name+"KernelBlurY",new W(0,1),this.blurKernel,1,null,m.BILINEAR_SAMPLINGMODE,t,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,this._textureType===0&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new Q(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,m.BILINEAR_SAMPLINGMODE,t,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(function(n){n.setFloat2("screenSize",r,r),n.setTexture("textureSampler",e._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])},i.prototype._renderForShadowMap=function(e,t,r,n){var s;if(n.length)for(s=0;s<n.length;s++)this._renderSubMeshForShadowMap(n.data[s]);for(s=0;s<e.length;s++)this._renderSubMeshForShadowMap(e.data[s]);for(s=0;s<t.length;s++)this._renderSubMeshForShadowMap(t.data[s]);if(this._transparencyShadow)for(s=0;s<r.length;s++)this._renderSubMeshForShadowMap(r.data[s],!0);else for(s=0;s<r.length;s++)r.data[s].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1},i.prototype._bindCustomEffectForRenderSubMeshForShadowMap=function(e,t,r){t.setMatrix("viewProjection",this.getTransformMatrix())},i.prototype._renderSubMeshForShadowMap=function(e,t){var r,n;t===void 0&&(t=!1);var s=e.getRenderingMesh(),a=e.getEffectiveMesh(),o=this._scene,h=o.getEngine(),l=e.getMaterial();if(a._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!(!l||e.verticesCount===0||e._renderId===o.getRenderId())){var p=a._getWorldMatrixDeterminant()<0,c=(r=s.overrideMaterialSideOrientation)!==null&&r!==void 0?r:l.sideOrientation;p&&(c=c===0?1:0);var _=c===0;h.setState(l.backFaceCulling,void 0,void 0,_,l.cullBackFaces);var f=s._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(!f.mustReturn){var d=h.getCaps().instancedArrays&&(f.visibleInstances[e._id]!==null&&f.visibleInstances[e._id]!==void 0||s.hasThinInstances);if(!(this.customAllowRendering&&!this.customAllowRendering(e)))if(this.isReady(e,d,t)){e._renderId=o.getRenderId();var v=l.shadowDepthWrapper,S=(n=v==null?void 0:v.getEffect(e,this,h.currentRenderPassId))!==null&&n!==void 0?n:e._getDrawWrapper(),g=he.GetEffect(S);if(h.enableEffect(S),d||s._bind(e,g,l.fillMode),this.getTransformMatrix(),g.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===ae.LIGHTTYPEID_DIRECTIONALLIGHT?g.setVector3("lightDataSM",this._cachedDirection):g.setVector3("lightDataSM",this._cachedPosition),o.activeCamera&&g.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(o.activeCamera),this.getLight().getDepthMinZ(o.activeCamera)+this.getLight().getDepthMaxZ(o.activeCamera)),t&&this.enableSoftTransparentShadow&&g.setFloat("softTransparentShadowSM",a.visibility*l.alpha),v)e._setMainDrawWrapperOverride(S),v.standalone?v.baseMaterial.bindForSubMesh(a.getWorldMatrix(),s,e):l.bindForSubMesh(a.getWorldMatrix(),s,e),e._setMainDrawWrapperOverride(null);else{if(l&&this.useOpacityTextureForTransparentShadow){var b=l.opacityTexture;b&&(g.setTexture("diffuseSampler",b),g.setMatrix("diffuseMatrix",b.getTextureMatrix()||this._defaultTextureMatrix))}else if(l&&l.needAlphaTesting()){var u=l.getAlphaTestTexture();u&&(g.setTexture("diffuseSampler",u),g.setMatrix("diffuseMatrix",u.getTextureMatrix()||this._defaultTextureMatrix))}if(s.useBones&&s.computeBonesUsingShaders&&s.skeleton){var T=s.skeleton;if(T.isUsingTextureForMatrices){var E=T.getTransformMatrixTexture(s);if(!E)return;g.setTexture("boneSampler",E),g.setFloat("boneTextureWidth",4*(T.bones.length+1))}else g.setMatrices("mBones",T.getTransformMatrices(s))}L.BindMorphTargetParameters(s,g),s.morphTargetManager&&s.morphTargetManager.isUsingTextureForTargets&&s.morphTargetManager._bind(g),L.BindClipPlane(g,o)}!this._useUBO&&!v&&this._bindCustomEffectForRenderSubMeshForShadowMap(e,g,a),L.BindSceneUniformBuffer(g,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();var x=a.getWorldMatrix();d&&(a.getMeshUniformBuffer().bindToEffect(g,"Mesh"),a.transferToEffect(x)),this.forceBackFacesOnly&&h.setState(!0,0,!1,!0,l.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(s),this.onBeforeShadowMapRenderObservable.notifyObservers(g),s._processRendering(a,e,g,l.fillMode,f,d,function(P,A){a!==s&&!P?(s.getMeshUniformBuffer().bindToEffect(g,"Mesh"),s.transferToEffect(A)):(a.getMeshUniformBuffer().bindToEffect(g,"Mesh"),a.transferToEffect(P?A:x))}),this.forceBackFacesOnly&&h.setState(!0,0,!1,!1,l.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(g),this.onAfterShadowMapRenderMeshObservable.notifyObservers(s)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}}},i.prototype._applyFilterValues=function(){!this._shadowMap||(this.filter===i.FILTER_NONE||this.filter===i.FILTER_PCSS?this._shadowMap.updateSamplingMode(m.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(m.BILINEAR_SAMPLINGMODE))},i.prototype.forceCompilation=function(e,t){var r=this,n=Y({useInstances:!1},t),s=this.getShadowMap();if(!s){e&&e(this);return}var a=s.renderList;if(!a){e&&e(this);return}for(var o=new Array,h=0,l=a;h<l.length;h++){var p=l[h];o.push.apply(o,p.subMeshes)}if(o.length===0){e&&e(this);return}var c=0,_=function(){var f,d;if(!(!r._scene||!r._scene.getEngine())){for(;r.isReady(o[c],n.useInstances,(d=(f=o[c].getMaterial())===null||f===void 0?void 0:f.needAlphaBlendingForMesh(o[c].getMesh()))!==null&&d!==void 0?d:!1);)if(c++,c>=o.length){e&&e(r);return}setTimeout(_,16)}};_()},i.prototype.forceCompilationAsync=function(e){var t=this;return new Promise(function(r){t.forceCompilation(function(){r()},e)})},i.prototype._isReadyCustomDefines=function(e,t,r){},i.prototype._prepareShadowDefines=function(e,t,r,n){r.push("#define SM_FLOAT "+(this._textureType!==0?"1":"0")),r.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),r.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));var s=e.getMesh();return r.push("#define SM_NORMALBIAS "+(this.normalBias&&s.isVerticesDataPresent(C.NormalKind)?"1":"0")),r.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===ae.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),r.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),r.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&n?"1":"0")),this._isReadyCustomDefines(r,e,t),r},i.prototype.isReady=function(e,t,r){var n,s=e.getMaterial(),a=s==null?void 0:s.shadowDepthWrapper,o=[];if(this._prepareShadowDefines(e,t,o,r),a){if(!a.isReadyForSubMesh(e,o,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{var h=e._getDrawWrapper(void 0,!0),l=h.effect,p=h.defines,c=[C.PositionKind],_=e.getMesh();if(this.normalBias&&_.isVerticesDataPresent(C.NormalKind)&&(c.push(C.NormalKind),o.push("#define NORMAL"),_.nonUniformScaling&&o.push("#define NONUNIFORMSCALING")),s&&s.needAlphaTesting()){var f=null;if(this.useOpacityTextureForTransparentShadow?f=s.opacityTexture:f=s.getAlphaTestTexture(),f){if(!f.isReady())return!1;var d=(n=s.alphaCutOff)!==null&&n!==void 0?n:i.DEFAULT_ALPHA_CUTOFF;o.push("#define ALPHATEST"),o.push("#define ALPHATESTVALUE ".concat(d).concat(d%1===0?".":"")),_.isVerticesDataPresent(C.UVKind)&&(c.push(C.UVKind),o.push("#define UV1")),_.isVerticesDataPresent(C.UV2Kind)&&f.coordinatesIndex===1&&(c.push(C.UV2Kind),o.push("#define UV2"))}}var v=new ve;if(_.useBones&&_.computeBonesUsingShaders&&_.skeleton){c.push(C.MatricesIndicesKind),c.push(C.MatricesWeightsKind),_.numBoneInfluencers>4&&(c.push(C.MatricesIndicesExtraKind),c.push(C.MatricesWeightsExtraKind));var S=_.skeleton;o.push("#define NUM_BONE_INFLUENCERS "+_.numBoneInfluencers),_.numBoneInfluencers>0&&v.addCPUSkinningFallback(0,_),S.isUsingTextureForMatrices?o.push("#define BONETEXTURE"):o.push("#define BonesPerMesh "+(S.bones.length+1))}else o.push("#define NUM_BONE_INFLUENCERS 0");var g=_.morphTargetManager,b=0;g&&g.numInfluencers>0&&(o.push("#define MORPHTARGETS"),b=g.numInfluencers,o.push("#define NUM_MORPH_INFLUENCERS "+b),g.isUsingTextureForTargets&&o.push("#define MORPHTARGETS_TEXTURE"),L.PrepareAttributesForMorphTargetsInfluencers(c,_,b));var u=this._scene;if(u.clipPlane&&o.push("#define CLIPPLANE"),u.clipPlane2&&o.push("#define CLIPPLANE2"),u.clipPlane3&&o.push("#define CLIPPLANE3"),u.clipPlane4&&o.push("#define CLIPPLANE4"),u.clipPlane5&&o.push("#define CLIPPLANE5"),u.clipPlane6&&o.push("#define CLIPPLANE6"),t&&(o.push("#define INSTANCES"),L.PushAttributesForInstances(c),e.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(var T=0,E=this.customShaderOptions.defines;T<E.length;T++){var x=E[T];o.indexOf(x)===-1&&o.push(x)}var P=o.join(`
`);if(p!==P){p=P;var A="shadowMap",w=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","boneTextureWidth","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices"],I=["diffuseSampler","boneSampler","morphTargets"],ue=["Scene","Mesh"];if(this.customShaderOptions){if(A=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(var z=0,Z=this.customShaderOptions.attributes;z<Z.length;z++){var q=Z[z];c.indexOf(q)===-1&&c.push(q)}if(this.customShaderOptions.uniforms)for(var H=0,J=this.customShaderOptions.uniforms;H<J.length;H++){var ee=J[H];w.indexOf(ee)===-1&&w.push(ee)}if(this.customShaderOptions.samplers)for(var k=0,te=this.customShaderOptions.samplers;k<te.length;k++){var re=te[k];I.indexOf(re)===-1&&I.push(re)}}var ie=this._scene.getEngine();l=ie.createEffect(A,{attributes:c,uniformsNames:w,uniformBuffersNames:ue,samplers:I,defines:P,fallbacks:v,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:b}},ie),h.setEffect(l,p)}if(!l.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())},i.prototype.prepareDefines=function(e,t){var r=this._scene,n=this._light;!r.shadowsEnabled||!n.shadowEnabled||(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===i.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===i.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===i.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===i.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),n.needCube()&&(e["SHADOWCUBE"+t]=!0))},i.prototype.bindShadowLight=function(e,t){var r=this._light,n=this._scene;if(!(!n.shadowsEnabled||!r.shadowEnabled)){var s=n.activeCamera;if(!!s){var a=this.getShadowMap();!a||(r.needCube()||t.setMatrix("lightMatrix"+e,this.getTransformMatrix()),this._filter===i.FILTER_PCF?(t.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering()),r._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a.getSize().width,1/a.getSize().width,this.frustumEdgeFalloff,e)):this._filter===i.FILTER_PCSS?(t.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering()),t.setTexture("depthSampler"+e,this.getShadowMapForRendering()),r._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/a.getSize().width,this._contactHardeningLightSizeUVRatio*a.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowSampler"+e,this.getShadowMapForRendering()),r._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/a.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),r._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(s),this.getLight().getDepthMinZ(s)+this.getLight().getDepthMaxZ(s),e))}}},i.prototype.getTransformMatrix=function(){var e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;var t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),F.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),Math.abs(F.Dot(this._lightDirection,F.Up()))===1&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),D.LookAtLHToRef(t,t.add(this._lightDirection),F.Up(),this._viewMatrix);var r=this.getShadowMap();if(r){var n=r.renderList;n&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,n)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix},i.prototype.recreateShadowMap=function(){var e=this._shadowMap;if(!!e){var t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(var r=0,n=t;r<n.length;r++){var s=n[r];this._shadowMap.renderList.push(s)}}else this._shadowMap.renderList=null}},i.prototype._disposeBlurPostProcesses=function(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]},i.prototype._disposeRTTandPostProcesses=function(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()},i.prototype._disposeSceneUBOs=function(){if(this._sceneUBOs){for(var e=0,t=this._sceneUBOs;e<t.length;e++){var r=t[e];r.dispose()}this._sceneUBOs=[]}},i.prototype.dispose=function(){this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light&&(this._light._shadowGenerator=null,this._light._markMeshesAsLightDirty()),this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()},i.prototype.serialize=function(){var e={},t=this.getShadowMap();if(!t)return e;if(e.className=this.getClassName(),e.lightId=this._light.id,e.id=this.id,e.mapSize=t.getRenderSize(),e.forceBackFacesOnly=this.forceBackFacesOnly,e.darkness=this.getDarkness(),e.transparencyShadow=this._transparencyShadow,e.frustumEdgeFalloff=this.frustumEdgeFalloff,e.bias=this.bias,e.normalBias=this.normalBias,e.usePercentageCloserFiltering=this.usePercentageCloserFiltering,e.useContactHardeningShadow=this.useContactHardeningShadow,e.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,e.filteringQuality=this.filteringQuality,e.useExponentialShadowMap=this.useExponentialShadowMap,e.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,e.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.usePoissonSampling=this.usePoissonSampling,e.depthScale=this.depthScale,e.blurBoxOffset=this.blurBoxOffset,e.blurKernel=this.blurKernel,e.blurScale=this.blurScale,e.useKernelBlur=this.useKernelBlur,e.renderList=[],t.renderList)for(var r=0;r<t.renderList.length;r++){var n=t.renderList[r];e.renderList.push(n.id)}return e},i.Parse=function(e,t,r){for(var n=t.getLightById(e.lightId),s=r?r(e.mapSize,n):new i(e.mapSize,n),a=s.getShadowMap(),o=0;o<e.renderList.length;o++){var h=t.getMeshesById(e.renderList[o]);h.forEach(function(l){!a||(a.renderList||(a.renderList=[]),a.renderList.push(l))})}return e.id!==void 0&&(s.id=e.id),s.forceBackFacesOnly=!!e.forceBackFacesOnly,e.darkness!==void 0&&s.setDarkness(e.darkness),e.transparencyShadow&&s.setTransparencyShadow(!0),e.frustumEdgeFalloff!==void 0&&(s.frustumEdgeFalloff=e.frustumEdgeFalloff),e.bias!==void 0&&(s.bias=e.bias),e.normalBias!==void 0&&(s.normalBias=e.normalBias),e.usePercentageCloserFiltering?s.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?s.useContactHardeningShadow=!0:e.usePoissonSampling?s.usePoissonSampling=!0:e.useExponentialShadowMap?s.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?s.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?s.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?s.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?s.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(s.useBlurExponentialShadowMap=!0),e.contactHardeningLightSizeUVRatio!==void 0&&(s.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),e.filteringQuality!==void 0&&(s.filteringQuality=e.filteringQuality),e.depthScale&&(s.depthScale=e.depthScale),e.blurScale&&(s.blurScale=e.blurScale),e.blurBoxOffset&&(s.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(s.useKernelBlur=e.useKernelBlur),e.blurKernel&&(s.blurKernel=e.blurKernel),s},i.CLASSNAME="ShadowGenerator",i.FILTER_NONE=0,i.FILTER_EXPONENTIALSHADOWMAP=1,i.FILTER_POISSONSAMPLING=2,i.FILTER_BLUREXPONENTIALSHADOWMAP=3,i.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,i.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,i.FILTER_PCF=6,i.FILTER_PCSS=7,i.QUALITY_HIGH=0,i.QUALITY_MEDIUM=1,i.QUALITY_LOW=2,i.DEFAULT_ALPHA_CUTOFF=.5,i._SceneComponentInitialization=function(e){throw ge("ShadowGeneratorSceneComponent")},i}(),gt=Object.freeze(Object.defineProperty({__proto__:null,ShadowGenerator:ut},Symbol.toStringTag,{value:"Module"}));export{Q as P,U as R,ut as S,gt as s};
