import{A as T,j}from"./@babylonjscore_Misc.329df4d9.js";import{a as c,M as _,E as X,T as m}from"./@babylonjscore_Maths.42afce42.js";import{S as g}from"./@babylonjscore_scene.b072ee35.js";import{A as q}from"./@babylonjscore_Meshes.896ebf22.js";import{P as F,I as H}from"./@babylonjscore_Collisions.8a0e928d.js";import{C as D}from"./@babylonjscore_Cameras.c6ce826c.js";import{E}from"./@babylonjscore_Engines.a7c830c0.js";import{S as B}from"./@babylonjscore_sceneComponent.5f0854c6.js";var W=function(){function i(t,r,e){this.vectors=T.BuildArray(8,c.Zero),this.center=c.Zero(),this.centerWorld=c.Zero(),this.extendSize=c.Zero(),this.extendSizeWorld=c.Zero(),this.directions=T.BuildArray(3,c.Zero),this.vectorsWorld=T.BuildArray(8,c.Zero),this.minimumWorld=c.Zero(),this.maximumWorld=c.Zero(),this.minimum=c.Zero(),this.maximum=c.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(t,r,e)}return i.prototype.reConstruct=function(t,r,e){var n=t.x,o=t.y,a=t.z,s=r.x,f=r.y,u=r.z,h=this.vectors;this.minimum.copyFromFloats(n,o,a),this.maximum.copyFromFloats(s,f,u),h[0].copyFromFloats(n,o,a),h[1].copyFromFloats(s,f,u),h[2].copyFromFloats(s,o,a),h[3].copyFromFloats(n,f,a),h[4].copyFromFloats(n,o,u),h[5].copyFromFloats(s,f,a),h[6].copyFromFloats(n,f,u),h[7].copyFromFloats(s,o,u),r.addToRef(t,this.center).scaleInPlace(.5),r.subtractToRef(t,this.extendSize).scaleInPlace(.5),this._worldMatrix=e||_.IdentityReadOnly,this._update(this._worldMatrix)},i.prototype.scale=function(t){var r=i._TmpVector3,e=this.maximum.subtractToRef(this.minimum,r[0]),n=e.length();e.normalizeFromLength(n);var o=n*t,a=e.scaleInPlace(o*.5),s=this.center.subtractToRef(a,r[1]),f=this.center.addToRef(a,r[2]);return this.reConstruct(s,f,this._worldMatrix),this},i.prototype.getWorldMatrix=function(){return this._worldMatrix},i.prototype._update=function(t){var r=this.minimumWorld,e=this.maximumWorld,n=this.directions,o=this.vectorsWorld,a=this.vectors;if(t.isIdentity()){r.copyFrom(this.minimum),e.copyFrom(this.maximum);for(var s=0;s<8;++s)o[s].copyFrom(a[s]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{r.setAll(Number.MAX_VALUE),e.setAll(-Number.MAX_VALUE);for(var s=0;s<8;++s){var f=o[s];c.TransformCoordinatesToRef(a[s],t,f),r.minimizeInPlace(f),e.maximizeInPlace(f)}e.subtractToRef(r,this.extendSizeWorld).scaleInPlace(.5),e.addToRef(r,this.centerWorld).scaleInPlace(.5)}c.FromArrayToRef(t.m,0,n[0]),c.FromArrayToRef(t.m,4,n[1]),c.FromArrayToRef(t.m,8,n[2]),this._worldMatrix=t},i.prototype.isInFrustum=function(t){return i.IsInFrustum(this.vectorsWorld,t)},i.prototype.isCompletelyInFrustum=function(t){return i.IsCompletelyInFrustum(this.vectorsWorld,t)},i.prototype.intersectsPoint=function(t){var r=this.minimumWorld,e=this.maximumWorld,n=r.x,o=r.y,a=r.z,s=e.x,f=e.y,u=e.z,h=t.x,l=t.y,d=t.z,p=-X;return!(s-h<p||p>h-n||f-l<p||p>l-o||u-d<p||p>d-a)},i.prototype.intersectsSphere=function(t){return i.IntersectsSphere(this.minimumWorld,this.maximumWorld,t.centerWorld,t.radiusWorld)},i.prototype.intersectsMinMax=function(t,r){var e=this.minimumWorld,n=this.maximumWorld,o=e.x,a=e.y,s=e.z,f=n.x,u=n.y,h=n.z,l=t.x,d=t.y,p=t.z,R=r.x,v=r.y,x=r.z;return!(f<l||o>R||u<d||a>v||h<p||s>x)},i.prototype.dispose=function(){var t,r;(t=this._drawWrapperFront)===null||t===void 0||t.dispose(),(r=this._drawWrapperBack)===null||r===void 0||r.dispose()},i.Intersects=function(t,r){return t.intersectsMinMax(r.minimumWorld,r.maximumWorld)},i.IntersectsSphere=function(t,r,e,n){var o=i._TmpVector3[0];c.ClampToRef(e,t,r,o);var a=c.DistanceSquared(e,o);return a<=n*n},i.IsCompletelyInFrustum=function(t,r){for(var e=0;e<6;++e)for(var n=r[e],o=0;o<8;++o)if(n.dotCoordinate(t[o])<0)return!1;return!0},i.IsInFrustum=function(t,r){for(var e=0;e<6;++e){for(var n=!0,o=r[e],a=0;a<8;++a)if(o.dotCoordinate(t[a])>=0){n=!1;break}if(n)return!1}return!0},i._TmpVector3=T.BuildArray(3,c.Zero),i}(),Z=function(){function i(t,r,e){this.center=c.Zero(),this.centerWorld=c.Zero(),this.minimum=c.Zero(),this.maximum=c.Zero(),this.reConstruct(t,r,e)}return i.prototype.reConstruct=function(t,r,e){this.minimum.copyFrom(t),this.maximum.copyFrom(r);var n=c.Distance(t,r);r.addToRef(t,this.center).scaleInPlace(.5),this.radius=n*.5,this._update(e||_.IdentityReadOnly)},i.prototype.scale=function(t){var r=this.radius*t,e=i._TmpVector3,n=e[0].setAll(r),o=this.center.subtractToRef(n,e[1]),a=this.center.addToRef(n,e[2]);return this.reConstruct(o,a,this._worldMatrix),this},i.prototype.getWorldMatrix=function(){return this._worldMatrix},i.prototype._update=function(t){if(t.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{c.TransformCoordinatesToRef(this.center,t,this.centerWorld);var r=i._TmpVector3[0];c.TransformNormalFromFloatsToRef(1,1,1,t,r),this.radiusWorld=Math.max(Math.abs(r.x),Math.abs(r.y),Math.abs(r.z))*this.radius}},i.prototype.isInFrustum=function(t){for(var r=this.centerWorld,e=this.radiusWorld,n=0;n<6;n++)if(t[n].dotCoordinate(r)<=-e)return!1;return!0},i.prototype.isCenterInFrustum=function(t){for(var r=this.centerWorld,e=0;e<6;e++)if(t[e].dotCoordinate(r)<0)return!1;return!0},i.prototype.intersectsPoint=function(t){var r=c.DistanceSquared(this.centerWorld,t);return!(this.radiusWorld*this.radiusWorld<r)},i.Intersects=function(t,r){var e=c.DistanceSquared(t.centerWorld,r.centerWorld),n=t.radiusWorld+r.radiusWorld;return!(n*n<e)},i.CreateFromCenterAndRadius=function(t,r,e){this._TmpVector3[0].copyFrom(t),this._TmpVector3[1].copyFromFloats(0,0,r),this._TmpVector3[2].copyFrom(t),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);var n=new i(this._TmpVector3[0],this._TmpVector3[2]);return e?n._worldMatrix=e:n._worldMatrix=_.Identity(),n},i._TmpVector3=T.BuildArray(3,c.Zero),i}(),P={min:0,max:0},V={min:0,max:0},A=function(i,t,r){var e=c.Dot(t.centerWorld,i),n=Math.abs(c.Dot(t.directions[0],i))*t.extendSize.x,o=Math.abs(c.Dot(t.directions[1],i))*t.extendSize.y,a=Math.abs(c.Dot(t.directions[2],i))*t.extendSize.z,s=n+o+a;r.min=e-s,r.max=e+s},y=function(i,t,r){return A(i,t,P),A(i,r,V),!(P.min>V.max||V.min>P.max)},rt=function(){function i(t,r,e){this._isLocked=!1,this.boundingBox=new W(t,r,e),this.boundingSphere=new Z(t,r,e)}return i.prototype.reConstruct=function(t,r,e){this.boundingBox.reConstruct(t,r,e),this.boundingSphere.reConstruct(t,r,e)},Object.defineProperty(i.prototype,"minimum",{get:function(){return this.boundingBox.minimum},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"maximum",{get:function(){return this.boundingBox.maximum},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isLocked",{get:function(){return this._isLocked},set:function(t){this._isLocked=t},enumerable:!1,configurable:!0}),i.prototype.update=function(t){this._isLocked||(this.boundingBox._update(t),this.boundingSphere._update(t))},i.prototype.centerOn=function(t,r){var e=i._TmpVector3[0].copyFrom(t).subtractInPlace(r),n=i._TmpVector3[1].copyFrom(t).addInPlace(r);return this.boundingBox.reConstruct(e,n,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(e,n,this.boundingBox.getWorldMatrix()),this},i.prototype.encapsulate=function(t){var r=c.Minimize(this.minimum,t),e=c.Maximize(this.maximum,t);return this.reConstruct(r,e,this.boundingBox.getWorldMatrix()),this},i.prototype.encapsulateBoundingInfo=function(t){return this.encapsulate(t.boundingBox.centerWorld.subtract(t.boundingBox.extendSizeWorld)),this.encapsulate(t.boundingBox.centerWorld.add(t.boundingBox.extendSizeWorld)),this},i.prototype.scale=function(t){return this.boundingBox.scale(t),this.boundingSphere.scale(t),this},i.prototype.isInFrustum=function(t,r){r===void 0&&(r=0);var e=r===2||r===3;if(e&&this.boundingSphere.isCenterInFrustum(t))return!0;if(!this.boundingSphere.isInFrustum(t))return!1;var n=r===1||r===3;return n?!0:this.boundingBox.isInFrustum(t)},Object.defineProperty(i.prototype,"diagonalLength",{get:function(){var t=this.boundingBox,r=t.maximumWorld.subtractToRef(t.minimumWorld,i._TmpVector3[0]);return r.length()},enumerable:!1,configurable:!0}),i.prototype.isCompletelyInFrustum=function(t){return this.boundingBox.isCompletelyInFrustum(t)},i.prototype._checkCollision=function(t){return t._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)},i.prototype.intersectsPoint=function(t){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(t)||!this.boundingBox.intersectsPoint(t))},i.prototype.intersects=function(t,r){if(!Z.Intersects(this.boundingSphere,t.boundingSphere)||!W.Intersects(this.boundingBox,t.boundingBox))return!1;if(!r)return!0;var e=this.boundingBox,n=t.boundingBox;return!(!y(e.directions[0],e,n)||!y(e.directions[1],e,n)||!y(e.directions[2],e,n)||!y(n.directions[0],e,n)||!y(n.directions[1],e,n)||!y(n.directions[2],e,n)||!y(c.Cross(e.directions[0],n.directions[0]),e,n)||!y(c.Cross(e.directions[0],n.directions[1]),e,n)||!y(c.Cross(e.directions[0],n.directions[2]),e,n)||!y(c.Cross(e.directions[1],n.directions[0]),e,n)||!y(c.Cross(e.directions[1],n.directions[1]),e,n)||!y(c.Cross(e.directions[1],n.directions[2]),e,n)||!y(c.Cross(e.directions[2],n.directions[0]),e,n)||!y(c.Cross(e.directions[2],n.directions[1]),e,n)||!y(c.Cross(e.directions[2],n.directions[2]),e,n))},i._TmpVector3=T.BuildArray(2,c.Zero),i}(),b=function(){function i(t,r,e){e===void 0&&(e=Number.MAX_VALUE),this.origin=t,this.direction=r,this.length=e}return i.prototype.clone=function(){return new i(this.origin.clone(),this.direction.clone(),this.length)},i.prototype.intersectsBoxMinMax=function(t,r,e){e===void 0&&(e=0);var n=i._TmpVector3[0].copyFromFloats(t.x-e,t.y-e,t.z-e),o=i._TmpVector3[1].copyFromFloats(r.x+e,r.y+e,r.z+e),a=0,s=Number.MAX_VALUE,f,u,h,l;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<n.x||this.origin.x>o.x)return!1}else if(f=1/this.direction.x,u=(n.x-this.origin.x)*f,h=(o.x-this.origin.x)*f,h===-1/0&&(h=1/0),u>h&&(l=u,u=h,h=l),a=Math.max(u,a),s=Math.min(h,s),a>s)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<n.y||this.origin.y>o.y)return!1}else if(f=1/this.direction.y,u=(n.y-this.origin.y)*f,h=(o.y-this.origin.y)*f,h===-1/0&&(h=1/0),u>h&&(l=u,u=h,h=l),a=Math.max(u,a),s=Math.min(h,s),a>s)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<n.z||this.origin.z>o.z)return!1}else if(f=1/this.direction.z,u=(n.z-this.origin.z)*f,h=(o.z-this.origin.z)*f,h===-1/0&&(h=1/0),u>h&&(l=u,u=h,h=l),a=Math.max(u,a),s=Math.min(h,s),a>s)return!1;return!0},i.prototype.intersectsBox=function(t,r){return r===void 0&&(r=0),this.intersectsBoxMinMax(t.minimum,t.maximum,r)},i.prototype.intersectsSphere=function(t,r){r===void 0&&(r=0);var e=t.center.x-this.origin.x,n=t.center.y-this.origin.y,o=t.center.z-this.origin.z,a=e*e+n*n+o*o,s=t.radius+r,f=s*s;if(a<=f)return!0;var u=e*this.direction.x+n*this.direction.y+o*this.direction.z;if(u<0)return!1;var h=a-u*u;return h<=f},i.prototype.intersectsTriangle=function(t,r,e){var n=i._TmpVector3[0],o=i._TmpVector3[1],a=i._TmpVector3[2],s=i._TmpVector3[3],f=i._TmpVector3[4];r.subtractToRef(t,n),e.subtractToRef(t,o),c.CrossToRef(this.direction,o,a);var u=c.Dot(n,a);if(u===0)return null;var h=1/u;this.origin.subtractToRef(t,s);var l=c.Dot(s,a)*h;if(l<0||l>1)return null;c.CrossToRef(s,n,f);var d=c.Dot(this.direction,f)*h;if(d<0||l+d>1)return null;var p=c.Dot(o,f)*h;return p>this.length?null:new H(1-l-d,l,p)},i.prototype.intersectsPlane=function(t){var r,e=c.Dot(t.normal,this.direction);if(Math.abs(e)<999999997475243e-21)return null;var n=c.Dot(t.normal,this.origin);return r=(-t.d-n)/e,r<0?r<-999999997475243e-21?null:0:r},i.prototype.intersectsAxis=function(t,r){switch(r===void 0&&(r=0),t){case"y":{var e=(this.origin.y-r)/this.direction.y;return e>0?null:new c(this.origin.x+this.direction.x*-e,r,this.origin.z+this.direction.z*-e)}case"x":{var e=(this.origin.x-r)/this.direction.x;return e>0?null:new c(r,this.origin.y+this.direction.y*-e,this.origin.z+this.direction.z*-e)}case"z":{var e=(this.origin.z-r)/this.direction.z;return e>0?null:new c(this.origin.x+this.direction.x*-e,this.origin.y+this.direction.y*-e,r)}default:return null}},i.prototype.intersectsMesh=function(t,r){var e=m.Matrix[0];return t.getWorldMatrix().invertToRef(e),this._tmpRay?i.TransformToRef(this,e,this._tmpRay):this._tmpRay=i.Transform(this,e),t.intersects(this._tmpRay,r)},i.prototype.intersectsMeshes=function(t,r,e){e?e.length=0:e=[];for(var n=0;n<t.length;n++){var o=this.intersectsMesh(t[n],r);o.hit&&e.push(o)}return e.sort(this._comparePickingInfo),e},i.prototype._comparePickingInfo=function(t,r){return t.distance<r.distance?-1:t.distance>r.distance?1:0},i.prototype.intersectionSegment=function(t,r,e){var n=this.origin,o=m.Vector3[0],a=m.Vector3[1],s=m.Vector3[2],f=m.Vector3[3];r.subtractToRef(t,o),this.direction.scaleToRef(i._Rayl,s),n.addToRef(s,a),t.subtractToRef(n,f);var u=c.Dot(o,o),h=c.Dot(o,s),l=c.Dot(s,s),d=c.Dot(o,f),p=c.Dot(s,f),R=u*l-h*h,v,x=R,M,C=R;R<i._Smallnum?(v=0,x=1,M=p,C=l):(v=h*p-l*d,M=u*p-h*d,v<0?(v=0,M=p,C=l):v>x&&(v=x,M=p+h,C=l)),M<0?(M=0,-d<0?v=0:-d>u?v=x:(v=-d,x=u)):M>C&&(M=C,-d+h<0?v=0:-d+h>u?v=x:(v=-d+h,x=u));var N=Math.abs(v)<i._Smallnum?0:v/x,S=Math.abs(M)<i._Smallnum?0:M/C,z=m.Vector3[4];s.scaleToRef(S,z);var I=m.Vector3[5];o.scaleToRef(N,I),I.addInPlace(f);var O=m.Vector3[6];I.subtractToRef(z,O);var L=S>0&&S<=this.length&&O.lengthSquared()<e*e;return L?I.length():-1},i.prototype.update=function(t,r,e,n,o,a,s,f){if(f===void 0&&(f=!1),f){i._RayDistant||(i._RayDistant=i.Zero()),i._RayDistant.unprojectRayToRef(t,r,e,n,_.IdentityReadOnly,a,s);var u=m.Matrix[0];o.invertToRef(u),i.TransformToRef(i._RayDistant,u,this)}else this.unprojectRayToRef(t,r,e,n,o,a,s);return this},i.Zero=function(){return new i(c.Zero(),c.Zero())},i.CreateNew=function(t,r,e,n,o,a,s){var f=i.Zero();return f.update(t,r,e,n,o,a,s)},i.CreateNewFromTo=function(t,r,e){e===void 0&&(e=_.IdentityReadOnly);var n=r.subtract(t),o=Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z);return n.normalize(),i.Transform(new i(t,n,o),e)},i.Transform=function(t,r){var e=new i(new c(0,0,0),new c(0,0,0));return i.TransformToRef(t,r,e),e},i.TransformToRef=function(t,r,e){c.TransformCoordinatesToRef(t.origin,r,e.origin),c.TransformNormalToRef(t.direction,r,e.direction),e.length=t.length;var n=e.direction,o=n.length();if(!(o===0||o===1)){var a=1/o;n.x*=a,n.y*=a,n.z*=a,e.length*=o}},i.prototype.unprojectRayToRef=function(t,r,e,n,o,a,s){var f,u=m.Matrix[0];o.multiplyToRef(a,u),u.multiplyToRef(s,u),u.invert();var h=m.Vector3[0];h.x=t/e*2-1,h.y=-(r/n*2-1),h.z=!((f=E.LastCreatedEngine)===null||f===void 0)&&f.isNDCHalfZRange?0:-1;var l=m.Vector3[1].copyFromFloats(h.x,h.y,1-1e-8),d=m.Vector3[2],p=m.Vector3[3];c._UnprojectFromInvertedMatrixToRef(h,u,d),c._UnprojectFromInvertedMatrixToRef(l,u,p),this.origin.copyFrom(d),p.subtractToRef(d,this.direction),this.direction.normalize()},i._TmpVector3=T.BuildArray(6,c.Zero),i._RayDistant=i.Zero(),i._Smallnum=1e-8,i._Rayl=1e9,i}();g.prototype.createPickingRay=function(i,t,r,e,n){n===void 0&&(n=!1);var o=b.Zero();return this.createPickingRayToRef(i,t,r,o,e,n),o};g.prototype.createPickingRayToRef=function(i,t,r,e,n,o,a){o===void 0&&(o=!1),a===void 0&&(a=!1);var s=this.getEngine();if(!n){if(!this.activeCamera)return this;n=this.activeCamera}var f=n.viewport,u=f.toGlobal(s.getRenderWidth(),s.getRenderHeight());return i=i/s.getHardwareScalingLevel()-u.x,t=t/s.getHardwareScalingLevel()-(s.getRenderHeight()-u.y-u.height),e.update(i,t,u.width,u.height,r||_.IdentityReadOnly,o?_.IdentityReadOnly:n.getViewMatrix(),n.getProjectionMatrix(),a),this};g.prototype.createPickingRayInCameraSpace=function(i,t,r){var e=b.Zero();return this.createPickingRayInCameraSpaceToRef(i,t,e,r),e};g.prototype.createPickingRayInCameraSpaceToRef=function(i,t,r,e){if(!F)return this;var n=this.getEngine();if(!e){if(!this.activeCamera)throw new Error("Active camera not set");e=this.activeCamera}var o=e.viewport,a=o.toGlobal(n.getRenderWidth(),n.getRenderHeight()),s=_.Identity();return i=i/n.getHardwareScalingLevel()-a.x,t=t/n.getHardwareScalingLevel()-(n.getRenderHeight()-a.y-a.height),r.update(i,t,a.width,a.height,s,s,e.getProjectionMatrix()),this};g.prototype._internalPickForMesh=function(i,t,r,e,n,o,a,s){var f=t(e,r.enableDistantPicking),u=r.intersects(f,n,a,o,e,s);return!u||!u.hit||!n&&i!=null&&u.distance>=i.distance?null:u};g.prototype._internalPick=function(i,t,r,e,n){if(!F)return null;for(var o=null,a=0;a<this.meshes.length;a++){var s=this.meshes[a];if(t){if(!t(s))continue}else if(!s.isEnabled()||!s.isVisible||!s.isPickable)continue;var f=s.getWorldMatrix();if(s.hasThinInstances&&s.thinInstanceEnablePicking){var u=this._internalPickForMesh(o,i,s,f,!0,!0,n);if(u){if(e)return u;for(var h=m.Matrix[1],l=s.thinInstanceGetWorldMatrices(),d=0;d<l.length;d++){var p=l[d];p.multiplyToRef(f,h);var R=this._internalPickForMesh(o,i,s,h,r,e,n,!0);if(R&&(o=R,o.thinInstanceIndex=d,r))return o}}}else{var u=this._internalPickForMesh(o,i,s,f,r,e,n);if(u&&(o=u,r))return o}}return o||new F};g.prototype._internalMultiPick=function(i,t,r){if(!F)return null;for(var e=new Array,n=0;n<this.meshes.length;n++){var o=this.meshes[n];if(t){if(!t(o))continue}else if(!o.isEnabled()||!o.isVisible||!o.isPickable)continue;var a=o.getWorldMatrix();if(o.hasThinInstances&&o.thinInstanceEnablePicking){var s=this._internalPickForMesh(null,i,o,a,!0,!0,r);if(s)for(var f=m.Matrix[1],u=o.thinInstanceGetWorldMatrices(),h=0;h<u.length;h++){var l=u[h];l.multiplyToRef(a,f);var d=this._internalPickForMesh(null,i,o,f,!1,!1,r,!0);d&&(d.thinInstanceIndex=h,e.push(d))}}else{var s=this._internalPickForMesh(null,i,o,a,!1,!1,r);s&&e.push(s)}}return e};g.prototype.pickWithBoundingInfo=function(i,t,r,e,n){var o=this;if(!F)return null;var a=this._internalPick(function(s){return o._tempPickingRay||(o._tempPickingRay=b.Zero()),o.createPickingRayToRef(i,t,s,o._tempPickingRay,n||null),o._tempPickingRay},r,e,!0);return a&&(a.ray=this.createPickingRay(i,t,_.Identity(),n||null)),a};g.prototype.pick=function(i,t,r,e,n,o,a){var s=this;if(!F)return null;var f=this._internalPick(function(u,h){return s._tempPickingRay||(s._tempPickingRay=b.Zero()),s.createPickingRayToRef(i,t,u,s._tempPickingRay,n||null,!1,h),s._tempPickingRay},r,e,!1,o);return f&&(f.ray=this.createPickingRay(i,t,_.Identity(),n||null)),f};g.prototype.pickWithRay=function(i,t,r,e){var n=this,o=this._internalPick(function(a){return n._pickWithRayInverseMatrix||(n._pickWithRayInverseMatrix=_.Identity()),a.invertToRef(n._pickWithRayInverseMatrix),n._cachedRayForTransform||(n._cachedRayForTransform=b.Zero()),b.TransformToRef(i,n._pickWithRayInverseMatrix,n._cachedRayForTransform),n._cachedRayForTransform},t,r,!1,e);return o&&(o.ray=i),o};g.prototype.multiPick=function(i,t,r,e,n){var o=this;return this._internalMultiPick(function(a){return o.createPickingRay(i,t,a,e||null)},r,n)};g.prototype.multiPickWithRay=function(i,t,r){var e=this;return this._internalMultiPick(function(n){return e._pickWithRayInverseMatrix||(e._pickWithRayInverseMatrix=_.Identity()),n.invertToRef(e._pickWithRayInverseMatrix),e._cachedRayForTransform||(e._cachedRayForTransform=b.Zero()),b.TransformToRef(i,e._pickWithRayInverseMatrix,e._cachedRayForTransform),e._cachedRayForTransform},t,r)};D.prototype.getForwardRay=function(i,t,r){return i===void 0&&(i=100),this.getForwardRayToRef(new b(c.Zero(),c.Zero(),i),i,t,r)};D.prototype.getForwardRayToRef=function(i,t,r,e){return t===void 0&&(t=100),r||(r=this.getWorldMatrix()),i.length=t,e?i.origin.copyFrom(e):i.origin.copyFrom(this.position),m.Vector3[2].set(0,0,this._scene.useRightHandedSystem?-1:1),c.TransformNormalToRef(m.Vector3[2],r,m.Vector3[3]),c.NormalizeToRef(m.Vector3[3],i.direction),i};var Y=function(){function i(t,r,e,n,o,a){this.entries=new Array,this._boundingVectors=new Array,this._capacity=e,this._depth=n,this._maxDepth=o,this._creationFunc=a,this._minPoint=t,this._maxPoint=r,this._boundingVectors.push(t.clone()),this._boundingVectors.push(r.clone()),this._boundingVectors.push(t.clone()),this._boundingVectors[2].x=r.x,this._boundingVectors.push(t.clone()),this._boundingVectors[3].y=r.y,this._boundingVectors.push(t.clone()),this._boundingVectors[4].z=r.z,this._boundingVectors.push(r.clone()),this._boundingVectors[5].z=t.z,this._boundingVectors.push(r.clone()),this._boundingVectors[6].x=t.x,this._boundingVectors.push(r.clone()),this._boundingVectors[7].y=t.y}return Object.defineProperty(i.prototype,"capacity",{get:function(){return this._capacity},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"minPoint",{get:function(){return this._minPoint},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"maxPoint",{get:function(){return this._maxPoint},enumerable:!1,configurable:!0}),i.prototype.addEntry=function(t){if(this.blocks){for(var r=0;r<this.blocks.length;r++){var e=this.blocks[r];e.addEntry(t)}return}this._creationFunc(t,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()},i.prototype.removeEntry=function(t){if(this.blocks){for(var r=0;r<this.blocks.length;r++){var e=this.blocks[r];e.removeEntry(t)}return}var n=this.entries.indexOf(t);n>-1&&this.entries.splice(n,1)},i.prototype.addEntries=function(t){for(var r=0;r<t.length;r++){var e=t[r];this.addEntry(e)}},i.prototype.select=function(t,r,e){if(W.IsInFrustum(this._boundingVectors,t)){if(this.blocks){for(var n=0;n<this.blocks.length;n++){var o=this.blocks[n];o.select(t,r,e)}return}e?r.concat(this.entries):r.concatWithNoDuplicate(this.entries)}},i.prototype.intersects=function(t,r,e,n){if(W.IntersectsSphere(this._minPoint,this._maxPoint,t,r)){if(this.blocks){for(var o=0;o<this.blocks.length;o++){var a=this.blocks[o];a.intersects(t,r,e,n)}return}n?e.concat(this.entries):e.concatWithNoDuplicate(this.entries)}},i.prototype.intersectsRay=function(t,r){if(t.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(var e=0;e<this.blocks.length;e++){var n=this.blocks[e];n.intersectsRay(t,r)}return}r.concatWithNoDuplicate(this.entries)}},i.prototype.createInnerBlocks=function(){i._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc)},i._CreateBlocks=function(t,r,e,n,o,a,s,f){s.blocks=new Array;for(var u=new c((r.x-t.x)/2,(r.y-t.y)/2,(r.z-t.z)/2),h=0;h<2;h++)for(var l=0;l<2;l++)for(var d=0;d<2;d++){var p=t.add(u.multiplyByFloats(h,l,d)),R=t.add(u.multiplyByFloats(h+1,l+1,d+1)),v=new i(p,R,n,o+1,a,f);v.addEntries(e),s.blocks.push(v)}},i}(),k=function(){function i(t,r,e){e===void 0&&(e=2),this.maxDepth=e,this.dynamicContent=new Array,this._maxBlockCapacity=r||64,this._selectionContent=new j(1024),this._creationFunc=t}return i.prototype.update=function(t,r,e){Y._CreateBlocks(t,r,e,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)},i.prototype.addMesh=function(t){for(var r=0;r<this.blocks.length;r++){var e=this.blocks[r];e.addEntry(t)}},i.prototype.removeMesh=function(t){for(var r=0;r<this.blocks.length;r++){var e=this.blocks[r];e.removeEntry(t)}},i.prototype.select=function(t,r){this._selectionContent.reset();for(var e=0;e<this.blocks.length;e++){var n=this.blocks[e];n.select(t,this._selectionContent,r)}return r?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},i.prototype.intersects=function(t,r,e){this._selectionContent.reset();for(var n=0;n<this.blocks.length;n++){var o=this.blocks[n];o.intersects(t,r,this._selectionContent,e)}return e?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},i.prototype.intersectsRay=function(t){this._selectionContent.reset();for(var r=0;r<this.blocks.length;r++){var e=this.blocks[r];e.intersectsRay(t,this._selectionContent)}return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},i.CreationFuncForMeshes=function(t,r){var e=t.getBoundingInfo();!t.isBlocked&&e.boundingBox.intersectsMinMax(r.minPoint,r.maxPoint)&&r.entries.push(t)},i.CreationFuncForSubMeshes=function(t,r){var e=t.getBoundingInfo();e.boundingBox.intersectsMinMax(r.minPoint,r.maxPoint)&&r.entries.push(t)},i}();g.prototype.createOrUpdateSelectionOctree=function(i,t){i===void 0&&(i=64),t===void 0&&(t=2);var r=this._getComponent(B.NAME_OCTREE);r||(r=new w(this),this._addComponent(r)),this._selectionOctree||(this._selectionOctree=new k(k.CreationFuncForMeshes,i,t));var e=this.getWorldExtends();return this._selectionOctree.update(e.min,e.max,this.meshes),this._selectionOctree};Object.defineProperty(g.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0});q.prototype.createOrUpdateSubmeshesOctree=function(i,t){i===void 0&&(i=64),t===void 0&&(t=2);var r=this.getScene(),e=r._getComponent(B.NAME_OCTREE);e||(e=new w(r),r._addComponent(e)),this._submeshesOctree||(this._submeshesOctree=new k(k.CreationFuncForSubMeshes,i,t)),this.computeWorldMatrix(!0);var n=this.getBoundingInfo(),o=n.boundingBox;return this._submeshesOctree.update(o.minimumWorld,o.maximumWorld,this.subMeshes),this._submeshesOctree};var w=function(){function i(t){this.name=B.NAME_OCTREE,this.checksIsEnabled=!0,this._tempRay=new b(c.Zero(),new c(1,1,1)),t=t||E.LastCreatedScene,t&&(this.scene=t,this.scene.getActiveMeshCandidates=this.getActiveMeshCandidates.bind(this),this.scene.getActiveSubMeshCandidates=this.getActiveSubMeshCandidates.bind(this),this.scene.getCollidingSubMeshCandidates=this.getCollidingSubMeshCandidates.bind(this),this.scene.getIntersectingSubMeshCandidates=this.getIntersectingSubMeshCandidates.bind(this))}return i.prototype.register=function(){var t=this;this.scene.onMeshRemovedObservable.add(function(r){var e=t.scene.selectionOctree;if(e!=null){var n=e.dynamicContent.indexOf(r);n!==-1&&e.dynamicContent.splice(n,1)}}),this.scene.onMeshImportedObservable.add(function(r){var e=t.scene.selectionOctree;e!=null&&e.addMesh(r)})},i.prototype.getActiveMeshCandidates=function(){if(this.scene._selectionOctree){var t=this.scene._selectionOctree.select(this.scene.frustumPlanes);return t}return this.scene._getDefaultMeshCandidates()},i.prototype.getActiveSubMeshCandidates=function(t){if(t._submeshesOctree&&t.useOctreeForRenderingSelection){var r=t._submeshesOctree.select(this.scene.frustumPlanes);return r}return this.scene._getDefaultSubMeshCandidates(t)},i.prototype.getIntersectingSubMeshCandidates=function(t,r){if(t._submeshesOctree&&t.useOctreeForPicking){b.TransformToRef(r,t.getWorldMatrix(),this._tempRay);var e=t._submeshesOctree.intersectsRay(this._tempRay);return e}return this.scene._getDefaultSubMeshCandidates(t)},i.prototype.getCollidingSubMeshCandidates=function(t,r){if(t._submeshesOctree&&t.useOctreeForCollisions){var e=r._velocityWorldLength+Math.max(r._radius.x,r._radius.y,r._radius.z),n=t._submeshesOctree.intersects(r._basePointWorld,e);return n}return this.scene._getDefaultSubMeshCandidates(t)},i.prototype.rebuild=function(){},i.prototype.dispose=function(){},i}();export{rt as B,b as R,Z as a};
