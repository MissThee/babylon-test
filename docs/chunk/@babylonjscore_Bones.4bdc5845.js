import{_ as E}from"./tslibtslib.b6e59fa7.js";import{T as O,Q as y,a as m,M as c,e as u,A as F}from"./@babylonjscore_Maths.f3ef132c.js";import{A as D,L as w,D as U,O as H}from"./@babylonjscore_Misc.d81f49ec.js";import{N as X}from"./@babylonjscore_node.60f33419.js";import{R as S}from"./@babylonjscore_Materials.00e32dae.js";import{b as W,A as Q}from"./@babylonjscore_Animations.615099a9.js";import{E as N}from"./@babylonjscore_Engines.7287f97a.js";var B=function(a){E(t,a);function t(e,i,r,o,s,n,f){r===void 0&&(r=null),o===void 0&&(o=null),s===void 0&&(s=null),n===void 0&&(n=null),f===void 0&&(f=null);var h=a.call(this,e,i.getScene())||this;return h.name=e,h.children=new Array,h.animations=new Array,h._index=null,h._absoluteTransform=new c,h._invertedAbsoluteTransform=new c,h._scalingDeterminant=1,h._worldTransform=new c,h._needToDecompose=!0,h._needToCompose=!1,h._linkedTransformNode=null,h._waitingTransformNodeId=null,h._skeleton=i,h._localMatrix=o?o.clone():c.Identity(),h._restPose=s||h._localMatrix.clone(),h._baseMatrix=n||h._localMatrix.clone(),h._index=f,i.bones.push(h),h.setParent(r,!1),(n||o)&&h._updateDifferenceMatrix(),h}return Object.defineProperty(t.prototype,"_matrix",{get:function(){return this._compose(),this._localMatrix},set:function(e){this._needToCompose=!1,e.updateFlag!==this._localMatrix.updateFlag&&(this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"Bone"},t.prototype.getSkeleton=function(){return this._skeleton},Object.defineProperty(t.prototype,"parent",{get:function(){return this._parentNode},set:function(e){this.setParent(e)},enumerable:!1,configurable:!0}),t.prototype.getParent=function(){return this.parent},t.prototype.getChildren=function(){return this.children},t.prototype.getIndex=function(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index},t.prototype.setParent=function(e,i){if(i===void 0&&(i=!0),this.parent!==e){if(this.parent){var r=this.parent.children.indexOf(this);r!==-1&&this.parent.children.splice(r,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),i&&this._updateDifferenceMatrix(),this.markAsDirty()}},t.prototype.getLocalMatrix=function(){return this._compose(),this._localMatrix},t.prototype.getBaseMatrix=function(){return this._baseMatrix},t.prototype.getRestPose=function(){return this._restPose},t.prototype.setRestPose=function(e){this._restPose.copyFrom(e)},t.prototype.getBindPose=function(){return this._baseMatrix},t.prototype.setBindPose=function(e){this.updateMatrix(e)},t.prototype.getWorldMatrix=function(){return this._worldTransform},t.prototype.returnToRest=function(){var e;if(this._linkedTransformNode){var i=O.Vector3[0],r=O.Quaternion[0],o=O.Vector3[1];this.getRestPose().decompose(i,r,o),this._linkedTransformNode.position.copyFrom(o),this._linkedTransformNode.rotationQuaternion=(e=this._linkedTransformNode.rotationQuaternion)!==null&&e!==void 0?e:y.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(r),this._linkedTransformNode.scaling.copyFrom(i)}else this._matrix=this._restPose},t.prototype.getInvertedAbsoluteTransform=function(){return this._invertedAbsoluteTransform},t.prototype.getAbsoluteTransform=function(){return this._absoluteTransform},t.prototype.linkTransformNode=function(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++},t.prototype.getTransformNode=function(){return this._linkedTransformNode},Object.defineProperty(t.prototype,"position",{get:function(){return this._decompose(),this._localPosition},set:function(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rotation",{get:function(){return this.getRotation()},set:function(e){this.setRotation(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rotationQuaternion",{get:function(){return this._decompose(),this._localRotation},set:function(e){this.setRotationQuaternion(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"scaling",{get:function(){return this.getScale()},set:function(e){this.setScale(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"animationPropertiesOverride",{get:function(){return this._skeleton.animationPropertiesOverride},enumerable:!1,configurable:!0}),t.prototype._decompose=function(){!this._needToDecompose||(this._needToDecompose=!1,this._localScaling||(this._localScaling=m.Zero(),this._localRotation=y.Zero(),this._localPosition=m.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))},t.prototype._compose=function(){if(!!this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,c.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}},t.prototype.updateMatrix=function(e,i,r){i===void 0&&(i=!0),r===void 0&&(r=!0),this._baseMatrix.copyFrom(e),i&&this._updateDifferenceMatrix(),r?this._matrix=e:this.markAsDirty()},t.prototype._updateDifferenceMatrix=function(e,i){if(i===void 0&&(i=!0),e||(e=this._baseMatrix),this.parent?e.multiplyToRef(this.parent._absoluteTransform,this._absoluteTransform):this._absoluteTransform.copyFrom(e),this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform),i)for(var r=0;r<this.children.length;r++)this.children[r]._updateDifferenceMatrix();this._scalingDeterminant=this._absoluteTransform.determinant()<0?-1:1},t.prototype.markAsDirty=function(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this},t.prototype._markAsDirtyAndCompose=function(){this.markAsDirty(),this._needToCompose=!0},t.prototype._markAsDirtyAndDecompose=function(){this.markAsDirty(),this._needToDecompose=!0},t.prototype.translate=function(e,i,r){i===void 0&&(i=u.LOCAL);var o=this.getLocalMatrix();if(i==u.LOCAL)o.addAtIndex(12,e.x),o.addAtIndex(13,e.y),o.addAtIndex(14,e.z);else{var s=null;r&&(s=r.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var n=t._TmpMats[0],f=t._TmpVecs[0];this.parent?r&&s?(n.copyFrom(this.parent.getAbsoluteTransform()),n.multiplyToRef(s,n)):n.copyFrom(this.parent.getAbsoluteTransform()):c.IdentityToRef(n),n.setTranslationFromFloats(0,0,0),n.invert(),m.TransformCoordinatesToRef(e,n,f),o.addAtIndex(12,f.x),o.addAtIndex(13,f.y),o.addAtIndex(14,f.z)}this._markAsDirtyAndDecompose()},t.prototype.setPosition=function(e,i,r){i===void 0&&(i=u.LOCAL);var o=this.getLocalMatrix();if(i==u.LOCAL)o.setTranslationFromFloats(e.x,e.y,e.z);else{var s=null;r&&(s=r.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var n=t._TmpMats[0],f=t._TmpVecs[0];this.parent?(r&&s?(n.copyFrom(this.parent.getAbsoluteTransform()),n.multiplyToRef(s,n)):n.copyFrom(this.parent.getAbsoluteTransform()),n.invert()):c.IdentityToRef(n),m.TransformCoordinatesToRef(e,n,f),o.setTranslationFromFloats(f.x,f.y,f.z)}this._markAsDirtyAndDecompose()},t.prototype.setAbsolutePosition=function(e,i){this.setPosition(e,u.WORLD,i)},t.prototype.scale=function(e,i,r,o){o===void 0&&(o=!1);var s=this.getLocalMatrix(),n=t._TmpMats[0];c.ScalingToRef(e,i,r,n),n.multiplyToRef(s,s),n.invert();for(var f=0,h=this.children;f<h.length;f++){var _=h[f],p=_.getLocalMatrix();p.multiplyToRef(n,p),p.multiplyAtIndex(12,e),p.multiplyAtIndex(13,i),p.multiplyAtIndex(14,r),_._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),o)for(var T=0,d=this.children;T<d.length;T++){var _=d[T];_.scale(e,i,r,o)}},t.prototype.setScale=function(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()},t.prototype.getScale=function(){return this._decompose(),this._localScaling},t.prototype.getScaleToRef=function(e){this._decompose(),e.copyFrom(this._localScaling)},t.prototype.setYawPitchRoll=function(e,i,r,o,s){if(o===void 0&&(o=u.LOCAL),o===u.LOCAL){var n=t._TmpQuat;y.RotationYawPitchRollToRef(e,i,r,n),this.setRotationQuaternion(n,o,s);return}var f=t._TmpMats[0];if(!!this._getNegativeRotationToRef(f,s)){var h=t._TmpMats[1];c.RotationYawPitchRollToRef(e,i,r,h),f.multiplyToRef(h,h),this._rotateWithMatrix(h,o,s)}},t.prototype.rotate=function(e,i,r,o){r===void 0&&(r=u.LOCAL);var s=t._TmpMats[0];s.setTranslationFromFloats(0,0,0),c.RotationAxisToRef(e,i,s),this._rotateWithMatrix(s,r,o)},t.prototype.setAxisAngle=function(e,i,r,o){if(r===void 0&&(r=u.LOCAL),r===u.LOCAL){var s=t._TmpQuat;y.RotationAxisToRef(e,i,s),this.setRotationQuaternion(s,r,o);return}var n=t._TmpMats[0];if(!!this._getNegativeRotationToRef(n,o)){var f=t._TmpMats[1];c.RotationAxisToRef(e,i,f),n.multiplyToRef(f,f),this._rotateWithMatrix(f,r,o)}},t.prototype.setRotation=function(e,i,r){i===void 0&&(i=u.LOCAL),this.setYawPitchRoll(e.y,e.x,e.z,i,r)},t.prototype.setRotationQuaternion=function(e,i,r){if(i===void 0&&(i=u.LOCAL),i===u.LOCAL){this._decompose(),this._localRotation.copyFrom(e),this._markAsDirtyAndCompose();return}var o=t._TmpMats[0];if(!!this._getNegativeRotationToRef(o,r)){var s=t._TmpMats[1];c.FromQuaternionToRef(e,s),o.multiplyToRef(s,s),this._rotateWithMatrix(s,i,r)}},t.prototype.setRotationMatrix=function(e,i,r){if(i===void 0&&(i=u.LOCAL),i===u.LOCAL){var o=t._TmpQuat;y.FromRotationMatrixToRef(e,o),this.setRotationQuaternion(o,i,r);return}var s=t._TmpMats[0];if(!!this._getNegativeRotationToRef(s,r)){var n=t._TmpMats[1];n.copyFrom(e),s.multiplyToRef(e,n),this._rotateWithMatrix(n,i,r)}},t.prototype._rotateWithMatrix=function(e,i,r){i===void 0&&(i=u.LOCAL);var o=this.getLocalMatrix(),s=o.m[12],n=o.m[13],f=o.m[14],h=this.getParent(),_=t._TmpMats[3],p=t._TmpMats[4];h&&i==u.WORLD?(r?(_.copyFrom(r.getWorldMatrix()),h.getAbsoluteTransform().multiplyToRef(_,_)):_.copyFrom(h.getAbsoluteTransform()),p.copyFrom(_),p.invert(),o.multiplyToRef(_,o),o.multiplyToRef(e,o),o.multiplyToRef(p,o)):i==u.WORLD&&r?(_.copyFrom(r.getWorldMatrix()),p.copyFrom(_),p.invert(),o.multiplyToRef(_,o),o.multiplyToRef(e,o),o.multiplyToRef(p,o)):o.multiplyToRef(e,o),o.setTranslationFromFloats(s,n,f),this.computeAbsoluteTransforms(),this._markAsDirtyAndDecompose()},t.prototype._getNegativeRotationToRef=function(e,i){var r=t._TmpMats[2];return e.copyFrom(this.getAbsoluteTransform()),i?(e.multiplyToRef(i.getWorldMatrix(),e),c.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,r)):c.IdentityToRef(r),e.invert(),isNaN(e.m[0])?!1:(r.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(r,e),!0)},t.prototype.getPosition=function(e,i){e===void 0&&(e=u.LOCAL),i===void 0&&(i=null);var r=m.Zero();return this.getPositionToRef(e,i,r),r},t.prototype.getPositionToRef=function(e,i,r){if(e===void 0&&(e=u.LOCAL),e==u.LOCAL){var o=this.getLocalMatrix();r.x=o.m[12],r.y=o.m[13],r.z=o.m[14]}else{var s=null;i&&(s=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var n=t._TmpMats[0];i&&s?(n.copyFrom(this.getAbsoluteTransform()),n.multiplyToRef(s,n)):n=this.getAbsoluteTransform(),r.x=n.m[12],r.y=n.m[13],r.z=n.m[14]}},t.prototype.getAbsolutePosition=function(e){e===void 0&&(e=null);var i=m.Zero();return this.getPositionToRef(u.WORLD,e,i),i},t.prototype.getAbsolutePositionToRef=function(e,i){this.getPositionToRef(u.WORLD,e,i)},t.prototype.computeAbsoluteTransforms=function(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteTransform,this._absoluteTransform);else{this._absoluteTransform.copyFrom(this._localMatrix);var e=this._skeleton.getPoseMatrix();e&&this._absoluteTransform.multiplyToRef(e,this._absoluteTransform)}for(var i=this.children,r=i.length,o=0;o<r;o++)i[o].computeAbsoluteTransforms()},t.prototype.getDirection=function(e,i){i===void 0&&(i=null);var r=m.Zero();return this.getDirectionToRef(e,i,r),r},t.prototype.getDirectionToRef=function(e,i,r){i===void 0&&(i=null);var o=null;i&&(o=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var s=t._TmpMats[0];s.copyFrom(this.getAbsoluteTransform()),i&&o&&s.multiplyToRef(o,s),m.TransformNormalToRef(e,s,r),r.normalize()},t.prototype.getRotation=function(e,i){e===void 0&&(e=u.LOCAL),i===void 0&&(i=null);var r=m.Zero();return this.getRotationToRef(e,i,r),r},t.prototype.getRotationToRef=function(e,i,r){e===void 0&&(e=u.LOCAL),i===void 0&&(i=null);var o=t._TmpQuat;this.getRotationQuaternionToRef(e,i,o),o.toEulerAnglesToRef(r)},t.prototype.getRotationQuaternion=function(e,i){e===void 0&&(e=u.LOCAL),i===void 0&&(i=null);var r=y.Identity();return this.getRotationQuaternionToRef(e,i,r),r},t.prototype.getRotationQuaternionToRef=function(e,i,r){if(e===void 0&&(e=u.LOCAL),i===void 0&&(i=null),e==u.LOCAL)this._decompose(),r.copyFrom(this._localRotation);else{var o=t._TmpMats[0],s=this.getAbsoluteTransform();i?s.multiplyToRef(i.getWorldMatrix(),o):o.copyFrom(s),o.multiplyAtIndex(0,this._scalingDeterminant),o.multiplyAtIndex(1,this._scalingDeterminant),o.multiplyAtIndex(2,this._scalingDeterminant),o.decompose(void 0,r,void 0)}},t.prototype.getRotationMatrix=function(e,i){e===void 0&&(e=u.LOCAL);var r=c.Identity();return this.getRotationMatrixToRef(e,i,r),r},t.prototype.getRotationMatrixToRef=function(e,i,r){if(e===void 0&&(e=u.LOCAL),e==u.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(r);else{var o=t._TmpMats[0],s=this.getAbsoluteTransform();i?s.multiplyToRef(i.getWorldMatrix(),o):o.copyFrom(s),o.multiplyAtIndex(0,this._scalingDeterminant),o.multiplyAtIndex(1,this._scalingDeterminant),o.multiplyAtIndex(2,this._scalingDeterminant),o.getRotationMatrixToRef(r)}},t.prototype.getAbsolutePositionFromLocal=function(e,i){i===void 0&&(i=null);var r=m.Zero();return this.getAbsolutePositionFromLocalToRef(e,i,r),r},t.prototype.getAbsolutePositionFromLocalToRef=function(e,i,r){i===void 0&&(i=null);var o=null;i&&(o=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var s=t._TmpMats[0];i&&o?(s.copyFrom(this.getAbsoluteTransform()),s.multiplyToRef(o,s)):s=this.getAbsoluteTransform(),m.TransformCoordinatesToRef(e,s,r)},t.prototype.getLocalPositionFromAbsolute=function(e,i){i===void 0&&(i=null);var r=m.Zero();return this.getLocalPositionFromAbsoluteToRef(e,i,r),r},t.prototype.getLocalPositionFromAbsoluteToRef=function(e,i,r){i===void 0&&(i=null);var o=null;i&&(o=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var s=t._TmpMats[0];s.copyFrom(this.getAbsoluteTransform()),i&&o&&s.multiplyToRef(o,s),s.invert(),m.TransformCoordinatesToRef(e,s,r)},t.prototype.setCurrentPoseAsRest=function(){this.setRestPose(this.getLocalMatrix())},t._TmpVecs=D.BuildArray(2,m.Zero),t._TmpQuat=y.Identity(),t._TmpMats=D.BuildArray(5,c.Identity),t}(X);(function(){function a(t,e,i){if(this.targetPosition=m.Zero(),this.poleTargetPosition=m.Zero(),this.poleTargetLocalOffset=m.Zero(),this.poleAngle=0,this.slerpAmount=1,this._bone1Quat=y.Identity(),this._bone1Mat=c.Identity(),this._bone2Ang=Math.PI,this._maxAngle=Math.PI,this._rightHandedSystem=!1,this._bendAxis=m.Right(),this._slerping=!1,this._adjustRoll=0,this._bone2=e,this._bone1=e.getParent(),!!this._bone1){this.mesh=t;var r=e.getPosition();if(e.getAbsoluteTransform().determinant()>0&&(this._rightHandedSystem=!0,this._bendAxis.x=0,this._bendAxis.y=0,this._bendAxis.z=-1,r.x>r.y&&r.x>r.z&&(this._adjustRoll=Math.PI*.5,this._bendAxis.z=1)),this._bone1.length){var o=this._bone1.getScale(),s=this._bone2.getScale();this._bone1Length=this._bone1.length*o.y*this.mesh.scaling.y,this._bone2Length=this._bone2.length*s.y*this.mesh.scaling.y}else if(this._bone1.children[0]){t.computeWorldMatrix(!0);var n=this._bone2.children[0].getAbsolutePosition(t),f=this._bone2.getAbsolutePosition(t),h=this._bone1.getAbsolutePosition(t);this._bone1Length=m.Distance(n,f),this._bone2Length=m.Distance(f,h)}this._bone1.getRotationMatrixToRef(u.WORLD,t,this._bone1Mat),this.maxAngle=Math.PI,i&&(i.targetMesh&&(this.targetMesh=i.targetMesh,this.targetMesh.computeWorldMatrix(!0)),i.poleTargetMesh?(this.poleTargetMesh=i.poleTargetMesh,this.poleTargetMesh.computeWorldMatrix(!0)):i.poleTargetBone?this.poleTargetBone=i.poleTargetBone:this._bone1.getParent()&&(this.poleTargetBone=this._bone1.getParent()),i.poleTargetLocalOffset&&this.poleTargetLocalOffset.copyFrom(i.poleTargetLocalOffset),i.poleAngle&&(this.poleAngle=i.poleAngle),i.bendAxis&&this._bendAxis.copyFrom(i.bendAxis),i.maxAngle&&(this.maxAngle=i.maxAngle),i.slerpAmount&&(this.slerpAmount=i.slerpAmount))}}return Object.defineProperty(a.prototype,"maxAngle",{get:function(){return this._maxAngle},set:function(t){this._setMaxAngle(t)},enumerable:!1,configurable:!0}),a.prototype._setMaxAngle=function(t){t<0&&(t=0),(t>Math.PI||t==null)&&(t=Math.PI),this._maxAngle=t;var e=this._bone1Length,i=this._bone2Length;this._maxReach=Math.sqrt(e*e+i*i-2*e*i*Math.cos(t))},a.prototype.update=function(){var t=this._bone1;if(!!t){var e=this.targetPosition,i=this.poleTargetPosition,r=a._TmpMats[0],o=a._TmpMats[1];this.targetMesh&&e.copyFrom(this.targetMesh.getAbsolutePosition()),this.poleTargetBone?this.poleTargetBone.getAbsolutePositionFromLocalToRef(this.poleTargetLocalOffset,this.mesh,i):this.poleTargetMesh&&m.TransformCoordinatesToRef(this.poleTargetLocalOffset,this.poleTargetMesh.getWorldMatrix(),i);var s=a._TmpVecs[0],n=a._TmpVecs[1],f=a._TmpVecs[2],h=a._TmpVecs[3],_=a._TmpVecs[4],p=a._TmpQuat;t.getAbsolutePositionToRef(this.mesh,s),i.subtractToRef(s,_),_.x==0&&_.y==0&&_.z==0?_.y=1:_.normalize(),e.subtractToRef(s,h),h.normalize(),m.CrossToRef(h,_,n),n.normalize(),m.CrossToRef(h,n,f),f.normalize(),c.FromXYZAxesToRef(f,h,n,r);var T=this._bone1Length,d=this._bone2Length,A=m.Distance(s,e);this._maxReach>0&&(A=Math.min(this._maxReach,A));var g=(d*d+A*A-T*T)/(2*d*A),l=(A*A+T*T-d*d)/(2*A*T);g>1&&(g=1),l>1&&(l=1),g<-1&&(g=-1),l<-1&&(l=-1);var L=Math.acos(g),b=Math.acos(l),x=-L-b;if(this._rightHandedSystem)c.RotationYawPitchRollToRef(0,0,this._adjustRoll,o),o.multiplyToRef(r,r),c.RotationAxisToRef(this._bendAxis,b,o),o.multiplyToRef(r,r);else{var v=a._TmpVecs[5];v.copyFrom(this._bendAxis),v.x*=-1,c.RotationAxisToRef(v,-b,o),o.multiplyToRef(r,r)}this.poleAngle&&(c.RotationAxisToRef(h,this.poleAngle,o),r.multiplyToRef(o,r)),this._bone1&&(this.slerpAmount<1?(this._slerping||y.FromRotationMatrixToRef(this._bone1Mat,this._bone1Quat),y.FromRotationMatrixToRef(r,p),y.SlerpToRef(this._bone1Quat,p,this.slerpAmount,this._bone1Quat),x=this._bone2Ang*(1-this.slerpAmount)+x*this.slerpAmount,this._bone1.setRotationQuaternion(this._bone1Quat,u.WORLD,this.mesh),this._slerping=!0):(this._bone1.setRotationMatrix(r,u.WORLD,this.mesh),this._bone1Mat.copyFrom(r),this._slerping=!1),this._updateLinkedTransformRotation(this._bone1)),this._bone2.setAxisAngle(this._bendAxis,x,u.LOCAL),this._updateLinkedTransformRotation(this._bone2),this._bone2Ang=x}},a.prototype._updateLinkedTransformRotation=function(t){t._linkedTransformNode&&(t._linkedTransformNode.rotationQuaternion||(t._linkedTransformNode.rotationQuaternion=new y),t.getRotationQuaternionToRef(u.LOCAL,null,t._linkedTransformNode.rotationQuaternion))},a._TmpVecs=[m.Zero(),m.Zero(),m.Zero(),m.Zero(),m.Zero(),m.Zero()],a._TmpQuat=y.Identity(),a._TmpMats=[c.Identity(),c.Identity()],a})();(function(){function a(t,e,i,r){if(this.upAxis=m.Up(),this.upAxisSpace=u.LOCAL,this.adjustYaw=0,this.adjustPitch=0,this.adjustRoll=0,this.slerpAmount=1,this._boneQuat=y.Identity(),this._slerping=!1,this._firstFrameSkipped=!1,this._fowardAxis=m.Forward(),this.mesh=t,this.bone=e,this.target=i,r&&(r.adjustYaw&&(this.adjustYaw=r.adjustYaw),r.adjustPitch&&(this.adjustPitch=r.adjustPitch),r.adjustRoll&&(this.adjustRoll=r.adjustRoll),r.maxYaw!=null?this.maxYaw=r.maxYaw:this.maxYaw=Math.PI,r.minYaw!=null?this.minYaw=r.minYaw:this.minYaw=-Math.PI,r.maxPitch!=null?this.maxPitch=r.maxPitch:this.maxPitch=Math.PI,r.minPitch!=null?this.minPitch=r.minPitch:this.minPitch=-Math.PI,r.slerpAmount!=null&&(this.slerpAmount=r.slerpAmount),r.upAxis!=null&&(this.upAxis=r.upAxis),r.upAxisSpace!=null&&(this.upAxisSpace=r.upAxisSpace),r.yawAxis!=null||r.pitchAxis!=null)){var o=F.Y,s=F.X;r.yawAxis!=null&&(o=r.yawAxis.clone(),o.normalize()),r.pitchAxis!=null&&(s=r.pitchAxis.clone(),s.normalize());var n=m.Cross(s,o);this._transformYawPitch=c.Identity(),c.FromXYZAxesToRef(s,o,n,this._transformYawPitch),this._transformYawPitchInv=this._transformYawPitch.clone(),this._transformYawPitch.invert()}!e.getParent()&&this.upAxisSpace==u.BONE&&(this.upAxisSpace=u.LOCAL)}return Object.defineProperty(a.prototype,"minYaw",{get:function(){return this._minYaw},set:function(t){this._minYaw=t,this._minYawSin=Math.sin(t),this._minYawCos=Math.cos(t),this._maxYaw!=null&&(this._midYawConstraint=this._getAngleDiff(this._minYaw,this._maxYaw)*.5+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"maxYaw",{get:function(){return this._maxYaw},set:function(t){this._maxYaw=t,this._maxYawSin=Math.sin(t),this._maxYawCos=Math.cos(t),this._minYaw!=null&&(this._midYawConstraint=this._getAngleDiff(this._minYaw,this._maxYaw)*.5+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"minPitch",{get:function(){return this._minPitch},set:function(t){this._minPitch=t,this._minPitchTan=Math.tan(t)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"maxPitch",{get:function(){return this._maxPitch},set:function(t){this._maxPitch=t,this._maxPitchTan=Math.tan(t)},enumerable:!1,configurable:!0}),a.prototype.update=function(){if(this.slerpAmount<1&&!this._firstFrameSkipped){this._firstFrameSkipped=!0;return}var t=this.bone,e=a._TmpVecs[0];t.getAbsolutePositionToRef(this.mesh,e);var i=this.target,r=a._TmpMats[0],o=a._TmpMats[1],s=this.mesh,n=t.getParent(),f=a._TmpVecs[1];f.copyFrom(this.upAxis),this.upAxisSpace==u.BONE&&n?(this._transformYawPitch&&m.TransformCoordinatesToRef(f,this._transformYawPitchInv,f),n.getDirectionToRef(f,this.mesh,f)):this.upAxisSpace==u.LOCAL&&(s.getDirectionToRef(f,f),(s.scaling.x!=1||s.scaling.y!=1||s.scaling.z!=1)&&f.normalize());var h=!1,_=!1;if((this._maxYaw!=Math.PI||this._minYaw!=-Math.PI)&&(h=!0),(this._maxPitch!=Math.PI||this._minPitch!=-Math.PI)&&(_=!0),h||_){var p=a._TmpMats[2],T=a._TmpMats[3];if(this.upAxisSpace==u.BONE&&f.y==1&&n)n.getRotationMatrixToRef(u.WORLD,this.mesh,p);else if(this.upAxisSpace==u.LOCAL&&f.y==1&&!n)p.copyFrom(s.getWorldMatrix());else{var d=a._TmpVecs[2];d.copyFrom(this._fowardAxis),this._transformYawPitch&&m.TransformCoordinatesToRef(d,this._transformYawPitchInv,d),n?n.getDirectionToRef(d,this.mesh,d):s.getDirectionToRef(d,d);var A=m.Cross(f,d);A.normalize(),d=m.Cross(A,f),c.FromXYZAxesToRef(A,f,d,p)}p.invertToRef(T);var g=null;if(_){var l=a._TmpVecs[3];i.subtractToRef(e,l),m.TransformCoordinatesToRef(l,T,l),g=Math.sqrt(l.x*l.x+l.z*l.z);var L=Math.atan2(l.y,g),b=L;L>this._maxPitch?(l.y=this._maxPitchTan*g,b=this._maxPitch):L<this._minPitch&&(l.y=this._minPitchTan*g,b=this._minPitch),L!=b&&(m.TransformCoordinatesToRef(l,p,l),l.addInPlace(e),i=l)}if(h){var l=a._TmpVecs[4];i.subtractToRef(e,l),m.TransformCoordinatesToRef(l,T,l);var x=Math.atan2(l.x,l.z),v=x;if((x>this._maxYaw||x<this._minYaw)&&(g==null&&(g=Math.sqrt(l.x*l.x+l.z*l.z)),this._yawRange>Math.PI?this._isAngleBetween(x,this._maxYaw,this._midYawConstraint)?(l.z=this._maxYawCos*g,l.x=this._maxYawSin*g,v=this._maxYaw):this._isAngleBetween(x,this._midYawConstraint,this._minYaw)&&(l.z=this._minYawCos*g,l.x=this._minYawSin*g,v=this._minYaw):x>this._maxYaw?(l.z=this._maxYawCos*g,l.x=this._maxYawSin*g,v=this._maxYaw):x<this._minYaw&&(l.z=this._minYawCos*g,l.x=this._minYawSin*g,v=this._minYaw)),this._slerping&&this._yawRange>Math.PI){var R=a._TmpVecs[8];R.copyFrom(F.Z),this._transformYawPitch&&m.TransformCoordinatesToRef(R,this._transformYawPitchInv,R);var k=a._TmpMats[4];this._boneQuat.toRotationMatrix(k),this.mesh.getWorldMatrix().multiplyToRef(k,k),m.TransformCoordinatesToRef(R,k,R),m.TransformCoordinatesToRef(R,T,R);var I=Math.atan2(R.x,R.z),j=this._getAngleBetween(I,x),z=this._getAngleBetween(I,this._midYawConstraint);if(j>z){g==null&&(g=Math.sqrt(l.x*l.x+l.z*l.z));var Z=this._getAngleBetween(I,this._maxYaw),V=this._getAngleBetween(I,this._minYaw);V<Z?(v=I+Math.PI*.75,l.z=Math.cos(v)*g,l.x=Math.sin(v)*g):(v=I-Math.PI*.75,l.z=Math.cos(v)*g,l.x=Math.sin(v)*g)}}x!=v&&(m.TransformCoordinatesToRef(l,p,l),l.addInPlace(e),i=l)}}var M=a._TmpVecs[5],P=a._TmpVecs[6],C=a._TmpVecs[7],Y=a._TmpQuat;i.subtractToRef(e,M),M.normalize(),m.CrossToRef(f,M,P),P.normalize(),m.CrossToRef(M,P,C),C.normalize(),c.FromXYZAxesToRef(P,C,M,r),!(P.x===0&&P.y===0&&P.z===0)&&(C.x===0&&C.y===0&&C.z===0||M.x===0&&M.y===0&&M.z===0||((this.adjustYaw||this.adjustPitch||this.adjustRoll)&&(c.RotationYawPitchRollToRef(this.adjustYaw,this.adjustPitch,this.adjustRoll,o),o.multiplyToRef(r,r)),this.slerpAmount<1?(this._slerping||this.bone.getRotationQuaternionToRef(u.WORLD,this.mesh,this._boneQuat),this._transformYawPitch&&this._transformYawPitch.multiplyToRef(r,r),y.FromRotationMatrixToRef(r,Y),y.SlerpToRef(this._boneQuat,Y,this.slerpAmount,this._boneQuat),this.bone.setRotationQuaternion(this._boneQuat,u.WORLD,this.mesh),this._slerping=!0):(this._transformYawPitch&&this._transformYawPitch.multiplyToRef(r,r),this.bone.setRotationMatrix(r,u.WORLD,this.mesh),this._slerping=!1),this._updateLinkedTransformRotation()))},a.prototype._getAngleDiff=function(t,e){var i=e-t;return i%=Math.PI*2,i>Math.PI?i-=Math.PI*2:i<-Math.PI&&(i+=Math.PI*2),i},a.prototype._getAngleBetween=function(t,e){t%=2*Math.PI,t=t<0?t+2*Math.PI:t,e%=2*Math.PI,e=e<0?e+2*Math.PI:e;var i=0;return t<e?i=e-t:i=t-e,i>Math.PI&&(i=Math.PI*2-i),i},a.prototype._isAngleBetween=function(t,e,i){if(t%=2*Math.PI,t=t<0?t+2*Math.PI:t,e%=2*Math.PI,e=e<0?e+2*Math.PI:e,i%=2*Math.PI,i=i<0?i+2*Math.PI:i,e<i){if(t>e&&t<i)return!0}else if(t>i&&t<e)return!0;return!1},a.prototype._updateLinkedTransformRotation=function(){var t=this.bone;t._linkedTransformNode&&(t._linkedTransformNode.rotationQuaternion||(t._linkedTransformNode.rotationQuaternion=new y),t.getRotationQuaternionToRef(u.LOCAL,null,t._linkedTransformNode.rotationQuaternion))},a._TmpVecs=D.BuildArray(10,m.Zero),a._TmpQuat=y.Identity(),a._TmpMats=D.BuildArray(5,c.Identity),a})();var et=function(){function a(t,e,i){this.name=t,this.id=e,this.bones=new Array,this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=c.Identity(),this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new H,this.bones=[],this._scene=i||N.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;var r=this._scene.getEngine().getCaps();this._canUseTextureForBones=r.textureFloat&&r.maxVertexTextureImageUnits>0}return Object.defineProperty(a.prototype,"useTextureToStoreBoneMatrices",{get:function(){return this._useTextureToStoreBoneMatrices},set:function(t){this._useTextureToStoreBoneMatrices=t,this._markAsDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"animationPropertiesOverride",{get:function(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride},set:function(t){this._animationPropertiesOverride=t},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"isUsingTextureForMatrices",{get:function(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),a.prototype.getClassName=function(){return"Skeleton"},a.prototype.getChildren=function(){return this.bones.filter(function(t){return!t.getParent()})},a.prototype.getTransformMatrices=function(t){return this.needInitialSkinMatrix?(t._bonesTransformMatrices||this.prepare(),t._bonesTransformMatrices):(this._transformMatrices||this.prepare(),this._transformMatrices)},a.prototype.getTransformMatrixTexture=function(t){return this.needInitialSkinMatrix&&t._transformMatrixTexture?t._transformMatrixTexture:this._transformMatrixTexture},a.prototype.getScene=function(){return this._scene},a.prototype.toString=function(t){var e="Name: ".concat(this.name,", nBones: ").concat(this.bones.length);if(e+=", nAnimationRanges: ".concat(this._ranges?Object.keys(this._ranges).length:"none"),t){e+=", Ranges: {";var i=!0;for(var r in this._ranges)i&&(e+=", ",i=!1),e+=r;e+="}"}return e},a.prototype.getBoneIndexByName=function(t){for(var e=0,i=this.bones.length;e<i;e++)if(this.bones[e].name===t)return e;return-1},a.prototype.createAnimationRange=function(t,e,i){if(!this._ranges[t]){this._ranges[t]=new W(t,e,i);for(var r=0,o=this.bones.length;r<o;r++)this.bones[r].animations[0]&&this.bones[r].animations[0].createRange(t,e,i)}},a.prototype.deleteAnimationRange=function(t,e){e===void 0&&(e=!0);for(var i=0,r=this.bones.length;i<r;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(t,e);this._ranges[t]=null},a.prototype.getAnimationRange=function(t){return this._ranges[t]||null},a.prototype.getAnimationRanges=function(){var t=[],e;for(e in this._ranges)t.push(this._ranges[e]);return t},a.prototype.copyAnimationRange=function(t,e,i){if(i===void 0&&(i=!1),this._ranges[e]||!t.getAnimationRange(e))return!1;var r=!0,o=this._getHighestAnimationFrame()+1,s={},n=t.bones,f,h;for(h=0,f=n.length;h<f;h++)s[n[h].name]=n[h];this.bones.length!==n.length&&(w.Warn("copyAnimationRange: this rig has ".concat(this.bones.length," bones, while source as ").concat(n.length)),r=!1);var _=i&&this.dimensionsAtRest&&t.dimensionsAtRest?this.dimensionsAtRest.divide(t.dimensionsAtRest):null;for(h=0,f=this.bones.length;h<f;h++){var p=this.bones[h].name,T=s[p];T?r=r&&this.bones[h].copyAnimationRange(T,e,o,i,_):(w.Warn("copyAnimationRange: not same rig, missing source bone "+p),r=!1)}var d=t.getAnimationRange(e);return d&&(this._ranges[e]=new W(e,d.from+o,d.to+o)),r},a.prototype.returnToRest=function(){for(var t=0,e=this.bones;t<e.length;t++){var i=e[t];i._index!==-1&&i.returnToRest()}},a.prototype._getHighestAnimationFrame=function(){for(var t=0,e=0,i=this.bones.length;e<i;e++)if(this.bones[e].animations[0]){var r=this.bones[e].animations[0].getHighestFrame();t<r&&(t=r)}return t},a.prototype.beginAnimation=function(t,e,i,r){var o=this.getAnimationRange(t);return o?this._scene.beginAnimation(this,o.from,o.to,e,i,r):null},a.MakeAnimationAdditive=function(t,e,i){e===void 0&&(e=0);var r=t.getAnimationRange(i);if(!r)return null;for(var o=t._scene.getAllAnimatablesByTarget(t),s=null,n=0;n<o.length;n++){var f=o[n];if(f.fromFrame===(r==null?void 0:r.from)&&f.toFrame===(r==null?void 0:r.to)){s=f;break}}for(var h=t.getAnimatables(),n=0;n<h.length;n++){var _=h[n],p=_.animations;if(!!p)for(var T=0;T<p.length;T++)Q.MakeAnimationAdditive(p[T],e,i)}return s&&(s.isAdditive=!0),t},a.prototype._markAsDirty=function(){this._isDirty=!0,this._absoluteTransformIsDirty=!0},a.prototype._registerMeshWithPoseMatrix=function(t){this._meshesWithPoseMatrix.push(t)},a.prototype._unregisterMeshWithPoseMatrix=function(t){var e=this._meshesWithPoseMatrix.indexOf(t);e>-1&&this._meshesWithPoseMatrix.splice(e,1)},a.prototype._computeTransformMatrices=function(t,e){this.onBeforeComputeObservable.notifyObservers(this);for(var i=0;i<this.bones.length;i++){var r=this.bones[i];r._childUpdateId++;var o=r.getParent();if(o?r.getLocalMatrix().multiplyToRef(o.getWorldMatrix(),r.getWorldMatrix()):e?r.getLocalMatrix().multiplyToRef(e,r.getWorldMatrix()):r.getWorldMatrix().copyFrom(r.getLocalMatrix()),r._index!==-1){var s=r._index===null?i:r._index;r.getInvertedAbsoluteTransform().multiplyToArray(r.getWorldMatrix(),t,s*16)}}this._identity.copyToArray(t,this.bones.length*16)},a.prototype.prepare=function(){if(this._numBonesWithLinkedTransformNode>0)for(var t=0,e=this.bones;t<e.length;t++){var i=e[t];i._linkedTransformNode&&(i._linkedTransformNode.computeWorldMatrix(),i._matrix=i._linkedTransformNode._localMatrix)}if(this.needInitialSkinMatrix)for(var r=0,o=this._meshesWithPoseMatrix;r<o.length;r++){var s=o[r],n=s.getPoseMatrix(),f=this._isDirty;if((!s._bonesTransformMatrices||s._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(s._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),f=!0),!!f){if(this._synchronizedWithMesh!==s){this._synchronizedWithMesh=s;for(var h=0,_=this.bones;h<_.length;h++){var i=_[h];if(!i.getParent()){var p=i.getBaseMatrix();p.multiplyToRef(n,O.Matrix[1]),i._updateDifferenceMatrix(O.Matrix[1])}}if(this.isUsingTextureForMatrices){var T=(this.bones.length+1)*4;(!s._transformMatrixTexture||s._transformMatrixTexture.getSize().width!==T)&&(s._transformMatrixTexture&&s._transformMatrixTexture.dispose(),s._transformMatrixTexture=S.CreateRGBATexture(s._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(s._bonesTransformMatrices,n),this.isUsingTextureForMatrices&&s._transformMatrixTexture&&s._transformMatrixTexture.update(s._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=S.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1},a.prototype.getAnimatables=function(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(var t=0;t<this.bones.length;t++)this._animatables.push(this.bones[t])}return this._animatables},a.prototype.clone=function(t,e){var i=new a(t,e||t,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix;for(var r=0;r<this.bones.length;r++){var o=this.bones[r],s=null,n=o.getParent();if(n){var f=this.bones.indexOf(n);s=i.bones[f]}var h=new B(o.name,i,s,o.getBaseMatrix().clone(),o.getRestPose().clone());h._index=o._index,o._linkedTransformNode&&h.linkTransformNode(o._linkedTransformNode),U.DeepCopy(o.animations,h.animations)}if(this._ranges){i._ranges={};for(var _ in this._ranges){var p=this._ranges[_];p&&(i._ranges[_]=p.clone())}}return this._isDirty=!0,i},a.prototype.enableBlending=function(t){t===void 0&&(t=.01),this.bones.forEach(function(e){e.animations.forEach(function(i){i.enableBlending=!0,i.blendingSpeed=t})})},a.prototype.dispose=function(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){var t=this._parentContainer.skeletons.indexOf(this);t>-1&&this._parentContainer.skeletons.splice(t,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)},a.prototype.serialize=function(){var t,e={};e.name=this.name,e.id=this.id,this.dimensionsAtRest&&(e.dimensionsAtRest=this.dimensionsAtRest.asArray()),e.bones=[],e.needInitialSkinMatrix=this.needInitialSkinMatrix;for(var i=0;i<this.bones.length;i++){var r=this.bones[i],o=r.getParent(),s={parentBoneIndex:o?this.bones.indexOf(o):-1,index:r.getIndex(),name:r.name,id:r.id,matrix:r.getBaseMatrix().toArray(),rest:r.getRestPose().toArray(),linkedTransformNodeId:(t=r.getTransformNode())===null||t===void 0?void 0:t.id};e.bones.push(s),r.length&&(s.length=r.length),r.metadata&&(s.metadata=r.metadata),r.animations&&r.animations.length>0&&(s.animation=r.animations[0].serialize()),e.ranges=[];for(var n in this._ranges){var f=this._ranges[n];if(!!f){var h={};h.name=n,h.from=f.from,h.to=f.to,e.ranges.push(h)}}}return e},a.Parse=function(t,e){var i=new a(t.name,t.id,e);t.dimensionsAtRest&&(i.dimensionsAtRest=m.FromArray(t.dimensionsAtRest)),i.needInitialSkinMatrix=t.needInitialSkinMatrix;var r;for(r=0;r<t.bones.length;r++){var o=t.bones[r],s=t.bones[r].index,n=null;o.parentBoneIndex>-1&&(n=i.bones[o.parentBoneIndex]);var f=o.rest?c.FromArray(o.rest):null,h=new B(o.name,i,n,c.FromArray(o.matrix),f,null,s);o.id!==void 0&&o.id!==null&&(h.id=o.id),o.length&&(h.length=o.length),o.metadata&&(h.metadata=o.metadata),o.animation&&h.animations.push(Q.Parse(o.animation)),o.linkedTransformNodeId!==void 0&&o.linkedTransformNodeId!==null&&(i._hasWaitingData=!0,h._waitingTransformNodeId=o.linkedTransformNodeId)}if(t.ranges)for(r=0;r<t.ranges.length;r++){var _=t.ranges[r];i.createAnimationRange(_.name,_.from,_.to)}return i},a.prototype.computeAbsoluteTransforms=function(t){t===void 0&&(t=!1),(this._absoluteTransformIsDirty||t)&&(this.bones[0].computeAbsoluteTransforms(),this._absoluteTransformIsDirty=!1)},a.prototype.getPoseMatrix=function(){var t=null;return this._meshesWithPoseMatrix.length>0&&(t=this._meshesWithPoseMatrix[0].getPoseMatrix()),t},a.prototype.sortBones=function(){for(var t=new Array,e=new Array(this.bones.length),i=0;i<this.bones.length;i++)this._sortBones(i,t,e);this.bones=t},a.prototype._sortBones=function(t,e,i){if(!i[t]){i[t]=!0;var r=this.bones[t];if(!!r){r._index===void 0&&(r._index=t);var o=r.getParent();o&&this._sortBones(this.bones.indexOf(o),e,i),e.push(r)}}},a.prototype.setCurrentPoseAsRest=function(){this.bones.forEach(function(t){t.setCurrentPoseAsRest()})},a}();export{B,et as S};
