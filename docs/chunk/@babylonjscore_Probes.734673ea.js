import{a as m}from"./tslibtslib.b6e59fa7.js";import{S as v,g as P,d as y}from"./@babylonjscore_Misc.329df4d9.js";import{k as x}from"./@babylonjscore_Materials.49fd589a.js";import{M as c,a as h}from"./@babylonjscore_Maths.42afce42.js";import{A as b}from"./@babylonjscore_abstractScene.a7cd866f.js";b.prototype.removeReflectionProbe=function(i){if(!this.reflectionProbes)return-1;var t=this.reflectionProbes.indexOf(i);return t!==-1&&this.reflectionProbes.splice(t,1),t};b.prototype.addReflectionProbe=function(i){this.reflectionProbes||(this.reflectionProbes=[]),this.reflectionProbes.push(i)};var S=function(){function i(t,o,e,n,a,u){n===void 0&&(n=!0),a===void 0&&(a=!1),u===void 0&&(u=!1);var r=this;if(this.name=t,this._viewMatrix=c.Identity(),this._target=h.Zero(),this._add=h.Zero(),this._invertYAxis=!1,this.position=h.Zero(),this._parentContainer=null,this._scene=e,e.getEngine().supportsUniformBuffers){this._sceneUBOs=[];for(var d=0;d<6;++d)this._sceneUBOs.push(e.createSceneUniformBuffer('Scene for Reflection Probe (name "'.concat(t,'") face #').concat(d)))}this._scene.reflectionProbes||(this._scene.reflectionProbes=new Array),this._scene.reflectionProbes.push(this);var l=0;if(a){var p=this._scene.getEngine().getCaps();p.textureHalfFloatRender?l=2:p.textureFloatRender&&(l=1)}this._renderTargetTexture=new x(t,o,e,n,!0,l,!0),this._renderTargetTexture.gammaSpace=!u;var _=e.getEngine().useReverseDepthBuffer;this._renderTargetTexture.onBeforeRenderObservable.add(function(f){switch(r._sceneUBOs&&(e.setSceneUniformBuffer(r._sceneUBOs[f]),e.getSceneUniformBuffer().unbindEffect()),f){case 0:r._add.copyFromFloats(1,0,0);break;case 1:r._add.copyFromFloats(-1,0,0);break;case 2:r._add.copyFromFloats(0,r._invertYAxis?1:-1,0);break;case 3:r._add.copyFromFloats(0,r._invertYAxis?-1:1,0);break;case 4:r._add.copyFromFloats(0,0,e.useRightHandedSystem?-1:1);break;case 5:r._add.copyFromFloats(0,0,e.useRightHandedSystem?1:-1);break}r._attachedMesh&&r.position.copyFrom(r._attachedMesh.getAbsolutePosition()),r.position.addToRef(r._add,r._target);var s=e.useRightHandedSystem?c.LookAtRHToRef:c.LookAtLHToRef,T=e.useRightHandedSystem?c.PerspectiveFovRH:c.PerspectiveFovLH;s(r.position,r._target,h.Up(),r._viewMatrix),e.activeCamera&&(r._projectionMatrix=T(Math.PI/2,1,_?e.activeCamera.maxZ:e.activeCamera.minZ,_?e.activeCamera.minZ:e.activeCamera.maxZ,r._scene.getEngine().isNDCHalfZRange),e.setTransformMatrix(r._viewMatrix,r._projectionMatrix),e.activeCamera.isRigCamera&&!r._renderTargetTexture.activeCamera&&(r._renderTargetTexture.activeCamera=e.activeCamera.rigParent||null)),e._forcedViewPosition=r.position});var g;this._renderTargetTexture.onBeforeBindObservable.add(function(){var f,s;r._currentSceneUBO=e.getSceneUniformBuffer(),(s=(f=e.getEngine())._debugPushGroup)===null||s===void 0||s.call(f,"reflection probe generation for ".concat(t),1),g=r._scene.imageProcessingConfiguration.applyByPostProcess,u&&(e.imageProcessingConfiguration.applyByPostProcess=!0)}),this._renderTargetTexture.onAfterUnbindObservable.add(function(){var f,s;e.imageProcessingConfiguration.applyByPostProcess=g,e._forcedViewPosition=null,r._sceneUBOs&&e.setSceneUniformBuffer(r._currentSceneUBO),e.updateTransformMatrix(!0),(s=(f=e.getEngine())._debugPopGroup)===null||s===void 0||s.call(f,1)})}return Object.defineProperty(i.prototype,"samples",{get:function(){return this._renderTargetTexture.samples},set:function(t){this._renderTargetTexture.samples=t},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"refreshRate",{get:function(){return this._renderTargetTexture.refreshRate},set:function(t){this._renderTargetTexture.refreshRate=t},enumerable:!1,configurable:!0}),i.prototype.getScene=function(){return this._scene},Object.defineProperty(i.prototype,"cubeTexture",{get:function(){return this._renderTargetTexture},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"renderList",{get:function(){return this._renderTargetTexture.renderList},enumerable:!1,configurable:!0}),i.prototype.attachToMesh=function(t){this._attachedMesh=t},i.prototype.setRenderingAutoClearDepthStencil=function(t,o){this._renderTargetTexture.setRenderingAutoClearDepthStencil(t,o)},i.prototype.dispose=function(){var t=this._scene.reflectionProbes.indexOf(this);if(t!==-1&&this._scene.reflectionProbes.splice(t,1),this._parentContainer){var o=this._parentContainer.reflectionProbes.indexOf(this);o>-1&&this._parentContainer.reflectionProbes.splice(o,1),this._parentContainer=null}if(this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null),this._sceneUBOs){for(var e=0,n=this._sceneUBOs;e<n.length;e++){var a=n[e];a.dispose()}this._sceneUBOs=[]}},i.prototype.toString=function(t){var o="Name: "+this.name;return t&&(o+=", position: "+this.position.toString(),this._attachedMesh&&(o+=", attached mesh: "+this._attachedMesh.name)),o},i.prototype.getClassName=function(){return"ReflectionProbe"},i.prototype.serialize=function(){var t=v.Serialize(this,this._renderTargetTexture.serialize());return t.isReflectionProbe=!0,t},i.Parse=function(t,o,e){var n=null;if(o.reflectionProbes)for(var a=0;a<o.reflectionProbes.length;a++){var u=o.reflectionProbes[a];if(u.name===t.name){n=u;break}}return n=v.Parse(function(){return n||new i(t.name,t.renderTargetSize,o,t._generateMipMaps)},t,o,e),n.cubeTexture._waitingRenderList=t.renderList,t._attachedMesh&&n.attachToMesh(o.getMeshById(t._attachedMesh)),n},m([P()],i.prototype,"_attachedMesh",void 0),m([y()],i.prototype,"position",void 0),i}();export{S as R};
