var Wt=Object.defineProperty;var Xt=(a,e,t)=>e in a?Wt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var At=(a,e,t)=>(Xt(a,typeof e!="symbol"?e+"":e,t),t);import{Vector3 as p,TmpVectors as G,Vector2 as Ft,Vector4 as It,Matrix as gt}from"./math.vector.560c6bc4.js";import{Color4 as A,TmpColors as Ht,Color3 as Gt}from"./math.color.d29cb8ed.js";import{T as rt}from"./clipPlaneVertex.1e772c5b.js";import{T as O,b as yt,c as pt,L as lt,_ as mt,a as kt,m as Lt,l as Et,O as Rt,f as Yt}from"./precisionDate.1704d4c6.js";import{S as m,G as ft}from"./arrayTools.49279cc5.js";import{V as q,a as Zt,B as St,I as Pt}from"./math.plane.7ea68d04.js";import{T as _t,D as Y,S as Kt}from"./decorators.5af14a95.js";import{E as $t}from"./performanceConfigurator.ee04355d.js";import"./engine.dynamicBuffer.fe9de623.js";import"./imageProcessingFunctions.3c9d02ee.js";import{T as Jt}from"./thinMaterialHelper.ab1f33f5.js";import"./math.size.64d00435.js";var Qt="./assets/png/star.498ac026.png",qt=function(){function a(e,t,i){this.gradient=e,this.color1=t,this.color2=i}return a.prototype.getColorToRef=function(e){if(!this.color2){e.copyFrom(this.color1);return}A.LerpToRef(this.color1,this.color2,Math.random(),e)},a}(),jt=function(){function a(e,t){this.gradient=e,this.color=t}return a}(),te=function(){function a(e,t,i){this.gradient=e,this.factor1=t,this.factor2=i}return a.prototype.getFactor=function(){return this.factor2===void 0||this.factor2===this.factor1?this.factor1:this.factor1+(this.factor2-this.factor1)*Math.random()},a}(),M=function(){function a(){}return a.GetCurrentGradient=function(e,t,i){if(t[0].gradient>e){i(t[0],t[0],1);return}for(var o=0;o<t.length-1;o++){var s=t[o],n=t[o+1];if(e>=s.gradient&&e<=n.gradient){var f=(e-s.gradient)/(n.gradient-s.gradient);i(s,n,f);return}}var r=t.length-1;i(t[r],t[r],1)},a}();O.prototype.updateRawTexture=function(a,e,t,i,o,s,n){if(o===void 0&&(o=null),s===void 0&&(s=0),n===void 0&&(n=!1),!!a){var f=this._getRGBABufferInternalSizedFormat(s,t,n),r=this._getInternalFormat(t),d=this._getWebGLTextureType(s);this._bindTextureDirectly(this._gl.TEXTURE_2D,a,!0),this._unpackFlipY(i===void 0?!0:!!i),this._doNotHandleContextLost||(a._bufferView=e,a.format=t,a.type=s,a.invertY=i,a._compression=o),a.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),o&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[o],a.width,a.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,f,a.width,a.height,0,r,d,e),a.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),a.isReady=!0}};O.prototype.createRawTexture=function(a,e,t,i,o,s,n,f,r,d,c){f===void 0&&(f=null),r===void 0&&(r=0),c===void 0&&(c=!1);var h=new yt(this,pt.Raw);h.baseWidth=e,h.baseHeight=t,h.width=e,h.height=t,h.format=i,h.generateMipMaps=o,h.samplingMode=n,h.invertY=s,h._compression=f,h.type=r,h._useSRGBBuffer=this._getUseSRGBBuffer(c,!o),this._doNotHandleContextLost||(h._bufferView=a),this.updateRawTexture(h,a,i,s,f,r,h._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,h,!0);var _=this._getSamplingParameters(n,o);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,_.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,_.min),o&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(h),h};O.prototype.createRawCubeTexture=function(a,e,t,i,o,s,n,f){f===void 0&&(f=null);var r=this._gl,d=new yt(this,pt.CubeRaw);d.isCube=!0,d.format=t,d.type=i,this._doNotHandleContextLost||(d._bufferViewArray=a);var c=this._getWebGLTextureType(i),h=this._getInternalFormat(t);h===r.RGB&&(h=r.RGBA),c===r.FLOAT&&!this._caps.textureFloatLinearFiltering?(o=!1,n=1,lt.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):c===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(o=!1,n=1,lt.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):c===r.FLOAT&&!this._caps.textureFloatRender?(o=!1,lt.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):c===r.HALF_FLOAT&&!this._caps.colorBufferFloat&&(o=!1,lt.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));var _=e,u=_;d.width=_,d.height=u;var v=!this.needPOTTextures||_t.IsExponentOfTwo(d.width)&&_t.IsExponentOfTwo(d.height);v||(o=!1),a&&this.updateRawCubeTexture(d,a,t,i,s,f),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,d,!0),a&&o&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);var E=this._getSamplingParameters(n,o);return r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,E.mag),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,E.min),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),d.generateMipMaps=o,d.samplingMode=n,d};O.prototype.updateRawCubeTexture=function(a,e,t,i,o,s,n){s===void 0&&(s=null),n===void 0&&(n=0),a._bufferViewArray=e,a.format=t,a.type=i,a.invertY=o,a._compression=s;var f=this._gl,r=this._getWebGLTextureType(i),d=this._getInternalFormat(t),c=this._getRGBABufferInternalSizedFormat(i),h=!1;d===f.RGB&&(d=f.RGBA,h=!0),this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,a,!0),this._unpackFlipY(o===void 0?!0:!!o),a.width%4!==0&&f.pixelStorei(f.UNPACK_ALIGNMENT,1);for(var _=0;_<6;_++){var u=e[_];s?f.compressedTexImage2D(f.TEXTURE_CUBE_MAP_POSITIVE_X+_,n,this.getCaps().s3tc[s],a.width,a.height,0,u):(h&&(u=Bt(u,a.width,a.height,i)),f.texImage2D(f.TEXTURE_CUBE_MAP_POSITIVE_X+_,n,c,a.width,a.height,0,d,r,u))}var v=!this.needPOTTextures||_t.IsExponentOfTwo(a.width)&&_t.IsExponentOfTwo(a.height);v&&a.generateMipMaps&&n===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),a.isReady=!0};O.prototype.createRawCubeTextureFromUrl=function(a,e,t,i,o,s,n,f,r,d,c,h){var _=this;r===void 0&&(r=null),d===void 0&&(d=null),c===void 0&&(c=3),h===void 0&&(h=!1);var u=this._gl,v=this.createRawCubeTexture(null,t,i,o,!s,h,c,null);e==null||e.addPendingData(v),v.url=a,this._internalTexturesCache.push(v);var E=function(l,y){e==null||e.removePendingData(v),d&&l&&d(l.status+" "+l.statusText,y)},x=function(l){var y=v.width,T=n(l);if(!!T){if(f){var w=_._getWebGLTextureType(o),b=_._getInternalFormat(i),D=_._getRGBABufferInternalSizedFormat(o),L=!1;b===u.RGB&&(b=u.RGBA,L=!0),_._bindTextureDirectly(u.TEXTURE_CUBE_MAP,v,!0),_._unpackFlipY(!1);for(var U=f(T),P=0;P<U.length;P++)for(var V=y>>P,F=0;F<6;F++){var B=U[P][F];L&&(B=Bt(B,V,V,o)),u.texImage2D(F,P,D,V,V,0,b,w,B)}_._bindTextureDirectly(u.TEXTURE_CUBE_MAP,null)}else _.updateRawCubeTexture(v,T,i,o,h);v.isReady=!0,e==null||e.removePendingData(v),v.onLoadedObservable.notifyObservers(v),v.onLoadedObservable.clear(),r&&r()}};return this._loadFile(a,function(l){x(l)},void 0,e==null?void 0:e.offlineProvider,!0,E),v};function Bt(a,e,t,i){var o,s=1;i===1?o=new Float32Array(e*t*4):i===2?(o=new Uint16Array(e*t*4),s=15360):i===7?o=new Uint32Array(e*t*4):o=new Uint8Array(e*t*4);for(var n=0;n<e;n++)for(var f=0;f<t;f++){var r=(f*e+n)*3,d=(f*e+n)*4;o[d+0]=a[r+0],o[d+1]=a[r+1],o[d+2]=a[r+2],o[d+3]=s}return o}function wt(a){return function(e,t,i,o,s,n,f,r,d,c){d===void 0&&(d=null),c===void 0&&(c=0);var h=a?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,_=a?pt.Raw3D:pt.Raw2DArray,u=new yt(this,_);u.baseWidth=t,u.baseHeight=i,u.baseDepth=o,u.width=t,u.height=i,u.depth=o,u.format=s,u.type=c,u.generateMipMaps=n,u.samplingMode=r,a?u.is3D=!0:u.is2DArray=!0,this._doNotHandleContextLost||(u._bufferView=e),a?this.updateRawTexture3D(u,e,s,f,d,c):this.updateRawTexture2DArray(u,e,s,f,d,c),this._bindTextureDirectly(h,u,!0);var v=this._getSamplingParameters(r,n);return this._gl.texParameteri(h,this._gl.TEXTURE_MAG_FILTER,v.mag),this._gl.texParameteri(h,this._gl.TEXTURE_MIN_FILTER,v.min),n&&this._gl.generateMipmap(h),this._bindTextureDirectly(h,null),this._internalTexturesCache.push(u),u}}O.prototype.createRawTexture2DArray=wt(!1);O.prototype.createRawTexture3D=wt(!0);function bt(a){return function(e,t,i,o,s,n){s===void 0&&(s=null),n===void 0&&(n=0);var f=a?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,r=this._getWebGLTextureType(n),d=this._getInternalFormat(i),c=this._getRGBABufferInternalSizedFormat(n,i);this._bindTextureDirectly(f,e,!0),this._unpackFlipY(o===void 0?!0:!!o),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=o,e._compression=s),e.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),s&&t?this._gl.compressedTexImage3D(f,0,this.getCaps().s3tc[s],e.width,e.height,e.depth,0,t):this._gl.texImage3D(f,0,c,e.width,e.height,e.depth,0,d,r,t),e.generateMipMaps&&this._gl.generateMipmap(f),this._bindTextureDirectly(f,null),e.isReady=!0}}O.prototype.updateRawTexture2DArray=bt(!1);O.prototype.updateRawTexture3D=bt(!0);var ee=function(a){mt(e,a);function e(t,i,o,s,n,f,r,d,c,h,_){f===void 0&&(f=!0),r===void 0&&(r=!1),d===void 0&&(d=3),c===void 0&&(c=0);var u=a.call(this,null,n,!f,r,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,h)||this;return u.format=s,u._engine&&(!u._engine._caps.textureFloatLinearFiltering&&c===1&&(d=1),!u._engine._caps.textureHalfFloatLinearFiltering&&c===2&&(d=1),u._texture=u._engine.createRawTexture(t,i,o,s,f,r,d,null,c,h!=null?h:0,_!=null?_:!1),u.wrapU=rt.CLAMP_ADDRESSMODE,u.wrapV=rt.CLAMP_ADDRESSMODE),u}return e.prototype.update=function(t){this._getEngine().updateRawTexture(this._texture,t,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer)},e.CreateLuminanceTexture=function(t,i,o,s,n,f,r){return n===void 0&&(n=!0),f===void 0&&(f=!1),r===void 0&&(r=3),new e(t,i,o,1,s,n,f,r)},e.CreateLuminanceAlphaTexture=function(t,i,o,s,n,f,r){return n===void 0&&(n=!0),f===void 0&&(f=!1),r===void 0&&(r=3),new e(t,i,o,2,s,n,f,r)},e.CreateAlphaTexture=function(t,i,o,s,n,f,r){return n===void 0&&(n=!0),f===void 0&&(f=!1),r===void 0&&(r=3),new e(t,i,o,0,s,n,f,r)},e.CreateRGBTexture=function(t,i,o,s,n,f,r,d,c,h){return n===void 0&&(n=!0),f===void 0&&(f=!1),r===void 0&&(r=3),d===void 0&&(d=0),c===void 0&&(c=0),h===void 0&&(h=!1),new e(t,i,o,4,s,n,f,r,d,c,h)},e.CreateRGBATexture=function(t,i,o,s,n,f,r,d,c,h){return n===void 0&&(n=!0),f===void 0&&(f=!1),r===void 0&&(r=3),d===void 0&&(d=0),c===void 0&&(c=0),h===void 0&&(h=!1),new e(t,i,o,5,s,n,f,r,d,c,h)},e.CreateRGBAStorageTexture=function(t,i,o,s,n,f,r,d,c){return n===void 0&&(n=!0),f===void 0&&(f=!1),r===void 0&&(r=3),d===void 0&&(d=0),c===void 0&&(c=!1),new e(t,i,o,5,s,n,f,r,d,1,c)},e.CreateRTexture=function(t,i,o,s,n,f,r,d){return n===void 0&&(n=!0),f===void 0&&(f=!1),r===void 0&&(r=rt.TRILINEAR_SAMPLINGMODE),d===void 0&&(d=1),new e(t,i,o,6,s,n,f,r,d)},e.CreateRStorageTexture=function(t,i,o,s,n,f,r,d){return n===void 0&&(n=!0),f===void 0&&(f=!1),r===void 0&&(r=rt.TRILINEAR_SAMPLINGMODE),d===void 0&&(d=1),new e(t,i,o,6,s,n,f,r,d,1)},e}(rt),ct=function(){function a(){this.direction1=new p(0,1,0),this.direction2=new p(0,1,0),this.minEmitBox=new p(-.5,-.5,-.5),this.maxEmitBox=new p(.5,.5,.5)}return a.prototype.startDirectionFunction=function(e,t,i,o){var s=m.RandomRange(this.direction1.x,this.direction2.x),n=m.RandomRange(this.direction1.y,this.direction2.y),f=m.RandomRange(this.direction1.z,this.direction2.z);if(o){t.x=s,t.y=n,t.z=f;return}p.TransformNormalFromFloatsToRef(s,n,f,e,t)},a.prototype.startPositionFunction=function(e,t,i,o){var s=m.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),n=m.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),f=m.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);if(o){t.x=s,t.y=n,t.z=f;return}p.TransformCoordinatesFromFloatsToRef(s,n,f,e,t)},a.prototype.clone=function(){var e=new a;return Y.DeepCopy(this,e),e},a.prototype.applyToShader=function(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)},a.prototype.buildUniformLayout=function(e){e.addUniform("direction1",3),e.addUniform("direction2",3),e.addUniform("minEmitBox",3),e.addUniform("maxEmitBox",3)},a.prototype.getEffectDefines=function(){return"#define BOXEMITTER"},a.prototype.getClassName=function(){return"BoxParticleEmitter"},a.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e},a.prototype.parse=function(e){p.FromArrayToRef(e.direction1,0,this.direction1),p.FromArrayToRef(e.direction2,0,this.direction2),p.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),p.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)},a}(),Vt=function(){function a(e,t,i){e===void 0&&(e=1),t===void 0&&(t=Math.PI),i===void 0&&(i=0),this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=t,this.radius=e}return Object.defineProperty(a.prototype,"radius",{get:function(){return this._radius},set:function(e){this._radius=e,this._buildHeight()},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"angle",{get:function(){return this._angle},set:function(e){this._angle=e,this._buildHeight()},enumerable:!1,configurable:!0}),a.prototype._buildHeight=function(){this._angle!==0?this._height=this._radius/Math.tan(this._angle/2):this._height=1},a.prototype.startDirectionFunction=function(e,t,i,o){o?G.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(e.getTranslation(),G.Vector3[0]).normalize();var s=m.RandomRange(0,this.directionRandomizer),n=m.RandomRange(0,this.directionRandomizer),f=m.RandomRange(0,this.directionRandomizer);t.x=G.Vector3[0].x+s,t.y=G.Vector3[0].y+n,t.z=G.Vector3[0].z+f,t.normalize()},a.prototype.startPositionFunction=function(e,t,i,o){var s=m.RandomRange(0,Math.PI*2),n;this.emitFromSpawnPointOnly?n=1e-4:(n=m.RandomRange(0,this.heightRange),n=1-n*n);var f=this._radius-m.RandomRange(0,this._radius*this.radiusRange);f=f*n;var r=f*Math.sin(s),d=f*Math.cos(s),c=n*this._height;if(o){t.x=r,t.y=c,t.z=d;return}p.TransformCoordinatesFromFloatsToRef(r,c,d,e,t)},a.prototype.clone=function(){var e=new a(this._radius,this._angle,this.directionRandomizer);return Y.DeepCopy(this,e),e},a.prototype.applyToShader=function(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)},a.prototype.buildUniformLayout=function(e){e.addUniform("radius",2),e.addUniform("coneAngle",1),e.addUniform("height",2),e.addUniform("directionRandomizer",1)},a.prototype.getEffectDefines=function(){var e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+=`
#define CONEEMITTERSPAWNPOINT`),e},a.prototype.getClassName=function(){return"ConeParticleEmitter"},a.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e.radiusRange=this.radiusRange,e.heightRange=this.heightRange,e.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,e},a.prototype.parse=function(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer,this.radiusRange=e.radiusRange!==void 0?e.radiusRange:1,this.heightRange=e.radiusRange!==void 0?e.heightRange:1,this.emitFromSpawnPointOnly=e.emitFromSpawnPointOnly!==void 0?e.emitFromSpawnPointOnly:!1},a}(),xt=function(){function a(e,t,i,o){e===void 0&&(e=1),t===void 0&&(t=1),i===void 0&&(i=1),o===void 0&&(o=0),this.radius=e,this.height=t,this.radiusRange=i,this.directionRandomizer=o,this._tempVector=p.Zero()}return a.prototype.startDirectionFunction=function(e,t,i,o,s){i.position.subtractToRef(e.getTranslation(),this._tempVector),this._tempVector.normalize(),p.TransformNormalToRef(this._tempVector,s,this._tempVector);var n=m.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2),f=Math.atan2(this._tempVector.x,this._tempVector.z);if(f+=m.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=n,this._tempVector.x=Math.sin(f),this._tempVector.z=Math.cos(f),this._tempVector.normalize(),o){t.copyFrom(this._tempVector);return}p.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e,t)},a.prototype.startPositionFunction=function(e,t,i,o){var s=m.RandomRange(-this.height/2,this.height/2),n=m.RandomRange(0,2*Math.PI),f=m.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),r=Math.sqrt(f)*this.radius,d=r*Math.cos(n),c=r*Math.sin(n);if(o){t.copyFromFloats(d,s,c);return}p.TransformCoordinatesFromFloatsToRef(d,s,c,e,t)},a.prototype.clone=function(){var e=new a(this.radius,this.directionRandomizer);return Y.DeepCopy(this,e),e},a.prototype.applyToShader=function(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)},a.prototype.buildUniformLayout=function(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)},a.prototype.getEffectDefines=function(){return"#define CYLINDEREMITTER"},a.prototype.getClassName=function(){return"CylinderParticleEmitter"},a.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e},a.prototype.parse=function(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer},a}(),Nt=function(a){mt(e,a);function e(t,i,o,s,n){t===void 0&&(t=1),i===void 0&&(i=1),o===void 0&&(o=1),s===void 0&&(s=new p(0,1,0)),n===void 0&&(n=new p(0,1,0));var f=a.call(this,t,i,o)||this;return f.direction1=s,f.direction2=n,f}return e.prototype.startDirectionFunction=function(t,i){var o=m.RandomRange(this.direction1.x,this.direction2.x),s=m.RandomRange(this.direction1.y,this.direction2.y),n=m.RandomRange(this.direction1.z,this.direction2.z);p.TransformNormalFromFloatsToRef(o,s,n,t,i)},e.prototype.clone=function(){var t=new e(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return Y.DeepCopy(this,t),t},e.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("height",this.height),t.setFloat("radiusRange",this.radiusRange),t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)},e.prototype.buildUniformLayout=function(t){t.addUniform("radius",1),t.addUniform("height",1),t.addUniform("radiusRange",1),t.addUniform("direction1",3),t.addUniform("direction2",3)},e.prototype.getEffectDefines=function(){return`#define CYLINDEREMITTER
#define DIRECTEDCYLINDEREMITTER`},e.prototype.getClassName=function(){return"CylinderDirectedParticleEmitter"},e.prototype.serialize=function(){var t=a.prototype.serialize.call(this);return t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t},e.prototype.parse=function(t){a.prototype.parse.call(this,t),this.direction1.copyFrom(t.direction1),this.direction2.copyFrom(t.direction2)},e}(xt),Mt=function(){function a(e,t,i){e===void 0&&(e=1),t===void 0&&(t=1),i===void 0&&(i=0),this.radius=e,this.radiusRange=t,this.directionRandomizer=i}return a.prototype.startDirectionFunction=function(e,t,i,o){var s=i.position.subtract(e.getTranslation()).normalize(),n=m.RandomRange(0,this.directionRandomizer),f=m.RandomRange(0,this.directionRandomizer),r=m.RandomRange(0,this.directionRandomizer);if(s.x+=n,s.y+=f,s.z+=r,s.normalize(),o){t.copyFrom(s);return}p.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)},a.prototype.startPositionFunction=function(e,t,i,o){var s=this.radius-m.RandomRange(0,this.radius*this.radiusRange),n=m.RandomRange(0,1),f=m.RandomRange(0,2*Math.PI),r=Math.acos(2*n-1),d=s*Math.cos(f)*Math.sin(r),c=s*Math.cos(r),h=s*Math.sin(f)*Math.sin(r);if(o){t.copyFromFloats(d,Math.abs(c),h);return}p.TransformCoordinatesFromFloatsToRef(d,Math.abs(c),h,e,t)},a.prototype.clone=function(){var e=new a(this.radius,this.directionRandomizer);return Y.DeepCopy(this,e),e},a.prototype.applyToShader=function(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)},a.prototype.buildUniformLayout=function(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)},a.prototype.getEffectDefines=function(){return"#define HEMISPHERICEMITTER"},a.prototype.getClassName=function(){return"HemisphericParticleEmitter"},a.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e},a.prototype.parse=function(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer},a}(),zt=function(){function a(){this.direction1=new p(0,1,0),this.direction2=new p(0,1,0)}return a.prototype.startDirectionFunction=function(e,t,i,o){var s=m.RandomRange(this.direction1.x,this.direction2.x),n=m.RandomRange(this.direction1.y,this.direction2.y),f=m.RandomRange(this.direction1.z,this.direction2.z);if(o){t.copyFromFloats(s,n,f);return}p.TransformNormalFromFloatsToRef(s,n,f,e,t)},a.prototype.startPositionFunction=function(e,t,i,o){if(o){t.copyFromFloats(0,0,0);return}p.TransformCoordinatesFromFloatsToRef(0,0,0,e,t)},a.prototype.clone=function(){var e=new a;return Y.DeepCopy(this,e),e},a.prototype.applyToShader=function(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)},a.prototype.buildUniformLayout=function(e){e.addUniform("direction1",3),e.addUniform("direction2",3)},a.prototype.getEffectDefines=function(){return"#define POINTEMITTER"},a.prototype.getClassName=function(){return"PointParticleEmitter"},a.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e},a.prototype.parse=function(e){p.FromArrayToRef(e.direction1,0,this.direction1),p.FromArrayToRef(e.direction2,0,this.direction2)},a}(),Tt=function(){function a(e,t,i){e===void 0&&(e=1),t===void 0&&(t=1),i===void 0&&(i=0),this.radius=e,this.radiusRange=t,this.directionRandomizer=i}return a.prototype.startDirectionFunction=function(e,t,i,o){var s=i.position.subtract(e.getTranslation()).normalize(),n=m.RandomRange(0,this.directionRandomizer),f=m.RandomRange(0,this.directionRandomizer),r=m.RandomRange(0,this.directionRandomizer);if(s.x+=n,s.y+=f,s.z+=r,s.normalize(),o){t.copyFrom(s);return}p.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)},a.prototype.startPositionFunction=function(e,t,i,o){var s=this.radius-m.RandomRange(0,this.radius*this.radiusRange),n=m.RandomRange(0,1),f=m.RandomRange(0,2*Math.PI),r=Math.acos(2*n-1),d=s*Math.cos(f)*Math.sin(r),c=s*Math.cos(r),h=s*Math.sin(f)*Math.sin(r);if(o){t.copyFromFloats(d,c,h);return}p.TransformCoordinatesFromFloatsToRef(d,c,h,e,t)},a.prototype.clone=function(){var e=new a(this.radius,this.directionRandomizer);return Y.DeepCopy(this,e),e},a.prototype.applyToShader=function(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)},a.prototype.buildUniformLayout=function(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)},a.prototype.getEffectDefines=function(){return"#define SPHEREEMITTER"},a.prototype.getClassName=function(){return"SphereParticleEmitter"},a.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e},a.prototype.parse=function(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer},a}(),Ot=function(a){mt(e,a);function e(t,i,o){t===void 0&&(t=1),i===void 0&&(i=new p(0,1,0)),o===void 0&&(o=new p(0,1,0));var s=a.call(this,t)||this;return s.direction1=i,s.direction2=o,s}return e.prototype.startDirectionFunction=function(t,i){var o=m.RandomRange(this.direction1.x,this.direction2.x),s=m.RandomRange(this.direction1.y,this.direction2.y),n=m.RandomRange(this.direction1.z,this.direction2.z);p.TransformNormalFromFloatsToRef(o,s,n,t,i)},e.prototype.clone=function(){var t=new e(this.radius,this.direction1,this.direction2);return Y.DeepCopy(this,t),t},e.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("radiusRange",this.radiusRange),t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)},e.prototype.buildUniformLayout=function(t){t.addUniform("radius",1),t.addUniform("radiusRange",1),t.addUniform("direction1",3),t.addUniform("direction2",3)},e.prototype.getEffectDefines=function(){return`#define SPHEREEMITTER
#define DIRECTEDSPHEREEMITTER`},e.prototype.getClassName=function(){return"SphereDirectedParticleEmitter"},e.prototype.serialize=function(){var t=a.prototype.serialize.call(this);return t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t},e.prototype.parse=function(t){a.prototype.parse.call(this,t),this.direction1.copyFrom(t.direction1),this.direction2.copyFrom(t.direction2)},e}(Tt),ie=function(){function a(e){e===void 0&&(e=null),this._indices=null,this._positions=null,this._normals=null,this._storedNormal=p.Zero(),this._mesh=null,this.direction1=new p(0,1,0),this.direction2=new p(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=e}return Object.defineProperty(a.prototype,"mesh",{get:function(){return this._mesh},set:function(e){this._mesh!==e&&(this._mesh=e,e?(this._indices=e.getIndices(),this._positions=e.getVerticesData(q.PositionKind),this._normals=e.getVerticesData(q.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))},enumerable:!1,configurable:!0}),a.prototype.startDirectionFunction=function(e,t,i,o){if(this.useMeshNormalsForDirection&&this._normals){p.TransformNormalToRef(this._storedNormal,e,t);return}var s=m.RandomRange(this.direction1.x,this.direction2.x),n=m.RandomRange(this.direction1.y,this.direction2.y),f=m.RandomRange(this.direction1.z,this.direction2.z);if(o){t.copyFromFloats(s,n,f);return}p.TransformNormalFromFloatsToRef(s,n,f,e,t)},a.prototype.startPositionFunction=function(e,t,i,o){if(!(!this._indices||!this._positions)){var s=3*Math.random()*(this._indices.length/3)|0,n=Math.random(),f=Math.random()*(1-n),r=1-n-f,d=this._indices[s],c=this._indices[s+1],h=this._indices[s+2],_=G.Vector3[0],u=G.Vector3[1],v=G.Vector3[2],E=G.Vector3[3];p.FromArrayToRef(this._positions,d*3,_),p.FromArrayToRef(this._positions,c*3,u),p.FromArrayToRef(this._positions,h*3,v),E.x=n*_.x+f*u.x+r*v.x,E.y=n*_.y+f*u.y+r*v.y,E.z=n*_.z+f*u.z+r*v.z,o?t.copyFromFloats(E.x,E.y,E.z):p.TransformCoordinatesFromFloatsToRef(E.x,E.y,E.z,e,t),this.useMeshNormalsForDirection&&this._normals&&(p.FromArrayToRef(this._normals,d*3,_),p.FromArrayToRef(this._normals,c*3,u),p.FromArrayToRef(this._normals,h*3,v),this._storedNormal.x=n*_.x+f*u.x+r*v.x,this._storedNormal.y=n*_.y+f*u.y+r*v.y,this._storedNormal.z=n*_.z+f*u.z+r*v.z)}},a.prototype.clone=function(){var e=new a(this.mesh);return Y.DeepCopy(this,e),e},a.prototype.applyToShader=function(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)},a.prototype.buildUniformLayout=function(e){e.addUniform("direction1",3),e.addUniform("direction2",3)},a.prototype.getEffectDefines=function(){return""},a.prototype.getClassName=function(){return"MeshParticleEmitter"},a.prototype.serialize=function(){var e,t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t.meshId=(e=this.mesh)===null||e===void 0?void 0:e.id,t.useMeshNormalsForDirection=this.useMeshNormalsForDirection,t},a.prototype.parse=function(e,t){p.FromArrayToRef(e.direction1,0,this.direction1),p.FromArrayToRef(e.direction2,0,this.direction2),e.meshId&&t&&(this.mesh=t.getLastMeshById(e.meshId)),this.useMeshNormalsForDirection=e.useMeshNormalsForDirection},a}(),re=function(){function a(e){this.animations=[],this.renderingGroupId=0,this.emitter=p.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this._rootUrl="",this.noiseStrength=new p(10,10,10),this.onAnimationEnd=null,this.blendMode=a.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new Ft(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new p(0,0,0),this.gravity=p.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new A(1,1,1,1),this.color2=new A(1,1,1,1),this.colorDead=new A(0,0,0,1),this.textureMask=new A(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new Zt,this.id=e,this.name=e}return Object.defineProperty(a.prototype,"noiseTexture",{get:function(){return this._noiseTexture},set:function(e){this._noiseTexture!==e&&(this._noiseTexture=e,this._reset())},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"isAnimationSheetEnabled",{get:function(){return this._isAnimationSheetEnabled},set:function(e){this._isAnimationSheetEnabled!=e&&(this._isAnimationSheetEnabled=e,this._reset())},enumerable:!1,configurable:!0}),a.prototype.getScene=function(){return this._scene},a.prototype._hasTargetStopDurationDependantGradient=function(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0},a.prototype.getDragGradients=function(){return this._dragGradients},a.prototype.getLimitVelocityGradients=function(){return this._limitVelocityGradients},a.prototype.getColorGradients=function(){return this._colorGradients},a.prototype.getSizeGradients=function(){return this._sizeGradients},a.prototype.getColorRemapGradients=function(){return this._colorRemapGradients},a.prototype.getAlphaRemapGradients=function(){return this._alphaRemapGradients},a.prototype.getLifeTimeGradients=function(){return this._lifeTimeGradients},a.prototype.getAngularSpeedGradients=function(){return this._angularSpeedGradients},a.prototype.getVelocityGradients=function(){return this._velocityGradients},a.prototype.getStartSizeGradients=function(){return this._startSizeGradients},a.prototype.getEmitRateGradients=function(){return this._emitRateGradients},Object.defineProperty(a.prototype,"direction1",{get:function(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:p.Zero()},set:function(e){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=e)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"direction2",{get:function(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:p.Zero()},set:function(e){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=e)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"minEmitBox",{get:function(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:p.Zero()},set:function(e){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=e)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"maxEmitBox",{get:function(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:p.Zero()},set:function(e){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=e)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"billboardMode",{get:function(){return this._billboardMode},set:function(e){this._billboardMode!==e&&(this._billboardMode=e,this._reset())},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"isBillboardBased",{get:function(){return this._isBillboardBased},set:function(e){this._isBillboardBased!==e&&(this._isBillboardBased=e,this._reset())},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e)},enumerable:!1,configurable:!0}),a.prototype._attachImageProcessingConfiguration=function(e){e!==this._imageProcessingConfiguration&&(!e&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=e)},a.prototype._reset=function(){},a.prototype._removeGradientAndTexture=function(e,t,i){if(!t)return this;for(var o=0,s=0,n=t;s<n.length;s++){var f=n[s];if(f.gradient===e){t.splice(o,1);break}o++}return i&&i.dispose(),this},a.prototype.createPointEmitter=function(e,t){var i=new zt;return i.direction1=e,i.direction2=t,this.particleEmitterType=i,i},a.prototype.createHemisphericEmitter=function(e,t){e===void 0&&(e=1),t===void 0&&(t=1);var i=new Mt(e,t);return this.particleEmitterType=i,i},a.prototype.createSphereEmitter=function(e,t){e===void 0&&(e=1),t===void 0&&(t=1);var i=new Tt(e,t);return this.particleEmitterType=i,i},a.prototype.createDirectedSphereEmitter=function(e,t,i){e===void 0&&(e=1),t===void 0&&(t=new p(0,1,0)),i===void 0&&(i=new p(0,1,0));var o=new Ot(e,t,i);return this.particleEmitterType=o,o},a.prototype.createCylinderEmitter=function(e,t,i,o){e===void 0&&(e=1),t===void 0&&(t=1),i===void 0&&(i=1),o===void 0&&(o=0);var s=new xt(e,t,i,o);return this.particleEmitterType=s,s},a.prototype.createDirectedCylinderEmitter=function(e,t,i,o,s){e===void 0&&(e=1),t===void 0&&(t=1),i===void 0&&(i=1),o===void 0&&(o=new p(0,1,0)),s===void 0&&(s=new p(0,1,0));var n=new Nt(e,t,i,o,s);return this.particleEmitterType=n,n},a.prototype.createConeEmitter=function(e,t){e===void 0&&(e=1),t===void 0&&(t=Math.PI/4);var i=new Vt(e,t);return this.particleEmitterType=i,i},a.prototype.createBoxEmitter=function(e,t,i,o){var s=new ct;return this.particleEmitterType=s,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=o,s},a.BLENDMODE_ONEONE=0,a.BLENDMODE_STANDARD=1,a.BLENDMODE_ADD=2,a.BLENDMODE_MULTIPLY=3,a.BLENDMODE_MULTIPLYADD=4,a}(),ne=function(){function a(e){this.particleSystem=e,this.position=p.Zero(),this.direction=p.Zero(),this.color=new A(0,0,0,0),this.colorStep=new A(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new Ft(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new A(0,0,0,0),this._currentColor2=new A(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=a._Count++,this.particleSystem.isAnimationSheetEnabled&&this._updateCellInfoFromSystem()}return a.prototype._updateCellInfoFromSystem=function(){this.cellIndex=this.particleSystem.startSpriteCellID},a.prototype.updateCellIndex=function(){var e=this.age,t=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(this._randomCellOffset===void 0&&(this._randomCellOffset=Math.random()*this.lifeTime),t===0?(t=1,e=this._randomCellOffset):e+=this._randomCellOffset);var i=this._initialEndSpriteCellID-this._initialStartSpriteCellID,o;this._initialSpriteCellLoop?o=m.Clamp(e*t%this.lifeTime/this.lifeTime):o=m.Clamp(e*t/this.lifeTime),this.cellIndex=this._initialStartSpriteCellID+o*i|0},a.prototype._inheritParticleInfoToSubEmitter=function(e){if(e.particleSystem.emitter.position){var t=e.particleSystem.emitter;if(t.position.copyFrom(this.position),e.inheritDirection){var i=G.Vector3[0];this.direction.normalizeToRef(i),t.setDirection(i,0,Math.PI/2)}}else{var o=e.particleSystem.emitter;o.copyFrom(this.position)}this.direction.scaleToRef(e.inheritedVelocityAmount/2,G.Vector3[0]),e.particleSystem._inheritedVelocityOffset.copyFrom(G.Vector3[0])},a.prototype._inheritParticleInfoToSubEmitters=function(){var e=this;this._attachedSubEmitters&&this._attachedSubEmitters.length>0&&this._attachedSubEmitters.forEach(function(t){e._inheritParticleInfoToSubEmitter(t)})},a.prototype._reset=function(){this.age=0,this.id=a._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0},a.prototype.copyTo=function(e){e.position.copyFrom(this.position),this._initialDirection?e._initialDirection?e._initialDirection.copyFrom(this._initialDirection):e._initialDirection=this._initialDirection.clone():e._initialDirection=null,e.direction.copyFrom(this.direction),this._localPosition&&(e._localPosition?e._localPosition.copyFrom(this._localPosition):e._localPosition=this._localPosition.clone()),e.color.copyFrom(this.color),e.colorStep.copyFrom(this.colorStep),e.lifeTime=this.lifeTime,e.age=this.age,e._randomCellOffset=this._randomCellOffset,e.size=this.size,e.scale.copyFrom(this.scale),e.angle=this.angle,e.angularSpeed=this.angularSpeed,e.particleSystem=this.particleSystem,e.cellIndex=this.cellIndex,e.id=this.id,e._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(e._currentColorGradient=this._currentColorGradient,e._currentColor1.copyFrom(this._currentColor1),e._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(e._currentSizeGradient=this._currentSizeGradient,e._currentSize1=this._currentSize1,e._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(e._currentAngularSpeedGradient=this._currentAngularSpeedGradient,e._currentAngularSpeed1=this._currentAngularSpeed1,e._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(e._currentVelocityGradient=this._currentVelocityGradient,e._currentVelocity1=this._currentVelocity1,e._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(e._currentLimitVelocityGradient=this._currentLimitVelocityGradient,e._currentLimitVelocity1=this._currentLimitVelocity1,e._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(e._currentDragGradient=this._currentDragGradient,e._currentDrag1=this._currentDrag1,e._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(e._initialStartSpriteCellID=this._initialStartSpriteCellID,e._initialEndSpriteCellID=this._initialEndSpriteCellID,e._initialSpriteCellLoop=this._initialSpriteCellLoop),this.particleSystem.useRampGradients&&(e.remapData&&this.remapData?e.remapData.copyFrom(this.remapData):e.remapData=new It(0,0,0,0)),this._randomNoiseCoordinates1&&(e._randomNoiseCoordinates1?(e._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),e._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(e._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),e._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))},a._Count=0,a}(),dt;(function(a){a[a.ATTACHED=0]="ATTACHED",a[a.END=1]="END"})(dt||(dt={}));var ut=function(){function a(e){if(this.particleSystem=e,this.type=dt.END,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!e.emitter||!e.emitter.dispose){var t=ft("BABYLON.AbstractMesh");e.emitter=new t("SubemitterSystemEmitter",e.getScene()),e._disposeEmitterOnDispose=!0}}return a.prototype.clone=function(){var e=this.particleSystem.emitter;if(!e)e=new p;else if(e instanceof p)e=e.clone();else if(e.getClassName().indexOf("Mesh")!==-1){var t=ft("BABYLON.Mesh");e=new t("",e.getScene()),e.isVisible=!1}var i=new a(this.particleSystem.clone(this.particleSystem.name,e));return i.particleSystem.name+="Clone",i.type=this.type,i.inheritDirection=this.inheritDirection,i.inheritedVelocityAmount=this.inheritedVelocityAmount,i.particleSystem._disposeEmitterOnDispose=!0,i.particleSystem.disposeOnStop=!0,i},a.prototype.serialize=function(e){e===void 0&&(e=!1);var t={};return t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem=this.particleSystem.serialize(e),t},a._ParseParticleSystem=function(e,t,i,o){throw kt("ParseParticle")},a.Parse=function(e,t,i){var o=e.particleSystem,s=new a(a._ParseParticleSystem(o,t,i,!0));return s.type=e.type,s.inheritDirection=e.inheritDirection,s.inheritedVelocityAmount=e.inheritedVelocityAmount,s.particleSystem._isSubEmitter=!0,s},a.prototype.dispose=function(){this.particleSystem.dispose()},a}(),oe="particlesPixelShader",ae=`varying vec2 vUV;
varying vec4 vColor;
uniform vec4 textureMask;
uniform sampler2D diffuseSampler;
#include<clipPlaneFragmentDeclaration>
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#ifdef RAMPGRADIENT
varying vec4 remapRanges;
uniform sampler2D rampSampler;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec4 textureColor=texture2D(diffuseSampler,vUV);
vec4 baseColor=(textureColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;
#ifdef RAMPGRADIENT
float alpha=baseColor.a;
float remappedColorIndex=clamp((alpha-remapRanges.x)/remapRanges.y,0.0,1.0);
vec4 rampColor=texture2D(rampSampler,vec2(1.0-remappedColorIndex,0.));
baseColor.rgb*=rampColor.rgb;
float finalAlpha=baseColor.a;
baseColor.a=clamp((alpha*rampColor.a-remapRanges.z)/remapRanges.w,0.0,1.0);
#endif
#ifdef BLENDMULTIPLYMODE
float sourceAlpha=vColor.a*textureColor.a;
baseColor.rgb=baseColor.rgb*sourceAlpha+vec3(1.0)*(1.0-sourceAlpha);
#endif
#ifdef IMAGEPROCESSINGPOSTPROCESS
baseColor.rgb=toLinearSpace(baseColor.rgb);
#else
#ifdef IMAGEPROCESSING
baseColor.rgb=toLinearSpace(baseColor.rgb);
baseColor=applyImageProcessing(baseColor);
#endif
#endif
gl_FragColor=baseColor;
#define CUSTOM_FRAGMENT_MAIN_END
}`;Lt.ShadersStore[oe]=ae;var se="particlesVertexShader",fe=`attribute vec3 position;
attribute vec4 color;
attribute float angle;
attribute vec2 size;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
#ifndef BILLBOARD
attribute vec3 direction;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
#ifdef RAMPGRADIENT
attribute vec4 remapData;
#endif
attribute vec2 offset;
uniform mat4 view;
uniform mat4 projection;
uniform vec2 translationPivot;
#ifdef ANIMATESHEET
uniform vec3 particlesInfos; 
#endif
varying vec2 vUV;
varying vec4 vColor;
varying vec3 vPositionW;
#ifdef RAMPGRADIENT
varying vec4 remapRanges;
#endif
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration>
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {
vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));
vec3 zaxis=normalize(cross(yaxis,xaxis));
vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);
vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);
vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);
mat3 rotMatrix= mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
return position+alignedCorner;
}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {
vec3 normalizedToCamera=normalize(toCamera);
vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));
vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));
vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);
vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);
vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);
mat3 rotMatrix= mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
return position+alignedCorner;
}
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec2 cornerPos;
cornerPos=(vec2(offset.x-0.5,offset.y -0.5)-translationPivot)*size+translationPivot;
#ifdef BILLBOARD
vec3 rotatedCorner;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.y=0.;
vec3 yaxis=position-eyePosition;
yaxis.y=0.;
vPositionW=rotate(normalize(yaxis),rotatedCorner);
vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
vec3 toCamera=position-eyePosition;
vPositionW=rotateAlign(toCamera,rotatedCorner);
vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
vec3 viewPos=(view*vec4(position,1.0)).xyz+rotatedCorner;
vPositionW=(invView*vec4(viewPos,1)).xyz;
#endif
#ifdef RAMPGRADIENT
remapRanges=remapData;
#endif
gl_Position=projection*vec4(viewPos,1.0);
#else
vec3 rotatedCorner;
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.y=0.;
vec3 yaxis=normalize(direction);
vPositionW=rotate(yaxis,rotatedCorner);
gl_Position=projection*view*vec4(vPositionW,1.0);
#endif
vColor=color;
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex*particlesInfos.z);
float columnOffset=cellIndex-rowOffset/particlesInfos.z;
vec2 uvScale=particlesInfos.xy;
vec2 uvOffset=vec2(offset.x ,1.0-offset.y);
vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=offset;
#endif
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;Lt.ShadersStore[se]=fe;var Ut=function(a){mt(e,a);function e(t,i,o,s,n,f){s===void 0&&(s=null),n===void 0&&(n=!1),f===void 0&&(f=.01);var r=a.call(this,t)||this;r._emitterInverseWorldMatrix=gt.Identity(),r._inheritedVelocityOffset=new p,r.onDisposeObservable=new Rt,r.onStoppedObservable=new Rt,r._particles=new Array,r._stockParticles=new Array,r._newPartsExcess=0,r._vertexBuffers={},r._scaledColorStep=new A(0,0,0,0),r._colorDiff=new A(0,0,0,0),r._scaledDirection=p.Zero(),r._scaledGravity=p.Zero(),r._currentRenderId=-1,r._useInstancing=!1,r._started=!1,r._stopped=!1,r._actualFrame=0,r._currentEmitRate1=0,r._currentEmitRate2=0,r._currentStartSize1=0,r._currentStartSize2=0,r._rawTextureWidth=256,r._useRampGradients=!1,r._disposeEmitterOnDispose=!1,r.isLocal=!1,r._onBeforeDrawParticlesObservable=null,r.recycleParticle=function(c){var h=r._particles.pop();h!==c&&h.copyTo(c),r._stockParticles.push(h)},r._createParticle=function(){var c;if(r._stockParticles.length!==0?(c=r._stockParticles.pop(),c._reset()):c=new ne(r),r._subEmitters&&r._subEmitters.length>0){var h=r._subEmitters[Math.floor(Math.random()*r._subEmitters.length)];c._attachedSubEmitters=[],h.forEach(function(_){if(_.type===dt.ATTACHED){var u=_.clone();c._attachedSubEmitters.push(u),u.particleSystem.start()}})}return c},r._emitFromParticle=function(c){if(!(!r._subEmitters||r._subEmitters.length===0)){var h=Math.floor(Math.random()*r._subEmitters.length);r._subEmitters[h].forEach(function(_){if(_.type===dt.END){var u=_.clone();c._inheritParticleInfoToSubEmitter(u),u.particleSystem._rootParticleSystem=r,r.activeSubSystems.push(u.particleSystem),u.particleSystem.start()}})}},r._capacity=i,r._epsilon=f,r._isAnimationSheetEnabled=n,!o||o.getClassName()==="Scene"?(r._scene=o||$t.LastCreatedScene,r._engine=r._scene.getEngine(),r.uniqueId=r._scene.getUniqueId(),r._scene.particleSystems.push(r)):(r._engine=o,r.defaultProjectionMatrix=gt.PerspectiveFovLH(.8,1,.1,100,r._engine.isNDCHalfZRange)),r._engine.getCaps().vertexArrayObject&&(r._vertexArrayObject=null),r._attachImageProcessingConfiguration(null),r._customWrappers={0:new Et(r._engine)},r._customWrappers[0].effect=s,r._drawWrappers=[],r._useInstancing=r._engine.getCaps().instancedArrays,r._createIndexBuffer(),r._createVertexBuffers(),r.particleEmitterType=new ct;var d=null;return r.updateFunction=function(c){var h,_=null;r.noiseTexture&&(_=r.noiseTexture.getSize(),(h=r.noiseTexture.getContent())===null||h===void 0||h.then(function(x){d=x}));for(var u=function(x){var l=c[x],y=r._scaledUpdateSpeed,T=l.age;if(l.age+=y,l.age>l.lifeTime){var w=l.age-T,b=l.lifeTime-T;y=b*y/w,l.age=l.lifeTime}var D=l.age/l.lifeTime;r._colorGradients&&r._colorGradients.length>0?M.GetCurrentGradient(D,r._colorGradients,function(g,C,R){g!==l._currentColorGradient&&(l._currentColor1.copyFrom(l._currentColor2),C.getColorToRef(l._currentColor2),l._currentColorGradient=g),A.LerpToRef(l._currentColor1,l._currentColor2,R,l.color)}):(l.colorStep.scaleToRef(y,r._scaledColorStep),l.color.addInPlace(r._scaledColorStep),l.color.a<0&&(l.color.a=0)),r._angularSpeedGradients&&r._angularSpeedGradients.length>0&&M.GetCurrentGradient(D,r._angularSpeedGradients,function(g,C,R){g!==l._currentAngularSpeedGradient&&(l._currentAngularSpeed1=l._currentAngularSpeed2,l._currentAngularSpeed2=C.getFactor(),l._currentAngularSpeedGradient=g),l.angularSpeed=m.Lerp(l._currentAngularSpeed1,l._currentAngularSpeed2,R)}),l.angle+=l.angularSpeed*y;var L=y;if(r._velocityGradients&&r._velocityGradients.length>0&&M.GetCurrentGradient(D,r._velocityGradients,function(g,C,R){g!==l._currentVelocityGradient&&(l._currentVelocity1=l._currentVelocity2,l._currentVelocity2=C.getFactor(),l._currentVelocityGradient=g),L*=m.Lerp(l._currentVelocity1,l._currentVelocity2,R)}),l.direction.scaleToRef(L,r._scaledDirection),r._limitVelocityGradients&&r._limitVelocityGradients.length>0&&M.GetCurrentGradient(D,r._limitVelocityGradients,function(g,C,R){g!==l._currentLimitVelocityGradient&&(l._currentLimitVelocity1=l._currentLimitVelocity2,l._currentLimitVelocity2=C.getFactor(),l._currentLimitVelocityGradient=g);var I=m.Lerp(l._currentLimitVelocity1,l._currentLimitVelocity2,R),N=l.direction.length();N>I&&l.direction.scaleInPlace(r.limitVelocityDamping)}),r._dragGradients&&r._dragGradients.length>0&&M.GetCurrentGradient(D,r._dragGradients,function(g,C,R){g!==l._currentDragGradient&&(l._currentDrag1=l._currentDrag2,l._currentDrag2=C.getFactor(),l._currentDragGradient=g);var I=m.Lerp(l._currentDrag1,l._currentDrag2,R);r._scaledDirection.scaleInPlace(1-I)}),r.isLocal&&l._localPosition?(l._localPosition.addInPlace(r._scaledDirection),p.TransformCoordinatesToRef(l._localPosition,r._emitterWorldMatrix,l.position)):l.position.addInPlace(r._scaledDirection),d&&_&&l._randomNoiseCoordinates1){var U=r._fetchR(l._randomNoiseCoordinates1.x,l._randomNoiseCoordinates1.y,_.width,_.height,d),P=r._fetchR(l._randomNoiseCoordinates1.z,l._randomNoiseCoordinates2.x,_.width,_.height,d),V=r._fetchR(l._randomNoiseCoordinates2.y,l._randomNoiseCoordinates2.z,_.width,_.height,d),F=G.Vector3[0],B=G.Vector3[1];F.copyFromFloats((2*U-1)*r.noiseStrength.x,(2*P-1)*r.noiseStrength.y,(2*V-1)*r.noiseStrength.z),F.scaleToRef(y,B),l.direction.addInPlace(B)}if(r.gravity.scaleToRef(y,r._scaledGravity),l.direction.addInPlace(r._scaledGravity),r._sizeGradients&&r._sizeGradients.length>0&&M.GetCurrentGradient(D,r._sizeGradients,function(g,C,R){g!==l._currentSizeGradient&&(l._currentSize1=l._currentSize2,l._currentSize2=C.getFactor(),l._currentSizeGradient=g),l.size=m.Lerp(l._currentSize1,l._currentSize2,R)}),r._useRampGradients&&(r._colorRemapGradients&&r._colorRemapGradients.length>0&&M.GetCurrentGradient(D,r._colorRemapGradients,function(g,C,R){var I=m.Lerp(g.factor1,C.factor1,R),N=m.Lerp(g.factor2,C.factor2,R);l.remapData.x=I,l.remapData.y=N-I}),r._alphaRemapGradients&&r._alphaRemapGradients.length>0&&M.GetCurrentGradient(D,r._alphaRemapGradients,function(g,C,R){var I=m.Lerp(g.factor1,C.factor1,R),N=m.Lerp(g.factor2,C.factor2,R);l.remapData.z=I,l.remapData.w=N-I})),r._isAnimationSheetEnabled&&l.updateCellIndex(),l._inheritParticleInfoToSubEmitters(),l.age>=l.lifeTime)return r._emitFromParticle(l),l._attachedSubEmitters&&(l._attachedSubEmitters.forEach(function(g){g.particleSystem.disposeOnStop=!0,g.particleSystem.stop()}),l._attachedSubEmitters=null),r.recycleParticle(l),x--,v=x,"continue";v=x},v,E=0;E<c.length;E++)u(E),E=v},r}return Object.defineProperty(e.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"useRampGradients",{get:function(){return this._useRampGradients},set:function(t){this._useRampGradients!==t&&(this._useRampGradients=t,this._resetEffect())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"particles",{get:function(){return this._particles},enumerable:!1,configurable:!0}),e.prototype.getActiveCount=function(){return this._particles.length},e.prototype.getClassName=function(){return"ParticleSystem"},e.prototype.isStopping=function(){return this._stopped&&this.isAlive()},e.prototype.getCustomEffect=function(t){var i,o;return t===void 0&&(t=0),(o=(i=this._customWrappers[t])===null||i===void 0?void 0:i.effect)!==null&&o!==void 0?o:this._customWrappers[0].effect},e.prototype._getCustomDrawWrapper=function(t){var i;return t===void 0&&(t=0),(i=this._customWrappers[t])!==null&&i!==void 0?i:this._customWrappers[0]},e.prototype.setCustomEffect=function(t,i){i===void 0&&(i=0),this._customWrappers[i]=new Et(this._engine),this._customWrappers[i].effect=t,this._customWrappers[i].drawContext&&(this._customWrappers[i].drawContext.useInstancing=this._useInstancing)},Object.defineProperty(e.prototype,"onBeforeDrawParticlesObservable",{get:function(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new Rt),this._onBeforeDrawParticlesObservable},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"vertexShaderName",{get:function(){return"particles"},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"vertexBuffers",{get:function(){return this._vertexBuffers},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"indexBuffer",{get:function(){return this._indexBuffer},enumerable:!1,configurable:!0}),e.prototype._addFactorGradient=function(t,i,o,s){var n=new te(i,o,s);t.push(n),t.sort(function(f,r){return f.gradient<r.gradient?-1:f.gradient>r.gradient?1:0})},e.prototype._removeFactorGradient=function(t,i){if(!!t)for(var o=0,s=0,n=t;s<n.length;s++){var f=n[s];if(f.gradient===i){t.splice(o,1);break}o++}},e.prototype.addLifeTimeGradient=function(t,i,o){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,t,i,o),this},e.prototype.removeLifeTimeGradient=function(t){return this._removeFactorGradient(this._lifeTimeGradients,t),this},e.prototype.addSizeGradient=function(t,i,o){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,t,i,o),this},e.prototype.removeSizeGradient=function(t){return this._removeFactorGradient(this._sizeGradients,t),this},e.prototype.addColorRemapGradient=function(t,i,o){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,t,i,o),this},e.prototype.removeColorRemapGradient=function(t){return this._removeFactorGradient(this._colorRemapGradients,t),this},e.prototype.addAlphaRemapGradient=function(t,i,o){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,t,i,o),this},e.prototype.removeAlphaRemapGradient=function(t){return this._removeFactorGradient(this._alphaRemapGradients,t),this},e.prototype.addAngularSpeedGradient=function(t,i,o){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,t,i,o),this},e.prototype.removeAngularSpeedGradient=function(t){return this._removeFactorGradient(this._angularSpeedGradients,t),this},e.prototype.addVelocityGradient=function(t,i,o){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,t,i,o),this},e.prototype.removeVelocityGradient=function(t){return this._removeFactorGradient(this._velocityGradients,t),this},e.prototype.addLimitVelocityGradient=function(t,i,o){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,t,i,o),this},e.prototype.removeLimitVelocityGradient=function(t){return this._removeFactorGradient(this._limitVelocityGradients,t),this},e.prototype.addDragGradient=function(t,i,o){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,t,i,o),this},e.prototype.removeDragGradient=function(t){return this._removeFactorGradient(this._dragGradients,t),this},e.prototype.addEmitRateGradient=function(t,i,o){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,t,i,o),this},e.prototype.removeEmitRateGradient=function(t){return this._removeFactorGradient(this._emitRateGradients,t),this},e.prototype.addStartSizeGradient=function(t,i,o){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,t,i,o),this},e.prototype.removeStartSizeGradient=function(t){return this._removeFactorGradient(this._startSizeGradients,t),this},e.prototype._createRampGradientTexture=function(){if(!(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)){for(var t=new Uint8Array(this._rawTextureWidth*4),i=Ht.Color3[0],o=function(f){var r=f/s._rawTextureWidth;M.GetCurrentGradient(r,s._rampGradients,function(d,c,h){Gt.LerpToRef(d.color,c.color,h,i),t[f*4]=i.r*255,t[f*4+1]=i.g*255,t[f*4+2]=i.b*255,t[f*4+3]=255})},s=this,n=0;n<this._rawTextureWidth;n++)o(n);this._rampGradientsTexture=ee.CreateRGBATexture(t,this._rawTextureWidth,1,this._scene,!1,!1,1)}},e.prototype.getRampGradients=function(){return this._rampGradients},e.prototype.forceRefreshGradients=function(){this._syncRampGradientTexture()},e.prototype._syncRampGradientTexture=function(){!this._rampGradients||(this._rampGradients.sort(function(t,i){return t.gradient<i.gradient?-1:t.gradient>i.gradient?1:0}),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())},e.prototype.addRampGradient=function(t,i){this._rampGradients||(this._rampGradients=[]);var o=new jt(t,i);return this._rampGradients.push(o),this._syncRampGradientTexture(),this},e.prototype.removeRampGradient=function(t){return this._removeGradientAndTexture(t,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this},e.prototype.addColorGradient=function(t,i,o){this._colorGradients||(this._colorGradients=[]);var s=new qt(t,i,o);return this._colorGradients.push(s),this._colorGradients.sort(function(n,f){return n.gradient<f.gradient?-1:n.gradient>f.gradient?1:0}),this},e.prototype.removeColorGradient=function(t){if(!this._colorGradients)return this;for(var i=0,o=0,s=this._colorGradients;o<s.length;o++){var n=s[o];if(n.gradient===t){this._colorGradients.splice(i,1);break}i++}return this},e.prototype.resetDrawCache=function(){for(var t=0,i=this._drawWrappers;t<i.length;t++){var o=i[t];if(o)for(var s=0,n=o;s<n.length;s++){var f=n[s];f==null||f.dispose()}}this._drawWrappers=[]},e.prototype._fetchR=function(t,i,o,s,n){t=Math.abs(t)*.5+.5,i=Math.abs(i)*.5+.5;var f=t*o%o|0,r=i*s%s|0,d=(f+r*o)*4;return n[d]/255},e.prototype._reset=function(){this._resetEffect()},e.prototype._resetEffect=function(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()},e.prototype._createVertexBuffers=function(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),(!this._isBillboardBased||this.billboardMode===e.BILLBOARDMODE_STRETCHED)&&(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);var t=this._engine,i=this._vertexBufferSize*(this._useInstancing?1:4);this._vertexData=new Float32Array(this._capacity*i),this._vertexBuffer=new St(t,this._vertexData,!0,i);var o=0,s=this._vertexBuffer.createVertexBuffer(q.PositionKind,o,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[q.PositionKind]=s,o+=3;var n=this._vertexBuffer.createVertexBuffer(q.ColorKind,o,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[q.ColorKind]=n,o+=4;var f=this._vertexBuffer.createVertexBuffer("angle",o,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=f,o+=1;var r=this._vertexBuffer.createVertexBuffer("size",o,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=r,o+=2,this._isAnimationSheetEnabled){var d=this._vertexBuffer.createVertexBuffer("cellIndex",o,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=d,o+=1}if(!this._isBillboardBased||this.billboardMode===e.BILLBOARDMODE_STRETCHED){var c=this._vertexBuffer.createVertexBuffer("direction",o,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=c,o+=3}if(this._useRampGradients){var h=this._vertexBuffer.createVertexBuffer("remapData",o,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=h,o+=4}var _;if(this._useInstancing){var u=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new St(t,u,!1,2),_=this._spriteBuffer.createVertexBuffer("offset",0,2)}else _=this._vertexBuffer.createVertexBuffer("offset",o,2,this._vertexBufferSize,this._useInstancing),o+=2;this._vertexBuffers.offset=_,this.resetDrawCache()},e.prototype._createIndexBuffer=function(){if(!this._useInstancing){for(var t=[],i=0,o=0;o<this._capacity;o++)t.push(i),t.push(i+1),t.push(i+2),t.push(i),t.push(i+2),t.push(i+3),i+=4;this._indexBuffer=this._engine.createIndexBuffer(t)}},e.prototype.getCapacity=function(){return this._capacity},e.prototype.isAlive=function(){return this._alive},e.prototype.isStarted=function(){return this._started},e.prototype._prepareSubEmitterInternalArray=function(){var t=this;this._subEmitters=new Array,this.subEmitters&&this.subEmitters.forEach(function(i){i instanceof e?t._subEmitters.push([new ut(i)]):i instanceof ut?t._subEmitters.push([i]):i instanceof Array&&t._subEmitters.push(i)})},e.prototype.start=function(t){var i=this,o;if(t===void 0&&(t=this.startDelay),!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(t){setTimeout(function(){i.start(0)},t);return}if(this._prepareSubEmitterInternalArray(),this._started=!0,this._stopped=!1,this._actualFrame=0,this._subEmitters&&this._subEmitters.length!=0&&(this.activeSubSystems=new Array),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){((o=this.emitter)===null||o===void 0?void 0:o.getClassName().indexOf("Mesh"))!==-1&&this.emitter.computeWorldMatrix(!0);var s=this.noiseTexture;if(s&&s.onGeneratedObservable)s.onGeneratedObservable.addOnce(function(){setTimeout(function(){for(var f=0;f<i.preWarmCycles;f++)i.animate(!0),s.render()})});else for(var n=0;n<this.preWarmCycles;n++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)},e.prototype.stop=function(t){t===void 0&&(t=!0),!this._stopped&&(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,t&&this._stopSubEmitters())},e.prototype.reset=function(){this._stockParticles.length=0,this._particles.length=0},e.prototype._appendParticleVertex=function(t,i,o,s){var n=t*this._vertexBufferSize;if(this._vertexData[n++]=i.position.x+this.worldOffset.x,this._vertexData[n++]=i.position.y+this.worldOffset.y,this._vertexData[n++]=i.position.z+this.worldOffset.z,this._vertexData[n++]=i.color.r,this._vertexData[n++]=i.color.g,this._vertexData[n++]=i.color.b,this._vertexData[n++]=i.color.a,this._vertexData[n++]=i.angle,this._vertexData[n++]=i.scale.x*i.size,this._vertexData[n++]=i.scale.y*i.size,this._isAnimationSheetEnabled&&(this._vertexData[n++]=i.cellIndex),this._isBillboardBased)this.billboardMode===e.BILLBOARDMODE_STRETCHED&&(this._vertexData[n++]=i.direction.x,this._vertexData[n++]=i.direction.y,this._vertexData[n++]=i.direction.z);else if(i._initialDirection){var f=i._initialDirection;this.isLocal&&(p.TransformNormalToRef(f,this._emitterWorldMatrix,G.Vector3[0]),f=G.Vector3[0]),f.x===0&&f.z===0&&(f.x=.001),this._vertexData[n++]=f.x,this._vertexData[n++]=f.y,this._vertexData[n++]=f.z}else{var r=i.direction;this.isLocal&&(p.TransformNormalToRef(r,this._emitterWorldMatrix,G.Vector3[0]),r=G.Vector3[0]),r.x===0&&r.z===0&&(r.x=.001),this._vertexData[n++]=r.x,this._vertexData[n++]=r.y,this._vertexData[n++]=r.z}this._useRampGradients&&i.remapData&&(this._vertexData[n++]=i.remapData.x,this._vertexData[n++]=i.remapData.y,this._vertexData[n++]=i.remapData.z,this._vertexData[n++]=i.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(o===0?o=this._epsilon:o===1&&(o=1-this._epsilon),s===0?s=this._epsilon:s===1&&(s=1-this._epsilon)),this._vertexData[n++]=o,this._vertexData[n++]=s)},e.prototype._stopSubEmitters=function(){!this.activeSubSystems||(this.activeSubSystems.forEach(function(t){t.stop(!0)}),this.activeSubSystems=new Array)},e.prototype._removeFromRoot=function(){if(!!this._rootParticleSystem){var t=this._rootParticleSystem.activeSubSystems.indexOf(this);t!==-1&&this._rootParticleSystem.activeSubSystems.splice(t,1),this._rootParticleSystem=null}},e.prototype._update=function(t){var i=this;if(this._alive=this._particles.length>0,this.emitter.position){var o=this.emitter;this._emitterWorldMatrix=o.getWorldMatrix()}else{var s=this.emitter;this._emitterWorldMatrix=gt.Translation(s.x,s.y,s.z)}this._emitterWorldMatrix.invertToRef(this._emitterInverseWorldMatrix),this.updateFunction(this._particles);for(var n,f=function(h){if(r._particles.length===r._capacity)return"break";if(n=r._createParticle(),r._particles.push(n),r.targetStopDuration&&r._lifeTimeGradients&&r._lifeTimeGradients.length>0){var _=m.Clamp(r._actualFrame/r.targetStopDuration);M.GetCurrentGradient(_,r._lifeTimeGradients,function(x,l){var y=x,T=l,w=y.getFactor(),b=T.getFactor(),D=(_-y.gradient)/(T.gradient-y.gradient);n.lifeTime=m.Lerp(w,b,D)})}else n.lifeTime=m.RandomRange(r.minLifeTime,r.maxLifeTime);var u=m.RandomRange(r.minEmitPower,r.maxEmitPower);if(r.startPositionFunction?r.startPositionFunction(r._emitterWorldMatrix,n.position,n,r.isLocal):r.particleEmitterType.startPositionFunction(r._emitterWorldMatrix,n.position,n,r.isLocal),r.isLocal&&(n._localPosition?n._localPosition.copyFrom(n.position):n._localPosition=n.position.clone(),p.TransformCoordinatesToRef(n._localPosition,r._emitterWorldMatrix,n.position)),r.startDirectionFunction?r.startDirectionFunction(r._emitterWorldMatrix,n.direction,n,r.isLocal):r.particleEmitterType.startDirectionFunction(r._emitterWorldMatrix,n.direction,n,r.isLocal,r._emitterInverseWorldMatrix),u===0?n._initialDirection?n._initialDirection.copyFrom(n.direction):n._initialDirection=n.direction.clone():n._initialDirection=null,n.direction.scaleInPlace(u),!r._sizeGradients||r._sizeGradients.length===0?n.size=m.RandomRange(r.minSize,r.maxSize):(n._currentSizeGradient=r._sizeGradients[0],n._currentSize1=n._currentSizeGradient.getFactor(),n.size=n._currentSize1,r._sizeGradients.length>1?n._currentSize2=r._sizeGradients[1].getFactor():n._currentSize2=n._currentSize1),n.scale.copyFromFloats(m.RandomRange(r.minScaleX,r.maxScaleX),m.RandomRange(r.minScaleY,r.maxScaleY)),r._startSizeGradients&&r._startSizeGradients[0]&&r.targetStopDuration){var v=r._actualFrame/r.targetStopDuration;M.GetCurrentGradient(v,r._startSizeGradients,function(x,l,y){x!==i._currentStartSizeGradient&&(i._currentStartSize1=i._currentStartSize2,i._currentStartSize2=l.getFactor(),i._currentStartSizeGradient=x);var T=m.Lerp(i._currentStartSize1,i._currentStartSize2,y);n.scale.scaleInPlace(T)})}if(!r._angularSpeedGradients||r._angularSpeedGradients.length===0?n.angularSpeed=m.RandomRange(r.minAngularSpeed,r.maxAngularSpeed):(n._currentAngularSpeedGradient=r._angularSpeedGradients[0],n.angularSpeed=n._currentAngularSpeedGradient.getFactor(),n._currentAngularSpeed1=n.angularSpeed,r._angularSpeedGradients.length>1?n._currentAngularSpeed2=r._angularSpeedGradients[1].getFactor():n._currentAngularSpeed2=n._currentAngularSpeed1),n.angle=m.RandomRange(r.minInitialRotation,r.maxInitialRotation),r._velocityGradients&&r._velocityGradients.length>0&&(n._currentVelocityGradient=r._velocityGradients[0],n._currentVelocity1=n._currentVelocityGradient.getFactor(),r._velocityGradients.length>1?n._currentVelocity2=r._velocityGradients[1].getFactor():n._currentVelocity2=n._currentVelocity1),r._limitVelocityGradients&&r._limitVelocityGradients.length>0&&(n._currentLimitVelocityGradient=r._limitVelocityGradients[0],n._currentLimitVelocity1=n._currentLimitVelocityGradient.getFactor(),r._limitVelocityGradients.length>1?n._currentLimitVelocity2=r._limitVelocityGradients[1].getFactor():n._currentLimitVelocity2=n._currentLimitVelocity1),r._dragGradients&&r._dragGradients.length>0&&(n._currentDragGradient=r._dragGradients[0],n._currentDrag1=n._currentDragGradient.getFactor(),r._dragGradients.length>1?n._currentDrag2=r._dragGradients[1].getFactor():n._currentDrag2=n._currentDrag1),!r._colorGradients||r._colorGradients.length===0){var E=m.RandomRange(0,1);A.LerpToRef(r.color1,r.color2,E,n.color),r.colorDead.subtractToRef(n.color,r._colorDiff),r._colorDiff.scaleToRef(1/n.lifeTime,n.colorStep)}else n._currentColorGradient=r._colorGradients[0],n._currentColorGradient.getColorToRef(n.color),n._currentColor1.copyFrom(n.color),r._colorGradients.length>1?r._colorGradients[1].getColorToRef(n._currentColor2):n._currentColor2.copyFrom(n.color);r._isAnimationSheetEnabled&&(n._initialStartSpriteCellID=r.startSpriteCellID,n._initialEndSpriteCellID=r.endSpriteCellID,n._initialSpriteCellLoop=r.spriteCellLoop),n.direction.addInPlace(r._inheritedVelocityOffset),r._useRampGradients&&(n.remapData=new It(0,1,0,1)),r.noiseTexture&&(n._randomNoiseCoordinates1?(n._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),n._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(n._randomNoiseCoordinates1=new p(Math.random(),Math.random(),Math.random()),n._randomNoiseCoordinates2=new p(Math.random(),Math.random(),Math.random()))),n._inheritParticleInfoToSubEmitters()},r=this,d=0;d<t;d++){var c=f();if(c==="break")break}},e._GetAttributeNamesOrOptions=function(t,i,o){t===void 0&&(t=!1),i===void 0&&(i=!1),o===void 0&&(o=!1);var s=[q.PositionKind,q.ColorKind,"angle","offset","size"];return t&&s.push("cellIndex"),i||s.push("direction"),o&&s.push("remapData"),s},e._GetEffectCreationOptions=function(t){t===void 0&&(t=!1);var i=["invView","view","projection","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","textureMask","translationPivot","eyePosition"];return t&&i.push("particlesInfos"),i},e.prototype.fillDefines=function(t,i){if(this._scene&&(this._scene.clipPlane&&t.push("#define CLIPPLANE"),this._scene.clipPlane2&&t.push("#define CLIPPLANE2"),this._scene.clipPlane3&&t.push("#define CLIPPLANE3"),this._scene.clipPlane4&&t.push("#define CLIPPLANE4"),this._scene.clipPlane5&&t.push("#define CLIPPLANE5"),this._scene.clipPlane6&&t.push("#define CLIPPLANE6")),this._isAnimationSheetEnabled&&t.push("#define ANIMATESHEET"),i===e.BLENDMODE_MULTIPLY&&t.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&t.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(t.push("#define BILLBOARD"),this.billboardMode){case e.BILLBOARDMODE_Y:t.push("#define BILLBOARDY");break;case e.BILLBOARDMODE_STRETCHED:t.push("#define BILLBOARDSTRETCHED");break;case e.BILLBOARDMODE_ALL:t.push("#define BILLBOARDMODE_ALL");break}this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),t.push(this._imageProcessingConfigurationDefines.toString()))},e.prototype.fillUniformsAttributesAndSamplerNames=function(t,i,o){i.push.apply(i,e._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&this.billboardMode!==e.BILLBOARDMODE_STRETCHED,this._useRampGradients)),t.push.apply(t,e._GetEffectCreationOptions(this._isAnimationSheetEnabled)),o.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&(Pt.PrepareUniforms(t,this._imageProcessingConfigurationDefines),Pt.PrepareSamplers(o,this._imageProcessingConfigurationDefines))},e.prototype._getWrapper=function(t){var i=this._getCustomDrawWrapper(t);if(i!=null&&i.effect)return i;var o=[];this.fillDefines(o,t);var s=this._engine._features.supportRenderPasses?this._engine.currentRenderPassId:0,n=this._drawWrappers[s];n||(n=this._drawWrappers[s]=[]);var f=n[t];f||(f=new Et(this._engine),f.drawContext&&(f.drawContext.useInstancing=this._useInstancing),n[t]=f);var r=o.join(`
`);if(f.defines!==r){var d=[],c=[],h=[];this.fillUniformsAttributesAndSamplerNames(c,d,h),f.setEffect(this._engine.createEffect("particles",d,c,h,r),r)}return f},e.prototype.animate=function(t){var i=this,o;if(t===void 0&&(t=!1),!!this._started){if(!t&&this._scene){if(!this.isReady()||this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}this._scaledUpdateSpeed=this.updateSpeed*(t?this.preWarmStepOffset:((o=this._scene)===null||o===void 0?void 0:o.getAnimationRatio())||1);var s;if(this.manualEmitCount>-1)s=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{var n=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){var f=this._actualFrame/this.targetStopDuration;M.GetCurrentGradient(f,this._emitRateGradients,function(h,_,u){h!==i._currentEmitRateGradient&&(i._currentEmitRate1=i._currentEmitRate2,i._currentEmitRate2=_.getFactor(),i._currentEmitRateGradient=h),n=m.Lerp(i._currentEmitRate1,i._currentEmitRate2,u)})}s=n*this._scaledUpdateSpeed>>0,this._newPartsExcess+=n*this._scaledUpdateSpeed-s}if(this._newPartsExcess>1&&(s+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?s=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(s),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!t){for(var r=0,d=0;d<this._particles.length;d++){var c=this._particles[d];this._appendParticleVertices(r,c),r+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.updateDirectly(this._vertexData,0,this._particles.length)}this.manualEmitCount===0&&this.disposeOnStop&&this.stop()}},e.prototype._appendParticleVertices=function(t,i){this._appendParticleVertex(t++,i,0,0),this._useInstancing||(this._appendParticleVertex(t++,i,1,0),this._appendParticleVertex(t++,i,1,1),this._appendParticleVertex(t++,i,0,1))},e.prototype.rebuild=function(){var t,i;this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._createIndexBuffer(),(t=this._spriteBuffer)===null||t===void 0||t._rebuild(),(i=this._vertexBuffer)===null||i===void 0||i._rebuild();for(var o in this._vertexBuffers)this._vertexBuffers[o]._rebuild();this.resetDrawCache()},e.prototype.isReady=function(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==e.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(e.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(e.BLENDMODE_ADD).effect.isReady())return!1;return!0},e.prototype._render=function(t){var i,o,s=this._getWrapper(t),n=s.effect,f=this._engine;f.enableEffect(s);var r=(i=this.defaultViewMatrix)!==null&&i!==void 0?i:this._scene.getViewMatrix();if(n.setTexture("diffuseSampler",this.particleTexture),n.setMatrix("view",r),n.setMatrix("projection",(o=this.defaultProjectionMatrix)!==null&&o!==void 0?o:this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){var d=this.particleTexture.getBaseSize();n.setFloat3("particlesInfos",this.spriteCellWidth/d.width,this.spriteCellHeight/d.height,this.spriteCellWidth/d.width)}if(n.setVector2("translationPivot",this.translationPivot),n.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){var c=this._scene.activeCamera;n.setVector3("eyePosition",c.globalPosition)}this._rampGradientsTexture&&((!this._rampGradients||!this._rampGradients.length)&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),n.setTexture("rampSampler",this._rampGradientsTexture));var h=n.defines;switch(this._scene&&(this._scene.clipPlane||this._scene.clipPlane2||this._scene.clipPlane3||this._scene.clipPlane4||this._scene.clipPlane5||this._scene.clipPlane6)&&Jt.BindClipPlane(n,this._scene),h.indexOf("#define BILLBOARDMODE_ALL")>=0&&(r.invertToRef(G.Matrix[0]),n.setMatrix("invView",G.Matrix[0])),this._vertexArrayObject!==void 0?(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,n)),this._engine.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):f.bindBuffers(this._vertexBuffers,this._indexBuffer,n),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(n),t){case e.BLENDMODE_ADD:f.setAlphaMode(1);break;case e.BLENDMODE_ONEONE:f.setAlphaMode(6);break;case e.BLENDMODE_STANDARD:f.setAlphaMode(2);break;case e.BLENDMODE_MULTIPLY:f.setAlphaMode(4);break}return this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(n),this._useInstancing?f.drawArraysType(7,0,4,this._particles.length):f.drawElementsType(0,0,this._particles.length*6),this._particles.length},e.prototype.render=function(){if(!this.isReady()||!this._particles.length)return 0;var t=this._engine;t.setState&&(t.setState(!1),this.forceDepthWrite&&t.setDepthWrite(!0));var i=0;return this.blendMode===e.BLENDMODE_MULTIPLYADD?i=this._render(e.BLENDMODE_MULTIPLY)+this._render(e.BLENDMODE_ADD):i=this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),i},e.prototype.dispose=function(t){if(t===void 0&&(t=!0),this.resetDrawCache(),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),t&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),t&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._removeFromRoot(),this.subEmitters&&!this._subEmitters&&this._prepareSubEmitterInternalArray(),this._subEmitters&&this._subEmitters.length){for(var i=0;i<this._subEmitters.length;i++)for(var o=0,s=this._subEmitters[i];o<s.length;o++){var n=s[o];n.dispose()}this._subEmitters=[],this.subEmitters=[]}if(this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){var i=this._scene.particleSystems.indexOf(this);i>-1&&this._scene.particleSystems.splice(i,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.reset()},e.prototype.clone=function(t,i){var o=Yt({},this._customWrappers),s=null,n=this._engine;if(n.createEffectForParticles&&this.customShader!=null){s=this.customShader;var f=s.shaderOptions.defines.length>0?s.shaderOptions.defines.join(`
`):"",r=n.createEffectForParticles(s.shaderPath.fragmentElement,s.shaderOptions.uniforms,s.shaderOptions.samplers,f);o[0]?o[0].effect=r:this.setCustomEffect(r,0)}var d=this.serialize(),c=e.Parse(d,this._scene||this._engine,this._rootUrl);return c.name=t,c.customShader=s,c._customWrappers=o,i===void 0&&(i=this.emitter),this.noiseTexture&&(c.noiseTexture=this.noiseTexture.clone()),c.emitter=i,this.preventAutoStart||c.start(),c},e.prototype.serialize=function(t){t===void 0&&(t=!1);var i={};if(e._Serialize(i,this,t),i.textureMask=this.textureMask.asArray(),i.customShader=this.customShader,i.preventAutoStart=this.preventAutoStart,this.subEmitters){i.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(var o=0,s=this._subEmitters;o<s.length;o++){for(var n=s[o],f=[],r=0,d=n;r<d.length;r++){var c=d[r];f.push(c.serialize(t))}i.subEmitters.push(f)}}return i},e._Serialize=function(t,i,o){if(t.name=i.name,t.id=i.id,t.capacity=i.getCapacity(),t.disposeOnStop=i.disposeOnStop,t.manualEmitCount=i.manualEmitCount,i.emitter.position){var s=i.emitter;t.emitterId=s.id}else{var n=i.emitter;t.emitter=n.asArray()}i.particleEmitterType&&(t.particleEmitterType=i.particleEmitterType.serialize()),i.particleTexture&&(o?t.texture=i.particleTexture.serialize():(t.textureName=i.particleTexture.name,t.invertY=!!i.particleTexture._invertY)),t.isLocal=i.isLocal,Kt.AppendSerializedAnimations(i,t),t.beginAnimationOnStart=i.beginAnimationOnStart,t.beginAnimationFrom=i.beginAnimationFrom,t.beginAnimationTo=i.beginAnimationTo,t.beginAnimationLoop=i.beginAnimationLoop,t.startDelay=i.startDelay,t.renderingGroupId=i.renderingGroupId,t.isBillboardBased=i.isBillboardBased,t.billboardMode=i.billboardMode,t.minAngularSpeed=i.minAngularSpeed,t.maxAngularSpeed=i.maxAngularSpeed,t.minSize=i.minSize,t.maxSize=i.maxSize,t.minScaleX=i.minScaleX,t.maxScaleX=i.maxScaleX,t.minScaleY=i.minScaleY,t.maxScaleY=i.maxScaleY,t.minEmitPower=i.minEmitPower,t.maxEmitPower=i.maxEmitPower,t.minLifeTime=i.minLifeTime,t.maxLifeTime=i.maxLifeTime,t.emitRate=i.emitRate,t.gravity=i.gravity.asArray(),t.noiseStrength=i.noiseStrength.asArray(),t.color1=i.color1.asArray(),t.color2=i.color2.asArray(),t.colorDead=i.colorDead.asArray(),t.updateSpeed=i.updateSpeed,t.targetStopDuration=i.targetStopDuration,t.blendMode=i.blendMode,t.preWarmCycles=i.preWarmCycles,t.preWarmStepOffset=i.preWarmStepOffset,t.minInitialRotation=i.minInitialRotation,t.maxInitialRotation=i.maxInitialRotation,t.startSpriteCellID=i.startSpriteCellID,t.spriteCellLoop=i.spriteCellLoop,t.endSpriteCellID=i.endSpriteCellID,t.spriteCellChangeSpeed=i.spriteCellChangeSpeed,t.spriteCellWidth=i.spriteCellWidth,t.spriteCellHeight=i.spriteCellHeight,t.spriteRandomStartCell=i.spriteRandomStartCell,t.isAnimationSheetEnabled=i.isAnimationSheetEnabled;var f=i.getColorGradients();if(f){t.colorGradients=[];for(var r=0,d=f;r<d.length;r++){var c=d[r],h={gradient:c.gradient,color1:c.color1.asArray()};c.color2?h.color2=c.color2.asArray():h.color2=c.color1.asArray(),t.colorGradients.push(h)}}var _=i.getRampGradients();if(_){t.rampGradients=[];for(var u=0,v=_;u<v.length;u++){var E=v[u],h={gradient:E.gradient,color:E.color.asArray()};t.rampGradients.push(h)}t.useRampGradients=i.useRampGradients}var x=i.getColorRemapGradients();if(x){t.colorRemapGradients=[];for(var l=0,y=x;l<y.length;l++){var T=y[l],h={gradient:T.gradient,factor1:T.factor1};T.factor2!==void 0?h.factor2=T.factor2:h.factor2=T.factor1,t.colorRemapGradients.push(h)}}var w=i.getAlphaRemapGradients();if(w){t.alphaRemapGradients=[];for(var b=0,D=w;b<D.length;b++){var L=D[b],h={gradient:L.gradient,factor1:L.factor1};L.factor2!==void 0?h.factor2=L.factor2:h.factor2=L.factor1,t.alphaRemapGradients.push(h)}}var U=i.getSizeGradients();if(U){t.sizeGradients=[];for(var P=0,V=U;P<V.length;P++){var F=V[P],h={gradient:F.gradient,factor1:F.factor1};F.factor2!==void 0?h.factor2=F.factor2:h.factor2=F.factor1,t.sizeGradients.push(h)}}var B=i.getAngularSpeedGradients();if(B){t.angularSpeedGradients=[];for(var g=0,C=B;g<C.length;g++){var R=C[g],h={gradient:R.gradient,factor1:R.factor1};R.factor2!==void 0?h.factor2=R.factor2:h.factor2=R.factor1,t.angularSpeedGradients.push(h)}}var I=i.getVelocityGradients();if(I){t.velocityGradients=[];for(var N=0,Z=I;N<Z.length;N++){var W=Z[N],h={gradient:W.gradient,factor1:W.factor1};W.factor2!==void 0?h.factor2=W.factor2:h.factor2=W.factor1,t.velocityGradients.push(h)}}var nt=i.getDragGradients();if(nt){t.dragGradients=[];for(var X=0,tt=nt;X<tt.length;X++){var K=tt[X],h={gradient:K.gradient,factor1:K.factor1};K.factor2!==void 0?h.factor2=K.factor2:h.factor2=K.factor1,t.dragGradients.push(h)}}var $=i.getEmitRateGradients();if($){t.emitRateGradients=[];for(var j=0,ot=$;j<ot.length;j++){var z=ot[j],h={gradient:z.gradient,factor1:z.factor1};z.factor2!==void 0?h.factor2=z.factor2:h.factor2=z.factor1,t.emitRateGradients.push(h)}}var et=i.getStartSizeGradients();if(et){t.startSizeGradients=[];for(var it=0,J=et;it<J.length;it++){var H=J[it],h={gradient:H.gradient,factor1:H.factor1};H.factor2!==void 0?h.factor2=H.factor2:h.factor2=H.factor1,t.startSizeGradients.push(h)}}var at=i.getLifeTimeGradients();if(at){t.lifeTimeGradients=[];for(var k=0,ht=at;k<ht.length;k++){var S=ht[k],h={gradient:S.gradient,factor1:S.factor1};S.factor2!==void 0?h.factor2=S.factor2:h.factor2=S.factor1,t.lifeTimeGradients.push(h)}}var Ct=i.getLimitVelocityGradients();if(Ct){t.limitVelocityGradients=[];for(var vt=0,Dt=Ct;vt<Dt.length;vt++){var st=Dt[vt],h={gradient:st.gradient,factor1:st.factor1};st.factor2!==void 0?h.factor2=st.factor2:h.factor2=st.factor1,t.limitVelocityGradients.push(h)}t.limitVelocityDamping=i.limitVelocityDamping}i.noiseTexture&&(t.noiseTexture=i.noiseTexture.serialize())},e._Parse=function(t,i,o,s){var n,f,r,d;o instanceof O?d=null:d=o;var c=ft("BABYLON.Texture");if(c&&d&&(t.texture?i.particleTexture=c.Parse(t.texture,d,s):t.textureName&&(i.particleTexture=new c(s+t.textureName,d,!1,t.invertY!==void 0?t.invertY:!0),i.particleTexture.name=t.textureName)),!t.emitterId&&t.emitterId!==0&&t.emitter===void 0?i.emitter=p.Zero():t.emitterId&&d?i.emitter=d.getLastMeshById(t.emitterId):i.emitter=p.FromArray(t.emitter),i.isLocal=!!t.isLocal,t.renderingGroupId!==void 0&&(i.renderingGroupId=t.renderingGroupId),t.isBillboardBased!==void 0&&(i.isBillboardBased=t.isBillboardBased),t.billboardMode!==void 0&&(i.billboardMode=t.billboardMode),t.animations){for(var h=0;h<t.animations.length;h++){var _=t.animations[h],u=ft("BABYLON.Animation");u&&i.animations.push(u.Parse(_))}i.beginAnimationOnStart=t.beginAnimationOnStart,i.beginAnimationFrom=t.beginAnimationFrom,i.beginAnimationTo=t.beginAnimationTo,i.beginAnimationLoop=t.beginAnimationLoop}if(t.autoAnimate&&d&&d.beginAnimation(i,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),i.startDelay=t.startDelay|0,i.minAngularSpeed=t.minAngularSpeed,i.maxAngularSpeed=t.maxAngularSpeed,i.minSize=t.minSize,i.maxSize=t.maxSize,t.minScaleX&&(i.minScaleX=t.minScaleX,i.maxScaleX=t.maxScaleX,i.minScaleY=t.minScaleY,i.maxScaleY=t.maxScaleY),t.preWarmCycles!==void 0&&(i.preWarmCycles=t.preWarmCycles,i.preWarmStepOffset=t.preWarmStepOffset),t.minInitialRotation!==void 0&&(i.minInitialRotation=t.minInitialRotation,i.maxInitialRotation=t.maxInitialRotation),i.minLifeTime=t.minLifeTime,i.maxLifeTime=t.maxLifeTime,i.minEmitPower=t.minEmitPower,i.maxEmitPower=t.maxEmitPower,i.emitRate=t.emitRate,i.gravity=p.FromArray(t.gravity),t.noiseStrength&&(i.noiseStrength=p.FromArray(t.noiseStrength)),i.color1=A.FromArray(t.color1),i.color2=A.FromArray(t.color2),i.colorDead=A.FromArray(t.colorDead),i.updateSpeed=t.updateSpeed,i.targetStopDuration=t.targetStopDuration,i.blendMode=t.blendMode,t.colorGradients)for(var v=0,E=t.colorGradients;v<E.length;v++){var x=E[v];i.addColorGradient(x.gradient,A.FromArray(x.color1),x.color2?A.FromArray(x.color2):void 0)}if(t.rampGradients){for(var l=0,y=t.rampGradients;l<y.length;l++){var T=y[l];i.addRampGradient(T.gradient,Gt.FromArray(T.color))}i.useRampGradients=t.useRampGradients}if(t.colorRemapGradients)for(var w=0,b=t.colorRemapGradients;w<b.length;w++){var D=b[w];i.addColorRemapGradient(D.gradient,D.factor1!==void 0?D.factor1:D.factor,D.factor2)}if(t.alphaRemapGradients)for(var L=0,U=t.alphaRemapGradients;L<U.length;L++){var P=U[L];i.addAlphaRemapGradient(P.gradient,P.factor1!==void 0?P.factor1:P.factor,P.factor2)}if(t.sizeGradients)for(var V=0,F=t.sizeGradients;V<F.length;V++){var B=F[V];i.addSizeGradient(B.gradient,B.factor1!==void 0?B.factor1:B.factor,B.factor2)}if(t.angularSpeedGradients)for(var g=0,C=t.angularSpeedGradients;g<C.length;g++){var R=C[g];i.addAngularSpeedGradient(R.gradient,R.factor1!==void 0?R.factor1:R.factor,R.factor2)}if(t.velocityGradients)for(var I=0,N=t.velocityGradients;I<N.length;I++){var Z=N[I];i.addVelocityGradient(Z.gradient,Z.factor1!==void 0?Z.factor1:Z.factor,Z.factor2)}if(t.dragGradients)for(var W=0,nt=t.dragGradients;W<nt.length;W++){var X=nt[W];i.addDragGradient(X.gradient,X.factor1!==void 0?X.factor1:X.factor,X.factor2)}if(t.emitRateGradients)for(var tt=0,K=t.emitRateGradients;tt<K.length;tt++){var $=K[tt];i.addEmitRateGradient($.gradient,$.factor1!==void 0?$.factor1:$.factor,$.factor2)}if(t.startSizeGradients)for(var j=0,ot=t.startSizeGradients;j<ot.length;j++){var z=ot[j];i.addStartSizeGradient(z.gradient,z.factor1!==void 0?z.factor1:z.factor,z.factor2)}if(t.lifeTimeGradients)for(var et=0,it=t.lifeTimeGradients;et<it.length;et++){var J=it[et];i.addLifeTimeGradient(J.gradient,J.factor1!==void 0?J.factor1:J.factor,J.factor2)}if(t.limitVelocityGradients){for(var H=0,at=t.limitVelocityGradients;H<at.length;H++){var k=at[H];i.addLimitVelocityGradient(k.gradient,k.factor1!==void 0?k.factor1:k.factor,k.factor2)}i.limitVelocityDamping=t.limitVelocityDamping}if(t.noiseTexture&&d){var ht=ft("BABYLON.ProceduralTexture");i.noiseTexture=ht.Parse(t.noiseTexture,d,s)}var S;if(t.particleEmitterType){switch(t.particleEmitterType.type){case"SphereParticleEmitter":S=new Tt;break;case"SphereDirectedParticleEmitter":S=new Ot;break;case"ConeEmitter":case"ConeParticleEmitter":S=new Vt;break;case"CylinderParticleEmitter":S=new xt;break;case"CylinderDirectedParticleEmitter":S=new Nt;break;case"HemisphericParticleEmitter":S=new Mt;break;case"PointParticleEmitter":S=new zt;break;case"MeshParticleEmitter":S=new ie;break;case"BoxEmitter":case"BoxParticleEmitter":default:S=new ct;break}S.parse(t.particleEmitterType,d)}else S=new ct,S.parse(t,d);i.particleEmitterType=S,i.startSpriteCellID=t.startSpriteCellID,i.endSpriteCellID=t.endSpriteCellID,i.spriteCellLoop=(n=t.spriteCellLoop)!==null&&n!==void 0?n:!0,i.spriteCellWidth=t.spriteCellWidth,i.spriteCellHeight=t.spriteCellHeight,i.spriteCellChangeSpeed=t.spriteCellChangeSpeed,i.spriteRandomStartCell=t.spriteRandomStartCell,i.disposeOnStop=(f=t.disposeOnStop)!==null&&f!==void 0?f:!1,i.manualEmitCount=(r=t.manualEmitCount)!==null&&r!==void 0?r:-1},e.Parse=function(t,i,o,s,n){s===void 0&&(s=!1);var f=t.name,r=null,d=null,c,h;if(i instanceof O?c=i:(h=i,c=h.getEngine()),t.customShader&&c.createEffectForParticles){d=t.customShader;var _=d.shaderOptions.defines.length>0?d.shaderOptions.defines.join(`
`):"";r=c.createEffectForParticles(d.shaderPath.fragmentElement,d.shaderOptions.uniforms,d.shaderOptions.samplers,_)}var u=new e(f,n||t.capacity,i,r,t.isAnimationSheetEnabled);if(u.customShader=d,u._rootUrl=o,t.id&&(u.id=t.id),t.subEmitters){u.subEmitters=[];for(var v=0,E=t.subEmitters;v<E.length;v++){for(var x=E[v],l=[],y=0,T=x;y<T.length;y++){var w=T[y];l.push(ut.Parse(w,i,o))}u.subEmitters.push(l)}}return e._Parse(t,u,i,o),t.textureMask&&(u.textureMask=A.FromArray(t.textureMask)),t.preventAutoStart&&(u.preventAutoStart=t.preventAutoStart),!s&&!u.preventAutoStart&&u.start(),u},e.BILLBOARDMODE_Y=2,e.BILLBOARDMODE_ALL=7,e.BILLBOARDMODE_STRETCHED=8,e}(re);ut._ParseParticleSystem=Ut.Parse;const Q={Vector3:p,Texture:rt,ParticleSystem:Ut,Color4:A};class xe{constructor(e){At(this,"particleSystem");this.particleSystem=new Q.ParticleSystem("particles",2e3,e),this.particleSystem.particleTexture=new Q.Texture(Qt),this.particleSystem.createPointEmitter(new Q.Vector3(5,-5,5),new Q.Vector3(5,5,-5)),this.particleSystem.color1=new Q.Color4(1,0,0,1),this.particleSystem.color2=new Q.Color4(1.5,1.5,1.5,1),this.particleSystem.colorDead=new Q.Color4(1.5,1.5,1.5,.2),this.particleSystem.minSize=1,this.particleSystem.maxSize=1.5,this.particleSystem.minLifeTime=.3,this.particleSystem.maxLifeTime=.6,this.particleSystem.emitRate=200,this.particleSystem.targetStopDuration=.02,this.particleSystem.blendMode=Q.ParticleSystem.BLENDMODE_STANDARD,this.particleSystem.minEmitPower=2,this.particleSystem.maxEmitPower=2,this.particleSystem.updateSpeed=.01,this.particleSystem.addVelocityGradient(0,2),this.particleSystem.addVelocityGradient(.5,.5),this.particleSystem.addVelocityGradient(1,0)}}export{xe as default};
