import{C as _,a as v,M as y,d as M}from"./@babylonjscore_Maths.4b8bfdd1.js";import{b as P,d as A,M as I}from"./@babylonjscore_Materials.d4538583.js";import{V as f}from"./@babylonjscore_Buffers.c351261b.js";import{a as c,_ as Y}from"./@babylonjscore_Misc.5aaba58d.js";import{E as R}from"./@babylonjscore_Engines.77a493e8.js";import{R as z}from"./@babylonjscore_Culling.bdb6ff26.js";import"./@babylonjscore_Shaders.02c89b72.js";import{S as u}from"./@babylonjscore_sceneComponent.5f0854c6.js";import{A as p}from"./@babylonjscore_abstractScene.a7cd866f.js";var T=function(){function i(e,r,t,n,s){this.size=e,this.position=r,this.alphaMode=6,this.color=t||new _(1,1,1),this.texture=n?new P(n,s.getScene(),!0):null,this._system=s;var o=s.scene.getEngine();this._drawWrapper=new A(o),this._drawWrapper.effect=o.createEffect("lensFlare",[f.PositionKind],["color","viewportMatrix"],["textureSampler"],""),s.lensFlares.push(this)}return i.AddFlare=function(e,r,t,n,s){return new i(e,r,t,n,s)},i.prototype.dispose=function(){this.texture&&this.texture.dispose();var e=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(e,1)},i}(),S=function(){function i(e,r,t){this.name=e,this.lensFlares=new Array,this.borderLimit=300,this.viewportBorder=0,this.layerMask=268435455,this._vertexBuffers={},this._isEnabled=!0,this._scene=t||R.LastCreatedScene,i._SceneComponentInitialization(this._scene),this._emitter=r,this.id=e,t.lensFlareSystems.push(this),this.meshesSelectionPredicate=function(o){return t.activeCamera&&o.material&&o.isVisible&&o.isEnabled()&&o.isBlocker&&(o.layerMask&t.activeCamera.layerMask)!=0};var n=t.getEngine(),s=[];s.push(1,1),s.push(-1,1),s.push(-1,-1),s.push(1,-1),this._vertexBuffers[f.PositionKind]=new f(n,s,f.PositionKind,!1,!1,2),this._createIndexBuffer()}return Object.defineProperty(i.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),i.prototype._createIndexBuffer=function(){var e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)},Object.defineProperty(i.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this._isEnabled=e},enumerable:!1,configurable:!0}),i.prototype.getScene=function(){return this._scene},i.prototype.getEmitter=function(){return this._emitter},i.prototype.setEmitter=function(e){this._emitter=e},i.prototype.getEmitterPosition=function(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position},i.prototype.computeEffectivePosition=function(e){var r=this.getEmitterPosition();r=v.Project(r,y.Identity(),this._scene.getTransformMatrix(),e),this._positionX=r.x,this._positionY=r.y,r=v.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),this.viewportBorder>0&&(e.x-=this.viewportBorder,e.y-=this.viewportBorder,e.width+=this.viewportBorder*2,e.height+=this.viewportBorder*2,r.x+=this.viewportBorder,r.y+=this.viewportBorder,this._positionX+=this.viewportBorder,this._positionY+=this.viewportBorder);var t=this._scene.useRightHandedSystem,n=r.z>0&&!t||r.z<0&&t;return n?(this._positionX>e.x&&this._positionX<e.x+e.width&&this._positionY>e.y&&this._positionY<e.y+e.height,!0):!1},i.prototype._isVisible=function(){if(!this._isEnabled||!this._scene.activeCamera)return!1;var e=this.getEmitterPosition(),r=e.subtract(this._scene.activeCamera.globalPosition),t=r.length();r.normalize();var n=new z(this._scene.activeCamera.globalPosition,r),s=this._scene.pickWithRay(n,this.meshesSelectionPredicate,!0);return!s||!s.hit||s.distance>t},i.prototype.render=function(){if(!this._scene.activeCamera)return!1;var e=this._scene.getEngine(),r=this._scene.activeCamera.viewport,t=r.toGlobal(e.getRenderWidth(!0),e.getRenderHeight(!0));if(!this.computeEffectivePosition(t)||!this._isVisible())return!1;var n,s;this._positionX<this.borderLimit+t.x?n=this.borderLimit+t.x-this._positionX:this._positionX>t.x+t.width-this.borderLimit?n=this._positionX-t.x-t.width+this.borderLimit:n=0,this._positionY<this.borderLimit+t.y?s=this.borderLimit+t.y-this._positionY:this._positionY>t.y+t.height-this.borderLimit?s=this._positionY-t.y-t.height+this.borderLimit:s=0;var o=n>s?n:s;o-=this.viewportBorder,o>this.borderLimit&&(o=this.borderLimit);var h=1-M.Clamp(o/this.borderLimit,0,1);if(h<0)return!1;h>1&&(h=1),this.viewportBorder>0&&(t.x+=this.viewportBorder,t.y+=this.viewportBorder,t.width-=this.viewportBorder*2,t.height-=this.viewportBorder*2,this._positionX-=this.viewportBorder,this._positionY-=this.viewportBorder);var l=t.x+t.width/2,d=t.y+t.height/2,F=l-this._positionX,g=d-this._positionY;e.setState(!1),e.setDepthBuffer(!1);for(var m=0;m<this.lensFlares.length;m++){var a=this.lensFlares[m];if(!(!a._drawWrapper.effect.isReady()||a.texture&&!a.texture.isReady())){e.enableEffect(a._drawWrapper),e.bindBuffers(this._vertexBuffers,this._indexBuffer,a._drawWrapper.effect),e.setAlphaMode(a.alphaMode);var w=l-F*a.position,E=d-g*a.position,B=a.size,x=a.size*e.getAspectRatio(this._scene.activeCamera,!0),b=2*(w/(t.width+t.x*2))-1,L=1-2*(E/(t.height+t.y*2)),C=y.FromValues(B/2,0,0,0,0,x/2,0,0,0,0,1,0,b,L,0,1);a._drawWrapper.effect.setMatrix("viewportMatrix",C),a._drawWrapper.effect.setTexture("textureSampler",a.texture),a._drawWrapper.effect.setFloat4("color",a.color.r*h,a.color.g*h,a.color.b*h,1),e.drawElementsType(I.TriangleFillMode,0,6)}}return e.setDepthBuffer(!0),e.setAlphaMode(0),!0},i.prototype.rebuild=function(){var e;this._createIndexBuffer();for(var r in this._vertexBuffers)(e=this._vertexBuffers[r])===null||e===void 0||e._rebuild()},i.prototype.dispose=function(){var e=this._vertexBuffers[f.PositionKind];for(e&&(e.dispose(),this._vertexBuffers[f.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();var r=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(r,1)},i.Parse=function(e,r,t){var n=r.getLastEntryById(e.emitterId),s=e.name||"lensFlareSystem#"+e.emitterId,o=new i(s,n,r);o.id=e.id||s,o.borderLimit=e.borderLimit;for(var h=0;h<e.flares.length;h++){var l=e.flares[h];T.AddFlare(l.size,l.position,_.FromArray(l.color),l.textureName?t+l.textureName:"",o)}return o},i.prototype.serialize=function(){var e={};e.id=this.id,e.name=this.name,e.emitterId=this.getEmitter().id,e.borderLimit=this.borderLimit,e.flares=[];for(var r=0;r<this.lensFlares.length;r++){var t=this.lensFlares[r];e.flares.push({size:t.size,position:t.position,color:t.color.asArray(),textureName:c.GetFilename(t.texture?t.texture.name:"")})}return e},i._SceneComponentInitialization=function(e){throw Y("LensFlareSystemSceneComponent")},i}();p.AddParser(u.NAME_LENSFLARESYSTEM,function(i,e,r,t){if(i.lensFlareSystems!==void 0&&i.lensFlareSystems!==null){r.lensFlareSystems||(r.lensFlareSystems=new Array);for(var n=0,s=i.lensFlareSystems.length;n<s;n++){var o=i.lensFlareSystems[n],h=S.Parse(o,e,t);r.lensFlareSystems.push(h)}}});p.prototype.getLensFlareSystemByName=function(i){for(var e=0;e<this.lensFlareSystems.length;e++)if(this.lensFlareSystems[e].name===i)return this.lensFlareSystems[e];return null};p.prototype.getLensFlareSystemById=function(i){for(var e=0;e<this.lensFlareSystems.length;e++)if(this.lensFlareSystems[e].id===i)return this.lensFlareSystems[e];return null};p.prototype.getLensFlareSystemByID=function(i){return this.getLensFlareSystemById(i)};p.prototype.removeLensFlareSystem=function(i){var e=this.lensFlareSystems.indexOf(i);return e!==-1&&this.lensFlareSystems.splice(e,1),e};p.prototype.addLensFlareSystem=function(i){this.lensFlareSystems.push(i)};var W=function(){function i(e){this.name=u.NAME_LENSFLARESYSTEM,this.scene=e,e.lensFlareSystems=new Array}return i.prototype.register=function(){this.scene._afterCameraDrawStage.registerStep(u.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM,this,this._draw)},i.prototype.rebuild=function(){for(var e=0;e<this.scene.lensFlareSystems.length;e++)this.scene.lensFlareSystems[e].rebuild()},i.prototype.addFromContainer=function(e){var r=this;!e.lensFlareSystems||e.lensFlareSystems.forEach(function(t){r.scene.addLensFlareSystem(t)})},i.prototype.removeFromContainer=function(e,r){var t=this;!e.lensFlareSystems||e.lensFlareSystems.forEach(function(n){t.scene.removeLensFlareSystem(n),r&&n.dispose()})},i.prototype.serialize=function(e){e.lensFlareSystems=[];for(var r=this.scene.lensFlareSystems,t=0,n=r;t<n.length;t++){var s=n[t];e.lensFlareSystems.push(s.serialize())}},i.prototype.dispose=function(){for(var e=this.scene.lensFlareSystems;e.length;)e[0].dispose()},i.prototype._draw=function(e){if(this.scene.lensFlaresEnabled){var r=this.scene.lensFlareSystems;c.StartPerformanceCounter("Lens flares",r.length>0);for(var t=0,n=r;t<n.length;t++){var s=n[t];(e.layerMask&s.layerMask)!==0&&s.render()}c.EndPerformanceCounter("Lens flares",r.length>0)}},i}();S._SceneComponentInitialization=function(i){var e=i._getComponent(u.NAME_LENSFLARESYSTEM);e||(e=new W(i),i._addComponent(e))};
