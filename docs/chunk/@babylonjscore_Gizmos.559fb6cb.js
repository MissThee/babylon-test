import{_ as V}from"./tslibtslib.b6e59fa7.js";import{O as S,c as W,L as Y}from"./@babylonjscore_Misc.5aaba58d.js";import{a as l,Q as x,M as F,C as m,E as ee}from"./@babylonjscore_Maths.4b8bfdd1.js";import{M as R,T as ae,c as H,h as J,A as k,f as E,d as ie,b as ce,C as me,i as ue,j as fe}from"./@babylonjscore_Meshes.9ddea1c8.js";import{P as U,S as ge}from"./@babylonjscore_Behaviors.d1e74062.js";import{U as N}from"./@babylonjscore_Rendering.1459be29.js";import{P as K}from"./@babylonjscore_Events.25582a49.js";import{L as se,H as ve,D as Me,S as be}from"./@babylonjscore_Lights.894f8849.js";import{S as D,E as _e,c as ye}from"./@babylonjscore_Materials.d4538583.js";var b=function(){function d(s){s===void 0&&(s=N.DefaultUtilityLayer);var e=this;this.gizmoLayer=s,this._attachedMesh=null,this._attachedNode=null,this._customRotationQuaternion=null,this._scaleRatio=1,this._isHovered=!1,this._customMeshSet=!1,this._updateGizmoRotationToMatchAttachedMesh=!0,this.updateGizmoPositionToMatchAttachedMesh=!0,this.updateScale=!0,this._interactionsEnabled=!0,this._tempQuaternion=new x(0,0,0,1),this._tempVector=new l,this._tempVector2=new l,this._tempMatrix1=new F,this._tempMatrix2=new F,this._rightHandtoLeftHandMatrix=F.RotationY(Math.PI),this._rootMesh=new R("gizmoRootNode",s.utilityLayerScene),this._rootMesh.rotationQuaternion=x.Identity(),this._beforeRenderObserver=this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.add(function(){e._update()})}return Object.defineProperty(d.prototype,"scaleRatio",{get:function(){return this._scaleRatio},set:function(s){this._scaleRatio=s},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"isHovered",{get:function(){return this._isHovered},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"attachedMesh",{get:function(){return this._attachedMesh},set:function(s){this._attachedMesh=s,s&&(this._attachedNode=s),this._rootMesh.setEnabled(!!s),this._attachedNodeChanged(s)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"attachedNode",{get:function(){return this._attachedNode},set:function(s){this._attachedNode=s,this._attachedMesh=null,this._rootMesh.setEnabled(!!s),this._attachedNodeChanged(s)},enumerable:!1,configurable:!0}),d.prototype.setCustomMesh=function(s){if(s.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this._rootMesh.getChildMeshes().forEach(function(e){e.dispose()}),s.parent=this._rootMesh,this._customMeshSet=!0},Object.defineProperty(d.prototype,"updateGizmoRotationToMatchAttachedMesh",{get:function(){return this._updateGizmoRotationToMatchAttachedMesh},set:function(s){this._updateGizmoRotationToMatchAttachedMesh=s},enumerable:!1,configurable:!0}),d.prototype._attachedNodeChanged=function(s){},Object.defineProperty(d.prototype,"customRotationQuaternion",{get:function(){return this._customRotationQuaternion},set:function(s){this._customRotationQuaternion=s},enumerable:!1,configurable:!0}),d.prototype._update=function(){if(this.attachedNode){var s=this.attachedNode;if(this.attachedMesh&&(s=this.attachedMesh||this.attachedNode),this.updateGizmoPositionToMatchAttachedMesh){var e=s.getWorldMatrix().getRow(3),i=e?e.toVector3():new l(0,0,0);this._rootMesh.position.copyFrom(i)}if(this.updateGizmoRotationToMatchAttachedMesh){var t=s._isMesh||s.getClassName()==="AbstractMesh"||s.getClassName()==="TransformNode"||s.getClassName()==="InstancedMesh",o=t?s:void 0;s.getWorldMatrix().decompose(void 0,this._rootMesh.rotationQuaternion,void 0,d.PreserveScaling?o:void 0)}else this._customRotationQuaternion?this._rootMesh.rotationQuaternion.copyFrom(this._customRotationQuaternion):this._rootMesh.rotationQuaternion.set(0,0,0,1);if(this.updateScale){var n=this.gizmoLayer.utilityLayerScene.activeCamera,a=n.globalPosition;n.devicePosition&&(a=n.devicePosition),this._rootMesh.position.subtractToRef(a,this._tempVector);var h=this._tempVector.length()*this.scaleRatio;this._rootMesh.scaling.set(h,h,h),s._getWorldMatrixDeterminant()<0&&!d.PreserveScaling&&(this._rootMesh.scaling.y*=-1)}else this._rootMesh.scaling.setAll(this.scaleRatio)}},d.prototype._handlePivot=function(){var s=this._attachedNode;s.isUsingPivotMatrix&&s.isUsingPivotMatrix()&&s.position&&s.getWorldMatrix().setTranslation(s.position)},d.prototype._matrixChanged=function(){if(!!this._attachedNode)if(this._attachedNode._isCamera){var s=this._attachedNode,e=void 0,i=void 0;if(s.parent){var t=this._tempMatrix2;s.parent._worldMatrix.invertToRef(t),this._attachedNode._worldMatrix.multiplyToRef(t,this._tempMatrix1),e=this._tempMatrix1}else e=this._attachedNode._worldMatrix;s.getScene().useRightHandedSystem?(this._rightHandtoLeftHandMatrix.multiplyToRef(e,this._tempMatrix2),i=this._tempMatrix2):i=e,i.decompose(this._tempVector2,this._tempQuaternion,this._tempVector);var o=this._attachedNode.getClassName()==="FreeCamera"||this._attachedNode.getClassName()==="FlyCamera"||this._attachedNode.getClassName()==="ArcFollowCamera"||this._attachedNode.getClassName()==="TargetCamera"||this._attachedNode.getClassName()==="TouchCamera"||this._attachedNode.getClassName()==="UniversalCamera";if(o){var n=this._attachedNode;n.rotation=this._tempQuaternion.toEulerAngles(),n.rotationQuaternion&&(n.rotationQuaternion.copyFrom(this._tempQuaternion),n.rotationQuaternion.normalize())}s.position.copyFrom(this._tempVector)}else if(this._attachedNode._isMesh||this._attachedNode.getClassName()==="AbstractMesh"||this._attachedNode.getClassName()==="TransformNode"||this._attachedNode.getClassName()==="InstancedMesh"){var a=this._attachedNode;if(a.parent){var t=this._tempMatrix1,h=this._tempMatrix2;a.parent.getWorldMatrix().invertToRef(t),this._attachedNode.getWorldMatrix().multiplyToRef(t,h),h.decompose(this._tempVector,this._tempQuaternion,a.position,d.PreserveScaling?a:void 0)}else this._attachedNode._worldMatrix.decompose(this._tempVector,this._tempQuaternion,a.position,d.PreserveScaling?a:void 0);a.scaling.copyFrom(this._tempVector),a.billboardMode||(a.rotationQuaternion?(a.rotationQuaternion.copyFrom(this._tempQuaternion),a.rotationQuaternion.normalize()):a.rotation=this._tempQuaternion.toEulerAngles())}else if(this._attachedNode.getClassName()==="Bone"){var r=this._attachedNode,p=r.getParent();if(p){var f=this._tempMatrix1,g=this._tempMatrix2;p.getWorldMatrix().invertToRef(f),r.getWorldMatrix().multiplyToRef(f,g);var _=r.getLocalMatrix();_.copyFrom(g)}else{var _=r.getLocalMatrix();_.copyFrom(r.getWorldMatrix())}r.markAsDirty()}else{var c=this._attachedNode;if(c.getTypeID){var M=c.getTypeID();if(M===se.LIGHTTYPEID_DIRECTIONALLIGHT||M===se.LIGHTTYPEID_SPOTLIGHT||M===se.LIGHTTYPEID_POINTLIGHT){var v=c.parent;if(v){var f=this._tempMatrix1,u=this._tempMatrix2;v.getWorldMatrix().invertToRef(f),c.getWorldMatrix().multiplyToRef(f,u),u.decompose(void 0,this._tempQuaternion,this._tempVector)}else this._attachedNode._worldMatrix.decompose(void 0,this._tempQuaternion,this._tempVector);c.position=new l(this._tempVector.x,this._tempVector.y,this._tempVector.z),c.direction&&(c.direction=new l(c.direction.x,c.direction.y,c.direction.z))}}}},d.prototype._setGizmoMeshMaterial=function(s,e){s&&s.forEach(function(i){i.material=e,i.color&&(i.color=e.diffuseColor)})},d.GizmoAxisPointerObserver=function(s,e){var i=!1,t=s.utilityLayerScene.onPointerObservable.add(function(o){var n,a;if(o.pickInfo){if(o.type===K.POINTERMOVE){if(i)return;e.forEach(function(r){var p,f;if(r.colliderMeshes&&r.gizmoMeshes){var g=((p=r.colliderMeshes)===null||p===void 0?void 0:p.indexOf((f=o==null?void 0:o.pickInfo)===null||f===void 0?void 0:f.pickedMesh))!=-1,_=r.dragBehavior.enabled?g||r.active?r.hoverMaterial:r.material:r.disableMaterial;r.gizmoMeshes.forEach(function(c){c.material=_,c.color&&(c.color=_.diffuseColor)})}})}if(o.type===K.POINTERDOWN&&e.has((n=o.pickInfo.pickedMesh)===null||n===void 0?void 0:n.parent)){i=!0;var h=e.get((a=o.pickInfo.pickedMesh)===null||a===void 0?void 0:a.parent);h.active=!0,e.forEach(function(r){var p,f,g=((p=r.colliderMeshes)===null||p===void 0?void 0:p.indexOf((f=o==null?void 0:o.pickInfo)===null||f===void 0?void 0:f.pickedMesh))!=-1,_=(g||r.active)&&r.dragBehavior.enabled?r.hoverMaterial:r.disableMaterial;r.gizmoMeshes.forEach(function(c){c.material=_,c.color&&(c.color=_.diffuseColor)})})}o.type===K.POINTERUP&&e.forEach(function(r){r.active=!1,i=!1,r.gizmoMeshes.forEach(function(p){p.material=r.dragBehavior.enabled?r.material:r.disableMaterial,p.color&&(p.color=r.material.diffuseColor)})})}});return t},d.prototype.dispose=function(){this._rootMesh.dispose(),this._beforeRenderObserver&&this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.remove(this._beforeRenderObserver)},d.PreserveScaling=!1,d}(),ne=function(d){V(s,d);function s(e,i,t,o,n){i===void 0&&(i=m.Gray()),t===void 0&&(t=N.DefaultUtilityLayer),o===void 0&&(o=null),n===void 0&&(n=1);var a=this,h;a=d.call(this,t)||this,a._pointerObserver=null,a.snapDistance=0,a.onSnapObservable=new S,a._isEnabled=!0,a._parent=null,a._dragging=!1,a._parent=o,a._coloredMaterial=new D("",t.utilityLayerScene),a._coloredMaterial.diffuseColor=i,a._coloredMaterial.specularColor=i.subtract(new m(.1,.1,.1)),a._hoverMaterial=new D("",t.utilityLayerScene),a._hoverMaterial.diffuseColor=m.Yellow(),a._disableMaterial=new D("",t.utilityLayerScene),a._disableMaterial.diffuseColor=m.Gray(),a._disableMaterial.alpha=.4;var r=s._CreateArrow(t.utilityLayerScene,a._coloredMaterial,n),p=s._CreateArrow(t.utilityLayerScene,a._coloredMaterial,n+4,!0);a._gizmoMesh=new R("",t.utilityLayerScene),a._gizmoMesh.addChild(r),a._gizmoMesh.addChild(p),a._gizmoMesh.lookAt(a._rootMesh.position.add(e)),a._gizmoMesh.scaling.scaleInPlace(1/3),a._gizmoMesh.parent=a._rootMesh;var f=0,g=new l,_=new l,c={snapDistance:0};a.dragBehavior=new U({dragAxis:e}),a.dragBehavior.moveAttached=!1,a.dragBehavior.updateDragPlane=!1,a._rootMesh.addBehavior(a.dragBehavior),a.dragBehavior.onDragObservable.add(function(u){if(a.attachedNode){a._handlePivot();var P=!1;if(a.snapDistance==0)a.attachedNode.getWorldMatrix().getTranslationToRef(_),_.addInPlace(u.delta),a.dragBehavior.validateDrag(_)&&(a.attachedNode.position&&a.attachedNode.position.addInPlaceFromFloats(u.delta.x,u.delta.y,u.delta.z),a.attachedNode.getWorldMatrix().addTranslationFromFloats(u.delta.x,u.delta.y,u.delta.z),a.attachedNode.updateCache(),P=!0);else if(f+=u.dragDistance,Math.abs(f)>a.snapDistance){var y=Math.floor(Math.abs(f)/a.snapDistance);f=f%a.snapDistance,u.delta.normalizeToRef(g),g.scaleInPlace(a.snapDistance*y),a.attachedNode.getWorldMatrix().getTranslationToRef(_),_.addInPlace(g),a.dragBehavior.validateDrag(_)&&(a.attachedNode.getWorldMatrix().addTranslationFromFloats(g.x,g.y,g.z),a.attachedNode.updateCache(),c.snapDistance=a.snapDistance*y,a.onSnapObservable.notifyObservers(c),P=!0)}P&&a._matrixChanged()}}),a.dragBehavior.onDragStartObservable.add(function(){a._dragging=!0}),a.dragBehavior.onDragEndObservable.add(function(){a._dragging=!1});var M=t._getSharedGizmoLight();M.includedOnlyMeshes=M.includedOnlyMeshes.concat(a._rootMesh.getChildMeshes(!1));var v={gizmoMeshes:r.getChildMeshes(),colliderMeshes:p.getChildMeshes(),material:a._coloredMaterial,hoverMaterial:a._hoverMaterial,disableMaterial:a._disableMaterial,active:!1,dragBehavior:a.dragBehavior};return(h=a._parent)===null||h===void 0||h.addToAxisCache(p,v),a._pointerObserver=t.utilityLayerScene.onPointerObservable.add(function(u){var P;if(!a._customMeshSet&&(a._isHovered=v.colliderMeshes.indexOf((P=u==null?void 0:u.pickInfo)===null||P===void 0?void 0:P.pickedMesh)!=-1,!a._parent)){var y=a.dragBehavior.enabled?a._isHovered||a._dragging?a._hoverMaterial:a._coloredMaterial:a._disableMaterial;a._setGizmoMeshMaterial(v.gizmoMeshes,y)}}),a.dragBehavior.onEnabledObservable.add(function(u){a._setGizmoMeshMaterial(v.gizmoMeshes,u?v.material:v.disableMaterial)}),a}return s._CreateArrow=function(e,i,t,o){t===void 0&&(t=1),o===void 0&&(o=!1);var n=new ae("arrow",e),a=H("cylinder",{diameterTop:0,height:.075,diameterBottom:.0375*(1+(t-1)/4),tessellation:96},e),h=H("cylinder",{diameterTop:.005*t,height:.275,diameterBottom:.005*t,tessellation:96},e);return a.parent=n,a.material=i,a.rotation.x=Math.PI/2,a.position.z+=.3,h.parent=n,h.material=i,h.position.z+=.275/2,h.rotation.x=Math.PI/2,o&&(h.visibility=0,a.visibility=0),n},s._CreateArrowInstance=function(e,i){for(var t=new ae("arrow",e),o=0,n=i.getChildMeshes();o<n.length;o++){var a=n[o],h=a.createInstance(a.name);h.parent=t}return t},s.prototype._attachedNodeChanged=function(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)},Object.defineProperty(s.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)},enumerable:!1,configurable:!0}),s.prototype.dispose=function(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(function(e){e&&e.dispose()}),d.prototype.dispose.call(this)},s}(b),te=function(d){V(s,d);function s(e,i,t,o,n){i===void 0&&(i=m.Gray()),t===void 0&&(t=N.DefaultUtilityLayer),o===void 0&&(o=null),n===void 0&&(n=1);var a=this,h,r,p,f,g,_,c;a=d.call(this,t)||this,a._pointerObserver=null,a.snapDistance=0,a.onSnapObservable=new S,a.uniformScaling=!1,a.sensitivity=1,a.dragScale=1,a._isEnabled=!0,a._parent=null,a._dragging=!1,a._tmpVector=new l,a._tmpMatrix=new F,a._tmpMatrix2=new F,a._parent=o,a._coloredMaterial=new D("",t.utilityLayerScene),a._coloredMaterial.diffuseColor=i,a._coloredMaterial.specularColor=i.subtract(new m(.1,.1,.1)),a._hoverMaterial=new D("",t.utilityLayerScene),a._hoverMaterial.diffuseColor=m.Yellow(),a._disableMaterial=new D("",t.utilityLayerScene),a._disableMaterial.diffuseColor=m.Gray(),a._disableMaterial.alpha=.4,a._gizmoMesh=new R("axis",t.utilityLayerScene);var M=a._createGizmoMesh(a._gizmoMesh,n),v=M.arrowMesh,u=M.arrowTail,P=a._createGizmoMesh(a._gizmoMesh,n+4,!0);a._gizmoMesh.lookAt(a._rootMesh.position.add(e)),a._rootMesh.addChild(a._gizmoMesh,b.PreserveScaling),a._gizmoMesh.scaling.scaleInPlace(1/3);var y=v.position.clone(),T=u.position.clone(),w=u.scaling.clone(),I=function(B){var A=B*(3/a._rootMesh.scaling.length())*6;v.position.z+=A/3.5,u.scaling.y+=A,a.dragScale=u.scaling.y,u.position.z=v.position.z/2},G=function(){v.position.set(y.x,y.y,y.z),u.position.set(T.x,T.y,T.z),u.scaling.set(w.x,w.y,w.z),a.dragScale=u.scaling.y,a._dragging=!1};a.dragBehavior=new U({dragAxis:e}),a.dragBehavior.moveAttached=!1,a.dragBehavior.updateDragPlane=!1,a._rootMesh.addBehavior(a.dragBehavior);var z=0,O=new l,L={snapDistance:0};a.dragBehavior.onDragObservable.add(function(B){if(a.attachedNode){a._handlePivot();var A=a.sensitivity*B.dragDistance*(a.scaleRatio*3/a._rootMesh.scaling.length()),j=!1,C=0;a.uniformScaling?O.setAll(.57735):O.copyFrom(e),a.snapDistance==0?O.scaleToRef(A,O):(z+=A,Math.abs(z)>a.snapDistance?(C=Math.floor(Math.abs(z)/a.snapDistance),z<0&&(C*=-1),z=z%a.snapDistance,O.scaleToRef(a.snapDistance*C,O),j=!0):O.scaleInPlace(0)),F.ScalingToRef(1+O.x,1+O.y,1+O.z,a._tmpMatrix2),a._tmpMatrix2.multiplyToRef(a.attachedNode.getWorldMatrix(),a._tmpMatrix);var X=a.attachedNode._isMesh?a.attachedNode:void 0;a._tmpMatrix.decompose(a._tmpVector,void 0,void 0,b.PreserveScaling?X:void 0);var Z=1e5;Math.abs(a._tmpVector.x)<Z&&Math.abs(a._tmpVector.y)<Z&&Math.abs(a._tmpVector.z)<Z&&a.attachedNode.getWorldMatrix().copyFrom(a._tmpMatrix),j&&(L.snapDistance=a.snapDistance*C,a.onSnapObservable.notifyObservers(L)),a._matrixChanged()}}),a.dragBehavior.onDragStartObservable.add(function(){a._dragging=!0}),a.dragBehavior.onDragObservable.add(function(B){return I(B.dragDistance)}),a.dragBehavior.onDragEndObservable.add(G),(p=(r=(h=o==null?void 0:o.uniformScaleGizmo)===null||h===void 0?void 0:h.dragBehavior)===null||r===void 0?void 0:r.onDragObservable)===null||p===void 0||p.add(function(B){return I(B.delta.y)}),(_=(g=(f=o==null?void 0:o.uniformScaleGizmo)===null||f===void 0?void 0:f.dragBehavior)===null||g===void 0?void 0:g.onDragEndObservable)===null||_===void 0||_.add(G);var Q={gizmoMeshes:[v,u],colliderMeshes:[P.arrowMesh,P.arrowTail],material:a._coloredMaterial,hoverMaterial:a._hoverMaterial,disableMaterial:a._disableMaterial,active:!1,dragBehavior:a.dragBehavior};(c=a._parent)===null||c===void 0||c.addToAxisCache(a._gizmoMesh,Q),a._pointerObserver=t.utilityLayerScene.onPointerObservable.add(function(B){var A;if(!a._customMeshSet&&(a._isHovered=Q.colliderMeshes.indexOf((A=B==null?void 0:B.pickInfo)===null||A===void 0?void 0:A.pickedMesh)!=-1,!a._parent)){var j=a.dragBehavior.enabled?a._isHovered||a._dragging?a._hoverMaterial:a._coloredMaterial:a._disableMaterial;a._setGizmoMeshMaterial(Q.gizmoMeshes,j)}}),a.dragBehavior.onEnabledObservable.add(function(B){a._setGizmoMeshMaterial(Q.gizmoMeshes,B?a._coloredMaterial:a._disableMaterial)});var q=t._getSharedGizmoLight();return q.includedOnlyMeshes=q.includedOnlyMeshes.concat(a._rootMesh.getChildMeshes()),a}return s.prototype._createGizmoMesh=function(e,i,t){t===void 0&&(t=!1);var o=J("yPosMesh",{size:.4*(1+(i-1)/4)},this.gizmoLayer.utilityLayerScene),n=H("cylinder",{diameterTop:.005*i,height:.275,diameterBottom:.005*i,tessellation:96},this.gizmoLayer.utilityLayerScene);return o.scaling.scaleInPlace(.1),o.material=this._coloredMaterial,o.rotation.x=Math.PI/2,o.position.z+=.3,n.material=this._coloredMaterial,n.position.z+=.275/2,n.rotation.x=Math.PI/2,t&&(o.visibility=0,n.visibility=0),e.addChild(o),e.addChild(n),{arrowMesh:o,arrowTail:n}},s.prototype._attachedNodeChanged=function(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)},Object.defineProperty(s.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)},enumerable:!1,configurable:!0}),s.prototype.dispose=function(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(function(e){e&&e.dispose()}),d.prototype.dispose.call(this)},s.prototype.setCustomMesh=function(e,i){var t=this;i===void 0&&(i=!1),d.prototype.setCustomMesh.call(this,e),i&&(this._rootMesh.getChildMeshes().forEach(function(o){o.material=t._coloredMaterial,o.color&&(o.color=t._coloredMaterial.diffuseColor)}),this._customMeshSet=!1)},s}(b),ze=function(d){V(s,d);function s(e,i){e===void 0&&(e=m.Gray()),i===void 0&&(i=N.DefaultKeepDepthUtilityLayer);var t=d.call(this,i)||this;t._boundingDimensions=new l(1,1,1),t._renderObserver=null,t._pointerObserver=null,t._scaleDragSpeed=.2,t._tmpQuaternion=new x,t._tmpVector=new l(0,0,0),t._tmpRotationMatrix=new F,t.ignoreChildren=!1,t.includeChildPredicate=null,t.rotationSphereSize=.1,t.scaleBoxSize=.1,t.fixedDragMeshScreenSize=!1,t.fixedDragMeshBoundsSize=!1,t.fixedDragMeshScreenSizeDistanceFactor=10,t.onDragStartObservable=new S,t.onScaleBoxDragObservable=new S,t.onScaleBoxDragEndObservable=new S,t.onRotationSphereDragObservable=new S,t.onRotationSphereDragEndObservable=new S,t.scalePivot=null,t._axisFactor=new l(1,1,1),t._existingMeshScale=new l,t._dragMesh=null,t._pointerDragBehavior=new U,t.updateScale=!1,t._anchorMesh=new k("anchor",i.utilityLayerScene),t._coloredMaterial=new D("",i.utilityLayerScene),t._coloredMaterial.disableLighting=!0,t._hoverColoredMaterial=new D("",i.utilityLayerScene),t._hoverColoredMaterial.disableLighting=!0,t._lineBoundingBox=new k("",i.utilityLayerScene),t._lineBoundingBox.rotationQuaternion=new x;var o=[];o.push(E("lines",{points:[new l(0,0,0),new l(t._boundingDimensions.x,0,0)]},i.utilityLayerScene)),o.push(E("lines",{points:[new l(0,0,0),new l(0,t._boundingDimensions.y,0)]},i.utilityLayerScene)),o.push(E("lines",{points:[new l(0,0,0),new l(0,0,t._boundingDimensions.z)]},i.utilityLayerScene)),o.push(E("lines",{points:[new l(t._boundingDimensions.x,0,0),new l(t._boundingDimensions.x,t._boundingDimensions.y,0)]},i.utilityLayerScene)),o.push(E("lines",{points:[new l(t._boundingDimensions.x,0,0),new l(t._boundingDimensions.x,0,t._boundingDimensions.z)]},i.utilityLayerScene)),o.push(E("lines",{points:[new l(0,t._boundingDimensions.y,0),new l(t._boundingDimensions.x,t._boundingDimensions.y,0)]},i.utilityLayerScene)),o.push(E("lines",{points:[new l(0,t._boundingDimensions.y,0),new l(0,t._boundingDimensions.y,t._boundingDimensions.z)]},i.utilityLayerScene)),o.push(E("lines",{points:[new l(0,0,t._boundingDimensions.z),new l(t._boundingDimensions.x,0,t._boundingDimensions.z)]},i.utilityLayerScene)),o.push(E("lines",{points:[new l(0,0,t._boundingDimensions.z),new l(0,t._boundingDimensions.y,t._boundingDimensions.z)]},i.utilityLayerScene)),o.push(E("lines",{points:[new l(t._boundingDimensions.x,t._boundingDimensions.y,t._boundingDimensions.z),new l(0,t._boundingDimensions.y,t._boundingDimensions.z)]},i.utilityLayerScene)),o.push(E("lines",{points:[new l(t._boundingDimensions.x,t._boundingDimensions.y,t._boundingDimensions.z),new l(t._boundingDimensions.x,0,t._boundingDimensions.z)]},i.utilityLayerScene)),o.push(E("lines",{points:[new l(t._boundingDimensions.x,t._boundingDimensions.y,t._boundingDimensions.z),new l(t._boundingDimensions.x,t._boundingDimensions.y,0)]},i.utilityLayerScene)),o.forEach(function(c){c.color=e,c.position.addInPlace(new l(-t._boundingDimensions.x/2,-t._boundingDimensions.y/2,-t._boundingDimensions.z/2)),c.isPickable=!1,t._lineBoundingBox.addChild(c)}),t._rootMesh.addChild(t._lineBoundingBox),t.setColor(e),t._rotateSpheresParent=new k("",i.utilityLayerScene),t._rotateSpheresParent.rotationQuaternion=new x;for(var n=function(c){var M=ie("",{diameter:1},i.utilityLayerScene);M.rotationQuaternion=new x,M.material=a._coloredMaterial,M.isNearGrabbable=!0;var v=new U({});v.moveAttached=!1,v.updateDragPlane=!1,M.addBehavior(v);var u=new l(1,0,0),P=0;v.onDragStartObservable.add(function(){u.copyFrom(M.forward),P=0}),v.onDragObservable.add(function(y){if(t.onRotationSphereDragObservable.notifyObservers({}),t.attachedMesh){var T=t.attachedMesh.parent;if(T&&T.scaling&&T.scaling.isNonUniformWithinEpsilon(.001)){Y.Warn("BoundingBoxGizmo controls are not supported on child meshes with non-uniform parent scaling");return}W._RemoveAndStorePivotPoint(t.attachedMesh);var w=u,I=y.dragPlaneNormal.scale(l.Dot(y.dragPlaneNormal,w)),G=w.subtract(I).normalizeToNew(),z=l.Dot(G,y.delta)<0?Math.abs(y.delta.length()):-Math.abs(y.delta.length());z=z/t._boundingDimensions.length()*t._anchorMesh.scaling.length(),t.attachedMesh.rotationQuaternion||(t.attachedMesh.rotationQuaternion=x.RotationYawPitchRoll(t.attachedMesh.rotation.y,t.attachedMesh.rotation.x,t.attachedMesh.rotation.z)),t._anchorMesh.rotationQuaternion||(t._anchorMesh.rotationQuaternion=x.RotationYawPitchRoll(t._anchorMesh.rotation.y,t._anchorMesh.rotation.x,t._anchorMesh.rotation.z)),P+=z,Math.abs(P)<=2*Math.PI&&(c>=8?x.RotationYawPitchRollToRef(0,0,z,t._tmpQuaternion):c>=4?x.RotationYawPitchRollToRef(z,0,0,t._tmpQuaternion):x.RotationYawPitchRollToRef(0,z,0,t._tmpQuaternion),t._anchorMesh.addChild(t.attachedMesh,b.PreserveScaling),t._anchorMesh.getScene().useRightHandedSystem&&t._tmpQuaternion.conjugateInPlace(),t._anchorMesh.rotationQuaternion.multiplyToRef(t._tmpQuaternion,t._anchorMesh.rotationQuaternion),t._anchorMesh.removeChild(t.attachedMesh,b.PreserveScaling),t.attachedMesh.setParent(T,b.PreserveScaling)),t.updateBoundingBox(),W._RestorePivotPoint(t.attachedMesh)}t._updateDummy()}),v.onDragStartObservable.add(function(){t.onDragStartObservable.notifyObservers({}),t._selectNode(M)}),v.onDragEndObservable.add(function(){t.onRotationSphereDragEndObservable.notifyObservers({}),t._selectNode(null),t._updateDummy()}),a._rotateSpheresParent.addChild(M)},a=this,h=0;h<12;h++)n(h);t._rootMesh.addChild(t._rotateSpheresParent),t._scaleBoxesParent=new k("",i.utilityLayerScene),t._scaleBoxesParent.rotationQuaternion=new x;for(var h=0;h<3;h++)for(var r=0;r<3;r++)for(var p=function(M){var v=(h===1?1:0)+(r===1?1:0)+(M===1?1:0);if(v===1||v===3)return"continue";var u=J("",{size:1},i.utilityLayerScene);u.material=f._coloredMaterial,u.metadata=v===2,u.isNearGrabbable=!0;var P=new l(h-1,r-1,M-1).normalize(),y=new U({dragAxis:P});y.updateDragPlane=!1,y.moveAttached=!1,u.addBehavior(y),y.onDragObservable.add(function(T){if(t.onScaleBoxDragObservable.notifyObservers({}),t.attachedMesh){var w=t.attachedMesh.parent;if(w&&w.scaling&&w.scaling.isNonUniformWithinEpsilon(.001)){Y.Warn("BoundingBoxGizmo controls are not supported on child meshes with non-uniform parent scaling");return}W._RemoveAndStorePivotPoint(t.attachedMesh);var I=T.dragDistance/t._boundingDimensions.length()*t._anchorMesh.scaling.length(),G=new l(I,I,I);v===2&&(G.x*=Math.abs(P.x),G.y*=Math.abs(P.y),G.z*=Math.abs(P.z)),G.scaleInPlace(t._scaleDragSpeed),G.multiplyInPlace(t._axisFactor),t.updateBoundingBox(),t.scalePivot?(t.attachedMesh.getWorldMatrix().getRotationMatrixToRef(t._tmpRotationMatrix),t._boundingDimensions.scaleToRef(.5,t._tmpVector),l.TransformCoordinatesToRef(t._tmpVector,t._tmpRotationMatrix,t._tmpVector),t._anchorMesh.position.subtractInPlace(t._tmpVector),t._boundingDimensions.multiplyToRef(t.scalePivot,t._tmpVector),l.TransformCoordinatesToRef(t._tmpVector,t._tmpRotationMatrix,t._tmpVector),t._anchorMesh.position.addInPlace(t._tmpVector)):(u.absolutePosition.subtractToRef(t._anchorMesh.position,t._tmpVector),t._anchorMesh.position.subtractInPlace(t._tmpVector)),t._anchorMesh.addChild(t.attachedMesh,b.PreserveScaling),t._anchorMesh.scaling.addInPlace(G),(t._anchorMesh.scaling.x<0||t._anchorMesh.scaling.y<0||t._anchorMesh.scaling.z<0)&&t._anchorMesh.scaling.subtractInPlace(G),t._anchorMesh.removeChild(t.attachedMesh,b.PreserveScaling),t.attachedMesh.setParent(w,b.PreserveScaling),W._RestorePivotPoint(t.attachedMesh)}t._updateDummy()}),y.onDragStartObservable.add(function(){t.onDragStartObservable.notifyObservers({}),t._selectNode(u)}),y.onDragEndObservable.add(function(){t.onScaleBoxDragEndObservable.notifyObservers({}),t._selectNode(null),t._updateDummy()}),f._scaleBoxesParent.addChild(u)},f=this,g=0;g<3;g++)p(g);t._rootMesh.addChild(t._scaleBoxesParent);var _=new Array;return t._pointerObserver=i.utilityLayerScene.onPointerObservable.add(function(c){_[c.event.pointerId]?c.pickInfo&&c.pickInfo.pickedMesh!=_[c.event.pointerId]&&(_[c.event.pointerId].material=t._coloredMaterial,delete _[c.event.pointerId]):t._rotateSpheresParent.getChildMeshes().concat(t._scaleBoxesParent.getChildMeshes()).forEach(function(M){c.pickInfo&&c.pickInfo.pickedMesh==M&&(_[c.event.pointerId]=M,M.material=t._hoverColoredMaterial)})}),t._renderObserver=t.gizmoLayer.originalScene.onBeforeRenderObservable.add(function(){t.attachedMesh&&!t._existingMeshScale.equals(t.attachedMesh.scaling)?t.updateBoundingBox():(t.fixedDragMeshScreenSize||t.fixedDragMeshBoundsSize)&&(t._updateRotationSpheres(),t._updateScaleBoxes()),t._dragMesh&&t.attachedMesh&&t._pointerDragBehavior.dragging&&(t._lineBoundingBox.position.rotateByQuaternionToRef(t._rootMesh.rotationQuaternion,t._tmpVector),t.attachedMesh.setAbsolutePosition(t._dragMesh.position.add(t._tmpVector.scale(-1))))}),t.updateBoundingBox(),t}return Object.defineProperty(s.prototype,"axisFactor",{get:function(){return this._axisFactor},set:function(e){this._axisFactor=e;for(var i=this._scaleBoxesParent.getChildMeshes(),t=0,o=0;o<3;o++)for(var n=0;n<3;n++)for(var a=0;a<3;a++){var h=(o===1?1:0)+(n===1?1:0)+(a===1?1:0);if(!(h===1||h===3)){if(i[t]){var r=new l(o-1,n-1,a-1);r.multiplyInPlace(this._axisFactor),i[t].setEnabled(r.lengthSquared()>ee)}t++}}},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"scaleDragSpeed",{get:function(){return this._scaleDragSpeed},set:function(e){this._scaleDragSpeed=e},enumerable:!1,configurable:!0}),s.prototype.setColor=function(e){this._coloredMaterial.emissiveColor=e,this._hoverColoredMaterial.emissiveColor=e.clone().add(new m(.3,.3,.3)),this._lineBoundingBox.getChildren().forEach(function(i){i.color&&(i.color=e)})},s.prototype._attachedNodeChanged=function(e){var i=this;if(e){this._anchorMesh.scaling.setAll(1),W._RemoveAndStorePivotPoint(e);var t=e.parent;this._anchorMesh.addChild(e,b.PreserveScaling),this._anchorMesh.removeChild(e,b.PreserveScaling),e.setParent(t,b.PreserveScaling),W._RestorePivotPoint(e),this.updateBoundingBox(),e.getChildMeshes(!1).forEach(function(o){o.markAsDirty("scaling")}),this.gizmoLayer.utilityLayerScene.onAfterRenderObservable.addOnce(function(){i._updateDummy()})}},s.prototype._selectNode=function(e){this._rotateSpheresParent.getChildMeshes().concat(this._scaleBoxesParent.getChildMeshes()).forEach(function(i){i.isVisible=!e||i==e})},s.prototype.getScaleBoxes=function(){return this._scaleBoxesParent.getChildMeshes()},s.prototype.updateBoundingBox=function(){if(this.attachedMesh){W._RemoveAndStorePivotPoint(this.attachedMesh);var e=this.attachedMesh.parent;this.attachedMesh.setParent(null,b.PreserveScaling),this._update(),this.attachedMesh.rotationQuaternion||(this.attachedMesh.rotationQuaternion=x.RotationYawPitchRoll(this.attachedMesh.rotation.y,this.attachedMesh.rotation.x,this.attachedMesh.rotation.z)),this._anchorMesh.rotationQuaternion||(this._anchorMesh.rotationQuaternion=x.RotationYawPitchRoll(this._anchorMesh.rotation.y,this._anchorMesh.rotation.x,this._anchorMesh.rotation.z)),this._anchorMesh.rotationQuaternion.copyFrom(this.attachedMesh.rotationQuaternion),this._tmpQuaternion.copyFrom(this.attachedMesh.rotationQuaternion),this._tmpVector.copyFrom(this.attachedMesh.position),this.attachedMesh.rotationQuaternion.set(0,0,0,1),this.attachedMesh.position.set(0,0,0);var i=this.attachedMesh.getHierarchyBoundingVectors(!this.ignoreChildren,this.includeChildPredicate);i.max.subtractToRef(i.min,this._boundingDimensions),this._lineBoundingBox.scaling.copyFrom(this._boundingDimensions),this._lineBoundingBox.position.set((i.max.x+i.min.x)/2,(i.max.y+i.min.y)/2,(i.max.z+i.min.z)/2),this._rotateSpheresParent.position.copyFrom(this._lineBoundingBox.position),this._scaleBoxesParent.position.copyFrom(this._lineBoundingBox.position),this._lineBoundingBox.computeWorldMatrix(),this._anchorMesh.position.copyFrom(this._lineBoundingBox.absolutePosition),this.attachedMesh.rotationQuaternion.copyFrom(this._tmpQuaternion),this.attachedMesh.position.copyFrom(this._tmpVector),this.attachedMesh.setParent(e,b.PreserveScaling)}this._updateRotationSpheres(),this._updateScaleBoxes(),this.attachedMesh&&(this._existingMeshScale.copyFrom(this.attachedMesh.scaling),W._RestorePivotPoint(this.attachedMesh))},s.prototype._updateRotationSpheres=function(){for(var e=this._rotateSpheresParent.getChildMeshes(),i=0;i<3;i++)for(var t=0;t<2;t++)for(var o=0;o<2;o++){var n=i*4+t*2+o;if(i==0&&(e[n].position.set(this._boundingDimensions.x/2,this._boundingDimensions.y*t,this._boundingDimensions.z*o),e[n].position.addInPlace(new l(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),e[n].lookAt(l.Cross(e[n].position.normalizeToNew(),l.Right()).normalizeToNew().add(e[n].position))),i==1&&(e[n].position.set(this._boundingDimensions.x*t,this._boundingDimensions.y/2,this._boundingDimensions.z*o),e[n].position.addInPlace(new l(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),e[n].lookAt(l.Cross(e[n].position.normalizeToNew(),l.Up()).normalizeToNew().add(e[n].position))),i==2&&(e[n].position.set(this._boundingDimensions.x*t,this._boundingDimensions.y*o,this._boundingDimensions.z/2),e[n].position.addInPlace(new l(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),e[n].lookAt(l.Cross(e[n].position.normalizeToNew(),l.Forward()).normalizeToNew().add(e[n].position))),this.fixedDragMeshScreenSize&&this.gizmoLayer.utilityLayerScene.activeCamera){e[n].absolutePosition.subtractToRef(this.gizmoLayer.utilityLayerScene.activeCamera.position,this._tmpVector);var a=this.rotationSphereSize*this._tmpVector.length()/this.fixedDragMeshScreenSizeDistanceFactor;e[n].scaling.set(a,a,a)}else this.fixedDragMeshBoundsSize?e[n].scaling.set(this.rotationSphereSize*this._boundingDimensions.x,this.rotationSphereSize*this._boundingDimensions.y,this.rotationSphereSize*this._boundingDimensions.z):e[n].scaling.set(this.rotationSphereSize,this.rotationSphereSize,this.rotationSphereSize)}},s.prototype._updateScaleBoxes=function(){for(var e=this._scaleBoxesParent.getChildMeshes(),i=0,t=0;t<3;t++)for(var o=0;o<3;o++)for(var n=0;n<3;n++){var a=(t===1?1:0)+(o===1?1:0)+(n===1?1:0);if(!(a===1||a===3)){if(e[i])if(e[i].position.set(this._boundingDimensions.x*(t/2),this._boundingDimensions.y*(o/2),this._boundingDimensions.z*(n/2)),e[i].position.addInPlace(new l(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),this.fixedDragMeshScreenSize&&this.gizmoLayer.utilityLayerScene.activeCamera){e[i].absolutePosition.subtractToRef(this.gizmoLayer.utilityLayerScene.activeCamera.position,this._tmpVector);var h=this.scaleBoxSize*this._tmpVector.length()/this.fixedDragMeshScreenSizeDistanceFactor;e[i].scaling.set(h,h,h)}else this.fixedDragMeshBoundsSize?e[i].scaling.set(this.scaleBoxSize*this._boundingDimensions.x,this.scaleBoxSize*this._boundingDimensions.y,this.scaleBoxSize*this._boundingDimensions.z):e[i].scaling.set(this.scaleBoxSize,this.scaleBoxSize,this.scaleBoxSize);i++}}},s.prototype.setEnabledRotationAxis=function(e){this._rotateSpheresParent.getChildMeshes().forEach(function(i,t){t<4?i.setEnabled(e.indexOf("x")!=-1):t<8?i.setEnabled(e.indexOf("y")!=-1):i.setEnabled(e.indexOf("z")!=-1)})},s.prototype.setEnabledScaling=function(e,i){i===void 0&&(i=!1),this._scaleBoxesParent.getChildMeshes().forEach(function(t){var o=e;i&&t.metadata===!0&&(o=!1),t.setEnabled(o)})},s.prototype._updateDummy=function(){this._dragMesh&&(this._dragMesh.position.copyFrom(this._lineBoundingBox.getAbsolutePosition()),this._dragMesh.scaling.copyFrom(this._lineBoundingBox.scaling),this._dragMesh.rotationQuaternion.copyFrom(this._rootMesh.rotationQuaternion))},s.prototype.enableDragBehavior=function(){this._dragMesh=J("dummy",{size:1},this.gizmoLayer.utilityLayerScene),this._dragMesh.visibility=0,this._dragMesh.rotationQuaternion=new x,this._pointerDragBehavior.useObjectOrientationForDragging=!1,this._dragMesh.addBehavior(this._pointerDragBehavior)},s.prototype.dispose=function(){this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.gizmoLayer.originalScene.onBeforeRenderObservable.remove(this._renderObserver),this._lineBoundingBox.dispose(),this._rotateSpheresParent.dispose(),this._scaleBoxesParent.dispose(),this._dragMesh&&this._dragMesh.dispose(),d.prototype.dispose.call(this)},s.MakeNotPickableAndWrapInBoundingBox=function(e){var i=function(h){h.isPickable=!1,h.getChildMeshes().forEach(function(r){i(r)})};i(e),e.rotationQuaternion||(e.rotationQuaternion=x.RotationYawPitchRoll(e.rotation.y,e.rotation.x,e.rotation.z));var t=e.position.clone(),o=e.rotationQuaternion.clone();e.rotationQuaternion.set(0,0,0,1),e.position.set(0,0,0);var n=J("box",{size:1},e.getScene()),a=e.getHierarchyBoundingVectors();return a.max.subtractToRef(a.min,n.scaling),n.scaling.y===0&&(n.scaling.y=ee),n.scaling.x===0&&(n.scaling.x=ee),n.scaling.z===0&&(n.scaling.z=ee),n.position.set((a.max.x+a.min.x)/2,(a.max.y+a.min.y)/2,(a.max.z+a.min.z)/2),e.addChild(n),e.rotationQuaternion.copyFrom(o),e.position.copyFrom(t),e.removeChild(n),n.addChild(e),n.visibility=0,n},s.prototype.setCustomMesh=function(){Y.Error("Custom meshes are not supported on this gizmo")},s}(b),re=function(d){V(s,d);function s(e,i,t,o,n,a,h){i===void 0&&(i=m.Gray()),t===void 0&&(t=N.DefaultUtilityLayer),o===void 0&&(o=32),n===void 0&&(n=null),h===void 0&&(h=1);var r=this,p;r=d.call(this,t)||this,r._pointerObserver=null,r.snapDistance=0,r.onSnapObservable=new S,r.angle=0,r._isEnabled=!0,r._parent=null,r._dragging=!1,r._angles=new l,r._parent=n,r._coloredMaterial=new D("",t.utilityLayerScene),r._coloredMaterial.diffuseColor=i,r._coloredMaterial.specularColor=i.subtract(new m(.1,.1,.1)),r._hoverMaterial=new D("",t.utilityLayerScene),r._hoverMaterial.diffuseColor=m.Yellow(),r._disableMaterial=new D("",t.utilityLayerScene),r._disableMaterial.diffuseColor=m.Gray(),r._disableMaterial.alpha=.4,r._gizmoMesh=new R("",t.utilityLayerScene);var f=r._createGizmoMesh(r._gizmoMesh,h,o),g=f.rotationMesh,_=f.collider;r._rotationDisplayPlane=me("rotationDisplay",{size:.6,updatable:!1},r.gizmoLayer.utilityLayerScene),r._rotationDisplayPlane.rotation.z=Math.PI*.5,r._rotationDisplayPlane.parent=r._gizmoMesh,r._rotationDisplayPlane.setEnabled(!1),_e.ShadersStore.rotationGizmoVertexShader=s._RotationGizmoVertexShader,_e.ShadersStore.rotationGizmoFragmentShader=s._RotationGizmoFragmentShader,r._rotationShaderMaterial=new ye("shader",r.gizmoLayer.utilityLayerScene,{vertex:"rotationGizmo",fragment:"rotationGizmo"},{attributes:["position","uv"],uniforms:["worldViewProjection","angles"]}),r._rotationShaderMaterial.backFaceCulling=!1,r._rotationDisplayPlane.material=r._rotationShaderMaterial,r._rotationDisplayPlane.visibility=.999,r._gizmoMesh.lookAt(r._rootMesh.position.add(e)),r._rootMesh.addChild(r._gizmoMesh,b.PreserveScaling),r._gizmoMesh.scaling.scaleInPlace(1/3),r.dragBehavior=new U({dragPlaneNormal:e}),r.dragBehavior.moveAttached=!1,r.dragBehavior.maxDragAngle=s.MaxDragAngle,r.dragBehavior._useAlternatePickedPointAboveMaxDragAngle=!0,r._rootMesh.addBehavior(r.dragBehavior);var c=new l,M=new F,v=new l,u=new l;r.dragBehavior.onDragStartObservable.add(function(z){r.attachedNode&&(c.copyFrom(z.dragPlanePoint),r._rotationDisplayPlane.setEnabled(!0),r._rotationDisplayPlane.getWorldMatrix().invertToRef(M),l.TransformCoordinatesToRef(z.dragPlanePoint,M,c),r._angles.x=Math.atan2(c.y,c.x)+Math.PI,r._angles.y=0,r._angles.z=r.updateGizmoRotationToMatchAttachedMesh?1:0,r._dragging=!0,c.copyFrom(z.dragPlanePoint),r._rotationShaderMaterial.setVector3("angles",r._angles),r.angle=0)}),r.dragBehavior.onDragEndObservable.add(function(){r._dragging=!1,r._rotationDisplayPlane.setEnabled(!1)});var P={snapDistance:0},y=0,T=new F,w=new x;r.dragBehavior.onDragObservable.add(function(z){if(r.attachedNode){var O=new l(1,1,1),L=new x(0,0,0,1),Q=new l(0,0,0);r._handlePivot(),r.attachedNode.getWorldMatrix().decompose(O,L,Q);var q=z.dragPlanePoint.subtract(Q).normalize(),B=c.subtract(Q).normalize(),A=l.Cross(q,B),j=l.Dot(q,B),C=Math.atan2(A.length(),j);v.copyFrom(e),u.copyFrom(e),r.updateGizmoRotationToMatchAttachedMesh&&(L.toRotationMatrix(M),u=l.TransformCoordinates(v,M));var X=!1;if(t.utilityLayerScene.activeCamera){var Z=t.utilityLayerScene.activeCamera.position.subtract(Q).normalize();l.Dot(Z,u)>0&&(v.scaleInPlace(-1),u.scaleInPlace(-1),X=!0)}var pe=l.Dot(u,A)>0;pe&&(C=-C);var le=!1;if(r.snapDistance!=0)if(y+=C,Math.abs(y)>r.snapDistance){var de=Math.floor(Math.abs(y)/r.snapDistance);y<0&&(de*=-1),y=y%r.snapDistance,C=r.snapDistance*de,le=!0}else C=0;var oe=Math.sin(C/2);if(w.set(v.x*oe,v.y*oe,v.z*oe,Math.cos(C/2)),T.determinant()>0){var $=new l;w.toEulerAnglesToRef($),x.RotationYawPitchRollToRef($.y,-$.x,-$.z,w)}r.updateGizmoRotationToMatchAttachedMesh?L.multiplyToRef(w,L):w.multiplyToRef(L,L),r.attachedNode.getWorldMatrix().copyFrom(F.Compose(O,L,Q)),c.copyFrom(z.dragPlanePoint),le&&(P.snapDistance=C,r.onSnapObservable.notifyObservers(P)),r._angles.y+=C,r.angle+=X?-C:C,r._rotationShaderMaterial.setVector3("angles",r._angles),r._matrixChanged()}});var I=t._getSharedGizmoLight();I.includedOnlyMeshes=I.includedOnlyMeshes.concat(r._rootMesh.getChildMeshes(!1));var G={colliderMeshes:[_],gizmoMeshes:[g],material:r._coloredMaterial,hoverMaterial:r._hoverMaterial,disableMaterial:r._disableMaterial,active:!1,dragBehavior:r.dragBehavior};return(p=r._parent)===null||p===void 0||p.addToAxisCache(r._gizmoMesh,G),r._pointerObserver=t.utilityLayerScene.onPointerObservable.add(function(z){var O;if(!r._customMeshSet&&(r.dragBehavior.maxDragAngle=s.MaxDragAngle,r._isHovered=G.colliderMeshes.indexOf((O=z==null?void 0:z.pickInfo)===null||O===void 0?void 0:O.pickedMesh)!=-1,!r._parent)){var L=G.dragBehavior.enabled?r._isHovered||r._dragging?r._hoverMaterial:r._coloredMaterial:r._disableMaterial;r._setGizmoMeshMaterial(G.gizmoMeshes,L)}}),r.dragBehavior.onEnabledObservable.add(function(z){r._setGizmoMeshMaterial(G.gizmoMeshes,z?r._coloredMaterial:r._disableMaterial)}),r}return s.prototype._createGizmoMesh=function(e,i,t){var o=ce("ignore",{diameter:.6,thickness:.03*i,tessellation:t},this.gizmoLayer.utilityLayerScene);o.visibility=0;var n=ce("",{diameter:.6,thickness:.005*i,tessellation:t},this.gizmoLayer.utilityLayerScene);return n.material=this._coloredMaterial,n.rotation.x=Math.PI/2,o.rotation.x=Math.PI/2,e.addChild(n,b.PreserveScaling),e.addChild(o,b.PreserveScaling),{rotationMesh:n,collider:o}},s.prototype._attachedNodeChanged=function(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)},Object.defineProperty(s.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh):this.attachedMesh=null},enumerable:!1,configurable:!0}),s.prototype.dispose=function(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),this._rotationDisplayPlane&&this._rotationDisplayPlane.dispose(),this._rotationShaderMaterial&&this._rotationShaderMaterial.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(function(e){e&&e.dispose()}),d.prototype.dispose.call(this)},s.MaxDragAngle=Math.PI*9/20,s._RotationGizmoVertexShader=`
        precision highp float;
        attribute vec3 position;
        attribute vec2 uv;
        uniform mat4 worldViewProjection;
        varying vec3 vPosition;
        varying vec2 vUV;
        void main(void) {
            gl_Position = worldViewProjection * vec4(position, 1.0);
            vUV = uv;
        }`,s._RotationGizmoFragmentShader=`
        precision highp float;
        varying vec2 vUV;
        varying vec3 vPosition;
        uniform vec3 angles;
        #define twopi 6.283185307
        void main(void) {
            vec2 uv = vUV - vec2(0.5);
            float angle = atan(uv.y, uv.x) + 3.141592;
            float delta = gl_FrontFacing ? angles.y : -angles.y;
            float begin = angles.x - delta * angles.z;
            float start = (begin < (begin + delta)) ? begin : (begin + delta);
            float end = (begin > (begin + delta)) ? begin : (begin + delta);
            float len = sqrt(dot(uv,uv));
            float opacity = 1. - step(0.5, len);

            float base = abs(floor(start / twopi)) * twopi;
            start += base;
            end += base;

            float intensity = 0.;
            for (int i = 0; i < 5; i++)
            {
                intensity += max(step(start, angle) - step(end, angle), 0.);
                angle += twopi;
            }
            gl_FragColor = vec4(1.,1.,0., min(intensity * 0.25, 0.8)) * opacity;
        }`,s}(b),Pe=function(d){V(s,d);function s(e,i,t,o,n,a){e===void 0&&(e=N.DefaultUtilityLayer),i===void 0&&(i=32),t===void 0&&(t=!1),o===void 0&&(o=1);var h=d.call(this,e)||this;h.onDragStartObservable=new S,h.onDragEndObservable=new S,h._observables=[],h._gizmoAxisCache=new Map;var r=a&&a.xOptions&&a.xOptions.color?a.xOptions.color:m.Red().scale(.5),p=a&&a.yOptions&&a.yOptions.color?a.yOptions.color:m.Green().scale(.5),f=a&&a.zOptions&&a.zOptions.color?a.zOptions.color:m.Blue().scale(.5);return h.xGizmo=new re(new l(1,0,0),r,e,i,h,t,o),h.yGizmo=new re(new l(0,1,0),p,e,i,h,t,o),h.zGizmo=new re(new l(0,0,1),f,e,i,h,t,o),[h.xGizmo,h.yGizmo,h.zGizmo].forEach(function(g){a&&a.updateScale!=null&&(g.updateScale=a.updateScale),g.dragBehavior.onDragStartObservable.add(function(){h.onDragStartObservable.notifyObservers({})}),g.dragBehavior.onDragEndObservable.add(function(){h.onDragEndObservable.notifyObservers({})})}),h.attachedMesh=null,h.attachedNode=null,n?n.addToAxisCache(h._gizmoAxisCache):b.GizmoAxisPointerObserver(e,h._gizmoAxisCache),h}return Object.defineProperty(s.prototype,"attachedMesh",{get:function(){return this._meshAttached},set:function(e){this._meshAttached=e,this._nodeAttached=e,this._checkBillboardTransform(),[this.xGizmo,this.yGizmo,this.zGizmo].forEach(function(i){i.isEnabled?i.attachedMesh=e:i.attachedMesh=null})},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"attachedNode",{get:function(){return this._nodeAttached},set:function(e){this._meshAttached=null,this._nodeAttached=e,this._checkBillboardTransform(),[this.xGizmo,this.yGizmo,this.zGizmo].forEach(function(i){i.isEnabled?i.attachedNode=e:i.attachedNode=null})},enumerable:!1,configurable:!0}),s.prototype._checkBillboardTransform=function(){this._nodeAttached&&this._nodeAttached.billboardMode&&console.log("Rotation Gizmo will not work with transforms in billboard mode.")},Object.defineProperty(s.prototype,"isHovered",{get:function(){var e=!1;return[this.xGizmo,this.yGizmo,this.zGizmo].forEach(function(i){e=e||i.isHovered}),e},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"updateGizmoRotationToMatchAttachedMesh",{get:function(){return this.xGizmo.updateGizmoRotationToMatchAttachedMesh},set:function(e){this.xGizmo&&(this.xGizmo.updateGizmoRotationToMatchAttachedMesh=e,this.yGizmo.updateGizmoRotationToMatchAttachedMesh=e,this.zGizmo.updateGizmoRotationToMatchAttachedMesh=e)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"snapDistance",{get:function(){return this.xGizmo.snapDistance},set:function(e){this.xGizmo&&(this.xGizmo.snapDistance=e,this.yGizmo.snapDistance=e,this.zGizmo.snapDistance=e)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"scaleRatio",{get:function(){return this.xGizmo.scaleRatio},set:function(e){this.xGizmo&&(this.xGizmo.scaleRatio=e,this.yGizmo.scaleRatio=e,this.zGizmo.scaleRatio=e)},enumerable:!1,configurable:!0}),s.prototype.addToAxisCache=function(e,i){this._gizmoAxisCache.set(e,i)},s.prototype.dispose=function(){var e=this;this.xGizmo.dispose(),this.yGizmo.dispose(),this.zGizmo.dispose(),this.onDragStartObservable.clear(),this.onDragEndObservable.clear(),this._observables.forEach(function(i){e.gizmoLayer.utilityLayerScene.onPointerObservable.remove(i)})},s.prototype.setCustomMesh=function(){Y.Error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo)")},s}(b),he=function(d){V(s,d);function s(e,i,t,o){i===void 0&&(i=m.Gray()),t===void 0&&(t=N.DefaultUtilityLayer),o===void 0&&(o=null);var n=this,a;n=d.call(this,t)||this,n._pointerObserver=null,n.snapDistance=0,n.onSnapObservable=new S,n._isEnabled=!1,n._parent=null,n._dragging=!1,n._parent=o,n._coloredMaterial=new D("",t.utilityLayerScene),n._coloredMaterial.diffuseColor=i,n._coloredMaterial.specularColor=i.subtract(new m(.1,.1,.1)),n._hoverMaterial=new D("",t.utilityLayerScene),n._hoverMaterial.diffuseColor=m.Yellow(),n._disableMaterial=new D("",t.utilityLayerScene),n._disableMaterial.diffuseColor=m.Gray(),n._disableMaterial.alpha=.4,n._gizmoMesh=s._CreatePlane(t.utilityLayerScene,n._coloredMaterial),n._gizmoMesh.lookAt(n._rootMesh.position.add(e)),n._gizmoMesh.scaling.scaleInPlace(1/3),n._gizmoMesh.parent=n._rootMesh;var h=0,r=new l,p={snapDistance:0};n.dragBehavior=new U({dragPlaneNormal:e}),n.dragBehavior.moveAttached=!1,n._rootMesh.addBehavior(n.dragBehavior),n.dragBehavior.onDragObservable.add(function(_){if(n.attachedNode){if(n._handlePivot(),n.snapDistance==0)n.attachedNode.getWorldMatrix().addTranslationFromFloats(_.delta.x,_.delta.y,_.delta.z);else if(h+=_.dragDistance,Math.abs(h)>n.snapDistance){var c=Math.floor(Math.abs(h)/n.snapDistance);h=h%n.snapDistance,_.delta.normalizeToRef(r),r.scaleInPlace(n.snapDistance*c),n.attachedNode.getWorldMatrix().addTranslationFromFloats(r.x,r.y,r.z),p.snapDistance=n.snapDistance*c,n.onSnapObservable.notifyObservers(p)}n._matrixChanged()}}),n.dragBehavior.onDragStartObservable.add(function(){n._dragging=!0}),n.dragBehavior.onDragEndObservable.add(function(){n._dragging=!1});var f=t._getSharedGizmoLight();f.includedOnlyMeshes=f.includedOnlyMeshes.concat(n._rootMesh.getChildMeshes(!1));var g={gizmoMeshes:n._gizmoMesh.getChildMeshes(),colliderMeshes:n._gizmoMesh.getChildMeshes(),material:n._coloredMaterial,hoverMaterial:n._hoverMaterial,disableMaterial:n._disableMaterial,active:!1,dragBehavior:n.dragBehavior};return(a=n._parent)===null||a===void 0||a.addToAxisCache(n._gizmoMesh,g),n._pointerObserver=t.utilityLayerScene.onPointerObservable.add(function(_){var c;if(!n._customMeshSet&&(n._isHovered=g.colliderMeshes.indexOf((c=_==null?void 0:_.pickInfo)===null||c===void 0?void 0:c.pickedMesh)!=-1,!n._parent)){var M=g.dragBehavior.enabled?n._isHovered||n._dragging?n._hoverMaterial:n._coloredMaterial:n._disableMaterial;n._setGizmoMeshMaterial(g.gizmoMeshes,M)}}),n.dragBehavior.onEnabledObservable.add(function(_){n._setGizmoMeshMaterial(g.gizmoMeshes,_?n._coloredMaterial:n._disableMaterial)}),n}return s._CreatePlane=function(e,i){var t=new ae("plane",e),o=me("dragPlane",{width:.1375,height:.1375,sideOrientation:2},e);return o.material=i,o.parent=t,t},s.prototype._attachedNodeChanged=function(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)},Object.defineProperty(s.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this._isEnabled=e,e?this._parent&&(this.attachedNode=this._parent.attachedNode):this.attachedNode=null},enumerable:!1,configurable:!0}),s.prototype.dispose=function(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),d.prototype.dispose.call(this),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(function(e){e&&e.dispose()})},s}(b),xe=function(d){V(s,d);function s(e,i,t){e===void 0&&(e=N.DefaultUtilityLayer),i===void 0&&(i=1);var o=d.call(this,e)||this;return o._meshAttached=null,o._nodeAttached=null,o._observables=[],o._gizmoAxisCache=new Map,o.onDragStartObservable=new S,o.onDragEndObservable=new S,o._planarGizmoEnabled=!1,o.xGizmo=new ne(new l(1,0,0),m.Red().scale(.5),e,o,i),o.yGizmo=new ne(new l(0,1,0),m.Green().scale(.5),e,o,i),o.zGizmo=new ne(new l(0,0,1),m.Blue().scale(.5),e,o,i),o.xPlaneGizmo=new he(new l(1,0,0),m.Red().scale(.5),o.gizmoLayer,o),o.yPlaneGizmo=new he(new l(0,1,0),m.Green().scale(.5),o.gizmoLayer,o),o.zPlaneGizmo=new he(new l(0,0,1),m.Blue().scale(.5),o.gizmoLayer,o),[o.xGizmo,o.yGizmo,o.zGizmo,o.xPlaneGizmo,o.yPlaneGizmo,o.zPlaneGizmo].forEach(function(n){n.dragBehavior.onDragStartObservable.add(function(){o.onDragStartObservable.notifyObservers({})}),n.dragBehavior.onDragEndObservable.add(function(){o.onDragEndObservable.notifyObservers({})})}),o.attachedMesh=null,t?t.addToAxisCache(o._gizmoAxisCache):b.GizmoAxisPointerObserver(e,o._gizmoAxisCache),o}return Object.defineProperty(s.prototype,"attachedMesh",{get:function(){return this._meshAttached},set:function(e){this._meshAttached=e,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i.isEnabled?i.attachedMesh=e:i.attachedMesh=null})},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"attachedNode",{get:function(){return this._nodeAttached},set:function(e){this._meshAttached=null,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i.isEnabled?i.attachedNode=e:i.attachedNode=null})},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"isHovered",{get:function(){var e=!1;return[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){e=e||i.isHovered}),e},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"planarGizmoEnabled",{get:function(){return this._planarGizmoEnabled},set:function(e){var i=this;this._planarGizmoEnabled=e,[this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(t){t&&(t.isEnabled=e,e&&(t.attachedMesh?t.attachedMesh=i.attachedMesh:t.attachedNode=i.attachedNode))},this)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"updateGizmoRotationToMatchAttachedMesh",{get:function(){return this._updateGizmoRotationToMatchAttachedMesh},set:function(e){this._updateGizmoRotationToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i&&(i.updateGizmoRotationToMatchAttachedMesh=e)})},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"snapDistance",{get:function(){return this._snapDistance},set:function(e){this._snapDistance=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i&&(i.snapDistance=e)})},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"scaleRatio",{get:function(){return this._scaleRatio},set:function(e){this._scaleRatio=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i&&(i.scaleRatio=e)})},enumerable:!1,configurable:!0}),s.prototype.addToAxisCache=function(e,i){this._gizmoAxisCache.set(e,i)},s.prototype.dispose=function(){var e=this;[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(function(i){i&&i.dispose()}),this._observables.forEach(function(i){e.gizmoLayer.utilityLayerScene.onPointerObservable.remove(i)}),this.onDragStartObservable.clear(),this.onDragEndObservable.clear()},s.prototype.setCustomMesh=function(){Y.Error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo,gizmo.xPlaneGizmo, gizmo.yPlaneGizmo, gizmo.zPlaneGizmo)")},s}(b),Se=function(d){V(s,d);function s(e,i,t){e===void 0&&(e=N.DefaultUtilityLayer),i===void 0&&(i=1);var o=d.call(this,e)||this;return o._meshAttached=null,o._nodeAttached=null,o._sensitivity=1,o._observables=[],o._gizmoAxisCache=new Map,o.onDragStartObservable=new S,o.onDragEndObservable=new S,o.uniformScaleGizmo=o._createUniformScaleMesh(),o.xGizmo=new te(new l(1,0,0),m.Red().scale(.5),e,o,i),o.yGizmo=new te(new l(0,1,0),m.Green().scale(.5),e,o,i),o.zGizmo=new te(new l(0,0,1),m.Blue().scale(.5),e,o,i),[o.xGizmo,o.yGizmo,o.zGizmo,o.uniformScaleGizmo].forEach(function(n){n.dragBehavior.onDragStartObservable.add(function(){o.onDragStartObservable.notifyObservers({})}),n.dragBehavior.onDragEndObservable.add(function(){o.onDragEndObservable.notifyObservers({})})}),o.attachedMesh=null,o.attachedNode=null,t?t.addToAxisCache(o._gizmoAxisCache):b.GizmoAxisPointerObserver(e,o._gizmoAxisCache),o}return Object.defineProperty(s.prototype,"attachedMesh",{get:function(){return this._meshAttached},set:function(e){this._meshAttached=e,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i.isEnabled?i.attachedMesh=e:i.attachedMesh=null})},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"attachedNode",{get:function(){return this._nodeAttached},set:function(e){this._meshAttached=null,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i.isEnabled?i.attachedNode=e:i.attachedNode=null})},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"isHovered",{get:function(){var e=!1;return[this.xGizmo,this.yGizmo,this.zGizmo].forEach(function(i){e=e||i.isHovered}),e},enumerable:!1,configurable:!0}),s.prototype._createUniformScaleMesh=function(){this._coloredMaterial=new D("",this.gizmoLayer.utilityLayerScene),this._coloredMaterial.diffuseColor=m.Gray(),this._hoverMaterial=new D("",this.gizmoLayer.utilityLayerScene),this._hoverMaterial.diffuseColor=m.Yellow(),this._disableMaterial=new D("",this.gizmoLayer.utilityLayerScene),this._disableMaterial.diffuseColor=m.Gray(),this._disableMaterial.alpha=.4;var e=new te(new l(0,1,0),m.Gray().scale(.5),this.gizmoLayer,this);e.updateGizmoRotationToMatchAttachedMesh=!1,e.uniformScaling=!0,this._uniformScalingMesh=ue("uniform",{type:1},e.gizmoLayer.utilityLayerScene),this._uniformScalingMesh.scaling.scaleInPlace(.01),this._uniformScalingMesh.visibility=0,this._octahedron=ue("",{type:1},e.gizmoLayer.utilityLayerScene),this._octahedron.scaling.scaleInPlace(.007),this._uniformScalingMesh.addChild(this._octahedron),e.setCustomMesh(this._uniformScalingMesh,!0);var i=this.gizmoLayer._getSharedGizmoLight();i.includedOnlyMeshes=i.includedOnlyMeshes.concat(this._octahedron);var t={gizmoMeshes:[this._octahedron,this._uniformScalingMesh],colliderMeshes:[this._uniformScalingMesh],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:e.dragBehavior};return this.addToAxisCache(e._rootMesh,t),e},Object.defineProperty(s.prototype,"updateGizmoRotationToMatchAttachedMesh",{get:function(){return this._updateGizmoRotationToMatchAttachedMesh},set:function(e){e?(this._updateGizmoRotationToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i&&(i.updateGizmoRotationToMatchAttachedMesh=e)})):Y.Warn("Setting updateGizmoRotationToMatchAttachedMesh = false on scaling gizmo is not supported.")},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"snapDistance",{get:function(){return this._snapDistance},set:function(e){this._snapDistance=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i&&(i.snapDistance=e)})},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"scaleRatio",{get:function(){return this._scaleRatio},set:function(e){this._scaleRatio=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i&&(i.scaleRatio=e)})},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"sensitivity",{get:function(){return this._sensitivity},set:function(e){this._sensitivity=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i&&(i.sensitivity=e)})},enumerable:!1,configurable:!0}),s.prototype.addToAxisCache=function(e,i){this._gizmoAxisCache.set(e,i)},s.prototype.dispose=function(){var e=this;[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(function(i){i&&i.dispose()}),this._observables.forEach(function(i){e.gizmoLayer.utilityLayerScene.onPointerObservable.remove(i)}),this.onDragStartObservable.clear(),this.onDragEndObservable.clear(),[this._uniformScalingMesh,this._octahedron].forEach(function(i){i&&i.dispose()}),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(function(i){i&&i.dispose()})},s}(b);(function(){function d(s,e,i,t){e===void 0&&(e=1),i===void 0&&(i=N.DefaultUtilityLayer),t===void 0&&(t=N.DefaultKeepDepthUtilityLayer),this._scene=s,this.clearGizmoOnEmptyPointerEvent=!1,this.enableAutoPicking=!0,this.onAttachedToMeshObservable=new S,this.onAttachedToNodeObservable=new S,this._gizmosEnabled={positionGizmo:!1,rotationGizmo:!1,scaleGizmo:!1,boundingBoxGizmo:!1},this._pointerObservers=[],this._attachedMesh=null,this._attachedNode=null,this._boundingBoxColor=m.FromHexString("#0984e3"),this._thickness=1,this._scaleRatio=1,this._gizmoAxisCache=new Map,this.boundingBoxDragBehavior=new ge,this.attachableMeshes=null,this.attachableNodes=null,this.usePointerToAttachGizmos=!0,this._defaultUtilityLayer=i,this._defaultKeepDepthUtilityLayer=t,this._defaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,this._thickness=e,this.gizmos={positionGizmo:null,rotationGizmo:null,scaleGizmo:null,boundingBoxGizmo:null};var o=this._attachToMeshPointerObserver(s),n=b.GizmoAxisPointerObserver(this._defaultUtilityLayer,this._gizmoAxisCache);this._pointerObservers=[o,n]}return Object.defineProperty(d.prototype,"keepDepthUtilityLayer",{get:function(){return this._defaultKeepDepthUtilityLayer},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"utilityLayer",{get:function(){return this._defaultUtilityLayer},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"isHovered",{get:function(){var s=!1;for(var e in this.gizmos){var i=this.gizmos[e];if(i&&i.isHovered){s=!0;break}}return s},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"scaleRatio",{get:function(){return this._scaleRatio},set:function(s){this._scaleRatio=s,[this.gizmos.positionGizmo,this.gizmos.rotationGizmo,this.gizmos.scaleGizmo].forEach(function(e){e&&(e.scaleRatio=s)})},enumerable:!1,configurable:!0}),d.prototype._attachToMeshPointerObserver=function(s){var e=this,i=s.onPointerObservable.add(function(t){if(!!e.usePointerToAttachGizmos&&t.type==K.POINTERDOWN)if(t.pickInfo&&t.pickInfo.pickedMesh){if(e.enableAutoPicking){var o=t.pickInfo.pickedMesh;if(e.attachableMeshes==null)for(;o&&o.parent!=null;)o=o.parent;else{var n=!1;e.attachableMeshes.forEach(function(a){o&&(o==a||o.isDescendantOf(a))&&(o=a,n=!0)}),n||(o=null)}o instanceof k?e._attachedMesh!=o&&e.attachToMesh(o):e.clearGizmoOnEmptyPointerEvent&&e.attachToMesh(null)}}else e.clearGizmoOnEmptyPointerEvent&&e.attachToMesh(null)});return i},d.prototype.attachToMesh=function(s){this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh=s,this._attachedNode=null;for(var e in this.gizmos){var i=this.gizmos[e];i&&this._gizmosEnabled[e]&&(i.attachedMesh=s)}this.boundingBoxGizmoEnabled&&this._attachedMesh&&this._attachedMesh.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToMeshObservable.notifyObservers(s)},d.prototype.attachToNode=function(s){this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh=null,this._attachedNode=s;for(var e in this.gizmos){var i=this.gizmos[e];i&&this._gizmosEnabled[e]&&(i.attachedNode=s)}this.boundingBoxGizmoEnabled&&this._attachedNode&&this._attachedNode.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToNodeObservable.notifyObservers(s)},Object.defineProperty(d.prototype,"positionGizmoEnabled",{get:function(){return this._gizmosEnabled.positionGizmo},set:function(s){s?(this.gizmos.positionGizmo||(this.gizmos.positionGizmo=new xe(this._defaultUtilityLayer,this._thickness,this)),this._attachedNode?this.gizmos.positionGizmo.attachedNode=this._attachedNode:this.gizmos.positionGizmo.attachedMesh=this._attachedMesh):this.gizmos.positionGizmo&&(this.gizmos.positionGizmo.attachedNode=null),this._gizmosEnabled.positionGizmo=s},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"rotationGizmoEnabled",{get:function(){return this._gizmosEnabled.rotationGizmo},set:function(s){s?(this.gizmos.rotationGizmo||(this.gizmos.rotationGizmo=new Pe(this._defaultUtilityLayer,32,!1,this._thickness,this)),this._attachedNode?this.gizmos.rotationGizmo.attachedNode=this._attachedNode:this.gizmos.rotationGizmo.attachedMesh=this._attachedMesh):this.gizmos.rotationGizmo&&(this.gizmos.rotationGizmo.attachedNode=null),this._gizmosEnabled.rotationGizmo=s},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"scaleGizmoEnabled",{get:function(){return this._gizmosEnabled.scaleGizmo},set:function(s){s?(this.gizmos.scaleGizmo=this.gizmos.scaleGizmo||new Se(this._defaultUtilityLayer,this._thickness,this),this._attachedNode?this.gizmos.scaleGizmo.attachedNode=this._attachedNode:this.gizmos.scaleGizmo.attachedMesh=this._attachedMesh):this.gizmos.scaleGizmo&&(this.gizmos.scaleGizmo.attachedNode=null),this._gizmosEnabled.scaleGizmo=s},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"boundingBoxGizmoEnabled",{get:function(){return this._gizmosEnabled.boundingBoxGizmo},set:function(s){s?(this.gizmos.boundingBoxGizmo=this.gizmos.boundingBoxGizmo||new ze(this._boundingBoxColor,this._defaultKeepDepthUtilityLayer),this._attachedMesh?this.gizmos.boundingBoxGizmo.attachedMesh=this._attachedMesh:this.gizmos.boundingBoxGizmo.attachedNode=this._attachedNode,this._attachedMesh?(this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh.addBehavior(this.boundingBoxDragBehavior)):this._attachedNode&&(this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode.addBehavior(this.boundingBoxDragBehavior))):this.gizmos.boundingBoxGizmo&&(this._attachedMesh?this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior):this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this.gizmos.boundingBoxGizmo.attachedNode=null),this._gizmosEnabled.boundingBoxGizmo=s},enumerable:!1,configurable:!0}),d.prototype.addToAxisCache=function(s){var e=this;s.size>0&&s.forEach(function(i,t){e._gizmoAxisCache.set(t,i)})},d.prototype.dispose=function(){var s=this,e,i;this._pointerObservers.forEach(function(n){s._scene.onPointerObservable.remove(n)});for(var t in this.gizmos){var o=this.gizmos[t];o&&o.dispose()}this._defaultKeepDepthUtilityLayer!==N._DefaultKeepDepthUtilityLayer&&((e=this._defaultKeepDepthUtilityLayer)===null||e===void 0||e.dispose()),this._defaultUtilityLayer!==N._DefaultUtilityLayer&&((i=this._defaultUtilityLayer)===null||i===void 0||i.dispose()),this.boundingBoxDragBehavior.detach(),this.onAttachedToMeshObservable.clear()},d})();(function(d){V(s,d);function s(e){e===void 0&&(e=N.DefaultUtilityLayer);var i=d.call(this,e)||this;return i._cachedPosition=new l,i._cachedForward=new l(0,0,1),i._pointerObserver=null,i.onClickedObservable=new S,i._light=null,i.attachedMesh=new k("",i.gizmoLayer.utilityLayerScene),i._attachedMeshParent=new ae("parent",i.gizmoLayer.utilityLayerScene),i.attachedMesh.parent=i._attachedMeshParent,i._material=new D("light",i.gizmoLayer.utilityLayerScene),i._material.diffuseColor=new m(.5,.5,.5),i._material.specularColor=new m(.1,.1,.1),i._pointerObserver=e.utilityLayerScene.onPointerObservable.add(function(t){!i._light||(i._isHovered=!!(t.pickInfo&&i._rootMesh.getChildMeshes().indexOf(t.pickInfo.pickedMesh)!=-1),i._isHovered&&t.event.button===0&&i.onClickedObservable.notifyObservers(i._light))},K.POINTERDOWN),i}return Object.defineProperty(s.prototype,"attachedNode",{get:function(){return this.attachedMesh},set:function(e){console.warn("Nodes cannot be attached to LightGizmo. Attach to a mesh instead.")},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"light",{get:function(){return this._light},set:function(e){var i=this;if(this._light=e,e){this._lightMesh&&this._lightMesh.dispose(),e instanceof ve?this._lightMesh=s._CreateHemisphericLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof Me?this._lightMesh=s._CreateDirectionalLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof be?this._lightMesh=s._CreateSpotLightMesh(this.gizmoLayer.utilityLayerScene):this._lightMesh=s._CreatePointLightMesh(this.gizmoLayer.utilityLayerScene),this._lightMesh.getChildMeshes(!1).forEach(function(o){o.material=i._material}),this._lightMesh.parent=this._rootMesh;var t=this.gizmoLayer._getSharedGizmoLight();t.includedOnlyMeshes=t.includedOnlyMeshes.concat(this._lightMesh.getChildMeshes(!1)),this._lightMesh.rotationQuaternion=new x,this.attachedMesh.reservedDataStore||(this.attachedMesh.reservedDataStore={}),this.attachedMesh.reservedDataStore.lightGizmo=this,e.parent&&this._attachedMeshParent.freezeWorldMatrix(e.parent.getWorldMatrix()),e.position&&(this.attachedMesh.position.copyFrom(e.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position)),e.direction&&(this.attachedMesh.setDirection(e.direction),this.attachedMesh.computeWorldMatrix(!0),this._cachedForward.copyFrom(this.attachedMesh.forward)),this._update()}},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"material",{get:function(){return this._material},enumerable:!1,configurable:!0}),s.prototype._update=function(){if(d.prototype._update.call(this),!!this._light){if(this._light.parent&&this._attachedMeshParent.freezeWorldMatrix(this._light.parent.getWorldMatrix()),this._light.position)if(this.attachedMesh.position.equals(this._cachedPosition))this.attachedMesh.position.copyFrom(this._light.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position);else{var e=this.attachedMesh.position;this._light.position=new l(e.x,e.y,e.z),this._cachedPosition.copyFrom(this.attachedMesh.position)}if(this._light.direction)if(l.DistanceSquared(this.attachedMesh.forward,this._cachedForward)>1e-4){var i=this.attachedMesh.forward;this._light.direction=new l(i.x,i.y,i.z),this._cachedForward.copyFrom(this.attachedMesh.forward)}else l.DistanceSquared(this.attachedMesh.forward,this._light.direction)>1e-4&&(this.attachedMesh.setDirection(this._light.direction),this.attachedMesh.computeWorldMatrix(!0),this._cachedForward.copyFrom(this.attachedMesh.forward))}},s.prototype.dispose=function(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this._material.dispose(),d.prototype.dispose.call(this),this._attachedMeshParent.dispose()},s._CreateHemisphericLightMesh=function(e){var i=new R("hemisphereLight",e),t=fe(i.name,{segments:10,diameter:1},e);t.position.z=-.15,t.rotation.x=Math.PI/2,t.parent=i;var o=this._CreateLightLines(3,e);return o.parent=i,i.scaling.scaleInPlace(s._Scale),i.rotation.x=Math.PI/2,i},s._CreatePointLightMesh=function(e){var i=new R("pointLight",e),t=ie(i.name,{segments:10,diameter:1},e);t.rotation.x=Math.PI/2,t.parent=i;var o=this._CreateLightLines(5,e);return o.parent=i,i.scaling.scaleInPlace(s._Scale),i.rotation.x=Math.PI/2,i},s._CreateSpotLightMesh=function(e){var i=new R("spotLight",e),t=ie(i.name,{segments:10,diameter:1},e);t.parent=i;var o=fe(i.name,{segments:10,diameter:2},e);o.parent=i,o.rotation.x=-Math.PI/2;var n=this._CreateLightLines(2,e);return n.parent=i,i.scaling.scaleInPlace(s._Scale),i.rotation.x=Math.PI/2,i},s._CreateDirectionalLightMesh=function(e){var i=new R("directionalLight",e),t=new R(i.name,e);t.parent=i;var o=ie(i.name,{diameter:1.2,segments:10},e);o.parent=t;var n=H(i.name,{updatable:!1,height:6,diameterTop:.3,diameterBottom:.3,tessellation:6,subdivisions:1},e);n.parent=t;var a=n.clone(i.name);a.scaling.y=.5,a.position.x+=1.25;var h=n.clone(i.name);h.scaling.y=.5,h.position.x+=-1.25;var r=H(i.name,{updatable:!1,height:1,diameterTop:0,diameterBottom:.6,tessellation:6,subdivisions:1},e);return r.position.y+=3,r.parent=t,a=r.clone(i.name),a.position.y=1.5,a.position.x+=1.25,h=r.clone(i.name),h.position.y=1.5,h.position.x+=-1.25,t.scaling.scaleInPlace(s._Scale),t.rotation.z=Math.PI/2,t.rotation.y=Math.PI/2,i},s._Scale=.007,s._CreateLightLines=function(e,i){var t=1.2,o=new R("root",i);o.rotation.x=Math.PI/2;var n=new R("linePivot",i);n.parent=o;var a=H("line",{updatable:!1,height:2,diameterTop:.2,diameterBottom:.3,tessellation:6,subdivisions:1},i);if(a.position.y=a.scaling.y/2+t,a.parent=n,e<2)return n;for(var h=0;h<4;h++){var r=n.clone("lineParentClone");r.rotation.z=Math.PI/4,r.rotation.y=Math.PI/2+Math.PI/2*h,r.getChildMeshes()[0].scaling.y=.5,r.getChildMeshes()[0].scaling.x=r.getChildMeshes()[0].scaling.z=.8,r.getChildMeshes()[0].position.y=r.getChildMeshes()[0].scaling.y/2+t}if(e<3)return o;for(var h=0;h<4;h++){var p=n.clone("linePivotClone");p.rotation.z=Math.PI/2,p.rotation.y=Math.PI/2*h}if(e<4)return o;for(var h=0;h<4;h++){var f=n.clone("linePivotClone");f.rotation.z=Math.PI+Math.PI/4,f.rotation.y=Math.PI/2+Math.PI/2*h,f.getChildMeshes()[0].scaling.y=.5,f.getChildMeshes()[0].scaling.x=f.getChildMeshes()[0].scaling.z=.8,f.getChildMeshes()[0].position.y=f.getChildMeshes()[0].scaling.y/2+t}if(e<5)return o;var g=n.clone("linePivotClone");return g.rotation.z=Math.PI,o},s})(b);(function(d){V(s,d);function s(e){e===void 0&&(e=N.DefaultUtilityLayer);var i=d.call(this,e)||this;return i._pointerObserver=null,i.onClickedObservable=new S,i._camera=null,i._invProjection=new F,i._material=new D("cameraGizmoMaterial",i.gizmoLayer.utilityLayerScene),i._material.diffuseColor=new m(.5,.5,.5),i._material.specularColor=new m(.1,.1,.1),i._pointerObserver=e.utilityLayerScene.onPointerObservable.add(function(t){!i._camera||(i._isHovered=!!(t.pickInfo&&i._rootMesh.getChildMeshes().indexOf(t.pickInfo.pickedMesh)!=-1),i._isHovered&&t.event.button===0&&i.onClickedObservable.notifyObservers(i._camera))},K.POINTERDOWN),i}return Object.defineProperty(s.prototype,"displayFrustum",{get:function(){return this._cameraLinesMesh.isEnabled()},set:function(e){this._cameraLinesMesh.setEnabled(e)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"camera",{get:function(){return this._camera},set:function(e){var i=this;if(this._camera=e,this.attachedNode=e,e){this._cameraMesh&&this._cameraMesh.dispose(),this._cameraLinesMesh&&this._cameraLinesMesh.dispose(),this._cameraMesh=s._CreateCameraMesh(this.gizmoLayer.utilityLayerScene),this._cameraLinesMesh=s._CreateCameraFrustum(this.gizmoLayer.utilityLayerScene),this._cameraMesh.getChildMeshes(!1).forEach(function(o){o.material=i._material}),this._cameraMesh.parent=this._rootMesh,this._cameraLinesMesh.parent=this._rootMesh,this.gizmoLayer.utilityLayerScene.activeCamera&&this.gizmoLayer.utilityLayerScene.activeCamera.maxZ<e.maxZ*1.5&&(this.gizmoLayer.utilityLayerScene.activeCamera.maxZ=e.maxZ*1.5),this.attachedNode.reservedDataStore||(this.attachedNode.reservedDataStore={}),this.attachedNode.reservedDataStore.cameraGizmo=this;var t=this.gizmoLayer._getSharedGizmoLight();t.includedOnlyMeshes=t.includedOnlyMeshes.concat(this._cameraMesh.getChildMeshes(!1)),this._update()}},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"material",{get:function(){return this._material},enumerable:!1,configurable:!0}),s.prototype._update=function(){d.prototype._update.call(this),this._camera&&(this._camera.getProjectionMatrix().invertToRef(this._invProjection),this._cameraLinesMesh.setPivotMatrix(this._invProjection,!1),this._cameraLinesMesh.scaling.x=1/this._rootMesh.scaling.x,this._cameraLinesMesh.scaling.y=1/this._rootMesh.scaling.y,this._cameraLinesMesh.scaling.z=1/this._rootMesh.scaling.z,this._cameraMesh.parent=null,this._cameraMesh.rotation.y=Math.PI*.5*(this._camera.getScene().useRightHandedSystem?1:-1),this._cameraMesh.parent=this._rootMesh)},s.prototype.dispose=function(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this._cameraMesh&&this._cameraMesh.dispose(),this._cameraLinesMesh&&this._cameraLinesMesh.dispose(),this._material.dispose(),d.prototype.dispose.call(this)},s._CreateCameraMesh=function(e){var i=new R("rootCameraGizmo",e),t=new R(i.name,e);t.parent=i;var o=J(i.name,{width:1,height:.8,depth:.5},e);o.parent=t;var n=H(i.name,{height:.5,diameterTop:.8,diameterBottom:.8},e);n.parent=t,n.position.y=.3,n.position.x=-.6,n.rotation.x=Math.PI*.5;var a=H(i.name,{height:.5,diameterTop:.6,diameterBottom:.6},e);a.parent=t,a.position.y=.5,a.position.x=.4,a.rotation.x=Math.PI*.5;var h=H(i.name,{height:.5,diameterTop:.5,diameterBottom:.5},e);return h.parent=t,h.position.y=0,h.position.x=.6,h.rotation.z=Math.PI*.5,i.scaling.scaleInPlace(s._Scale),t.position.x=-.9,i},s._CreateCameraFrustum=function(e){var i=new R("rootCameraGizmo",e),t=new R(i.name,e);t.parent=i;for(var o=0;o<4;o+=2)for(var n=0;n<4;n+=2){var a=E("lines",{points:[new l(-1+n,-1+o,-1),new l(-1+n,-1+o,1)]},e);a.parent=t,a.alwaysSelectAsActiveMesh=!0,a.isPickable=!1,a=E("lines",{points:[new l(-1,-1+n,-1+o),new l(1,-1+n,-1+o)]},e),a.parent=t,a.alwaysSelectAsActiveMesh=!0,a.isPickable=!1,a=E("lines",{points:[new l(-1+n,-1,-1+o),new l(-1+n,1,-1+o)]},e),a.parent=t,a.alwaysSelectAsActiveMesh=!0,a.isPickable=!1}return i},s._Scale=.05,s})(b);export{ne as A};
