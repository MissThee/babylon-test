import{b as k,a as v,_ as K}from"./tslibtslib.b6e59fa7.js";import{a as ee,_ as te,b as T,B as re,H as ie,O as x,S as G,R as X,L as se}from"./@babylonjscore_Misc.5aaba58d.js";import{b as L,V as M,C as ne}from"./@babylonjscore_Maths.4b8bfdd1.js";import{a as O,E as U}from"./@babylonjscore_Engines.77a493e8.js";import{V as d}from"./@babylonjscore_Buffers.c351261b.js";import{k as V,b as p,M as m,l as H,d as Q,m as oe}from"./@babylonjscore_Materials.d4538583.js";import"./@babylonjscore_Shaders.02c89b72.js";import{C as Y}from"./@babylonjscore_Cameras.05e2a1ea.js";import{S as g}from"./@babylonjscore_sceneComponent.5f0854c6.js";import{A as z}from"./@babylonjscore_abstractScene.a7cd866f.js";import{B as P,P as ae,b as ue}from"./@babylonjscore_PostProcesses.6391d89e.js";var W=function(){function n(e,t){this._vertexBuffers={},this._maxSize=0,this._mainTextureDesiredSize={width:0,height:0},this._shouldRender=!0,this._postProcesses=[],this._textures=[],this._emissiveTextureAndColor={texture:null,color:new L},this.neutralColor=new L,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new x,this.onBeforeRenderMainTextureObservable=new x,this.onBeforeComposeObservable=new x,this.onBeforeRenderMeshToEffect=new x,this.onAfterRenderMeshToEffect=new x,this.onAfterComposeObservable=new x,this.onSizeChangedObservable=new x,this._materialForRendering={},this.name=e,this._scene=t||U.LastCreatedScene,n._SceneComponentInitialization(this._scene),this._engine=this._scene.getEngine(),this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.effectLayers.push(this),this._mergeDrawWrapper=[],this._generateIndexBuffer(),this._generateVertexBuffer()}return Object.defineProperty(n.prototype,"camera",{get:function(){return this._effectLayerOptions.camera},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"renderingGroupId",{get:function(){return this._effectLayerOptions.renderingGroupId},set:function(e){this._effectLayerOptions.renderingGroupId=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"mainTexture",{get:function(){return this._mainTexture},enumerable:!1,configurable:!0}),n.prototype.setMaterialForRendering=function(e,t){if(this._mainTexture.setMaterialForRendering(e,t),Array.isArray(e))for(var r=0;r<e.length;++r){var i=e[r];t?this._materialForRendering[i.uniqueId]=[i,t]:delete this._materialForRendering[i.uniqueId]}else t?this._materialForRendering[e.uniqueId]=[e,t]:delete this._materialForRendering[e.uniqueId]},n.prototype._numInternalDraws=function(){return 1},n.prototype._init=function(e){this._effectLayerOptions=k({mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1},e),this._setMainTextureSize(),this._createMainTexture(),this._createTextureAndPostProcesses()},n.prototype._generateIndexBuffer=function(){var e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._engine.createIndexBuffer(e)},n.prototype._generateVertexBuffer=function(){var e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1);var t=new d(this._engine,e,d.PositionKind,!1,!1,2);this._vertexBuffers[d.PositionKind]=t},n.prototype._setMainTextureSize=function(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?O.GetExponentOfTwo(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?O.GetExponentOfTwo(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height),this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width),this._mainTextureDesiredSize.height=Math.floor(this._mainTextureDesiredSize.height)},n.prototype._createMainTexture=function(){var e=this;this._mainTexture=new V("EffectLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,!1,!0,0),this._mainTexture.activeCamera=this._effectLayerOptions.camera,this._mainTexture.wrapU=p.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=p.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode(p.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._mainTexture.ignoreCameraViewport=!0;for(var t in this._materialForRendering){var r=this._materialForRendering[t],i=r[0],s=r[1];this._mainTexture.setMaterialForRendering(i,s)}if(this._mainTexture.customIsReadyFunction=function(a,u){if(!a.isReady(!1))return!1;if(u===0&&a.subMeshes)for(var h=0;h<a.subMeshes.length;++h){var l=a.subMeshes[h],f=l.getMaterial(),_=l.getRenderingMesh();if(!!f){var E=_._getInstancesRenderList(l._id,!!l.getReplacementMesh()),S=E.hardwareInstancedRendering[l._id]||_.hasThinInstances;if(e._setEmissiveTextureAndColor(_,l,f),!e._isReady(l,S,e._emissiveTextureAndColor.texture))return!1}}return!0},this._mainTexture.customRenderFunction=function(a,u,h,l){e.onBeforeRenderMainTextureObservable.notifyObservers(e);var f,_=e._scene.getEngine();if(l.length){for(_.setColorWrite(!1),f=0;f<l.length;f++)e._renderSubMesh(l.data[f]);_.setColorWrite(!0)}for(f=0;f<a.length;f++)e._renderSubMesh(a.data[f]);for(f=0;f<u.length;f++)e._renderSubMesh(u.data[f]);var E=_.getAlphaMode();for(f=0;f<h.length;f++)e._renderSubMesh(h.data[f],!0);_.setAlphaMode(E)},this._mainTexture.onClearObservable.add(function(a){a.clear(e.neutralColor,!0,!0,!0)}),this._scene.getBoundingBoxRenderer){var o=this._scene.getBoundingBoxRenderer().enabled;this._mainTexture.onBeforeBindObservable.add(function(){e._scene.getBoundingBoxRenderer().enabled=!e.disableBoundingBoxesFromEffectLayer&&o}),this._mainTexture.onAfterUnbindObservable.add(function(){e._scene.getBoundingBoxRenderer().enabled=o})}},n.prototype._addCustomEffectDefines=function(e){},n.prototype._isReady=function(e,t,r){var i,s=this._scene.getEngine(),o=e.getMesh(),a=(i=o._internalAbstractMeshDataInfo._materialForRenderPass)===null||i===void 0?void 0:i[s.currentRenderPassId];if(a)return a.isReadyForSubMesh(o,e,t);var u=e.getMaterial();if(!u)return!1;if(this._useMeshMaterial(e.getRenderingMesh()))return u.isReadyForSubMesh(e.getMesh(),e,t);var h=[],l=[d.PositionKind],f=!1,_=!1;if(u){var E=u.needAlphaTesting(),S=u.getAlphaTestTexture(),w=S&&S.hasAlpha&&(u.useAlphaFromDiffuseTexture||u._useAlphaFromAlbedoTexture);S&&(E||w)&&(h.push("#define DIFFUSE"),o.isVerticesDataPresent(d.UV2Kind)&&S.coordinatesIndex===1?(h.push("#define DIFFUSEUV2"),_=!0):o.isVerticesDataPresent(d.UVKind)&&(h.push("#define DIFFUSEUV1"),f=!0),E&&(h.push("#define ALPHATEST"),h.push("#define ALPHATESTVALUE 0.4")),S.gammaSpace||h.push("#define DIFFUSE_ISLINEAR"));var R=u.opacityTexture;R&&(h.push("#define OPACITY"),o.isVerticesDataPresent(d.UV2Kind)&&R.coordinatesIndex===1?(h.push("#define OPACITYUV2"),_=!0):o.isVerticesDataPresent(d.UVKind)&&(h.push("#define OPACITYUV1"),f=!0))}r&&(h.push("#define EMISSIVE"),o.isVerticesDataPresent(d.UV2Kind)&&r.coordinatesIndex===1?(h.push("#define EMISSIVEUV2"),_=!0):o.isVerticesDataPresent(d.UVKind)&&(h.push("#define EMISSIVEUV1"),f=!0),r.gammaSpace||h.push("#define EMISSIVE_ISLINEAR")),o.useVertexColors&&o.isVerticesDataPresent(d.ColorKind)&&o.hasVertexAlpha&&u.transparencyMode!==m.MATERIAL_OPAQUE&&(l.push(d.ColorKind),h.push("#define VERTEXALPHA")),f&&(l.push(d.UVKind),h.push("#define UV1")),_&&(l.push(d.UV2Kind),h.push("#define UV2"));var b=new oe;if(o.useBones&&o.computeBonesUsingShaders){l.push(d.MatricesIndicesKind),l.push(d.MatricesWeightsKind),o.numBoneInfluencers>4&&(l.push(d.MatricesIndicesExtraKind),l.push(d.MatricesWeightsExtraKind)),h.push("#define NUM_BONE_INFLUENCERS "+o.numBoneInfluencers);var y=o.skeleton;y&&y.isUsingTextureForMatrices?h.push("#define BONETEXTURE"):h.push("#define BonesPerMesh "+(y?y.bones.length+1:0)),o.numBoneInfluencers>0&&b.addCPUSkinningFallback(0,o)}else h.push("#define NUM_BONE_INFLUENCERS 0");var c=o.morphTargetManager,A=0;c&&c.numInfluencers>0&&(h.push("#define MORPHTARGETS"),A=c.numInfluencers,h.push("#define NUM_MORPH_INFLUENCERS "+A),c.isUsingTextureForTargets&&h.push("#define MORPHTARGETS_TEXTURE"),H.PrepareAttributesForMorphTargetsInfluencers(l,o,A)),t&&(h.push("#define INSTANCES"),H.PushAttributesForInstances(l),e.getRenderingMesh().hasThinInstances&&h.push("#define THIN_INSTANCES")),this._addCustomEffectDefines(h);var I=e._getDrawWrapper(void 0,!0),B=I.defines,C=h.join(`
`);return B!==C&&I.setEffect(this._engine.createEffect("glowMapGeneration",l,["world","mBones","viewProjection","glowColor","morphTargetInfluences","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices"],["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],C,b,void 0,void 0,{maxSimultaneousMorphTargets:A}),C),I.effect.isReady()},n.prototype.render=function(){for(var e=0;e<this._postProcesses.length;e++)if(!this._postProcesses[e].isReady())return;for(var t=this._scene.getEngine(),r=this._numInternalDraws(),i=!0,e=0;e<r;++e){var s=this._mergeDrawWrapper[e];s||(s=this._mergeDrawWrapper[e]=new Q(this._engine),s.setEffect(this._createMergeEffect())),i=i&&s.effect.isReady()}if(!!i){this.onBeforeComposeObservable.notifyObservers(this);for(var o=t.getAlphaMode(),e=0;e<r;++e){var s=this._mergeDrawWrapper[e];t.enableEffect(s),t.setState(!1),t.bindBuffers(this._vertexBuffers,this._indexBuffer,s.effect),t.setAlphaMode(this._effectLayerOptions.alphaBlendingMode),this._internalRender(s.effect,e)}t.setAlphaMode(o),this.onAfterComposeObservable.notifyObservers(this);var a=this._mainTexture.getSize();this._setMainTextureSize(),(a.width!==this._mainTextureDesiredSize.width||a.height!==this._mainTextureDesiredSize.height)&&this._mainTextureDesiredSize.width!==0&&this._mainTextureDesiredSize.height!==0&&(this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses())}},n.prototype.hasMesh=function(e){return this.renderingGroupId===-1||e.renderingGroupId===this.renderingGroupId},n.prototype.shouldRender=function(){return this.isEnabled&&this._shouldRender},n.prototype._shouldRenderMesh=function(e){return!0},n.prototype._canRenderMesh=function(e,t){return!t.needAlphaBlendingForMesh(e)},n.prototype._shouldRenderEmissiveTextureForMesh=function(){return!0},n.prototype._renderSubMesh=function(e,t){var r,i;if(t===void 0&&(t=!1),!!this.shouldRender()){var s=e.getMaterial(),o=e.getMesh(),a=e.getReplacementMesh(),u=e.getRenderingMesh(),h=e.getEffectiveMesh(),l=this._scene,f=l.getEngine();if(h._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!!s&&!!this._canRenderMesh(u,s)){var _=(r=u.overrideMaterialSideOrientation)!==null&&r!==void 0?r:s.sideOrientation,E=h._getWorldMatrixDeterminant();E<0&&(_=_===m.ClockWiseSideOrientation?m.CounterClockWiseSideOrientation:m.ClockWiseSideOrientation);var S=_===m.ClockWiseSideOrientation;f.setState(s.backFaceCulling,s.zOffset,void 0,S,s.cullBackFaces,void 0,s.zOffsetUnits);var w=u._getInstancesRenderList(e._id,!!a);if(!w.mustReturn&&!!this._shouldRenderMesh(u)){var R=w.hardwareInstancedRendering[e._id]||u.hasThinInstances;if(this._setEmissiveTextureAndColor(u,e,s),this.onBeforeRenderMeshToEffect.notifyObservers(o),this._useMeshMaterial(u))u.render(e,R,a||void 0);else if(this._isReady(e,R,this._emissiveTextureAndColor.texture)){var b=(i=h._internalAbstractMeshDataInfo._materialForRenderPass)===null||i===void 0?void 0:i[f.currentRenderPassId],y=e._getDrawWrapper();if(!y&&b&&(y=b._getDrawWrapper()),!y)return;var c=y.effect;if(f.enableEffect(y),!R){var A=l.forcePointsCloud?m.PointFillMode:l.forceWireframe?m.WireFrameFillMode:s.fillMode;u._bind(e,c,A)}if(b?b.bindForSubMesh(h.getWorldMatrix(),h,e):(c.setMatrix("viewProjection",l.getTransformMatrix()),c.setMatrix("world",h.getWorldMatrix()),c.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a)),!b){var I=s.needAlphaTesting(),B=s.getAlphaTestTexture(),C=B&&B.hasAlpha&&(s.useAlphaFromDiffuseTexture||s._useAlphaFromAlbedoTexture);if(B&&(I||C)){c.setTexture("diffuseSampler",B);var D=B.getTextureMatrix();D&&c.setMatrix("diffuseMatrix",D)}var F=s.opacityTexture;if(F){c.setTexture("opacitySampler",F),c.setFloat("opacityIntensity",F.level);var D=F.getTextureMatrix();D&&c.setMatrix("opacityMatrix",D)}if(this._emissiveTextureAndColor.texture&&(c.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),c.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())),u.useBones&&u.computeBonesUsingShaders&&u.skeleton){var N=u.skeleton;if(N.isUsingTextureForMatrices){var q=N.getTransformMatrixTexture(u);if(!q)return;c.setTexture("boneSampler",q),c.setFloat("boneTextureWidth",4*(N.bones.length+1))}else c.setMatrices("mBones",N.getTransformMatrices(u))}H.BindMorphTargetParameters(u,c),u.morphTargetManager&&u.morphTargetManager.isUsingTextureForTargets&&u.morphTargetManager._bind(c),t&&f.setAlphaMode(s.alphaMode)}u._processRendering(h,e,c,s.fillMode,w,R,function(fe,$){return c.setMatrix("world",$)})}else this._mainTexture.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(o)}}}},n.prototype._useMeshMaterial=function(e){return!1},n.prototype._rebuild=function(){var e=this._vertexBuffers[d.PositionKind];e&&e._rebuild(),this._generateIndexBuffer()},n.prototype._disposeTextureAndPostProcesses=function(){this._mainTexture.dispose();for(var e=0;e<this._postProcesses.length;e++)this._postProcesses[e]&&this._postProcesses[e].dispose();this._postProcesses=[];for(var e=0;e<this._textures.length;e++)this._textures[e]&&this._textures[e].dispose();this._textures=[]},n.prototype.dispose=function(){var e=this._vertexBuffers[d.PositionKind];e&&(e.dispose(),this._vertexBuffers[d.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);for(var t=0,r=this._mergeDrawWrapper;t<r.length;t++){var i=r[t];i.dispose()}this._mergeDrawWrapper=[],this._disposeTextureAndPostProcesses();var s=this._scene.effectLayers.indexOf(this,0);s>-1&&this._scene.effectLayers.splice(s,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()},n.prototype.getClassName=function(){return"EffectLayer"},n.Parse=function(e,t,r){var i=ee.Instantiate(e.customType);return i.Parse(e,t,r)},n._SceneComponentInitialization=function(e){throw te("EffectLayerSceneComponent")},v([T()],n.prototype,"name",void 0),v([re()],n.prototype,"neutralColor",void 0),v([T()],n.prototype,"isEnabled",void 0),v([ie()],n.prototype,"camera",null),v([T()],n.prototype,"renderingGroupId",null),v([T()],n.prototype,"disableBoundingBoxesFromEffectLayer",void 0),n}();z.AddParser(g.NAME_EFFECTLAYER,function(n,e,t,r){if(n.effectLayers){t.effectLayers||(t.effectLayers=new Array);for(var i=0;i<n.effectLayers.length;i++){var s=W.Parse(n.effectLayers[i],e,r);t.effectLayers.push(s)}}});z.prototype.removeEffectLayer=function(n){var e=this.effectLayers.indexOf(n);return e!==-1&&this.effectLayers.splice(e,1),e};z.prototype.addEffectLayer=function(n){this.effectLayers.push(n)};var he=function(){function n(e){this.name=g.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=e||U.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine(),this.scene.effectLayers=new Array)}return n.prototype.register=function(){this.scene._isReadyForMeshStage.registerStep(g.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(g.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(g.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(g.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(g.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(g.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)},n.prototype.rebuild=function(){for(var e=this.scene.effectLayers,t=0,r=e;t<r.length;t++){var i=r[t];i._rebuild()}},n.prototype.serialize=function(e){e.effectLayers=[];for(var t=this.scene.effectLayers,r=0,i=t;r<i.length;r++){var s=i[r];s.serialize&&e.effectLayers.push(s.serialize())}},n.prototype.addFromContainer=function(e){var t=this;!e.effectLayers||e.effectLayers.forEach(function(r){t.scene.addEffectLayer(r)})},n.prototype.removeFromContainer=function(e,t){var r=this;!e.effectLayers||e.effectLayers.forEach(function(i){r.scene.removeEffectLayer(i),t&&i.dispose()})},n.prototype.dispose=function(){for(var e=this.scene.effectLayers;e.length;)e[0].dispose()},n.prototype._isReadyForMesh=function(e,t){for(var r=this._engine.currentRenderPassId,i=this.scene.effectLayers,s=0,o=i;s<o.length;s++){var a=o[s];if(!!a.hasMesh(e)){var u=a._mainTexture;this._engine.currentRenderPassId=u.renderPassId;for(var h=0,l=e.subMeshes;h<l.length;h++){var f=l[h];if(!a.isReady(f,t))return this._engine.currentRenderPassId=r,!1}}}return this._engine.currentRenderPassId=r,!0},n.prototype._renderMainTexture=function(e){this._renderEffects=!1,this._needStencil=!1;var t=!1,r=this.scene.effectLayers;if(r&&r.length>0){this._previousStencilState=this._engine.getStencilBuffer();for(var i=0,s=r;i<s.length;i++){var o=s[i];if(o.shouldRender()&&(!o.camera||o.camera.cameraRigMode===Y.RIG_MODE_NONE&&e===o.camera||o.camera.cameraRigMode!==Y.RIG_MODE_NONE&&o.camera._rigCameras.indexOf(e)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||o.needStencil();var a=o._mainTexture;a._shouldRender()&&(this.scene.incrementRenderId(),a.render(!1,!1),t=!0)}}this.scene.incrementRenderId()}return t},n.prototype._setStencil=function(){this._needStencil&&this._engine.setStencilBuffer(!0)},n.prototype._setStencilBack=function(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)},n.prototype._draw=function(e){if(this._renderEffects){this._engine.setDepthBuffer(!1);for(var t=this.scene.effectLayers,r=0;r<t.length;r++){var i=t[r];i.renderingGroupId===e&&i.shouldRender()&&i.render()}this._engine.setDepthBuffer(!0)}},n.prototype._drawCamera=function(){this._renderEffects&&this._draw(-1)},n.prototype._drawRenderingGroup=function(e){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(e)},n}();W._SceneComponentInitialization=function(n){var e=n._getComponent(g.NAME_EFFECTLAYER);e||(e=new he(n),n._addComponent(e))};z.prototype.getGlowLayerByName=function(n){for(var e=0;e<this.effectLayers.length;e++)if(this.effectLayers[e].name===n&&this.effectLayers[e].getEffectName()===J.EffectName)return this.effectLayers[e];return null};var J=function(n){K(e,n);function e(t,r,i){var s=n.call(this,t,r)||this;return s._intensity=1,s._includedOnlyMeshes=[],s._excludedMeshes=[],s._meshesUsingTheirOwnMaterials=[],s.neutralColor=new L(0,0,0,1),s._options=k({mainTextureRatio:e.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1},i),s._init({alphaBlendingMode:s._options.alphaBlendingMode,camera:s._options.camera,mainTextureFixedSize:s._options.mainTextureFixedSize,mainTextureRatio:s._options.mainTextureRatio,renderingGroupId:s._options.renderingGroupId}),s}return Object.defineProperty(e.prototype,"blurKernelSize",{get:function(){return this._horizontalBlurPostprocess1.kernel},set:function(t){this._horizontalBlurPostprocess1.kernel=t,this._verticalBlurPostprocess1.kernel=t,this._horizontalBlurPostprocess2.kernel=t,this._verticalBlurPostprocess2.kernel=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"intensity",{get:function(){return this._intensity},set:function(t){this._intensity=t},enumerable:!1,configurable:!0}),e.prototype.getEffectName=function(){return e.EffectName},e.prototype._createMergeEffect=function(){var t=`#define EMISSIVE 
`;return this._options.ldrMerge&&(t+=`#define LDR 
`),this._engine.createEffect("glowMapMerge",[d.PositionKind],["offset"],["textureSampler","textureSampler2"],t)},e.prototype._createTextureAndPostProcesses=function(){var t=this,r=this._mainTextureDesiredSize.width,i=this._mainTextureDesiredSize.height;r=this._engine.needPOTTextures?O.GetExponentOfTwo(r,this._maxSize):r,i=this._engine.needPOTTextures?O.GetExponentOfTwo(i,this._maxSize):i;var s=0;this._engine.getCaps().textureHalfFloatRender?s=2:s=0,this._blurTexture1=new V("GlowLayerBlurRTT",{width:r,height:i},this._scene,!1,!0,s),this._blurTexture1.wrapU=p.CLAMP_ADDRESSMODE,this._blurTexture1.wrapV=p.CLAMP_ADDRESSMODE,this._blurTexture1.updateSamplingMode(p.BILINEAR_SAMPLINGMODE),this._blurTexture1.renderParticles=!1,this._blurTexture1.ignoreCameraViewport=!0;var o=Math.floor(r/2),a=Math.floor(i/2);this._blurTexture2=new V("GlowLayerBlurRTT2",{width:o,height:a},this._scene,!1,!0,s),this._blurTexture2.wrapU=p.CLAMP_ADDRESSMODE,this._blurTexture2.wrapV=p.CLAMP_ADDRESSMODE,this._blurTexture2.updateSamplingMode(p.BILINEAR_SAMPLINGMODE),this._blurTexture2.renderParticles=!1,this._blurTexture2.ignoreCameraViewport=!0,this._textures=[this._blurTexture1,this._blurTexture2],this._horizontalBlurPostprocess1=new P("GlowLayerHBP1",new M(1,0),this._options.blurKernelSize/2,{width:r,height:i},null,p.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,s),this._horizontalBlurPostprocess1.width=r,this._horizontalBlurPostprocess1.height=i,this._horizontalBlurPostprocess1.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess1.onApplyObservable.add(function(u){u.setTexture("textureSampler",t._mainTexture)}),this._verticalBlurPostprocess1=new P("GlowLayerVBP1",new M(0,1),this._options.blurKernelSize/2,{width:r,height:i},null,p.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,s),this._horizontalBlurPostprocess2=new P("GlowLayerHBP2",new M(1,0),this._options.blurKernelSize/2,{width:o,height:a},null,p.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,s),this._horizontalBlurPostprocess2.width=o,this._horizontalBlurPostprocess2.height=a,this._horizontalBlurPostprocess2.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess2.onApplyObservable.add(function(u){u.setTexture("textureSampler",t._blurTexture1)}),this._verticalBlurPostprocess2=new P("GlowLayerVBP2",new M(0,1),this._options.blurKernelSize/2,{width:o,height:a},null,p.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,s),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1],this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._mainTexture.samples=this._options.mainTextureSamples,this._mainTexture.onAfterUnbindObservable.add(function(){var u=t._blurTexture1.renderTarget;if(u){t._scene.postProcessManager.directRender(t._postProcesses1,u,!0);var h=t._blurTexture2.renderTarget;h&&t._scene.postProcessManager.directRender(t._postProcesses2,h,!0),t._engine.unBindFramebuffer(h!=null?h:u,!0)}}),this._postProcesses.map(function(u){u.autoClear=!1})},e.prototype.isReady=function(t,r){var i=t.getMaterial(),s=t.getRenderingMesh();if(!i||!s)return!1;var o=i.emissiveTexture;return n.prototype._isReady.call(this,t,r,o)},e.prototype.needStencil=function(){return!1},e.prototype._canRenderMesh=function(t,r){return!0},e.prototype._internalRender=function(t){t.setTexture("textureSampler",this._blurTexture1),t.setTexture("textureSampler2",this._blurTexture2),t.setFloat("offset",this._intensity);var r=this._engine,i=r.getStencilBuffer();r.setStencilBuffer(!1),r.drawElementsType(m.TriangleFillMode,0,6),r.setStencilBuffer(i)},e.prototype._setEmissiveTextureAndColor=function(t,r,i){var s,o=1;if(this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(t,r,i):i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.texture&&(o=this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null,this.customEmissiveColorSelector)this.customEmissiveColorSelector(t,r,i,this._emissiveTextureAndColor.color);else if(i.emissiveColor){var a=(s=i.emissiveIntensity)!==null&&s!==void 0?s:1;o*=a,this._emissiveTextureAndColor.color.set(i.emissiveColor.r*o,i.emissiveColor.g*o,i.emissiveColor.b*o,i.alpha)}else this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)},e.prototype._shouldRenderMesh=function(t){return this.hasMesh(t)},e.prototype._addCustomEffectDefines=function(t){t.push("#define GLOW")},e.prototype.addExcludedMesh=function(t){this._excludedMeshes.indexOf(t.uniqueId)===-1&&this._excludedMeshes.push(t.uniqueId)},e.prototype.removeExcludedMesh=function(t){var r=this._excludedMeshes.indexOf(t.uniqueId);r!==-1&&this._excludedMeshes.splice(r,1)},e.prototype.addIncludedOnlyMesh=function(t){this._includedOnlyMeshes.indexOf(t.uniqueId)===-1&&this._includedOnlyMeshes.push(t.uniqueId)},e.prototype.removeIncludedOnlyMesh=function(t){var r=this._includedOnlyMeshes.indexOf(t.uniqueId);r!==-1&&this._includedOnlyMeshes.splice(r,1)},e.prototype.hasMesh=function(t){return n.prototype.hasMesh.call(this,t)?this._includedOnlyMeshes.length?this._includedOnlyMeshes.indexOf(t.uniqueId)!==-1:this._excludedMeshes.length?this._excludedMeshes.indexOf(t.uniqueId)===-1:!0:!1},e.prototype._useMeshMaterial=function(t){return this._meshesUsingTheirOwnMaterials.length==0?!1:this._meshesUsingTheirOwnMaterials.indexOf(t.uniqueId)>-1},e.prototype.referenceMeshToUseItsOwnMaterial=function(t){var r=this;t.resetDrawCache(this._mainTexture.renderPassId),this._meshesUsingTheirOwnMaterials.push(t.uniqueId),t.onDisposeObservable.add(function(){r._disposeMesh(t)})},e.prototype.unReferenceMeshFromUsingItsOwnMaterial=function(t){for(var r=this._meshesUsingTheirOwnMaterials.indexOf(t.uniqueId);r>=0;)this._meshesUsingTheirOwnMaterials.splice(r,1),r=this._meshesUsingTheirOwnMaterials.indexOf(t.uniqueId);t.resetDrawCache(this._mainTexture.renderPassId)},e.prototype._disposeMesh=function(t){this.removeIncludedOnlyMesh(t),this.removeExcludedMesh(t)},e.prototype.getClassName=function(){return"GlowLayer"},e.prototype.serialize=function(){var t=G.Serialize(this);t.customType="BABYLON.GlowLayer";var r;if(t.includedMeshes=[],this._includedOnlyMeshes.length)for(r=0;r<this._includedOnlyMeshes.length;r++){var i=this._scene.getMeshByUniqueId(this._includedOnlyMeshes[r]);i&&t.includedMeshes.push(i.id)}if(t.excludedMeshes=[],this._excludedMeshes.length)for(r=0;r<this._excludedMeshes.length;r++){var i=this._scene.getMeshByUniqueId(this._excludedMeshes[r]);i&&t.excludedMeshes.push(i.id)}return t},e.Parse=function(t,r,i){var s=G.Parse(function(){return new e(t.name,r,t.options)},t,r,i),o;for(o=0;o<t.excludedMeshes.length;o++){var a=r.getMeshById(t.excludedMeshes[o]);a&&s.addExcludedMesh(a)}for(o=0;o<t.includedMeshes.length;o++){var a=r.getMeshById(t.includedMeshes[o]);a&&s.addIncludedOnlyMesh(a)}return s},e.EffectName="GlowLayer",e.DefaultBlurKernelSize=32,e.DefaultTextureRatio=.5,v([T()],e.prototype,"blurKernelSize",null),v([T()],e.prototype,"intensity",null),v([T("options")],e.prototype,"_options",void 0),e}(W);X("BABYLON.GlowLayer",J);z.prototype.getHighlightLayerByName=function(n){for(var e,t=0;t<((e=this.effectLayers)===null||e===void 0?void 0:e.length);t++)if(this.effectLayers[t].name===n&&this.effectLayers[t].getEffectName()===Z.EffectName)return this.effectLayers[t];return null};var j=function(n){K(e,n);function e(t,r,i,s,o,a,u,h){a===void 0&&(a=p.BILINEAR_SAMPLINGMODE);var l=n.call(this,t,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,s,o,a,u,h)||this;return l.direction=r,l.kernel=i,l.onApplyObservable.add(function(f){f.setFloat2("screenSize",l.width,l.height),f.setVector2("direction",l.direction),f.setFloat("blurWidth",l.kernel)}),l}return e}(ue),Z=function(n){K(e,n);function e(t,r,i){var s=n.call(this,t,r)||this;return s.name=t,s.innerGlow=!0,s.outerGlow=!0,s.onBeforeBlurObservable=new x,s.onAfterBlurObservable=new x,s._instanceGlowingMeshStencilReference=e.GlowingMeshStencilReference++,s._meshes={},s._excludedMeshes={},s.neutralColor=e.NeutralColor,s._engine.isStencilEnable||se.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }"),s._options=k({mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1},i),s._init({alphaBlendingMode:s._options.alphaBlendingMode,camera:s._options.camera,mainTextureFixedSize:s._options.mainTextureFixedSize,mainTextureRatio:s._options.mainTextureRatio,renderingGroupId:s._options.renderingGroupId}),s._shouldRender=!1,s}return Object.defineProperty(e.prototype,"blurHorizontalSize",{get:function(){return this._horizontalBlurPostprocess.kernel},set:function(t){this._horizontalBlurPostprocess.kernel=t,this._options.blurHorizontalSize=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"blurVerticalSize",{get:function(){return this._verticalBlurPostprocess.kernel},set:function(t){this._verticalBlurPostprocess.kernel=t,this._options.blurVerticalSize=t},enumerable:!1,configurable:!0}),e.prototype.getEffectName=function(){return e.EffectName},e.prototype._numInternalDraws=function(){return 2},e.prototype._createMergeEffect=function(){return this._engine.createEffect("glowMapMerge",[d.PositionKind],["offset"],["textureSampler"],this._options.isStroke?`#define STROKE 
`:void 0)},e.prototype._createTextureAndPostProcesses=function(){var t=this,r=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,i=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;r=this._engine.needPOTTextures?O.GetExponentOfTwo(r,this._maxSize):r,i=this._engine.needPOTTextures?O.GetExponentOfTwo(i,this._maxSize):i;var s=0;this._engine.getCaps().textureHalfFloatRender?s=2:s=0,this._blurTexture=new V("HighlightLayerBlurRTT",{width:r,height:i},this._scene,!1,!0,s),this._blurTexture.wrapU=p.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=p.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode(p.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._blurTexture.ignoreCameraViewport=!0,this._textures=[this._blurTexture],this._options.alphaBlendingMode===2?(this._downSamplePostprocess=new ae("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,p.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._downSamplePostprocess.externalTextureSamplerBinding=!0,this._downSamplePostprocess.onApplyObservable.add(function(o){o.setTexture("textureSampler",t._mainTexture)}),this._horizontalBlurPostprocess=new j("HighlightLayerHBP",new M(1,0),this._options.blurHorizontalSize,1,null,p.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add(function(o){o.setFloat2("screenSize",r,i)}),this._verticalBlurPostprocess=new j("HighlightLayerVBP",new M(0,1),this._options.blurVerticalSize,1,null,p.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add(function(o){o.setFloat2("screenSize",r,i)}),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]):(this._horizontalBlurPostprocess=new P("HighlightLayerHBP",new M(1,0),this._options.blurHorizontalSize/2,{width:r,height:i},null,p.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,s),this._horizontalBlurPostprocess.width=r,this._horizontalBlurPostprocess.height=i,this._horizontalBlurPostprocess.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess.onApplyObservable.add(function(o){o.setTexture("textureSampler",t._mainTexture)}),this._verticalBlurPostprocess=new P("HighlightLayerVBP",new M(0,1),this._options.blurVerticalSize/2,{width:r,height:i},null,p.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,s),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]),this._mainTexture.onAfterUnbindObservable.add(function(){t.onBeforeBlurObservable.notifyObservers(t);var o=t._blurTexture.renderTarget;o&&(t._scene.postProcessManager.directRender(t._postProcesses,o,!0),t._engine.unBindFramebuffer(o,!0)),t.onAfterBlurObservable.notifyObservers(t)}),this._postProcesses.map(function(o){o.autoClear=!1})},e.prototype.needStencil=function(){return!0},e.prototype.isReady=function(t,r){var i=t.getMaterial(),s=t.getRenderingMesh();if(!i||!s||!this._meshes)return!1;var o=null,a=this._meshes[s.uniqueId];return a&&a.glowEmissiveOnly&&i&&(o=i.emissiveTexture),n.prototype._isReady.call(this,t,r,o)},e.prototype._internalRender=function(t,r){t.setTexture("textureSampler",this._blurTexture);var i=this._engine;i.cacheStencilState(),i.setStencilOperationPass(7681),i.setStencilOperationFail(7680),i.setStencilOperationDepthFail(7680),i.setStencilMask(0),i.setStencilBuffer(!0),i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&r===0&&(t.setFloat("offset",0),i.setStencilFunction(517),i.drawElementsType(m.TriangleFillMode,0,6)),this.innerGlow&&r===1&&(t.setFloat("offset",1),i.setStencilFunction(514),i.drawElementsType(m.TriangleFillMode,0,6)),i.restoreStencilState()},e.prototype.shouldRender=function(){return n.prototype.shouldRender.call(this)?!!this._meshes:!1},e.prototype._shouldRenderMesh=function(t){return!(this._excludedMeshes&&this._excludedMeshes[t.uniqueId]||!n.prototype.hasMesh.call(this,t))},e.prototype._canRenderMesh=function(t,r){return!0},e.prototype._addCustomEffectDefines=function(t){t.push("#define HIGHLIGHT")},e.prototype._setEmissiveTextureAndColor=function(t,r,i){var s=this._meshes[t.uniqueId];s?this._emissiveTextureAndColor.color.set(s.color.r,s.color.g,s.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),s&&s.glowEmissiveOnly&&i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=null},e.prototype.addExcludedMesh=function(t){if(!!this._excludedMeshes){var r=this._excludedMeshes[t.uniqueId];r||(this._excludedMeshes[t.uniqueId]={mesh:t,beforeBind:t.onBeforeBindObservable.add(function(i){i.getEngine().setStencilBuffer(!1)}),afterRender:t.onAfterRenderObservable.add(function(i){i.getEngine().setStencilBuffer(!0)})})}},e.prototype.removeExcludedMesh=function(t){if(!!this._excludedMeshes){var r=this._excludedMeshes[t.uniqueId];r&&(r.beforeBind&&t.onBeforeBindObservable.remove(r.beforeBind),r.afterRender&&t.onAfterRenderObservable.remove(r.afterRender)),this._excludedMeshes[t.uniqueId]=null}},e.prototype.hasMesh=function(t){return!this._meshes||!n.prototype.hasMesh.call(this,t)?!1:this._meshes[t.uniqueId]!==void 0&&this._meshes[t.uniqueId]!==null},e.prototype.addMesh=function(t,r,i){var s=this;if(i===void 0&&(i=!1),!!this._meshes){var o=this._meshes[t.uniqueId];o?o.color=r:(this._meshes[t.uniqueId]={mesh:t,color:r,observerHighlight:t.onBeforeBindObservable.add(function(a){s.isEnabled&&(s._excludedMeshes&&s._excludedMeshes[a.uniqueId]?s._defaultStencilReference(a):a.getScene().getEngine().setStencilFunctionReference(s._instanceGlowingMeshStencilReference))}),observerDefault:t.onAfterRenderObservable.add(function(a){s.isEnabled&&s._defaultStencilReference(a)}),glowEmissiveOnly:i},t.onDisposeObservable.add(function(){s._disposeMesh(t)})),this._shouldRender=!0}},e.prototype.removeMesh=function(t){if(!!this._meshes){var r=this._meshes[t.uniqueId];r&&(r.observerHighlight&&t.onBeforeBindObservable.remove(r.observerHighlight),r.observerDefault&&t.onAfterRenderObservable.remove(r.observerDefault),delete this._meshes[t.uniqueId]),this._shouldRender=!1;for(var i in this._meshes)if(this._meshes[i]){this._shouldRender=!0;break}}},e.prototype.removeAllMeshes=function(){if(!!this._meshes){for(var t in this._meshes)if(Object.prototype.hasOwnProperty.call(this._meshes,t)){var r=this._meshes[t];r&&this.removeMesh(r.mesh)}}},e.prototype._defaultStencilReference=function(t){t.getScene().getEngine().setStencilFunctionReference(e.NormalMeshStencilReference)},e.prototype._disposeMesh=function(t){this.removeMesh(t),this.removeExcludedMesh(t)},e.prototype.dispose=function(){if(this._meshes){for(var t in this._meshes){var r=this._meshes[t];r&&r.mesh&&(r.observerHighlight&&r.mesh.onBeforeBindObservable.remove(r.observerHighlight),r.observerDefault&&r.mesh.onAfterRenderObservable.remove(r.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(var t in this._excludedMeshes){var r=this._excludedMeshes[t];r&&(r.beforeBind&&r.mesh.onBeforeBindObservable.remove(r.beforeBind),r.afterRender&&r.mesh.onAfterRenderObservable.remove(r.afterRender))}this._excludedMeshes=null}n.prototype.dispose.call(this)},e.prototype.getClassName=function(){return"HighlightLayer"},e.prototype.serialize=function(){var t=G.Serialize(this);if(t.customType="BABYLON.HighlightLayer",t.meshes=[],this._meshes)for(var r in this._meshes){var i=this._meshes[r];i&&t.meshes.push({glowEmissiveOnly:i.glowEmissiveOnly,color:i.color.asArray(),meshId:i.mesh.id})}if(t.excludedMeshes=[],this._excludedMeshes)for(var s in this._excludedMeshes){var o=this._excludedMeshes[s];o&&t.excludedMeshes.push(o.mesh.id)}return t},e.Parse=function(t,r,i){var s=G.Parse(function(){return new e(t.name,r,t.options)},t,r,i),o;for(o=0;o<t.excludedMeshes.length;o++){var a=r.getMeshById(t.excludedMeshes[o]);a&&s.addExcludedMesh(a)}for(o=0;o<t.meshes.length;o++){var u=t.meshes[o],a=r.getMeshById(u.meshId);a&&s.addMesh(a,ne.FromArray(u.color),u.glowEmissiveOnly)}return s},e.EffectName="HighlightLayer",e.NeutralColor=new L(0,0,0,0),e.GlowingMeshStencilReference=2,e.NormalMeshStencilReference=1,v([T()],e.prototype,"innerGlow",void 0),v([T()],e.prototype,"outerGlow",void 0),v([T()],e.prototype,"blurHorizontalSize",null),v([T()],e.prototype,"blurVerticalSize",null),v([T("options")],e.prototype,"_options",void 0),e}(W);X("BABYLON.HighlightLayer",Z);var le=function(){function n(e){this.name=g.NAME_LAYER,this.scene=e||U.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine(),this.scene.layers=new Array)}return n.prototype.register=function(){this.scene._beforeCameraDrawStage.registerStep(g.STEP_BEFORECAMERADRAW_LAYER,this,this._drawCameraBackground),this.scene._afterCameraDrawStage.registerStep(g.STEP_AFTERCAMERADRAW_LAYER,this,this._drawCameraForeground),this.scene._beforeRenderTargetDrawStage.registerStep(g.STEP_BEFORERENDERTARGETDRAW_LAYER,this,this._drawRenderTargetBackground),this.scene._afterRenderTargetDrawStage.registerStep(g.STEP_AFTERRENDERTARGETDRAW_LAYER,this,this._drawRenderTargetForeground)},n.prototype.rebuild=function(){for(var e=this.scene.layers,t=0,r=e;t<r.length;t++){var i=r[t];i._rebuild()}},n.prototype.dispose=function(){for(var e=this.scene.layers;e.length;)e[0].dispose()},n.prototype._draw=function(e){var t=this.scene.layers;if(t.length){this._engine.setDepthBuffer(!1);for(var r=0,i=t;r<i.length;r++){var s=i[r];e(s)&&s.render()}this._engine.setDepthBuffer(!0)}},n.prototype._drawCameraPredicate=function(e,t,r){return!e.renderOnlyInRenderTargetTextures&&e.isBackground===t&&(e.layerMask&r)!==0},n.prototype._drawCameraBackground=function(e){var t=this;this._draw(function(r){return t._drawCameraPredicate(r,!0,e.layerMask)})},n.prototype._drawCameraForeground=function(e){var t=this;this._draw(function(r){return t._drawCameraPredicate(r,!1,e.layerMask)})},n.prototype._drawRenderTargetPredicate=function(e,t,r,i){return e.renderTargetTextures.length>0&&e.isBackground===t&&e.renderTargetTextures.indexOf(i)>-1&&(e.layerMask&r)!==0},n.prototype._drawRenderTargetBackground=function(e){var t=this;this._draw(function(r){return t._drawRenderTargetPredicate(r,!0,t.scene.activeCamera.layerMask,e)})},n.prototype._drawRenderTargetForeground=function(e){var t=this;this._draw(function(r){return t._drawRenderTargetPredicate(r,!1,t.scene.activeCamera.layerMask,e)})},n.prototype.addFromContainer=function(e){var t=this;!e.layers||e.layers.forEach(function(r){t.scene.layers.push(r)})},n.prototype.removeFromContainer=function(e,t){var r=this;t===void 0&&(t=!1),e.layers&&e.layers.forEach(function(i){var s=r.scene.layers.indexOf(i);s!==-1&&r.scene.layers.splice(s,1),t&&i.dispose()})},n}();(function(){function n(e,t,r,i,s){this.name=e,this.scale=new M(1,1),this.offset=new M(0,0),this.alphaBlendingMode=2,this.layerMask=268435455,this.renderTargetTextures=[],this.renderOnlyInRenderTargetTextures=!1,this.isEnabled=!0,this._vertexBuffers={},this.onDisposeObservable=new x,this.onBeforeRenderObservable=new x,this.onAfterRenderObservable=new x,this.texture=t?new p(t,r,!0):null,this.isBackground=i===void 0?!0:i,this.color=s===void 0?new L(1,1,1,1):s,this._scene=r||U.LastCreatedScene;var o=this._scene._getComponent(g.NAME_LAYER);o||(o=new le(this._scene),this._scene._addComponent(o)),this._scene.layers.push(this);var a=this._scene.getEngine();this._drawWrapper=new Q(a);var u=[];u.push(1,1),u.push(-1,1),u.push(-1,-1),u.push(1,-1);var h=new d(a,u,d.PositionKind,!1,!1,2);this._vertexBuffers[d.PositionKind]=h,this._createIndexBuffer()}return Object.defineProperty(n.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"onBeforeRender",{set:function(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"onAfterRender",{set:function(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)},enumerable:!1,configurable:!0}),n.prototype._createIndexBuffer=function(){var e=this._scene.getEngine(),t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)},n.prototype._rebuild=function(){var e=this._vertexBuffers[d.PositionKind];e&&e._rebuild(),this._createIndexBuffer()},n.prototype.render=function(){if(!!this.isEnabled){var e=this._scene.getEngine(),t="";this.alphaTest&&(t="#define ALPHATEST"),this.texture&&!this.texture.gammaSpace&&(t+=`\r
#define LINEAR`),this._previousDefines!==t&&(this._previousDefines=t,this._drawWrapper.effect=e.createEffect("layer",[d.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],t));var r=this._drawWrapper.effect;!r||!r.isReady()||!this.texture||!this.texture.isReady()||(this.onBeforeRenderObservable.notifyObservers(this),e.enableEffect(this._drawWrapper),e.setState(!1),r.setTexture("textureSampler",this.texture),r.setMatrix("textureMatrix",this.texture.getTextureMatrix()),r.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a),r.setVector2("offset",this.offset),r.setVector2("scale",this.scale),e.bindBuffers(this._vertexBuffers,this._indexBuffer,r),this.alphaTest?e.drawElementsType(m.TriangleFillMode,0,6):(e.setAlphaMode(this.alphaBlendingMode),e.drawElementsType(m.TriangleFillMode,0,6),e.setAlphaMode(0)),this.onAfterRenderObservable.notifyObservers(this))}},n.prototype.dispose=function(){var e=this._vertexBuffers[d.PositionKind];e&&(e.dispose(),this._vertexBuffers[d.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.texture&&(this.texture.dispose(),this.texture=null),this.renderTargetTextures=[];var t=this._scene.layers.indexOf(this);this._scene.layers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderObservable.clear()},n})();export{J as G};
