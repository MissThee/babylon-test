import{_ as I,a as p,b as ge}from"./tslibtslib.b6e59fa7.js";import{S as j,K as Q,b as g,e as me,G as Me,d as q,s as Se,_ as pe,O as H,M as Te,L as ye}from"./@babylonjscore_Misc.5aaba58d.js";import{h as z,a as u,C as J,M as m,A as Ee,V as ae,b as he}from"./@babylonjscore_Maths.4b8bfdd1.js";import{N as x}from"./@babylonjscore_node.47978260.js";import{U as Le,b as D,k as Z,d as be,l as U,m as ve}from"./@babylonjscore_Materials.d4538583.js";import{V as w}from"./@babylonjscore_Buffers.c351261b.js";import{B as ue,b as Pe}from"./@babylonjscore_PostProcesses.6391d89e.js";import{R as fe}from"./@babylonjscore_Rendering.1459be29.js";import"./@babylonjscore_Shaders.02c89b72.js";import{B as Ce}from"./@babylonjscore_Culling.bdb6ff26.js";import{E as we}from"./@babylonjscore_Engines.77a493e8.js";import{S as W}from"./@babylonjscore_sceneComponent.5f0854c6.js";import{A as De}from"./@babylonjscore_abstractScene.a7cd866f.js";var L=function(){function n(){}return n.CompareLightsPriority=function(t,e){return t.shadowEnabled!==e.shadowEnabled?(e.shadowEnabled?1:0)-(t.shadowEnabled?1:0):e.renderPriority-t.renderPriority},n.FALLOFF_DEFAULT=0,n.FALLOFF_PHYSICAL=1,n.FALLOFF_GLTF=2,n.FALLOFF_STANDARD=3,n.LIGHTMAP_DEFAULT=0,n.LIGHTMAP_SPECULAR=1,n.LIGHTMAP_SHADOWSONLY=2,n.INTENSITYMODE_AUTOMATIC=0,n.INTENSITYMODE_LUMINOUSPOWER=1,n.INTENSITYMODE_LUMINOUSINTENSITY=2,n.INTENSITYMODE_ILLUMINANCE=3,n.INTENSITYMODE_LUMINANCE=4,n.LIGHTTYPEID_POINTLIGHT=0,n.LIGHTTYPEID_DIRECTIONALLIGHT=1,n.LIGHTTYPEID_SPOTLIGHT=2,n.LIGHTTYPEID_HEMISPHERICLIGHT=3,n}(),A=function(n){I(t,n);function t(e,i){var s=n.call(this,e,i)||this;return s.diffuse=new J(1,1,1),s.specular=new J(1,1,1),s.falloffType=t.FALLOFF_DEFAULT,s.intensity=1,s._range=Number.MAX_VALUE,s._inverseSquaredRange=0,s._photometricScale=1,s._intensityMode=t.INTENSITYMODE_AUTOMATIC,s._radius=1e-5,s.renderPriority=0,s._shadowEnabled=!0,s._excludeWithLayerMask=0,s._includeOnlyWithLayerMask=0,s._lightmapMode=0,s._excludedMeshesIds=new Array,s._includedOnlyMeshesIds=new Array,s._isLight=!0,s.getScene().addLight(s),s._uniformBuffer=new Le(s.getScene().getEngine(),void 0,void 0,e),s._buildUniformLayout(),s.includedOnlyMeshes=new Array,s.excludedMeshes=new Array,s._resyncMeshes(),s}return Object.defineProperty(t.prototype,"range",{get:function(){return this._range},set:function(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"intensityMode",{get:function(){return this._intensityMode},set:function(e){this._intensityMode=e,this._computePhotometricScale()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"radius",{get:function(){return this._radius},set:function(e){this._radius=e,this._computePhotometricScale()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shadowEnabled",{get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"includedOnlyMeshes",{get:function(){return this._includedOnlyMeshes},set:function(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"excludedMeshes",{get:function(){return this._excludedMeshes},set:function(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"excludeWithLayerMask",{get:function(){return this._excludeWithLayerMask},set:function(e){this._excludeWithLayerMask=e,this._resyncMeshes()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"includeOnlyWithLayerMask",{get:function(){return this._includeOnlyWithLayerMask},set:function(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lightmapMode",{get:function(){return this._lightmapMode},set:function(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),t.prototype.transferTexturesToEffect=function(e,i){return this},t.prototype._bindLight=function(e,i,s,r,o){o===void 0&&(o=!0);var a=e.toString(),h=!1;if(this._uniformBuffer.bindToEffect(s,"Light"+a),this._renderId!==i.getRenderId()||this._lastUseSpecular!==r||!this._uniformBuffer.useUbo){this._renderId=i.getRenderId(),this._lastUseSpecular=r;var f=this.getScaledIntensity();this.transferToEffect(s,a),this.diffuse.scaleToRef(f,z.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",z.Color3[0],this.range,a),r&&(this.specular.scaleToRef(f,z.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",z.Color3[1],this.radius,a)),h=!0}if(this.transferTexturesToEffect(s,a),i.shadowsEnabled&&this.shadowEnabled&&o){var M=this.getShadowGenerator();M&&(M.bindShadowLight(a,s),h=!0)}h?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()},t.prototype.getClassName=function(){return"Light"},t.prototype.toString=function(e){var i="Name: "+this.name;if(i+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(var s=0;s<this.animations.length;s++)i+=", animation[0]: "+this.animations[s].toString(e);return i},t.prototype._syncParentEnabledState=function(){n.prototype._syncParentEnabledState.call(this),this.isDisposed()||this._resyncMeshes()},t.prototype.setEnabled=function(e){n.prototype.setEnabled.call(this,e),this._resyncMeshes()},t.prototype.getShadowGenerator=function(){return this._shadowGenerator},t.prototype.getAbsolutePosition=function(){return u.Zero()},t.prototype.canAffectMesh=function(e){return e?!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(e)===-1||this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1||this.includeOnlyWithLayerMask!==0&&(this.includeOnlyWithLayerMask&e.layerMask)===0||this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&e.layerMask):!0},t.prototype.dispose=function(e,i){if(i===void 0&&(i=!1),this._shadowGenerator&&(this._shadowGenerator.dispose(),this._shadowGenerator=null),this.getScene().stopAnimation(this),this._parentContainer){var s=this._parentContainer.lights.indexOf(this);s>-1&&this._parentContainer.lights.splice(s,1),this._parentContainer=null}for(var r=0,o=this.getScene().meshes;r<o.length;r++){var a=o[r];a._removeLightSource(this,!0)}this._uniformBuffer.dispose(),this.getScene().removeLight(this),n.prototype.dispose.call(this,e,i)},t.prototype.getTypeID=function(){return 0},t.prototype.getScaledIntensity=function(){return this._photometricScale*this.intensity},t.prototype.clone=function(e,i){i===void 0&&(i=null);var s=t.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!s)return null;var r=j.Clone(s,this);return e&&(r.name=e),i&&(r.parent=i),r.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(r),r},t.prototype.serialize=function(){var e=j.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach(function(i){e.excludedMeshesIds.push(i.id)})),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(function(i){e.includedOnlyMeshesIds.push(i.id)})),j.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e},t.GetConstructorFromName=function(e,i,s){var r=x.Construct("Light_Type_"+e,i,s);return r||null},t.Parse=function(e,i){var s=t.GetConstructorFromName(e.type,e.name,i);if(!s)return null;var r=j.Parse(s,e,i);if(e.excludedMeshesIds&&(r._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(r._includedOnlyMeshesIds=e.includedOnlyMeshesIds),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.falloffType!==void 0&&(r.falloffType=e.falloffType),e.lightmapMode!==void 0&&(r.lightmapMode=e.lightmapMode),e.animations){for(var o=0;o<e.animations.length;o++){var a=e.animations[o],h=Me("BABYLON.Animation");h&&r.animations.push(h.Parse(a))}x.ParseAnimationRanges(r,e,i)}return e.autoAnimate&&i.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&r.setEnabled(e.isEnabled),r},t.prototype._hookArrayForExcluded=function(e){var i=this,s=e.push;e.push=function(){for(var f=[],M=0;M<arguments.length;M++)f[M]=arguments[M];for(var d=s.apply(e,f),l=0,_=f;l<_.length;l++){var S=_[l];S._resyncLightSource(i)}return d};var r=e.splice;e.splice=function(f,M){for(var d=r.apply(e,[f,M]),l=0,_=d;l<_.length;l++){var S=_[l];S._resyncLightSource(i)}return d};for(var o=0,a=e;o<a.length;o++){var h=a[o];h._resyncLightSource(this)}},t.prototype._hookArrayForIncludedOnly=function(e){var i=this,s=e.push;e.push=function(){for(var o=[],a=0;a<arguments.length;a++)o[a]=arguments[a];var h=s.apply(e,o);return i._resyncMeshes(),h};var r=e.splice;e.splice=function(o,a){var h=r.apply(e,[o,a]);return i._resyncMeshes(),h},this._resyncMeshes()},t.prototype._resyncMeshes=function(){for(var e=0,i=this.getScene().meshes;e<i.length;e++){var s=i[e];s._resyncLightSource(this)}},t.prototype._markMeshesAsLightDirty=function(){for(var e=0,i=this.getScene().meshes;e<i.length;e++){var s=i[e];s.lightSources.indexOf(this)!==-1&&s._markSubMeshesAsLightDirty()}},t.prototype._computePhotometricScale=function(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()},t.prototype._getPhotometricScale=function(){var e=0,i=this.getTypeID(),s=this.intensityMode;switch(s===t.INTENSITYMODE_AUTOMATIC&&(i===t.LIGHTTYPEID_DIRECTIONALLIGHT?s=t.INTENSITYMODE_ILLUMINANCE:s=t.INTENSITYMODE_LUMINOUSINTENSITY),i){case t.LIGHTTYPEID_POINTLIGHT:case t.LIGHTTYPEID_SPOTLIGHT:switch(s){case t.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case t.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case t.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius;break}break;case t.LIGHTTYPEID_DIRECTIONALLIGHT:switch(s){case t.INTENSITYMODE_ILLUMINANCE:e=1;break;case t.INTENSITYMODE_LUMINANCE:{var r=this.radius;r=Math.max(r,.001);var o=2*Math.PI*(1-Math.cos(r));e=o;break}}break;case t.LIGHTTYPEID_HEMISPHERICLIGHT:e=1;break}return e},t.prototype._reorderLightsInScene=function(){var e=this.getScene();this._renderPriority!=0&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()},t.FALLOFF_DEFAULT=L.FALLOFF_DEFAULT,t.FALLOFF_PHYSICAL=L.FALLOFF_PHYSICAL,t.FALLOFF_GLTF=L.FALLOFF_GLTF,t.FALLOFF_STANDARD=L.FALLOFF_STANDARD,t.LIGHTMAP_DEFAULT=L.LIGHTMAP_DEFAULT,t.LIGHTMAP_SPECULAR=L.LIGHTMAP_SPECULAR,t.LIGHTMAP_SHADOWSONLY=L.LIGHTMAP_SHADOWSONLY,t.INTENSITYMODE_AUTOMATIC=L.INTENSITYMODE_AUTOMATIC,t.INTENSITYMODE_LUMINOUSPOWER=L.INTENSITYMODE_LUMINOUSPOWER,t.INTENSITYMODE_LUMINOUSINTENSITY=L.INTENSITYMODE_LUMINOUSINTENSITY,t.INTENSITYMODE_ILLUMINANCE=L.INTENSITYMODE_ILLUMINANCE,t.INTENSITYMODE_LUMINANCE=L.INTENSITYMODE_LUMINANCE,t.LIGHTTYPEID_POINTLIGHT=L.LIGHTTYPEID_POINTLIGHT,t.LIGHTTYPEID_DIRECTIONALLIGHT=L.LIGHTTYPEID_DIRECTIONALLIGHT,t.LIGHTTYPEID_SPOTLIGHT=L.LIGHTTYPEID_SPOTLIGHT,t.LIGHTTYPEID_HEMISPHERICLIGHT=L.LIGHTTYPEID_HEMISPHERICLIGHT,p([Q()],t.prototype,"diffuse",void 0),p([Q()],t.prototype,"specular",void 0),p([g()],t.prototype,"falloffType",void 0),p([g()],t.prototype,"intensity",void 0),p([g()],t.prototype,"range",null),p([g()],t.prototype,"intensityMode",null),p([g()],t.prototype,"radius",null),p([g()],t.prototype,"_renderPriority",void 0),p([me("_reorderLightsInScene")],t.prototype,"renderPriority",void 0),p([g("shadowEnabled")],t.prototype,"_shadowEnabled",void 0),p([g("excludeWithLayerMask")],t.prototype,"_excludeWithLayerMask",void 0),p([g("includeOnlyWithLayerMask")],t.prototype,"_includeOnlyWithLayerMask",void 0),p([g("lightmapMode")],t.prototype,"_lightmapMode",void 0),t}(x);x.AddNodeConstructor("Light_Type_3",function(n,t){return function(){return new Oe(n,u.Zero(),t)}});var Oe=function(n){I(t,n);function t(e,i,s){var r=n.call(this,e,s)||this;return r.groundColor=new J(0,0,0),r.direction=i||u.Up(),r}return t.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},t.prototype.getClassName=function(){return"HemisphericLight"},t.prototype.setDirectionToTarget=function(e){return this.direction=u.Normalize(e.subtract(u.Zero())),this.direction},t.prototype.getShadowGenerator=function(){return null},t.prototype.transferToEffect=function(e,i){var s=u.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",s.x,s.y,s.z,0,i),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),i),this},t.prototype.transferToNodeMaterialEffect=function(e,i){var s=u.Normalize(this.direction);return e.setFloat3(i,s.x,s.y,s.z),this},t.prototype.computeWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=m.Identity()),this._worldMatrix},t.prototype.getTypeID=function(){return A.LIGHTTYPEID_HEMISPHERICLIGHT},t.prototype.prepareLightSpecificDefines=function(e,i){e["HEMILIGHT"+i]=!0},p([Q()],t.prototype,"groundColor",void 0),p([q()],t.prototype,"direction",void 0),t}(A),$=function(n){I(t,n);function t(){var e=n!==null&&n.apply(this,arguments)||this;return e._needProjectionMatrixCompute=!0,e}return t.prototype._setPosition=function(e){this._position=e},Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(e){this._setPosition(e)},enumerable:!1,configurable:!0}),t.prototype._setDirection=function(e){this._direction=e},Object.defineProperty(t.prototype,"direction",{get:function(){return this._direction},set:function(e){this._setDirection(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shadowMinZ",{get:function(){return this._shadowMinZ},set:function(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shadowMaxZ",{get:function(){return this._shadowMaxZ},set:function(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),t.prototype.computeTransformedInformation=function(){return this.parent&&this.parent.getWorldMatrix?(this.transformedPosition||(this.transformedPosition=u.Zero()),u.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=u.Zero()),u.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0):!1},t.prototype.getDepthScale=function(){return 50},t.prototype.getShadowDirection=function(e){return this.transformedDirection?this.transformedDirection:this.direction},t.prototype.getAbsolutePosition=function(){return this.transformedPosition?this.transformedPosition:this.position},t.prototype.setDirectionToTarget=function(e){return this.direction=u.Normalize(e.subtract(this.position)),this.direction},t.prototype.getRotation=function(){this.direction.normalize();var e=u.Cross(this.direction,Ee.Y),i=u.Cross(e,this.direction);return u.RotationFromAxis(e,i,this.direction)},t.prototype.needCube=function(){return!1},t.prototype.needProjectionMatrixCompute=function(){return this._needProjectionMatrixCompute},t.prototype.forceProjectionMatrixCompute=function(){this._needProjectionMatrixCompute=!0},t.prototype._initCache=function(){n.prototype._initCache.call(this),this._cache.position=u.Zero()},t.prototype._isSynchronized=function(){return!!this._cache.position.equals(this.position)},t.prototype.computeWorldMatrix=function(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=m.Identity()),m.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)},t.prototype.getDepthMinZ=function(e){return this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ},t.prototype.getDepthMaxZ=function(e){return this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ},t.prototype.setShadowProjectionMatrix=function(e,i,s){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(i,s,e):this._setDefaultShadowProjectionMatrix(e,i,s),this},t.prototype._syncParentEnabledState=function(){n.prototype._syncParentEnabledState.call(this),(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition=null,this.transformedDirection=null)},p([q()],t.prototype,"position",null),p([q()],t.prototype,"direction",null),p([g()],t.prototype,"shadowMinZ",null),p([g()],t.prototype,"shadowMaxZ",null),t}(A);x.AddNodeConstructor("Light_Type_1",function(n,t){return function(){return new Ae(n,u.Zero(),t)}});var Ae=function(n){I(t,n);function t(e,i,s){var r=n.call(this,e,s)||this;return r._shadowFrustumSize=0,r._shadowOrthoScale=.1,r.autoUpdateExtends=!0,r.autoCalcShadowZBounds=!1,r._orthoLeft=Number.MAX_VALUE,r._orthoRight=Number.MIN_VALUE,r._orthoTop=Number.MIN_VALUE,r._orthoBottom=Number.MAX_VALUE,r.position=i.scale(-1),r.direction=i,r}return Object.defineProperty(t.prototype,"shadowFrustumSize",{get:function(){return this._shadowFrustumSize},set:function(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shadowOrthoScale",{get:function(){return this._shadowOrthoScale},set:function(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"orthoLeft",{get:function(){return this._orthoLeft},set:function(e){this._orthoLeft=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"orthoRight",{get:function(){return this._orthoRight},set:function(e){this._orthoRight=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"orthoTop",{get:function(){return this._orthoTop},set:function(e){this._orthoTop=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"orthoBottom",{get:function(){return this._orthoBottom},set:function(e){this._orthoBottom=e},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"DirectionalLight"},t.prototype.getTypeID=function(){return A.LIGHTTYPEID_DIRECTIONALLIGHT},t.prototype._setDefaultShadowProjectionMatrix=function(e,i,s){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,i,s)},t.prototype._setDefaultFixedFrustumShadowProjectionMatrix=function(e){var i=this.getScene().activeCamera;!i||m.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,this.shadowMinZ!==void 0?this.shadowMinZ:i.minZ,this.shadowMaxZ!==void 0?this.shadowMaxZ:i.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)},t.prototype._setDefaultAutoExtendShadowProjectionMatrix=function(e,i,s){var r=this.getScene().activeCamera;if(!!r){if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){var o=u.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE;for(var a=Number.MAX_VALUE,h=Number.MIN_VALUE,f=0;f<s.length;f++){var M=s[f];if(!!M)for(var d=M.getBoundingInfo(),l=d.boundingBox,_=0;_<l.vectorsWorld.length;_++)u.TransformCoordinatesToRef(l.vectorsWorld[_],i,o),o.x<this._orthoLeft&&(this._orthoLeft=o.x),o.y<this._orthoBottom&&(this._orthoBottom=o.y),o.x>this._orthoRight&&(this._orthoRight=o.x),o.y>this._orthoTop&&(this._orthoTop=o.y),this.autoCalcShadowZBounds&&(o.z<a&&(a=o.z),o.z>h&&(h=o.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=a,this._shadowMaxZ=h)}var S=this._orthoRight-this._orthoLeft,y=this._orthoTop-this._orthoBottom,E=this.shadowMinZ!==void 0?this.shadowMinZ:r.minZ,c=this.shadowMaxZ!==void 0?this.shadowMaxZ:r.maxZ,b=this.getScene().getEngine().useReverseDepthBuffer;m.OrthoOffCenterLHToRef(this._orthoLeft-S*this.shadowOrthoScale,this._orthoRight+S*this.shadowOrthoScale,this._orthoBottom-y*this.shadowOrthoScale,this._orthoTop+y*this.shadowOrthoScale,b?c:E,b?E:c,e,this.getScene().getEngine().isNDCHalfZRange)}},t.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},t.prototype.transferToEffect=function(e,i){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,i),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,i),this)},t.prototype.transferToNodeMaterialEffect=function(e,i){return this.computeTransformedInformation()?(e.setFloat3(i,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(i,this.direction.x,this.direction.y,this.direction.z),this)},t.prototype.getDepthMinZ=function(e){var i=this._scene.getEngine();return!i.useReverseDepthBuffer&&i.isNDCHalfZRange?0:1},t.prototype.getDepthMaxZ=function(e){var i=this._scene.getEngine();return i.useReverseDepthBuffer&&i.isNDCHalfZRange?0:1},t.prototype.prepareLightSpecificDefines=function(e,i){e["DIRLIGHT"+i]=!0},p([g()],t.prototype,"shadowFrustumSize",null),p([g()],t.prototype,"shadowOrthoScale",null),p([g()],t.prototype,"autoUpdateExtends",void 0),p([g()],t.prototype,"autoCalcShadowZBounds",void 0),p([g("orthoLeft")],t.prototype,"_orthoLeft",void 0),p([g("orthoRight")],t.prototype,"_orthoRight",void 0),p([g("orthoTop")],t.prototype,"_orthoTop",void 0),p([g("orthoBottom")],t.prototype,"_orthoBottom",void 0),t}($);x.AddNodeConstructor("Light_Type_2",function(n,t){return function(){return new xe(n,u.Zero(),u.Zero(),0,0,t)}});var xe=function(n){I(t,n);function t(e,i,s,r,o,a){var h=n.call(this,e,a)||this;return h._innerAngle=0,h._projectionTextureMatrix=m.Zero(),h._projectionTextureLightNear=1e-6,h._projectionTextureLightFar=1e3,h._projectionTextureUpDirection=u.Up(),h._projectionTextureViewLightDirty=!0,h._projectionTextureProjectionLightDirty=!0,h._projectionTextureDirty=!0,h._projectionTextureViewTargetVector=u.Zero(),h._projectionTextureViewLightMatrix=m.Zero(),h._projectionTextureProjectionLightMatrix=m.Zero(),h._projectionTextureScalingMatrix=m.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),h.position=i,h.direction=s,h.angle=r,h.exponent=o,h}return Object.defineProperty(t.prototype,"angle",{get:function(){return this._angle},set:function(e){this._angle=e,this._cosHalfAngle=Math.cos(e*.5),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"innerAngle",{get:function(){return this._innerAngle},set:function(e){this._innerAngle=e,this._computeAngleValues()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shadowAngleScale",{get:function(){return this._shadowAngleScale},set:function(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"projectionTextureMatrix",{get:function(){return this._projectionTextureMatrix},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"projectionTextureLightNear",{get:function(){return this._projectionTextureLightNear},set:function(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"projectionTextureLightFar",{get:function(){return this._projectionTextureLightFar},set:function(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"projectionTextureUpDirection",{get:function(){return this._projectionTextureUpDirection},set:function(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"projectionTexture",{get:function(){return this._projectionTexture},set:function(e){var i=this;this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(t._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(function(){i._markMeshesAsLightDirty()}):t._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(function(){i._markMeshesAsLightDirty()})))},enumerable:!1,configurable:!0}),t._IsProceduralTexture=function(e){return e.onGeneratedObservable!==void 0},t._IsTexture=function(e){return e.onLoadObservable!==void 0},Object.defineProperty(t.prototype,"projectionTextureProjectionLightMatrix",{get:function(){return this._projectionTextureProjectionLightMatrix},set:function(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"SpotLight"},t.prototype.getTypeID=function(){return A.LIGHTTYPEID_SPOTLIGHT},t.prototype._setDirection=function(e){n.prototype._setDirection.call(this,e),this._projectionTextureViewLightDirty=!0},t.prototype._setPosition=function(e){n.prototype._setPosition.call(this,e),this._projectionTextureViewLightDirty=!0},t.prototype._setDefaultShadowProjectionMatrix=function(e,i,s){var r=this.getScene().activeCamera;if(!!r){this._shadowAngleScale=this._shadowAngleScale||1;var o=this._shadowAngleScale*this._angle,a=this.shadowMinZ!==void 0?this.shadowMinZ:r.minZ,h=this.shadowMaxZ!==void 0?this.shadowMaxZ:r.maxZ,f=this.getScene().getEngine().useReverseDepthBuffer;m.PerspectiveFovLHToRef(o,1,f?h:a,f?a:h,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,f)}},t.prototype._computeProjectionTextureViewLightMatrix=function(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.position.addToRef(this.direction,this._projectionTextureViewTargetVector),m.LookAtLHToRef(this.position,this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)},t.prototype._computeProjectionTextureProjectionLightMatrix=function(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;var e=this.projectionTextureLightFar,i=this.projectionTextureLightNear,s=e/(e-i),r=-s*i,o=1/Math.tan(this._angle/2),a=1;m.FromValuesToRef(o/a,0,0,0,0,o,0,0,0,0,s,1,0,0,r,0,this._projectionTextureProjectionLightMatrix)},t.prototype._computeProjectionTextureMatrix=function(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof D){var e=this._projectionTexture.uScale/2,i=this._projectionTexture.vScale/2;m.FromValuesToRef(e,0,0,0,0,i,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)},t.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},t.prototype._computeAngleValues=function(){this._lightAngleScale=1/Math.max(.001,Math.cos(this._innerAngle*.5)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale},t.prototype.transferTexturesToEffect=function(e,i){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+i,this._projectionTextureMatrix),e.setTexture("projectionLightSampler"+i,this.projectionTexture)),this},t.prototype.transferToEffect=function(e,i){var s;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,i),s=u.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,i),s=u.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",s.x,s.y,s.z,this._cosHalfAngle,i),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,i),this},t.prototype.transferToNodeMaterialEffect=function(e,i){var s;return this.computeTransformedInformation()?s=u.Normalize(this.transformedDirection):s=u.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(i,-s.x,-s.y,-s.z):e.setFloat3(i,s.x,s.y,s.z),this},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._projectionTexture&&this._projectionTexture.dispose()},t.prototype.getDepthMinZ=function(e){var i=this._scene.getEngine(),s=this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ;return i.useReverseDepthBuffer&&i.isNDCHalfZRange?s:this._scene.getEngine().isNDCHalfZRange?0:s},t.prototype.getDepthMaxZ=function(e){var i=this._scene.getEngine(),s=this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ;return i.useReverseDepthBuffer&&i.isNDCHalfZRange?0:s},t.prototype.prepareLightSpecificDefines=function(e,i){e["SPOTLIGHT"+i]=!0,e["PROJECTEDLIGHTTEXTURE"+i]=!!(this.projectionTexture&&this.projectionTexture.isReady())},p([g()],t.prototype,"angle",null),p([g()],t.prototype,"innerAngle",null),p([g()],t.prototype,"shadowAngleScale",null),p([g()],t.prototype,"exponent",void 0),p([g()],t.prototype,"projectionTextureLightNear",null),p([g()],t.prototype,"projectionTextureLightFar",null),p([g()],t.prototype,"projectionTextureUpDirection",null),p([Se("projectedLightTexture")],t.prototype,"_projectionTexture",void 0),t}($),P=function(){function n(t,e,i){this.onBeforeShadowMapRenderObservable=new H,this.onAfterShadowMapRenderObservable=new H,this.onBeforeShadowMapRenderMeshObservable=new H,this.onAfterShadowMapRenderMeshObservable=new H,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=n.FILTER_NONE,this._filteringQuality=n.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this.forceBackFacesOnly=!1,this._lightDirection=u.Zero(),this._viewMatrix=m.Zero(),this._projectionMatrix=m.Zero(),this._transformMatrix=m.Zero(),this._cachedPosition=new u(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new u(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=m.Identity(),this._mapSize=t,this._light=e,this._scene=e.getScene(),e._shadowGenerator=this,this.id=e.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer('Scene for Shadow Generator (light "'.concat(this._light.name,'")')))),n._SceneComponentInitialization(this._scene);var s=this._scene.getEngine().getCaps();i?s.textureFloatRender&&s.textureFloatLinearFiltering?this._textureType=1:s.textureHalfFloatRender&&s.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:s.textureHalfFloatRender&&s.textureHalfFloatLinearFiltering?this._textureType=2:s.textureFloatRender&&s.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}return Object.defineProperty(n.prototype,"bias",{get:function(){return this._bias},set:function(t){this._bias=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"normalBias",{get:function(){return this._normalBias},set:function(t){this._normalBias=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"blurBoxOffset",{get:function(){return this._blurBoxOffset},set:function(t){this._blurBoxOffset!==t&&(this._blurBoxOffset=t,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"blurScale",{get:function(){return this._blurScale},set:function(t){this._blurScale!==t&&(this._blurScale=t,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"blurKernel",{get:function(){return this._blurKernel},set:function(t){this._blurKernel!==t&&(this._blurKernel=t,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"useKernelBlur",{get:function(){return this._useKernelBlur},set:function(t){this._useKernelBlur!==t&&(this._useKernelBlur=t,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"depthScale",{get:function(){return this._depthScale!==void 0?this._depthScale:this._light.getDepthScale()},set:function(t){this._depthScale=t},enumerable:!1,configurable:!0}),n.prototype._validateFilter=function(t){return t},Object.defineProperty(n.prototype,"filter",{get:function(){return this._filter},set:function(t){if(t=this._validateFilter(t),this._light.needCube()){if(t===n.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=!0;return}else if(t===n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=!0;return}else if(t===n.FILTER_PCF||t===n.FILTER_PCSS){this.usePoissonSampling=!0;return}}if((t===n.FILTER_PCF||t===n.FILTER_PCSS)&&!this._scene.getEngine()._features.supportShadowSamplers){this.usePoissonSampling=!0;return}this._filter!==t&&(this._filter=t,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"usePoissonSampling",{get:function(){return this.filter===n.FILTER_POISSONSAMPLING},set:function(t){var e=this._validateFilter(n.FILTER_POISSONSAMPLING);!t&&this.filter!==n.FILTER_POISSONSAMPLING||(this.filter=t?e:n.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"useExponentialShadowMap",{get:function(){return this.filter===n.FILTER_EXPONENTIALSHADOWMAP},set:function(t){var e=this._validateFilter(n.FILTER_EXPONENTIALSHADOWMAP);!t&&this.filter!==n.FILTER_EXPONENTIALSHADOWMAP||(this.filter=t?e:n.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"useBlurExponentialShadowMap",{get:function(){return this.filter===n.FILTER_BLUREXPONENTIALSHADOWMAP},set:function(t){var e=this._validateFilter(n.FILTER_BLUREXPONENTIALSHADOWMAP);!t&&this.filter!==n.FILTER_BLUREXPONENTIALSHADOWMAP||(this.filter=t?e:n.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"useCloseExponentialShadowMap",{get:function(){return this.filter===n.FILTER_CLOSEEXPONENTIALSHADOWMAP},set:function(t){var e=this._validateFilter(n.FILTER_CLOSEEXPONENTIALSHADOWMAP);!t&&this.filter!==n.FILTER_CLOSEEXPONENTIALSHADOWMAP||(this.filter=t?e:n.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"useBlurCloseExponentialShadowMap",{get:function(){return this.filter===n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP},set:function(t){var e=this._validateFilter(n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);!t&&this.filter!==n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP||(this.filter=t?e:n.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"usePercentageCloserFiltering",{get:function(){return this.filter===n.FILTER_PCF},set:function(t){var e=this._validateFilter(n.FILTER_PCF);!t&&this.filter!==n.FILTER_PCF||(this.filter=t?e:n.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"filteringQuality",{get:function(){return this._filteringQuality},set:function(t){this._filteringQuality!==t&&(this._filteringQuality=t,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"useContactHardeningShadow",{get:function(){return this.filter===n.FILTER_PCSS},set:function(t){var e=this._validateFilter(n.FILTER_PCSS);!t&&this.filter!==n.FILTER_PCSS||(this.filter=t?e:n.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"contactHardeningLightSizeUVRatio",{get:function(){return this._contactHardeningLightSizeUVRatio},set:function(t){this._contactHardeningLightSizeUVRatio=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"darkness",{get:function(){return this._darkness},set:function(t){this.setDarkness(t)},enumerable:!1,configurable:!0}),n.prototype.getDarkness=function(){return this._darkness},n.prototype.setDarkness=function(t){return t>=1?this._darkness=1:t<=0?this._darkness=0:this._darkness=t,this},Object.defineProperty(n.prototype,"transparencyShadow",{get:function(){return this._transparencyShadow},set:function(t){this.setTransparencyShadow(t)},enumerable:!1,configurable:!0}),n.prototype.setTransparencyShadow=function(t){return this._transparencyShadow=t,this},n.prototype.getShadowMap=function(){return this._shadowMap},n.prototype.getShadowMapForRendering=function(){return this._shadowMap2?this._shadowMap2:this._shadowMap},n.prototype.getClassName=function(){return n.CLASSNAME},n.prototype.addShadowCaster=function(t,e){if(e===void 0&&(e=!0),!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),this._shadowMap.renderList.indexOf(t)===-1&&this._shadowMap.renderList.push(t),e)for(var i=0,s=t.getChildMeshes();i<s.length;i++){var r=s[i];this._shadowMap.renderList.indexOf(r)===-1&&this._shadowMap.renderList.push(r)}return this},n.prototype.removeShadowCaster=function(t,e){if(e===void 0&&(e=!0),!this._shadowMap||!this._shadowMap.renderList)return this;var i=this._shadowMap.renderList.indexOf(t);if(i!==-1&&this._shadowMap.renderList.splice(i,1),e)for(var s=0,r=t.getChildren();s<r.length;s++){var o=r[s];this.removeShadowCaster(o)}return this},n.prototype.getLight=function(){return this._light},Object.defineProperty(n.prototype,"mapSize",{get:function(){return this._mapSize},set:function(t){this._mapSize=t,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()},enumerable:!1,configurable:!0}),n.prototype._initializeGenerator=function(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()},n.prototype._createTargetRenderTexture=function(){var t=this._scene.getEngine();t._features.supportDepthStencilTexture?(this._shadowMap=new Z(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1),this._shadowMap.createDepthStencilTexture(t.useReverseDepthBuffer?516:513,!0)):this._shadowMap=new Z(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube())},n.prototype._initializeShadowMap=function(){var t=this;if(this._createTargetRenderTexture(),this._shadowMap!==null){this._shadowMap.wrapU=D.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=D.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(D.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=this._renderForShadowMap.bind(this),this._shadowMap.customIsReadyFunction=function(){return!0};var e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(function(){var o;t._currentSceneUBO=t._scene.getSceneUniformBuffer(),(o=e._debugPushGroup)===null||o===void 0||o.call(e,"shadow map generation for pass id ".concat(e.currentRenderPassId),1)}),this._shadowMap.onBeforeRenderObservable.add(function(o){t._sceneUBOs&&t._scene.setSceneUniformBuffer(t._sceneUBOs[0]),t._currentFaceIndex=o,t._filter===n.FILTER_PCF&&e.setColorWrite(!1),t.getTransformMatrix(),t._scene.setTransformMatrix(t._viewMatrix,t._projectionMatrix),t._useUBO&&(t._scene.getSceneUniformBuffer().unbindEffect(),t._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(function(){var o,a;if(t._sceneUBOs&&t._scene.setSceneUniformBuffer(t._currentSceneUBO),t._scene.updateTransformMatrix(),t._filter===n.FILTER_PCF&&e.setColorWrite(!0),!t.useBlurExponentialShadowMap&&!t.useBlurCloseExponentialShadowMap){(o=e._debugPopGroup)===null||o===void 0||o.call(e,1);return}var h=t.getShadowMapForRendering();h&&(t._scene.postProcessManager.directRender(t._blurPostProcesses,h.renderTarget,!0),e.unBindFramebuffer(h.renderTarget,!0),(a=e._debugPopGroup)===null||a===void 0||a.call(e,1))});var i=new he(0,0,0,0),s=new he(1,1,1,1);this._shadowMap.onClearObservable.add(function(o){t._filter===n.FILTER_PCF?o.clear(s,!1,!0,!1):t.useExponentialShadowMap||t.useBlurExponentialShadowMap?o.clear(i,!0,!0,!1):o.clear(s,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(function(o){t._storedUniqueId=t._shadowMap.uniqueId,t._mapSize=o.getRenderSize(),t._light._markMeshesAsLightDirty(),t.recreateShadowMap()});for(var r=fe.MIN_RENDERINGGROUPS;r<fe.MAX_RENDERINGGROUPS;r++)this._shadowMap.setRenderingAutoClearDepthStencil(r,!1)}},n.prototype._initializeBlurRTTAndPostProcesses=function(){var t=this,e=this._scene.getEngine(),i=this._mapSize/this.blurScale;(!this.useKernelBlur||this.blurScale!==1)&&(this._shadowMap2=new Z(this._light.name+"_shadowMap2",i,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=D.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=D.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(D.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new ue(this._light.name+"KernelBlurX",new ae(1,0),this.blurKernel,1,null,D.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=i,this._kernelBlurXPostprocess.height=i,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(function(s){s.setTexture("textureSampler",t._shadowMap)}),this._kernelBlurYPostprocess=new ue(this._light.name+"KernelBlurY",new ae(0,1),this.blurKernel,1,null,D.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,this._textureType===0&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new Pe(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,D.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(function(s){s.setFloat2("screenSize",i,i),s.setTexture("textureSampler",t._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])},n.prototype._renderForShadowMap=function(t,e,i,s){var r;if(s.length)for(r=0;r<s.length;r++)this._renderSubMeshForShadowMap(s.data[r]);for(r=0;r<t.length;r++)this._renderSubMeshForShadowMap(t.data[r]);for(r=0;r<e.length;r++)this._renderSubMeshForShadowMap(e.data[r]);if(this._transparencyShadow)for(r=0;r<i.length;r++)this._renderSubMeshForShadowMap(i.data[r],!0);else for(r=0;r<i.length;r++)i.data[r].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1},n.prototype._bindCustomEffectForRenderSubMeshForShadowMap=function(t,e,i){e.setMatrix("viewProjection",this.getTransformMatrix())},n.prototype._renderSubMeshForShadowMap=function(t,e){var i,s;e===void 0&&(e=!1);var r=t.getRenderingMesh(),o=t.getEffectiveMesh(),a=this._scene,h=a.getEngine(),f=t.getMaterial();if(o._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!(!f||t.verticesCount===0||t._renderId===a.getRenderId())){var M=o._getWorldMatrixDeterminant()<0,d=(i=r.overrideMaterialSideOrientation)!==null&&i!==void 0?i:f.sideOrientation;M&&(d=d===0?1:0);var l=d===0;h.setState(f.backFaceCulling,void 0,void 0,l,f.cullBackFaces);var _=r._getInstancesRenderList(t._id,!!t.getReplacementMesh());if(!_.mustReturn){var S=h.getCaps().instancedArrays&&(_.visibleInstances[t._id]!==null&&_.visibleInstances[t._id]!==void 0||r.hasThinInstances);if(!(this.customAllowRendering&&!this.customAllowRendering(t)))if(this.isReady(t,S,e)){t._renderId=a.getRenderId();var y=f.shadowDepthWrapper,E=(s=y==null?void 0:y.getEffect(t,this,h.currentRenderPassId))!==null&&s!==void 0?s:t._getDrawWrapper(),c=be.GetEffect(E);if(h.enableEffect(E),S||r._bind(t,c,f.fillMode),this.getTransformMatrix(),c.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===A.LIGHTTYPEID_DIRECTIONALLIGHT?c.setVector3("lightDataSM",this._cachedDirection):c.setVector3("lightDataSM",this._cachedPosition),a.activeCamera&&c.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(a.activeCamera),this.getLight().getDepthMinZ(a.activeCamera)+this.getLight().getDepthMaxZ(a.activeCamera)),e&&this.enableSoftTransparentShadow&&c.setFloat("softTransparentShadowSM",o.visibility*f.alpha),y)t._setMainDrawWrapperOverride(E),y.standalone?y.baseMaterial.bindForSubMesh(o.getWorldMatrix(),r,t):f.bindForSubMesh(o.getWorldMatrix(),r,t),t._setMainDrawWrapperOverride(null);else{if(f&&this.useOpacityTextureForTransparentShadow){var b=f.opacityTexture;b&&(c.setTexture("diffuseSampler",b),c.setMatrix("diffuseMatrix",b.getTextureMatrix()||this._defaultTextureMatrix))}else if(f&&f.needAlphaTesting()){var v=f.getAlphaTestTexture();v&&(c.setTexture("diffuseSampler",v),c.setMatrix("diffuseMatrix",v.getTextureMatrix()||this._defaultTextureMatrix))}if(r.useBones&&r.computeBonesUsingShaders&&r.skeleton){var C=r.skeleton;if(C.isUsingTextureForMatrices){var O=C.getTransformMatrixTexture(r);if(!O)return;c.setTexture("boneSampler",O),c.setFloat("boneTextureWidth",4*(C.bones.length+1))}else c.setMatrices("mBones",C.getTransformMatrices(r))}U.BindMorphTargetParameters(r,c),r.morphTargetManager&&r.morphTargetManager.isUsingTextureForTargets&&r.morphTargetManager._bind(c),U.BindClipPlane(c,a)}!this._useUBO&&!y&&this._bindCustomEffectForRenderSubMeshForShadowMap(t,c,o),U.BindSceneUniformBuffer(c,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();var N=o.getWorldMatrix();S&&(o.getMeshUniformBuffer().bindToEffect(c,"Mesh"),o.transferToEffect(N)),this.forceBackFacesOnly&&h.setState(!0,0,!1,!0,f.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(r),this.onBeforeShadowMapRenderObservable.notifyObservers(c),r._processRendering(o,t,c,f.fillMode,_,S,function(B,R){o!==r&&!B?(r.getMeshUniformBuffer().bindToEffect(c,"Mesh"),r.transferToEffect(R)):(o.getMeshUniformBuffer().bindToEffect(c,"Mesh"),o.transferToEffect(B?R:N))}),this.forceBackFacesOnly&&h.setState(!0,0,!1,!1,f.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(c),this.onAfterShadowMapRenderMeshObservable.notifyObservers(r)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}}},n.prototype._applyFilterValues=function(){!this._shadowMap||(this.filter===n.FILTER_NONE||this.filter===n.FILTER_PCSS?this._shadowMap.updateSamplingMode(D.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(D.BILINEAR_SAMPLINGMODE))},n.prototype.forceCompilation=function(t,e){var i=this,s=ge({useInstances:!1},e),r=this.getShadowMap();if(!r){t&&t(this);return}var o=r.renderList;if(!o){t&&t(this);return}for(var a=new Array,h=0,f=o;h<f.length;h++){var M=f[h];a.push.apply(a,M.subMeshes)}if(a.length===0){t&&t(this);return}var d=0,l=function(){var _,S;if(!(!i._scene||!i._scene.getEngine())){for(;i.isReady(a[d],s.useInstances,(S=(_=a[d].getMaterial())===null||_===void 0?void 0:_.needAlphaBlendingForMesh(a[d].getMesh()))!==null&&S!==void 0?S:!1);)if(d++,d>=a.length){t&&t(i);return}setTimeout(l,16)}};l()},n.prototype.forceCompilationAsync=function(t){var e=this;return new Promise(function(i){e.forceCompilation(function(){i()},t)})},n.prototype._isReadyCustomDefines=function(t,e,i){},n.prototype._prepareShadowDefines=function(t,e,i,s){i.push("#define SM_FLOAT "+(this._textureType!==0?"1":"0")),i.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),i.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));var r=t.getMesh();return i.push("#define SM_NORMALBIAS "+(this.normalBias&&r.isVerticesDataPresent(w.NormalKind)?"1":"0")),i.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===A.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),i.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),i.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&s?"1":"0")),this._isReadyCustomDefines(i,t,e),i},n.prototype.isReady=function(t,e,i){var s,r=t.getMaterial(),o=r==null?void 0:r.shadowDepthWrapper,a=[];if(this._prepareShadowDefines(t,e,a,i),o){if(!o.isReadyForSubMesh(t,a,this,e,this._scene.getEngine().currentRenderPassId))return!1}else{var h=t._getDrawWrapper(void 0,!0),f=h.effect,M=h.defines,d=[w.PositionKind],l=t.getMesh();if(this.normalBias&&l.isVerticesDataPresent(w.NormalKind)&&(d.push(w.NormalKind),a.push("#define NORMAL"),l.nonUniformScaling&&a.push("#define NONUNIFORMSCALING")),r&&r.needAlphaTesting()){var _=null;if(this.useOpacityTextureForTransparentShadow?_=r.opacityTexture:_=r.getAlphaTestTexture(),_){if(!_.isReady())return!1;var S=(s=r.alphaCutOff)!==null&&s!==void 0?s:n.DEFAULT_ALPHA_CUTOFF;a.push("#define ALPHATEST"),a.push("#define ALPHATESTVALUE ".concat(S).concat(S%1===0?".":"")),l.isVerticesDataPresent(w.UVKind)&&(d.push(w.UVKind),a.push("#define UV1")),l.isVerticesDataPresent(w.UV2Kind)&&_.coordinatesIndex===1&&(d.push(w.UV2Kind),a.push("#define UV2"))}}var y=new ve;if(l.useBones&&l.computeBonesUsingShaders&&l.skeleton){d.push(w.MatricesIndicesKind),d.push(w.MatricesWeightsKind),l.numBoneInfluencers>4&&(d.push(w.MatricesIndicesExtraKind),d.push(w.MatricesWeightsExtraKind));var E=l.skeleton;a.push("#define NUM_BONE_INFLUENCERS "+l.numBoneInfluencers),l.numBoneInfluencers>0&&y.addCPUSkinningFallback(0,l),E.isUsingTextureForMatrices?a.push("#define BONETEXTURE"):a.push("#define BonesPerMesh "+(E.bones.length+1))}else a.push("#define NUM_BONE_INFLUENCERS 0");var c=l.morphTargetManager,b=0;c&&c.numInfluencers>0&&(a.push("#define MORPHTARGETS"),b=c.numInfluencers,a.push("#define NUM_MORPH_INFLUENCERS "+b),c.isUsingTextureForTargets&&a.push("#define MORPHTARGETS_TEXTURE"),U.PrepareAttributesForMorphTargetsInfluencers(d,l,b));var v=this._scene;if(v.clipPlane&&a.push("#define CLIPPLANE"),v.clipPlane2&&a.push("#define CLIPPLANE2"),v.clipPlane3&&a.push("#define CLIPPLANE3"),v.clipPlane4&&a.push("#define CLIPPLANE4"),v.clipPlane5&&a.push("#define CLIPPLANE5"),v.clipPlane6&&a.push("#define CLIPPLANE6"),e&&(a.push("#define INSTANCES"),U.PushAttributesForInstances(d),t.getRenderingMesh().hasThinInstances&&a.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(var C=0,O=this.customShaderOptions.defines;C<O.length;C++){var N=O[C];a.indexOf(N)===-1&&a.push(N)}var B=a.join(`
`);if(M!==B){M=B;var R="shadowMap",V=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","boneTextureWidth","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices"],Y=["diffuseSampler","boneSampler","morphTargets"],_e=["Scene","Mesh"];if(this.customShaderOptions){if(R=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(var G=0,ee=this.customShaderOptions.attributes;G<ee.length;G++){var te=ee[G];d.indexOf(te)===-1&&d.push(te)}if(this.customShaderOptions.uniforms)for(var X=0,ie=this.customShaderOptions.uniforms;X<ie.length;X++){var re=ie[X];V.indexOf(re)===-1&&V.push(re)}if(this.customShaderOptions.samplers)for(var K=0,se=this.customShaderOptions.samplers;K<se.length;K++){var ne=se[K];Y.indexOf(ne)===-1&&Y.push(ne)}}var oe=this._scene.getEngine();f=oe.createEffect(R,{attributes:d,uniformsNames:V,uniformBuffersNames:_e,samplers:Y,defines:B,fallbacks:y,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:b}},oe),h.setEffect(f,M)}if(!f.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())},n.prototype.prepareDefines=function(t,e){var i=this._scene,s=this._light;!i.shadowsEnabled||!s.shadowEnabled||(t["SHADOW"+e]=!0,this.useContactHardeningShadow?(t["SHADOWPCSS"+e]=!0,this._filteringQuality===n.QUALITY_LOW?t["SHADOWLOWQUALITY"+e]=!0:this._filteringQuality===n.QUALITY_MEDIUM&&(t["SHADOWMEDIUMQUALITY"+e]=!0)):this.usePercentageCloserFiltering?(t["SHADOWPCF"+e]=!0,this._filteringQuality===n.QUALITY_LOW?t["SHADOWLOWQUALITY"+e]=!0:this._filteringQuality===n.QUALITY_MEDIUM&&(t["SHADOWMEDIUMQUALITY"+e]=!0)):this.usePoissonSampling?t["SHADOWPOISSON"+e]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?t["SHADOWESM"+e]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(t["SHADOWCLOSEESM"+e]=!0),s.needCube()&&(t["SHADOWCUBE"+e]=!0))},n.prototype.bindShadowLight=function(t,e){var i=this._light,s=this._scene;if(!(!s.shadowsEnabled||!i.shadowEnabled)){var r=s.activeCamera;if(!!r){var o=this.getShadowMap();!o||(i.needCube()||e.setMatrix("lightMatrix"+t,this.getTransformMatrix()),this._filter===n.FILTER_PCF?(e.setDepthStencilTexture("shadowSampler"+t,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),o.getSize().width,1/o.getSize().width,this.frustumEdgeFalloff,t)):this._filter===n.FILTER_PCSS?(e.setDepthStencilTexture("shadowSampler"+t,this.getShadowMapForRendering()),e.setTexture("depthSampler"+t,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/o.getSize().width,this._contactHardeningLightSizeUVRatio*o.getSize().width,this.frustumEdgeFalloff,t)):(e.setTexture("shadowSampler"+t,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/o.getSize().width,this.depthScale,this.frustumEdgeFalloff,t)),i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(r),this.getLight().getDepthMinZ(r)+this.getLight().getDepthMaxZ(r),t))}}},n.prototype.getTransformMatrix=function(){var t=this._scene;if(this._currentRenderId===t.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=t.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;var e=this._light.position;if(this._light.computeTransformedInformation()&&(e=this._light.transformedPosition),u.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),Math.abs(u.Dot(this._lightDirection,u.Up()))===1&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!e.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(e),this._cachedDirection.copyFrom(this._lightDirection),m.LookAtLHToRef(e,e.add(this._lightDirection),u.Up(),this._viewMatrix);var i=this.getShadowMap();if(i){var s=i.renderList;s&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,s)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix},n.prototype.recreateShadowMap=function(){var t=this._shadowMap;if(!!t){var e=t.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),e){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(var i=0,s=e;i<s.length;i++){var r=s[i];this._shadowMap.renderList.push(r)}}else this._shadowMap.renderList=null}},n.prototype._disposeBlurPostProcesses=function(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]},n.prototype._disposeRTTandPostProcesses=function(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()},n.prototype._disposeSceneUBOs=function(){if(this._sceneUBOs){for(var t=0,e=this._sceneUBOs;t<e.length;t++){var i=e[t];i.dispose()}this._sceneUBOs=[]}},n.prototype.dispose=function(){this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light&&(this._light._shadowGenerator=null,this._light._markMeshesAsLightDirty()),this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()},n.prototype.serialize=function(){var t={},e=this.getShadowMap();if(!e)return t;if(t.className=this.getClassName(),t.lightId=this._light.id,t.id=this.id,t.mapSize=e.getRenderSize(),t.forceBackFacesOnly=this.forceBackFacesOnly,t.darkness=this.getDarkness(),t.transparencyShadow=this._transparencyShadow,t.frustumEdgeFalloff=this.frustumEdgeFalloff,t.bias=this.bias,t.normalBias=this.normalBias,t.usePercentageCloserFiltering=this.usePercentageCloserFiltering,t.useContactHardeningShadow=this.useContactHardeningShadow,t.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,t.filteringQuality=this.filteringQuality,t.useExponentialShadowMap=this.useExponentialShadowMap,t.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,t.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,t.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,t.usePoissonSampling=this.usePoissonSampling,t.depthScale=this.depthScale,t.blurBoxOffset=this.blurBoxOffset,t.blurKernel=this.blurKernel,t.blurScale=this.blurScale,t.useKernelBlur=this.useKernelBlur,t.renderList=[],e.renderList)for(var i=0;i<e.renderList.length;i++){var s=e.renderList[i];t.renderList.push(s.id)}return t},n.Parse=function(t,e,i){for(var s=e.getLightById(t.lightId),r=i?i(t.mapSize,s):new n(t.mapSize,s),o=r.getShadowMap(),a=0;a<t.renderList.length;a++){var h=e.getMeshesById(t.renderList[a]);h.forEach(function(f){!o||(o.renderList||(o.renderList=[]),o.renderList.push(f))})}return t.id!==void 0&&(r.id=t.id),r.forceBackFacesOnly=!!t.forceBackFacesOnly,t.darkness!==void 0&&r.setDarkness(t.darkness),t.transparencyShadow&&r.setTransparencyShadow(!0),t.frustumEdgeFalloff!==void 0&&(r.frustumEdgeFalloff=t.frustumEdgeFalloff),t.bias!==void 0&&(r.bias=t.bias),t.normalBias!==void 0&&(r.normalBias=t.normalBias),t.usePercentageCloserFiltering?r.usePercentageCloserFiltering=!0:t.useContactHardeningShadow?r.useContactHardeningShadow=!0:t.usePoissonSampling?r.usePoissonSampling=!0:t.useExponentialShadowMap?r.useExponentialShadowMap=!0:t.useBlurExponentialShadowMap?r.useBlurExponentialShadowMap=!0:t.useCloseExponentialShadowMap?r.useCloseExponentialShadowMap=!0:t.useBlurCloseExponentialShadowMap?r.useBlurCloseExponentialShadowMap=!0:t.useVarianceShadowMap?r.useExponentialShadowMap=!0:t.useBlurVarianceShadowMap&&(r.useBlurExponentialShadowMap=!0),t.contactHardeningLightSizeUVRatio!==void 0&&(r.contactHardeningLightSizeUVRatio=t.contactHardeningLightSizeUVRatio),t.filteringQuality!==void 0&&(r.filteringQuality=t.filteringQuality),t.depthScale&&(r.depthScale=t.depthScale),t.blurScale&&(r.blurScale=t.blurScale),t.blurBoxOffset&&(r.blurBoxOffset=t.blurBoxOffset),t.useKernelBlur&&(r.useKernelBlur=t.useKernelBlur),t.blurKernel&&(r.blurKernel=t.blurKernel),r},n.CLASSNAME="ShadowGenerator",n.FILTER_NONE=0,n.FILTER_EXPONENTIALSHADOWMAP=1,n.FILTER_POISSONSAMPLING=2,n.FILTER_BLUREXPONENTIALSHADOWMAP=3,n.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,n.FILTER_PCF=6,n.FILTER_PCSS=7,n.QUALITY_HIGH=0,n.QUALITY_MEDIUM=1,n.QUALITY_LOW=2,n.DEFAULT_ALPHA_CUTOFF=.5,n._SceneComponentInitialization=function(t){throw pe("ShadowGeneratorSceneComponent")},n}(),le=u.Up(),Ie=u.Zero(),T=new u,F=new u,k=new m,ce=function(n){I(t,n);function t(e,i,s){var r=this;return t.IsSupported?(r=n.call(this,e,i,s)||this,r.usePercentageCloserFiltering=!0,r):(ye.Error("CascadedShadowMap is not supported by the current engine."),r)}return t.prototype._validateFilter=function(e){return e===P.FILTER_NONE||e===P.FILTER_PCF||e===P.FILTER_PCSS?e:(console.error('Unsupported filter "'+e+'"!'),P.FILTER_NONE)},Object.defineProperty(t.prototype,"numCascades",{get:function(){return this._numCascades},set:function(e){e=Math.min(Math.max(e,t.MIN_CASCADES_COUNT),t.MAX_CASCADES_COUNT),e!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"freezeShadowCastersBoundingInfo",{get:function(){return this._freezeShadowCastersBoundingInfo},set:function(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),!this._freezeShadowCastersBoundingInfoObservable&&!e&&(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(this._computeShadowCastersBoundingInfo.bind(this))),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()},enumerable:!1,configurable:!0}),t.prototype._computeShadowCastersBoundingInfo=function(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._shadowMap&&this._shadowMap.renderList){for(var e=this._shadowMap.renderList,i=0;i<e.length;i++){var s=e[i];if(!!s){var r=s.getBoundingInfo(),o=r.boundingBox;this._scbiMin.minimizeInPlace(o.minimumWorld),this._scbiMax.maximizeInPlace(o.maximumWorld)}}for(var a=this._scene.meshes,i=0;i<a.length;i++){var s=a[i];if(!(!s||!s.isVisible||!s.isEnabled||!s.receiveShadows)){var r=s.getBoundingInfo(),o=r.boundingBox;this._scbiMin.minimizeInPlace(o.minimumWorld),this._scbiMax.maximizeInPlace(o.maximumWorld)}}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)},Object.defineProperty(t.prototype,"shadowCastersBoundingInfo",{get:function(){return this._shadowCastersBoundingInfo},set:function(e){this._shadowCastersBoundingInfo=e},enumerable:!1,configurable:!0}),t.prototype.setMinMaxDistance=function(e,i){this._minDistance===e&&this._maxDistance===i||(e>i&&(e=0,i=1),e<0&&(e=0),i>1&&(i=1),this._minDistance=e,this._maxDistance=i,this._breaksAreDirty=!0)},Object.defineProperty(t.prototype,"minDistance",{get:function(){return this._minDistance},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"maxDistance",{get:function(){return this._maxDistance},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return t.CLASSNAME},t.prototype.getCascadeMinExtents=function(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null},t.prototype.getCascadeMaxExtents=function(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null},Object.defineProperty(t.prototype,"shadowMaxZ",{get:function(){return!this._scene||!this._scene.activeCamera?0:this._shadowMaxZ},set:function(e){if(!this._scene||!this._scene.activeCamera){this._shadowMaxZ=e;return}this._shadowMaxZ===e||e<this._scene.activeCamera.minZ||e>this._scene.activeCamera.maxZ||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"debug",{get:function(){return this._debug},set:function(e){this._debug=e,this._light._markMeshesAsLightDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"depthClamp",{get:function(){return this._depthClamp},set:function(e){this._depthClamp=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cascadeBlendPercentage",{get:function(){return this._cascadeBlendPercentage},set:function(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lambda",{get:function(){return this._lambda},set:function(e){var i=Math.min(Math.max(e,0),1);this._lambda!=i&&(this._lambda=i,this._breaksAreDirty=!0)},enumerable:!1,configurable:!0}),t.prototype.getCascadeViewMatrix=function(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null},t.prototype.getCascadeProjectionMatrix=function(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null},t.prototype.getCascadeTransformMatrix=function(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null},t.prototype.setDepthRenderer=function(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)},Object.defineProperty(t.prototype,"autoCalcDepthBounds",{get:function(){return this._autoCalcDepthBounds},set:function(e){var i=this,s=this._scene.activeCamera;if(!!s){if(this._autoCalcDepthBounds=e,!e){this._depthReducer&&this._depthReducer.deactivate(),this.setMinMaxDistance(0,1);return}this._depthReducer||(this._depthReducer=new Te(s),this._depthReducer.onAfterReductionPerformed.add(function(r){var o=r.min,a=r.max;o>=a&&(o=0,a=1),(o!=i._minDistance||a!=i._maxDistance)&&i.setMinMaxDistance(o,a)}),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"autoCalcDepthBoundsRefreshRate",{get:function(){var e,i,s;return(s=(i=(e=this._depthReducer)===null||e===void 0?void 0:e.depthRenderer)===null||i===void 0?void 0:i.getDepthMap().refreshRate)!==null&&s!==void 0?s:-1},set:function(e){var i;!((i=this._depthReducer)===null||i===void 0)&&i.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)},enumerable:!1,configurable:!0}),t.prototype.splitFrustum=function(){this._breaksAreDirty=!0},t.prototype._splitFrustum=function(){var e=this._scene.activeCamera;if(!!e){for(var i=e.minZ,s=e.maxZ,r=s-i,o=this._minDistance,a=this._shadowMaxZ<s&&this._shadowMaxZ>=i?Math.min((this._shadowMaxZ-i)/(s-i),this._maxDistance):this._maxDistance,h=i+o*r,f=i+a*r,M=f-h,d=f/h,l=0;l<this._cascades.length;++l){var _=(l+1)/this._numCascades,S=h*Math.pow(d,_),y=h+M*_,E=this._lambda*(S-y)+y;this._cascades[l].prevBreakDistance=l===0?o:this._cascades[l-1].breakDistance,this._cascades[l].breakDistance=(E-i)/r,this._viewSpaceFrustumsZ[l]=E,this._frustumLengths[l]=(this._cascades[l].breakDistance-this._cascades[l].prevBreakDistance)*r}this._breaksAreDirty=!1}},t.prototype._computeMatrices=function(){var e=this._scene,i=e.activeCamera;if(!!i){u.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),Math.abs(u.Dot(this._lightDirection,u.Up()))===1&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);for(var s=e.getEngine().useReverseDepthBuffer,r=0;r<this._numCascades;++r){this._computeFrustumInWorldSpace(r),this._computeCascadeFrustum(r),this._cascadeMaxExtents[r].subtractToRef(this._cascadeMinExtents[r],T),this._frustumCenter[r].addToRef(this._lightDirection.scale(this._cascadeMinExtents[r].z),this._shadowCameraPos[r]),m.LookAtLHToRef(this._shadowCameraPos[r],this._frustumCenter[r],le,this._viewMatrices[r]);var o=0,a=T.z,h=this._shadowCastersBoundingInfo;h.update(this._viewMatrices[r]),a=Math.min(a,h.boundingBox.maximumWorld.z),!this._depthClamp||this.filter===P.FILTER_PCSS?o=Math.min(o,h.boundingBox.minimumWorld.z):o=Math.max(o,h.boundingBox.minimumWorld.z),m.OrthoOffCenterLHToRef(this._cascadeMinExtents[r].x,this._cascadeMaxExtents[r].x,this._cascadeMinExtents[r].y,this._cascadeMaxExtents[r].y,s?a:o,s?o:a,this._projectionMatrices[r],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[r].z=o,this._cascadeMaxExtents[r].z=a,this._viewMatrices[r].multiplyToRef(this._projectionMatrices[r],this._transformMatrices[r]),u.TransformCoordinatesToRef(Ie,this._transformMatrices[r],T),T.scaleInPlace(this._mapSize/2),F.copyFromFloats(Math.round(T.x),Math.round(T.y),Math.round(T.z)),F.subtractInPlace(T).scaleInPlace(2/this._mapSize),m.TranslationToRef(F.x,F.y,0,k),this._projectionMatrices[r].multiplyToRef(k,this._projectionMatrices[r]),this._viewMatrices[r].multiplyToRef(this._projectionMatrices[r],this._transformMatrices[r]),this._transformMatrices[r].copyToArray(this._transformMatricesAsArray,r*16)}}},t.prototype._computeFrustumInWorldSpace=function(e){if(!!this._scene.activeCamera){var i=this._cascades[e].prevBreakDistance,s=this._cascades[e].breakDistance,r=this._scene.getEngine().isNDCHalfZRange;this._scene.activeCamera.getViewMatrix();for(var o=m.Invert(this._scene.activeCamera.getTransformationMatrix()),a=this._scene.getEngine().useReverseDepthBuffer?4:0,h=0;h<t._FrustumCornersNDCSpace.length;++h)T.copyFrom(t._FrustumCornersNDCSpace[(h+a)%t._FrustumCornersNDCSpace.length]),r&&T.z===-1&&(T.z=0),u.TransformCoordinatesToRef(T,o,this._frustumCornersWorldSpace[e][h]);for(var h=0;h<t._FrustumCornersNDCSpace.length/2;++h)T.copyFrom(this._frustumCornersWorldSpace[e][h+4]).subtractInPlace(this._frustumCornersWorldSpace[e][h]),F.copyFrom(T).scaleInPlace(i),T.scaleInPlace(s),T.addInPlace(this._frustumCornersWorldSpace[e][h]),this._frustumCornersWorldSpace[e][h+4].copyFrom(T),this._frustumCornersWorldSpace[e][h].addInPlace(F)}},t.prototype._computeCascadeFrustum=function(e){this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0);var i=this._scene.activeCamera;if(!!i){for(var s=0;s<this._frustumCornersWorldSpace[e].length;++s)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][s]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){for(var r=0,s=0;s<this._frustumCornersWorldSpace[e].length;++s){var o=this._frustumCornersWorldSpace[e][s].subtractToRef(this._frustumCenter[e],T).length();r=Math.max(r,o)}r=Math.ceil(r*16)/16,this._cascadeMaxExtents[e].copyFromFloats(r,r,r),this._cascadeMinExtents[e].copyFromFloats(-r,-r,-r)}else{var a=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,T),m.LookAtLHToRef(a,T,le,k);for(var s=0;s<this._frustumCornersWorldSpace[e].length;++s)u.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][s],k,T),this._cascadeMinExtents[e].minimizeInPlace(T),this._cascadeMaxExtents[e].maximizeInPlace(T)}}},t.prototype._recreateSceneUBOs=function(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(var e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer('Scene for CSM Shadow Generator (light "'.concat(this._light.name,'" cascade #').concat(e,")")))},Object.defineProperty(t,"IsSupported",{get:function(){var e=we.LastCreatedEngine;return e?e._features.supportCSM:!1},enumerable:!1,configurable:!0}),t.prototype._initializeGenerator=function(){var e,i,s,r,o,a,h,f,M,d,l,_,S,y,E,c,b,v,C,O;this.penumbraDarkness=(e=this.penumbraDarkness)!==null&&e!==void 0?e:1,this._numCascades=(i=this._numCascades)!==null&&i!==void 0?i:t.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=(s=this.stabilizeCascades)!==null&&s!==void 0?s:!1,this._freezeShadowCastersBoundingInfoObservable=(r=this._freezeShadowCastersBoundingInfoObservable)!==null&&r!==void 0?r:null,this.freezeShadowCastersBoundingInfo=(o=this.freezeShadowCastersBoundingInfo)!==null&&o!==void 0?o:!1,this._scbiMin=(a=this._scbiMin)!==null&&a!==void 0?a:new u(0,0,0),this._scbiMax=(h=this._scbiMax)!==null&&h!==void 0?h:new u(0,0,0),this._shadowCastersBoundingInfo=(f=this._shadowCastersBoundingInfo)!==null&&f!==void 0?f:new Ce(new u(0,0,0),new u(0,0,0)),this._breaksAreDirty=(M=this._breaksAreDirty)!==null&&M!==void 0?M:!0,this._minDistance=(d=this._minDistance)!==null&&d!==void 0?d:0,this._maxDistance=(l=this._maxDistance)!==null&&l!==void 0?l:1,this._currentLayer=(_=this._currentLayer)!==null&&_!==void 0?_:0,this._shadowMaxZ=(E=(S=this._shadowMaxZ)!==null&&S!==void 0?S:(y=this._scene.activeCamera)===null||y===void 0?void 0:y.maxZ)!==null&&E!==void 0?E:1e4,this._debug=(c=this._debug)!==null&&c!==void 0?c:!1,this._depthClamp=(b=this._depthClamp)!==null&&b!==void 0?b:!0,this._cascadeBlendPercentage=(v=this._cascadeBlendPercentage)!==null&&v!==void 0?v:.1,this._lambda=(C=this._lambda)!==null&&C!==void 0?C:.5,this._autoCalcDepthBounds=(O=this._autoCalcDepthBounds)!==null&&O!==void 0?O:!1,this._recreateSceneUBOs(),n.prototype._initializeGenerator.call(this)},t.prototype._createTargetRenderTexture=function(){var e=this._scene.getEngine(),i={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new Z(this._light.name+"_CSMShadowMap",i,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0)},t.prototype._initializeShadowMap=function(){var e=this;if(n.prototype._initializeShadowMap.call(this),this._shadowMap!==null){this._transformMatricesAsArray=new Float32Array(this._numCascades*16),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(this._numCascades*2),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(var i=0;i<this._numCascades;++i){this._cascades[i]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[i]=m.Zero(),this._projectionMatrices[i]=m.Zero(),this._transformMatrices[i]=m.Zero(),this._cascadeMinExtents[i]=new u,this._cascadeMaxExtents[i]=new u,this._frustumCenter[i]=new u,this._shadowCameraPos[i]=new u,this._frustumCornersWorldSpace[i]=new Array(t._FrustumCornersNDCSpace.length);for(var s=0;s<t._FrustumCornersNDCSpace.length;++s)this._frustumCornersWorldSpace[i][s]=new u}var r=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add(function(o){e._sceneUBOs&&e._scene.setSceneUniformBuffer(e._sceneUBOs[o]),e._currentLayer=o,e._filter===P.FILTER_PCF&&r.setColorWrite(!1),e._scene.setTransformMatrix(e.getCascadeViewMatrix(o),e.getCascadeProjectionMatrix(o)),e._useUBO&&(e._scene.getSceneUniformBuffer().unbindEffect(),e._scene.finalizeSceneUbo())}),this._shadowMap.onBeforeBindObservable.add(function(){var o;e._currentSceneUBO=e._scene.getSceneUniformBuffer(),(o=r._debugPushGroup)===null||o===void 0||o.call(r,"cascaded shadow map generation for pass id ".concat(r.currentRenderPassId),1),e._breaksAreDirty&&e._splitFrustum(),e._computeMatrices()}),this._splitFrustum()}},t.prototype._bindCustomEffectForRenderSubMeshForShadowMap=function(e,i){i.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))},t.prototype._isReadyCustomDefines=function(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==P.FILTER_PCSS?"1":"0"))},t.prototype.prepareDefines=function(e,i){n.prototype.prepareDefines.call(this,e,i);var s=this._scene,r=this._light;if(!(!s.shadowsEnabled||!r.shadowEnabled)){e["SHADOWCSM"+i]=!0,e["SHADOWCSMDEBUG"+i]=this.debug,e["SHADOWCSMNUM_CASCADES"+i]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+i]=s.useRightHandedSystem;var o=s.activeCamera;o&&this._shadowMaxZ<o.maxZ&&(e["SHADOWCSMUSESHADOWMAXZ"+i]=!0),this.cascadeBlendPercentage===0&&(e["SHADOWCSMNOBLEND"+i]=!0)}},t.prototype.bindShadowLight=function(e,i){var s=this._light,r=this._scene;if(!(!r.shadowsEnabled||!s.shadowEnabled)){var o=r.activeCamera;if(!!o){var a=this.getShadowMap();if(!!a){var h=a.getSize().width;if(i.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),i.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),i.setFloat("cascadeBlendFactor"+e,this.cascadeBlendPercentage===0?1e4:1/this.cascadeBlendPercentage),i.setArray("frustumLengths"+e,this._frustumLengths),this._filter===P.FILTER_PCF)i.setDepthStencilTexture("shadowSampler"+e,a),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),h,1/h,this.frustumEdgeFalloff,e);else if(this._filter===P.FILTER_PCSS){for(var f=0;f<this._numCascades;++f)this._lightSizeUVCorrection[f*2+0]=f===0?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[f].x-this._cascadeMinExtents[f].x),this._lightSizeUVCorrection[f*2+1]=f===0?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[f].y-this._cascadeMinExtents[f].y),this._depthCorrection[f]=f===0?1:(this._cascadeMaxExtents[f].z-this._cascadeMinExtents[f].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);i.setDepthStencilTexture("shadowSampler"+e,a),i.setTexture("depthSampler"+e,a),i.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),i.setArray("depthCorrection"+e,this._depthCorrection),i.setFloat("penumbraDarkness"+e,this.penumbraDarkness),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/h,this._contactHardeningLightSizeUVRatio*h,this.frustumEdgeFalloff,e)}else i.setTexture("shadowSampler"+e,a),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),h,1/h,this.frustumEdgeFalloff,e);s._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(o),this.getLight().getDepthMinZ(o)+this.getLight().getDepthMaxZ(o),e)}}}},t.prototype.getTransformMatrix=function(){return this.getCascadeTransformMatrix(0)},t.prototype.dispose=function(){n.prototype.dispose.call(this),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)},t.prototype.serialize=function(){var e=n.prototype.serialize.call(this),i=this.getShadowMap();if(!i)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],i.renderList)for(var s=0;s<i.renderList.length;s++){var r=i.renderList[s];e.renderList.push(r.id)}return e},t.Parse=function(e,i){var s=P.Parse(e,i,function(r,o){return new t(r,o)});return e.numCascades!==void 0&&(s.numCascades=e.numCascades),e.debug!==void 0&&(s.debug=e.debug),e.stabilizeCascades!==void 0&&(s.stabilizeCascades=e.stabilizeCascades),e.lambda!==void 0&&(s.lambda=e.lambda),e.cascadeBlendPercentage!==void 0&&(s.cascadeBlendPercentage=e.cascadeBlendPercentage),e.depthClamp!==void 0&&(s.depthClamp=e.depthClamp),e.autoCalcDepthBounds!==void 0&&(s.autoCalcDepthBounds=e.autoCalcDepthBounds),e.shadowMaxZ!==void 0&&(s.shadowMaxZ=e.shadowMaxZ),e.penumbraDarkness!==void 0&&(s.penumbraDarkness=e.penumbraDarkness),e.freezeShadowCastersBoundingInfo!==void 0&&(s.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),e.minDistance!==void 0&&e.maxDistance!==void 0&&s.setMinMaxDistance(e.minDistance,e.maxDistance),s},t._FrustumCornersNDCSpace=[new u(-1,1,-1),new u(1,1,-1),new u(1,-1,-1),new u(-1,-1,-1),new u(-1,1,1),new u(1,1,1),new u(1,-1,1),new u(-1,-1,1)],t.CLASSNAME="CascadedShadowGenerator",t.DEFAULT_CASCADES_COUNT=4,t.MIN_CASCADES_COUNT=2,t.MAX_CASCADES_COUNT=4,t._SceneComponentInitialization=function(e){throw pe("ShadowGeneratorSceneComponent")},t}(P);De.AddParser(W.NAME_SHADOWGENERATOR,function(n,t){if(n.shadowGenerators!==void 0&&n.shadowGenerators!==null)for(var e=0,i=n.shadowGenerators.length;e<i;e++){var s=n.shadowGenerators[e];s.className===ce.CLASSNAME?ce.Parse(s,t):P.Parse(s,t)}});var de=function(){function n(t){this.name=W.NAME_SHADOWGENERATOR,this.scene=t}return n.prototype.register=function(){this.scene._gatherRenderTargetsStage.registerStep(W.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)},n.prototype.rebuild=function(){},n.prototype.serialize=function(t){t.shadowGenerators=[];for(var e=this.scene.lights,i=0,s=e;i<s.length;i++){var r=s[i],o=r.getShadowGenerator();o&&t.shadowGenerators.push(o.serialize())}},n.prototype.addFromContainer=function(t){},n.prototype.removeFromContainer=function(t,e){},n.prototype.dispose=function(){},n.prototype._gatherRenderTargets=function(t){var e=this.scene;if(this.scene.shadowsEnabled)for(var i=0;i<e.lights.length;i++){var s=e.lights[i],r=s.getShadowGenerator();if(s.isEnabled()&&s.shadowEnabled&&r){var o=r.getShadowMap();e.textures.indexOf(o)!==-1&&t.push(o)}}},n}();P._SceneComponentInitialization=function(n){var t=n._getComponent(W.NAME_SHADOWGENERATOR);t||(t=new de(n),n._addComponent(t))};var Xe=Object.freeze(Object.defineProperty({__proto__:null,ShadowGeneratorSceneComponent:de},Symbol.toStringTag,{value:"Module"}));x.AddNodeConstructor("Light_Type_0",function(n,t){return function(){return new Be(n,u.Zero(),t)}});var Be=function(n){I(t,n);function t(e,i,s){var r=n.call(this,e,s)||this;return r._shadowAngle=Math.PI/2,r.position=i,r}return Object.defineProperty(t.prototype,"shadowAngle",{get:function(){return this._shadowAngle},set:function(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"direction",{get:function(){return this._direction},set:function(e){var i=this.needCube();this._direction=e,this.needCube()!==i&&this._shadowGenerator&&this._shadowGenerator.recreateShadowMap()},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"PointLight"},t.prototype.getTypeID=function(){return A.LIGHTTYPEID_POINTLIGHT},t.prototype.needCube=function(){return!this.direction},t.prototype.getShadowDirection=function(e){if(this.direction)return n.prototype.getShadowDirection.call(this,e);switch(e){case 0:return new u(1,0,0);case 1:return new u(-1,0,0);case 2:return new u(0,-1,0);case 3:return new u(0,1,0);case 4:return new u(0,0,1);case 5:return new u(0,0,-1)}return u.Zero()},t.prototype._setDefaultShadowProjectionMatrix=function(e,i,s){var r=this.getScene().activeCamera;if(!!r){var o=this.shadowMinZ!==void 0?this.shadowMinZ:r.minZ,a=this.shadowMaxZ!==void 0?this.shadowMaxZ:r.maxZ,h=this.getScene().getEngine().useReverseDepthBuffer;m.PerspectiveFovLHToRef(this.shadowAngle,1,h?a:o,h?o:a,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,h)}},t.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},t.prototype.transferToEffect=function(e,i){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,i):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,i),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,i),this},t.prototype.transferToNodeMaterialEffect=function(e,i){return this.computeTransformedInformation()?e.setFloat3(i,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(i,this.position.x,this.position.y,this.position.z),this},t.prototype.prepareLightSpecificDefines=function(e,i){e["POINTLIGHT"+i]=!0},p([g()],t.prototype,"shadowAngle",null),t}($);export{Ae as D,Oe as H,A as L,Be as P,xe as S,L as a,P as b,Xe as s};
