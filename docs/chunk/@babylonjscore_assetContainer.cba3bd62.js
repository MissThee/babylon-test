import{_ as b,b as q}from"./tslibtslib.b6e59fa7.js";import{A as I}from"./@babylonjscore_abstractScene.d5c48c49.js";import{M as C}from"./@babylonjscore_Meshes.307935b5.js";import{L as O}from"./@babylonjscore_Misc.d81f49ec.js";import{E as S}from"./@babylonjscore_Engines.7287f97a.js";var R=function(p){b(g,p);function g(){return p!==null&&p.apply(this,arguments)||this}return g}(I),P=function(){function p(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}return p}(),z=function(p){b(g,p);function g(e){var t=p.call(this)||this;return t._wasAddedToScene=!1,e=e||S.LastCreatedScene,e&&(t.scene=e,t.sounds=[],t.effectLayers=[],t.layers=[],t.lensFlareSystems=[],t.proceduralTextures=[],t.reflectionProbes=[],e.onDisposeObservable.add(function(){t._wasAddedToScene||t.dispose()}),t._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(function(){for(var n=0,r=t.geometries;n<r.length;n++){var v=r[n];v._rebuild()}for(var h=0,i=t.meshes;h<i.length;h++){var s=i[h];s._rebuild()}for(var E=0,a=t.particleSystems;E<a.length;E++){var M=a[E];M.rebuild()}for(var o=0,f=t.textures;o<f.length;o++){var l=f[o];l._rebuild()}})),t}return g.prototype.instantiateModelsToScene=function(e,t,n){var r=this;t===void 0&&(t=!1);var v={},h={},i=new P,s=[],E=[],a=q({doNotInstantiate:!0},n);a.doNotInstantiate||(a.doNotInstantiate=function(o){return!!o.skeleton});var M=function(o,f){if(v[o.uniqueId]=f.uniqueId,h[f.uniqueId]=f,e&&(f.name=e(o.name)),f instanceof C){var l=f;if(l.morphTargetManager){var c=o.morphTargetManager;l.morphTargetManager=c.clone();for(var u=0;u<c.numTargets;u++){var d=c.getTarget(u),m=l.morphTargetManager.getTarget(u);v[d.uniqueId]=m.uniqueId,h[m.uniqueId]=m}}}};return this.transformNodes.forEach(function(o){if(!(a.predicate&&!a.predicate(o))&&!o.parent){var f=o.instantiateHierarchy(null,a,function(l,c){M(l,c)});f&&i.rootNodes.push(f)}}),this.meshes.forEach(function(o){if(!(a.predicate&&!a.predicate(o))&&!o.parent){var f=o.instantiateHierarchy(null,a,function(l,c){if(M(l,c),c.material){var u=c;if(u.material)if(t){var d=l.material;if(E.indexOf(d)===-1){var m=d.clone(e?e(d.name):"Clone of "+d.name);if(E.push(d),v[d.uniqueId]=m.uniqueId,h[m.uniqueId]=m,d.getClassName()==="MultiMaterial"){for(var T=d,x=0,A=T.subMaterials;x<A.length;x++){var N=A[x];!N||(m=N.clone(e?e(N.name):"Clone of "+N.name),E.push(N),v[N.uniqueId]=m.uniqueId,h[m.uniqueId]=m)}T.subMaterials=T.subMaterials.map(function(y){return y&&h[v[y.uniqueId]]})}}u.getClassName()!=="InstancedMesh"&&(u.material=h[v[d.uniqueId]])}else u.material.getClassName()==="MultiMaterial"?r.scene.multiMaterials.indexOf(u.material)===-1&&r.scene.addMultiMaterial(u.material):r.scene.materials.indexOf(u.material)===-1&&r.scene.addMaterial(u.material)}});f&&i.rootNodes.push(f)}}),this.skeletons.forEach(function(o){if(!(a.predicate&&!a.predicate(o))){for(var f=o.clone(e?e(o.name):"Clone of "+o.name),l=0,c=r.meshes;l<c.length;l++){var u=c[l];if(u.skeleton===o&&!u.isAnInstance){var d=h[v[u.uniqueId]];if(d.isAnInstance||(d.skeleton=f,s.indexOf(f)!==-1))continue;s.push(f);for(var m=0,T=f.bones;m<T.length;m++){var x=T[m];x._linkedTransformNode&&(x._linkedTransformNode=h[v[x._linkedTransformNode.uniqueId]])}}}i.skeletons.push(f)}}),this.animationGroups.forEach(function(o){if(!(a.predicate&&!a.predicate(o))){var f=o.clone(e?e(o.name):"Clone of "+o.name,function(l){var c=h[v[l.uniqueId]];return c||l});i.animationGroups.push(f)}}),i},g.prototype.addAllToScene=function(){if(!this._wasAddedToScene){this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(var e=0,t=this.scene._serializableComponents;e<t.length;e++){var n=t[e];n.addFromContainer(this)}this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}},g.prototype.addToScene=function(e){var t=this;e===void 0&&(e=null),this.cameras.forEach(function(n){e&&!e(n)||t.scene.addCamera(n)}),this.lights.forEach(function(n){e&&!e(n)||t.scene.addLight(n)}),this.meshes.forEach(function(n){e&&!e(n)||t.scene.addMesh(n)}),this.skeletons.forEach(function(n){e&&!e(n)||t.scene.addSkeleton(n)}),this.animations.forEach(function(n){e&&!e(n)||t.scene.addAnimation(n)}),this.animationGroups.forEach(function(n){e&&!e(n)||t.scene.addAnimationGroup(n)}),this.multiMaterials.forEach(function(n){e&&!e(n)||t.scene.addMultiMaterial(n)}),this.materials.forEach(function(n){e&&!e(n)||t.scene.addMaterial(n)}),this.morphTargetManagers.forEach(function(n){e&&!e(n)||t.scene.addMorphTargetManager(n)}),this.geometries.forEach(function(n){e&&!e(n)||t.scene.addGeometry(n)}),this.transformNodes.forEach(function(n){e&&!e(n)||t.scene.addTransformNode(n)}),this.actionManagers.forEach(function(n){e&&!e(n)||t.scene.addActionManager(n)}),this.textures.forEach(function(n){e&&!e(n)||t.scene.addTexture(n)}),this.reflectionProbes.forEach(function(n){e&&!e(n)||t.scene.addReflectionProbe(n)})},g.prototype.removeAllFromScene=function(){this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(var e=0,t=this.scene._serializableComponents;e<t.length;e++){var n=t[e];n.removeFromContainer(this)}},g.prototype.removeFromScene=function(e){var t=this;e===void 0&&(e=null),this.cameras.forEach(function(n){e&&!e(n)||t.scene.removeCamera(n)}),this.lights.forEach(function(n){e&&!e(n)||t.scene.removeLight(n)}),this.meshes.forEach(function(n){e&&!e(n)||t.scene.removeMesh(n)}),this.skeletons.forEach(function(n){e&&!e(n)||t.scene.removeSkeleton(n)}),this.animations.forEach(function(n){e&&!e(n)||t.scene.removeAnimation(n)}),this.animationGroups.forEach(function(n){e&&!e(n)||t.scene.removeAnimationGroup(n)}),this.multiMaterials.forEach(function(n){e&&!e(n)||t.scene.removeMultiMaterial(n)}),this.materials.forEach(function(n){e&&!e(n)||t.scene.removeMaterial(n)}),this.morphTargetManagers.forEach(function(n){e&&!e(n)||t.scene.removeMorphTargetManager(n)}),this.geometries.forEach(function(n){e&&!e(n)||t.scene.removeGeometry(n)}),this.transformNodes.forEach(function(n){e&&!e(n)||t.scene.removeTransformNode(n)}),this.actionManagers.forEach(function(n){e&&!e(n)||t.scene.removeActionManager(n)}),this.textures.forEach(function(n){e&&!e(n)||t.scene.removeTexture(n)}),this.reflectionProbes.forEach(function(n){e&&!e(n)||t.scene.removeReflectionProbe(n)})},g.prototype.dispose=function(){this.cameras.slice(0).forEach(function(r){r.dispose()}),this.cameras.length=0,this.lights.slice(0).forEach(function(r){r.dispose()}),this.lights.length=0,this.meshes.slice(0).forEach(function(r){r.dispose()}),this.meshes.length=0,this.skeletons.slice(0).forEach(function(r){r.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(function(r){r.dispose()}),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach(function(r){r.dispose()}),this.multiMaterials.length=0,this.materials.slice(0).forEach(function(r){r.dispose()}),this.materials.length=0,this.geometries.slice(0).forEach(function(r){r.dispose()}),this.geometries.length=0,this.transformNodes.slice(0).forEach(function(r){r.dispose()}),this.transformNodes.length=0,this.actionManagers.slice(0).forEach(function(r){r.dispose()}),this.actionManagers.length=0,this.textures.slice(0).forEach(function(r){r.dispose()}),this.textures.length=0,this.reflectionProbes.slice(0).forEach(function(r){r.dispose()}),this.reflectionProbes.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(var e=0,t=this.scene._serializableComponents;e<t.length;e++){var n=t[e];n.removeFromContainer(this,!0)}this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)},g.prototype._moveAssets=function(e,t,n){if(!!e)for(var r=0,v=e;r<v.length;r++){var h=v[r],i=!0;if(n)for(var s=0,E=n;s<E.length;s++){var a=E[s];if(h===a){i=!1;break}}i&&(t.push(h),h._parentContainer=this)}},g.prototype.moveAllFromScene=function(e){this._wasAddedToScene=!1,e===void 0&&(e=new R);for(var t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||(t==="environmentTexture"?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()},g.prototype.createRootMesh=function(){var e=new C("assetContainerRootMesh",this.scene);return this.meshes.forEach(function(t){t.parent||e.addChild(t)}),this.meshes.unshift(e),e},g.prototype.mergeAnimationsTo=function(e,t,n){if(e===void 0&&(e=S.LastCreatedScene),n===void 0&&(n=null),!e)return O.Error("No scene available to merge animations to"),[];var r=n||function(i){var s=null,E=i.animations.length?i.animations[0].targetProperty:"",a=i.name.split(".").join("").split("_primitive")[0];switch(E){case"position":case"rotationQuaternion":s=e.getTransformNodeByName(i.name)||e.getTransformNodeByName(a);break;case"influence":s=e.getMorphTargetByName(i.name)||e.getMorphTargetByName(a);break;default:s=e.getNodeByName(i.name)||e.getNodeByName(a)}return s},v=this.getNodes();v.forEach(function(i){var s=r(i);if(s!==null){for(var E=function(f){for(var l=s.animations.filter(function(T){return T.targetProperty===f.targetProperty}),c=0,u=l;c<u.length;c++){var d=u[c],m=s.animations.indexOf(d,0);m>-1&&s.animations.splice(m,1)}},a=0,M=i.animations;a<M.length;a++){var o=M[a];E(o)}s.animations=s.animations.concat(i.animations)}});var h=new Array;return this.animationGroups.slice().forEach(function(i){h.push(i.clone(i.name,r)),i.animatables.forEach(function(s){s.stop()})}),t.forEach(function(i){var s=r(i.target);s&&(e.beginAnimation(s,i.fromFrame,i.toFrame,i.loopAnimation,i.speedRatio,i.onAnimationEnd?i.onAnimationEnd:void 0,void 0,!0,void 0,i.onAnimationLoop?i.onAnimationLoop:void 0),e.stopAnimation(i.target))}),h},g}(I);export{z as A};
