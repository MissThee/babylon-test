import{_ as F,L as N,a as O,j as f,O as T}from"./precisionDate.911053b8.js";import{T as D,S as M,g as d,s as _}from"./decorators.033fe02c.js";import{F as L,b as H,a as y}from"./scene.600fc970.js";import{Vector3 as S,Matrix as P,Quaternion as b}from"./math.vector.dbc48609.js";import{N as C}from"./node.c2e9b9af.js";import{G as V}from"./arrayTools.49f8ffa1.js";import{E as I}from"./performanceConfigurator.3a0adc9f.js";import{V as E}from"./math.plane.3df9f77f.js";import{L as A}from"./light.9e8c0fea.js";import{Color3 as U}from"./math.color.a4c793a9.js";import{T as G}from"./thinMaterialHelper.ab63cfd8.js";var w=function(){function n(e,t,r,i){this.x=e,this.y=t,this.width=r,this.height=i}return n.prototype.toGlobal=function(e,t){return new n(this.x*e,this.y*t,this.width*e,this.height*t)},n.prototype.toGlobalToRef=function(e,t,r){return r.x=this.x*e,r.y=this.y*t,r.width=this.width*e,r.height=this.height*t,this},n.prototype.clone=function(){return new n(this.x,this.y,this.width,this.height)},n}(),B=function(n){F(e,n);function e(t,r,i,a){a===void 0&&(a=!0);var o=n.call(this,t,i)||this;return o._position=S.Zero(),o._upVector=S.Up(),o.orthoLeft=null,o.orthoRight=null,o.orthoBottom=null,o.orthoTop=null,o.fov=.8,o.projectionPlaneTilt=0,o.minZ=1,o.maxZ=1e4,o.inertia=.9,o.mode=e.PERSPECTIVE_CAMERA,o.isIntermediate=!1,o.viewport=new w(0,0,1,1),o.layerMask=268435455,o.fovMode=e.FOVMODE_VERTICAL_FIXED,o.cameraRigMode=e.RIG_MODE_NONE,o.customRenderTargets=new Array,o.outputRenderTarget=null,o.onViewMatrixChangedObservable=new T,o.onProjectionMatrixChangedObservable=new T,o.onAfterCheckInputsObservable=new T,o.onRestoreStateObservable=new T,o.isRigCamera=!1,o._rigCameras=new Array,o._webvrViewMatrix=P.Identity(),o._skipRendering=!1,o._projectionMatrix=new P,o._postProcesses=new Array,o._activeMeshes=new H(256),o._globalPosition=S.Zero(),o._computedViewMatrix=P.Identity(),o._doNotComputeProjectionMatrix=!1,o._transformMatrix=P.Zero(),o._refreshFrustumPlanes=!0,o._absoluteRotation=b.Identity(),o._isCamera=!0,o._isLeftCamera=!1,o._isRightCamera=!1,o.getScene().addCamera(o),a&&!o.getScene().activeCamera&&(o.getScene().activeCamera=o),o.position=r,o.renderPassId=o.getScene().getEngine().createRenderPassId("Camera ".concat(t)),o}return Object.defineProperty(e.prototype,"position",{get:function(){return this._position},set:function(t){this._position=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"upVector",{get:function(){return this._upVector},set:function(t){this._upVector=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"screenArea",{get:function(){var t,r,i,a,o=0,s=0;if(this.mode===e.PERSPECTIVE_CAMERA)this.fovMode===e.FOVMODE_VERTICAL_FIXED?(s=this.minZ*2*Math.tan(this.fov/2),o=this.getEngine().getAspectRatio(this)*s):(o=this.minZ*2*Math.tan(this.fov/2),s=o/this.getEngine().getAspectRatio(this));else{var u=this.getEngine().getRenderWidth()/2,c=this.getEngine().getRenderHeight()/2;o=((t=this.orthoRight)!==null&&t!==void 0?t:u)-((r=this.orthoLeft)!==null&&r!==void 0?r:-u),s=((i=this.orthoTop)!==null&&i!==void 0?i:c)-((a=this.orthoBottom)!==null&&a!==void 0?a:-c)}return o*s},enumerable:!1,configurable:!0}),e.prototype.storeState=function(){return this._stateStored=!0,this._storedFov=this.fov,this},e.prototype._restoreStateValues=function(){return this._stateStored?(this.fov=this._storedFov,!0):!1},e.prototype.restoreState=function(){return this._restoreStateValues()?(this.onRestoreStateObservable.notifyObservers(this),!0):!1},e.prototype.getClassName=function(){return"Camera"},e.prototype.toString=function(t){var r="Name: "+this.name;if(r+=", type: "+this.getClassName(),this.animations)for(var i=0;i<this.animations.length;i++)r+=", animation[0]: "+this.animations[i].toString(t);return r},e.prototype.applyVerticalCorrection=function(){var t=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-t.x:t.x},Object.defineProperty(e.prototype,"globalPosition",{get:function(){return this._globalPosition},enumerable:!1,configurable:!0}),e.prototype.getActiveMeshes=function(){return this._activeMeshes},e.prototype.isActiveMesh=function(t){return this._activeMeshes.indexOf(t)!==-1},e.prototype.isReady=function(t){if(t===void 0&&(t=!1),t)for(var r=0,i=this._postProcesses;r<i.length;r++){var a=i[r];if(a&&!a.isReady())return!1}return n.prototype.isReady.call(this,t)},e.prototype._initCache=function(){n.prototype._initCache.call(this),this._cache.position=new S(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new S(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0},e.prototype._updateCache=function(t){t||n.prototype._updateCache.call(this),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)},e.prototype._isSynchronized=function(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()},e.prototype._isSynchronizedViewMatrix=function(){return n.prototype._isSynchronized.call(this)?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1},e.prototype._isSynchronizedProjectionMatrix=function(){var t=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!t)return!1;var r=this.getEngine();return this.mode===e.PERSPECTIVE_CAMERA?t=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===r.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:t=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===r.getRenderWidth()&&this._cache.renderHeight===r.getRenderHeight(),t},e.prototype.attachControl=function(t,r){},e.prototype.detachControl=function(t){},e.prototype.update=function(){this._checkInputs(),this.cameraRigMode!==e.RIG_MODE_NONE&&this._updateRigCameras()},e.prototype._checkInputs=function(){this.onAfterCheckInputsObservable.notifyObservers(this)},Object.defineProperty(e.prototype,"rigCameras",{get:function(){return this._rigCameras},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rigPostProcess",{get:function(){return this._rigPostProcess},enumerable:!1,configurable:!0}),e.prototype._getFirstPostProcess=function(){for(var t=0;t<this._postProcesses.length;t++)if(this._postProcesses[t]!==null)return this._postProcesses[t];return null},e.prototype._cascadePostProcessesToRigCams=function(){var t=this._getFirstPostProcess();t&&t.markTextureDirty();for(var r=0,i=this._rigCameras.length;r<i;r++){var a=this._rigCameras[r],o=a._rigPostProcess;if(o){var s=o.getEffectName()==="pass";s&&(a.isIntermediate=this._postProcesses.length===0),a._postProcesses=this._postProcesses.slice(0).concat(o),o.markTextureDirty()}else a._postProcesses=this._postProcesses.slice(0)}},e.prototype.attachPostProcess=function(t,r){return r===void 0&&(r=null),!t.isReusable()&&this._postProcesses.indexOf(t)>-1?(N.Error("You're trying to reuse a post process not defined as reusable."),0):(r==null||r<0?this._postProcesses.push(t):this._postProcesses[r]===null?this._postProcesses[r]=t:this._postProcesses.splice(r,0,t),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(t))},e.prototype.detachPostProcess=function(t){var r=this._postProcesses.indexOf(t);r!==-1&&(this._postProcesses[r]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()},e.prototype.getWorldMatrix=function(){return this._isSynchronizedViewMatrix()?this._worldMatrix:(this.getViewMatrix(),this._worldMatrix)},e.prototype._getViewMatrix=function(){return P.Identity()},e.prototype.getViewMatrix=function(t){return!t&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix),this._computedViewMatrix)},e.prototype.freezeProjectionMatrix=function(t){this._doNotComputeProjectionMatrix=!0,t!==void 0&&(this._projectionMatrix=t)},e.prototype.unfreezeProjectionMatrix=function(){this._doNotComputeProjectionMatrix=!1},e.prototype.getProjectionMatrix=function(t){var r,i,a,o,s,u,c,p;if(this._doNotComputeProjectionMatrix||!t&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;var l=this.getEngine(),h=this.getScene();if(this.mode===e.PERSPECTIVE_CAMERA){this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=l.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1);var R=l.useReverseDepthBuffer,v=void 0;h.useRightHandedSystem?v=P.PerspectiveFovRHToRef:v=P.PerspectiveFovLHToRef,v(this.fov,l.getAspectRatio(this),R?this.maxZ:this.minZ,R?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===e.FOVMODE_VERTICAL_FIXED,l.isNDCHalfZRange,this.projectionPlaneTilt,l.useReverseDepthBuffer)}else{var m=l.getRenderWidth()/2,g=l.getRenderHeight()/2;h.useRightHandedSystem?P.OrthoOffCenterRHToRef((r=this.orthoLeft)!==null&&r!==void 0?r:-m,(i=this.orthoRight)!==null&&i!==void 0?i:m,(a=this.orthoBottom)!==null&&a!==void 0?a:-g,(o=this.orthoTop)!==null&&o!==void 0?o:g,this.minZ,this.maxZ,this._projectionMatrix,l.isNDCHalfZRange):P.OrthoOffCenterLHToRef((s=this.orthoLeft)!==null&&s!==void 0?s:-m,(u=this.orthoRight)!==null&&u!==void 0?u:m,(c=this.orthoBottom)!==null&&c!==void 0?c:-g,(p=this.orthoTop)!==null&&p!==void 0?p:g,this.minZ,this.maxZ,this._projectionMatrix,l.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=l.getRenderWidth(),this._cache.renderHeight=l.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix},e.prototype.getTransformationMatrix=function(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix},e.prototype._updateFrustumPlanes=function(){!this._refreshFrustumPlanes||(this.getTransformationMatrix(),this._frustumPlanes?L.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=L.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)},e.prototype.isInFrustum=function(t,r){if(r===void 0&&(r=!1),this._updateFrustumPlanes(),r&&this.rigCameras.length>0){var i=!1;return this.rigCameras.forEach(function(a){a._updateFrustumPlanes(),i=i||t.isInFrustum(a._frustumPlanes)}),i}else return t.isInFrustum(this._frustumPlanes)},e.prototype.isCompletelyInFrustum=function(t){return this._updateFrustumPlanes(),t.isCompletelyInFrustum(this._frustumPlanes)},e.prototype.getForwardRay=function(t,r,i){throw O("Ray")},e.prototype.getForwardRayToRef=function(t,r,i,a){throw O("Ray")},e.prototype.dispose=function(t,r){for(r===void 0&&(r=!1),this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){var i=this._rigCameras.pop();i&&i.dispose()}if(this._parentContainer){var a=this._parentContainer.cameras.indexOf(this);a>-1&&this._parentContainer.cameras.splice(a,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses=[];else if(this.cameraRigMode!==e.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses=[];else for(var o=this._postProcesses.length;--o>=0;){var s=this._postProcesses[o];s&&s.dispose(this)}for(var u=this.customRenderTargets.length;--u>=0;)this.customRenderTargets[u].dispose();this.customRenderTargets=[],this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),n.prototype.dispose.call(this,t,r)},Object.defineProperty(e.prototype,"isLeftCamera",{get:function(){return this._isLeftCamera},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isRightCamera",{get:function(){return this._isRightCamera},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"leftCamera",{get:function(){return this._rigCameras.length<1?null:this._rigCameras[0]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rightCamera",{get:function(){return this._rigCameras.length<2?null:this._rigCameras[1]},enumerable:!1,configurable:!0}),e.prototype.getLeftTarget=function(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()},e.prototype.getRightTarget=function(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()},e.prototype.setCameraRigMode=function(t,r){if(this.cameraRigMode!==t){for(;this._rigCameras.length>0;){var i=this._rigCameras.pop();i&&i.dispose()}if(this.cameraRigMode=t,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=r.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=D.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==e.RIG_MODE_NONE){var a=this.createRigCamera(this.name+"_L",0);a&&(a._isLeftCamera=!0);var o=this.createRigCamera(this.name+"_R",1);o&&(o._isRightCamera=!0),a&&o&&(this._rigCameras.push(a),this._rigCameras.push(o))}this._setRigMode(r),this._cascadePostProcessesToRigCams(),this.update()}},e.prototype._setRigMode=function(t){},e.prototype._getVRProjectionMatrix=function(){return P.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix},e.prototype._updateCameraRotationMatrix=function(){},e.prototype._updateWebVRCameraRotationMatrix=function(){},e.prototype._getWebVRProjectionMatrix=function(){return P.Identity()},e.prototype._getWebVRViewMatrix=function(){return P.Identity()},e.prototype.setCameraRigParameter=function(t,r){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[t]=r,t==="interaxialDistance"&&(this._cameraRigParams.stereoHalfAngle=D.ToRadians(r/.0637))},e.prototype.createRigCamera=function(t,r){return null},e.prototype._updateRigCameras=function(){for(var t=0;t<this._rigCameras.length;t++)this._rigCameras[t].minZ=this.minZ,this._rigCameras[t].maxZ=this.maxZ,this._rigCameras[t].fov=this.fov,this._rigCameras[t].upVector.copyFrom(this.upVector);this.cameraRigMode===e.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)},e.prototype._setupInputs=function(){},e.prototype.serialize=function(){var t=M.Serialize(this);return t.uniqueId=this.uniqueId,t.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(t),this.inputs&&this.inputs.serialize(t),M.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t.isEnabled=this.isEnabled(),t},e.prototype.clone=function(t,r){r===void 0&&(r=null);var i=M.Clone(e.GetConstructorFromName(this.getClassName(),t,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=t,i.parent=r,this.onClonedObservable.notifyObservers(i),i},e.prototype.getDirection=function(t){var r=S.Zero();return this.getDirectionToRef(t,r),r},Object.defineProperty(e.prototype,"absoluteRotation",{get:function(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation},enumerable:!1,configurable:!0}),e.prototype.getDirectionToRef=function(t,r){S.TransformNormalToRef(t,this.getWorldMatrix(),r)},e.GetConstructorFromName=function(t,r,i,a,o){a===void 0&&(a=0),o===void 0&&(o=!0);var s=C.Construct(t,r,i,{interaxial_distance:a,isStereoscopicSideBySide:o});return s||function(){return e._CreateDefaultParsedCamera(r,i)}},e.prototype.computeWorldMatrix=function(){return this.getWorldMatrix()},e.Parse=function(t,r){var i=t.type,a=e.GetConstructorFromName(i,t.name,r,t.interaxial_distance,t.isStereoscopicSideBySide),o=M.Parse(a,t,r);if(t.parentId!==void 0&&(o._waitingParentId=t.parentId),t.parentInstanceIndex!==void 0&&(o._waitingParentInstanceIndex=t.parentInstanceIndex),o.inputs&&(o.inputs.parse(t),o._setupInputs()),t.upVector&&(o.upVector=S.FromArray(t.upVector)),o.setPosition&&(o.position.copyFromFloats(0,0,0),o.setPosition(S.FromArray(t.position))),t.target&&o.setTarget&&o.setTarget(S.FromArray(t.target)),t.cameraRigMode){var s=t.interaxial_distance?{interaxialDistance:t.interaxial_distance}:{};o.setCameraRigMode(t.cameraRigMode,s)}if(t.animations){for(var u=0;u<t.animations.length;u++){var c=t.animations[u],p=V("BABYLON.Animation");p&&o.animations.push(p.Parse(c))}C.ParseAnimationRanges(o,t,r)}return t.autoAnimate&&r.beginAnimation(o,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),t.isEnabled!==void 0&&o.setEnabled(t.isEnabled),o},e._CreateDefaultParsedCamera=function(t,r){throw O("UniversalCamera")},e.PERSPECTIVE_CAMERA=0,e.ORTHOGRAPHIC_CAMERA=1,e.FOVMODE_VERTICAL_FIXED=0,e.FOVMODE_HORIZONTAL_FIXED=1,e.RIG_MODE_NONE=0,e.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,e.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,e.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,e.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,e.RIG_MODE_STEREOSCOPIC_INTERLACED=14,e.RIG_MODE_VR=20,e.RIG_MODE_WEBVR=21,e.RIG_MODE_CUSTOM=22,e.ForceAttachControlToAlwaysPreventDefault=!1,f([d("position")],e.prototype,"_position",void 0),f([d("upVector")],e.prototype,"_upVector",void 0),f([_()],e.prototype,"orthoLeft",void 0),f([_()],e.prototype,"orthoRight",void 0),f([_()],e.prototype,"orthoBottom",void 0),f([_()],e.prototype,"orthoTop",void 0),f([_()],e.prototype,"fov",void 0),f([_()],e.prototype,"projectionPlaneTilt",void 0),f([_()],e.prototype,"minZ",void 0),f([_()],e.prototype,"maxZ",void 0),f([_()],e.prototype,"inertia",void 0),f([_()],e.prototype,"mode",void 0),f([_()],e.prototype,"layerMask",void 0),f([_()],e.prototype,"fovMode",void 0),f([_()],e.prototype,"cameraRigMode",void 0),f([_()],e.prototype,"interaxialDistance",void 0),f([_()],e.prototype,"isStereoscopicSideBySide",void 0),e}(C),J=function(){function n(){}return n.BindSceneUniformBuffer=function(e,t){t.bindToEffect(e,"Scene")},n.PrepareDefinesForMergedUV=function(e,t,r){t._needUVs=!0,t[r]=!0,e.getTextureMatrix().isIdentityAs3x2()?(t[r+"DIRECTUV"]=e.coordinatesIndex+1,t["MAINUV"+(e.coordinatesIndex+1)]=!0):t[r+"DIRECTUV"]=0},n.BindTextureMatrix=function(e,t,r){var i=e.getTextureMatrix();t.updateMatrix(r+"Matrix",i)},n.GetFogState=function(e,t){return t.fogEnabled&&e.applyFog&&t.fogMode!==y.FOGMODE_NONE},n.PrepareDefinesForMisc=function(e,t,r,i,a,o,s){s._areMiscDirty&&(s.LOGARITHMICDEPTH=r,s.POINTSIZE=i,s.FOG=a&&this.GetFogState(e,t),s.NONUNIFORMSCALING=e.nonUniformScaling,s.ALPHATEST=o)},n.PrepareDefinesForFrameBoundValues=function(e,t,r,i,a,o){a===void 0&&(a=null),o===void 0&&(o=!1);var s=!1,u=!1,c=!1,p=!1,l=!1,h=!1,R=!1;u=a==null?e.clipPlane!==void 0&&e.clipPlane!==null:a,c=a==null?e.clipPlane2!==void 0&&e.clipPlane2!==null:a,p=a==null?e.clipPlane3!==void 0&&e.clipPlane3!==null:a,l=a==null?e.clipPlane4!==void 0&&e.clipPlane4!==null:a,h=a==null?e.clipPlane5!==void 0&&e.clipPlane5!==null:a,R=a==null?e.clipPlane6!==void 0&&e.clipPlane6!==null:a,r.CLIPPLANE!==u&&(r.CLIPPLANE=u,s=!0),r.CLIPPLANE2!==c&&(r.CLIPPLANE2=c,s=!0),r.CLIPPLANE3!==p&&(r.CLIPPLANE3=p,s=!0),r.CLIPPLANE4!==l&&(r.CLIPPLANE4=l,s=!0),r.CLIPPLANE5!==h&&(r.CLIPPLANE5=h,s=!0),r.CLIPPLANE6!==R&&(r.CLIPPLANE6=R,s=!0),r.DEPTHPREPASS!==!t.getColorWrite()&&(r.DEPTHPREPASS=!r.DEPTHPREPASS,s=!0),r.INSTANCES!==i&&(r.INSTANCES=i,s=!0),r.INSTANCESCOLOR&&!r.INSTANCES&&(r.INSTANCESCOLOR=!1,s=!0),r.THIN_INSTANCES!==o&&(r.THIN_INSTANCES=o,s=!0),s&&r.markAsUnprocessed()},n.PrepareDefinesForBones=function(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;var r=t.BONETEXTURE!==void 0;if(e.skeleton.isUsingTextureForMatrices&&r)t.BONETEXTURE=!0;else{t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=r?!1:void 0;var i=e.getScene().prePassRenderer;if(i&&i.enabled){var a=i.excludedSkinnedMesh.indexOf(e)===-1;t.BONES_VELOCITY_ENABLED=a}}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0},n.PrepareDefinesForMorphTargets=function(e,t){var r=e.morphTargetManager;r?(t.MORPHTARGETS_UV=r.supportsUVs&&t.UV1,t.MORPHTARGETS_TANGENT=r.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=r.supportsNormals&&t.NORMAL,t.MORPHTARGETS=r.numInfluencers>0,t.NUM_MORPH_INFLUENCERS=r.numInfluencers,t.MORPHTARGETS_TEXTURE=r.isUsingTextureForTargets):(t.MORPHTARGETS_UV=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)},n.PrepareDefinesForBakedVertexAnimation=function(e,t){var r=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!!(r&&r.isEnabled)},n.PrepareDefinesForAttributes=function(e,t,r,i,a,o,s){if(a===void 0&&(a=!1),o===void 0&&(o=!0),s===void 0&&(s=!0),!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent(E.NormalKind),t._needNormals&&e.isVerticesDataPresent(E.TangentKind)&&(t.TANGENT=!0);for(var u=1;u<=6;++u)t["UV"+u]=t._needUVs?e.isVerticesDataPresent("uv".concat(u===1?"":u)):!1;if(r){var c=e.useVertexColors&&e.isVerticesDataPresent(E.ColorKind);t.VERTEXCOLOR=c,t.VERTEXALPHA=e.hasVertexAlpha&&c&&o}return e.isVerticesDataPresent(E.ColorInstanceKind)&&(e.hasInstances||e.hasThinInstances)&&(t.INSTANCESCOLOR=!0),i&&this.PrepareDefinesForBones(e,t),a&&this.PrepareDefinesForMorphTargets(e,t),s&&this.PrepareDefinesForBakedVertexAnimation(e,t),!0},n.PrepareDefinesForMultiview=function(e,t){if(e.activeCamera){var r=t.MULTIVIEW;t.MULTIVIEW=e.activeCamera.outputRenderTarget!==null&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=r&&t.markAsUnprocessed()}},n.PrepareDefinesForOIT=function(e,t,r){var i=t.ORDER_INDEPENDENT_TRANSPARENCY,a=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&r,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,(i!==t.ORDER_INDEPENDENT_TRANSPARENCY||a!==t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&t.markAsUnprocessed()},n.PrepareDefinesForPrePass=function(e,t,r){var i=t.PREPASS;if(!!t._arePrePassDirty){var a=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&r){t.PREPASS=!0,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount;for(var o=0;o<a.length;o++){var s=e.prePassRenderer.getIndex(a[o].type);s!==-1?(t[a[o].define]=!0,t[a[o].index]=s):t[a[o].define]=!1}}else{t.PREPASS=!1;for(var o=0;o<a.length;o++)t[a[o].define]=!1}t.PREPASS!=i&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty())}},n.PrepareDefinesForLight=function(e,t,r,i,a,o,s){switch(s.needNormals=!0,a["LIGHT"+i]===void 0&&(s.needRebuild=!0),a["LIGHT"+i]=!0,a["SPOTLIGHT"+i]=!1,a["HEMILIGHT"+i]=!1,a["POINTLIGHT"+i]=!1,a["DIRLIGHT"+i]=!1,r.prepareLightSpecificDefines(a,i),a["LIGHT_FALLOFF_PHYSICAL"+i]=!1,a["LIGHT_FALLOFF_GLTF"+i]=!1,a["LIGHT_FALLOFF_STANDARD"+i]=!1,r.falloffType){case A.FALLOFF_GLTF:a["LIGHT_FALLOFF_GLTF"+i]=!0;break;case A.FALLOFF_PHYSICAL:a["LIGHT_FALLOFF_PHYSICAL"+i]=!0;break;case A.FALLOFF_STANDARD:a["LIGHT_FALLOFF_STANDARD"+i]=!0;break}if(o&&!r.specular.equalsFloats(0,0,0)&&(s.specularEnabled=!0),a["SHADOW"+i]=!1,a["SHADOWCSM"+i]=!1,a["SHADOWCSMDEBUG"+i]=!1,a["SHADOWCSMNUM_CASCADES"+i]=!1,a["SHADOWCSMUSESHADOWMAXZ"+i]=!1,a["SHADOWCSMNOBLEND"+i]=!1,a["SHADOWCSM_RIGHTHANDED"+i]=!1,a["SHADOWPCF"+i]=!1,a["SHADOWPCSS"+i]=!1,a["SHADOWPOISSON"+i]=!1,a["SHADOWESM"+i]=!1,a["SHADOWCLOSEESM"+i]=!1,a["SHADOWCUBE"+i]=!1,a["SHADOWLOWQUALITY"+i]=!1,a["SHADOWMEDIUMQUALITY"+i]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&r.shadowEnabled){var u=r.getShadowGenerator();if(u){var c=u.getShadowMap();c&&c.renderList&&c.renderList.length>0&&(s.shadowEnabled=!0,u.prepareDefines(a,i))}}r.lightmapMode!=A.LIGHTMAP_DEFAULT?(s.lightmapMode=!0,a["LIGHTMAPEXCLUDED"+i]=!0,a["LIGHTMAPNOSPECULAR"+i]=r.lightmapMode==A.LIGHTMAP_SHADOWSONLY):(a["LIGHTMAPEXCLUDED"+i]=!1,a["LIGHTMAPNOSPECULAR"+i]=!1)},n.PrepareDefinesForLights=function(e,t,r,i,a,o){if(a===void 0&&(a=4),o===void 0&&(o=!1),!r._areLightsDirty)return r._needNormals;var s=0,u={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!o)for(var c=0,p=t.lightSources;c<p.length;c++){var l=p[c];if(this.PrepareDefinesForLight(e,t,l,s,r,i,u),s++,s===a)break}r.SPECULARTERM=u.specularEnabled,r.SHADOWS=u.shadowEnabled;for(var h=s;h<a;h++)r["LIGHT"+h]!==void 0&&(r["LIGHT"+h]=!1,r["HEMILIGHT"+h]=!1,r["POINTLIGHT"+h]=!1,r["DIRLIGHT"+h]=!1,r["SPOTLIGHT"+h]=!1,r["SHADOW"+h]=!1,r["SHADOWCSM"+h]=!1,r["SHADOWCSMDEBUG"+h]=!1,r["SHADOWCSMNUM_CASCADES"+h]=!1,r["SHADOWCSMUSESHADOWMAXZ"+h]=!1,r["SHADOWCSMNOBLEND"+h]=!1,r["SHADOWCSM_RIGHTHANDED"+h]=!1,r["SHADOWPCF"+h]=!1,r["SHADOWPCSS"+h]=!1,r["SHADOWPOISSON"+h]=!1,r["SHADOWESM"+h]=!1,r["SHADOWCLOSEESM"+h]=!1,r["SHADOWCUBE"+h]=!1,r["SHADOWLOWQUALITY"+h]=!1,r["SHADOWMEDIUMQUALITY"+h]=!1);var R=e.getEngine().getCaps();return r.SHADOWFLOAT===void 0&&(u.needRebuild=!0),r.SHADOWFLOAT=u.shadowEnabled&&(R.textureFloatRender&&R.textureFloatLinearFiltering||R.textureHalfFloatRender&&R.textureHalfFloatLinearFiltering),r.LIGHTMAPEXCLUDED=u.lightmapMode,u.needRebuild&&r.rebuild(),u.needNormals},n.PrepareUniformsAndSamplersForLight=function(e,t,r,i,a,o){a===void 0&&(a=null),o===void 0&&(o=!1),a&&a.push("Light"+e),!o&&(t.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightFalloff"+e,"vLightGround"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),r.push("shadowSampler"+e),r.push("depthSampler"+e),t.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),i&&(r.push("projectionLightSampler"+e),t.push("textureProjectionMatrix"+e)))},n.PrepareUniformsAndSamplersList=function(e,t,r,i){i===void 0&&(i=4);var a,o=null;if(e.uniformsNames){var s=e;a=s.uniformsNames,o=s.uniformBuffersNames,t=s.samplers,r=s.defines,i=s.maxSimultaneousLights||0}else a=e,t||(t=[]);for(var u=0;u<i&&r["LIGHT"+u];u++)this.PrepareUniformsAndSamplersForLight(u,a,t,r["PROJECTEDLIGHTTEXTURE"+u],o);r.NUM_MORPH_INFLUENCERS&&a.push("morphTargetInfluences"),r.BAKED_VERTEX_ANIMATION_TEXTURE&&(a.push("bakedVertexAnimationSettings"),a.push("bakedVertexAnimationTextureSizeInverted"),a.push("bakedVertexAnimationTime"),t.push("bakedVertexAnimationTexture"))},n.HandleFallbacksForShadows=function(e,t,r,i){r===void 0&&(r=4),i===void 0&&(i=0);for(var a=0,o=0;o<r&&e["LIGHT"+o];o++)o>0&&(a=i+o,t.addFallback(a,"LIGHT"+o)),e.SHADOWS||(e["SHADOW"+o]&&t.addFallback(i,"SHADOW"+o),e["SHADOWPCF"+o]&&t.addFallback(i,"SHADOWPCF"+o),e["SHADOWPCSS"+o]&&t.addFallback(i,"SHADOWPCSS"+o),e["SHADOWPOISSON"+o]&&t.addFallback(i,"SHADOWPOISSON"+o),e["SHADOWESM"+o]&&t.addFallback(i,"SHADOWESM"+o),e["SHADOWCLOSEESM"+o]&&t.addFallback(i,"SHADOWCLOSEESM"+o));return a++},n.PrepareAttributesForMorphTargetsInfluencers=function(e,t,r){this._TmpMorphInfluencers.NUM_MORPH_INFLUENCERS=r,this.PrepareAttributesForMorphTargets(e,t,this._TmpMorphInfluencers)},n.PrepareAttributesForMorphTargets=function(e,t,r){var i=r.NUM_MORPH_INFLUENCERS;if(i>0&&I.LastCreatedEngine){var a=I.LastCreatedEngine.getCaps().maxVertexAttribs,o=t.morphTargetManager;if(o!=null&&o.isUsingTextureForTargets)return;for(var s=o&&o.supportsNormals&&r.NORMAL,u=o&&o.supportsTangents&&r.TANGENT,c=o&&o.supportsUVs&&r.UV1,p=0;p<i;p++)e.push(E.PositionKind+p),s&&e.push(E.NormalKind+p),u&&e.push(E.TangentKind+p),c&&e.push(E.UVKind+"_"+p),e.length>a&&N.Error("Cannot add more vertex attributes for mesh "+t.name)}},n.PrepareAttributesForBakedVertexAnimation=function(e,t,r){var i=r.BAKED_VERTEX_ANIMATION_TEXTURE&&r.INSTANCES;i&&e.push("bakedVertexAnimationSettingsInstanced")},n.PrepareAttributesForBones=function(e,t,r,i){r.NUM_BONE_INFLUENCERS>0&&(i.addCPUSkinningFallback(0,t),e.push(E.MatricesIndicesKind),e.push(E.MatricesWeightsKind),r.NUM_BONE_INFLUENCERS>4&&(e.push(E.MatricesIndicesExtraKind),e.push(E.MatricesWeightsExtraKind)))},n.PrepareAttributesForInstances=function(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&this.PushAttributesForInstances(e,!!t.PREPASS_VELOCITY),t.INSTANCESCOLOR&&e.push(E.ColorInstanceKind)},n.PushAttributesForInstances=function(e,t){t===void 0&&(t=!1),e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),t&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"))},n.BindLightProperties=function(e,t,r){e.transferToEffect(t,r+"")},n.BindLight=function(e,t,r,i,a,o){o===void 0&&(o=!0),e._bindLight(t,r,i,a,o)},n.BindLights=function(e,t,r,i,a){a===void 0&&(a=4);for(var o=Math.min(t.lightSources.length,a),s=0;s<o;s++){var u=t.lightSources[s];this.BindLight(u,s,e,r,typeof i=="boolean"?i:i.SPECULARTERM,t.receiveShadows)}},n.BindFogParameters=function(e,t,r,i){i===void 0&&(i=!1),e.fogEnabled&&t.applyFog&&e.fogMode!==y.FOGMODE_NONE&&(r.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),i?(e.fogColor.toLinearSpaceToRef(this._TempFogColor),r.setColor3("vFogColor",this._TempFogColor)):r.setColor3("vFogColor",e.fogColor))},n.BindBonesParameters=function(e,t,r){if(!(!t||!e)&&(e.computeBonesUsingShaders&&t._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=!1),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){var i=e.skeleton;if(i.isUsingTextureForMatrices&&t.getUniformIndex("boneTextureWidth")>-1){var a=i.getTransformMatrixTexture(e);t.setTexture("boneSampler",a),t.setFloat("boneTextureWidth",4*(i.bones.length+1))}else{var o=i.getTransformMatrices(e);o&&(t.setMatrices("mBones",o),r&&e.getScene().prePassRenderer&&e.getScene().prePassRenderer.getIndex(2)&&(r.previousBones[e.uniqueId]||(r.previousBones[e.uniqueId]=o.slice()),t.setMatrices("mPreviousBones",r.previousBones[e.uniqueId]),n._CopyBonesTransformationMatrices(o,r.previousBones[e.uniqueId])))}}},n._CopyBonesTransformationMatrices=function(e,t){return t.set(e),t},n.BindMorphTargetParameters=function(e,t){var r=e.morphTargetManager;!e||!r||t.setFloatArray("morphTargetInfluences",r.influences)},n.BindLogDepth=function(e,t,r){if(!e||e.LOGARITHMICDEPTH){var i=r.activeCamera;i.mode===B.ORTHOGRAPHIC_CAMERA&&N.Error("Logarithmic depth is not compatible with orthographic cameras!",20),t.setFloat("logarithmicDepthConstant",2/(Math.log(i.maxZ+1)/Math.LN2))}},n.BindClipPlane=function(e,t){G.BindClipPlane(e,t)},n._TmpMorphInfluencers={NUM_MORPH_INFLUENCERS:0},n._TempFogColor=U.Black(),n}();export{B as C,J as M};
