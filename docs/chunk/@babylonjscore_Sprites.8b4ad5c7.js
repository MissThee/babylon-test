import{_ as U}from"./tslibtslib.b6e59fa7.js";import{a as m,b as W,T as _,M as D,V as P}from"./@babylonjscore_Maths.42afce42.js";import{O as R,a as L,W as z,L as H}from"./@babylonjscore_Misc.329df4d9.js";import{S as M}from"./@babylonjscore_scene.b072ee35.js";import{R as E}from"./@babylonjscore_Culling.f738e368.js";import{P as O}from"./@babylonjscore_Collisions.8a0e928d.js";import{S as T}from"./@babylonjscore_sceneComponent.5f0854c6.js";import{A as b}from"./@babylonjscore_Actions.0e30626e.js";import{d as C,b as y,R as k,E as j,c as K}from"./@babylonjscore_Materials.49fd589a.js";import{B as N,V as w}from"./@babylonjscore_Buffers.c351261b.js";import{E as F,a as B}from"./@babylonjscore_Engines.a7c830c0.js";import"./@babylonjscore_Shaders.eb9cec10.js";import{C as G}from"./@babylonjscore_Meshes.896ebf22.js";var Z=function(){function s(){this.width=1,this.height=1,this.angle=0,this.invertU=!1,this.invertV=!1,this.isVisible=!0,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._time=0,this._onBaseAnimationEnd=null,this.position={x:1,y:1,z:1},this.color={r:1,g:1,b:1,a:1}}return Object.defineProperty(s.prototype,"animationStarted",{get:function(){return this._animationStarted},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"fromIndex",{get:function(){return this._fromIndex},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"toIndex",{get:function(){return this._toIndex},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"loopAnimation",{get:function(){return this._loopAnimation},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"delay",{get:function(){return Math.max(this._delay,1)},enumerable:!1,configurable:!0}),s.prototype.playAnimation=function(t,e,r,i,n){this._fromIndex=t,this._toIndex=e,this._loopAnimation=r,this._delay=i||1,this._animationStarted=!0,this._onBaseAnimationEnd=n,t<e?this._direction=1:(this._direction=-1,this._toIndex=t,this._fromIndex=e),this.cellIndex=t,this._time=0},s.prototype.stopAnimation=function(){this._animationStarted=!1},s.prototype._animate=function(t){!this._animationStarted||(this._time+=t,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,(this._direction>0&&this.cellIndex>this._toIndex||this._direction<0&&this.cellIndex<this._fromIndex)&&(this._loopAnimation?this.cellIndex=this._direction>0?this._fromIndex:this._toIndex:(this.cellIndex=this._toIndex,this._animationStarted=!1,this._onBaseAnimationEnd&&this._onBaseAnimationEnd()))))},s}(),q=function(s){U(t,s);function t(e,r){var i=s.call(this)||this;return i.name=e,i.animations=new Array,i.isPickable=!1,i.useAlphaForPicking=!1,i.onDisposeObservable=new R,i._onAnimationEnd=null,i._endAnimation=function(){i._onAnimationEnd&&i._onAnimationEnd(),i.disposeWhenFinishedAnimating&&i.dispose()},i.color=new W(1,1,1,1),i.position=m.Zero(),i._manager=r,i._manager.sprites.push(i),i.uniqueId=i._manager.scene.getUniqueId(),i}return Object.defineProperty(t.prototype,"size",{get:function(){return this.width},set:function(e){this.width=e,this.height=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"manager",{get:function(){return this._manager},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"Sprite"},Object.defineProperty(t.prototype,"fromIndex",{get:function(){return this._fromIndex},set:function(e){this.playAnimation(e,this._toIndex,this._loopAnimation,this._delay,this._onAnimationEnd)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"toIndex",{get:function(){return this._toIndex},set:function(e){this.playAnimation(this._fromIndex,e,this._loopAnimation,this._delay,this._onAnimationEnd)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loopAnimation",{get:function(){return this._loopAnimation},set:function(e){this.playAnimation(this._fromIndex,this._toIndex,e,this._delay,this._onAnimationEnd)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"delay",{get:function(){return Math.max(this._delay,1)},set:function(e){this.playAnimation(this._fromIndex,this._toIndex,this._loopAnimation,e,this._onAnimationEnd)},enumerable:!1,configurable:!0}),t.prototype.playAnimation=function(e,r,i,n,a){a===void 0&&(a=null),this._onAnimationEnd=a,s.prototype.playAnimation.call(this,e,r,i,n,this._endAnimation)},t.prototype.dispose=function(){for(var e=0;e<this._manager.sprites.length;e++)this._manager.sprites[e]==this&&this._manager.sprites.splice(e,1);this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},t.prototype.serialize=function(){var e={};return e.name=this.name,e.position=this.position.asArray(),e.color=this.color.asArray(),e.width=this.width,e.height=this.height,e.angle=this.angle,e.cellIndex=this.cellIndex,e.cellRef=this.cellRef,e.invertU=this.invertU,e.invertV=this.invertV,e.disposeWhenFinishedAnimating=this.disposeWhenFinishedAnimating,e.isPickable=this.isPickable,e.isVisible=this.isVisible,e.useAlphaForPicking=this.useAlphaForPicking,e.animationStarted=this.animationStarted,e.fromIndex=this.fromIndex,e.toIndex=this.toIndex,e.loopAnimation=this.loopAnimation,e.delay=this.delay,e},t.Parse=function(e,r){var i=new t(e.name,r);return i.position=m.FromArray(e.position),i.color=W.FromArray(e.color),i.width=e.width,i.height=e.height,i.angle=e.angle,i.cellIndex=e.cellIndex,i.cellRef=e.cellRef,i.invertU=e.invertU,i.invertV=e.invertV,i.disposeWhenFinishedAnimating=e.disposeWhenFinishedAnimating,i.isPickable=e.isPickable,i.isVisible=e.isVisible,i.useAlphaForPicking=e.useAlphaForPicking,i.fromIndex=e.fromIndex,i.toIndex=e.toIndex,i.loopAnimation=e.loopAnimation,i.delay=e.delay,e.animationStarted&&i.playAnimation(i.fromIndex,i.toIndex,i.loopAnimation,i.delay),i},t}(Z);M.prototype._internalPickSprites=function(s,t,e,r){if(!O)return null;var i=null;if(!r){if(!this.activeCamera)return null;r=this.activeCamera}if(this.spriteManagers.length>0)for(var n=0;n<this.spriteManagers.length;n++){var a=this.spriteManagers[n];if(!!a.isPickable){var o=a.intersects(s,r,t,e);if(!(!o||!o.hit)&&!(!e&&i!=null&&o.distance>=i.distance)&&(i=o,e))break}}return i||new O};M.prototype._internalMultiPickSprites=function(s,t,e){if(!O)return null;var r=new Array;if(!e){if(!this.activeCamera)return null;e=this.activeCamera}if(this.spriteManagers.length>0)for(var i=0;i<this.spriteManagers.length;i++){var n=this.spriteManagers[i];if(!!n.isPickable){var a=n.multiIntersects(s,e,t);a!==null&&(r=r.concat(a))}}return r};M.prototype.pickSprite=function(s,t,e,r,i){if(!this._tempSpritePickingRay)return null;this.createPickingRayInCameraSpaceToRef(s,t,this._tempSpritePickingRay,i);var n=this._internalPickSprites(this._tempSpritePickingRay,e,r,i);return n&&(n.ray=this.createPickingRayInCameraSpace(s,t,i)),n};M.prototype.pickSpriteWithRay=function(s,t,e,r){if(!this._tempSpritePickingRay)return null;if(!r){if(!this.activeCamera)return null;r=this.activeCamera}E.TransformToRef(s,r.getViewMatrix(),this._tempSpritePickingRay);var i=this._internalPickSprites(this._tempSpritePickingRay,t,e,r);return i&&(i.ray=s),i};M.prototype.multiPickSprite=function(s,t,e,r){return this.createPickingRayInCameraSpaceToRef(s,t,this._tempSpritePickingRay,r),this._internalMultiPickSprites(this._tempSpritePickingRay,e,r)};M.prototype.multiPickSpriteWithRay=function(s,t,e){if(!this._tempSpritePickingRay)return null;if(!e){if(!this.activeCamera)return null;e=this.activeCamera}return E.TransformToRef(s,e.getViewMatrix(),this._tempSpritePickingRay),this._internalMultiPickSprites(this._tempSpritePickingRay,t,e)};M.prototype.setPointerOverSprite=function(s){this._pointerOverSprite!==s&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(10,b.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=s,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(9,b.CreateNewFromSprite(this._pointerOverSprite,this)))};M.prototype.getPointerOverSprite=function(){return this._pointerOverSprite};var J=function(){function s(t){this.name=T.NAME_SPRITE,this.scene=t,this.scene.spriteManagers=new Array,this.scene._tempSpritePickingRay=E?E.Zero():null,this.scene.onBeforeSpritesRenderingObservable=new R,this.scene.onAfterSpritesRenderingObservable=new R,this._spritePredicate=function(e){return e.actionManager?e.isPickable&&e.actionManager.hasPointerTriggers:!1}}return s.prototype.register=function(){this.scene._pointerMoveStage.registerStep(T.STEP_POINTERMOVE_SPRITE,this,this._pointerMove),this.scene._pointerDownStage.registerStep(T.STEP_POINTERDOWN_SPRITE,this,this._pointerDown),this.scene._pointerUpStage.registerStep(T.STEP_POINTERUP_SPRITE,this,this._pointerUp)},s.prototype.rebuild=function(){},s.prototype.dispose=function(){this.scene.onBeforeSpritesRenderingObservable.clear(),this.scene.onAfterSpritesRenderingObservable.clear();for(var t=this.scene.spriteManagers;t.length;)t[0].dispose()},s.prototype._pickSpriteButKeepRay=function(t,e,r,i,n){var a=this.scene.pickSprite(e,r,this._spritePredicate,i,n);return a&&(a.ray=t?t.ray:null),a},s.prototype._pointerMove=function(t,e,r,i,n){var a=this.scene;return i?a.setPointerOverSprite(null):(r=this._pickSpriteButKeepRay(r,t,e,!1,a.cameraToUseForPointers||void 0),r&&r.hit&&r.pickedSprite?(a.setPointerOverSprite(r.pickedSprite),!a.doNotHandleCursors&&n&&(a._pointerOverSprite&&a._pointerOverSprite.actionManager&&a._pointerOverSprite.actionManager.hoverCursor?n.style.cursor=a._pointerOverSprite.actionManager.hoverCursor:n.style.cursor=a.hoverCursor)):a.setPointerOverSprite(null)),r},s.prototype._pointerDown=function(t,e,r,i){var n=this.scene;if(n._pickedDownSprite=null,n.spriteManagers.length>0&&(r=n.pickSprite(t,e,this._spritePredicate,!1,n.cameraToUseForPointers||void 0),r&&r.hit&&r.pickedSprite&&r.pickedSprite.actionManager)){switch(n._pickedDownSprite=r.pickedSprite,i.button){case 0:r.pickedSprite.actionManager.processTrigger(2,b.CreateNewFromSprite(r.pickedSprite,n,i));break;case 1:r.pickedSprite.actionManager.processTrigger(4,b.CreateNewFromSprite(r.pickedSprite,n,i));break;case 2:r.pickedSprite.actionManager.processTrigger(3,b.CreateNewFromSprite(r.pickedSprite,n,i));break}r.pickedSprite.actionManager&&r.pickedSprite.actionManager.processTrigger(5,b.CreateNewFromSprite(r.pickedSprite,n,i))}return r},s.prototype._pointerUp=function(t,e,r,i){var n=this.scene;if(n.spriteManagers.length>0){var a=n.pickSprite(t,e,this._spritePredicate,!1,n.cameraToUseForPointers||void 0);a&&(a.hit&&a.pickedSprite&&a.pickedSprite.actionManager&&(a.pickedSprite.actionManager.processTrigger(7,b.CreateNewFromSprite(a.pickedSprite,n,i)),a.pickedSprite.actionManager&&(this.scene._inputManager._isPointerSwiping()||a.pickedSprite.actionManager.processTrigger(1,b.CreateNewFromSprite(a.pickedSprite,n,i)))),n._pickedDownSprite&&n._pickedDownSprite.actionManager&&n._pickedDownSprite!==a.pickedSprite&&n._pickedDownSprite.actionManager.processTrigger(16,b.CreateNewFromSprite(n._pickedDownSprite,n,i)))}return r},s}(),Y=function(){function s(t,e,r,i){r===void 0&&(r=.01),i===void 0&&(i=null),this.blendMode=2,this.autoResetAlpha=!0,this.disableDepthWrite=!1,this.fogEnabled=!0,this._useVAO=!1,this._useInstancing=!1,this._vertexBuffers={},this._capacity=e,this._epsilon=r,this._engine=t,this._useInstancing=t.getCaps().instancedArrays&&t._features.supportSpriteInstancing,this._useVAO=t.getCaps().vertexArrayObject&&!t.disableVertexArrayObjects,this._scene=i,this._drawWrapperBase=new C(t),this._drawWrapperFog=new C(t),this._drawWrapperDepth=new C(t,!1),this._drawWrapperFogDepth=new C(t,!1),this._useInstancing||this._buildIndexBuffer(),this._drawWrapperBase.drawContext&&(this._drawWrapperBase.drawContext.useInstancing=this._useInstancing),this._drawWrapperFog.drawContext&&(this._drawWrapperFog.drawContext.useInstancing=this._useInstancing),this._drawWrapperDepth.drawContext&&(this._drawWrapperDepth.drawContext.useInstancing=this._useInstancing),this._drawWrapperFogDepth.drawContext&&(this._drawWrapperFogDepth.drawContext.useInstancing=this._useInstancing),this._vertexBufferSize=this._useInstancing?16:18,this._vertexData=new Float32Array(e*this._vertexBufferSize*(this._useInstancing?1:4)),this._buffer=new N(t,this._vertexData,!0,this._vertexBufferSize);var n=this._buffer.createVertexBuffer(w.PositionKind,0,4,this._vertexBufferSize,this._useInstancing),a=this._buffer.createVertexBuffer("options",4,2,this._vertexBufferSize,this._useInstancing),o=6,h;if(this._useInstancing){var p=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new N(t,p,!1,2),h=this._spriteBuffer.createVertexBuffer("offsets",0,2)}else h=this._buffer.createVertexBuffer("offsets",o,2,this._vertexBufferSize,this._useInstancing),o+=2;var f=this._buffer.createVertexBuffer("inverts",o,2,this._vertexBufferSize,this._useInstancing),u=this._buffer.createVertexBuffer("cellInfo",o+2,4,this._vertexBufferSize,this._useInstancing),l=this._buffer.createVertexBuffer(w.ColorKind,o+6,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[w.PositionKind]=n,this._vertexBuffers.options=a,this._vertexBuffers.offsets=h,this._vertexBuffers.inverts=f,this._vertexBuffers.cellInfo=u,this._vertexBuffers[w.ColorKind]=l,this._drawWrapperBase.effect=this._engine.createEffect("sprites",[w.PositionKind,"options","offsets","inverts","cellInfo",w.ColorKind],["view","projection","textureInfos","alphaTest"],["diffuseSampler"],""),this._drawWrapperDepth.effect=this._drawWrapperBase.effect,this._drawWrapperDepth.materialContext=this._drawWrapperBase.materialContext,this._scene&&(this._drawWrapperFog.effect=this._scene.getEngine().createEffect("sprites",[w.PositionKind,"options","offsets","inverts","cellInfo",w.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor"],["diffuseSampler"],"#define FOG"),this._drawWrapperFogDepth.effect=this._drawWrapperFog.effect,this._drawWrapperFogDepth.materialContext=this._drawWrapperFog.materialContext)}return Object.defineProperty(s.prototype,"capacity",{get:function(){return this._capacity},enumerable:!1,configurable:!0}),s.prototype.render=function(t,e,r,i,n){if(n===void 0&&(n=null),!(!this.texture||!this.texture.isReady()||!t.length)){var a=this._drawWrapperBase,o=this._drawWrapperDepth,h=!1;this.fogEnabled&&this._scene&&this._scene.fogEnabled&&this._scene.fogMode!==0&&(a=this._drawWrapperFog,o=this._drawWrapperFogDepth,h=!0);var p=a.effect;if(!!p.isReady()){for(var f=this._engine,u=!!(this._scene&&this._scene.useRightHandedSystem),l=this.texture.getBaseSize(),c=Math.min(this._capacity,t.length),d=0,g=!0,v=0;v<c;v++){var x=t[v];!x||!x.isVisible||(g=!1,x._animate(e),this._appendSpriteVertex(d++,x,0,0,l,u,n),this._useInstancing||(this._appendSpriteVertex(d++,x,1,0,l,u,n),this._appendSpriteVertex(d++,x,1,1,l,u,n),this._appendSpriteVertex(d++,x,0,1,l,u,n)))}if(!g){this._buffer.update(this._vertexData);var S=!!f.depthCullingState.cull,A=f.depthCullingState.zOffset,V=f.depthCullingState.zOffsetUnits;if(f.setState(S,A,!1,!1,void 0,void 0,V),f.enableEffect(a),p.setTexture("diffuseSampler",this.texture),p.setMatrix("view",r),p.setMatrix("projection",i),h){var I=this._scene;p.setFloat4("vFogInfos",I.fogMode,I.fogStart,I.fogEnd,I.fogDensity),p.setColor3("vFogColor",I.fogColor)}this._useVAO?(this._vertexArrayObject||(this._vertexArrayObject=f.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,p)),f.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):f.bindBuffers(this._vertexBuffers,this._indexBuffer,p),f.depthCullingState.depthFunc=f.useReverseDepthBuffer?518:515,this.disableDepthWrite||(p.setBool("alphaTest",!0),f.setColorWrite(!1),f.enableEffect(o),this._useInstancing?f.drawArraysType(7,0,4,d):f.drawElementsType(0,0,d/4*6),f.enableEffect(a),f.setColorWrite(!0),p.setBool("alphaTest",!1)),f.setAlphaMode(this.blendMode),this._useInstancing?f.drawArraysType(7,0,4,d):f.drawElementsType(0,0,d/4*6),this.autoResetAlpha&&f.setAlphaMode(0),u&&this._scene.getEngine().setState(S,A,!1,!0,void 0,void 0,V),f.unbindInstanceAttributes()}}}},s.prototype._appendSpriteVertex=function(t,e,r,i,n,a,o){var h=t*this._vertexBufferSize;if(r===0?r=this._epsilon:r===1&&(r=1-this._epsilon),i===0?i=this._epsilon:i===1&&(i=1-this._epsilon),o)o(e,n);else{e.cellIndex||(e.cellIndex=0);var p=n.width/this.cellWidth,f=e.cellIndex/p>>0;e._xOffset=(e.cellIndex-f*p)*this.cellWidth/n.width,e._yOffset=f*this.cellHeight/n.height,e._xSize=this.cellWidth,e._ySize=this.cellHeight}this._vertexData[h]=e.position.x,this._vertexData[h+1]=e.position.y,this._vertexData[h+2]=e.position.z,this._vertexData[h+3]=e.angle,this._vertexData[h+4]=e.width,this._vertexData[h+5]=e.height,this._useInstancing?h-=2:(this._vertexData[h+6]=r,this._vertexData[h+7]=i),a?this._vertexData[h+8]=e.invertU?0:1:this._vertexData[h+8]=e.invertU?1:0,this._vertexData[h+9]=e.invertV?1:0,this._vertexData[h+10]=e._xOffset,this._vertexData[h+11]=e._yOffset,this._vertexData[h+12]=e._xSize/n.width,this._vertexData[h+13]=e._ySize/n.height,this._vertexData[h+14]=e.color.r,this._vertexData[h+15]=e.color.g,this._vertexData[h+16]=e.color.b,this._vertexData[h+17]=e.color.a},s.prototype._buildIndexBuffer=function(){for(var t=[],e=0,r=0;r<this._capacity;r++)t.push(e),t.push(e+1),t.push(e+2),t.push(e),t.push(e+2),t.push(e+3),e+=4;this._indexBuffer=this._engine.createIndexBuffer(t)},s.prototype.rebuild=function(){var t;this._indexBuffer&&this._buildIndexBuffer(),this._useVAO&&(this._vertexArrayObject=void 0),this._buffer._rebuild();for(var e in this._vertexBuffers){var r=this._vertexBuffers[e];r._rebuild()}(t=this._spriteBuffer)===null||t===void 0||t._rebuild()},s.prototype.dispose=function(){this._buffer&&(this._buffer.dispose(),this._buffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this.texture&&(this.texture.dispose(),this.texture=null),this._drawWrapperBase.dispose(),this._drawWrapperFog.dispose(),this._drawWrapperDepth.dispose(),this._drawWrapperFogDepth.dispose()},s}(),X=function(){function s(t,e,r,i,n,a,o,h,p){a===void 0&&(a=.01),o===void 0&&(o=y.TRILINEAR_SAMPLINGMODE),h===void 0&&(h=!1),p===void 0&&(p=null);var f=this;this.name=t,this.sprites=new Array,this.renderingGroupId=0,this.layerMask=268435455,this.isPickable=!1,this.onDisposeObservable=new R,this._disableDepthWrite=!1,this._packedAndReady=!1,this._customUpdate=function(l,c){l.cellRef||(l.cellIndex=0);var d=l.cellIndex;typeof d=="number"&&isFinite(d)&&Math.floor(d)===d&&(l.cellRef=f._spriteMap[l.cellIndex]),l._xOffset=f._cellData[l.cellRef].frame.x/c.width,l._yOffset=f._cellData[l.cellRef].frame.y/c.height,l._xSize=f._cellData[l.cellRef].frame.w,l._ySize=f._cellData[l.cellRef].frame.h},n||(n=F.LastCreatedScene),n._getComponent(T.NAME_SPRITE)||n._addComponent(new J(n)),this._fromPacked=h,this._scene=n;var u=this._scene.getEngine();if(this._spriteRenderer=new Y(u,r,a,n),i.width&&i.height)this.cellWidth=i.width,this.cellHeight=i.height;else if(i!==void 0)this.cellWidth=i,this.cellHeight=i;else{this._spriteRenderer=null;return}this._scene.spriteManagers.push(this),this.uniqueId=this.scene.getUniqueId(),e&&(this.texture=new y(e,n,!0,!1,o)),this._fromPacked&&this._makePacked(e,p)}return Object.defineProperty(s.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"children",{get:function(){return this.sprites},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"capacity",{get:function(){return this._spriteRenderer.capacity},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"texture",{get:function(){return this._spriteRenderer.texture},set:function(t){t.wrapU=y.CLAMP_ADDRESSMODE,t.wrapV=y.CLAMP_ADDRESSMODE,this._spriteRenderer.texture=t,this._textureContent=null},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"cellWidth",{get:function(){return this._spriteRenderer.cellWidth},set:function(t){this._spriteRenderer.cellWidth=t},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"cellHeight",{get:function(){return this._spriteRenderer.cellHeight},set:function(t){this._spriteRenderer.cellHeight=t},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"fogEnabled",{get:function(){return this._spriteRenderer.fogEnabled},set:function(t){this._spriteRenderer.fogEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"blendMode",{get:function(){return this._spriteRenderer.blendMode},set:function(t){this._spriteRenderer.blendMode=t},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"disableDepthWrite",{get:function(){return this._disableDepthWrite},set:function(t){this._disableDepthWrite=t,this._spriteRenderer.disableDepthWrite=t},enumerable:!1,configurable:!0}),s.prototype.getClassName=function(){return"SpriteManager"},s.prototype._makePacked=function(t,e){var r=this;if(e!==null)try{var i=void 0;if(typeof e=="string"?i=JSON.parse(e):i=e,i.frames.length){for(var n={},a=0;a<i.frames.length;a++){var o=i.frames[a];if(typeof Object.keys(o)[0]!="string")throw new Error("Invalid JSON Format.  Check the frame values and make sure the name is the first parameter.");var h=o[Object.keys(o)[0]];n[h]=o}i.frames=n}var p=Reflect.ownKeys(i.frames);this._spriteMap=p,this._packedAndReady=!0,this._cellData=i.frames}catch{throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON from string. Spritesheet managed with constant cell size.")}else{var f=/\./g,u=void 0;do u=f.lastIndex,f.test(t);while(f.lastIndex>0);var l=t.substring(0,u-1)+".json",c=function(){H.Error("JSON ERROR: Unable to load JSON file."),r._fromPacked=!1,r._packedAndReady=!1},d=function(g){try{var v=JSON.parse(g),x=Reflect.ownKeys(v.frames);r._spriteMap=x,r._packedAndReady=!0,r._cellData=v.frames}catch{throw r._fromPacked=!1,r._packedAndReady=!1,new Error("Invalid JSON format. Please check documentation for format specifications.")}};L.LoadFile(l,d,void 0,void 0,!1,c)}},s.prototype._checkTextureAlpha=function(t,e,r,i,n){if(!t.useAlphaForPicking||!this.texture)return!0;var a=this.texture.getSize();this._textureContent||(this._textureContent=new Uint8Array(a.width*a.height*4),this.texture.readPixels(0,0,this._textureContent));var o=_.Vector3[0];o.copyFrom(e.direction),o.normalize(),o.scaleInPlace(r),o.addInPlace(e.origin);var h=(o.x-i.x)/(n.x-i.x)-.5,p=1-(o.y-i.y)/(n.y-i.y)-.5,f=t.angle,u=.5+(h*Math.cos(f)-p*Math.sin(f)),l=.5+(h*Math.sin(f)+p*Math.cos(f)),c=t._xOffset*a.width+u*t._xSize|0,d=t._yOffset*a.height+l*t._ySize|0,g=this._textureContent[(c+d*a.width)*4+3];return g>.5},s.prototype.intersects=function(t,e,r,i){for(var n=Math.min(this.capacity,this.sprites.length),a=m.Zero(),o=m.Zero(),h=Number.MAX_VALUE,p=null,f=_.Vector3[0],u=_.Vector3[1],l=e.getViewMatrix(),c=t,d=t,g=0;g<n;g++){var v=this.sprites[g];if(!!v){if(r){if(!r(v))continue}else if(!v.isPickable)continue;if(m.TransformCoordinatesToRef(v.position,l,u),v.angle?(D.TranslationToRef(-u.x,-u.y,0,_.Matrix[1]),D.TranslationToRef(u.x,u.y,0,_.Matrix[2]),D.RotationZToRef(v.angle,_.Matrix[3]),_.Matrix[1].multiplyToRef(_.Matrix[3],_.Matrix[4]),_.Matrix[4].multiplyToRef(_.Matrix[2],_.Matrix[0]),c=t.clone(),m.TransformCoordinatesToRef(t.origin,_.Matrix[0],c.origin),m.TransformNormalToRef(t.direction,_.Matrix[0],c.direction)):c=t,a.copyFromFloats(u.x-v.width/2,u.y-v.height/2,u.z),o.copyFromFloats(u.x+v.width/2,u.y+v.height/2,u.z),c.intersectsBoxMinMax(a,o)){var x=m.Distance(u,c.origin);if(h>x){if(!this._checkTextureAlpha(v,c,x,a,o))continue;if(d=c,h=x,p=v,i)break}}}}if(p){var S=new O;l.invertToRef(_.Matrix[0]),S.hit=!0,S.pickedSprite=p,S.distance=h;var A=_.Vector3[2];return A.copyFrom(d.direction),A.normalize(),A.scaleInPlace(h),d.origin.addToRef(A,f),S.pickedPoint=m.TransformCoordinates(f,_.Matrix[0]),S}return null},s.prototype.multiIntersects=function(t,e,r){for(var i=Math.min(this.capacity,this.sprites.length),n=m.Zero(),a=m.Zero(),o,h=[],p=_.Vector3[0].copyFromFloats(0,0,0),f=_.Vector3[1].copyFromFloats(0,0,0),u=e.getViewMatrix(),l=0;l<i;l++){var c=this.sprites[l];if(!!c){if(r){if(!r(c))continue}else if(!c.isPickable)continue;if(m.TransformCoordinatesToRef(c.position,u,f),n.copyFromFloats(f.x-c.width/2,f.y-c.height/2,f.z),a.copyFromFloats(f.x+c.width/2,f.y+c.height/2,f.z),t.intersectsBoxMinMax(n,a)){if(o=m.Distance(f,t.origin),!this._checkTextureAlpha(c,t,o,n,a))continue;var d=new O;h.push(d),u.invertToRef(_.Matrix[0]),d.hit=!0,d.pickedSprite=c,d.distance=o;var g=_.Vector3[2];g.copyFrom(t.direction),g.normalize(),g.scaleInPlace(o),t.origin.addToRef(g,p),d.pickedPoint=m.TransformCoordinates(p,_.Matrix[0])}}}return h},s.prototype.render=function(){if(!(this._fromPacked&&(!this._packedAndReady||!this._spriteMap||!this._cellData))){var t=this._scene.getEngine(),e=t.getDeltaTime();this._packedAndReady?this._spriteRenderer.render(this.sprites,e,this._scene.getViewMatrix(),this._scene.getProjectionMatrix(),this._customUpdate):this._spriteRenderer.render(this.sprites,e,this._scene.getViewMatrix(),this._scene.getProjectionMatrix())}},s.prototype.rebuild=function(){var t;(t=this._spriteRenderer)===null||t===void 0||t.rebuild()},s.prototype.dispose=function(){this._spriteRenderer&&(this._spriteRenderer.dispose(),this._spriteRenderer=null),this._textureContent=null;var t=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},s.prototype.serialize=function(t){t===void 0&&(t=!1);var e={};e.name=this.name,e.capacity=this.capacity,e.cellWidth=this.cellWidth,e.cellHeight=this.cellHeight,this.texture&&(t?e.texture=this.texture.serialize():(e.textureUrl=this.texture.name,e.invertY=this.texture._invertY)),e.sprites=[];for(var r=0,i=this.sprites;r<i.length;r++){var n=i[r];e.sprites.push(n.serialize())}return e},s.Parse=function(t,e,r){var i=new s(t.name,"",t.capacity,{width:t.cellWidth,height:t.cellHeight},e);t.texture?i.texture=y.Parse(t.texture,e,r):t.textureName&&(i.texture=new y(r+t.textureUrl,e,!1,t.invertY!==void 0?t.invertY:!0));for(var n=0,a=t.sprites;n<a.length;n++){var o=a[n];q.Parse(o,i)}return i},s.ParseFromFileAsync=function(t,e,r,i){return i===void 0&&(i=""),new Promise(function(n,a){var o=new z;o.addEventListener("readystatechange",function(){if(o.readyState==4)if(o.status==200){var h=JSON.parse(o.responseText),p=s.Parse(h,r||F.LastCreatedScene,i);t&&(p.name=t),n(p)}else a("Unable to load the sprite manager")}),o.open("GET",e),o.send()})},s.ParseFromSnippetAsync=function(t,e,r){var i=this;return r===void 0&&(r=""),t==="_BLANK"?Promise.resolve(new s("Default sprite manager","//playground.babylonjs.com/textures/player.png",500,64,e)):new Promise(function(n,a){var o=new z;o.addEventListener("readystatechange",function(){if(o.readyState==4)if(o.status==200){var h=JSON.parse(JSON.parse(o.responseText).jsonPayload),p=JSON.parse(h.spriteManager),f=s.Parse(p,e||F.LastCreatedScene,r);f.snippetId=t,n(f)}else a("Unable to load the snippet "+t)}),o.open("GET",i.SnippetUrl+"/"+t.replace(/#/g,"/")),o.send()})},s.SnippetUrl="https://snippet.babylonjs.com",s.CreateFromSnippetAsync=s.ParseFromSnippetAsync,s}();(function(){function s(t,e,r,i,n){var a=this;this.name=t,this.sprites=[],this.atlasJSON=e,this.sprites=this.atlasJSON.frames,this.spriteSheet=r,this.options=i,i.stageSize=i.stageSize||new P(1,1),i.outputSize=i.outputSize||i.stageSize,i.outputPosition=i.outputPosition||m.Zero(),i.outputRotation=i.outputRotation||m.Zero(),i.layerCount=i.layerCount||1,i.maxAnimationFrames=i.maxAnimationFrames||0,i.baseTile=i.baseTile||0,i.flipU=i.flipU||!1,i.colorMultiply=i.colorMultiply||new m(1,1,1),this._scene=n,this._frameMap=this._createFrameBuffer(),this._tileMaps=new Array;for(var o=0;o<i.layerCount;o++)this._tileMaps.push(this._createTileBuffer(null,o));this._animationMap=this._createTileAnimationBuffer(null);var h=[];h.push("#define LAYERS "+i.layerCount),i.flipU&&h.push("#define FLIPU"),h.push("#define MAX_ANIMATION_FRAMES ".concat(i.maxAnimationFrames,".0"));var p=j.ShadersStore.spriteMapPixelShader,f;if(n.getEngine()._features.supportSwitchCaseInShader){f="switch(i) {";for(var o=0;o<i.layerCount;o++)f+="case "+o+" : frameID = texture(tileMaps["+o+"], (tileID + 0.5) / stageSize, 0.).x;",f+="break;";f+="}"}else{f="";for(var o=0;o<i.layerCount;o++)f+="if (".concat(o," == i) { frameID = texture2D(tileMaps[").concat(o,"], (tileID + 0.5) / stageSize, 0.).x; }")}j.ShadersStore["spriteMap"+this.name+"PixelShader"]=p.replace("#define LAYER_ID_SWITCH",f),this._material=new K("spriteMap:"+this.name,this._scene,{vertex:"spriteMap",fragment:"spriteMap"+this.name},{defines:h,attributes:["position","normal","uv"],uniforms:["worldViewProjection","time","stageSize","outputSize","spriteMapSize","spriteCount","time","colorMul","mousePosition","curTile","flipU"],samplers:["spriteSheet","frameMap","tileMaps","animationMap"],needAlphaBlending:!0}),this._time=0,this._material.setFloat("spriteCount",this.spriteCount),this._material.setVector2("stageSize",i.stageSize),this._material.setVector2("outputSize",i.outputSize),this._material.setTexture("spriteSheet",this.spriteSheet),this._material.setVector2("spriteMapSize",new P(1,1)),this._material.setVector3("colorMul",i.colorMultiply);var u=0,l=function(){if(a.spriteSheet&&a.spriteSheet.isReady()&&a.spriteSheet._texture){a._material.setVector2("spriteMapSize",new P(a.spriteSheet._texture.baseWidth||1,a.spriteSheet._texture.baseHeight||1));return}u<100&&setTimeout(function(){u++,l()},100)};l(),this._material.setVector3("colorMul",i.colorMultiply),this._material.setTexture("frameMap",this._frameMap),this._material.setTextureArray("tileMaps",this._tileMaps),this._material.setTexture("animationMap",this._animationMap),this._material.setFloat("time",this._time),this._output=G(t+":output",{size:1,updatable:!0},n),this._output.scaling.x=i.outputSize.x,this._output.scaling.y=i.outputSize.y,this.position=i.outputPosition,this.rotation=i.outputRotation;var c=function(){a._time+=a._scene.getEngine().getDeltaTime(),a._material.setFloat("time",a._time)};this._scene.onBeforeRenderObservable.add(c),this._output.material=this._material}return Object.defineProperty(s.prototype,"spriteCount",{get:function(){return this.sprites.length},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"position",{get:function(){return this._output.position},set:function(t){this._output.position=t},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"rotation",{get:function(){return this._output.rotation},set:function(t){this._output.rotation=t},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"animationMap",{get:function(){return this._animationMap},set:function(t){var e=t._texture._bufferView,r=this._createTileAnimationBuffer(e);this._animationMap.dispose(),this._animationMap=r,this._material.setTexture("animationMap",this._animationMap)},enumerable:!1,configurable:!0}),s.prototype.getTileID=function(){var t=this.getMousePosition();return t.multiplyInPlace(this.options.stageSize||P.Zero()),t.x=Math.floor(t.x),t.y=Math.floor(t.y),t},s.prototype.getMousePosition=function(){var t=this._output,e=this._scene.pick(this._scene.pointerX,this._scene.pointerY,function(i){return i===t});if(!e||!e.hit||!e.getTextureCoordinates)return new P(-1,-1);var r=e.getTextureCoordinates();return r||new P(-1,-1)},s.prototype._createFrameBuffer=function(){for(var t=new Array,e=0;e<this.spriteCount;e++)t.push(0,0,0,0),t.push(0,0,0,0),t.push(0,0,0,0),t.push(0,0,0,0);for(var e=0;e<this.spriteCount;e++){var r=this.sprites[e].frame,i=this.sprites[e].spriteSourceSize,n=this.sprites[e].sourceSize,a=this.sprites[e].rotated?1:0,o=this.sprites[e].trimmed?1:0;t[e*4]=r.x,t[e*4+1]=r.y,t[e*4+2]=r.w,t[e*4+3]=r.h,t[e*4+this.spriteCount*4]=i.x,t[e*4+1+this.spriteCount*4]=i.y,t[e*4+3+this.spriteCount*4]=i.h,t[e*4+this.spriteCount*8]=n.w,t[e*4+1+this.spriteCount*8]=n.h,t[e*4+2+this.spriteCount*8]=a,t[e*4+3+this.spriteCount*8]=o}var h=new Float32Array(t),p=k.CreateRGBATexture(h,this.spriteCount,4,this._scene,!1,!1,y.NEAREST_NEAREST,B.TEXTURETYPE_FLOAT);return p},s.prototype._createTileBuffer=function(t,e){e===void 0&&(e=0);var r=new Array,i=this.options.stageSize.y||0,n=this.options.stageSize.x||0;if(t)r=t;else{var a=this.options.baseTile;e!=0&&(a=0);for(var o=0;o<i;o++)for(var h=0;h<n*4;h+=4)r.push(a,0,0,0)}var p=new Float32Array(r),f=k.CreateRGBATexture(p,n,i,this._scene,!1,!1,y.NEAREST_NEAREST,B.TEXTURETYPE_FLOAT);return f},s.prototype.changeTiles=function(t,e,r){t===void 0&&(t=0),r===void 0&&(r=0);var i=this._tileMaps[t]._texture._bufferView;if(i!==null){var n=new Array;e instanceof P?n.push(e):n=e;for(var a=this.options.stageSize.x||0,o=0;o<n.length;o++){var h=n[o];h.x=Math.floor(h.x),h.y=Math.floor(h.y);var p=h.x*4+h.y*(a*4);i[p]=r}var f=this._createTileBuffer(i);this._tileMaps[t].dispose(),this._tileMaps[t]=f,this._material.setTextureArray("tileMap",this._tileMaps)}},s.prototype._createTileAnimationBuffer=function(t){var e=new Array,r;if(t)r=t;else{for(var i=0;i<this.spriteCount;i++){e.push(0,0,0,0);for(var n=1;n<(this.options.maxAnimationFrames||4);)e.push(0,0,0,0),n++}r=new Float32Array(e)}var a=k.CreateRGBATexture(r,this.spriteCount,this.options.maxAnimationFrames||4,this._scene,!1,!1,y.NEAREST_NEAREST,B.TEXTURETYPE_FLOAT);return a},s.prototype.addAnimationToTile=function(t,e,r,i,n){t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),i===void 0&&(i=0),n===void 0&&(n=1);var a=this._animationMap._texture._bufferView,o=t*4+this.spriteCount*4*e;if(!!a){a[o]=r,a[o+1]=i,a[o+2]=n;var h=this._createTileAnimationBuffer(a);this._animationMap.dispose(),this._animationMap=h,this._material.setTexture("animationMap",this._animationMap)}},s.prototype.saveTileMaps=function(){for(var t="",e=0;e<this._tileMaps.length;e++)e>0&&(t+=`
\r`),t+=this._tileMaps[e]._texture._bufferView.toString();var r=document.createElement("a");r.href="data:octet/stream;charset=utf-8,"+encodeURI(t),r.target="_blank",r.download=this.name+".tilemaps",r.click(),r.remove()},s.prototype.loadTileMaps=function(t){var e=this,r=new XMLHttpRequest;r.open("GET",t);var i=this.options.layerCount||0;r.onload=function(){for(var n=r.response.split(`
\r`),a=0;a<i;a++){var o=n[a].split(",").map(Number),h=e._createTileBuffer(o);e._tileMaps[a].dispose(),e._tileMaps[a]=h}e._material.setTextureArray("tileMap",e._tileMaps)},r.send()},s.prototype.dispose=function(){this._output.dispose(),this._material.dispose(),this._animationMap.dispose(),this._tileMaps.forEach(function(t){t.dispose()}),this._frameMap.dispose()},s})();(function(s){U(t,s);function t(e,r,i,n,a,o,h){a===void 0&&(a=null),o===void 0&&(o=.01),h===void 0&&(h=y.TRILINEAR_SAMPLINGMODE);var p=s.call(this,e,r,i,64,n,o,h,!0,a)||this;return p.name=e,p}return t})(X);
