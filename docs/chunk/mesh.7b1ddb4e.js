import{a as l,V as S,l as P,m as J,C as de,o as ve,_ as fe,k as ue,O as q,L as W,B as ee,p as j,b as Y,q as ge,r as te,S as ie,Q as re,M as Q,i as _e,G as ne,c as ye,D as pe}from"./test1.990751a6.js";import{V as F,r as me,a as De,A as Ie,c as be}from"./abstractMesh.8bf71ac2.js";import{N as ae}from"./node.0c51c0e0.js";import{S as z,M as R}from"./material.4eb4d890.js";import{B as se}from"./boundingInfo.71d69726.js";import{e as Me}from"./math.functions.ef221795.js";import{C as H}from"./thinMaterialHelper.ab63cfd8.js";var le=function(){function v(){}return Object.defineProperty(v,"ForceFullSceneLoadingForIncremental",{get:function(){return v._ForceFullSceneLoadingForIncremental},set:function(t){v._ForceFullSceneLoadingForIncremental=t},enumerable:!1,configurable:!0}),Object.defineProperty(v,"ShowLoadingScreen",{get:function(){return v._ShowLoadingScreen},set:function(t){v._ShowLoadingScreen=t},enumerable:!1,configurable:!0}),Object.defineProperty(v,"loggingLevel",{get:function(){return v._LoggingLevel},set:function(t){v._LoggingLevel=t},enumerable:!1,configurable:!0}),Object.defineProperty(v,"CleanBoneMatrixWeights",{get:function(){return v._CleanBoneMatrixWeights},set:function(t){v._CleanBoneMatrixWeights=t},enumerable:!1,configurable:!0}),v._ForceFullSceneLoadingForIncremental=!1,v._ShowLoadingScreen=!0,v._CleanBoneMatrixWeights=!1,v._LoggingLevel=0,v}(),k=function(){function v(t,e,i,n,r){n===void 0&&(n=!1),r===void 0&&(r=null),this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=e||ve.LastCreatedScene,this._scene&&(this.id=t,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=n,i?this.setAllVerticesData(i,n):(this._totalVertices=0,this._indices=[]),this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),r&&(this.applyToMesh(r),r.computeWorldMatrix(!0)))}return Object.defineProperty(v.prototype,"boundingBias",{get:function(){return this._boundingBias},set:function(t){this._boundingBias?this._boundingBias.copyFrom(t):this._boundingBias=t.clone(),this._updateBoundingInfo(!0,null)},enumerable:!1,configurable:!0}),v.CreateGeometryForMesh=function(t){var e=new v(v.RandomId(),t.getScene());return e.applyToMesh(t),e},Object.defineProperty(v.prototype,"meshes",{get:function(){return this._meshes},enumerable:!1,configurable:!0}),Object.defineProperty(v.prototype,"extend",{get:function(){return this._extend},enumerable:!1,configurable:!0}),v.prototype.getScene=function(){return this._scene},v.prototype.getEngine=function(){return this._engine},v.prototype.isReady=function(){return this.delayLoadState===1||this.delayLoadState===0},Object.defineProperty(v.prototype,"doNotSerialize",{get:function(){for(var t=0;t<this._meshes.length;t++)if(!this._meshes[t].doNotSerialize)return!1;return!0},enumerable:!1,configurable:!0}),v.prototype._rebuild=function(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable));for(var t in this._vertexBuffers){var e=this._vertexBuffers[t];e._rebuild()}},v.prototype.setAllVerticesData=function(t,e){t.applyToGeometry(this,e),this._notifyUpdate()},v.prototype.setVerticesData=function(t,e,i,n){i===void 0&&(i=!1),i&&Array.isArray(e)&&(e=new Float32Array(e));var r=new l(this._engine,e,t,i,this._meshes.length===0,n);this.setVerticesBuffer(r)},v.prototype.removeVerticesData=function(t){this._vertexBuffers[t]&&(this._vertexBuffers[t].dispose(),delete this._vertexBuffers[t]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()},v.prototype.setVerticesBuffer=function(t,e,i){e===void 0&&(e=null),i===void 0&&(i=!0);var n=t.getKind();this._vertexBuffers[n]&&i&&this._vertexBuffers[n].dispose(),t._buffer&&t._buffer._increaseReferences(),this._vertexBuffers[n]=t;var r=this._meshes,s=r.length;if(n===l.PositionKind){var a=t.getData();e!=null?this._totalVertices=e:a!=null&&(this._totalVertices=a.length/(t.type===l.BYTE?t.byteStride:t.byteStride/4)),this._updateExtend(a),this._resetPointsArrayCache();for(var o=0;o<s;o++){var f=r[o];f.buildBoundingInfo(this._extend.minimum,this._extend.maximum),f._createGlobalSubMesh(f.isUnIndexed),f.computeWorldMatrix(!0),f.synchronizeInstances()}}this._notifyUpdate(n)},v.prototype.updateVerticesDataDirectly=function(t,e,i,n){n===void 0&&(n=!1);var r=this.getVertexBuffer(t);!r||(r.updateDirectly(e,i,n),this._notifyUpdate(t))},v.prototype.updateVerticesData=function(t,e,i){i===void 0&&(i=!1);var n=this.getVertexBuffer(t);!n||(n.update(e),t===l.PositionKind&&this._updateBoundingInfo(i,e),this._notifyUpdate(t))},v.prototype._updateBoundingInfo=function(t,e){if(t&&this._updateExtend(e),this._resetPointsArrayCache(),t)for(var i=this._meshes,n=0,r=i;n<r.length;n++){var s=r[n];s.hasBoundingInfo?s.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):s.buildBoundingInfo(this._extend.minimum,this._extend.maximum);for(var a=s.subMeshes,o=0,f=a;o<f.length;o++){var h=f[o];h.refreshBoundingInfo()}}},v.prototype._bind=function(t,e,i,n){if(!!t){e===void 0&&(e=this._indexBuffer);var r=this.getVertexBuffers();if(!!r){if(e!=this._indexBuffer||!this._vertexArrayObjects&&!n){this._engine.bindBuffers(r,e,t,i);return}var s=n||this._vertexArrayObjects;s[t.key]||(s[t.key]=this._engine.recordVertexArrayObject(r,e,t,i)),this._engine.bindVertexArrayObject(s[t.key],e)}}},v.prototype.getTotalVertices=function(){return this.isReady()?this._totalVertices:0},v.prototype.getVerticesData=function(t,e,i){var n=this.getVertexBuffer(t);return n?n.getFloatData(this._totalVertices,i||e&&this._meshes.length!==1):null},v.prototype.isVertexBufferUpdatable=function(t){var e=this._vertexBuffers[t];return e?e.isUpdatable():!1},v.prototype.getVertexBuffer=function(t){return this.isReady()?this._vertexBuffers[t]:null},v.prototype.getVertexBuffers=function(){return this.isReady()?this._vertexBuffers:null},v.prototype.isVerticesDataPresent=function(t){return this._vertexBuffers?this._vertexBuffers[t]!==void 0:this._delayInfo?this._delayInfo.indexOf(t)!==-1:!1},v.prototype.getVerticesDataKinds=function(){var t=[],e;if(!this._vertexBuffers&&this._delayInfo)for(e in this._delayInfo)t.push(e);else for(e in this._vertexBuffers)t.push(e);return t},v.prototype.updateIndices=function(t,e,i){if(i===void 0&&(i=!1),!!this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(t,null,!0);else{var n=t.length!==this._indices.length;if(i||(this._indices=t.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,t,e),n)for(var r=0,s=this._meshes;r<s.length;r++){var a=s[r];a._createGlobalSubMesh(!0)}}},v.prototype.setIndices=function(t,e,i){e===void 0&&(e=null),i===void 0&&(i=!1),this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=t,this._indexBufferIsUpdatable=i,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i)),e!=null&&(this._totalVertices=e);for(var n=0,r=this._meshes;n<r.length;n++){var s=r[n];s._createGlobalSubMesh(!0),s.synchronizeInstances()}this._notifyUpdate()},v.prototype.getTotalIndices=function(){return this.isReady()?this._indices.length:0},v.prototype.getIndices=function(t,e){if(!this.isReady())return null;var i=this._indices;return!e&&(!t||this._meshes.length===1)?i:i.slice()},v.prototype.getIndexBuffer=function(){return this.isReady()?this._indexBuffer:null},v.prototype._releaseVertexArrayObject=function(t){t===void 0&&(t=null),!(!t||!this._vertexArrayObjects)&&this._vertexArrayObjects[t.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[t.key]),delete this._vertexArrayObjects[t.key])},v.prototype.releaseForMesh=function(t,e){var i=this._meshes,n=i.indexOf(t);n!==-1&&(i.splice(n,1),this._vertexArrayObjects&&t._invalidateInstanceVertexArrayObject(),t._geometry=null,i.length===0&&e&&this.dispose())},v.prototype.applyToMesh=function(t){if(t._geometry!==this){var e=t._geometry;e&&e.releaseForMesh(t),this._vertexArrayObjects&&t._invalidateInstanceVertexArrayObject();var i=this._meshes;t._geometry=this,t._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(t),this.isReady()?this._applyToMesh(t):this._boundingInfo&&t.setBoundingInfo(this._boundingInfo)}},v.prototype._updateExtend=function(t){if(t===void 0&&(t=null),this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!t&&(t=this.getVerticesData(l.PositionKind),!t))return;this._extend=Me(t,0,this._totalVertices,this.boundingBias,3)}},v.prototype._applyToMesh=function(t){var e=this._meshes.length;for(var i in this._vertexBuffers)e===1&&this._vertexBuffers[i].create(),i===l.PositionKind&&(this._extend||this._updateExtend(),t.buildBoundingInfo(this._extend.minimum,this._extend.maximum),t._createGlobalSubMesh(t.isUnIndexed),t._updateBoundingInfo());e===1&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),t._syncGeometryWithMorphTargetManager(),t.synchronizeInstances()},v.prototype._notifyUpdate=function(t){this.onGeometryUpdated&&this.onGeometryUpdated(this,t),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(var e=0,i=this._meshes;e<i.length;e++){var n=i[e];n._markSubMeshesAsAttributesDirty()}},v.prototype.load=function(t,e){if(this.delayLoadState!==2){if(this.isReady()){e&&e();return}this.delayLoadState=2,this._queueLoad(t,e)}},v.prototype._queueLoad=function(t,e){var i=this;!this.delayLoadingFile||(t._addPendingData(this),t._loadFile(this.delayLoadingFile,function(n){if(!!i._delayLoadingFunction){i._delayLoadingFunction(JSON.parse(n),i),i.delayLoadState=1,i._delayInfo=[],t._removePendingData(i);for(var r=i._meshes,s=r.length,a=0;a<s;a++)i._applyToMesh(r[a]);e&&e()}},void 0,!0))},v.prototype.toLeftHanded=function(){var t=this.getIndices(!1);if(t!=null&&t.length>0){for(var e=0;e<t.length;e+=3){var i=t[e+0];t[e+0]=t[e+2],t[e+2]=i}this.setIndices(t)}var n=this.getVerticesData(l.PositionKind,!1);if(n!=null&&n.length>0){for(var e=0;e<n.length;e+=3)n[e+2]=-n[e+2];this.setVerticesData(l.PositionKind,n,!1)}var r=this.getVerticesData(l.NormalKind,!1);if(r!=null&&r.length>0){for(var e=0;e<r.length;e+=3)r[e+2]=-r[e+2];this.setVerticesData(l.NormalKind,r,!1)}},v.prototype._resetPointsArrayCache=function(){this._positions=null},v.prototype._generatePointsArray=function(){if(this._positions)return!0;var t=this.getVerticesData(l.PositionKind);if(!t||t.length===0)return!1;for(var e=this._positionsCache.length*3,i=this._positionsCache.length;e<t.length;e+=3,++i)this._positionsCache[i]=S.FromArray(t,e);for(var e=0,i=0;e<t.length;e+=3,++i)this._positionsCache[i].set(t[0+e],t[1+e],t[2+e]);return this._positionsCache.length=t.length/3,this._positions=this._positionsCache,!0},v.prototype.isDisposed=function(){return this._isDisposed},v.prototype._disposeVertexArrayObjects=function(){if(this._vertexArrayObjects){for(var t in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[t]);this._vertexArrayObjects={};for(var e=this._meshes,i=e.length,n=0;n<i;n++)e[n]._invalidateInstanceVertexArrayObject()}},v.prototype.dispose=function(){var t=this._meshes,e=t.length,i;for(i=0;i<e;i++)this.releaseForMesh(t[i]);this._meshes=[],this._disposeVertexArrayObjects();for(var n in this._vertexBuffers)this._vertexBuffers[n].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){var r=this._parentContainer.geometries.indexOf(this);r>-1&&this._parentContainer.geometries.splice(r,1),this._parentContainer=null}this._isDisposed=!0},v.prototype.copy=function(t){var e=new F;e.indices=[];var i=this.getIndices();if(i)for(var n=0;n<i.length;n++)e.indices.push(i[n]);var r=!1,s=!1,a;for(a in this._vertexBuffers){var o=this.getVerticesData(a);if(o&&(o instanceof Float32Array?e.set(new Float32Array(o),a):e.set(o.slice(0),a),!s)){var f=this.getVertexBuffer(a);f&&(r=f.isUpdatable(),s=!r)}}var h=new v(t,this._scene,e,r);h.delayLoadState=this.delayLoadState,h.delayLoadingFile=this.delayLoadingFile,h._delayLoadingFunction=this._delayLoadingFunction;for(a in this._delayInfo)h._delayInfo=h._delayInfo||[],h._delayInfo.push(a);return h._boundingInfo=new se(this._extend.minimum,this._extend.maximum),h},v.prototype.serialize=function(){var t={};return t.id=this.id,t.uniqueId=this.uniqueId,t.updatable=this._updatable,P&&P.HasTags(this)&&(t.tags=P.GetTags(this)),t},v.prototype._toNumberArray=function(t){return Array.isArray(t)?t:Array.prototype.slice.call(t)},v.prototype.clearCachedData=function(){this._indices=[],this._resetPointsArrayCache();for(var t in this._vertexBuffers)!Object.prototype.hasOwnProperty.call(this._vertexBuffers,t)||(this._vertexBuffers[t]._buffer._data=null)},v.prototype.serializeVerticeData=function(){var t=this.serialize();return this.isVerticesDataPresent(l.PositionKind)&&(t.positions=this._toNumberArray(this.getVerticesData(l.PositionKind)),this.isVertexBufferUpdatable(l.PositionKind)&&(t.positions._updatable=!0)),this.isVerticesDataPresent(l.NormalKind)&&(t.normals=this._toNumberArray(this.getVerticesData(l.NormalKind)),this.isVertexBufferUpdatable(l.NormalKind)&&(t.normals._updatable=!0)),this.isVerticesDataPresent(l.TangentKind)&&(t.tangents=this._toNumberArray(this.getVerticesData(l.TangentKind)),this.isVertexBufferUpdatable(l.TangentKind)&&(t.tangents._updatable=!0)),this.isVerticesDataPresent(l.UVKind)&&(t.uvs=this._toNumberArray(this.getVerticesData(l.UVKind)),this.isVertexBufferUpdatable(l.UVKind)&&(t.uvs._updatable=!0)),this.isVerticesDataPresent(l.UV2Kind)&&(t.uv2s=this._toNumberArray(this.getVerticesData(l.UV2Kind)),this.isVertexBufferUpdatable(l.UV2Kind)&&(t.uv2s._updatable=!0)),this.isVerticesDataPresent(l.UV3Kind)&&(t.uv3s=this._toNumberArray(this.getVerticesData(l.UV3Kind)),this.isVertexBufferUpdatable(l.UV3Kind)&&(t.uv3s._updatable=!0)),this.isVerticesDataPresent(l.UV4Kind)&&(t.uv4s=this._toNumberArray(this.getVerticesData(l.UV4Kind)),this.isVertexBufferUpdatable(l.UV4Kind)&&(t.uv4s._updatable=!0)),this.isVerticesDataPresent(l.UV5Kind)&&(t.uv5s=this._toNumberArray(this.getVerticesData(l.UV5Kind)),this.isVertexBufferUpdatable(l.UV5Kind)&&(t.uv5s._updatable=!0)),this.isVerticesDataPresent(l.UV6Kind)&&(t.uv6s=this._toNumberArray(this.getVerticesData(l.UV6Kind)),this.isVertexBufferUpdatable(l.UV6Kind)&&(t.uv6s._updatable=!0)),this.isVerticesDataPresent(l.ColorKind)&&(t.colors=this._toNumberArray(this.getVerticesData(l.ColorKind)),this.isVertexBufferUpdatable(l.ColorKind)&&(t.colors._updatable=!0)),this.isVerticesDataPresent(l.MatricesIndicesKind)&&(t.matricesIndices=this._toNumberArray(this.getVerticesData(l.MatricesIndicesKind)),t.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(l.MatricesIndicesKind)&&(t.matricesIndices._updatable=!0)),this.isVerticesDataPresent(l.MatricesWeightsKind)&&(t.matricesWeights=this._toNumberArray(this.getVerticesData(l.MatricesWeightsKind)),this.isVertexBufferUpdatable(l.MatricesWeightsKind)&&(t.matricesWeights._updatable=!0)),t.indices=this._toNumberArray(this.getIndices()),t},v.ExtractFromMesh=function(t,e){var i=t._geometry;return i?i.copy(e):null},v.RandomId=function(){return J.RandomId()},v._GetGeometryByLoadedUniqueId=function(t,e){for(var i=0;i<e.geometries.length;i++)if(e.geometries[i]._loadedUniqueId===t)return e.geometries[i];return null},v._ImportGeometry=function(t,e){var i=e.getScene(),n=t.geometryUniqueId,r=t.geometryId;if(n||r){var s=n?this._GetGeometryByLoadedUniqueId(n,i):i.getGeometryById(r);s&&s.applyToMesh(e)}else if(t instanceof ArrayBuffer){var a=e._binaryInfo;if(a.positionsAttrDesc&&a.positionsAttrDesc.count>0){var o=new Float32Array(t,a.positionsAttrDesc.offset,a.positionsAttrDesc.count);e.setVerticesData(l.PositionKind,o,!1)}if(a.normalsAttrDesc&&a.normalsAttrDesc.count>0){var f=new Float32Array(t,a.normalsAttrDesc.offset,a.normalsAttrDesc.count);e.setVerticesData(l.NormalKind,f,!1)}if(a.tangetsAttrDesc&&a.tangetsAttrDesc.count>0){var h=new Float32Array(t,a.tangetsAttrDesc.offset,a.tangetsAttrDesc.count);e.setVerticesData(l.TangentKind,h,!1)}if(a.uvsAttrDesc&&a.uvsAttrDesc.count>0){var c=new Float32Array(t,a.uvsAttrDesc.offset,a.uvsAttrDesc.count);if(H.UseOpenGLOrientationForUV)for(var u=1;u<c.length;u+=2)c[u]=1-c[u];e.setVerticesData(l.UVKind,c,!1)}if(a.uvs2AttrDesc&&a.uvs2AttrDesc.count>0){var p=new Float32Array(t,a.uvs2AttrDesc.offset,a.uvs2AttrDesc.count);if(H.UseOpenGLOrientationForUV)for(var u=1;u<p.length;u+=2)p[u]=1-p[u];e.setVerticesData(l.UV2Kind,p,!1)}if(a.uvs3AttrDesc&&a.uvs3AttrDesc.count>0){var d=new Float32Array(t,a.uvs3AttrDesc.offset,a.uvs3AttrDesc.count);if(H.UseOpenGLOrientationForUV)for(var u=1;u<d.length;u+=2)d[u]=1-d[u];e.setVerticesData(l.UV3Kind,d,!1)}if(a.uvs4AttrDesc&&a.uvs4AttrDesc.count>0){var g=new Float32Array(t,a.uvs4AttrDesc.offset,a.uvs4AttrDesc.count);if(H.UseOpenGLOrientationForUV)for(var u=1;u<g.length;u+=2)g[u]=1-g[u];e.setVerticesData(l.UV4Kind,g,!1)}if(a.uvs5AttrDesc&&a.uvs5AttrDesc.count>0){var _=new Float32Array(t,a.uvs5AttrDesc.offset,a.uvs5AttrDesc.count);if(H.UseOpenGLOrientationForUV)for(var u=1;u<_.length;u+=2)_[u]=1-_[u];e.setVerticesData(l.UV5Kind,_,!1)}if(a.uvs6AttrDesc&&a.uvs6AttrDesc.count>0){var D=new Float32Array(t,a.uvs6AttrDesc.offset,a.uvs6AttrDesc.count);if(H.UseOpenGLOrientationForUV)for(var u=1;u<D.length;u+=2)D[u]=1-D[u];e.setVerticesData(l.UV6Kind,D,!1)}if(a.colorsAttrDesc&&a.colorsAttrDesc.count>0){var m=new Float32Array(t,a.colorsAttrDesc.offset,a.colorsAttrDesc.count);e.setVerticesData(l.ColorKind,m,!1,a.colorsAttrDesc.stride)}if(a.matricesIndicesAttrDesc&&a.matricesIndicesAttrDesc.count>0){for(var M=new Int32Array(t,a.matricesIndicesAttrDesc.offset,a.matricesIndicesAttrDesc.count),I=[],x=0;x<M.length;x++){var u=M[x];I.push(u&255),I.push((u&65280)>>8),I.push((u&16711680)>>16),I.push(u>>24&255)}e.setVerticesData(l.MatricesIndicesKind,I,!1)}if(a.matricesIndicesExtraAttrDesc&&a.matricesIndicesExtraAttrDesc.count>0){for(var M=new Int32Array(t,a.matricesIndicesExtraAttrDesc.offset,a.matricesIndicesExtraAttrDesc.count),I=[],x=0;x<M.length;x++){var u=M[x];I.push(u&255),I.push((u&65280)>>8),I.push((u&16711680)>>16),I.push(u>>24&255)}e.setVerticesData(l.MatricesIndicesExtraKind,I,!1)}if(a.matricesWeightsAttrDesc&&a.matricesWeightsAttrDesc.count>0){var A=new Float32Array(t,a.matricesWeightsAttrDesc.offset,a.matricesWeightsAttrDesc.count);e.setVerticesData(l.MatricesWeightsKind,A,!1)}if(a.indicesAttrDesc&&a.indicesAttrDesc.count>0){var b=new Int32Array(t,a.indicesAttrDesc.offset,a.indicesAttrDesc.count);e.setIndices(b,null)}if(a.subMeshesAttrDesc&&a.subMeshesAttrDesc.count>0){var y=new Int32Array(t,a.subMeshesAttrDesc.offset,a.subMeshesAttrDesc.count*5);e.subMeshes=[];for(var x=0;x<a.subMeshesAttrDesc.count;x++){var C=y[x*5+0],V=y[x*5+1],T=y[x*5+2],L=y[x*5+3],K=y[x*5+4];z.AddToMesh(C,V,T,L,K,e)}}}else if(t.positions&&t.normals&&t.indices){if(e.setVerticesData(l.PositionKind,t.positions,t.positions._updatable),e.setVerticesData(l.NormalKind,t.normals,t.normals._updatable),t.tangents&&e.setVerticesData(l.TangentKind,t.tangents,t.tangents._updatable),t.uvs&&e.setVerticesData(l.UVKind,t.uvs,t.uvs._updatable),t.uvs2&&e.setVerticesData(l.UV2Kind,t.uvs2,t.uvs2._updatable),t.uvs3&&e.setVerticesData(l.UV3Kind,t.uvs3,t.uvs3._updatable),t.uvs4&&e.setVerticesData(l.UV4Kind,t.uvs4,t.uvs4._updatable),t.uvs5&&e.setVerticesData(l.UV5Kind,t.uvs5,t.uvs5._updatable),t.uvs6&&e.setVerticesData(l.UV6Kind,t.uvs6,t.uvs6._updatable),t.colors&&e.setVerticesData(l.ColorKind,de.CheckColors4(t.colors,t.positions.length/3),t.colors._updatable),t.matricesIndices)if(t.matricesIndices._isExpanded)delete t.matricesIndices._isExpanded,e.setVerticesData(l.MatricesIndicesKind,t.matricesIndices,t.matricesIndices._updatable);else{for(var I=[],x=0;x<t.matricesIndices.length;x++){var w=t.matricesIndices[x];I.push(w&255),I.push((w&65280)>>8),I.push((w&16711680)>>16),I.push(w>>24&255)}e.setVerticesData(l.MatricesIndicesKind,I,t.matricesIndices._updatable)}if(t.matricesIndicesExtra)if(t.matricesIndicesExtra._isExpanded)delete t.matricesIndices._isExpanded,e.setVerticesData(l.MatricesIndicesExtraKind,t.matricesIndicesExtra,t.matricesIndicesExtra._updatable);else{for(var I=[],x=0;x<t.matricesIndicesExtra.length;x++){var w=t.matricesIndicesExtra[x];I.push(w&255),I.push((w&65280)>>8),I.push((w&16711680)>>16),I.push(w>>24&255)}e.setVerticesData(l.MatricesIndicesExtraKind,I,t.matricesIndicesExtra._updatable)}t.matricesWeights&&(v._CleanMatricesWeights(t,e),e.setVerticesData(l.MatricesWeightsKind,t.matricesWeights,t.matricesWeights._updatable)),t.matricesWeightsExtra&&e.setVerticesData(l.MatricesWeightsExtraKind,t.matricesWeightsExtra,t.matricesWeights._updatable),e.setIndices(t.indices,null)}if(t.subMeshes){e.subMeshes=[];for(var N=0;N<t.subMeshes.length;N++){var E=t.subMeshes[N];z.AddToMesh(E.materialIndex,E.verticesStart,E.verticesCount,E.indexStart,E.indexCount,e)}}e._shouldGenerateFlatShading&&(e.convertToFlatShadedMesh(),e._shouldGenerateFlatShading=!1),e.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(e)},v._CleanMatricesWeights=function(t,e){var i=.001;if(!!le.CleanBoneMatrixWeights){var n=0;if(t.skeletonId>-1){var r=e.getScene().getLastSkeletonById(t.skeletonId);if(!r)return;n=r.bones.length}else return;for(var s=e.getVerticesData(l.MatricesIndicesKind),a=e.getVerticesData(l.MatricesIndicesExtraKind),o=t.matricesWeights,f=t.matricesWeightsExtra,h=t.numBoneInfluencer,c=o.length,u=0;u<c;u+=4){for(var p=0,d=-1,g=0;g<4;g++){var _=o[u+g];p+=_,_<i&&d<0&&(d=g)}if(f)for(var g=0;g<4;g++){var _=f[u+g];p+=_,_<i&&d<0&&(d=g+4)}if((d<0||d>h-1)&&(d=h-1),p>i){for(var D=1/p,g=0;g<4;g++)o[u+g]*=D;if(f)for(var g=0;g<4;g++)f[u+g]*=D}else d>=4?(f[u+d-4]=1-p,a[u+d-4]=n):(o[u+d]=1-p,s[u+d]=n)}e.setVerticesData(l.MatricesIndicesKind,s),t.matricesWeightsExtra&&e.setVerticesData(l.MatricesIndicesExtraKind,a)}},v.Parse=function(t,e,i){var n=new v(t.id,e,void 0,t.updatable);return n._loadedUniqueId=t.uniqueId,P&&P.AddTagsTo(n,t.tags),t.delayLoadingFile?(n.delayLoadState=4,n.delayLoadingFile=i+t.delayLoadingFile,n._boundingInfo=new se(S.FromArray(t.boundingBoxMinimum),S.FromArray(t.boundingBoxMaximum)),n._delayInfo=[],t.hasUVs&&n._delayInfo.push(l.UVKind),t.hasUVs2&&n._delayInfo.push(l.UV2Kind),t.hasUVs3&&n._delayInfo.push(l.UV3Kind),t.hasUVs4&&n._delayInfo.push(l.UV4Kind),t.hasUVs5&&n._delayInfo.push(l.UV5Kind),t.hasUVs6&&n._delayInfo.push(l.UV6Kind),t.hasColors&&n._delayInfo.push(l.ColorKind),t.hasMatricesIndices&&n._delayInfo.push(l.MatricesIndicesKind),t.hasMatricesWeights&&n._delayInfo.push(l.MatricesWeightsKind),n._delayLoadingFunction=F.ImportVertexData):F.ImportVertexData(t,n),e.pushGeometry(n,!0),n},v}(),X=function(v){fe(t,v);function t(e,i){var n=v.call(this,e,i,!0)||this;return n._waitingSubMaterialsUniqueIds=[],n.getScene().multiMaterials.push(n),n.subMaterials=new Array,n._storeEffectOnSubMeshes=!0,n}return Object.defineProperty(t.prototype,"subMaterials",{get:function(){return this._subMaterials},set:function(e){this._subMaterials=e,this._hookArray(e)},enumerable:!1,configurable:!0}),t.prototype.getChildren=function(){return this.subMaterials},t.prototype._hookArray=function(e){var i=this,n=e.push;e.push=function(){for(var s=[],a=0;a<arguments.length;a++)s[a]=arguments[a];var o=n.apply(e,s);return i._markAllSubMeshesAsTexturesDirty(),o};var r=e.splice;e.splice=function(s,a){var o=r.apply(e,[s,a]);return i._markAllSubMeshesAsTexturesDirty(),o}},t.prototype.getSubMaterial=function(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]},t.prototype.getActiveTextures=function(){var e;return(e=v.prototype.getActiveTextures.call(this)).concat.apply(e,this.subMaterials.map(function(i){return i?i.getActiveTextures():[]}))},t.prototype.hasTexture=function(e){var i;if(v.prototype.hasTexture.call(this,e))return!0;for(var n=0;n<this.subMaterials.length;n++)if(!((i=this.subMaterials[n])===null||i===void 0)&&i.hasTexture(e))return!0;return!1},t.prototype.getClassName=function(){return"MultiMaterial"},t.prototype.isReadyForSubMesh=function(e,i,n){for(var r=0;r<this.subMaterials.length;r++){var s=this.subMaterials[r];if(s){if(s._storeEffectOnSubMeshes){if(!s.isReadyForSubMesh(e,i,n))return!1;continue}if(!s.isReady(e))return!1}}return!0},t.prototype.clone=function(e,i){for(var n=new t(e,this.getScene()),r=0;r<this.subMaterials.length;r++){var s=null,a=this.subMaterials[r];i&&a?s=a.clone(e+"-"+a.name):s=this.subMaterials[r],n.subMaterials.push(s)}return n},t.prototype.serialize=function(){var e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,P&&(e.tags=P.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(var i=0;i<this.subMaterials.length;i++){var n=this.subMaterials[i];n?(e.materialsUniqueIds.push(n.uniqueId),e.materials.push(n.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e},t.prototype.dispose=function(e,i,n){var r=this.getScene();if(!!r){if(n)for(var s=0;s<this.subMaterials.length;s++){var a=this.subMaterials[s];a&&a.dispose(e,i)}var o=r.multiMaterials.indexOf(this);o>=0&&r.multiMaterials.splice(o,1),v.prototype.dispose.call(this,e,i)}},t.ParseMultiMaterial=function(e,i){var n=new t(e.name,i);return n.id=e.id,n._loadedUniqueId=e.uniqueId,P&&P.AddTagsTo(n,e.tags),e.materialsUniqueIds?n._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach(function(r){return n.subMaterials.push(i.getLastMaterialById(r))}),n},t}(R);ue("BABYLON.MultiMaterial",X);var xe=function(){function v(t,e){this.distanceOrScreenCoverage=t,this.mesh=e}return v}(),Ae=function(){function v(){this.visibleInstances={},this.batchCache=new oe,this.batchCacheReplacementModeInFrozenMode=new oe,this.instancesBufferSize=32*16*4}return v}(),oe=function(){function v(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array,this.hardwareInstancedRendering=new Array}return v}(),Se=function(){function v(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=32*16,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}return v}(),Be=function(){function v(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0}return v}(),B=function(v){fe(t,v);function t(e,i,n,r,s,a){i===void 0&&(i=null),n===void 0&&(n=null),r===void 0&&(r=null),a===void 0&&(a=!0);var o=v.call(this,e,i)||this;if(o._internalMeshDataInfo=new Be,o.delayLoadState=0,o.instances=new Array,o._creationDataStorage=null,o._geometry=null,o._instanceDataStorage=new Ae,o._thinInstanceDataStorage=new Se,o._shouldGenerateFlatShading=!1,o._originalBuilderSideOrientation=t.DEFAULTSIDE,o.overrideMaterialSideOrientation=null,o.ignoreCameraMaxZ=!1,i=o.getScene(),o._onBeforeDraw=function(D,m,M){D&&M&&(o._uniformBuffer?o.transferToEffect(m):M.bindOnlyWorldMatrix(m))},r){if(r._geometry&&r._geometry.applyToMesh(o),pe.DeepCopy(r,o,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo"],["_poseMatrix"]),o._internalMeshDataInfo._source=r,i.useClonedMeshMap&&(r._internalMeshDataInfo.meshMap||(r._internalMeshDataInfo.meshMap={}),r._internalMeshDataInfo.meshMap[o.uniqueId]=o),o._originalBuilderSideOrientation=r._originalBuilderSideOrientation,o._creationDataStorage=r._creationDataStorage,r._ranges){var f=r._ranges;for(var h in f)!Object.prototype.hasOwnProperty.call(f,h)||!f[h]||o.createAnimationRange(h,f[h].from,f[h].to)}if(r.metadata&&r.metadata.clone?o.metadata=r.metadata.clone():o.metadata=r.metadata,P&&P.HasTags(r)&&P.AddTagsTo(o,P.GetTags(r,!0)),o.setEnabled(r.isEnabled()),o.parent=r.parent,o.setPivotMatrix(r.getPivotMatrix()),o.id=e+"."+r.id,o.material=r.material,!s)for(var c=r.getDescendants(!0),u=0;u<c.length;u++){var p=c[u];p.clone&&p.clone(e+"."+p.name,o)}if(r.morphTargetManager&&(o.morphTargetManager=r.morphTargetManager),i.getPhysicsEngine){var d=i.getPhysicsEngine();if(a&&d){var g=d.getImpostorForPhysicsObject(r);g&&(o.physicsImpostor=g.clone(o))}}for(var u=0;u<i.particleSystems.length;u++){var _=i.particleSystems[u];_.emitter===r&&_.clone(_.name,o)}o.skeleton=r.skeleton,o.refreshBoundingInfo(!0,!0),o.computeWorldMatrix(!0)}return n!==null&&(o.parent=n),o._instanceDataStorage.hardwareInstancedRendering=o.getEngine().getCaps().instancedArrays,o._internalMeshDataInfo._onMeshReadyObserverAdded=function(D){D.unregisterOnNextCall=!0,o.isReady(!0)?o.onMeshReadyObservable.notifyObservers(o):o._internalMeshDataInfo._checkReadinessObserver||(o._internalMeshDataInfo._checkReadinessObserver=o._scene.onBeforeRenderObservable.add(function(){o.isReady(!0)&&(o._scene.onBeforeRenderObservable.remove(o._internalMeshDataInfo._checkReadinessObserver),o._internalMeshDataInfo._checkReadinessObserver=null,o.onMeshReadyObservable.notifyObservers(o))}))},o.onMeshReadyObservable=new q(o._internalMeshDataInfo._onMeshReadyObserverAdded),r&&r.onClonedObservable.notifyObservers(o),o}return t._GetDefaultSideOrientation=function(e){return e||t.FRONTSIDE},Object.defineProperty(t.prototype,"useLODScreenCoverage",{get:function(){return this._internalMeshDataInfo._useLODScreenCoverage},set:function(e){this._internalMeshDataInfo._useLODScreenCoverage=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"computeBonesUsingShaders",{get:function(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders},set:function(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(l.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(l.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onBeforeRenderObservable",{get:function(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new q),this._internalMeshDataInfo._onBeforeRenderObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onBeforeBindObservable",{get:function(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new q),this._internalMeshDataInfo._onBeforeBindObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onAfterRenderObservable",{get:function(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new q),this._internalMeshDataInfo._onAfterRenderObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onBetweenPassObservable",{get:function(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new q),this._internalMeshDataInfo._onBetweenPassObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onBeforeDrawObservable",{get:function(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new q),this._internalMeshDataInfo._onBeforeDrawObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onBeforeDraw",{set:function(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasInstances",{get:function(){return this.instances.length>0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasThinInstances",{get:function(){var e;return((e=this._thinInstanceDataStorage.instancesCount)!==null&&e!==void 0?e:0)>0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"forcedInstanceCount",{get:function(){return this._internalMeshDataInfo._forcedInstanceCount},set:function(e){this._internalMeshDataInfo._forcedInstanceCount=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"source",{get:function(){return this._internalMeshDataInfo._source},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cloneMeshMap",{get:function(){return this._internalMeshDataInfo.meshMap},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isUnIndexed",{get:function(){return this._unIndexed},set:function(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldMatrixInstancedBuffer",{get:function(){return this._instanceDataStorage.instancesData},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"previousWorldMatrixInstancedBuffer",{get:function(){return this._instanceDataStorage.instancesPreviousData},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"manualUpdateOfWorldMatrixInstancedBuffer",{get:function(){return this._instanceDataStorage.manualUpdate},set:function(e){this._instanceDataStorage.manualUpdate=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"manualUpdateOfPreviousWorldMatrixInstancedBuffer",{get:function(){return this._instanceDataStorage.previousManualUpdate},set:function(e){this._instanceDataStorage.previousManualUpdate=e},enumerable:!1,configurable:!0}),t.prototype.instantiateHierarchy=function(e,i,n){e===void 0&&(e=null);var r=this.getTotalVertices()>0&&(!i||!i.doNotInstantiate)?this.createInstance("instance of "+(this.name||this.id)):this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);r.parent=e||this.parent,r.position=this.position.clone(),r.scaling=this.scaling.clone(),this.rotationQuaternion?r.rotationQuaternion=this.rotationQuaternion.clone():r.rotation=this.rotation.clone(),n&&n(this,r);for(var s=0,a=this.getChildTransformNodes(!0);s<a.length;s++){var o=a[s];o.instantiateHierarchy(r,i,n)}return r},t.prototype.getClassName=function(){return"Mesh"},Object.defineProperty(t.prototype,"_isMesh",{get:function(){return!0},enumerable:!1,configurable:!0}),t.prototype.toString=function(e){var i=v.prototype.toString.call(this,e);if(i+=", n vertices: "+this.getTotalVertices(),i+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(var n=0;n<this.animations.length;n++)i+=", animation[0]: "+this.animations[n].toString(e);if(e)if(this._geometry){var r=this.getIndices(),s=this.getVerticesData(l.PositionKind);s&&r&&(i+=", flat shading: "+(s.length/3===r.length?"YES":"NO"))}else i+=", flat shading: UNKNOWN";return i},t.prototype._unBindEffect=function(){v.prototype._unBindEffect.call(this);for(var e=0,i=this.instances;e<i.length;e++){var n=i[e];n._unBindEffect()}},Object.defineProperty(t.prototype,"hasLODLevels",{get:function(){return this._internalMeshDataInfo._LODLevels.length>0},enumerable:!1,configurable:!0}),t.prototype.getLODLevels=function(){return this._internalMeshDataInfo._LODLevels},t.prototype._sortLODLevels=function(){var e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort(function(i,n){return i.distanceOrScreenCoverage<n.distanceOrScreenCoverage?e:i.distanceOrScreenCoverage>n.distanceOrScreenCoverage?-e:0})},t.prototype.addLODLevel=function(e,i){if(i&&i._masterMesh)return W.Warn("You cannot use a mesh as LOD level twice"),this;var n=new xe(e,i);return this._internalMeshDataInfo._LODLevels.push(n),i&&(i._masterMesh=this),this._sortLODLevels(),this},t.prototype.getLODLevelAtDistance=function(e){for(var i=this._internalMeshDataInfo,n=0;n<i._LODLevels.length;n++){var r=i._LODLevels[n];if(r.distanceOrScreenCoverage===e)return r.mesh}return null},t.prototype.removeLODLevel=function(e){for(var i=this._internalMeshDataInfo,n=0;n<i._LODLevels.length;n++)i._LODLevels[n].mesh===e&&(i._LODLevels.splice(n,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this},t.prototype.getLOD=function(e,i){var n=this._internalMeshDataInfo;if(!n._LODLevels||n._LODLevels.length===0)return this;var r;if(i)r=i;else{var s=this.getBoundingInfo();r=s.boundingSphere}var a=r.centerWorld.subtract(e.globalPosition).length(),o=n._useLODScreenCoverage,f=a,h=1;if(o){var c=e.screenArea,u=r.radiusWorld*e.minZ/a;u=u*u*Math.PI,f=u/c,h=-1}if(h*n._LODLevels[n._LODLevels.length-1].distanceOrScreenCoverage>h*f)return this.onLODLevelSelection&&this.onLODLevelSelection(f,this,this),this;for(var p=0;p<n._LODLevels.length;p++){var d=n._LODLevels[p];if(h*d.distanceOrScreenCoverage<h*f){if(d.mesh){if(d.mesh.delayLoadState===4)return d.mesh._checkDelayState(),this;if(d.mesh.delayLoadState===2)return this;d.mesh._preActivate(),d.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(f,this,d.mesh),d.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(f,this,this),this},Object.defineProperty(t.prototype,"geometry",{get:function(){return this._geometry},enumerable:!1,configurable:!0}),t.prototype.getTotalVertices=function(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()},t.prototype.getVerticesData=function(e,i,n){var r,s;if(!this._geometry)return null;var a=(s=(r=this._userInstancedBuffersStorage)===null||r===void 0?void 0:r.vertexBuffers[e])===null||s===void 0?void 0:s.getFloatData(this._geometry.getTotalVertices(),n||i&&this._geometry.meshes.length!==1);return a||(a=this._geometry.getVerticesData(e,i,n)),a},t.prototype.getVertexBuffer=function(e){var i,n;return this._geometry?(n=(i=this._userInstancedBuffersStorage)===null||i===void 0?void 0:i.vertexBuffers[e])!==null&&n!==void 0?n:this._geometry.getVertexBuffer(e):null},t.prototype.isVerticesDataPresent=function(e){var i;return this._geometry?((i=this._userInstancedBuffersStorage)===null||i===void 0?void 0:i.vertexBuffers[e])!==void 0||this._geometry.isVerticesDataPresent(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1},t.prototype.isVertexBufferUpdatable=function(e){var i,n;return this._geometry?((n=(i=this._userInstancedBuffersStorage)===null||i===void 0?void 0:i.vertexBuffers[e])===null||n===void 0?void 0:n.isUpdatable())||this._geometry.isVertexBufferUpdatable(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1},t.prototype.getVerticesDataKinds=function(){if(!this._geometry){var e=new Array;return this._delayInfo&&this._delayInfo.forEach(function(r){e.push(r)}),e}var i=this._geometry.getVerticesDataKinds();if(this._userInstancedBuffersStorage)for(var n in this._userInstancedBuffersStorage.vertexBuffers)i.push(n);return i},t.prototype.getTotalIndices=function(){return this._geometry?this._geometry.getTotalIndices():0},t.prototype.getIndices=function(e,i){return this._geometry?this._geometry.getIndices(e,i):[]},Object.defineProperty(t.prototype,"isBlocked",{get:function(){return this._masterMesh!==null&&this._masterMesh!==void 0},enumerable:!1,configurable:!0}),t.prototype.isReady=function(e,i){var n,r,s,a,o,f;if(e===void 0&&(e=!1),i===void 0&&(i=!1),this.delayLoadState===2||!v.prototype.isReady.call(this,e))return!1;if(!this.subMeshes||this.subMeshes.length===0||!e)return!0;var h=this.getEngine(),c=this.getScene(),u=i||h.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();var p=this.material||c.defaultMaterial;if(p){if(p._storeEffectOnSubMeshes)for(var d=0,g=this.subMeshes;d<g.length;d++){var _=g[d],D=_.getMaterial();if(D){if(D._storeEffectOnSubMeshes){if(!D.isReadyForSubMesh(this,_,u))return!1}else if(!D.isReady(this,u))return!1}}else if(!p.isReady(this,u))return!1}for(var m=h.currentRenderPassId,M=0,I=this.lightSources;M<I.length;M++){var x=I[M],A=x.getShadowGenerator();if(A&&(!(!((n=A.getShadowMap())===null||n===void 0)&&n.renderList)||((r=A.getShadowMap())===null||r===void 0?void 0:r.renderList)&&((a=(s=A.getShadowMap())===null||s===void 0?void 0:s.renderList)===null||a===void 0?void 0:a.indexOf(this))!==-1)){A.getShadowMap()&&(h.currentRenderPassId=A.getShadowMap().renderPassId);for(var b=0,y=this.subMeshes;b<y.length;b++){var _=y[b];if(!A.isReady(_,u,(f=(o=_.getMaterial())===null||o===void 0?void 0:o.needAlphaBlendingForMesh(this))!==null&&f!==void 0?f:!1))return h.currentRenderPassId=m,!1}h.currentRenderPassId=m}}for(var C=0,V=this._internalMeshDataInfo._LODLevels;C<V.length;C++){var T=V[C];if(T.mesh&&!T.mesh.isReady(u))return!1}return!0},Object.defineProperty(t.prototype,"areNormalsFrozen",{get:function(){return this._internalMeshDataInfo._areNormalsFrozen},enumerable:!1,configurable:!0}),t.prototype.freezeNormals=function(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this},t.prototype.unfreezeNormals=function(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this},Object.defineProperty(t.prototype,"overridenInstanceCount",{set:function(e){this._instanceDataStorage.overridenInstanceCount=e},enumerable:!1,configurable:!0}),t.prototype._preActivate=function(){var e=this._internalMeshDataInfo,i=this.getScene().getRenderId();return e._preActivateId===i?this:(e._preActivateId=i,this._instanceDataStorage.visibleInstances=null,this)},t.prototype._preActivateForIntermediateRendering=function(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this},t.prototype._registerInstanceForRenderId=function(e,i){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:i,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[i]||(this._instanceDataStorage.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=i,this._instanceDataStorage.visibleInstances[i]=new Array),this._instanceDataStorage.visibleInstances[i].push(e),this},t.prototype._afterComputeWorldMatrix=function(){v.prototype._afterComputeWorldMatrix.call(this),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))},t.prototype._postActivate=function(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))},t.prototype.refreshBoundingInfo=function(e,i){if(e===void 0&&(e=!1),i===void 0&&(i=!1),this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;var n=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(e,i),n),this},t.prototype._createGlobalSubMesh=function(e){var i=this.getTotalVertices();if(!i||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){var n=this.getIndices();if(!n)return null;var r=n.length,s=!1;if(e)s=!0;else for(var a=0,o=this.subMeshes;a<o.length;a++){var f=o[a];if(f.indexStart+f.indexCount>r){s=!0;break}if(f.verticesStart+f.verticesCount>i){s=!0;break}}if(!s)return this.subMeshes[0]}return this.releaseSubMeshes(),new z(0,0,i,0,this.getTotalIndices(),this)},t.prototype.subdivide=function(e){if(!(e<1)){for(var i=this.getTotalIndices(),n=i/e|0,r=0;n%3!==0;)n++;this.releaseSubMeshes();for(var s=0;s<e&&!(r>=i);s++)z.CreateFromIndices(0,r,s===e-1?i-r:n,this),r+=n;this.synchronizeInstances()}},t.prototype.setVerticesData=function(e,i,n,r){if(n===void 0&&(n=!1),this._geometry)this._geometry.setVerticesData(e,i,n,r);else{var s=new F;s.set(i,e);var a=this.getScene();new k(k.RandomId(),a,s,n,this)}return this},t.prototype.removeVerticesData=function(e){!this._geometry||this._geometry.removeVerticesData(e)},t.prototype.markVerticesDataAsUpdatable=function(e,i){i===void 0&&(i=!0);var n=this.getVertexBuffer(e);!n||n.isUpdatable()===i||this.setVerticesData(e,this.getVerticesData(e),i)},t.prototype.setVerticesBuffer=function(e,i){return i===void 0&&(i=!0),this._geometry||(this._geometry=k.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,i),this},t.prototype.updateVerticesData=function(e,i,n,r){return this._geometry?(r?(this.makeGeometryUnique(),this.updateVerticesData(e,i,n,!1)):this._geometry.updateVerticesData(e,i,n),this):this},t.prototype.updateMeshPositions=function(e,i){i===void 0&&(i=!0);var n=this.getVerticesData(l.PositionKind);if(!n)return this;if(e(n),this.updateVerticesData(l.PositionKind,n,!1,!1),i){var r=this.getIndices(),s=this.getVerticesData(l.NormalKind);if(!s)return this;F.ComputeNormals(n,r,s),this.updateVerticesData(l.NormalKind,s,!1,!1)}return this},t.prototype.makeGeometryUnique=function(){if(!this._geometry)return this;if(this._geometry.meshes.length===1)return this;var e=this._geometry,i=this._geometry.copy(k.RandomId());return e.releaseForMesh(this,!0),i.applyToMesh(this),this},t.prototype.setIndices=function(e,i,n){if(i===void 0&&(i=null),n===void 0&&(n=!1),this._geometry)this._geometry.setIndices(e,i,n);else{var r=new F;r.indices=e;var s=this.getScene();new k(k.RandomId(),s,r,n,this)}return this},t.prototype.updateIndices=function(e,i,n){return n===void 0&&(n=!1),this._geometry?(this._geometry.updateIndices(e,i,n),this):this},t.prototype.toLeftHanded=function(){return this._geometry?(this._geometry.toLeftHanded(),this):this},t.prototype._bind=function(e,i,n){if(!this._geometry)return this;var r=this.getScene().getEngine();this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(i);var s;if(this._unIndexed)s=null;else switch(n){case R.PointFillMode:s=null;break;case R.WireFrameFillMode:s=e._getLinesIndexBuffer(this.getIndices(),r);break;default:case R.TriangleFillMode:s=this._geometry.getIndexBuffer();break}return!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(i,s):this._geometry._bind(i,s,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),this},t.prototype._draw=function(e,i,n){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);var r=this.getScene(),s=r.getEngine();return this._unIndexed||i==R.PointFillMode?s.drawArraysType(i,e.verticesStart,e.verticesCount,this.forcedInstanceCount||n):i==R.WireFrameFillMode?s.drawElementsType(i,0,e._linesIndexCount,this.forcedInstanceCount||n):s.drawElementsType(i,e.indexStart,e.indexCount,this.forcedInstanceCount||n),this},t.prototype.registerBeforeRender=function(e){return this.onBeforeRenderObservable.add(e),this},t.prototype.unregisterBeforeRender=function(e){return this.onBeforeRenderObservable.removeCallback(e),this},t.prototype.registerAfterRender=function(e){return this.onAfterRenderObservable.add(e),this},t.prototype.unregisterAfterRender=function(e){return this.onAfterRenderObservable.removeCallback(e),this},t.prototype._getInstancesRenderList=function(e,i){if(i===void 0&&(i=!1),this._instanceDataStorage.isFrozen){if(i)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}var n=this.getScene(),r=n._isInIntermediateRendering(),s=r?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,a=this._instanceDataStorage.batchCache;if(a.mustReturn=!1,a.renderSelf[e]=i||!s&&this.isEnabled()&&this.isVisible,a.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!i){var o=this._instanceDataStorage.visibleInstances,f=n.getRenderId(),h=r?o.intermediateDefaultRenderId:o.defaultRenderId;a.visibleInstances[e]=o[f],!a.visibleInstances[e]&&h&&(a.visibleInstances[e]=o[h])}return a.hardwareInstancedRendering[e]=!i&&this._instanceDataStorage.hardwareInstancedRendering&&a.visibleInstances[e]!==null&&a.visibleInstances[e]!==void 0,this._instanceDataStorage.previousBatch=a,a},t.prototype._renderWithInstances=function(e,i,n,r,s){var a,o=n.visibleInstances[e._id];if(!o)return this;for(var f=this._instanceDataStorage,h=f.instancesBufferSize,c=f.instancesBuffer,u=f.instancesPreviousBuffer,p=o.length+1,d=p*16*4;f.instancesBufferSize<d;)f.instancesBufferSize*=2;(!f.instancesData||h!=f.instancesBufferSize)&&(f.instancesData=new Float32Array(f.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!f.instancesPreviousData||h!=f.instancesBufferSize)&&(f.instancesPreviousData=new Float32Array(f.instancesBufferSize/4));var g=0,_=0,D=n.renderSelf[e._id],m=!c||h!==f.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!f.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!f.isFrozen||m)){var M=this.getWorldMatrix();if(D&&(this._scene.needsPreviousWorldMatrices&&(f.masterMeshPreviousWorldMatrix?(f.masterMeshPreviousWorldMatrix.copyToArray(f.instancesPreviousData,g),f.masterMeshPreviousWorldMatrix.copyFrom(M)):(f.masterMeshPreviousWorldMatrix=M.clone(),f.masterMeshPreviousWorldMatrix.copyToArray(f.instancesPreviousData,g))),M.copyToArray(f.instancesData,g),g+=16,_++),o){if(t.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&((a=e.getMaterial())===null||a===void 0?void 0:a.needAlphaBlendingForMesh(e.getRenderingMesh()))){for(var I=this._scene.activeCamera.globalPosition,x=0;x<o.length;x++){var A=o[x];A._distanceToCamera=S.Distance(A.getBoundingInfo().boundingSphere.centerWorld,I)}o.sort(function(C,V){return C._distanceToCamera>V._distanceToCamera?-1:C._distanceToCamera<V._distanceToCamera?1:0})}for(var x=0;x<o.length;x++){var b=o[x],y=b.getWorldMatrix();y.copyToArray(f.instancesData,g),this._scene.needsPreviousWorldMatrices&&(b._previousWorldMatrix?(b._previousWorldMatrix.copyToArray(f.instancesPreviousData,g),b._previousWorldMatrix.copyFrom(y)):(b._previousWorldMatrix=y.clone(),b._previousWorldMatrix.copyToArray(f.instancesPreviousData,g))),g+=16,_++}}}else _=(D?1:0)+o.length;return m?(c&&c.dispose(),u&&u.dispose(),c=new ee(s,f.instancesData,!0,16,!1,!0),f.instancesBuffer=c,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=c.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=c.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=c.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=c.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(u=new ee(s,f.instancesPreviousData,!0,16,!1,!0),f.instancesPreviousBuffer=u,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=u.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=u.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=u.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=u.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):this._instanceDataStorage.isFrozen||(c.updateDirectly(f.instancesData,0,_),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&u.updateDirectly(f.instancesPreviousData,0,_)),this._processInstancedBuffers(o,D),this.getScene()._activeIndices.addCount(e.indexCount*_,!1),s._currentDrawContext&&(s._currentDrawContext.useInstancing=!0),this._bind(e,r,i),this._draw(e,i,_),this._scene.needsPreviousWorldMatrices&&!m&&this._instanceDataStorage.manualUpdate&&!this._instanceDataStorage.isFrozen&&!this._instanceDataStorage.previousManualUpdate&&u.updateDirectly(f.instancesData,0,_),s.unbindInstanceAttributes(),this},t.prototype._renderWithThinInstances=function(e,i,n,r){var s,a,o=(a=(s=this._thinInstanceDataStorage)===null||s===void 0?void 0:s.instancesCount)!==null&&a!==void 0?a:0;this.getScene()._activeIndices.addCount(e.indexCount*o,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,n,i),this._draw(e,i,o),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,o):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),r.unbindInstanceAttributes()},t.prototype._processInstancedBuffers=function(e,i){},t.prototype._processRendering=function(e,i,n,r,s,a,o,f){var h=this.getScene(),c=h.getEngine();if(a&&i.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(i,r,n,c),this;if(a)this._renderWithInstances(i,r,s,n,c);else{c._currentDrawContext&&(c._currentDrawContext.useInstancing=!1);var u=0;s.renderSelf[i._id]&&(o&&o(!1,e.getWorldMatrix(),f),u++,this._draw(i,r,this._instanceDataStorage.overridenInstanceCount));var p=s.visibleInstances[i._id];if(p){var d=p.length;u+=d;for(var g=0;g<d;g++){var _=p[g],D=_.getWorldMatrix();o&&o(!0,D,f),this._draw(i,r)}}h._activeIndices.addCount(i.indexCount*u,!1)}return this},t.prototype._rebuild=function(e){if(e===void 0&&(e=!1),this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(var i in this._userInstancedBuffersStorage.vertexBuffers){var n=this._userInstancedBuffersStorage.vertexBuffers[i];n&&(e&&n.dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,v.prototype._rebuild.call(this,e)},t.prototype._freeze=function(){if(!!this.subMeshes){for(var e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}},t.prototype._unFreeze=function(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null},t.prototype.render=function(e,i,n){var r,s,a,o=this.getScene();if(this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1,this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;var f=this._getInstancesRenderList(e._id,!!n);if(f.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;var h=o.getEngine(),c=0,u=null;this.ignoreCameraMaxZ&&o.activeCamera&&!o._isInIntermediateRendering()&&(c=o.activeCamera.maxZ,u=o.activeCamera,o.activeCamera.maxZ=0,o.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);var p=f.hardwareInstancedRendering[e._id]||e.getRenderingMesh().hasThinInstances,d=this._instanceDataStorage,g=e.getMaterial();if(!g)return u&&(u.maxZ=c,o.updateTransformMatrix(!0)),this;if(!d.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==g){if(g._storeEffectOnSubMeshes){if(!g.isReadyForSubMesh(this,e,p))return u&&(u.maxZ=c,o.updateTransformMatrix(!0)),this}else if(!g.isReady(this,p))return u&&(u.maxZ=c,o.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=g}else if(g._storeEffectOnSubMeshes&&!(!((r=e.effect)===null||r===void 0)&&r._wasPreviouslyReady)||!g._storeEffectOnSubMeshes&&!(!((s=g.getEffect())===null||s===void 0)&&s._wasPreviouslyReady))return u&&(u.maxZ=c,o.updateTransformMatrix(!0)),this;i&&h.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode);var _;this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?_=e._drawWrapper:_=this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();for(var D=(a=_==null?void 0:_.effect)!==null&&a!==void 0?a:null,m=0,M=o._beforeRenderingMeshStage;m<M.length;m++){var I=M[m];I.action(this,e,f,D)}if(!_||!D)return u&&(u.maxZ=c,o.updateTransformMatrix(!0)),this;var x=n||this,A;if(!d.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this.overrideMaterialSideOrientation!==null)){var b=x._getWorldMatrixDeterminant();A=this.overrideMaterialSideOrientation,A==null&&(A=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),b<0&&(A=A===R.ClockWiseSideOrientation?R.CounterClockWiseSideOrientation:R.ClockWiseSideOrientation),d.sideOrientation=A}else A=d.sideOrientation;var y=this._internalMeshDataInfo._effectiveMaterial._preBind(_,A);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&h.setDepthWrite(!0);var C=o.forcePointsCloud?R.PointFillMode:o.forceWireframe?R.WireFrameFillMode:this._internalMeshDataInfo._effectiveMaterial.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),p||this._bind(e,D,C);var V=this._internalMeshDataInfo._effectiveMaterial,T=x.getWorldMatrix();V._storeEffectOnSubMeshes?V.bindForSubMesh(T,this,e):V.bind(T,this),!V.backFaceCulling&&V.separateCullingPass&&(h.setState(!0,V.zOffset,!1,!y,V.cullBackFaces,V.stencil,V.zOffsetUnits),this._processRendering(this,e,D,C,f,p,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),h.setState(!0,V.zOffset,!1,y,V.cullBackFaces,V.stencil,V.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,D,C,f,p,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(var L=0,K=o._afterRenderingMeshStage;L<K.length;L++){var I=K[L];I.action(this,e,f,D)}return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),u&&(u.maxZ=c,o.updateTransformMatrix(!0)),this},t.prototype.cleanMatrixWeights=function(){this.isVerticesDataPresent(l.MatricesWeightsKind)&&(this.isVerticesDataPresent(l.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())},t.prototype._normalizeSkinFourWeights=function(){for(var e=this.getVerticesData(l.MatricesWeightsKind),i=e.length,n=0;n<i;n+=4){var r=e[n]+e[n+1]+e[n+2]+e[n+3];if(r===0)e[n]=1;else{var s=1/r;e[n]*=s,e[n+1]*=s,e[n+2]*=s,e[n+3]*=s}}this.setVerticesData(l.MatricesWeightsKind,e)},t.prototype._normalizeSkinWeightsAndExtra=function(){for(var e=this.getVerticesData(l.MatricesWeightsExtraKind),i=this.getVerticesData(l.MatricesWeightsKind),n=i.length,r=0;r<n;r+=4){var s=i[r]+i[r+1]+i[r+2]+i[r+3];if(s+=e[r]+e[r+1]+e[r+2]+e[r+3],s===0)i[r]=1;else{var a=1/s;i[r]*=a,i[r+1]*=a,i[r+2]*=a,i[r+3]*=a,e[r]*=a,e[r+1]*=a,e[r+2]*=a,e[r+3]*=a}}this.setVerticesData(l.MatricesWeightsKind,i),this.setVerticesData(l.MatricesWeightsKind,e)},t.prototype.validateSkinning=function(){var e=this.getVerticesData(l.MatricesWeightsExtraKind),i=this.getVerticesData(l.MatricesWeightsKind);if(i===null||this.skeleton==null)return{skinned:!1,valid:!0,report:"not skinned"};for(var n=i.length,r=0,s=0,a=0,o=0,f=e===null?4:8,h=new Array,c=0;c<=f;c++)h[c]=0;for(var u=.001,c=0;c<n;c+=4){for(var p=i[c],d=p,g=d===0?0:1,_=1;_<f;_++){var D=_<4?i[c+_]:e[c+_-4];D>p&&r++,D!==0&&g++,d+=D,p=D}if(h[g]++,g>a&&(a=g),d===0)s++;else{for(var m=1/d,M=0,_=0;_<f;_++)_<4?M+=Math.abs(i[c+_]-i[c+_]*m):M+=Math.abs(e[c+_-4]-e[c+_-4]*m);M>u&&o++}}for(var I=this.skeleton.bones.length,x=this.getVerticesData(l.MatricesIndicesKind),A=this.getVerticesData(l.MatricesIndicesExtraKind),b=0,c=0;c<n;c+=4)for(var _=0;_<f;_++){var y=_<4?x[c+_]:A[c+_-4];(y>=I||y<0)&&b++}var C="Number of Weights = "+n/4+`
Maximum influences = `+a+`
Missing Weights = `+s+`
Not Sorted = `+r+`
Not Normalized = `+o+`
WeightCounts = [`+h+`]
Number of bones = `+I+`
Bad Bone Indices = `+b;return{skinned:!0,valid:s===0&&o===0&&b===0,report:C}},t.prototype._checkDelayState=function(){var e=this.getScene();return this._geometry?this._geometry.load(e):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(e)),this},t.prototype._queueLoad=function(e){var i=this;e._addPendingData(this);var n=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;return J.LoadFile(this.delayLoadingFile,function(r){r instanceof ArrayBuffer?i._delayLoadingFunction(r,i):i._delayLoadingFunction(JSON.parse(r),i),i.instances.forEach(function(s){s.refreshBoundingInfo(),s._syncSubMeshes()}),i.delayLoadState=1,e._removePendingData(i)},function(){},e.offlineProvider,n),this},t.prototype.isInFrustum=function(e){return this.delayLoadState===2||!v.prototype.isInFrustum.call(this,e)?!1:(this._checkDelayState(),!0)},t.prototype.setMaterialById=function(e){var i=this.getScene().materials,n;for(n=i.length-1;n>-1;n--)if(i[n].id===e)return this.material=i[n],this;var r=this.getScene().multiMaterials;for(n=r.length-1;n>-1;n--)if(r[n].id===e)return this.material=r[n],this;return this},t.prototype.getAnimatables=function(){var e=new Array;return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e},t.prototype.bakeTransformIntoVertices=function(e){if(!this.isVerticesDataPresent(l.PositionKind))return this;var i=this.subMeshes.splice(0);this._resetPointsArrayCache();var n=this.getVerticesData(l.PositionKind),r=new Array,s;for(s=0;s<n.length;s+=3)S.TransformCoordinates(S.FromArray(n,s),e).toArray(r,s);if(this.setVerticesData(l.PositionKind,r,this.getVertexBuffer(l.PositionKind).isUpdatable()),this.isVerticesDataPresent(l.NormalKind)){for(n=this.getVerticesData(l.NormalKind),r=[],s=0;s<n.length;s+=3)S.TransformNormal(S.FromArray(n,s),e).normalize().toArray(r,s);this.setVerticesData(l.NormalKind,r,this.getVertexBuffer(l.NormalKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=i,this},t.prototype.bakeCurrentTransformIntoVertices=function(e){return e===void 0&&(e=!0),this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this},Object.defineProperty(t.prototype,"_positions",{get:function(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null},enumerable:!1,configurable:!0}),t.prototype._resetPointsArrayCache=function(){return this._geometry&&this._geometry._resetPointsArrayCache(),this},t.prototype._generatePointsArray=function(){return this._geometry?this._geometry._generatePointsArray():!1},t.prototype.clone=function(e,i,n,r){return e===void 0&&(e=""),i===void 0&&(i=null),r===void 0&&(r=!0),new t(e,this.getScene(),i,this,n,r)},t.prototype.dispose=function(e,i){i===void 0&&(i=!1),this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);var n=this._internalMeshDataInfo;if(n._onBeforeDrawObservable&&n._onBeforeDrawObservable.clear(),n._onBeforeBindObservable&&n._onBeforeBindObservable.clear(),n._onBeforeRenderObservable&&n._onBeforeRenderObservable.clear(),n._onAfterRenderObservable&&n._onAfterRenderObservable.clear(),n._onBetweenPassObservable&&n._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(n.meshMap)for(var r in n.meshMap){var s=n.meshMap[r];s&&(s._internalMeshDataInfo._source=null,n.meshMap[r]=void 0)}n._source&&n._source._internalMeshDataInfo.meshMap&&(n._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else for(var a=this.getScene().meshes,o=0,f=a;o<f.length;o++){var h=f[o],s=h;s._internalMeshDataInfo&&s._internalMeshDataInfo._source&&s._internalMeshDataInfo._source===this&&(s._internalMeshDataInfo._source=null)}n._source=null,this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),v.prototype.dispose.call(this,e,i)},t.prototype._disposeInstanceSpecificData=function(){},t.prototype._disposeThinInstanceSpecificData=function(){},t.prototype._invalidateInstanceVertexArrayObject=function(){},t.prototype.applyDisplacementMap=function(e,i,n,r,s,a,o){var f=this;o===void 0&&(o=!1);var h=this.getScene(),c=function(u){var p=u.width,d=u.height,g=f.getEngine().createCanvas(p,d),_=g.getContext("2d");_.drawImage(u,0,0);var D=_.getImageData(0,0,p,d).data;f.applyDisplacementMapFromBuffer(D,p,d,i,n,s,a,o),r&&r(f)};return J.LoadImage(e,c,function(){},h.offlineProvider),this},t.prototype.applyDisplacementMapFromBuffer=function(e,i,n,r,s,a,o,f){if(f===void 0&&(f=!1),!this.isVerticesDataPresent(l.PositionKind)||!this.isVerticesDataPresent(l.NormalKind)||!this.isVerticesDataPresent(l.UVKind))return W.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;var h=this.getVerticesData(l.PositionKind,!0,!0),c=this.getVerticesData(l.NormalKind),u=this.getVerticesData(l.UVKind),p=S.Zero(),d=S.Zero(),g=j.Zero();a=a||j.Zero(),o=o||new j(1,1);for(var _=0;_<h.length;_+=3){S.FromArrayToRef(h,_,p),S.FromArrayToRef(c,_,d),j.FromArrayToRef(u,_/3*2,g);var D=Math.abs(g.x*o.x+a.x%1)*(i-1)%i|0,m=Math.abs(g.y*o.y+a.y%1)*(n-1)%n|0,M=(D+m*i)*4,I=e[M]/255,x=e[M+1]/255,A=e[M+2]/255,b=I*.3+x*.59+A*.11;d.normalize(),d.scaleInPlace(r+(s-r)*b),p=p.add(d),p.toArray(h,_)}return F.ComputeNormals(h,this.getIndices(),c),f?(this.setVerticesData(l.PositionKind,h),this.setVerticesData(l.NormalKind,c),this.setVerticesData(l.UVKind,u)):(this.updateVerticesData(l.PositionKind,h),this.updateVerticesData(l.NormalKind,c)),this},t.prototype.convertToFlatShadedMesh=function(){var e=this.getVerticesDataKinds(),i={},n={},r={},s=!1,a,o;for(a=0;a<e.length;a++){o=e[a];var f=this.getVertexBuffer(o),h=f.getData();if(!((h instanceof Array||h instanceof Float32Array)&&h.length===0)){if(o===l.NormalKind){s=f.isUpdatable(),e.splice(a,1),a--;continue}i[o]=f,n[o]=this.getVerticesData(o),r[o]=[]}}var c=this.subMeshes.slice(0),u=this.getIndices(),p=this.getTotalIndices(),d;for(d=0;d<p;d++){var g=u[d];for(a=0;a<e.length;a++)if(o=e[a],!!i[o])for(var _=i[o].getStrideSize(),D=0;D<_;D++)r[o].push(n[o][g*_+D])}var m=[],M=r[l.PositionKind],I=this.getScene().useRightHandedSystem,x;for(I?x=this.overrideMaterialSideOrientation===1:x=this.overrideMaterialSideOrientation===0,d=0;d<p;d+=3){u[d]=d,u[d+1]=d+1,u[d+2]=d+2;var A=S.FromArray(M,d*3),b=S.FromArray(M,(d+1)*3),y=S.FromArray(M,(d+2)*3),C=A.subtract(b),V=y.subtract(b),T=S.Normalize(S.Cross(C,V));x&&T.scaleInPlace(-1);for(var L=0;L<3;L++)m.push(T.x),m.push(T.y),m.push(T.z)}for(this.setIndices(u),this.setVerticesData(l.NormalKind,m,s),a=0;a<e.length;a++)o=e[a],r[o]&&this.setVerticesData(o,r[o],i[o].isUpdatable());this.releaseSubMeshes();for(var K=0;K<c.length;K++){var w=c[K];z.AddToMesh(w.materialIndex,w.indexStart,w.indexCount,w.indexStart,w.indexCount,this)}return this.synchronizeInstances(),this},t.prototype.convertToUnIndexedMesh=function(){var e=this.getVerticesDataKinds(),i={},n={},r={},s,a;for(s=0;s<e.length;s++){a=e[s];var o=this.getVertexBuffer(a);i[a]=o,n[a]=i[a].getData(),r[a]=[]}var f=this.subMeshes.slice(0),h=this.getIndices(),c=this.getTotalIndices(),u;for(u=0;u<c;u++){var p=h[u];for(s=0;s<e.length;s++){a=e[s];for(var d=i[a].getStrideSize(),g=0;g<d;g++)r[a].push(n[a][p*d+g])}}for(u=0;u<c;u+=3)h[u]=u,h[u+1]=u+1,h[u+2]=u+2;for(this.setIndices(h),s=0;s<e.length;s++)a=e[s],this.setVerticesData(a,r[a],i[a].isUpdatable(),i[a].getStrideSize());this.releaseSubMeshes();for(var _=0;_<f.length;_++){var D=f[_];z.AddToMesh(D.materialIndex,D.indexStart,D.indexCount,D.indexStart,D.indexCount,this)}return this._unIndexed=!0,this.synchronizeInstances(),this},t.prototype.flipFaces=function(e){e===void 0&&(e=!1);var i=F.ExtractFromMesh(this),n;if(e&&this.isVerticesDataPresent(l.NormalKind)&&i.normals)for(n=0;n<i.normals.length;n++)i.normals[n]*=-1;if(i.indices){var r=void 0;for(n=0;n<i.indices.length;n+=3)r=i.indices[n+1],i.indices[n+1]=i.indices[n+2],i.indices[n+2]=r}return i.applyToMesh(this,this.isVertexBufferUpdatable(l.PositionKind)),this},t.prototype.increaseVertices=function(e){e===void 0&&(e=1);var i=F.ExtractFromMesh(this),n=i.indices&&!Array.isArray(i.indices)&&Array.from?Array.from(i.indices):i.indices,r=i.positions&&!Array.isArray(i.positions)&&Array.from?Array.from(i.positions):i.positions,s=i.uvs&&!Array.isArray(i.uvs)&&Array.from?Array.from(i.uvs):i.uvs,a=i.normals&&!Array.isArray(i.normals)&&Array.from?Array.from(i.normals):i.normals;if(!n||!r)W.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions");else{i.indices=n,i.positions=r,s&&(i.uvs=s),a&&(i.normals=a);for(var o=e+1,f=new Array,h=0;h<o+1;h++)f[h]=new Array;var c=void 0,u=void 0,p=new S(0,0,0),d=new S(0,0,0),g=new j(0,0),_=new Array,D=new Array,m=new Array,M=void 0,I=r.length,x=void 0;s&&(x=s.length);var A=void 0;a&&(A=a.length);for(var h=0;h<n.length;h+=3){D[0]=n[h],D[1]=n[h+1],D[2]=n[h+2];for(var b=0;b<3;b++)if(c=D[b],u=D[(b+1)%3],m[c]===void 0&&m[u]===void 0?(m[c]=new Array,m[u]=new Array):(m[c]===void 0&&(m[c]=new Array),m[u]===void 0&&(m[u]=new Array)),m[c][u]===void 0&&m[u][c]===void 0){m[c][u]=[],p.x=(r[3*u]-r[3*c])/o,p.y=(r[3*u+1]-r[3*c+1])/o,p.z=(r[3*u+2]-r[3*c+2])/o,a&&(d.x=(a[3*u]-a[3*c])/o,d.y=(a[3*u+1]-a[3*c+1])/o,d.z=(a[3*u+2]-a[3*c+2])/o),s&&(g.x=(s[2*u]-s[2*c])/o,g.y=(s[2*u+1]-s[2*c+1])/o),m[c][u].push(c);for(var y=1;y<o;y++)m[c][u].push(r.length/3),r[I++]=r[3*c]+y*p.x,r[I++]=r[3*c+1]+y*p.y,r[I++]=r[3*c+2]+y*p.z,a&&(a[A++]=a[3*c]+y*d.x,a[A++]=a[3*c+1]+y*d.y,a[A++]=a[3*c+2]+y*d.z),s&&(s[x++]=s[2*c]+y*g.x,s[x++]=s[2*c+1]+y*g.y);m[c][u].push(u),m[u][c]=new Array,M=m[c][u].length;for(var C=0;C<M;C++)m[u][c][C]=m[c][u][M-1-C]}f[0][0]=n[h],f[1][0]=m[n[h]][n[h+1]][1],f[1][1]=m[n[h]][n[h+2]][1];for(var y=2;y<o;y++){f[y][0]=m[n[h]][n[h+1]][y],f[y][y]=m[n[h]][n[h+2]][y],p.x=(r[3*f[y][y]]-r[3*f[y][0]])/y,p.y=(r[3*f[y][y]+1]-r[3*f[y][0]+1])/y,p.z=(r[3*f[y][y]+2]-r[3*f[y][0]+2])/y,a&&(d.x=(a[3*f[y][y]]-a[3*f[y][0]])/y,d.y=(a[3*f[y][y]+1]-a[3*f[y][0]+1])/y,d.z=(a[3*f[y][y]+2]-a[3*f[y][0]+2])/y),s&&(g.x=(s[2*f[y][y]]-s[2*f[y][0]])/y,g.y=(s[2*f[y][y]+1]-s[2*f[y][0]+1])/y);for(var b=1;b<y;b++)f[y][b]=r.length/3,r[I++]=r[3*f[y][0]]+b*p.x,r[I++]=r[3*f[y][0]+1]+b*p.y,r[I++]=r[3*f[y][0]+2]+b*p.z,a&&(a[A++]=a[3*f[y][0]]+b*d.x,a[A++]=a[3*f[y][0]+1]+b*d.y,a[A++]=a[3*f[y][0]+2]+b*d.z),s&&(s[x++]=s[2*f[y][0]]+b*g.x,s[x++]=s[2*f[y][0]+1]+b*g.y)}f[o]=m[n[h+1]][n[h+2]],_.push(f[0][0],f[1][0],f[1][1]);for(var y=1;y<o;y++){var b=void 0;for(b=0;b<y;b++)_.push(f[y][b],f[y+1][b],f[y+1][b+1]),_.push(f[y][b],f[y+1][b+1],f[y][b+1]);_.push(f[y][b],f[y+1][b],f[y+1][b+1])}}i.indices=_,i.applyToMesh(this,this.isVertexBufferUpdatable(l.PositionKind))}},t.prototype.forceSharedVertices=function(){var e=F.ExtractFromMesh(this),i=e.uvs,n=e.indices,r=e.positions,s=e.colors;if(n===void 0||r===void 0||n===null||r===null)W.Warn("VertexData contains empty entries");else{for(var a=new Array,o=new Array,f=new Array,h=new Array,c=new Array,u=0,p={},d=void 0,g=void 0,_=0;_<n.length;_+=3){g=[n[_],n[_+1],n[_+2]],c=new Array;for(var D=0;D<3;D++){c[D]="";for(var m=0;m<3;m++)Math.abs(r[3*g[D]+m])<1e-8&&(r[3*g[D]+m]=0),c[D]+=r[3*g[D]+m]+"|"}if(!(c[0]==c[1]||c[0]==c[2]||c[1]==c[2]))for(var D=0;D<3;D++){if(d=p[c[D]],d===void 0){p[c[D]]=u,d=u++;for(var m=0;m<3;m++)a.push(r[3*g[D]+m]);if(s!=null)for(var m=0;m<4;m++)h.push(s[4*g[D]+m]);if(i!=null)for(var m=0;m<2;m++)f.push(i[2*g[D]+m])}o.push(d)}}var M=new Array;F.ComputeNormals(a,o,M),e.positions=a,e.indices=o,e.normals=M,i!=null&&(e.uvs=f),s!=null&&(e.colors=h),e.applyToMesh(this,this.isVertexBufferUpdatable(l.PositionKind))}},t._instancedMeshFactory=function(e,i){throw Y("InstancedMesh")},t._PhysicsImpostorParser=function(e,i,n){throw Y("PhysicsImpostor")},t.prototype.createInstance=function(e){return t._instancedMeshFactory(e,this)},t.prototype.synchronizeInstances=function(){for(var e=0;e<this.instances.length;e++){var i=this.instances[e];i._syncSubMeshes()}return this},t.prototype.optimizeIndices=function(e){var i=this,n=this.getIndices(),r=this.getVerticesData(l.PositionKind);if(!r||!n)return this;for(var s=new Array,a=0;a<r.length;a=a+3)s.push(S.FromArray(r,a));var o=new Array;return ge.SyncAsyncForLoop(s.length,40,function(f){for(var h=s.length-1-f,c=s[h],u=0;u<h;++u){var p=s[u];if(c.equals(p)){o[h]=u;break}}},function(){for(var f=0;f<n.length;++f)n[f]=o[n[f]]||n[f];var h=i.subMeshes.slice(0);i.setIndices(n),i.subMeshes=h,e&&e(i)}),this},t.prototype.serialize=function(e){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),P&&P.HasTags(this)&&(e.tags=P.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.checkCollisions=this.checkCollisions,e.isBlocker=this.isBlocker,e.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;var i=this._geometry;if(i&&this.subMeshes){e.geometryUniqueId=i.uniqueId,e.geometryId=i.id,e.subMeshes=[];for(var n=0;n<this.subMeshes.length;n++){var r=this.subMeshes[n];e.subMeshes.push({materialIndex:r.materialIndex,verticesStart:r.verticesStart,verticesCount:r.verticesCount,indexStart:r.indexStart,indexCount:r.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(te.NAME_PHYSICSENGINE)){var s=this.getPhysicsImpostor();s&&(e.physicsMass=s.getParam("mass"),e.physicsFriction=s.getParam("friction"),e.physicsRestitution=s.getParam("mass"),e.physicsImpostor=s.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(var a=0;a<this.instances.length;a++){var o=this.instances[a];if(!o.doNotSerialize){var f={name:o.name,id:o.id,isEnabled:o.isEnabled(!1),isVisible:o.isVisible,isPickable:o.isPickable,checkCollisions:o.checkCollisions,position:o.position.asArray(),scaling:o.scaling.asArray()};if(o.parent&&o.parent._serializeAsParent(f),o.rotationQuaternion?f.rotationQuaternion=o.rotationQuaternion.asArray():o.rotation&&(f.rotation=o.rotation.asArray()),this.getScene()._getComponent(te.NAME_PHYSICSENGINE)){var s=o.getPhysicsImpostor();s&&(f.physicsMass=s.getParam("mass"),f.physicsFriction=s.getParam("friction"),f.physicsRestitution=s.getParam("mass"),f.physicsImpostor=s.type)}o.metadata&&(f.metadata=o.metadata),e.instances.push(f),ie.AppendSerializedAnimations(o,f),f.ranges=o.serializeAnimationRanges()}}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){var h={data:{},sizes:{},strides:{}};for(var c in this._userThinInstanceBuffersStorage.data)h.data[c]=Array.from(this._userThinInstanceBuffersStorage.data[c]),h.sizes[c]=this._userThinInstanceBuffersStorage.sizes[c],h.strides[c]=this._userThinInstanceBuffersStorage.strides[c];e.thinInstances.userThinInstance=h}ie.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name))},t.prototype._syncGeometryWithMorphTargetManager=function(){if(!!this.geometry){this._markSubMeshesAsAttributesDirty();var e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices()){W.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),this.morphTargetManager=null;return}if(e.isUsingTextureForTargets)return;for(var i=0;i<e.numInfluencers;i++){var n=e.getActiveTarget(i),r=n.getPositions();if(!r){W.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(l.PositionKind+i,r,!1,3);var s=n.getNormals();s&&this.geometry.setVerticesData(l.NormalKind+i,s,!1,3);var a=n.getTangents();a&&this.geometry.setVerticesData(l.TangentKind+i,a,!1,3);var o=n.getUVs();o&&this.geometry.setVerticesData(l.UVKind+"_"+i,o,!1,2)}}else for(var i=0;this.geometry.isVerticesDataPresent(l.PositionKind+i);)this.geometry.removeVerticesData(l.PositionKind+i),this.geometry.isVerticesDataPresent(l.NormalKind+i)&&this.geometry.removeVerticesData(l.NormalKind+i),this.geometry.isVerticesDataPresent(l.TangentKind+i)&&this.geometry.removeVerticesData(l.TangentKind+i),this.geometry.isVerticesDataPresent(l.UVKind+i)&&this.geometry.removeVerticesData(l.UVKind+"_"+i),i++}},t.Parse=function(e,i,n){var r;if(e.type&&e.type==="LinesMesh"?r=t._LinesMeshParser(e,i):e.type&&e.type==="GroundMesh"?r=t._GroundMeshParser(e,i):e.type&&e.type==="GoldbergMesh"?r=t._GoldbergMeshParser(e,i):r=new t(e.name,i),r.id=e.id,P&&P.AddTagsTo(r,e.tags),r.position=S.FromArray(e.position),e.metadata!==void 0&&(r.metadata=e.metadata),e.rotationQuaternion?r.rotationQuaternion=re.FromArray(e.rotationQuaternion):e.rotation&&(r.rotation=S.FromArray(e.rotation)),r.scaling=S.FromArray(e.scaling),e.localMatrix?r.setPreTransformMatrix(Q.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(Q.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r.isVisible=e.isVisible,r.infiniteDistance=e.infiniteDistance,r.showBoundingBox=e.showBoundingBox,r.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,e.applyFog!==void 0&&(r.applyFog=e.applyFog),e.pickable!==void 0&&(r.isPickable=e.pickable),e.alphaIndex!==void 0&&(r.alphaIndex=e.alphaIndex),r.receiveShadows=e.receiveShadows,r.billboardMode=e.billboardMode,e.visibility!==void 0&&(r.visibility=e.visibility),r.checkCollisions=e.checkCollisions,r.overrideMaterialSideOrientation=e.overrideMaterialSideOrientation,e.isBlocker!==void 0&&(r.isBlocker=e.isBlocker),r._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(r._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.actions!==void 0&&(r._waitingData.actions=e.actions),e.overlayAlpha!==void 0&&(r.overlayAlpha=e.overlayAlpha),e.overlayColor!==void 0&&(r.overlayColor=_e.FromArray(e.overlayColor)),e.renderOverlay!==void 0&&(r.renderOverlay=e.renderOverlay),r.isUnIndexed=!!e.isUnIndexed,r.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=n+e.delayLoadingFile,r.buildBoundingInfo(S.FromArray(e.boundingBoxMinimum),S.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(r._binaryInfo=e._binaryInfo),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(l.UVKind),e.hasUVs2&&r._delayInfo.push(l.UV2Kind),e.hasUVs3&&r._delayInfo.push(l.UV3Kind),e.hasUVs4&&r._delayInfo.push(l.UV4Kind),e.hasUVs5&&r._delayInfo.push(l.UV5Kind),e.hasUVs6&&r._delayInfo.push(l.UV6Kind),e.hasColors&&r._delayInfo.push(l.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(l.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(l.MatricesWeightsKind),r._delayLoadingFunction=k._ImportGeometry,le.ForceFullSceneLoadingForIncremental&&r._checkDelayState()):k._ImportGeometry(e,r),e.materialUniqueId?r._waitingMaterialId=e.materialUniqueId:e.materialId&&(r._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(r.morphTargetManager=i.getMorphTargetManagerById(e.morphTargetManagerId)),e.skeletonId!==void 0&&e.skeletonId!==null&&(r.skeleton=i.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(r.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(var s=0;s<e.animations.length;s++){var a=e.animations[s],o=ne("BABYLON.Animation");o&&r.animations.push(o.Parse(a))}ae.ParseAnimationRanges(r,e,i)}if(e.autoAnimate&&i.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?r.layerMask=Math.abs(parseInt(e.layerMask)):r.layerMask=268435455,e.physicsImpostor&&t._PhysicsImpostorParser(i,r,e),e.lodMeshIds&&(r._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(var f=0;f<e.instances.length;f++){var h=e.instances[f],c=r.createInstance(h.name);if(h.id&&(c.id=h.id),P&&(h.tags?P.AddTagsTo(c,h.tags):P.AddTagsTo(c,e.tags)),c.position=S.FromArray(h.position),h.metadata!==void 0&&(c.metadata=h.metadata),h.parentId!==void 0&&(c._waitingParentId=h.parentId),h.parentInstanceIndex!==void 0&&(c._waitingParentInstanceIndex=h.parentInstanceIndex),h.isEnabled!==void 0&&h.isEnabled!==null&&c.setEnabled(h.isEnabled),h.isVisible!==void 0&&h.isVisible!==null&&(c.isVisible=h.isVisible),h.isPickable!==void 0&&h.isPickable!==null&&(c.isPickable=h.isPickable),h.rotationQuaternion?c.rotationQuaternion=re.FromArray(h.rotationQuaternion):h.rotation&&(c.rotation=S.FromArray(h.rotation)),c.scaling=S.FromArray(h.scaling),h.checkCollisions!=null&&h.checkCollisions!=null&&(c.checkCollisions=h.checkCollisions),h.pickable!=null&&h.pickable!=null&&(c.isPickable=h.pickable),h.showBoundingBox!=null&&h.showBoundingBox!=null&&(c.showBoundingBox=h.showBoundingBox),h.showSubMeshesBoundingBox!=null&&h.showSubMeshesBoundingBox!=null&&(c.showSubMeshesBoundingBox=h.showSubMeshesBoundingBox),h.alphaIndex!=null&&h.showSubMeshesBoundingBox!=null&&(c.alphaIndex=h.alphaIndex),h.physicsImpostor&&t._PhysicsImpostorParser(i,c,h),h.animations){for(var s=0;s<h.animations.length;s++){var a=h.animations[s],o=ne("BABYLON.Animation");o&&c.animations.push(o.Parse(a))}ae.ParseAnimationRanges(c,h,i),h.autoAnimate&&i.beginAnimation(c,h.autoAnimateFrom,h.autoAnimateTo,h.autoAnimateLoop,h.autoAnimateSpeed||1)}}if(e.thinInstances){var u=e.thinInstances;if(r.thinInstanceEnablePicking=!!u.enablePicking,u.matrixData?(r.thinInstanceSetBuffer("matrix",new Float32Array(u.matrixData),16,!1),r._thinInstanceDataStorage.matrixBufferSize=u.matrixBufferSize,r._thinInstanceDataStorage.instancesCount=u.instancesCount):r._thinInstanceDataStorage.matrixBufferSize=u.matrixBufferSize,e.thinInstances.userThinInstance){var p=e.thinInstances.userThinInstance;for(var d in p.data)r.thinInstanceSetBuffer(d,new Float32Array(p.data[d]),p.strides[d],!1),r._userThinInstanceBuffersStorage.sizes[d]=p.sizes[d]}}return r},t.prototype.setPositionsForCPUSkinning=function(){var e=this._internalMeshDataInfo;if(!e._sourcePositions){var i=this.getVerticesData(l.PositionKind);if(!i)return e._sourcePositions;e._sourcePositions=new Float32Array(i),this.isVertexBufferUpdatable(l.PositionKind)||this.setVerticesData(l.PositionKind,i,!0)}return e._sourcePositions},t.prototype.setNormalsForCPUSkinning=function(){var e=this._internalMeshDataInfo;if(!e._sourceNormals){var i=this.getVerticesData(l.NormalKind);if(!i)return e._sourceNormals;e._sourceNormals=new Float32Array(i),this.isVertexBufferUpdatable(l.NormalKind)||this.setVerticesData(l.NormalKind,i,!0)}return e._sourceNormals},t.prototype.applySkeleton=function(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(l.PositionKind))return this;if(!this.isVerticesDataPresent(l.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(l.MatricesWeightsKind))return this;var i=this.isVerticesDataPresent(l.NormalKind),n=this._internalMeshDataInfo;if(!n._sourcePositions){var r=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=r}i&&!n._sourceNormals&&this.setNormalsForCPUSkinning();var s=this.getVerticesData(l.PositionKind);if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s));var a=this.getVerticesData(l.NormalKind);if(i){if(!a)return this;a instanceof Float32Array||(a=new Float32Array(a))}var o=this.getVerticesData(l.MatricesIndicesKind),f=this.getVerticesData(l.MatricesWeightsKind);if(!f||!o)return this;for(var h=this.numBoneInfluencers>4,c=h?this.getVerticesData(l.MatricesIndicesExtraKind):null,u=h?this.getVerticesData(l.MatricesWeightsExtraKind):null,p=e.getTransformMatrices(this),d=S.Zero(),g=new Q,_=new Q,D=0,m,M=0;M<s.length;M+=3,D+=4){var I=void 0;for(m=0;m<4;m++)I=f[D+m],I>0&&(Q.FromFloat32ArrayToRefScaled(p,Math.floor(o[D+m]*16),I,_),g.addToSelf(_));if(h)for(m=0;m<4;m++)I=u[D+m],I>0&&(Q.FromFloat32ArrayToRefScaled(p,Math.floor(c[D+m]*16),I,_),g.addToSelf(_));S.TransformCoordinatesFromFloatsToRef(n._sourcePositions[M],n._sourcePositions[M+1],n._sourcePositions[M+2],g,d),d.toArray(s,M),i&&(S.TransformNormalFromFloatsToRef(n._sourceNormals[M],n._sourceNormals[M+1],n._sourceNormals[M+2],g,d),d.toArray(a,M)),g.reset()}return this.updateVerticesData(l.PositionKind,s),i&&this.updateVerticesData(l.NormalKind,a),this},t.MinMax=function(e){var i=null,n=null;return e.forEach(function(r){var s=r.getBoundingInfo(),a=s.boundingBox;!i||!n?(i=a.minimumWorld,n=a.maximumWorld):(i.minimizeInPlace(a.minimumWorld),n.maximizeInPlace(a.maximumWorld))}),!i||!n?{min:S.Zero(),max:S.Zero()}:{min:i,max:n}},t.Center=function(e){var i=e instanceof Array?t.MinMax(e):e;return S.Center(i.min,i.max)},t.MergeMeshes=function(e,i,n,r,s,a){return i===void 0&&(i=!0),me(t._MergeMeshesCoroutine(e,i,n,r,s,a,!1))},t.MergeMeshesAsync=function(e,i,n,r,s,a){return i===void 0&&(i=!0),De(t._MergeMeshesCoroutine(e,i,n,r,s,a,!0),be())},t._MergeMeshesCoroutine=function(e,i,n,r,s,a,o){var f,h,c,u,p,d,g,_,D,O,O,O,m,M,I,x,A,b,y,C,V,T,L,K,w,N,E,$,Z,O;return i===void 0&&(i=!0),ye(this,function(U){switch(U.label){case 0:if(e=e.filter(Boolean),e.length===0)return[2,null];if(!n){for(h=0,f=0;f<e.length;f++)if(h+=e[f].getTotalVertices(),h>=65536)return W.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),[2,null]}for(a&&(s=!1),c=new Array,u=new Array,p=new Array,d=e[0].overrideMaterialSideOrientation,f=0;f<e.length;f++){if(g=e[f],g.isAnInstance)return W.Warn("Cannot merge instance meshes."),[2,null];if(d!==g.overrideMaterialSideOrientation)return W.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),[2,null];if(s&&p.push(g.getTotalIndices()),a)if(g.material)if(_=g.material,_ instanceof X){for(D=0;D<_.subMaterials.length;D++)c.indexOf(_.subMaterials[D])<0&&c.push(_.subMaterials[D]);for(O=0;O<g.subMeshes.length;O++)u.push(c.indexOf(_.subMaterials[g.subMeshes[O].materialIndex])),p.push(g.subMeshes[O].indexCount)}else for(c.indexOf(_)<0&&c.push(_),O=0;O<g.subMeshes.length;O++)u.push(c.indexOf(_)),p.push(g.subMeshes[O].indexCount);else for(O=0;O<g.subMeshes.length;O++)u.push(0),p.push(g.subMeshes[O].indexCount)}return m=e[0],M=function(G){var he=G.computeWorldMatrix(!0),ce=F.ExtractFromMesh(G,!1,!1);return[ce,he]},I=M(m),x=I[0],A=I[1],o?[4]:[3,2];case 1:U.sent(),U.label=2;case 2:b=new Array(e.length-1),y=1,U.label=3;case 3:return y<e.length?(b[y-1]=M(e[y]),o?[4]:[3,5]):[3,6];case 4:U.sent(),U.label=5;case 5:return y++,[3,3];case 6:C=x._mergeCoroutine(A,b,n,o,!i),V=C.next(),U.label=7;case 7:return V.done?[3,10]:o?[4]:[3,9];case 8:U.sent(),U.label=9;case 9:return V=C.next(),[3,7];case 10:T=V.value,r||(r=new t(m.name+"_merged",m.getScene())),L=T._applyToCoroutine(r,void 0,o),K=L.next(),U.label=11;case 11:return K.done?[3,14]:o?[4]:[3,13];case 12:U.sent(),U.label=13;case 13:return K=L.next(),[3,11];case 14:if(r.checkCollisions=m.checkCollisions,r.overrideMaterialSideOrientation=m.overrideMaterialSideOrientation,i)for(f=0;f<e.length;f++)e[f].dispose();if(s||a){for(r.releaseSubMeshes(),f=0,w=0;f<p.length;)z.CreateFromIndices(0,w,p[f],r,void 0,!1),w+=p[f],f++;for(N=0,E=r.subMeshes;N<E.length;N++)$=E[N],$.refreshBoundingInfo();r.computeWorldMatrix(!0)}if(a){for(Z=new X(m.name+"_merged",m.getScene()),Z.subMaterials=c,O=0;O<r.subMeshes.length;O++)r.subMeshes[O].materialIndex=u[O];r.material=Z}else r.material=m.material;return[2,r]}})},t.prototype.addInstance=function(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)},t.prototype.removeInstance=function(e){var i=e._indexInSourceMeshInstanceArray;if(i!=-1){if(i!==this.instances.length-1){var n=this.instances[this.instances.length-1];this.instances[i]=n,n._indexInSourceMeshInstanceArray=i}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}},t.prototype._shouldConvertRHS=function(){return this.overrideMaterialSideOrientation===R.CounterClockWiseSideOrientation},t.FRONTSIDE=F.FRONTSIDE,t.BACKSIDE=F.BACKSIDE,t.DOUBLESIDE=F.DOUBLESIDE,t.DEFAULTSIDE=F.DEFAULTSIDE,t.NO_CAP=0,t.CAP_START=1,t.CAP_END=2,t.CAP_ALL=3,t.NO_FLIP=0,t.FLIP_TILE=1,t.ROTATE_TILE=2,t.FLIP_ROW=3,t.ROTATE_ROW=4,t.FLIP_N_ROTATE_TILE=5,t.FLIP_N_ROTATE_ROW=6,t.CENTER=0,t.LEFT=1,t.RIGHT=2,t.TOP=3,t.BOTTOM=4,t.INSTANCEDMESH_SORT_TRANSPARENT=!1,t._GroundMeshParser=function(e,i){throw Y("GroundMesh")},t._GoldbergMeshParser=function(e,i){throw Y("GoldbergMesh")},t._LinesMeshParser=function(e,i){throw Y("LinesMesh")},t}(Ie);ue("BABYLON.Mesh",B);B.prototype.setMaterialByID=function(v){return this.setMaterialById(v)};B.CreateDisc=B.CreateDisc||function(){throw new Error("Import MeshBuilder to populate this function")};B.CreateBox=B.CreateBox||function(){throw new Error("Import MeshBuilder to populate this function")};B.CreateSphere=B.CreateSphere||function(){throw new Error("Import MeshBuilder to populate this function")};B.CreateCylinder=B.CreateCylinder||function(){throw new Error("Import MeshBuilder to populate this function")};B.CreateTorusKnot=B.CreateTorusKnot||function(){throw new Error("Import MeshBuilder to populate this function")};B.CreateTorus=B.CreateTorus||function(){throw new Error("Import MeshBuilder to populate this function")};B.CreatePlane=B.CreatePlane||function(){throw new Error("Import MeshBuilder to populate this function")};B.CreateGround=B.CreateGround||function(){throw new Error("Import MeshBuilder to populate this function")};B.CreateTiledGround=B.CreateTiledGround||function(){throw new Error("Import MeshBuilder to populate this function")};B.CreateGroundFromHeightMap=B.CreateGroundFromHeightMap||function(){throw new Error("Import MeshBuilder to populate this function")};B.CreateTube=B.CreateTube||function(){throw new Error("Import MeshBuilder to populate this function")};B.CreatePolyhedron=B.CreatePolyhedron||function(){throw new Error("Import MeshBuilder to populate this function")};B.CreateIcoSphere=B.CreateIcoSphere||function(){throw new Error("Import MeshBuilder to populate this function")};B.CreateDecal=B.CreateDecal||function(){throw new Error("Import MeshBuilder to populate this function")};B.CreateCapsule=B.CreateCapsule||function(){throw new Error("Import MeshBuilder to populate this function")};B.ExtendToGoldberg=B.ExtendToGoldberg||function(){throw new Error("Import MeshBuilder to populate this function")};export{B as M};
