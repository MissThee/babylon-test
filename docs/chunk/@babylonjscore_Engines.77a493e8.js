import{_ as J,c as we,d as Fe,b as se}from"./tslibtslib.b6e59fa7.js";import{_ as ve,I as ae,L as I,l as dt,O as ee,m as vt,n as pr,a as ce,o as gr,p as mr,E as je,q as St,r as pt,t as lt,F as vr,u as Er,v as Tr,w as Rr,x as yr,y as br,C as Ar,z as Sr}from"./@babylonjscore_Misc.5aaba58d.js";import{a as Z,E as Ee,d as Et,e as L,f as N,g as Ct,U as Oe,b as Cr,h as Kt}from"./@babylonjscore_Materials.d4538583.js";import{D as Zt,S as Jt,a as xr,A as Pr}from"./@babylonjscore_States.f9db8fc7.js";import{W as Ve,A as ue,g as Br}from"./@babylonjscore_Meshes.9ddea1c8.js";import{D as $e,V as he}from"./@babylonjscore_Buffers.c351261b.js";import{_ as wr}from"./@babylonjscore_Instrumentation.094ff3ea.js";import{C as Tt}from"./@babylonjscore_Cameras.05e2a1ea.js";import{S as De}from"./@babylonjscore_scene.c0faa314.js";import{M as Fr,T as xt,F as Ur,S as Ir,d as $t,b as Pt}from"./@babylonjscore_Maths.4b8bfdd1.js";import"./@babylonjscore_ShadersWGSL.25de9c3d.js";import"./@babylonjscore_Shaders.02c89b72.js";import{C as Dr}from"./@babylonjscore_Compute.87c199bd.js";var Rt=function(){function r(){}return r.SetMatrixPrecision=function(e){if(r.MatrixTrackPrecisionChange=!1,e&&!r.MatrixUse64Bits&&r.MatrixTrackedMatrices)for(var t=0;t<r.MatrixTrackedMatrices.length;++t){var i=r.MatrixTrackedMatrices[t],n=i._m;i._m=new Array(16);for(var a=0;a<16;++a)i._m[a]=n[a]}r.MatrixUse64Bits=e,r.MatrixCurrentType=r.MatrixUse64Bits?Array:Float32Array,r.MatrixTrackedMatrices=null},r.MatrixUse64Bits=!1,r.MatrixTrackPrecisionChange=!0,r.MatrixCurrentType=Float32Array,r.MatrixTrackedMatrices=[],r}(),Re=function(){function r(){}return Object.defineProperty(r,"LastCreatedEngine",{get:function(){return this.Instances.length===0?null:this.Instances[this.Instances.length-1]},enumerable:!1,configurable:!0}),Object.defineProperty(r,"LastCreatedScene",{get:function(){return this._LastCreatedScene},enumerable:!1,configurable:!0}),r.Instances=new Array,r._LastCreatedScene=null,r.UseFallbackTexture=!0,r.FallbackTexture="",r}(),Ge=function(){function r(){this.children=[]}return r.prototype.isValid=function(e){return!0},r.prototype.process=function(e,t){var i="";if(this.line){var n=this.line,a=t.processor;if(a){if(a.lineProcessor&&(n=a.lineProcessor(n,t.isFragment,t.processingContext)),a.attributeProcessor&&this.line.startsWith("attribute"))n=a.attributeProcessor(this.line,e,t.processingContext);else if(a.varyingProcessor&&this.line.startsWith("varying"))n=a.varyingProcessor(this.line,t.isFragment,e,t.processingContext);else if(a.uniformProcessor&&a.uniformRegexp&&a.uniformRegexp.test(this.line))t.lookForClosingBracketForUniformBuffer||(n=a.uniformProcessor(this.line,t.isFragment,e,t.processingContext));else if(a.uniformBufferProcessor&&a.uniformBufferRegexp&&a.uniformBufferRegexp.test(this.line))t.lookForClosingBracketForUniformBuffer||(n=a.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0);else if(a.textureProcessor&&a.textureRegexp&&a.textureRegexp.test(this.line))n=a.textureProcessor(this.line,t.isFragment,e,t.processingContext);else if((a.uniformProcessor||a.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer){var s=/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/;s.test(this.line)?a.uniformProcessor&&(n=a.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):a.uniformBufferProcessor&&(n=a.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)}t.lookForClosingBracketForUniformBuffer&&this.line.indexOf("}")!==-1&&(t.lookForClosingBracketForUniformBuffer=!1,a.endOfUniformBufferProcessor&&(n=a.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}i+=n+`\r
`}return this.children.forEach(function(o){i+=o.process(e,t)}),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),i},r}(),Lr=function(){function r(){this._lines=[]}return Object.defineProperty(r.prototype,"currentLine",{get:function(){return this._lines[this.lineIndex]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"canRead",{get:function(){return this.lineIndex<this._lines.length-1},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"lines",{set:function(e){this._lines.length=0;for(var t=0,i=e;t<i.length;t++){var n=i[t];if(n[0]==="#"){this._lines.push(n);continue}if(n.trim().startsWith("//")){this._lines.push(n);continue}for(var a=n.split(";"),s=0;s<a.length;s++){var o=a[s];o=o.trim(),o&&this._lines.push(o+(s!==a.length-1?";":""))}}},enumerable:!1,configurable:!0}),r}(),ht=function(r){J(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e.prototype.process=function(t,i){for(var n=0;n<this.children.length;n++){var a=this.children[n];if(a.isValid(t))return a.process(t,i)}return""},e}(Ge),Mr=function(r){J(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e.prototype.isValid=function(t){return this.testExpression.isTrue(t)},e}(Ge),He=function(){function r(){}return r.prototype.isTrue=function(e){return!0},r.postfixToInfix=function(e){for(var t=[],i=0,n=e;i<n.length;i++){var a=n[i];if(r._OperatorPriority[a]===void 0)t.push(a);else{var s=t[t.length-1],o=t[t.length-2];t.length-=2,t.push("(".concat(o).concat(a).concat(s,")"))}}return t[t.length-1]},r.infixToPostfix=function(e){for(var t=[],i=-1,n=function(){l=l.trim(),l!==""&&(t.push(l),l="")},a=function(_){i<r._Stack.length-1&&(r._Stack[++i]=_)},s=function(){return r._Stack[i]},o=function(){return i===-1?"!!INVALID EXPRESSION!!":r._Stack[i--]},u=0,l="";u<e.length;){var h=e.charAt(u),c=u<e.length-1?e.substr(u,2):"";if(h==="(")l="",a(h);else if(h===")"){for(n();i!==-1&&s()!=="(";)t.push(o());o()}else if(r._OperatorPriority[c]>1){for(n();i!==-1&&r._OperatorPriority[s()]>=r._OperatorPriority[c];)t.push(o());a(c),u++}else l+=h;u++}for(n();i!==-1;)s()==="("?o():t.push(o());return t},r._OperatorPriority={")":0,"(":1,"||":2,"&&":3},r._Stack=["","","","","","","","","","","","","","","","","","","",""],r}(),qe=function(r){J(e,r);function e(t,i){i===void 0&&(i=!1);var n=r.call(this)||this;return n.define=t,n.not=i,n}return e.prototype.isTrue=function(t){var i=t[this.define]!==void 0;return this.not&&(i=!i),i},e}(He),Or=function(r){J(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e.prototype.isTrue=function(t){return this.leftOperand.isTrue(t)||this.rightOperand.isTrue(t)},e}(He),Gr=function(r){J(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e.prototype.isTrue=function(t){return this.leftOperand.isTrue(t)&&this.rightOperand.isTrue(t)},e}(He),Nr=function(r){J(e,r);function e(t,i,n){var a=r.call(this)||this;return a.define=t,a.operand=i,a.testValue=n,a}return e.prototype.isTrue=function(t){var i=t[this.define];i===void 0&&(i=this.define);var n=!1,a=parseInt(i),s=parseInt(this.testValue);switch(this.operand){case">":n=a>s;break;case"<":n=a<s;break;case"<=":n=a<=s;break;case">=":n=a>=s;break;case"==":n=a===s;break}return n},e}(He),Wr=/defined\s*?\((.+?)\)/g,ct=/defined\s*?\[(.+?)\]/g,Bt=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,$i=function(){function r(){}return r.Initialize=function(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)},r.Process=function(e,t,i,n){var a=this,s;!((s=t.processor)===null||s===void 0)&&s.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,function(o){t.processCodeAfterIncludes&&(o=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",o));var u=a._ProcessShaderConversion(o,t,n);i(u)})},r.PreProcess=function(e,t,i,n){var a=this,s;!((s=t.processor)===null||s===void 0)&&s.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,function(o){t.processCodeAfterIncludes&&(o=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",o));var u=a._ApplyPreProcessing(o,t,n);i(u)})},r.Finalize=function(e,t,i){return!i.processor||!i.processor.finalizeShaders?{vertexCode:e,fragmentCode:t}:i.processor.finalizeShaders(e,t,i.processingContext)},r._ProcessPrecision=function(e,t){var i;if(!((i=t.processor)===null||i===void 0)&&i.noPrecision)return e;var n=t.shouldUseHighPrecisionShader;return e.indexOf("precision highp float")===-1?n?e=`precision highp float;
`+e:e=`precision mediump float;
`+e:n||(e=e.replace("precision highp float","precision mediump float")),e},r._ExtractOperation=function(e){var t=/defined\((.+)\)/,i=t.exec(e);if(i&&i.length)return new qe(i[1].trim(),e[0]==="!");for(var n=["==",">=","<=","<",">"],a="",s=0,o=0,u=n;o<u.length&&(a=u[o],s=e.indexOf(a),!(s>-1));o++);if(s===-1)return new qe(e);var l=e.substring(0,s).trim(),h=e.substring(s+a.length).trim();return new Nr(l,a,h)},r._BuildSubExpression=function(e){e=e.replace(Wr,"defined[$1]");for(var t=He.infixToPostfix(e),i=[],n=0,a=t;n<a.length;n++){var s=a[n];if(s!=="||"&&s!=="&&")i.push(s);else if(i.length>=2){var o=i[i.length-1],u=i[i.length-2];i.length-=2;var l=s=="&&"?new Gr:new Or;typeof o=="string"&&(o=o.replace(ct,"defined($1)")),typeof u=="string"&&(u=u.replace(ct,"defined($1)")),l.leftOperand=typeof u=="string"?this._ExtractOperation(u):u,l.rightOperand=typeof o=="string"?this._ExtractOperation(o):o,i.push(l)}}var h=i[i.length-1];return typeof h=="string"&&(h=h.replace(ct,"defined($1)")),typeof h=="string"?this._ExtractOperation(h):h},r._BuildExpression=function(e,t){var i=new Mr,n=e.substring(0,t),a=e.substring(t);return a=a.substring(0,(a.indexOf("//")+1||a.length+1)-1).trim(),n==="#ifdef"?i.testExpression=new qe(a):n==="#ifndef"?i.testExpression=new qe(a,!0):i.testExpression=this._BuildSubExpression(a),i},r._MoveCursorWithinIf=function(e,t,i){for(var n=e.currentLine;this._MoveCursor(e,i);){n=e.currentLine;var a=n.substring(0,5).toLowerCase();if(a==="#else"){var s=new Ge;t.children.push(s),this._MoveCursor(e,s);return}else if(a==="#elif"){var o=this._BuildExpression(n,5);t.children.push(o),i=o}}},r._MoveCursor=function(e,t){for(;e.canRead;){e.lineIndex++;var i=e.currentLine,n=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/,a=n.exec(i);if(a&&a.length){var s=a[0];switch(s){case"#ifdef":{var o=new ht;t.children.push(o);var u=this._BuildExpression(i,6);o.children.push(u),this._MoveCursorWithinIf(e,o,u);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{var o=new ht;t.children.push(o);var u=this._BuildExpression(i,7);o.children.push(u),this._MoveCursorWithinIf(e,o,u);break}case"#if":{var o=new ht,u=this._BuildExpression(i,3);t.children.push(o),o.children.push(u),this._MoveCursorWithinIf(e,o,u);break}}}else{var l=new Ge;if(l.line=i,t.children.push(l),i[0]==="#"&&i[1]==="d"){var h=i.replace(";","").split(" ");l.additionalDefineKey=h[1],h.length===3&&(l.additionalDefineValue=h[2])}}}return!1},r._EvaluatePreProcessors=function(e,t,i){var n=new Ge,a=new Lr;return a.lineIndex=-1,a.lines=e.split(`
`),this._MoveCursor(a,n),n.process(t,i)},r._PreparePreProcessors=function(e,t){for(var i,n=e.defines,a={},s=0,o=n;s<o.length;s++){var u=o[s],l=u.replace("#define","").replace(";","").trim(),h=l.split(" ");a[h[0]]=h.length>1?h[1]:""}return((i=e.processor)===null||i===void 0?void 0:i.shaderLanguage)===Z.GLSL&&(a.GL_ES="true"),a.__VERSION__=e.version,a[e.platformName]="true",t._getGlobalDefines(a),a},r._ProcessShaderConversion=function(e,t,i){var n=this._ProcessPrecision(e,t);if(!t.processor)return n;if(t.processor.shaderLanguage===Z.GLSL&&n.indexOf("#version 3")!==-1)return n.replace("#version 300 es","");var a=t.defines,s=this._PreparePreProcessors(t,i);return t.processor.preProcessor&&(n=t.processor.preProcessor(n,a,t.isFragment,t.processingContext)),n=this._EvaluatePreProcessors(n,s,t),t.processor.postProcessor&&(n=t.processor.postProcessor(n,a,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(n=i.inlineShaderCode(n)),n},r._ApplyPreProcessing=function(e,t,i){var n,a,s=e,o=t.defines,u=this._PreparePreProcessors(t,i);return!((n=t.processor)===null||n===void 0)&&n.preProcessor&&(s=t.processor.preProcessor(s,o,t.isFragment,t.processingContext)),s=this._EvaluatePreProcessors(s,u,t),!((a=t.processor)===null||a===void 0)&&a.postProcessor&&(s=t.processor.postProcessor(s,o,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(s=i.inlineShaderCode(s)),s},r._ProcessIncludes=function(e,t,i){for(var n=this,a=Bt.exec(e),s=new String(e),o=!1,u=function(){var h=a[1];if(h.indexOf("__decl__")!==-1&&(h=h.replace(/__decl__/,""),t.supportsUniformBuffers&&(h=h.replace(/Vertex/,"Ubo"),h=h.replace(/Fragment/,"Ubo")),h=h+"Declaration"),t.includesShadersStore[h]){var c=t.includesShadersStore[h];if(a[2])for(var _=a[3].split(","),d=0;d<_.length;d+=2){var g=new RegExp(_[d],"g"),v=_[d+1];c=c.replace(g,v)}if(a[4]){var p=a[5];if(p.indexOf("..")!==-1){var m=p.split(".."),E=parseInt(m[0]),T=parseInt(m[1]),R=c.slice(0);c="",isNaN(T)&&(T=t.indexParameters[m[1]]);for(var y=E;y<T;y++)t.supportsUniformBuffers||(R=R.replace(/light\{X\}.(\w*)/g,function(b,x){return x+"{X}"})),c+=R.replace(/\{X\}/g,y.toString())+`
`}else t.supportsUniformBuffers||(c=c.replace(/light\{X\}.(\w*)/g,function(b,x){return x+"{X}"})),c=c.replace(/\{X\}/g,p)}s=s.replace(a[0],c),o=o||c.indexOf("#include<")>=0||c.indexOf("#include <")>=0}else{var C=t.shadersRepository+"ShadersInclude/"+h+".fx";return r._FileToolsLoadFile(C,function(b){t.includesShadersStore[h]=b,n._ProcessIncludes(s,t,i)}),{value:void 0}}a=Bt.exec(e)};a!=null;){var l=u();if(typeof l=="object")return l.value}o?this._ProcessIncludes(s.toString(),t,i):i(s)},r._FileToolsLoadFile=function(e,t,i,n,a,s){throw ve("FileTools")},r}(),en=function(){function r(){}return r.GetShadersRepository=function(e){return e===void 0&&(e=Z.GLSL),e===Z.GLSL?r.ShadersRepository:r.ShadersRepositoryWGSL},r.GetShadersStore=function(e){return e===void 0&&(e=Z.GLSL),e===Z.GLSL?r.ShadersStore:r.ShadersStoreWGSL},r.GetIncludesShadersStore=function(e){return e===void 0&&(e=Z.GLSL),e===Z.GLSL?r.IncludesShadersStore:r.IncludesShadersStoreWGSL},r.ShadersRepository="src/Shaders/",r.ShadersStore={},r.IncludesShadersStore={},r.ShadersRepositoryWGSL="src/ShadersWGSL/",r.ShadersStoreWGSL={},r.IncludesShadersStoreWGSL={},r}(),Vr=function(){function r(){this.shaderLanguage=Z.GLSL}return r.prototype.postProcessor=function(e,t,i,n,a){if(!a.getCaps().drawBuffersExtension){var s=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(s,"")}return e},r}(),er=function(){function r(){this.shaderLanguage=Z.GLSL}return r.prototype.attributeProcessor=function(e){return e.replace("attribute","in")},r.prototype.varyingProcessor=function(e,t){return e.replace("varying",t?"in":"out")},r.prototype.postProcessor=function(e,t,i){var n=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,a=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(a,""),e=e.replace(/texture2D\s*\(/g,"texture("),i)e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(n?"":`out vec4 glFragColor;
`)+"void main(");else{var s=t.indexOf("#define MULTIVIEW")!==-1;if(s)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e}return e},r}(),Xr=function(){function r(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null}return Object.defineProperty(r.prototype,"isAsync",{get:function(){return this.isParallelCompiled},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isReady",{get:function(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1},enumerable:!1,configurable:!0}),r.prototype._handlesSpectorRebuildCallback=function(e){e&&this.program&&e(this.program)},r.prototype._fillEffectInformation=function(e,t,i,n,a,s,o,u){var l=this.engine;if(l.supportsUniformBuffers)for(var h in t)e.bindUniformBlock(h,t[h]);var c=this.engine.getUniforms(this,i);c.forEach(function(m,E){n[i[E]]=m}),this._uniforms=n;var _;for(_=0;_<a.length;_++){var d=e.getUniform(a[_]);d==null&&(a.splice(_,1),_--)}a.forEach(function(m,E){s[m]=E});for(var g=0,v=l.getAttributes(this,o);g<v.length;g++){var p=v[g];u.push(p)}},r.prototype.dispose=function(){this._uniforms={}},r.prototype._cacheMatrix=function(e,t){var i=this._valueCache[e],n=t.updateFlag;return i!==void 0&&i===n?!1:(this._valueCache[e]=n,!0)},r.prototype._cacheFloat2=function(e,t,i){var n=this._valueCache[e];if(!n||n.length!==2)return n=[t,i],this._valueCache[e]=n,!0;var a=!1;return n[0]!==t&&(n[0]=t,a=!0),n[1]!==i&&(n[1]=i,a=!0),a},r.prototype._cacheFloat3=function(e,t,i,n){var a=this._valueCache[e];if(!a||a.length!==3)return a=[t,i,n],this._valueCache[e]=a,!0;var s=!1;return a[0]!==t&&(a[0]=t,s=!0),a[1]!==i&&(a[1]=i,s=!0),a[2]!==n&&(a[2]=n,s=!0),s},r.prototype._cacheFloat4=function(e,t,i,n,a){var s=this._valueCache[e];if(!s||s.length!==4)return s=[t,i,n,a],this._valueCache[e]=s,!0;var o=!1;return s[0]!==t&&(s[0]=t,o=!0),s[1]!==i&&(s[1]=i,o=!0),s[2]!==n&&(s[2]=n,o=!0),s[3]!==a&&(s[3]=a,o=!0),o},r.prototype.setInt=function(e,t){var i=this._valueCache[e];i!==void 0&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)},r.prototype.setInt2=function(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))},r.prototype.setInt3=function(e,t,i,n){this._cacheFloat3(e,t,i,n)&&(this.engine.setInt3(this._uniforms[e],t,i,n)||(this._valueCache[e]=null))},r.prototype.setInt4=function(e,t,i,n,a){this._cacheFloat4(e,t,i,n,a)&&(this.engine.setInt4(this._uniforms[e],t,i,n,a)||(this._valueCache[e]=null))},r.prototype.setIntArray=function(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)},r.prototype.setIntArray2=function(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)},r.prototype.setIntArray3=function(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)},r.prototype.setIntArray4=function(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)},r.prototype.setArray=function(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)},r.prototype.setArray2=function(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)},r.prototype.setArray3=function(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)},r.prototype.setArray4=function(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)},r.prototype.setMatrices=function(e,t){!t||(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))},r.prototype.setMatrix=function(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))},r.prototype.setMatrix3x3=function(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)},r.prototype.setMatrix2x2=function(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)},r.prototype.setFloat=function(e,t){var i=this._valueCache[e];i!==void 0&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)},r.prototype.setVector2=function(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))},r.prototype.setFloat2=function(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))},r.prototype.setVector3=function(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))},r.prototype.setFloat3=function(e,t,i,n){this._cacheFloat3(e,t,i,n)&&(this.engine.setFloat3(this._uniforms[e],t,i,n)||(this._valueCache[e]=null))},r.prototype.setVector4=function(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))},r.prototype.setQuaternion=function(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))},r.prototype.setFloat4=function(e,t,i,n,a){this._cacheFloat4(e,t,i,n,a)&&(this.engine.setFloat4(this._uniforms[e],t,i,n,a)||(this._valueCache[e]=null))},r.prototype.setColor3=function(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))},r.prototype.setColor4=function(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))},r.prototype.setDirectColor4=function(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))},r.prototype._getVertexShaderCode=function(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null},r.prototype._getFragmentShaderCode=function(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null},r}(),yt=function(){function r(e,t){if(e===void 0&&(e=null),this._MSAARenderBuffer=null,this._context=t,!e&&(e=t.createTexture(),!e))throw new Error("Unable to create webGL texture");this.set(e)}return Object.defineProperty(r.prototype,"underlyingResource",{get:function(){return this._webGLTexture},enumerable:!1,configurable:!0}),r.prototype.setUsage=function(){},r.prototype.set=function(e){this._webGLTexture=e},r.prototype.reset=function(){this._webGLTexture=null,this._MSAARenderBuffer=null},r.prototype.release=function(){this._MSAARenderBuffer&&(this._context.deleteRenderbuffer(this._MSAARenderBuffer),this._MSAARenderBuffer=null),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()},r}(),Hr=function(){function r(){}return r}(),P=function(){function r(e,t,i,n){var a=this;this._name="WebGL",this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new ee,this._frameId=0,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new ee,this.onContextRestoredObservable=new ee,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new Zt,this._stencilStateComposer=new Jt,this._stencilState=new xr,this._alphaState=new Pr,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._renderTargetWrapperCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._activeRequests=new Array,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new ee,this._isWebGPU=!1,this._snapshotRenderingMode=0,this._useExactSrgbConversions=!1,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={};var s=null;if(i=i||{},this._creationOptions=i,this.adaptToDeviceRatio=n!=null?n:!1,this._stencilStateComposer.stencilGlobal=this._stencilState,Rt.SetMatrixPrecision(!!i.useHighPrecisionMatrix),!!e){if(n=n||i.adaptToDeviceRatio||!1,e.getContext){if(s=e,this._renderingCanvas=s,t!==void 0&&(i.antialias=t),i.deterministicLockstep===void 0&&(i.deterministicLockstep=!1),i.lockstepMaxSteps===void 0&&(i.lockstepMaxSteps=4),i.timeStep===void 0&&(i.timeStep=1/60),i.preserveDrawingBuffer===void 0&&(i.preserveDrawingBuffer=!1),i.audioEngine===void 0&&(i.audioEngine=!0),i.audioEngineOptions!==void 0&&i.audioEngineOptions.audioContext!==void 0&&(this._audioContext=i.audioEngineOptions.audioContext),i.audioEngineOptions!==void 0&&i.audioEngineOptions.audioDestination!==void 0&&(this._audioDestination=i.audioEngineOptions.audioDestination),i.stencil===void 0&&(i.stencil=!0),i.premultipliedAlpha===!1&&(this.premultipliedAlpha=!1),i.xrCompatible===void 0&&(i.xrCompatible=!0),i.useExactSrgbConversions!==void 0&&(this._useExactSrgbConversions=i.useExactSrgbConversions),this._doNotHandleContextLost=!!i.doNotHandleContextLost,navigator&&navigator.userAgent){this._checkForMobile=function(){var A=navigator.userAgent;a.hostInformation.isMobile=A.indexOf("Mobile")!==-1||A.indexOf("Mac")!==-1&&dt()&&"ontouchend"in document},this._checkForMobile(),ae()&&window.addEventListener("resize",this._checkForMobile);for(var o=navigator.userAgent,u=0,l=r.ExceptionList;u<l.length;u++){var h=l[u],c=h.key,_=h.targets,d=new RegExp(c);if(d.test(o)){if(h.capture&&h.captureConstraint){var g=h.capture,v=h.captureConstraint,p=new RegExp(g),m=p.exec(o);if(m&&m.length>0){var E=parseInt(m[m.length-1]);if(E>=v)continue}}for(var T=0,R=_;T<R.length;T++){var y=R[T];switch(y){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":i.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1;break}}}}}if(this._doNotHandleContextLost||(this._onContextLost=function(A){A.preventDefault(),a._contextWasLost=!0,I.Warn("WebGL context lost."),a.onContextLostObservable.notifyObservers(a)},this._onContextRestored=function(){a._restoreEngineAfterContextLost(a._initGLContext.bind(a))},s.addEventListener("webglcontextlost",this._onContextLost,!1),s.addEventListener("webglcontextrestored",this._onContextRestored,!1),i.powerPreference="high-performance"),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._badDesktopOS&&(i.xrCompatible=!1),!i.disableWebGL2Support)try{this._gl=s.getContext("webgl2",i)||s.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch{}if(!this._gl){if(!s)throw new Error("The provided canvas is null or undefined.");try{this._gl=s.getContext("webgl",i)||s.getContext("experimental-webgl",i)}catch{throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";var C=this._gl.getContextAttributes();C&&(i.stencil=C.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),i.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats);var b=ae()&&window.devicePixelRatio||1,x=i.limitDeviceRatio||b;this._hardwareScalingLevel=n?1/Math.min(x,b):1,this._lastDevicePixelRatio=b,this.resize(),this._isStencilEnable=!!i.stencil,this._initGLContext(),this._initFeatures();for(var S=0;S<this._caps.maxVertexAttribs;S++)this._currentBufferPointers[S]=new Hr;this._shaderProcessor=this.webGLVersion>1?new er:new Vr,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);var w="Babylon.js v".concat(r.Version);console.log(w+" - ".concat(this.description)),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",w)}}return Object.defineProperty(r,"NpmPackage",{get:function(){return"babylonjs@5.21.0"},enumerable:!1,configurable:!0}),Object.defineProperty(r,"Version",{get:function(){return"5.21.0"},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"description",{get:function(){var e=this.name+this.webGLVersion;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"name",{get:function(){return this._name},set:function(e){this._name=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"version",{get:function(){return this._webGLVersion},enumerable:!1,configurable:!0}),Object.defineProperty(r,"ShadersRepository",{get:function(){return Ee.ShadersRepository},set:function(e){Ee.ShadersRepository=e},enumerable:!1,configurable:!0}),r.prototype._getShaderProcessor=function(e){return this._shaderProcessor},Object.defineProperty(r.prototype,"useReverseDepthBuffer",{get:function(){return this._useReverseDepthBuffer},set:function(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,e?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"frameId",{get:function(){return this._frameId},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"supportsUniformBuffers",{get:function(){return this.webGLVersion>1&&!this.disableUniformBuffers},enumerable:!1,configurable:!0}),r.prototype.getCreationOptions=function(){return this._creationOptions},Object.defineProperty(r.prototype,"_shouldUseHighPrecisionShader",{get:function(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"needPOTTextures",{get:function(){return this._webGLVersion<2||this.forcePOTTextures},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"activeRenderLoops",{get:function(){return this._activeRenderLoops},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"doNotHandleContextLost",{get:function(){return this._doNotHandleContextLost},set:function(e){this._doNotHandleContextLost=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"_supportsHardwareTextureRescaling",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"framebufferDimensionsObject",{set:function(e){this._framebufferDimensionsObject=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"currentViewport",{get:function(){return this._cachedViewport},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"emptyTexture",{get:function(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"emptyTexture3D",{get:function(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"emptyTexture2DArray",{get:function(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"emptyCubeTexture",{get:function(){if(!this._emptyCubeTexture){var e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isWebGPU",{get:function(){return this._isWebGPU},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"shaderPlatformName",{get:function(){return this._shaderPlatformName},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"snapshotRendering",{get:function(){return!1},set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"snapshotRenderingMode",{get:function(){return this._snapshotRenderingMode},set:function(e){this._snapshotRenderingMode=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"useExactSrgbConversions",{get:function(){return this._useExactSrgbConversions},enumerable:!1,configurable:!0}),r.prototype.snapshotRenderingReset=function(){this.snapshotRendering=!1},r._CreateCanvas=function(e,t){if(typeof document=="undefined")return new OffscreenCanvas(e,t);var i=document.createElement("canvas");return i.width=e,i.height=t,i},r.prototype.createCanvas=function(e,t){return r._CreateCanvas(e,t)},r.prototype.createCanvasImage=function(){return document.createElement("img")},r.prototype._restoreEngineAfterContextLost=function(e){var t=this;setTimeout(function(){return we(t,void 0,void 0,function(){var i,n,a,s,o;return Fe(this,function(u){switch(u.label){case 0:return this._dummyFramebuffer=null,i=this._depthCullingState.depthTest,n=this._depthCullingState.depthFunc,a=this._depthCullingState.depthMask,s=this._stencilState.stencilTest,[4,e()];case 1:return u.sent(),this._rebuildEffects(),(o=this._rebuildComputeEffects)===null||o===void 0||o.call(this),this._rebuildInternalTextures(),this._rebuildRenderTargetWrappers(),this._rebuildBuffers(),this.wipeCaches(!0),this._depthCullingState.depthTest=i,this._depthCullingState.depthFunc=n,this._depthCullingState.depthMask=a,this._stencilState.stencilTest=s,I.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1,[2]}})})},0)},r.prototype._sharedInit=function(e,t,i){this._renderingCanvas=e},r.prototype._getShaderProcessingContext=function(e){return null},r.prototype._rebuildInternalTextures=function(){for(var e=this._internalTexturesCache.slice(),t=0,i=e;t<i.length;t++){var n=i[t];n._rebuild()}},r.prototype._rebuildRenderTargetWrappers=function(){for(var e=this._renderTargetWrapperCache.slice(),t=0,i=e;t<i.length;t++){var n=i[t];n._rebuild()}},r.prototype._rebuildEffects=function(){for(var e in this._compiledEffects){var t=this._compiledEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}Ee.ResetCache()},r.prototype.areAllEffectsReady=function(){for(var e in this._compiledEffects){var t=this._compiledEffects[e];if(!t.isReady())return!1}return!0},r.prototype._rebuildBuffers=function(){for(var e=0,t=this._uniformBuffers;e<t.length;e++){var i=t[e];i._rebuild()}for(var n=0,a=this._storageBuffers;n<a.length;n++){var s=a[n];s._rebuild()}},r.prototype._initGLContext=function(){var e;this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null,maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?256:128},this._glVersion=this._gl.getParameter(this._gl.VERSION);var t=this._gl.getExtension("WEBGL_debug_renderer_info");if(t!=null&&(this._glRenderer=this._gl.getParameter(t.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(t.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=((e=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT))!==null&&e!==void 0?e:0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride!==null?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES);else{var i=this._gl.getExtension("WEBGL_draw_buffers");if(i!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=i.drawBuffersWEBGL.bind(i),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(var n=0;n<16;n++)this._gl["COLOR_ATTACHMENT"+n+"_WEBGL"]=i["COLOR_ATTACHMENT"+n+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{var a=this._gl.getExtension("WEBGL_depth_texture");a!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=a.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{var s=this._gl.getExtension("OES_vertex_array_object");s!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=s.createVertexArrayOES.bind(s),this._gl.bindVertexArray=s.bindVertexArrayOES.bind(s),this._gl.deleteVertexArray=s.deleteVertexArrayOES.bind(s))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{var o=this._gl.getExtension("ANGLE_instanced_arrays");o!=null?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=o.drawArraysInstancedANGLE.bind(o),this._gl.drawElementsInstanced=o.drawElementsInstancedANGLE.bind(o),this._gl.vertexAttribDivisor=o.vertexAttribDivisorANGLE.bind(o)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){var u=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),l=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);u&&l&&(this._caps.highPrecisionShaderSupported=u.precision!==0&&l.precision!==0)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{var h=this._gl.getExtension("EXT_blend_minmax");h!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=h.MAX_EXT,this._gl.MIN=h.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0;else{var c=this._gl.getExtension("EXT_sRGB");c!=null&&(this._caps.supportSRGBBuffers=!0,this._gl.SRGB=c.SRGB_EXT,this._gl.SRGB8=c.SRGB_ALPHA_EXT,this._gl.SRGB8_ALPHA8=c.SRGB_ALPHA_EXT)}this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!!(this._creationOptions&&this._creationOptions.forceSRGBBufferSupportState)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(var _=0;_<this._maxSimultaneousTextures;_++)this._nextFreeTextureSlots.push(_)},r.prototype._initFeatures=function(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}},Object.defineProperty(r.prototype,"webGLVersion",{get:function(){return this._webGLVersion},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"ThinEngine"},Object.defineProperty(r.prototype,"isStencilEnable",{get:function(){return this._isStencilEnable},enumerable:!1,configurable:!0}),r.prototype._prepareWorkingCanvas=function(){if(!this._workingCanvas){this._workingCanvas=this.createCanvas(1,1);var e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}},r.prototype.resetTextureCache=function(){for(var e in this._boundTexturesCache)!Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)||(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1},r.prototype.getInfo=function(){return this.getGlInfo()},r.prototype.getGlInfo=function(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}},r.prototype.setHardwareScalingLevel=function(e){this._hardwareScalingLevel=e,this.resize()},r.prototype.getHardwareScalingLevel=function(){return this._hardwareScalingLevel},r.prototype.getLoadedTexturesCache=function(){return this._internalTexturesCache},r.prototype.getCaps=function(){return this._caps},r.prototype.stopRenderLoop=function(e){if(!e){this._activeRenderLoops=[];return}var t=this._activeRenderLoops.indexOf(e);t>=0&&this._activeRenderLoops.splice(t,1)},r.prototype._renderLoop=function(){if(!this._contextWasLost){var e=!0;if(!this.renderEvenInBackground&&this._windowIsBackground&&(e=!1),e){this.beginFrame();for(var t=0;t<this._activeRenderLoops.length;t++){var i=this._activeRenderLoops[t];i()}this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1},r.prototype.getRenderingCanvas=function(){return this._renderingCanvas},r.prototype.getAudioContext=function(){return this._audioContext},r.prototype.getAudioDestination=function(){return this._audioDestination},r.prototype.getHostWindow=function(){return ae()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null},r.prototype.getRenderWidth=function(e){return e===void 0&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth},r.prototype.getRenderHeight=function(e){return e===void 0&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight},r.prototype._queueNewFrame=function(e,t){return r.QueueNewFrame(e,t)},r.prototype.runRenderLoop=function(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=this._renderLoop.bind(this),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))},r.prototype.clear=function(e,t,i,n){n===void 0&&(n=!1);var a=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=a;var s=0;t&&e&&(this._gl.clearColor(e.r,e.g,e.b,e.a!==void 0?e.a:1),s|=this._gl.COLOR_BUFFER_BIT),i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),s|=this._gl.DEPTH_BUFFER_BIT),n&&(this._gl.clearStencil(0),s|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(s)},r.prototype._viewport=function(e,t,i,n){(e!==this._viewportCached.x||t!==this._viewportCached.y||i!==this._viewportCached.z||n!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=n,this._gl.viewport(e,t,i,n))},r.prototype.setViewport=function(e,t,i){var n=t||this.getRenderWidth(),a=i||this.getRenderHeight(),s=e.x||0,o=e.y||0;this._cachedViewport=e,this._viewport(s*n,o*a,n*e.width,a*e.height)},r.prototype.beginFrame=function(){},r.prototype.endFrame=function(){this._badOS&&this.flushFramebuffer(),this._frameId++},r.prototype.resize=function(e){e===void 0&&(e=!1);var t,i;if(this.adaptToDeviceRatio){var n=ae()&&window.devicePixelRatio||1,a=this._lastDevicePixelRatio/n;this._lastDevicePixelRatio=n,this._hardwareScalingLevel*=a}ae()?(t=this._renderingCanvas?this._renderingCanvas.clientWidth||this._renderingCanvas.width:window.innerWidth,i=this._renderingCanvas?this._renderingCanvas.clientHeight||this._renderingCanvas.height:window.innerHeight):(t=this._renderingCanvas?this._renderingCanvas.width:100,i=this._renderingCanvas?this._renderingCanvas.height:100),this.setSize(t/this._hardwareScalingLevel,i/this._hardwareScalingLevel,e)},r.prototype.setSize=function(e,t,i){return i===void 0&&(i=!1),!this._renderingCanvas||(e=e|0,t=t|0,!i&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t)?!1:(this._renderingCanvas.width=e,this._renderingCanvas.height=t,!0)},r.prototype.bindFramebuffer=function(e,t,i,n,a,s,o){var u,l,h,c,_;t===void 0&&(t=0),s===void 0&&(s=0),o===void 0&&(o=0);var d=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(d._MSAAFramebuffer?d._MSAAFramebuffer:d._framebuffer);var g=this._gl;e.is2DArray?g.framebufferTextureLayer(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,(u=e.texture._hardwareTexture)===null||u===void 0?void 0:u.underlyingResource,s,o):e.isCube&&g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_CUBE_MAP_POSITIVE_X+t,(l=e.texture._hardwareTexture)===null||l===void 0?void 0:l.underlyingResource,s);var v=e._depthStencilTexture;if(v){var p=e._depthStencilTextureWithStencil?g.DEPTH_STENCIL_ATTACHMENT:g.DEPTH_ATTACHMENT;e.is2DArray?g.framebufferTextureLayer(g.FRAMEBUFFER,p,(h=v._hardwareTexture)===null||h===void 0?void 0:h.underlyingResource,s,o):e.isCube?g.framebufferTexture2D(g.FRAMEBUFFER,p,g.TEXTURE_CUBE_MAP_POSITIVE_X+t,(c=v._hardwareTexture)===null||c===void 0?void 0:c.underlyingResource,s):g.framebufferTexture2D(g.FRAMEBUFFER,p,g.TEXTURE_2D,(_=v._hardwareTexture)===null||_===void 0?void 0:_.underlyingResource,s)}this._cachedViewport&&!a?this.setViewport(this._cachedViewport,i,n):(i||(i=e.width,s&&(i=i/Math.pow(2,s))),n||(n=e.height,s&&(n=n/Math.pow(2,s))),this._viewport(0,0,i,n)),this.wipeCaches()},r.prototype.setState=function(e,t,i,n,a,s,o){var u,l;t===void 0&&(t=0),n===void 0&&(n=!1),o===void 0&&(o=0),(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e);var h=!((l=(u=this.cullBackFaces)!==null&&u!==void 0?u:a)!==null&&l!==void 0)||l?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==h||i)&&(this._depthCullingState.cullFace=h),this.setZOffset(t),this.setZOffsetUnits(o);var c=n?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==c||i)&&(this._depthCullingState.frontFace=c),this._stencilStateComposer.stencilMaterial=s},r.prototype.getDepthBuffer=function(){return this._depthCullingState.depthTest},r.prototype.setDepthBuffer=function(e){this._depthCullingState.depthTest=e},r.prototype.setZOffset=function(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e},r.prototype.getZOffset=function(){var e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e},r.prototype.setZOffsetUnits=function(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e},r.prototype.getZOffsetUnits=function(){var e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e},r.prototype._bindUnboundFramebuffer=function(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)},r.prototype._currentFrameBufferIsDefaultFrameBuffer=function(){return this._currentFramebuffer===null},r.prototype.generateMipmaps=function(e){this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)},r.prototype.unBindFramebuffer=function(e,t,i){var n;t===void 0&&(t=!1);var a=e;this._currentRenderTarget=null;var s=this._gl;if(a._MSAAFramebuffer){if(e.isMulti){this.unBindMultiColorAttachmentFramebuffer(e,t,i);return}s.bindFramebuffer(s.READ_FRAMEBUFFER,a._MSAAFramebuffer),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,a._framebuffer),s.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,s.COLOR_BUFFER_BIT,s.NEAREST)}((n=e.texture)===null||n===void 0?void 0:n.generateMipMaps)&&!t&&!e.isCube&&this.generateMipmaps(e.texture),i&&(a._MSAAFramebuffer&&this._bindUnboundFramebuffer(a._framebuffer),i()),this._bindUnboundFramebuffer(null)},r.prototype.flushFramebuffer=function(){this._gl.flush()},r.prototype.restoreDefaultFramebuffer=function(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()},r.prototype._resetVertexBufferBinding=function(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null},r.prototype.createVertexBuffer=function(e){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)},r.prototype._createVertexBuffer=function(e,t){var i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");var n=new Ve(i);return this.bindArrayBuffer(n),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),this._resetVertexBufferBinding(),n.references=1,n},r.prototype.createDynamicVertexBuffer=function(e){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)},r.prototype._resetIndexBufferBinding=function(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null},r.prototype.createIndexBuffer=function(e,t){var i=this._gl.createBuffer(),n=new Ve(i);if(!i)throw new Error("Unable to create index buffer");this.bindIndexBuffer(n);var a=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,a,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),n.references=1,n.is32Bits=a.BYTES_PER_ELEMENT===4,n},r.prototype._normalizeIndexData=function(e){var t=e.BYTES_PER_ELEMENT;if(t===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(var i=0;i<e.length;i++)if(e[i]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)},r.prototype.bindArrayBuffer=function(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)},r.prototype.bindUniformBlock=function(e,t,i){var n=e.program,a=this._gl.getUniformBlockIndex(n,t);this._gl.uniformBlockBinding(n,a,i)},r.prototype.bindIndexBuffer=function(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)},r.prototype._bindBuffer=function(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)},r.prototype.updateArrayBuffer=function(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)},r.prototype._vertexAttribPointer=function(e,t,i,n,a,s,o){var u=this._currentBufferPointers[t];if(!!u){var l=!1;u.active?(u.buffer!==e&&(u.buffer=e,l=!0),u.size!==i&&(u.size=i,l=!0),u.type!==n&&(u.type=n,l=!0),u.normalized!==a&&(u.normalized=a,l=!0),u.stride!==s&&(u.stride=s,l=!0),u.offset!==o&&(u.offset=o,l=!0)):(l=!0,u.active=!0,u.index=t,u.size=i,u.type=n,u.normalized=a,u.stride=s,u.offset=o,u.buffer=e),(l||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),n===this._gl.UNSIGNED_INT||n===this._gl.INT?this._gl.vertexAttribIPointer(t,i,n,s,o):this._gl.vertexAttribPointer(t,i,n,a,s,o))}},r.prototype._bindIndexBufferWithCache=function(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)},r.prototype._bindVertexBuffersAttributes=function(e,t,i){var n=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(var a=0;a<n.length;a++){var s=t.getAttributeLocation(a);if(s>=0){var o=n[a],u=null;if(i&&(u=i[o]),u||(u=e[o]),!u)continue;this._gl.enableVertexAttribArray(s),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[s]=!0);var l=u.getBuffer();l&&(this._vertexAttribPointer(l,s,u.getSize(),u.type,u.normalized,u.byteStride,u.byteOffset),u.getIsInstanced()&&(this._gl.vertexAttribDivisor(s,u.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(s),this._currentInstanceBuffers.push(l))))}}},r.prototype.recordVertexArrayObject=function(e,t,i,n){var a=this._gl.createVertexArray();if(!a)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(a),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i,n),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),a},r.prototype.bindVertexArrayObject=function(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=t!=null&&t.is32Bits,this._mustWipeVertexAttributes=!0)},r.prototype.bindBuffersDirectly=function(e,t,i,n,a){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==a){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=a;var s=a.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();for(var o=0,u=0;u<s;u++)if(u<i.length){var l=a.getAttributeLocation(u);l>=0&&(this._gl.enableVertexAttribArray(l),this._vertexAttribArraysEnabled[l]=!0,this._vertexAttribPointer(e,l,i[u],this._gl.FLOAT,!1,n,o)),o+=i[u]*4}}this._bindIndexBufferWithCache(t)},r.prototype._unbindVertexArrayObject=function(){!this._cachedVertexArrayObject||(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))},r.prototype.bindBuffers=function(e,t,i,n){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==i)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,n)),this._bindIndexBufferWithCache(t)},r.prototype.unbindInstanceAttributes=function(){for(var e,t=0,i=this._currentInstanceLocations.length;t<i;t++){var n=this._currentInstanceBuffers[t];e!=n&&n.references&&(e=n,this.bindArrayBuffer(n));var a=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(a,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0},r.prototype.releaseVertexArrayObject=function(e){this._gl.deleteVertexArray(e)},r.prototype._releaseBuffer=function(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1},r.prototype._deleteBuffer=function(e){this._gl.deleteBuffer(e.underlyingResource)},r.prototype.updateAndBindInstancesBuffer=function(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),i[0].index!==void 0)this.bindInstancesBuffer(e,i,!0);else for(var n=0;n<4;n++){var a=i[n];this._vertexAttribArraysEnabled[a]||(this._gl.enableVertexAttribArray(a),this._vertexAttribArraysEnabled[a]=!0),this._vertexAttribPointer(e,a,4,this._gl.FLOAT,!1,64,n*16),this._gl.vertexAttribDivisor(a,1),this._currentInstanceLocations.push(a),this._currentInstanceBuffers.push(e)}},r.prototype.bindInstancesBuffer=function(e,t,i){i===void 0&&(i=!0),this.bindArrayBuffer(e);var n=0;if(i)for(var a=0;a<t.length;a++){var s=t[a];n+=s.attributeSize*4}for(var a=0;a<t.length;a++){var s=t[a];s.index===void 0&&(s.index=this._currentEffect.getAttributeLocationByName(s.attributeName)),!(s.index<0)&&(this._vertexAttribArraysEnabled[s.index]||(this._gl.enableVertexAttribArray(s.index),this._vertexAttribArraysEnabled[s.index]=!0),this._vertexAttribPointer(e,s.index,s.attributeSize,s.attributeType||this._gl.FLOAT,s.normalized||!1,n,s.offset),this._gl.vertexAttribDivisor(s.index,s.divisor===void 0?1:s.divisor),this._currentInstanceLocations.push(s.index),this._currentInstanceBuffers.push(e))}},r.prototype.disableInstanceAttributeByName=function(e){if(!!this._currentEffect){var t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}},r.prototype.disableInstanceAttribute=function(e){for(var t=!1,i;(i=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(i,1),this._currentInstanceBuffers.splice(i,1),t=!0,i=this._currentInstanceLocations.indexOf(e);t&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))},r.prototype.disableAttributeByIndex=function(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1},r.prototype.draw=function(e,t,i,n){this.drawElementsType(e?0:1,t,i,n)},r.prototype.drawPointClouds=function(e,t,i){this.drawArraysType(2,e,t,i)},r.prototype.drawUnIndexed=function(e,t,i,n){this.drawArraysType(e?0:1,t,i,n)},r.prototype.drawElementsType=function(e,t,i,n){this.applyStates(),this._reportDrawCall();var a=this._drawMode(e),s=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,o=this._uintIndicesCurrentlySet?4:2;n?this._gl.drawElementsInstanced(a,i,s,t*o,n):this._gl.drawElements(a,i,s,t*o)},r.prototype.drawArraysType=function(e,t,i,n){this.applyStates(),this._reportDrawCall();var a=this._drawMode(e);n?this._gl.drawArraysInstanced(a,t,i,n):this._gl.drawArrays(a,t,i)},r.prototype._drawMode=function(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}},r.prototype._reportDrawCall=function(){},r.prototype._releaseEffect=function(e){if(this._compiledEffects[e._key]){delete this._compiledEffects[e._key];var t=e.getPipelineContext();t&&this._deletePipelineContext(t)}},r.prototype._deletePipelineContext=function(e){var t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(t.program))},r.prototype._getGlobalDefines=function(e){if(e){this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS;return}else{var t="";return this.isNDCHalfZRange&&(t+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(t&&(t+=`
`),t+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(t&&(t+=`
`),t+="#define USE_EXACT_SRGB_CONVERSIONS"),t}},r.prototype.createEffect=function(e,t,i,n,a,s,o,u,l,h){var c;h===void 0&&(h=Z.GLSL);var _=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,d=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,g=this._getGlobalDefines(),v=(c=a!=null?a:t.defines)!==null&&c!==void 0?c:"";g&&(v+=g);var p=_+"+"+d+"@"+v;if(this._compiledEffects[p]){var m=this._compiledEffects[p];return o&&m.isReady()&&o(m),m}var E=new Ee(e,t,i,n,this,a,s,o,u,l,p,h);return this._compiledEffects[p]=E,E},r._ConcatenateShader=function(e,t,i){return i===void 0&&(i=""),i+(t?t+`
`:"")+e},r.prototype._compileShader=function(e,t,i,n){return this._compileRawShader(r._ConcatenateShader(e,i,n),t)},r.prototype._compileRawShader=function(e,t){var i=this._gl,n=i.createShader(t==="vertex"?i.VERTEX_SHADER:i.FRAGMENT_SHADER);if(!n){for(var a=i.NO_ERROR,s=i.NO_ERROR;(s=i.getError())!==i.NO_ERROR;)a=s;throw new Error("Something went wrong while creating a gl ".concat(t," shader object. gl error=").concat(a,", gl isContextLost=").concat(i.isContextLost(),", _contextWasLost=").concat(this._contextWasLost))}return i.shaderSource(n,e),i.compileShader(n),n},r.prototype._getShaderSource=function(e){return this._gl.getShaderSource(e)},r.prototype.createRawShaderProgram=function(e,t,i,n,a){a===void 0&&(a=null),n=n||this._gl;var s=this._compileRawShader(t,"vertex"),o=this._compileRawShader(i,"fragment");return this._createShaderProgram(e,s,o,n,a)},r.prototype.createShaderProgram=function(e,t,i,n,a,s){s===void 0&&(s=null),a=a||this._gl;var o=this._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:"",u=this._compileShader(t,"vertex",n,o),l=this._compileShader(i,"fragment",n,o);return this._createShaderProgram(e,u,l,a,s)},r.prototype.inlineShaderCode=function(e){return e},r.prototype.createPipelineContext=function(e){var t=new Xr;return t.engine=this,this._caps.parallelShaderCompile&&(t.isParallelCompiled=!0),t},r.prototype.createMaterialContext=function(){},r.prototype.createDrawContext=function(){},r.prototype._createShaderProgram=function(e,t,i,n,a){var s=n.createProgram();if(e.program=s,!s)throw new Error("Unable to create program");return n.attachShader(s,t),n.attachShader(s,i),n.linkProgram(s),e.context=n,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),s},r.prototype._finalizePipelineContext=function(e){var t=e.context,i=e.vertexShader,n=e.fragmentShader,a=e.program,s=t.getProgramParameter(a,t.LINK_STATUS);if(!s){if(!this._gl.getShaderParameter(i,this._gl.COMPILE_STATUS)){var o=this._gl.getShaderInfoLog(i);if(o)throw e.vertexCompilationError=o,new Error("VERTEX SHADER "+o)}if(!this._gl.getShaderParameter(n,this._gl.COMPILE_STATUS)){var o=this._gl.getShaderInfoLog(n);if(o)throw e.fragmentCompilationError=o,new Error("FRAGMENT SHADER "+o)}var u=t.getProgramInfoLog(a);if(u)throw e.programLinkError=u,new Error(u)}if(this.validateShaderPrograms){t.validateProgram(a);var l=t.getProgramParameter(a,t.VALIDATE_STATUS);if(!l){var u=t.getProgramInfoLog(a);if(u)throw e.programValidationError=u,new Error(u)}}t.deleteShader(i),t.deleteShader(n),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)},r.prototype._preparePipelineContext=function(e,t,i,n,a,s,o,u,l,h){var c=e;n?c.program=this.createRawShaderProgram(c,t,i,void 0,l):c.program=this.createShaderProgram(c,t,i,u,void 0,l),c.program.__SPECTOR_rebuildProgram=o},r.prototype._isRenderingStateCompiled=function(e){var t=e;return this._gl.getProgramParameter(t.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)?(this._finalizePipelineContext(t),!0):!1},r.prototype._executeWhenRenderingStateIsCompiled=function(e,t){var i=e;if(!i.isParallelCompiled){t();return}var n=i.onCompiled;n?i.onCompiled=function(){n(),t()}:i.onCompiled=t},r.prototype.getUniforms=function(e,t){for(var i=new Array,n=e,a=0;a<t.length;a++)i.push(this._gl.getUniformLocation(n.program,t[a]));return i},r.prototype.getAttributes=function(e,t){for(var i=[],n=e,a=0;a<t.length;a++)try{i.push(this._gl.getAttribLocation(n.program,t[a]))}catch{i.push(-1)}return i},r.prototype.enableEffect=function(e){e=e!==null&&Et.IsWrapper(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,e=e,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))},r.prototype.setInt=function(e,t){return e?(this._gl.uniform1i(e,t),!0):!1},r.prototype.setInt2=function(e,t,i){return e?(this._gl.uniform2i(e,t,i),!0):!1},r.prototype.setInt3=function(e,t,i,n){return e?(this._gl.uniform3i(e,t,i,n),!0):!1},r.prototype.setInt4=function(e,t,i,n,a){return e?(this._gl.uniform4i(e,t,i,n,a),!0):!1},r.prototype.setIntArray=function(e,t){return e?(this._gl.uniform1iv(e,t),!0):!1},r.prototype.setIntArray2=function(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2iv(e,t),!0)},r.prototype.setIntArray3=function(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3iv(e,t),!0)},r.prototype.setIntArray4=function(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4iv(e,t),!0)},r.prototype.setArray=function(e,t){return!e||t.length<1?!1:(this._gl.uniform1fv(e,t),!0)},r.prototype.setArray2=function(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2fv(e,t),!0)},r.prototype.setArray3=function(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3fv(e,t),!0)},r.prototype.setArray4=function(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4fv(e,t),!0)},r.prototype.setMatrices=function(e,t){return e?(this._gl.uniformMatrix4fv(e,!1,t),!0):!1},r.prototype.setMatrix3x3=function(e,t){return e?(this._gl.uniformMatrix3fv(e,!1,t),!0):!1},r.prototype.setMatrix2x2=function(e,t){return e?(this._gl.uniformMatrix2fv(e,!1,t),!0):!1},r.prototype.setFloat=function(e,t){return e?(this._gl.uniform1f(e,t),!0):!1},r.prototype.setFloat2=function(e,t,i){return e?(this._gl.uniform2f(e,t,i),!0):!1},r.prototype.setFloat3=function(e,t,i,n){return e?(this._gl.uniform3f(e,t,i,n),!0):!1},r.prototype.setFloat4=function(e,t,i,n,a){return e?(this._gl.uniform4f(e,t,i,n,a),!0):!1},r.prototype.applyStates=function(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;var e=this._colorWrite;this._gl.colorMask(e,e,e,e)}},r.prototype.setColorWrite=function(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)},r.prototype.getColorWrite=function(){return this._colorWrite},Object.defineProperty(r.prototype,"depthCullingState",{get:function(){return this._depthCullingState},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"alphaState",{get:function(){return this._alphaState},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"stencilState",{get:function(){return this._stencilState},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"stencilStateComposer",{get:function(){return this._stencilStateComposer},enumerable:!1,configurable:!0}),r.prototype.clearInternalTexturesCache=function(){this._internalTexturesCache.length=0},r.prototype.wipeCaches=function(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))},r.prototype._getSamplingParameters=function(e,t){var i=this._gl,n=i.NEAREST,a=i.NEAREST;switch(e){case 11:n=i.LINEAR,t?a=i.LINEAR_MIPMAP_NEAREST:a=i.LINEAR;break;case 3:n=i.LINEAR,t?a=i.LINEAR_MIPMAP_LINEAR:a=i.LINEAR;break;case 8:n=i.NEAREST,t?a=i.NEAREST_MIPMAP_LINEAR:a=i.NEAREST;break;case 4:n=i.NEAREST,t?a=i.NEAREST_MIPMAP_NEAREST:a=i.NEAREST;break;case 5:n=i.NEAREST,t?a=i.LINEAR_MIPMAP_NEAREST:a=i.LINEAR;break;case 6:n=i.NEAREST,t?a=i.LINEAR_MIPMAP_LINEAR:a=i.LINEAR;break;case 7:n=i.NEAREST,a=i.LINEAR;break;case 1:n=i.NEAREST,a=i.NEAREST;break;case 9:n=i.LINEAR,t?a=i.NEAREST_MIPMAP_NEAREST:a=i.NEAREST;break;case 10:n=i.LINEAR,t?a=i.NEAREST_MIPMAP_LINEAR:a=i.NEAREST;break;case 2:n=i.LINEAR,a=i.LINEAR;break;case 12:n=i.LINEAR,a=i.NEAREST;break}return{min:a,mag:n}},r.prototype._createTexture=function(){var e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e},r.prototype._createHardwareTexture=function(){return new yt(this._createTexture(),this._gl)},r.prototype._createInternalTexture=function(e,t,i,n){n===void 0&&(n=L.Unknown);var a={};t!==void 0&&typeof t=="object"?(a.generateMipMaps=t.generateMipMaps,a.type=t.type===void 0?0:t.type,a.samplingMode=t.samplingMode===void 0?3:t.samplingMode,a.format=t.format===void 0?5:t.format,a.useSRGBBuffer=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer):(a.generateMipMaps=t,a.type=0,a.samplingMode=3,a.format=5,a.useSRGBBuffer=!1),a.useSRGBBuffer=a.useSRGBBuffer&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU),(a.type===1&&!this._caps.textureFloatLinearFiltering||a.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(a.samplingMode=1),a.type===1&&!this._caps.textureFloat&&(a.type=0,I.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));var s=this._gl,o=new N(this,n);o._useSRGBBuffer=!!a.useSRGBBuffer;var u=e.width||e,l=e.height||e,h=e.layers||0,c=this._getSamplingParameters(a.samplingMode,!!a.generateMipMaps),_=h!==0?s.TEXTURE_2D_ARRAY:s.TEXTURE_2D,d=this._getRGBABufferInternalSizedFormat(a.type,a.format,a.useSRGBBuffer),g=this._getInternalFormat(a.format),v=this._getWebGLTextureType(a.type);return this._bindTextureDirectly(_,o),h!==0?(o.is2DArray=!0,s.texImage3D(_,0,d,u,l,h,0,g,v,null)):s.texImage2D(_,0,d,u,l,0,g,v,null),s.texParameteri(_,s.TEXTURE_MAG_FILTER,c.mag),s.texParameteri(_,s.TEXTURE_MIN_FILTER,c.min),s.texParameteri(_,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(_,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),a.generateMipMaps&&this._gl.generateMipmap(_),this._bindTextureDirectly(_,null),o.baseWidth=u,o.baseHeight=l,o.width=u,o.height=l,o.depth=h,o.isReady=!0,o.samples=1,o.generateMipMaps=!!a.generateMipMaps,o.samplingMode=a.samplingMode,o.type=a.type,o.format=a.format,this._internalTexturesCache.push(o),o},r.prototype._getUseSRGBBuffer=function(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||t)},r.prototype._createTextureBase=function(e,t,i,n,a,s,o,u,l,h,c,_,d,g,v,p){var m=this;a===void 0&&(a=3),s===void 0&&(s=null),o===void 0&&(o=null),h===void 0&&(h=null),c===void 0&&(c=null),_===void 0&&(_=null),d===void 0&&(d=null),e=e||"";var E=e.substr(0,5)==="data:",T=e.substr(0,5)==="blob:",R=E&&e.indexOf(";base64,")!==-1,y=c||new N(this,L.Url),C=e;this._transformTextureUrl&&!R&&!c&&!h&&(e=this._transformTextureUrl(e)),C!==e&&(y._originalUrl=C);var b=e.lastIndexOf("."),x=d||(b>-1?e.substring(b).toLowerCase():""),S=null,w=x.indexOf("?");w>-1&&(x=x.split("?")[0]);for(var A=0,U=r._TextureLoaders;A<U.length;A++){var M=U[A];if(M.canLoad(x,g)){S=M;break}}n&&n.addPendingData(y),y.url=e,y.generateMipMaps=!t,y.samplingMode=a,y.invertY=i,y._useSRGBBuffer=this._getUseSRGBBuffer(!!p,t),this._doNotHandleContextLost||(y._buffer=h);var q=null;s&&!c&&(q=y.onLoadedObservable.add(s)),c||this._internalTexturesCache.push(y);var G=function(H,Y){n&&n.removePendingData(y),e===C?(q&&y.onLoadedObservable.remove(q),Re.UseFallbackTexture&&m._createTextureBase(Re.FallbackTexture,t,y.invertY,n,a,null,o,u,l,h,y),H=(H||"Unknown error")+(Re.UseFallbackTexture?" - Fallback texture was used":""),y.onErrorObservable.notifyObservers({message:H,exception:Y}),o&&o(H,Y)):(I.Warn("Failed to load ".concat(e,", falling back to ").concat(C)),m._createTextureBase(C,t,y.invertY,n,a,s,o,u,l,h,y,_,d,g,v,p))};if(S){var O=function(H){S.loadData(H,y,function(Y,me,re,$,Ye,Pe){Pe?G("TextureLoader failed to load data"):u(y,x,n,{width:Y,height:me},y.invertY,!re,$,function(){return Ye(),!1},a)},v)};h?h instanceof ArrayBuffer?O(new Uint8Array(h)):ArrayBuffer.isView(h)?O(h):o&&o("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,function(H){return O(new Uint8Array(H))},void 0,n?n.offlineProvider:void 0,!0,function(H,Y){G("Unable to load "+(H&&H.responseURL,Y))})}else{var j=function(H){T&&!m._doNotHandleContextLost&&(y._buffer=H),u(y,x,n,H,y.invertY,t,!1,l,a)};!E||R?h&&(typeof h.decoding=="string"||h.close)?j(h):r._FileToolsLoadImage(e,j,G,n?n.offlineProvider:null,g,y.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):typeof h=="string"||h instanceof ArrayBuffer||ArrayBuffer.isView(h)||h instanceof Blob?r._FileToolsLoadImage(h,j,G,n?n.offlineProvider:null,g,y.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):h&&j(h)}return y},r.prototype.createTexture=function(e,t,i,n,a,s,o,u,l,h,c,_,d,g,v){var p=this;return a===void 0&&(a=3),s===void 0&&(s=null),o===void 0&&(o=null),u===void 0&&(u=null),l===void 0&&(l=null),h===void 0&&(h=null),c===void 0&&(c=null),this._createTextureBase(e,t,i,n,a,s,o,this._prepareWebGLTexture.bind(this),function(m,E,T,R,y,C){var b=p._gl,x=T.width===m&&T.height===E,S=h?p._getInternalFormat(h,y._useSRGBBuffer):R===".jpg"&&!y._useSRGBBuffer?b.RGB:y._useSRGBBuffer?b.SRGB8_ALPHA8:b.RGBA,w=h?p._getInternalFormat(h):R===".jpg"&&!y._useSRGBBuffer?b.RGB:b.RGBA;if(y._useSRGBBuffer&&p.webGLVersion===1&&(w=S),x)return b.texImage2D(b.TEXTURE_2D,0,S,w,b.UNSIGNED_BYTE,T),!1;var A=p._caps.maxTextureSize;if(T.width>A||T.height>A||!p._supportsHardwareTextureRescaling)return p._prepareWorkingCanvas(),!p._workingCanvas||!p._workingContext||(p._workingCanvas.width=m,p._workingCanvas.height=E,p._workingContext.drawImage(T,0,0,T.width,T.height,0,0,m,E),b.texImage2D(b.TEXTURE_2D,0,S,w,b.UNSIGNED_BYTE,p._workingCanvas),y.width=m,y.height=E),!1;var U=new N(p,L.Temp);return p._bindTextureDirectly(b.TEXTURE_2D,U,!0),b.texImage2D(b.TEXTURE_2D,0,S,w,b.UNSIGNED_BYTE,T),p._rescaleTexture(U,y,n,S,function(){p._releaseTexture(U),p._bindTextureDirectly(b.TEXTURE_2D,y,!0),C()}),!0},u,l,h,c,_,d,v)},r._FileToolsLoadImage=function(e,t,i,n,a,s){throw ve("FileTools")},r.prototype._rescaleTexture=function(e,t,i,n,a){},r.prototype.createRawTexture=function(e,t,i,n,a,s,o,u,l,h,c){throw ve("Engine.RawTexture")},r.prototype.createRawCubeTexture=function(e,t,i,n,a,s,o,u){throw ve("Engine.RawTexture")},r.prototype.createRawTexture3D=function(e,t,i,n,a,s,o,u,l,h){throw ve("Engine.RawTexture")},r.prototype.createRawTexture2DArray=function(e,t,i,n,a,s,o,u,l,h){throw ve("Engine.RawTexture")},r.prototype._unpackFlipY=function(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))},r.prototype._getUnpackAlignement=function(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)},r.prototype._getTextureTarget=function(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D},r.prototype.updateTextureSamplingMode=function(e,t,i){i===void 0&&(i=!1);var n=this._getTextureTarget(t),a=this._getSamplingParameters(e,t.generateMipMaps||i);this._setTextureParameterInteger(n,this._gl.TEXTURE_MAG_FILTER,a.mag,t),this._setTextureParameterInteger(n,this._gl.TEXTURE_MIN_FILTER,a.min),i&&(t.generateMipMaps=!0,this._gl.generateMipmap(n)),this._bindTextureDirectly(n,null),t.samplingMode=e},r.prototype.updateTextureDimensions=function(e,t,i,n){},r.prototype.updateTextureWrappingMode=function(e,t,i,n){i===void 0&&(i=null),n===void 0&&(n=null);var a=this._getTextureTarget(e);t!==null&&(this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),i!==null&&(this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&n!==null&&(this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(n),e),e._cachedWrapR=n),this._bindTextureDirectly(a,null)},r.prototype._setupDepthStencilTexture=function(e,t,i,n,a,s){s===void 0&&(s=1);var o=t.width||t,u=t.height||t,l=t.layers||0;e.baseWidth=o,e.baseHeight=u,e.width=o,e.height=u,e.is2DArray=l>0,e.depth=l,e.isReady=!0,e.samples=s,e.generateMipMaps=!1,e.samplingMode=n?2:1,e.type=0,e._comparisonFunction=a;var h=this._gl,c=this._getTextureTarget(e),_=this._getSamplingParameters(e.samplingMode,!1);h.texParameteri(c,h.TEXTURE_MAG_FILTER,_.mag),h.texParameteri(c,h.TEXTURE_MIN_FILTER,_.min),h.texParameteri(c,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(c,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),this.webGLVersion>1&&(a===0?(h.texParameteri(c,h.TEXTURE_COMPARE_FUNC,515),h.texParameteri(c,h.TEXTURE_COMPARE_MODE,h.NONE)):(h.texParameteri(c,h.TEXTURE_COMPARE_FUNC,a),h.texParameteri(c,h.TEXTURE_COMPARE_MODE,h.COMPARE_REF_TO_TEXTURE)))},r.prototype._uploadCompressedDataToTextureDirectly=function(e,t,i,n,a,s,o){s===void 0&&(s=0),o===void 0&&(o=0);var u=this._gl,l=u.TEXTURE_2D;if(e.isCube&&(l=u.TEXTURE_CUBE_MAP_POSITIVE_X+s),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=u.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=u.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=u.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=u.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=u.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=u.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=u.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}this._gl.compressedTexImage2D(l,o,t,i,n,0,a)},r.prototype._uploadDataToTextureDirectly=function(e,t,i,n,a,s){i===void 0&&(i=0),n===void 0&&(n=0),s===void 0&&(s=!1);var o=this._gl,u=this._getWebGLTextureType(e.type),l=this._getInternalFormat(e.format),h=a===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(a,e._useSRGBBuffer);this._unpackFlipY(e.invertY);var c=o.TEXTURE_2D;e.isCube&&(c=o.TEXTURE_CUBE_MAP_POSITIVE_X+i);var _=Math.round(Math.log(e.width)*Math.LOG2E),d=Math.round(Math.log(e.height)*Math.LOG2E),g=s?e.width:Math.pow(2,Math.max(_-n,0)),v=s?e.height:Math.pow(2,Math.max(d-n,0));o.texImage2D(c,n,h,g,v,0,l,u,t)},r.prototype.updateTextureData=function(e,t,i,n,a,s,o,u,l){o===void 0&&(o=0),u===void 0&&(u=0),l===void 0&&(l=!1);var h=this._gl,c=this._getWebGLTextureType(e.type),_=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);var d=h.TEXTURE_2D;e.isCube&&(d=h.TEXTURE_CUBE_MAP_POSITIVE_X+o),this._bindTextureDirectly(d,e,!0),h.texSubImage2D(d,u,i,n,a,s,_,c,t),l&&this._gl.generateMipmap(d),this._bindTextureDirectly(d,null)},r.prototype._uploadArrayBufferViewToTexture=function(e,t,i,n){i===void 0&&(i=0),n===void 0&&(n=0);var a=this._gl,s=e.isCube?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;this._bindTextureDirectly(s,e,!0),this._uploadDataToTextureDirectly(e,t,i,n),this._bindTextureDirectly(s,null,!0)},r.prototype._prepareWebGLTextureContinuation=function(e,t,i,n,a){var s=this._gl;if(!!s){var o=this._getSamplingParameters(a,!i);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,o.mag),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,o.min),!i&&!n&&s.generateMipmap(s.TEXTURE_2D),this._bindTextureDirectly(s.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}},r.prototype._prepareWebGLTexture=function(e,t,i,n,a,s,o,u,l){var h=this;l===void 0&&(l=3);var c=this.getCaps().maxTextureSize,_=Math.min(c,this.needPOTTextures?r.GetExponentOfTwo(n.width,c):n.width),d=Math.min(c,this.needPOTTextures?r.GetExponentOfTwo(n.height,c):n.height),g=this._gl;if(!!g){if(!e._hardwareTexture){i&&i.removePendingData(e);return}this._bindTextureDirectly(g.TEXTURE_2D,e,!0),this._unpackFlipY(a===void 0?!0:!!a),e.baseWidth=n.width,e.baseHeight=n.height,e.width=_,e.height=d,e.isReady=!0,!u(_,d,n,t,e,function(){h._prepareWebGLTextureContinuation(e,i,s,o,l)})&&this._prepareWebGLTextureContinuation(e,i,s,o,l)}},r.prototype._setupFramebufferDepthAttachments=function(e,t,i,n,a){a===void 0&&(a=1);var s=this._gl;if(e&&t)return this._createRenderBuffer(i,n,a,s.DEPTH_STENCIL,s.DEPTH24_STENCIL8,s.DEPTH_STENCIL_ATTACHMENT);if(t){var o=s.DEPTH_COMPONENT16;return this._webGLVersion>1&&(o=s.DEPTH_COMPONENT32F),this._createRenderBuffer(i,n,a,o,o,s.DEPTH_ATTACHMENT)}return e?this._createRenderBuffer(i,n,a,s.STENCIL_INDEX8,s.STENCIL_INDEX8,s.STENCIL_ATTACHMENT):null},r.prototype._createRenderBuffer=function(e,t,i,n,a,s,o){o===void 0&&(o=!0);var u=this._gl,l=u.createRenderbuffer();return u.bindRenderbuffer(u.RENDERBUFFER,l),i>1&&u.renderbufferStorageMultisample?u.renderbufferStorageMultisample(u.RENDERBUFFER,i,a,e,t):u.renderbufferStorage(u.RENDERBUFFER,n,e,t),u.framebufferRenderbuffer(u.FRAMEBUFFER,s,u.RENDERBUFFER,l),o&&u.bindRenderbuffer(u.RENDERBUFFER,null),l},r.prototype._releaseTexture=function(e){var t;this._deleteTexture((t=e._hardwareTexture)===null||t===void 0?void 0:t.underlyingResource),this.unbindAllTextures();var i=this._internalTexturesCache.indexOf(e);i!==-1&&this._internalTexturesCache.splice(i,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()},r.prototype._releaseRenderTargetWrapper=function(e){var t=this._renderTargetWrapperCache.indexOf(e);t!==-1&&this._renderTargetWrapperCache.splice(t,1)},r.prototype._deleteTexture=function(e){e&&this._gl.deleteTexture(e)},r.prototype._setProgram=function(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)},r.prototype.bindSamplers=function(e){var t=e.getPipelineContext();this._setProgram(t.program);for(var i=e.getSamplers(),n=0;n<i.length;n++){var a=e.getUniform(i[n]);a&&(this._boundUniforms[n]=a)}this._currentEffect=null},r.prototype._activateCurrentTexture=function(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)},r.prototype._bindTextureDirectly=function(e,t,i,n){var a,s;i===void 0&&(i=!1),n===void 0&&(n=!1);var o=!1,u=t&&t._associatedChannel>-1;i&&u&&(this._activeChannel=t._associatedChannel);var l=this._boundTexturesCache[this._activeChannel];if(l!==t||n){if(this._activateCurrentTexture(),t&&t.isMultiview)throw console.error(e,t),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,(s=(a=t==null?void 0:t._hardwareTexture)===null||a===void 0?void 0:a.underlyingResource)!==null&&s!==void 0?s:null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else i&&(o=!0,this._activateCurrentTexture());return u&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),o},r.prototype._bindTexture=function(e,t,i){if(e!==void 0){t&&(t._associatedChannel=e),this._activeChannel=e;var n=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(n,t)}},r.prototype.unbindAllTextures=function(){for(var e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))},r.prototype.setTexture=function(e,t,i,n){e!==void 0&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))},r.prototype._bindSamplerUniformToChannel=function(e,t){var i=this._boundUniforms[e];!i||i._currentState===t||(this._gl.uniform1i(i,t),i._currentState=t)},r.prototype._getTextureWrapMode=function(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT},r.prototype._setTexture=function(e,t,i,n,a){if(i===void 0&&(i=!1),n===void 0&&(n=!1),!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video)this._activeChannel=e,t.update();else if(t.delayLoadState===4)return t.delayLoad(),!1;var s;n?s=t.depthStencilTexture:t.isReady()?s=t.getInternalTexture():t.isCube?s=this.emptyCubeTexture:t.is3D?s=this.emptyTexture3D:t.is2DArray?s=this.emptyTexture2DArray:s=this.emptyTexture,!i&&s&&(s._associatedChannel=e);var o=!0;this._boundTexturesCache[e]===s&&(i||this._bindSamplerUniformToChannel(s._associatedChannel,e),o=!1),this._activeChannel=e;var u=this._getTextureTarget(s);if(o&&this._bindTextureDirectly(u,s,i),s&&!s.isMultiview){if(s.isCube&&s._cachedCoordinatesMode!==t.coordinatesMode){s._cachedCoordinatesMode=t.coordinatesMode;var l=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=l,t.wrapV=l}s._cachedWrapU!==t.wrapU&&(s._cachedWrapU=t.wrapU,this._setTextureParameterInteger(u,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),s)),s._cachedWrapV!==t.wrapV&&(s._cachedWrapV=t.wrapV,this._setTextureParameterInteger(u,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),s)),s.is3D&&s._cachedWrapR!==t.wrapR&&(s._cachedWrapR=t.wrapR,this._setTextureParameterInteger(u,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),s)),this._setAnisotropicLevel(u,s,t.anisotropicFilteringLevel)}return!0},r.prototype.setTextureArray=function(e,t,i,n){if(!(e===void 0||!t)){(!this._textureUnits||this._textureUnits.length!==i.length)&&(this._textureUnits=new Int32Array(i.length));for(var a=0;a<i.length;a++){var s=i[a].getInternalTexture();s?(this._textureUnits[a]=e+a,s._associatedChannel=e+a):this._textureUnits[a]=-1}this._gl.uniform1iv(t,this._textureUnits);for(var o=0;o<i.length;o++)this._setTexture(this._textureUnits[o],i[o],!0)}},r.prototype._setAnisotropicLevel=function(e,t,i){var n=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==11&&t.samplingMode!==3&&t.samplingMode!==2&&(i=1),n&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,n.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)},r.prototype._setTextureParameterFloat=function(e,t,i,n){this._bindTextureDirectly(e,n,!0,!0),this._gl.texParameterf(e,t,i)},r.prototype._setTextureParameterInteger=function(e,t,i,n){n&&this._bindTextureDirectly(e,n,!0,!0),this._gl.texParameteri(e,t,i)},r.prototype.unbindAllAttributes=function(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(var e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(var e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)},r.prototype.releaseEffects=function(){for(var e in this._compiledEffects){var t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}},r.prototype.dispose=function(){var e;this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),(e=this.releaseComputeEffects)===null||e===void 0||e.call(this),this.unbindAllAttributes(),this._boundUniforms={},ae()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),window.removeEventListener("resize",this._checkForMobile)),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,Ee.ResetCache();for(var t=0,i=this._activeRequests;t<i.length;t++){var n=i[t];n.abort()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},r.prototype.attachContextLostEvent=function(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)},r.prototype.attachContextRestoredEvent=function(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)},r.prototype.getError=function(){return this._gl.getError()},r.prototype._canRenderToFloatFramebuffer=function(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)},r.prototype._canRenderToHalfFloatFramebuffer=function(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)},r.prototype._canRenderToFramebuffer=function(e){for(var t=this._gl;t.getError()!==t.NO_ERROR;);var i=!0,n=t.createTexture();t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);var a=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,a),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,n,0);var s=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i=i&&s===t.FRAMEBUFFER_COMPLETE,i=i&&t.getError()===t.NO_ERROR,i&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);var o=t.RGBA,u=t.UNSIGNED_BYTE,l=new Uint8Array(4);t.readPixels(0,0,1,1,o,u,l),i=i&&t.getError()===t.NO_ERROR}for(t.deleteTexture(n),t.deleteFramebuffer(a),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i},r.prototype._getWebGLTextureType=function(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE},r.prototype._getInternalFormat=function(e,t){t===void 0&&(t=!1);var i=t?this._gl.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:i=this._gl.ALPHA;break;case 1:i=this._gl.LUMINANCE;break;case 2:i=this._gl.LUMINANCE_ALPHA;break;case 6:i=this._gl.RED;break;case 7:i=this._gl.RG;break;case 4:i=t?this._gl.SRGB:this._gl.RGB;break;case 5:i=t?this._gl.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:i=this._gl.RED_INTEGER;break;case 9:i=this._gl.RG_INTEGER;break;case 10:i=this._gl.RGB_INTEGER;break;case 11:i=this._gl.RGBA_INTEGER;break}return i},r.prototype._getRGBABufferInternalSizedFormat=function(e,t,i){if(i===void 0&&(i=!1),this._webGLVersion===1){if(t!==void 0)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return i?this._gl.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return i?this._gl.SRGB8:this._gl.RGB8;case 5:return i?this._gl.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return i?this._gl.SRGB8_ALPHA8:this._gl.RGBA8},r.prototype._getRGBAMultiSampleBufferFormat=function(e){return e===1?this._gl.RGBA32F:e===2?this._gl.RGBA16F:this._gl.RGBA8},r.prototype._loadFile=function(e,t,i,n,a,s){var o=this,u=r._FileToolsLoadFile(e,t,i,n,a,s);return this._activeRequests.push(u),u.onCompleteObservable.add(function(l){o._activeRequests.splice(o._activeRequests.indexOf(l),1)}),u},r._FileToolsLoadFile=function(e,t,i,n,a,s){throw ve("FileTools")},r.prototype.readPixels=function(e,t,i,n,a,s){a===void 0&&(a=!0),s===void 0&&(s=!0);var o=a?4:3,u=a?this._gl.RGBA:this._gl.RGB,l=new Uint8Array(n*i*o);return s&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,n,u,this._gl.UNSIGNED_BYTE,l),Promise.resolve(l)},Object.defineProperty(r,"IsSupportedAsync",{get:function(){return Promise.resolve(this.isSupported())},enumerable:!1,configurable:!0}),Object.defineProperty(r,"IsSupported",{get:function(){return this.isSupported()},enumerable:!1,configurable:!0}),r.isSupported=function(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{var e=this._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=t!=null&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported},Object.defineProperty(r,"HasMajorPerformanceCaveat",{get:function(){if(this._HasMajorPerformanceCaveat===null)try{var e=this._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat},enumerable:!1,configurable:!0}),r.CeilingPOT=function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e},r.FloorPOT=function(e){return e=e|e>>1,e=e|e>>2,e=e|e>>4,e=e|e>>8,e=e|e>>16,e-(e>>1)},r.NearestPOT=function(e){var t=r.CeilingPOT(e),i=r.FloorPOT(e);return t-e>e-i?i:t},r.GetExponentOfTwo=function(e,t,i){i===void 0&&(i=2);var n;switch(i){case 1:n=r.FloorPOT(e);break;case 2:n=r.NearestPOT(e);break;case 3:default:n=r.CeilingPOT(e);break}return Math.min(n,t)},r.QueueNewFrame=function(e,t){return ae()?(t||(t=window),t.requestPostAnimationFrame?t.requestPostAnimationFrame(e):t.requestAnimationFrame?t.requestAnimationFrame(e):t.msRequestAnimationFrame?t.msRequestAnimationFrame(e):t.webkitRequestAnimationFrame?t.webkitRequestAnimationFrame(e):t.mozRequestAnimationFrame?t.mozRequestAnimationFrame(e):t.oRequestAnimationFrame?t.oRequestAnimationFrame(e):window.setTimeout(e,16)):typeof requestAnimationFrame!="undefined"?requestAnimationFrame(e):setTimeout(e,16)},r.prototype.getHostDocument=function(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:dt()?document:null},r.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],r._TextureLoaders=[],r.CollisionsEpsilon=.001,r._IsSupported=null,r._HasMajorPerformanceCaveat=null,r}();P.prototype.createUniformBuffer=function(r){var e=this._gl.createBuffer();if(!e)throw new Error("Unable to create uniform buffer");var t=new Ve(e);return this.bindUniformBuffer(t),r instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,r,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(r),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),t.references=1,t};P.prototype.createDynamicUniformBuffer=function(r){var e=this._gl.createBuffer();if(!e)throw new Error("Unable to create dynamic uniform buffer");var t=new Ve(e);return this.bindUniformBuffer(t),r instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,r,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(r),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),t.references=1,t};P.prototype.updateUniformBuffer=function(r,e,t,i){this.bindUniformBuffer(r),t===void 0&&(t=0),i===void 0?e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,e):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,e.subarray(t,t+i)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(e).subarray(t,t+i)),this.bindUniformBuffer(null)};P.prototype.bindUniformBuffer=function(r){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,r?r.underlyingResource:null)};P.prototype.bindUniformBufferBase=function(r,e,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,e,r?r.underlyingResource:null)};P.prototype.bindUniformBlock=function(r,e,t){var i=r.program,n=this._gl.getUniformBlockIndex(i,e);n!==4294967295&&this._gl.uniformBlockBinding(i,n,t)};P.prototype.setAlphaConstants=function(r,e,t,i){this._alphaState.setAlphaBlendConstants(r,e,t,i)};P.prototype.setAlphaMode=function(r,e){if(e===void 0&&(e=!1),this._alphaMode!==r){switch(r){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break}e||(this.depthCullingState.depthMask=r===0),this._alphaMode=r}};P.prototype.getAlphaMode=function(){return this._alphaMode};P.prototype.setAlphaEquation=function(r){if(this._alphaEquation!==r){switch(r){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774);break}this._alphaEquation=r}};P.prototype.getAlphaEquation=function(){return this._alphaEquation};function gt(r,e,t,i){switch(t===void 0&&(t=!1),r){case 3:{var n=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e);return i&&n.set(new Int8Array(i)),n}case 0:{var a=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&a.set(new Uint8Array(i)),a}case 4:{var s=e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(t?e/2:e);return i&&s.set(new Int16Array(i)),s}case 5:case 8:case 9:case 10:case 2:{var o=e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(t?e/2:e);return i&&o.set(new Uint16Array(i)),o}case 6:{var u=e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(t?e/4:e);return i&&u.set(new Int32Array(i)),u}case 7:case 11:case 12:case 13:case 14:case 15:{var l=e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(t?e/4:e);return i&&l.set(new Uint32Array(i)),l}case 1:{var h=e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(t?e/4:e);return i&&h.set(new Float32Array(i)),h}}var c=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&c.set(new Uint8Array(i)),c}P.prototype._readTexturePixelsSync=function(r,e,t,i,n,a,s,o,u,l){var h,c;i===void 0&&(i=-1),n===void 0&&(n=0),a===void 0&&(a=null),s===void 0&&(s=!0),o===void 0&&(o=!1),u===void 0&&(u=0),l===void 0&&(l=0);var _=this._gl;if(!_)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){var d=_.createFramebuffer();if(!d)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=d}_.bindFramebuffer(_.FRAMEBUFFER,this._dummyFramebuffer),i>-1?_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_CUBE_MAP_POSITIVE_X+i,(h=r._hardwareTexture)===null||h===void 0?void 0:h.underlyingResource,n):_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_2D,(c=r._hardwareTexture)===null||c===void 0?void 0:c.underlyingResource,n);var g=r.type!==void 0?this._getWebGLTextureType(r.type):_.UNSIGNED_BYTE;if(o)a||(a=gt(r.type,4*e*t));else switch(g){case _.UNSIGNED_BYTE:a||(a=new Uint8Array(4*e*t)),g=_.UNSIGNED_BYTE;break;default:a||(a=new Float32Array(4*e*t)),g=_.FLOAT;break}return s&&this.flushFramebuffer(),_.readPixels(u,l,e,t,_.RGBA,g,a),_.bindFramebuffer(_.FRAMEBUFFER,this._currentFramebuffer),a};P.prototype._readTexturePixels=function(r,e,t,i,n,a,s,o,u,l){return i===void 0&&(i=-1),n===void 0&&(n=0),a===void 0&&(a=null),s===void 0&&(s=!0),o===void 0&&(o=!1),u===void 0&&(u=0),l===void 0&&(l=0),Promise.resolve(this._readTexturePixelsSync(r,e,t,i,n,a,s,o,u,l))};P.prototype.updateDynamicIndexBuffer=function(r,e,t){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(r);var i;r.is32Bits?i=e instanceof Uint32Array?e:new Uint32Array(e):i=e instanceof Uint16Array?e:new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()};P.prototype.updateDynamicVertexBuffer=function(r,e,t,i){this.bindArrayBuffer(r),t===void 0&&(t=0);var n=e.byteLength||e.length;i===void 0||i>=n&&t===0?e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(e).subarray(t,t+i)):(e instanceof ArrayBuffer?e=new Uint8Array(e,t,i):e=new Uint8Array(e.buffer,e.byteOffset+t,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)),this._resetVertexBufferBinding()};var F=function(r){J(e,r);function e(t,i,n,a){a===void 0&&(a=!1);var s=r.call(this,t,i,n,a)||this;if(s.enableOfflineSupport=!1,s.disableManifestCheck=!1,s.disableContextMenu=!0,s.scenes=new Array,s._virtualScenes=new Array,s.onNewSceneAddedObservable=new ee,s.postProcesses=new Array,s.isPointerLock=!1,s.onResizeObservable=new ee,s.onCanvasBlurObservable=new ee,s.onCanvasFocusObservable=new ee,s.onCanvasPointerOutObservable=new ee,s.onBeginFrameObservable=new ee,s.customAnimationFrameRequester=null,s.onEndFrameObservable=new ee,s.onBeforeShaderCompilationObservable=new ee,s.onAfterShaderCompilationObservable=new ee,s._deterministicLockstep=!1,s._lockstepMaxSteps=4,s._timeStep=1/60,s._fps=60,s._deltaTime=0,s._drawCalls=new vt,s.canvasTabIndex=1,s.disablePerformanceMonitorInBackground=!1,s._performanceMonitor=new pr,s._compatibilityMode=!0,s.currentRenderPassId=0,s._renderPassNames=["main"],e.Instances.push(s),!t)return s;if(s._features.supportRenderPasses=!0,n=s._creationOptions,t.getContext){var o=t;if(s._sharedInit(o,!!n.doNotHandleTouchAction,n.audioEngine),ae()){var u=document;s._onFullscreenChange=function(){u.fullscreen!==void 0?s.isFullscreen=u.fullscreen:u.mozFullScreen!==void 0?s.isFullscreen=u.mozFullScreen:u.webkitIsFullScreen!==void 0?s.isFullscreen=u.webkitIsFullScreen:u.msIsFullScreen!==void 0&&(s.isFullscreen=u.msIsFullScreen),s.isFullscreen&&s._pointerLockRequested&&o&&e._RequestPointerlock(o)},document.addEventListener("fullscreenchange",s._onFullscreenChange,!1),document.addEventListener("mozfullscreenchange",s._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",s._onFullscreenChange,!1),document.addEventListener("msfullscreenchange",s._onFullscreenChange,!1),s._onPointerLockChange=function(){s.isPointerLock=u.mozPointerLockElement===o||u.webkitPointerLockElement===o||u.msPointerLockElement===o||u.pointerLockElement===o},document.addEventListener("pointerlockchange",s._onPointerLockChange,!1),document.addEventListener("mspointerlockchange",s._onPointerLockChange,!1),document.addEventListener("mozpointerlockchange",s._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",s._onPointerLockChange,!1),!e.audioEngine&&n.audioEngine&&e.AudioEngineFactory&&(e.audioEngine=e.AudioEngineFactory(s.getRenderingCanvas(),s.getAudioContext(),s.getAudioDestination()))}s._connectVREvents(),s.enableOfflineSupport=e.OfflineProviderFactory!==void 0,s._deterministicLockstep=!!n.deterministicLockstep,s._lockstepMaxSteps=n.lockstepMaxSteps||0,s._timeStep=n.timeStep||1/60}return s._prepareVRComponent(),n.autoEnableWebVR&&s.initWebVR(),s}return Object.defineProperty(e,"NpmPackage",{get:function(){return P.NpmPackage},enumerable:!1,configurable:!0}),Object.defineProperty(e,"Version",{get:function(){return P.Version},enumerable:!1,configurable:!0}),Object.defineProperty(e,"Instances",{get:function(){return Re.Instances},enumerable:!1,configurable:!0}),Object.defineProperty(e,"LastCreatedEngine",{get:function(){return Re.LastCreatedEngine},enumerable:!1,configurable:!0}),Object.defineProperty(e,"LastCreatedScene",{get:function(){return Re.LastCreatedScene},enumerable:!1,configurable:!0}),e.prototype._createImageBitmapFromSource=function(t,i){var n=this,a=new Promise(function(s,o){var u=new Image;u.onload=function(){u.decode().then(function(){n.createImageBitmap(u,i).then(function(l){s(l)})})},u.onerror=function(){o("Error loading image ".concat(u.src))},u.src=t});return a},e.prototype.createImageBitmap=function(t,i){return createImageBitmap(t,i)},e.prototype.resizeImageBitmap=function(t,i,n){var a=this.createCanvas(i,n),s=a.getContext("2d");if(!s)throw new Error("Unable to get 2d context for resizeImageBitmap");s.drawImage(t,0,0);var o=s.getImageData(0,0,i,n).data;return o},e.MarkAllMaterialsAsDirty=function(t,i){for(var n=0;n<e.Instances.length;n++)for(var a=e.Instances[n],s=0;s<a.scenes.length;s++)a.scenes[s].markAllMaterialsAsDirty(t,i)},e.DefaultLoadingScreenFactory=function(t){throw ve("LoadingScreen")},Object.defineProperty(e.prototype,"_supportsHardwareTextureRescaling",{get:function(){return!!e._RescalePostProcessFactory},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"performanceMonitor",{get:function(){return this._performanceMonitor},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"compatibilityMode",{get:function(){return this._compatibilityMode},set:function(t){this._compatibilityMode=!0},enumerable:!1,configurable:!0}),e.prototype.getInputElement=function(){return this._renderingCanvas},e.prototype._sharedInit=function(t,i,n){var a=this;if(r.prototype._sharedInit.call(this,t,i,n),this._onCanvasFocus=function(){a.onCanvasFocusObservable.notifyObservers(a)},this._onCanvasBlur=function(){a.onCanvasBlurObservable.notifyObservers(a)},this._onCanvasContextMenu=function(o){a.disableContextMenu&&o.preventDefault()},t.addEventListener("focus",this._onCanvasFocus),t.addEventListener("blur",this._onCanvasBlur),t.addEventListener("contextmenu",this._onCanvasContextMenu),this._onBlur=function(){a.disablePerformanceMonitorInBackground&&a._performanceMonitor.disable(),a._windowIsBackground=!0},this._onFocus=function(){a.disablePerformanceMonitorInBackground&&a._performanceMonitor.enable(),a._windowIsBackground=!1},this._onCanvasPointerOut=function(o){document.elementFromPoint(o.clientX,o.clientY)!==t&&a.onCanvasPointerOutObservable.notifyObservers(o)},ae()){var s=this.getHostWindow();s&&(s.addEventListener("blur",this._onBlur),s.addEventListener("focus",this._onFocus))}t.addEventListener("pointerout",this._onCanvasPointerOut),i||this._disableTouchAction(),!e.audioEngine&&n&&e.AudioEngineFactory&&(e.audioEngine=e.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination()))},e.prototype.getAspectRatio=function(t,i){i===void 0&&(i=!1);var n=t.viewport;return this.getRenderWidth(i)*n.width/(this.getRenderHeight(i)*n.height)},e.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},e.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},e.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},e.prototype.isDeterministicLockStep=function(){return this._deterministicLockstep},e.prototype.getLockstepMaxSteps=function(){return this._lockstepMaxSteps},e.prototype.getTimeStep=function(){return this._timeStep*1e3},e.prototype.generateMipMapsForCubemap=function(t,i){if(i===void 0&&(i=!0),t.generateMipMaps){var n=this._gl;this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,t,!0),n.generateMipmap(n.TEXTURE_CUBE_MAP),i&&this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null)}},e.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},e.prototype.setDepthWrite=function(t){this._depthCullingState.depthMask=t},e.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},e.prototype.setStencilBuffer=function(t){this._stencilState.stencilTest=t},e.prototype.getStencilMask=function(){return this._stencilState.stencilMask},e.prototype.setStencilMask=function(t){this._stencilState.stencilMask=t},e.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},e.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},e.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},e.prototype.setStencilFunction=function(t){this._stencilState.stencilFunc=t},e.prototype.setStencilFunctionReference=function(t){this._stencilState.stencilFuncRef=t},e.prototype.setStencilFunctionMask=function(t){this._stencilState.stencilFuncMask=t},e.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},e.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},e.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},e.prototype.setStencilOperationFail=function(t){this._stencilState.stencilOpStencilFail=t},e.prototype.setStencilOperationDepthFail=function(t){this._stencilState.stencilOpDepthFail=t},e.prototype.setStencilOperationPass=function(t){this._stencilState.stencilOpStencilDepthPass=t},e.prototype.setDitheringState=function(t){t?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)},e.prototype.setRasterizerState=function(t){t?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)},e.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},e.prototype.setDepthFunction=function(t){this._depthCullingState.depthFunc=t},e.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},e.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},e.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},e.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},e.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},e.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)},e.prototype.setDirectViewport=function(t,i,n,a){var s=this._cachedViewport;return this._cachedViewport=null,this._viewport(t,i,n,a),s},e.prototype.scissorClear=function(t,i,n,a,s){this.enableScissor(t,i,n,a),this.clear(s,!0,!0,!0),this.disableScissor()},e.prototype.enableScissor=function(t,i,n,a){var s=this._gl;s.enable(s.SCISSOR_TEST),s.scissor(t,i,n,a)},e.prototype.disableScissor=function(){var t=this._gl;t.disable(t.SCISSOR_TEST)},e.prototype._reportDrawCall=function(t){t===void 0&&(t=1),this._drawCalls.addCount(t,!1)},e.prototype.initWebVR=function(){throw ve("WebVRCamera")},e.prototype._prepareVRComponent=function(){},e.prototype._connectVREvents=function(t,i){},e.prototype._submitVRFrame=function(){},e.prototype.disableVR=function(){},e.prototype.isVRPresenting=function(){return!1},e.prototype._requestVRFrame=function(){},e.prototype._loadFileAsync=function(t,i,n){var a=this;return new Promise(function(s,o){a._loadFile(t,function(u){s(u)},void 0,i,n,function(u,l){o(l)})})},e.prototype.getVertexShaderSource=function(t){var i=this._gl.getAttachedShaders(t);return i?this._gl.getShaderSource(i[0]):null},e.prototype.getFragmentShaderSource=function(t){var i=this._gl.getAttachedShaders(t);return i?this._gl.getShaderSource(i[1]):null},e.prototype.setDepthStencilTexture=function(t,i,n,a){t!==void 0&&(i&&(this._boundUniforms[t]=i),!n||!n.depthStencilTexture?this._setTexture(t,null,void 0,void 0,a):this._setTexture(t,n,!1,!0,a))},e.prototype.setTextureFromPostProcess=function(t,i,n){var a,s=null;i&&(i._textures.data[i._currentRenderTextureInd]?s=i._textures.data[i._currentRenderTextureInd]:i._forcedOutputTexture&&(s=i._forcedOutputTexture)),this._bindTexture(t,(a=s==null?void 0:s.texture)!==null&&a!==void 0?a:null,n)},e.prototype.setTextureFromPostProcessOutput=function(t,i,n){var a,s;this._bindTexture(t,(s=(a=i==null?void 0:i._outputTexture)===null||a===void 0?void 0:a.texture)!==null&&s!==void 0?s:null,n)},e.prototype._rebuildBuffers=function(){for(var t=0,i=this.scenes;t<i.length;t++){var n=i[t];n.resetCachedMaterial(),n._rebuildGeometries(),n._rebuildTextures()}for(var a=0,s=this._virtualScenes;a<s.length;a++){var n=s[a];n.resetCachedMaterial(),n._rebuildGeometries(),n._rebuildTextures()}r.prototype._rebuildBuffers.call(this)},e.prototype._renderFrame=function(){for(var t=0;t<this._activeRenderLoops.length;t++){var i=this._activeRenderLoops[t];i()}},e.prototype._renderLoop=function(){if(!this._contextWasLost){var t=!0;!this.renderEvenInBackground&&this._windowIsBackground&&(t=!1),t&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this.isVRPresenting()?this._requestVRFrame():this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1},e.prototype._renderViews=function(){return!1},e.prototype.switchFullscreen=function(t){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(t)},e.prototype.enterFullscreen=function(t){this.isFullscreen||(this._pointerLockRequested=t,this._renderingCanvas&&e._RequestFullscreen(this._renderingCanvas))},e.prototype.exitFullscreen=function(){this.isFullscreen&&e._ExitFullscreen()},e.prototype.enterPointerlock=function(){this._renderingCanvas&&e._RequestPointerlock(this._renderingCanvas)},e.prototype.exitPointerlock=function(){e._ExitPointerlock()},e.prototype.beginFrame=function(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),r.prototype.beginFrame.call(this)},e.prototype.endFrame=function(){r.prototype.endFrame.call(this),this._submitVRFrame(),this.onEndFrameObservable.notifyObservers(this)},e.prototype.resize=function(t){t===void 0&&(t=!1),!this.isVRPresenting()&&r.prototype.resize.call(this,t)},e.prototype.setSize=function(t,i,n){if(n===void 0&&(n=!1),!this._renderingCanvas||!r.prototype.setSize.call(this,t,i,n))return!1;if(this.scenes){for(var a=0;a<this.scenes.length;a++)for(var s=this.scenes[a],o=0;o<s.cameras.length;o++){var u=s.cameras[o];u._currentRenderId=0}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0},e.prototype._deletePipelineContext=function(t){var i=t;i&&i.program&&i.transformFeedback&&(this.deleteTransformFeedback(i.transformFeedback),i.transformFeedback=null),r.prototype._deletePipelineContext.call(this,t)},e.prototype.createShaderProgram=function(t,i,n,a,s,o){o===void 0&&(o=null),s=s||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);var u=r.prototype.createShaderProgram.call(this,t,i,n,a,s,o);return this.onAfterShaderCompilationObservable.notifyObservers(this),u},e.prototype._createShaderProgram=function(t,i,n,a,s){s===void 0&&(s=null);var o=a.createProgram();if(t.program=o,!o)throw new Error("Unable to create program");if(a.attachShader(o,i),a.attachShader(o,n),this.webGLVersion>1&&s){var u=this.createTransformFeedback();this.bindTransformFeedback(u),this.setTranformFeedbackVaryings(o,s),t.transformFeedback=u}return a.linkProgram(o),this.webGLVersion>1&&s&&this.bindTransformFeedback(null),t.context=a,t.vertexShader=i,t.fragmentShader=n,t.isParallelCompiled||this._finalizePipelineContext(t),o},e.prototype._releaseTexture=function(t){r.prototype._releaseTexture.call(this,t)},e.prototype._releaseRenderTargetWrapper=function(t){r.prototype._releaseRenderTargetWrapper.call(this,t),this.scenes.forEach(function(i){i.postProcesses.forEach(function(n){n._outputTexture===t&&(n._outputTexture=null)}),i.cameras.forEach(function(n){n._postProcesses.forEach(function(a){a&&a._outputTexture===t&&(a._outputTexture=null)})})})},e.prototype.getRenderPassNames=function(){return this._renderPassNames},e.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},e.prototype.createRenderPassId=function(t){var i=++e._RenderPassIdCounter;return this._renderPassNames[i]=t!=null?t:"NONAME",i},e.prototype.releaseRenderPassId=function(t){this._renderPassNames[t]=void 0;for(var i=0;i<this.scenes.length;++i)for(var n=this.scenes[i],a=0;a<n.meshes.length;++a){var s=n.meshes[a];if(s.subMeshes)for(var o=0;o<s.subMeshes.length;++o){var u=s.subMeshes[o];u._removeDrawWrapper(t)}}},e.prototype._rescaleTexture=function(t,i,n,a,s){var o=this;this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);var u=this.createRenderTargetTexture({width:i.width,height:i.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&e._RescalePostProcessFactory&&(this._rescalePostProcess=e._RescalePostProcessFactory(this)),this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled(function(){o._rescalePostProcess.onApply=function(h){h._bindTexture("textureSampler",t)};var l=n;l||(l=o.scenes[o.scenes.length-1]),l.postProcessManager.directRender([o._rescalePostProcess],u,!0),o._bindTextureDirectly(o._gl.TEXTURE_2D,i,!0),o._gl.copyTexImage2D(o._gl.TEXTURE_2D,0,a,0,0,i.width,i.height,0),o.unBindFramebuffer(u),u.dispose(),s&&s()})},e.prototype.getFps=function(){return this._fps},e.prototype.getDeltaTime=function(){return this._deltaTime},e.prototype._measureFps=function(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0},e.prototype.wrapWebGLTexture=function(t){var i=new yt(t,this._gl),n=new N(this,L.Unknown,!0);return n._hardwareTexture=i,n.isReady=!0,n},e.prototype._uploadImageToTexture=function(t,i,n,a){n===void 0&&(n=0),a===void 0&&(a=0);var s=this._gl,o=this._getWebGLTextureType(t.type),u=this._getInternalFormat(t.format),l=this._getRGBABufferInternalSizedFormat(t.type,u),h=t.isCube?s.TEXTURE_CUBE_MAP:s.TEXTURE_2D;this._bindTextureDirectly(h,t,!0),this._unpackFlipY(t.invertY);var c=s.TEXTURE_2D;t.isCube&&(c=s.TEXTURE_CUBE_MAP_POSITIVE_X+n),s.texImage2D(c,a,l,u,o,i),this._bindTextureDirectly(h,null,!0)},e.prototype.updateTextureComparisonFunction=function(t,i){if(this.webGLVersion===1){I.Error("WebGL 1 does not support texture comparison.");return}var n=this._gl;t.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,t,!0),i===0?(n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_FUNC,515),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_MODE,n.NONE)):(n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_FUNC,i),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),i===0?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_FUNC,515),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_MODE,n.NONE)):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_FUNC,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),t._comparisonFunction=i},e.prototype.createInstancesBuffer=function(t){var i=this._gl.createBuffer();if(!i)throw new Error("Unable to create instance buffer");var n=new Ve(i);return n.capacity=t,this.bindArrayBuffer(n),this._gl.bufferData(this._gl.ARRAY_BUFFER,t,this._gl.DYNAMIC_DRAW),n.references=1,n},e.prototype.deleteInstancesBuffer=function(t){this._gl.deleteBuffer(t)},e.prototype._clientWaitAsync=function(t,i,n){i===void 0&&(i=0),n===void 0&&(n=10);var a=this._gl;return new Promise(function(s,o){var u=function(){var l=a.clientWaitSync(t,i,0);if(l==a.WAIT_FAILED){o();return}if(l==a.TIMEOUT_EXPIRED){setTimeout(u,n);return}s()};u()})},e.prototype._readPixelsAsync=function(t,i,n,a,s,o,u){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");var l=this._gl,h=l.createBuffer();l.bindBuffer(l.PIXEL_PACK_BUFFER,h),l.bufferData(l.PIXEL_PACK_BUFFER,u.byteLength,l.STREAM_READ),l.readPixels(t,i,n,a,s,o,0),l.bindBuffer(l.PIXEL_PACK_BUFFER,null);var c=l.fenceSync(l.SYNC_GPU_COMMANDS_COMPLETE,0);return c?(l.flush(),this._clientWaitAsync(c,0,10).then(function(){return l.deleteSync(c),l.bindBuffer(l.PIXEL_PACK_BUFFER,h),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,u),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),l.deleteBuffer(h),u})):null},e.prototype.dispose=function(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();e.Instances.length===1&&e.audioEngine&&(e.audioEngine.dispose(),e.audioEngine=null),this.disableVR(),ae()&&(window.removeEventListener("blur",this._onBlur),window.removeEventListener("focus",this._onFocus),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut),this._renderingCanvas.removeEventListener("contextmenu",this._onCanvasContextMenu)),dt()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange))),r.prototype.dispose.call(this);var t=e.Instances.indexOf(this);t>=0&&e.Instances.splice(t,1),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()},e.prototype._disableTouchAction=function(){!this._renderingCanvas||!this._renderingCanvas.setAttribute||(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.msTouchAction="none",this._renderingCanvas.style.webkitTapHighlightColor="transparent")},e.prototype.displayLoadingUI=function(){if(!!ae()){var t=this.loadingScreen;t&&t.displayLoadingUI()}},e.prototype.hideLoadingUI=function(){if(!!ae()){var t=this._loadingScreen;t&&t.hideLoadingUI()}},Object.defineProperty(e.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=e.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(t){this._loadingScreen=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loadingUIText",{set:function(t){this.loadingScreen.loadingUIText=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loadingUIBackgroundColor",{set:function(t){this.loadingScreen.loadingUIBackgroundColor=t},enumerable:!1,configurable:!0}),e.prototype.createVideoElement=function(t){return document.createElement("video")},e._RequestPointerlock=function(t){t.requestPointerLock=t.requestPointerLock||t.msRequestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock,t.requestPointerLock&&(t.requestPointerLock(),t.focus())},e._ExitPointerlock=function(){var t=document;document.exitPointerLock=document.exitPointerLock||t.msExitPointerLock||t.mozExitPointerLock||t.webkitExitPointerLock,document.exitPointerLock&&document.exitPointerLock()},e._RequestFullscreen=function(t){var i=t.requestFullscreen||t.msRequestFullscreen||t.webkitRequestFullscreen||t.mozRequestFullScreen;!i||i.call(t)},e._ExitFullscreen=function(){var t=document;document.exitFullscreen?document.exitFullscreen():t.mozCancelFullScreen?t.mozCancelFullScreen():t.webkitCancelFullScreen?t.webkitCancelFullScreen():t.msCancelFullScreen&&t.msCancelFullScreen()},e.prototype.getFontOffset=function(t){var i=document.createElement("span");i.innerHTML="Hg",i.setAttribute("style","font: ".concat(t," !important"));var n=document.createElement("div");n.style.display="inline-block",n.style.width="1px",n.style.height="0px",n.style.verticalAlign="bottom";var a=document.createElement("div");a.style.whiteSpace="nowrap",a.appendChild(i),a.appendChild(n),document.body.appendChild(a);var s=0,o=0;try{o=n.getBoundingClientRect().top-i.getBoundingClientRect().top,n.style.verticalAlign="baseline",s=n.getBoundingClientRect().top-i.getBoundingClientRect().top}finally{document.body.removeChild(a)}return{ascent:s,height:o,descent:o-s}},e.ALPHA_DISABLE=0,e.ALPHA_ADD=1,e.ALPHA_COMBINE=2,e.ALPHA_SUBTRACT=3,e.ALPHA_MULTIPLY=4,e.ALPHA_MAXIMIZED=5,e.ALPHA_ONEONE=6,e.ALPHA_PREMULTIPLIED=7,e.ALPHA_PREMULTIPLIED_PORTERDUFF=8,e.ALPHA_INTERPOLATE=9,e.ALPHA_SCREENMODE=10,e.DELAYLOADSTATE_NONE=0,e.DELAYLOADSTATE_LOADED=1,e.DELAYLOADSTATE_LOADING=2,e.DELAYLOADSTATE_NOTLOADED=4,e.NEVER=512,e.ALWAYS=519,e.LESS=513,e.EQUAL=514,e.LEQUAL=515,e.GREATER=516,e.GEQUAL=518,e.NOTEQUAL=517,e.KEEP=7680,e.REPLACE=7681,e.INCR=7682,e.DECR=7683,e.INVERT=5386,e.INCR_WRAP=34055,e.DECR_WRAP=34056,e.TEXTURE_CLAMP_ADDRESSMODE=0,e.TEXTURE_WRAP_ADDRESSMODE=1,e.TEXTURE_MIRROR_ADDRESSMODE=2,e.TEXTUREFORMAT_ALPHA=0,e.TEXTUREFORMAT_LUMINANCE=1,e.TEXTUREFORMAT_LUMINANCE_ALPHA=2,e.TEXTUREFORMAT_RGB=4,e.TEXTUREFORMAT_RGBA=5,e.TEXTUREFORMAT_RED=6,e.TEXTUREFORMAT_R=6,e.TEXTUREFORMAT_RG=7,e.TEXTUREFORMAT_RED_INTEGER=8,e.TEXTUREFORMAT_R_INTEGER=8,e.TEXTUREFORMAT_RG_INTEGER=9,e.TEXTUREFORMAT_RGB_INTEGER=10,e.TEXTUREFORMAT_RGBA_INTEGER=11,e.TEXTURETYPE_UNSIGNED_BYTE=0,e.TEXTURETYPE_UNSIGNED_INT=0,e.TEXTURETYPE_FLOAT=1,e.TEXTURETYPE_HALF_FLOAT=2,e.TEXTURETYPE_BYTE=3,e.TEXTURETYPE_SHORT=4,e.TEXTURETYPE_UNSIGNED_SHORT=5,e.TEXTURETYPE_INT=6,e.TEXTURETYPE_UNSIGNED_INTEGER=7,e.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,e.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,e.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,e.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,e.TEXTURETYPE_UNSIGNED_INT_24_8=12,e.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,e.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,e.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,e.TEXTURE_NEAREST_SAMPLINGMODE=1,e.TEXTURE_BILINEAR_SAMPLINGMODE=2,e.TEXTURE_TRILINEAR_SAMPLINGMODE=3,e.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,e.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,e.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,e.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,e.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,e.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,e.TEXTURE_NEAREST_LINEAR=7,e.TEXTURE_NEAREST_NEAREST=1,e.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,e.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,e.TEXTURE_LINEAR_LINEAR=2,e.TEXTURE_LINEAR_NEAREST=12,e.TEXTURE_EXPLICIT_MODE=0,e.TEXTURE_SPHERICAL_MODE=1,e.TEXTURE_PLANAR_MODE=2,e.TEXTURE_CUBIC_MODE=3,e.TEXTURE_PROJECTION_MODE=4,e.TEXTURE_SKYBOX_MODE=5,e.TEXTURE_INVCUBIC_MODE=6,e.TEXTURE_EQUIRECTANGULAR_MODE=7,e.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,e.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,e.SCALEMODE_FLOOR=1,e.SCALEMODE_NEAREST=2,e.SCALEMODE_CEILING=3,e._RescalePostProcessFactory=null,e._RenderPassIdCounter=0,e}(P);P.prototype.updateRawTexture=function(r,e,t,i,n,a,s){if(n===void 0&&(n=null),a===void 0&&(a=0),s===void 0&&(s=!1),!!r){var o=this._getRGBABufferInternalSizedFormat(a,t,s),u=this._getInternalFormat(t),l=this._getWebGLTextureType(a);this._bindTextureDirectly(this._gl.TEXTURE_2D,r,!0),this._unpackFlipY(i===void 0?!0:!!i),this._doNotHandleContextLost||(r._bufferView=e,r.format=t,r.type=a,r.invertY=i,r._compression=n),r.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[n],r.width,r.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,o,r.width,r.height,0,u,l,e),r.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),r.isReady=!0}};P.prototype.createRawTexture=function(r,e,t,i,n,a,s,o,u,l,h){o===void 0&&(o=null),u===void 0&&(u=0),h===void 0&&(h=!1);var c=new N(this,L.Raw);c.baseWidth=e,c.baseHeight=t,c.width=e,c.height=t,c.format=i,c.generateMipMaps=n,c.samplingMode=s,c.invertY=a,c._compression=o,c.type=u,c._useSRGBBuffer=this._getUseSRGBBuffer(h,!n),this._doNotHandleContextLost||(c._bufferView=r),this.updateRawTexture(c,r,i,a,o,u,c._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,c,!0);var _=this._getSamplingParameters(s,n);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,_.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,_.min),n&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(c),c};P.prototype.createRawCubeTexture=function(r,e,t,i,n,a,s,o){o===void 0&&(o=null);var u=this._gl,l=new N(this,L.CubeRaw);l.isCube=!0,l.format=t,l.type=i,this._doNotHandleContextLost||(l._bufferViewArray=r);var h=this._getWebGLTextureType(i),c=this._getInternalFormat(t);c===u.RGB&&(c=u.RGBA),h===u.FLOAT&&!this._caps.textureFloatLinearFiltering?(n=!1,s=1,I.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):h===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(n=!1,s=1,I.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):h===u.FLOAT&&!this._caps.textureFloatRender?(n=!1,I.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):h===u.HALF_FLOAT&&!this._caps.colorBufferFloat&&(n=!1,I.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));var _=e,d=_;l.width=_,l.height=d;var g=!this.needPOTTextures||ce.IsExponentOfTwo(l.width)&&ce.IsExponentOfTwo(l.height);g||(n=!1),r&&this.updateRawCubeTexture(l,r,t,i,a,o),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,l,!0),r&&n&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);var v=this._getSamplingParameters(s,n);return u.texParameteri(u.TEXTURE_CUBE_MAP,u.TEXTURE_MAG_FILTER,v.mag),u.texParameteri(u.TEXTURE_CUBE_MAP,u.TEXTURE_MIN_FILTER,v.min),u.texParameteri(u.TEXTURE_CUBE_MAP,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_CUBE_MAP,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),this._bindTextureDirectly(u.TEXTURE_CUBE_MAP,null),l.generateMipMaps=n,l.samplingMode=s,l};P.prototype.updateRawCubeTexture=function(r,e,t,i,n,a,s){a===void 0&&(a=null),s===void 0&&(s=0),r._bufferViewArray=e,r.format=t,r.type=i,r.invertY=n,r._compression=a;var o=this._gl,u=this._getWebGLTextureType(i),l=this._getInternalFormat(t),h=this._getRGBABufferInternalSizedFormat(i),c=!1;l===o.RGB&&(l=o.RGBA,c=!0),this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,r,!0),this._unpackFlipY(n===void 0?!0:!!n),r.width%4!==0&&o.pixelStorei(o.UNPACK_ALIGNMENT,1);for(var _=0;_<6;_++){var d=e[_];a?o.compressedTexImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+_,s,this.getCaps().s3tc[a],r.width,r.height,0,d):(c&&(d=tr(d,r.width,r.height,i)),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+_,s,h,r.width,r.height,0,l,u,d))}var g=!this.needPOTTextures||ce.IsExponentOfTwo(r.width)&&ce.IsExponentOfTwo(r.height);g&&r.generateMipMaps&&s===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),r.isReady=!0};P.prototype.createRawCubeTextureFromUrl=function(r,e,t,i,n,a,s,o,u,l,h,c){var _=this;u===void 0&&(u=null),l===void 0&&(l=null),h===void 0&&(h=3),c===void 0&&(c=!1);var d=this._gl,g=this.createRawCubeTexture(null,t,i,n,!a,c,h,null);e==null||e.addPendingData(g),g.url=r,this._internalTexturesCache.push(g);var v=function(m,E){e==null||e.removePendingData(g),l&&m&&l(m.status+" "+m.statusText,E)},p=function(m){var E=g.width,T=s(m);if(!!T){if(o){var R=_._getWebGLTextureType(n),y=_._getInternalFormat(i),C=_._getRGBABufferInternalSizedFormat(n),b=!1;y===d.RGB&&(y=d.RGBA,b=!0),_._bindTextureDirectly(d.TEXTURE_CUBE_MAP,g,!0),_._unpackFlipY(!1);for(var x=o(T),S=0;S<x.length;S++)for(var w=E>>S,A=0;A<6;A++){var U=x[S][A];b&&(U=tr(U,w,w,n)),d.texImage2D(A,S,C,w,w,0,y,R,U)}_._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null)}else _.updateRawCubeTexture(g,T,i,n,c);g.isReady=!0,e==null||e.removePendingData(g),g.onLoadedObservable.notifyObservers(g),g.onLoadedObservable.clear(),u&&u()}};return this._loadFile(r,function(m){p(m)},void 0,e==null?void 0:e.offlineProvider,!0,v),g};function tr(r,e,t,i){var n,a=1;i===1?n=new Float32Array(e*t*4):i===2?(n=new Uint16Array(e*t*4),a=15360):i===7?n=new Uint32Array(e*t*4):n=new Uint8Array(e*t*4);for(var s=0;s<e;s++)for(var o=0;o<t;o++){var u=(o*e+s)*3,l=(o*e+s)*4;n[l+0]=r[u+0],n[l+1]=r[u+1],n[l+2]=r[u+2],n[l+3]=a}return n}function rr(r){return function(e,t,i,n,a,s,o,u,l,h){l===void 0&&(l=null),h===void 0&&(h=0);var c=r?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,_=r?L.Raw3D:L.Raw2DArray,d=new N(this,_);d.baseWidth=t,d.baseHeight=i,d.baseDepth=n,d.width=t,d.height=i,d.depth=n,d.format=a,d.type=h,d.generateMipMaps=s,d.samplingMode=u,r?d.is3D=!0:d.is2DArray=!0,this._doNotHandleContextLost||(d._bufferView=e),r?this.updateRawTexture3D(d,e,a,o,l,h):this.updateRawTexture2DArray(d,e,a,o,l,h),this._bindTextureDirectly(c,d,!0);var g=this._getSamplingParameters(u,s);return this._gl.texParameteri(c,this._gl.TEXTURE_MAG_FILTER,g.mag),this._gl.texParameteri(c,this._gl.TEXTURE_MIN_FILTER,g.min),s&&this._gl.generateMipmap(c),this._bindTextureDirectly(c,null),this._internalTexturesCache.push(d),d}}P.prototype.createRawTexture2DArray=rr(!1);P.prototype.createRawTexture3D=rr(!0);function ir(r){return function(e,t,i,n,a,s){a===void 0&&(a=null),s===void 0&&(s=0);var o=r?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,u=this._getWebGLTextureType(s),l=this._getInternalFormat(i),h=this._getRGBABufferInternalSizedFormat(s,i);this._bindTextureDirectly(o,e,!0),this._unpackFlipY(n===void 0?!0:!!n),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=n,e._compression=a),e.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),a&&t?this._gl.compressedTexImage3D(o,0,this.getCaps().s3tc[a],e.width,e.height,e.depth,0,t):this._gl.texImage3D(o,0,h,e.width,e.height,e.depth,0,l,u,t),e.generateMipMaps&&this._gl.generateMipmap(o),this._bindTextureDirectly(o,null),e.isReady=!0}}P.prototype.updateRawTexture2DArray=ir(!1);P.prototype.updateRawTexture3D=ir(!0);var ot=function(){function r(e,t,i,n){this._textures=null,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this._isMulti=e,this._isCube=t,this._size=i,this._engine=n,this._depthStencilTexture=null}return Object.defineProperty(r.prototype,"depthStencilTexture",{get:function(){return this._depthStencilTexture},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"depthStencilTextureWithStencil",{get:function(){return this._depthStencilTextureWithStencil},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isCube",{get:function(){return this._isCube},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isMulti",{get:function(){return this._isMulti},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"is2DArray",{get:function(){return this.layers>0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"size",{get:function(){return this.width},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"width",{get:function(){return this._size.width||this._size},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this._size.height||this._size},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"layers",{get:function(){return this._size.layers||0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"texture",{get:function(){var e,t;return(t=(e=this._textures)===null||e===void 0?void 0:e[0])!==null&&t!==void 0?t:null},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"textures",{get:function(){return this._textures},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"samples",{get:function(){var e,t;return(t=(e=this.texture)===null||e===void 0?void 0:e.samples)!==null&&t!==void 0?t:1},enumerable:!1,configurable:!0}),r.prototype.setSamples=function(e,t,i){return t===void 0&&(t=!0),i===void 0&&(i=!1),this.samples===e&&!i?e:this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e)},r.prototype.setTextures=function(e){Array.isArray(e)?this._textures=e:e?this._textures=[e]:this._textures=null},r.prototype.setTexture=function(e,t,i){t===void 0&&(t=0),i===void 0&&(i=!0),this._textures||(this._textures=[]),this._textures[t]&&i&&this._textures[t].dispose(),this._textures[t]=e},r.prototype.createDepthStencilTexture=function(e,t,i,n,a){var s;return e===void 0&&(e=0),t===void 0&&(t=!0),i===void 0&&(i=!1),n===void 0&&(n=1),a===void 0&&(a=14),(s=this._depthStencilTexture)===null||s===void 0||s.dispose(),this._depthStencilTextureWithStencil=i,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:i,isCube:this._isCube,samples:n,depthTextureFormat:a},this),this._depthStencilTexture},r.prototype._shareDepth=function(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,this._depthStencilTexture.incrementReferences())},r.prototype._swapAndDie=function(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)},r.prototype._cloneRenderTargetWrapper=function(){var e,t,i,n,a,s,o=null;if(this._isMulti){var u=this.textures;if(u&&u.length>0){var l=!1,h=u.length,c=u[u.length-1]._source;(c===L.Depth||c===L.DepthStencil)&&(l=!0,h--);for(var _=[],d=[],g=0;g<h;++g){var v=u[g];_.push(v.samplingMode),d.push(v.type)}var p={samplingModes:_,generateMipMaps:u[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:l,types:d,textureCount:h},m={width:this.width,height:this.height};o=this._engine.createMultipleRenderTarget(m,p)}}else{var E={};if(E.generateDepthBuffer=this._generateDepthBuffer,E.generateMipMaps=(t=(e=this.texture)===null||e===void 0?void 0:e.generateMipMaps)!==null&&t!==void 0?t:!1,E.generateStencilBuffer=this._generateStencilBuffer,E.samplingMode=(i=this.texture)===null||i===void 0?void 0:i.samplingMode,E.type=(n=this.texture)===null||n===void 0?void 0:n.type,E.format=(a=this.texture)===null||a===void 0?void 0:a.format,this.isCube)o=this._engine.createRenderTargetCubeTexture(this.width,E);else{var m={width:this.width,height:this.height,layers:this.is2DArray?(s=this.texture)===null||s===void 0?void 0:s.depth:void 0};o=this._engine.createRenderTargetTexture(m,E)}o.texture.isReady=!0}return o},r.prototype._swapRenderTargetWrapper=function(e){if(this._textures&&e._textures)for(var t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null},r.prototype._rebuild=function(){var e=this._cloneRenderTargetWrapper();if(!!e){if(this._depthStencilTexture){var t=this._depthStencilTexture.samplingMode,i=t===2||t===3||t===11;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,i,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}},r.prototype.releaseTextures=function(){var e,t;if(this._textures)for(var i=0;(t=i<((e=this._textures)===null||e===void 0?void 0:e.length))!==null&&t!==void 0&&t;++i)this._textures[i].dispose();this._textures=null},r.prototype.dispose=function(e){var t;e===void 0&&(e=!1),e||((t=this._depthStencilTexture)===null||t===void 0||t.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)},r}(),kr=function(r){J(e,r);function e(t,i,n,a,s){var o=r.call(this,t,i,n,a)||this;return o._framebuffer=null,o._depthStencilBuffer=null,o._MSAAFramebuffer=null,o._colorTextureArray=null,o._depthStencilTextureArray=null,o._context=s,o}return e.prototype._cloneRenderTargetWrapper=function(){var t=null;return this._colorTextureArray&&this._depthStencilTextureArray?(t=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),t.texture.isReady=!0):t=r.prototype._cloneRenderTargetWrapper.call(this),t},e.prototype._swapRenderTargetWrapper=function(t){r.prototype._swapRenderTargetWrapper.call(this,t),t._framebuffer=this._framebuffer,t._depthStencilBuffer=this._depthStencilBuffer,t._MSAAFramebuffer=this._MSAAFramebuffer,t._colorTextureArray=this._colorTextureArray,t._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null},e.prototype._shareDepth=function(t){r.prototype._shareDepth.call(this,t);var i=this._context,n=this._depthStencilBuffer,a=t._framebuffer;t._depthStencilBuffer&&i.deleteRenderbuffer(t._depthStencilBuffer),t._depthStencilBuffer=this._depthStencilBuffer,this._engine._bindUnboundFramebuffer(a),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,n),this._engine._bindUnboundFramebuffer(null)},e.prototype._bindTextureRenderTarget=function(t,i,n,a){if(i===void 0&&(i=0),n===void 0&&(n=-1),a===void 0&&(a=0),!!t._hardwareTexture){var s=this._context,o=this._framebuffer,u=this._engine._currentFramebuffer;this._engine._bindUnboundFramebuffer(o);var l=s[this._engine.webGLVersion>1?"COLOR_ATTACHMENT"+i:"COLOR_ATTACHMENT"+i+"_WEBGL"],h=n!==-1?s.TEXTURE_CUBE_MAP_POSITIVE_X+n:s.TEXTURE_2D;s.framebufferTexture2D(s.FRAMEBUFFER,l,h,t._hardwareTexture.underlyingResource,a),this._engine._bindUnboundFramebuffer(u)}},e.prototype.setTexture=function(t,i,n){i===void 0&&(i=0),n===void 0&&(n=!0),r.prototype.setTexture.call(this,t,i,n),this._bindTextureRenderTarget(t,i)},e.prototype.dispose=function(t){t===void 0&&(t=!1);var i=this._context;t||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(i.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(i.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(i.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),r.prototype.dispose.call(this,t)},e}(ot);P.prototype._createHardwareRenderTargetWrapper=function(r,e,t){var i=new kr(r,e,t,this,this._gl);return this._renderTargetWrapperCache.push(i),i};P.prototype.createRenderTargetTexture=function(r,e){var t=this._createHardwareRenderTargetWrapper(!1,!1,r),i={};e!==void 0&&typeof e=="object"?(i.generateDepthBuffer=!!e.generateDepthBuffer,i.generateStencilBuffer=!!e.generateStencilBuffer,i.noColorTarget=!!e.noColorTarget):(i.generateDepthBuffer=!0,i.generateStencilBuffer=!1,i.noColorTarget=!1);var n=i.noColorTarget?null:this._createInternalTexture(r,e,!0,L.RenderTarget),a=r.width||r,s=r.height||r,o=this._currentFramebuffer,u=this._gl,l=u.createFramebuffer();return this._bindUnboundFramebuffer(l),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(!!i.generateStencilBuffer,i.generateDepthBuffer,a,s),n&&!n.is2DArray&&u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_2D,n._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(o),t._framebuffer=l,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=!!i.generateStencilBuffer,t.setTextures(n),t};P.prototype.createDepthStencilTexture=function(r,e,t){if(e.isCube){var i=r.width||r;return this._createDepthStencilCubeTexture(i,e,t)}else return this._createDepthStencilTexture(r,e,t)};P.prototype._createDepthStencilTexture=function(r,e,t){var i=this._gl,n=r.layers||0,a=n!==0?i.TEXTURE_2D_ARRAY:i.TEXTURE_2D,s=new N(this,L.DepthStencil);if(!this._caps.depthTextureExtension)return I.Error("Depth texture is not supported by your browser or hardware."),s;var o=se({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},e);if(this._bindTextureDirectly(a,s,!0),this._setupDepthStencilTexture(s,r,o.generateStencil,o.comparisonFunction===0?!1:o.bilinearFiltering,o.comparisonFunction),o.depthTextureFormat!==void 0){if(o.depthTextureFormat!==15&&o.depthTextureFormat!==16&&o.depthTextureFormat!==17&&o.depthTextureFormat!==13&&o.depthTextureFormat!==14&&o.depthTextureFormat!==18)return I.Error("Depth texture format is not supported."),s;s.format=o.depthTextureFormat}else s.format=o.generateStencil?13:16;var u=s.format===17||s.format===13||s.format===18;t._depthStencilTexture=s,t._depthStencilTextureWithStencil=u;var l=i.UNSIGNED_INT;s.format===15?l=i.UNSIGNED_SHORT:s.format===17||s.format===13?l=i.UNSIGNED_INT_24_8:s.format===14?l=i.FLOAT:s.format===18&&(l=i.FLOAT_32_UNSIGNED_INT_24_8_REV);var h=u?i.DEPTH_STENCIL:i.DEPTH_COMPONENT,c=h;this.webGLVersion>1&&(s.format===15?c=i.DEPTH_COMPONENT16:s.format===16?c=i.DEPTH_COMPONENT24:s.format===17||s.format===13?c=i.DEPTH24_STENCIL8:s.format===14?c=i.DEPTH_COMPONENT32F:s.format===18&&(c=i.DEPTH32F_STENCIL8)),s.is2DArray?i.texImage3D(a,0,c,s.width,s.height,n,0,h,l,null):i.texImage2D(a,0,c,s.width,s.height,0,h,l,null),this._bindTextureDirectly(a,null),this._internalTexturesCache.push(s);var _=t;if(_._depthStencilBuffer){var d=this._currentFramebuffer;this._bindUnboundFramebuffer(_._framebuffer),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.STENCIL_ATTACHMENT,i.RENDERBUFFER,null),this._bindUnboundFramebuffer(d),i.deleteRenderbuffer(_._depthStencilBuffer),_._depthStencilBuffer=null}return s};P.prototype.updateRenderTargetTextureSampleCount=function(r,e){if(this.webGLVersion<2||!r||!r.texture)return 1;if(r.samples===e)return e;var t=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),r._depthStencilBuffer&&(t.deleteRenderbuffer(r._depthStencilBuffer),r._depthStencilBuffer=null),r._MSAAFramebuffer&&(t.deleteFramebuffer(r._MSAAFramebuffer),r._MSAAFramebuffer=null);var i=r.texture._hardwareTexture;if(i._MSAARenderBuffer&&(t.deleteRenderbuffer(i._MSAARenderBuffer),i._MSAARenderBuffer=null),e>1&&t.renderbufferStorageMultisample){var n=t.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");r._MSAAFramebuffer=n,this._bindUnboundFramebuffer(r._MSAAFramebuffer);var a=this._createRenderBuffer(r.texture.width,r.texture.height,e,-1,this._getRGBAMultiSampleBufferFormat(r.texture.type),t.COLOR_ATTACHMENT0,!1);if(!a)throw new Error("Unable to create multi sampled framebuffer");i._MSAARenderBuffer=a}else this._bindUnboundFramebuffer(r._framebuffer);return r.texture.samples=e,r._depthStencilBuffer=this._setupFramebufferDepthAttachments(r._generateStencilBuffer,r._generateDepthBuffer,r.texture.width,r.texture.height,e),this._bindUnboundFramebuffer(null),e};P.prototype.createRenderTargetCubeTexture=function(r,e){var t=this._createHardwareRenderTargetWrapper(!1,!0,r),i=se({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5},e);i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,(i.type===1&&!this._caps.textureFloatLinearFiltering||i.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(i.samplingMode=1);var n=this._gl,a=new N(this,L.RenderTarget);this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,a,!0);var s=this._getSamplingParameters(i.samplingMode,i.generateMipMaps);i.type===1&&!this._caps.textureFloat&&(i.type=0,I.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MAG_FILTER,s.mag),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MIN_FILTER,s.min),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);for(var o=0;o<6;o++)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+o,0,this._getRGBABufferInternalSizedFormat(i.type,i.format),r,r,0,this._getInternalFormat(i.format),this._getWebGLTextureType(i.type),null);var u=n.createFramebuffer();return this._bindUnboundFramebuffer(u),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(i.generateStencilBuffer,i.generateDepthBuffer,r,r),i.generateMipMaps&&n.generateMipmap(n.TEXTURE_CUBE_MAP),this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),t._framebuffer=u,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer,a.width=r,a.height=r,a.isReady=!0,a.isCube=!0,a.samples=1,a.generateMipMaps=i.generateMipMaps,a.samplingMode=i.samplingMode,a.type=i.type,a.format=i.format,this._internalTexturesCache.push(a),t.setTextures(a),t};F.prototype.createMultiviewRenderTargetTexture=function(r,e){var t=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";var i=this._createHardwareRenderTargetWrapper(!1,!1,{width:r,height:e});i._framebuffer=t.createFramebuffer();var n=new N(this,L.Unknown,!0);return n.width=r,n.height=e,n.isMultiview=!0,i._colorTextureArray=t.createTexture(),t.bindTexture(t.TEXTURE_2D_ARRAY,i._colorTextureArray),t.texStorage3D(t.TEXTURE_2D_ARRAY,1,t.RGBA8,r,e,2),i._depthStencilTextureArray=t.createTexture(),t.bindTexture(t.TEXTURE_2D_ARRAY,i._depthStencilTextureArray),t.texStorage3D(t.TEXTURE_2D_ARRAY,1,t.DEPTH24_STENCIL8,r,e,2),n.isReady=!0,i.setTextures(n),i._depthStencilTexture=n,i};F.prototype.bindMultiviewFramebuffer=function(r){var e=r,t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)this.getCaps().oculusMultiview?(i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,e.samples,0,2),i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,e.samples,0,2)):(i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,0,2));else throw"Invalid multiview frame buffer"};Tt.prototype._useMultiviewToSingleView=!1;Tt.prototype._multiviewTexture=null;Tt.prototype._resizeOrCreateMultiviewTexture=function(r,e){this._multiviewTexture?(this._multiviewTexture.getRenderWidth()!=r||this._multiviewTexture.getRenderHeight()!=e)&&(this._multiviewTexture.dispose(),this._multiviewTexture=new Ct(this.getScene(),{width:r,height:e})):this._multiviewTexture=new Ct(this.getScene(),{width:r,height:e})};function nr(r,e){var t=new Oe(r,void 0,!0,e);return t.addUniform("viewProjection",16),t.addUniform("viewProjectionR",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}var Yr=De.prototype.createSceneUniformBuffer;De.prototype._transformMatrixR=Fr.Zero();De.prototype._multiviewSceneUbo=null;De.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=nr(this.getEngine(),"scene_multiview")};De.prototype.createSceneUniformBuffer=function(r){return this._multiviewSceneUbo?nr(this.getEngine(),r):Yr.bind(this)(r)};De.prototype._updateMultiviewUbo=function(r,e){r&&e&&r.multiplyToRef(e,this._transformMatrixR),r&&e&&(r.multiplyToRef(e,xt.Matrix[0]),Ur.GetRightPlaneToRef(xt.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))};De.prototype._renderMultiviewToSingleView=function(r){r._resizeOrCreateMultiviewTexture(r._rigPostProcess&&r._rigPostProcess&&r._rigPostProcess.width>0?r._rigPostProcess.width:this.getEngine().getRenderWidth(!0),r._rigPostProcess&&r._rigPostProcess&&r._rigPostProcess.height>0?r._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),r.outputRenderTarget=r._multiviewTexture,this._renderForCamera(r),r.outputRenderTarget=null;for(var e=0;e<r._rigCameras.length;e++){var t=this.getEngine();this._activeCamera=r._rigCameras[e],t.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};Object.defineProperty(F.prototype,"isInVRExclusivePointerMode",{get:function(){return this._vrExclusivePointerMode},enumerable:!0,configurable:!0});F.prototype._prepareVRComponent=function(){this._vrSupported=!1,this._vrExclusivePointerMode=!1,this.onVRDisplayChangedObservable=new ee,this.onVRRequestPresentComplete=new ee,this.onVRRequestPresentStart=new ee};F.prototype.isVRDevicePresent=function(){return!!this._vrDisplay};F.prototype.getVRDevice=function(){return this._vrDisplay};F.prototype.initWebVR=function(){return this.initWebVRAsync(),this.onVRDisplayChangedObservable};F.prototype.initWebVRAsync=function(){var r=this,e=function(){var i={vrDisplay:r._vrDisplay,vrSupported:r._vrSupported};r.onVRDisplayChangedObservable.notifyObservers(i),r._webVRInitPromise=new Promise(function(n){n(i)})};if(!this._onVrDisplayConnect){this._onVrDisplayConnect=function(i){r._vrDisplay=i.display,e()},this._onVrDisplayDisconnect=function(){r._vrDisplay.cancelAnimationFrame(r._frameHandler),r._vrDisplay=void 0,r._frameHandler=F.QueueNewFrame(r._boundRenderFunction),e()},this._onVrDisplayPresentChange=function(){r._vrExclusivePointerMode=r._vrDisplay&&r._vrDisplay.isPresenting};var t=this.getHostWindow();t&&(t.addEventListener("vrdisplayconnect",this._onVrDisplayConnect),t.addEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),t.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange))}return this._webVRInitPromise=this._webVRInitPromise||this._getVRDisplaysAsync(),this._webVRInitPromise.then(e),this._webVRInitPromise};F.prototype._getVRDisplaysAsync=function(){var r=this;return new Promise(function(e){navigator.getVRDisplays?navigator.getVRDisplays().then(function(t){r._vrSupported=!0,r._vrDisplay=t[0],e({vrDisplay:r._vrDisplay,vrSupported:r._vrSupported})}):(r._vrDisplay=void 0,r._vrSupported=!1,e({vrDisplay:r._vrDisplay,vrSupported:r._vrSupported}))})};F.prototype.enableVR=function(r){var e=this;if(this._vrDisplay&&!this._vrDisplay.isPresenting){var t=function(){e.onVRRequestPresentComplete.notifyObservers(!0),e._onVRFullScreenTriggered()},i=function(){e.onVRRequestPresentComplete.notifyObservers(!1)};this.onVRRequestPresentStart.notifyObservers(this);var n={highRefreshRate:this.vrPresentationAttributes?this.vrPresentationAttributes.highRefreshRate:!1,foveationLevel:this.vrPresentationAttributes?this.vrPresentationAttributes.foveationLevel:1,multiview:(this.getCaps().multiview||this.getCaps().oculusMultiview)&&r.useMultiview};this._vrDisplay.requestPresent([se({source:this.getRenderingCanvas(),attributes:n},n)]).then(t).catch(i)}};F.prototype._onVRFullScreenTriggered=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting){this._oldSize=new Ir(this.getRenderWidth(),this.getRenderHeight()),this._oldHardwareScaleFactor=this.getHardwareScalingLevel();var r=this._vrDisplay.getEyeParameters("left");this.setHardwareScalingLevel(1),this.setSize(r.renderWidth*2,r.renderHeight)}else this.setHardwareScalingLevel(this._oldHardwareScaleFactor),this.setSize(this._oldSize.width,this._oldSize.height)};F.prototype.disableVR=function(){var r=this;this._vrDisplay&&this._vrDisplay.isPresenting&&this._vrDisplay.exitPresent().then(function(){return r._onVRFullScreenTriggered()}).catch(function(){return r._onVRFullScreenTriggered()}),ae()&&(window.removeEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted),window.removeEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted),this._onVrDisplayConnect&&(window.removeEventListener("vrdisplayconnect",this._onVrDisplayConnect),this._onVrDisplayDisconnect&&window.removeEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),this._onVrDisplayPresentChange&&window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange),this._onVrDisplayConnect=null,this._onVrDisplayDisconnect=null))};F.prototype._connectVREvents=function(r,e){var t=this;if(this._onVRDisplayPointerRestricted=function(){r&&r.requestPointerLock()},this._onVRDisplayPointerUnrestricted=function(){if(!e){var n=t.getHostWindow();n.document&&n.document.exitPointerLock&&n.document.exitPointerLock();return}!e.exitPointerLock||e.exitPointerLock()},ae()){var i=this.getHostWindow();i.addEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted,!1),i.addEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted,!1)}};F.prototype._submitVRFrame=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting)try{this._vrDisplay.submitFrame()}catch(r){ce.Warn("webVR submitFrame has had an unexpected failure: "+r)}};F.prototype.isVRPresenting=function(){return this._vrDisplay&&this._vrDisplay.isPresenting};F.prototype._requestVRFrame=function(){this._frameHandler=F.QueueNewFrame(this._boundRenderFunction,this._vrDisplay)};P.prototype.createDynamicTexture=function(r,e,t,i){var n=new N(this,L.Dynamic);return n.baseWidth=r,n.baseHeight=e,t&&(r=this.needPOTTextures?P.GetExponentOfTwo(r,this._caps.maxTextureSize):r,e=this.needPOTTextures?P.GetExponentOfTwo(e,this._caps.maxTextureSize):e),n.width=r,n.height=e,n.isReady=!1,n.generateMipMaps=t,n.samplingMode=i,this.updateTextureSamplingMode(i,n),this._internalTexturesCache.push(n),n};P.prototype.updateDynamicTexture=function(r,e,t,i,n,a,s){if(i===void 0&&(i=!1),a===void 0&&(a=!1),!!r){var o=this._gl,u=o.TEXTURE_2D,l=this._bindTextureDirectly(u,r,!0,a);this._unpackFlipY(t===void 0?r.invertY:t),i&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);var h=this._getWebGLTextureType(r.type),c=this._getInternalFormat(n||r.format),_=this._getRGBABufferInternalSizedFormat(r.type,c);o.texImage2D(u,0,_,c,h,e),r.generateMipMaps&&o.generateMipmap(u),l||this._bindTextureDirectly(u,null),i&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),r.isReady=!0}};var pe;(function(r){r[r.Texture=0]="Texture",r[r.StorageTexture=1]="StorageTexture",r[r.UniformBuffer=2]="UniformBuffer",r[r.StorageBuffer=3]="StorageBuffer",r[r.TextureWithoutSampler=4]="TextureWithoutSampler",r[r.Sampler=5]="Sampler"})(pe||(pe={}));P.prototype.createComputeEffect=function(r,e){throw new Error("createComputeEffect: This engine does not support compute shaders!")};P.prototype.createComputePipelineContext=function(){throw new Error("createComputePipelineContext: This engine does not support compute shaders!")};P.prototype.createComputeContext=function(){};P.prototype.computeDispatch=function(r,e,t,i,n,a,s){throw new Error("computeDispatch: This engine does not support compute shaders!")};P.prototype.areAllComputeEffectsReady=function(){return!0};P.prototype.releaseComputeEffects=function(){};P.prototype._prepareComputePipelineContext=function(r,e,t,i,n){};P.prototype._rebuildComputeEffects=function(){};P.prototype._executeWhenComputeStateIsCompiled=function(r,e){e()};P.prototype._releaseComputeEffect=function(r){};P.prototype._deleteComputePipelineContext=function(r){};var tn=function(){function r(){}return r.ALPHA_DISABLE=0,r.ALPHA_ADD=1,r.ALPHA_COMBINE=2,r.ALPHA_SUBTRACT=3,r.ALPHA_MULTIPLY=4,r.ALPHA_MAXIMIZED=5,r.ALPHA_ONEONE=6,r.ALPHA_PREMULTIPLIED=7,r.ALPHA_PREMULTIPLIED_PORTERDUFF=8,r.ALPHA_INTERPOLATE=9,r.ALPHA_SCREENMODE=10,r.ALPHA_ONEONE_ONEONE=11,r.ALPHA_ALPHATOCOLOR=12,r.ALPHA_REVERSEONEMINUS=13,r.ALPHA_SRC_DSTONEMINUSSRCALPHA=14,r.ALPHA_ONEONE_ONEZERO=15,r.ALPHA_EXCLUSION=16,r.ALPHA_LAYER_ACCUMULATE=17,r.ALPHA_EQUATION_ADD=0,r.ALPHA_EQUATION_SUBSTRACT=1,r.ALPHA_EQUATION_REVERSE_SUBTRACT=2,r.ALPHA_EQUATION_MAX=3,r.ALPHA_EQUATION_MIN=4,r.ALPHA_EQUATION_DARKEN=5,r.DELAYLOADSTATE_NONE=0,r.DELAYLOADSTATE_LOADED=1,r.DELAYLOADSTATE_LOADING=2,r.DELAYLOADSTATE_NOTLOADED=4,r.NEVER=512,r.ALWAYS=519,r.LESS=513,r.EQUAL=514,r.LEQUAL=515,r.GREATER=516,r.GEQUAL=518,r.NOTEQUAL=517,r.KEEP=7680,r.ZERO=0,r.REPLACE=7681,r.INCR=7682,r.DECR=7683,r.INVERT=5386,r.INCR_WRAP=34055,r.DECR_WRAP=34056,r.TEXTURE_CLAMP_ADDRESSMODE=0,r.TEXTURE_WRAP_ADDRESSMODE=1,r.TEXTURE_MIRROR_ADDRESSMODE=2,r.TEXTURE_CREATIONFLAG_STORAGE=1,r.TEXTUREFORMAT_ALPHA=0,r.TEXTUREFORMAT_LUMINANCE=1,r.TEXTUREFORMAT_LUMINANCE_ALPHA=2,r.TEXTUREFORMAT_RGB=4,r.TEXTUREFORMAT_RGBA=5,r.TEXTUREFORMAT_RED=6,r.TEXTUREFORMAT_R=6,r.TEXTUREFORMAT_RG=7,r.TEXTUREFORMAT_RED_INTEGER=8,r.TEXTUREFORMAT_R_INTEGER=8,r.TEXTUREFORMAT_RG_INTEGER=9,r.TEXTUREFORMAT_RGB_INTEGER=10,r.TEXTUREFORMAT_RGBA_INTEGER=11,r.TEXTUREFORMAT_BGRA=12,r.TEXTUREFORMAT_DEPTH24_STENCIL8=13,r.TEXTUREFORMAT_DEPTH32_FLOAT=14,r.TEXTUREFORMAT_DEPTH16=15,r.TEXTUREFORMAT_DEPTH24=16,r.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17,r.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18,r.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493,r.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495,r.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777,r.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917,r.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916,r.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840,r.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196,r.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493,r.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494,r.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495,r.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497,r.TEXTURETYPE_UNSIGNED_BYTE=0,r.TEXTURETYPE_UNSIGNED_INT=0,r.TEXTURETYPE_FLOAT=1,r.TEXTURETYPE_HALF_FLOAT=2,r.TEXTURETYPE_BYTE=3,r.TEXTURETYPE_SHORT=4,r.TEXTURETYPE_UNSIGNED_SHORT=5,r.TEXTURETYPE_INT=6,r.TEXTURETYPE_UNSIGNED_INTEGER=7,r.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,r.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,r.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,r.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,r.TEXTURETYPE_UNSIGNED_INT_24_8=12,r.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,r.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,r.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,r.TEXTURETYPE_UNDEFINED=16,r.TEXTURE_NEAREST_SAMPLINGMODE=1,r.TEXTURE_NEAREST_NEAREST=1,r.TEXTURE_BILINEAR_SAMPLINGMODE=2,r.TEXTURE_LINEAR_LINEAR=2,r.TEXTURE_TRILINEAR_SAMPLINGMODE=3,r.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,r.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,r.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,r.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,r.TEXTURE_NEAREST_LINEAR=7,r.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,r.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,r.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,r.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,r.TEXTURE_LINEAR_NEAREST=12,r.TEXTURE_EXPLICIT_MODE=0,r.TEXTURE_SPHERICAL_MODE=1,r.TEXTURE_PLANAR_MODE=2,r.TEXTURE_CUBIC_MODE=3,r.TEXTURE_PROJECTION_MODE=4,r.TEXTURE_SKYBOX_MODE=5,r.TEXTURE_INVCUBIC_MODE=6,r.TEXTURE_EQUIRECTANGULAR_MODE=7,r.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,r.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,r.TEXTURE_FILTERING_QUALITY_OFFLINE=4096,r.TEXTURE_FILTERING_QUALITY_HIGH=64,r.TEXTURE_FILTERING_QUALITY_MEDIUM=16,r.TEXTURE_FILTERING_QUALITY_LOW=8,r.SCALEMODE_FLOOR=1,r.SCALEMODE_NEAREST=2,r.SCALEMODE_CEILING=3,r.MATERIAL_TextureDirtyFlag=1,r.MATERIAL_LightDirtyFlag=2,r.MATERIAL_FresnelDirtyFlag=4,r.MATERIAL_AttributesDirtyFlag=8,r.MATERIAL_MiscDirtyFlag=16,r.MATERIAL_PrePassDirtyFlag=32,r.MATERIAL_AllDirtyFlag=63,r.MATERIAL_TriangleFillMode=0,r.MATERIAL_WireFrameFillMode=1,r.MATERIAL_PointFillMode=2,r.MATERIAL_PointListDrawMode=3,r.MATERIAL_LineListDrawMode=4,r.MATERIAL_LineLoopDrawMode=5,r.MATERIAL_LineStripDrawMode=6,r.MATERIAL_TriangleStripDrawMode=7,r.MATERIAL_TriangleFanDrawMode=8,r.MATERIAL_ClockWiseSideOrientation=0,r.MATERIAL_CounterClockWiseSideOrientation=1,r.ACTION_NothingTrigger=0,r.ACTION_OnPickTrigger=1,r.ACTION_OnLeftPickTrigger=2,r.ACTION_OnRightPickTrigger=3,r.ACTION_OnCenterPickTrigger=4,r.ACTION_OnPickDownTrigger=5,r.ACTION_OnDoublePickTrigger=6,r.ACTION_OnPickUpTrigger=7,r.ACTION_OnPickOutTrigger=16,r.ACTION_OnLongPressTrigger=8,r.ACTION_OnPointerOverTrigger=9,r.ACTION_OnPointerOutTrigger=10,r.ACTION_OnEveryFrameTrigger=11,r.ACTION_OnIntersectionEnterTrigger=12,r.ACTION_OnIntersectionExitTrigger=13,r.ACTION_OnKeyDownTrigger=14,r.ACTION_OnKeyUpTrigger=15,r.PARTICLES_BILLBOARDMODE_Y=2,r.PARTICLES_BILLBOARDMODE_ALL=7,r.PARTICLES_BILLBOARDMODE_STRETCHED=8,r.MESHES_CULLINGSTRATEGY_STANDARD=0,r.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,r.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,r.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,r.SCENELOADER_NO_LOGGING=0,r.SCENELOADER_MINIMAL_LOGGING=1,r.SCENELOADER_SUMMARY_LOGGING=2,r.SCENELOADER_DETAILED_LOGGING=3,r.PREPASS_IRRADIANCE_TEXTURE_TYPE=0,r.PREPASS_POSITION_TEXTURE_TYPE=1,r.PREPASS_VELOCITY_TEXTURE_TYPE=2,r.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3,r.PREPASS_COLOR_TEXTURE_TYPE=4,r.PREPASS_DEPTH_TEXTURE_TYPE=5,r.PREPASS_NORMAL_TEXTURE_TYPE=6,r.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7,r.BUFFER_CREATIONFLAG_READ=1,r.BUFFER_CREATIONFLAG_WRITE=2,r.BUFFER_CREATIONFLAG_READWRITE=3,r.BUFFER_CREATIONFLAG_UNIFORM=4,r.BUFFER_CREATIONFLAG_VERTEX=8,r.BUFFER_CREATIONFLAG_INDEX=16,r.BUFFER_CREATIONFLAG_STORAGE=32,r.RENDERPASS_MAIN=0,r.INPUT_ALT_KEY=18,r.INPUT_CTRL_KEY=17,r.INPUT_META_KEY1=91,r.INPUT_META_KEY2=92,r.INPUT_META_KEY3=93,r.INPUT_SHIFT_KEY=16,r.SNAPSHOTRENDERING_STANDARD=0,r.SNAPSHOTRENDERING_FAST=1,r.PERSPECTIVE_CAMERA=0,r.ORTHOGRAPHIC_CAMERA=1,r.FOVMODE_VERTICAL_FIXED=0,r.FOVMODE_HORIZONTAL_FIXED=1,r.RIG_MODE_NONE=0,r.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,r.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,r.RIG_MODE_STEREOSCOPIC_INTERLACED=14,r.RIG_MODE_VR=20,r.RIG_MODE_WEBVR=21,r.RIG_MODE_CUSTOM=22,r.MAX_SUPPORTED_UV_SETS=6,r.GL_ALPHA_EQUATION_ADD=32774,r.GL_ALPHA_EQUATION_MIN=32775,r.GL_ALPHA_EQUATION_MAX=32776,r.GL_ALPHA_EQUATION_SUBTRACT=32778,r.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779,r.GL_ALPHA_FUNCTION_SRC=768,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769,r.GL_ALPHA_FUNCTION_SRC_ALPHA=770,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771,r.GL_ALPHA_FUNCTION_DST_ALPHA=772,r.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773,r.GL_ALPHA_FUNCTION_DST_COLOR=774,r.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775,r.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776,r.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769,r.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770,r.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771,r.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772,r.SnippetUrl="https://snippet.babylonjs.com",r}(),Qr=function(){function r(){this.renderWidth=512,this.renderHeight=256,this.textureSize=512,this.deterministicLockstep=!1,this.lockstepMaxSteps=4}return r}();(function(r){J(e,r);function e(t){t===void 0&&(t=new Qr);var i=r.call(this,null)||this;F.Instances.push(i),t.deterministicLockstep===void 0&&(t.deterministicLockstep=!1),t.lockstepMaxSteps===void 0&&(t.lockstepMaxSteps=4),i._options=t,Rt.SetMatrixPrecision(!!t.useHighPrecisionMatrix),i._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:512,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!1,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:0,uintIndices:!1,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,textureFloat:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloat:!1,textureHalfFloatLinearFiltering:!1,textureHalfFloatRender:!1,textureLOD:!1,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!1,instancedArrays:!1,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,maxMSAASamples:1,blendMinMax:!1,canUseGLInstanceID:!1,canUseGLVertexID:!1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:128},i._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!1,supportSSAO2:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,_collectUbosUpdatedInFrame:!1},I.Log("Babylon.js v".concat(F.Version," - Null engine"));var n=typeof self!="undefined"?self:typeof global!="undefined"?global:window;return typeof URL=="undefined"&&(n.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),typeof Blob=="undefined"&&(n.Blob=function(){}),i}return e.prototype.isDeterministicLockStep=function(){return this._options.deterministicLockstep},e.prototype.getLockstepMaxSteps=function(){return this._options.lockstepMaxSteps},e.prototype.getHardwareScalingLevel=function(){return 1},e.prototype.createVertexBuffer=function(t){var i=new $e;return i.references=1,i},e.prototype.createIndexBuffer=function(t){var i=new $e;return i.references=1,i},e.prototype.clear=function(t,i,n,a){},e.prototype.getRenderWidth=function(t){return t===void 0&&(t=!1),!t&&this._currentRenderTarget?this._currentRenderTarget.width:this._options.renderWidth},e.prototype.getRenderHeight=function(t){return t===void 0&&(t=!1),!t&&this._currentRenderTarget?this._currentRenderTarget.height:this._options.renderHeight},e.prototype.setViewport=function(t,i,n){this._cachedViewport=t},e.prototype.createShaderProgram=function(t,i,n,a,s){return{__SPECTOR_rebuildProgram:null}},e.prototype.getUniforms=function(t,i){return[]},e.prototype.getAttributes=function(t,i){return[]},e.prototype.bindSamplers=function(t){this._currentEffect=null},e.prototype.enableEffect=function(t){t=t!==null&&Et.IsWrapper(t)?t.effect:t,this._currentEffect=t,t&&(t.onBind&&t.onBind(t),t._onBindObservable&&t._onBindObservable.notifyObservers(t))},e.prototype.setState=function(t,i,n,a,s,o,u){},e.prototype.setIntArray=function(t,i){return!0},e.prototype.setIntArray2=function(t,i){return!0},e.prototype.setIntArray3=function(t,i){return!0},e.prototype.setIntArray4=function(t,i){return!0},e.prototype.setFloatArray=function(t,i){return!0},e.prototype.setFloatArray2=function(t,i){return!0},e.prototype.setFloatArray3=function(t,i){return!0},e.prototype.setFloatArray4=function(t,i){return!0},e.prototype.setArray=function(t,i){return!0},e.prototype.setArray2=function(t,i){return!0},e.prototype.setArray3=function(t,i){return!0},e.prototype.setArray4=function(t,i){return!0},e.prototype.setMatrices=function(t,i){return!0},e.prototype.setMatrix3x3=function(t,i){return!0},e.prototype.setMatrix2x2=function(t,i){return!0},e.prototype.setFloat=function(t,i){return!0},e.prototype.setFloat2=function(t,i,n){return!0},e.prototype.setFloat3=function(t,i,n,a){return!0},e.prototype.setBool=function(t,i){return!0},e.prototype.setFloat4=function(t,i,n,a,s){return!0},e.prototype.setAlphaMode=function(t,i){i===void 0&&(i=!1),this._alphaMode!==t&&(this.alphaState.alphaBlend=t!==0,i||this.setDepthWrite(t===0),this._alphaMode=t)},e.prototype.bindBuffers=function(t,i,n){},e.prototype.wipeCaches=function(t){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,t&&(this._currentProgram=null,this._stencilStateComposer.reset(),this.depthCullingState.reset(),this.alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)},e.prototype.draw=function(t,i,n,a){},e.prototype.drawElementsType=function(t,i,n,a){},e.prototype.drawArraysType=function(t,i,n,a){},e.prototype._createTexture=function(){return{}},e.prototype._releaseTexture=function(t){},e.prototype.createTexture=function(t,i,n,a,s,o,u,l,h,c,_,d){s===void 0&&(s=3),o===void 0&&(o=null),c===void 0&&(c=null);var g=new N(this,L.Url),v=String(t);return g.url=v,g.generateMipMaps=!i,g.samplingMode=s,g.invertY=n,g.baseWidth=this._options.textureSize,g.baseHeight=this._options.textureSize,g.width=this._options.textureSize,g.height=this._options.textureSize,c&&(g.format=c),g.isReady=!0,o&&setTimeout(function(){o(g)}),this._internalTexturesCache.push(g),g},e.prototype._createHardwareRenderTargetWrapper=function(t,i,n){var a=new ot(t,i,n,this);return this._renderTargetWrapperCache.push(a),a},e.prototype.createRenderTargetTexture=function(t,i){var n=this._createHardwareRenderTargetWrapper(!1,!1,t),a={};i!==void 0&&typeof i=="object"?(a.generateMipMaps=i.generateMipMaps,a.generateDepthBuffer=i.generateDepthBuffer===void 0?!0:i.generateDepthBuffer,a.generateStencilBuffer=a.generateDepthBuffer&&i.generateStencilBuffer,a.type=i.type===void 0?0:i.type,a.samplingMode=i.samplingMode===void 0?3:i.samplingMode):(a.generateMipMaps=i,a.generateDepthBuffer=!0,a.generateStencilBuffer=!1,a.type=0,a.samplingMode=3);var s=new N(this,L.RenderTarget),o=t.width||t,u=t.height||t;return n._generateDepthBuffer=a.generateDepthBuffer,n._generateStencilBuffer=!!a.generateStencilBuffer,s.baseWidth=o,s.baseHeight=u,s.width=o,s.height=u,s.isReady=!0,s.samples=1,s.generateMipMaps=!!a.generateMipMaps,s.samplingMode=a.samplingMode,s.type=a.type,this._internalTexturesCache.push(s),n},e.prototype.updateTextureSamplingMode=function(t,i){i.samplingMode=t},e.prototype.createRawTexture=function(t,i,n,a,s,o,u,l,h,c,_){l===void 0&&(l=null),h===void 0&&(h=0),_===void 0&&(_=!1);var d=new N(this,L.Raw);return d.baseWidth=i,d.baseHeight=n,d.width=i,d.height=n,d.format=a,d.generateMipMaps=s,d.samplingMode=u,d.invertY=o,d._compression=l,d.type=h,d._useSRGBBuffer=_,this._doNotHandleContextLost||(d._bufferView=t),d},e.prototype.updateRawTexture=function(t,i,n,a,s,o,u){s===void 0&&(s=null),o===void 0&&(o=0),u===void 0&&(u=!1),t&&(t._bufferView=i,t.format=n,t.invertY=a,t._compression=s,t.type=o,t._useSRGBBuffer=u)},e.prototype.bindFramebuffer=function(t,i,n,a,s){this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=t,this._currentFramebuffer=null,this._cachedViewport&&!s&&this.setViewport(this._cachedViewport,n,a)},e.prototype.unBindFramebuffer=function(t,i,n){this._currentRenderTarget=null,n&&n(),this._currentFramebuffer=null},e.prototype.createDynamicVertexBuffer=function(t){var i=new $e;return i.references=1,i.capacity=1,i},e.prototype.updateDynamicTexture=function(t,i,n,a,s){},e.prototype.areAllEffectsReady=function(){return!0},e.prototype.getError=function(){return 0},e.prototype._getUnpackAlignement=function(){return 1},e.prototype._unpackFlipY=function(t){},e.prototype.updateDynamicIndexBuffer=function(t,i,n){},e.prototype.updateDynamicVertexBuffer=function(t,i,n,a){},e.prototype._bindTextureDirectly=function(t,i){return this._boundTexturesCache[this._activeChannel]!==i?(this._boundTexturesCache[this._activeChannel]=i,!0):!1},e.prototype._bindTexture=function(t,i){t<0||this._bindTextureDirectly(0,i)},e.prototype._deleteBuffer=function(t){},e.prototype.releaseEffects=function(){},e.prototype.displayLoadingUI=function(){},e.prototype.hideLoadingUI=function(){},Object.defineProperty(e.prototype,"loadingUIText",{set:function(t){},enumerable:!1,configurable:!0}),e.prototype._uploadCompressedDataToTextureDirectly=function(t,i,n,a,s,o,u){},e.prototype._uploadDataToTextureDirectly=function(t,i,n,a){},e.prototype._uploadArrayBufferViewToTexture=function(t,i,n,a){},e.prototype._uploadImageToTexture=function(t,i,n,a){},e})(F);P.prototype._debugPushGroup=function(r,e){};P.prototype._debugPopGroup=function(r){};P.prototype._debugInsertMarker=function(r,e){};P.prototype._debugFlushPendingCommands=function(){};var jr=function(){function r(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=ue.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=ue.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}return r}();F.prototype.createQuery=function(){var r=this._gl.createQuery();if(!r)throw new Error("Unable to create Occlusion Query");return r};F.prototype.deleteQuery=function(r){return this._gl.deleteQuery(r),this};F.prototype.isQueryResultAvailable=function(r){return this._gl.getQueryParameter(r,this._gl.QUERY_RESULT_AVAILABLE)};F.prototype.getQueryResult=function(r){return this._gl.getQueryParameter(r,this._gl.QUERY_RESULT)};F.prototype.beginOcclusionQuery=function(r,e){var t=this._getGlAlgorithmType(r);return this._gl.beginQuery(t,e),!0};F.prototype.endOcclusionQuery=function(r){var e=this._getGlAlgorithmType(r);return this._gl.endQuery(e),this};F.prototype._createTimeQuery=function(){var r=this.getCaps().timerQuery;return r.createQueryEXT?r.createQueryEXT():this.createQuery()};F.prototype._deleteTimeQuery=function(r){var e=this.getCaps().timerQuery;if(e.deleteQueryEXT){e.deleteQueryEXT(r);return}this.deleteQuery(r)};F.prototype._getTimeQueryResult=function(r){var e=this.getCaps().timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(r,e.QUERY_RESULT_EXT):this.getQueryResult(r)};F.prototype._getTimeQueryAvailability=function(r){var e=this.getCaps().timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(r,e.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(r)};F.prototype.startTimeQuery=function(){var r=this.getCaps(),e=r.timerQuery;if(!e)return null;var t=new wr;if(this._gl.getParameter(e.GPU_DISJOINT_EXT),r.canUseTimestampForTimerQuery)t._startTimeQuery=this._createTimeQuery(),e.queryCounterEXT(t._startTimeQuery,e.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;t._timeElapsedQuery=this._createTimeQuery(),e.beginQueryEXT?e.beginQueryEXT(e.TIME_ELAPSED_EXT,t._timeElapsedQuery):this._gl.beginQuery(e.TIME_ELAPSED_EXT,t._timeElapsedQuery),this._currentNonTimestampToken=t}return t};F.prototype.endTimeQuery=function(r){var e=this.getCaps(),t=e.timerQuery;if(!t||!r)return-1;if(e.canUseTimestampForTimerQuery){if(!r._startTimeQuery)return-1;r._endTimeQuery||(r._endTimeQuery=this._createTimeQuery(),t.queryCounterEXT(r._endTimeQuery,t.TIMESTAMP_EXT))}else if(!r._timeElapsedQueryEnded){if(!r._timeElapsedQuery)return-1;t.endQueryEXT?t.endQueryEXT(t.TIME_ELAPSED_EXT):(this._gl.endQuery(t.TIME_ELAPSED_EXT),this._currentNonTimestampToken=null),r._timeElapsedQueryEnded=!0}var i=this._gl.getParameter(t.GPU_DISJOINT_EXT),n=!1;if(r._endTimeQuery?n=this._getTimeQueryAvailability(r._endTimeQuery):r._timeElapsedQuery&&(n=this._getTimeQueryAvailability(r._timeElapsedQuery)),n&&!i){var a=0;if(e.canUseTimestampForTimerQuery){if(!r._startTimeQuery||!r._endTimeQuery)return-1;var s=this._getTimeQueryResult(r._startTimeQuery),o=this._getTimeQueryResult(r._endTimeQuery);a=o-s,this._deleteTimeQuery(r._startTimeQuery),this._deleteTimeQuery(r._endTimeQuery),r._startTimeQuery=null,r._endTimeQuery=null}else{if(!r._timeElapsedQuery)return-1;a=this._getTimeQueryResult(r._timeElapsedQuery),this._deleteTimeQuery(r._timeElapsedQuery),r._timeElapsedQuery=null,r._timeElapsedQueryEnded=!1}return a}return-1};F.prototype._captureGPUFrameTime=!1;F.prototype._gpuFrameTime=new vt;F.prototype.getGPUFrameTimeCounter=function(){return this._gpuFrameTime};F.prototype.captureGPUFrameTime=function(r){var e=this;r!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=r,r?(this._onBeginFrameObserver=this.onBeginFrameObservable.add(function(){e._gpuFrameTimeToken||(e._gpuFrameTimeToken=e.startTimeQuery())}),this._onEndFrameObserver=this.onEndFrameObservable.add(function(){if(!!e._gpuFrameTimeToken){var t=e.endTimeQuery(e._gpuFrameTimeToken);t>-1&&(e._gpuFrameTimeToken=null,e._gpuFrameTime.fetchNewFrame(),e._gpuFrameTime.addCount(t,!0))}})):(this.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null))};F.prototype._getGlAlgorithmType=function(r){return r===ue.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED};Object.defineProperty(ue.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(r){this._occlusionDataStorage.isOcclusionQueryInProgress=r},enumerable:!1,configurable:!0});Object.defineProperty(ue.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new jr),this.__occlusionDataStorage},enumerable:!1,configurable:!0});Object.defineProperty(ue.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(r){this._occlusionDataStorage.isOccluded=r},enumerable:!0,configurable:!0});Object.defineProperty(ue.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(r){this._occlusionDataStorage.occlusionQueryAlgorithmType=r},enumerable:!0,configurable:!0});Object.defineProperty(ue.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(r){this._occlusionDataStorage.occlusionType=r},enumerable:!0,configurable:!0});Object.defineProperty(ue.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(r){this._occlusionDataStorage.occlusionRetryCount=r},enumerable:!0,configurable:!0});Object.defineProperty(ue.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(r){this._occlusionDataStorage.forceRenderingWhenOccluded=r},enumerable:!0,configurable:!0});ue.prototype._checkOcclusionQuery=function(){var r=this._occlusionDataStorage;if(r.occlusionType===ue.OCCLUSION_TYPE_NONE)return r.isOccluded=!1,!1;var e=this.getEngine();if(!e.getCaps().supportOcclusionQuery||!e.isQueryResultAvailable)return r.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&this._occlusionQuery){var t=e.isQueryResultAvailable(this._occlusionQuery);if(t){var i=e.getQueryResult(this._occlusionQuery);r.isOcclusionQueryInProgress=!1,r.occlusionInternalRetryCounter=0,r.isOccluded=!(i>0)}else if(r.occlusionInternalRetryCounter++,r.occlusionRetryCount!==-1&&r.occlusionInternalRetryCounter>r.occlusionRetryCount)r.isOcclusionQueryInProgress=!1,r.occlusionInternalRetryCounter=0,r.isOccluded=r.occlusionType===ue.OCCLUSION_TYPE_OPTIMISTIC?!1:r.isOccluded;else return r.occlusionType===ue.OCCLUSION_TYPE_OPTIMISTIC?!1:r.isOccluded}var n=this.getScene();if(n.getBoundingBoxRenderer){var a=n.getBoundingBoxRenderer();this._occlusionQuery===null&&(this._occlusionQuery=e.createQuery()),e.beginOcclusionQuery(r.occlusionQueryAlgorithmType,this._occlusionQuery)&&(a.renderOcclusionBoundingBox(this),e.endOcclusionQuery(r.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0)}return r.isOccluded};F.prototype.createTransformFeedback=function(){var r=this._gl.createTransformFeedback();if(!r)throw new Error("Unable to create Transform Feedback");return r};F.prototype.deleteTransformFeedback=function(r){this._gl.deleteTransformFeedback(r)};F.prototype.bindTransformFeedback=function(r){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,r)};F.prototype.beginTransformFeedback=function(r){r===void 0&&(r=!0),this._gl.beginTransformFeedback(r?this._gl.POINTS:this._gl.TRIANGLES)};F.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()};F.prototype.setTranformFeedbackVaryings=function(r,e){this._gl.transformFeedbackVaryings(r,e,this._gl.INTERLEAVED_ATTRIBS)};F.prototype.bindTransformFeedbackBuffer=function(r){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,r?r.underlyingResource:null)};P.prototype.createExternalTexture=function(r){return null};P.prototype.setExternalTexture=function(r,e){throw new Error("setExternalTexture: This engine does not support external textures!")};P.prototype.updateVideoTexture=function(r,e,t){if(!(!r||r._isDisabled)){var i=this._bindTextureDirectly(this._gl.TEXTURE_2D,r,!0);this._unpackFlipY(!t);try{if(this._videoTextureSupported===void 0&&(this._gl.getError(),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e),this._gl.getError()!==0?this._videoTextureSupported=!1:this._videoTextureSupported=!0),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e);else{if(!r._workingCanvas){r._workingCanvas=this.createCanvas(r.width,r.height);var n=r._workingCanvas.getContext("2d");if(!n)throw new Error("Unable to get 2d context");r._workingContext=n,r._workingCanvas.width=r.width,r._workingCanvas.height=r.height}r._workingContext.clearRect(0,0,r.width,r.height),r._workingContext.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,r.width,r.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,r._workingCanvas)}r.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),i||this._bindTextureDirectly(this._gl.TEXTURE_2D,null),r.isReady=!0}catch{r._isDisabled=!0}}};P.prototype.restoreSingleAttachment=function(){var r=this._gl;this.bindAttachments([r.BACK])};P.prototype.restoreSingleAttachmentForRenderTarget=function(){var r=this._gl;this.bindAttachments([r.COLOR_ATTACHMENT0])};P.prototype.buildTextureLayout=function(r){for(var e=this._gl,t=[],i=0;i<r.length;i++)r[i]?t.push(e["COLOR_ATTACHMENT"+i]):t.push(e.NONE);return t};P.prototype.bindAttachments=function(r){var e=this._gl;e.drawBuffers(r)};P.prototype.unBindMultiColorAttachmentFramebuffer=function(r,e,t){e===void 0&&(e=!1),this._currentRenderTarget=null;var i=this._gl,n=r._attachments,a=n.length;if(r._MSAAFramebuffer){i.bindFramebuffer(i.READ_FRAMEBUFFER,r._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,r._framebuffer);for(var s=0;s<a;s++){for(var o=r.textures[s],u=0;u<a;u++)n[u]=i.NONE;n[s]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+s:"COLOR_ATTACHMENT"+s+"_WEBGL"],i.readBuffer(n[s]),i.drawBuffers(n),i.blitFramebuffer(0,0,o.width,o.height,0,0,o.width,o.height,i.COLOR_BUFFER_BIT,i.NEAREST)}for(var s=0;s<a;s++)n[s]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+s:"COLOR_ATTACHMENT"+s+"_WEBGL"];i.drawBuffers(n)}for(var s=0;s<a;s++){var o=r.textures[s];o.generateMipMaps&&!e&&!o.isCube&&(this._bindTextureDirectly(i.TEXTURE_2D,o,!0),i.generateMipmap(i.TEXTURE_2D),this._bindTextureDirectly(i.TEXTURE_2D,null))}t&&(r._MSAAFramebuffer&&this._bindUnboundFramebuffer(r._framebuffer),t()),this._bindUnboundFramebuffer(null)};P.prototype.createMultipleRenderTarget=function(r,e,t){t===void 0&&(t=!0);var i=!1,n=!0,a=!1,s=!1,o=15,u=1,l=0,h=3,c=!1,_=new Array,d=new Array,g=new Array,v=this._createHardwareRenderTargetWrapper(!0,!1,r);e!==void 0&&(i=e.generateMipMaps===void 0?!1:e.generateMipMaps,n=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,a=e.generateStencilBuffer===void 0?!1:e.generateStencilBuffer,s=e.generateDepthTexture===void 0?!1:e.generateDepthTexture,u=e.textureCount||1,e.types&&(_=e.types),e.samplingModes&&(d=e.samplingModes),e.useSRGBBuffers&&(g=e.useSRGBBuffers),this.webGLVersion>1&&(e.depthTextureFormat===13||e.depthTextureFormat===17||e.depthTextureFormat===16||e.depthTextureFormat===14||e.depthTextureFormat===18)&&(o=e.depthTextureFormat));var p=this._gl,m=p.createFramebuffer();this._bindUnboundFramebuffer(m);var E=r.width||r,T=r.height||r,R=[],y=[],C=this.webGLVersion>1&&s&&(e.depthTextureFormat===13||e.depthTextureFormat===17||e.depthTextureFormat===18),b=this._setupFramebufferDepthAttachments(!C&&a,!s&&n,E,T);v._framebuffer=m,v._depthStencilBuffer=b,v._generateDepthBuffer=!s&&n,v._generateStencilBuffer=!C&&a,v._attachments=y;for(var x=0;x<u;x++){var S=d[x]||h,w=_[x]||l,A=g[x]||c;(w===1&&!this._caps.textureFloatLinearFiltering||w===2&&!this._caps.textureHalfFloatLinearFiltering)&&(S=1);var U=this._getSamplingParameters(S,i);w===1&&!this._caps.textureFloat&&(w=0,I.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),A=A&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);var M=new N(this,L.MultiRenderTarget),q=p[this.webGLVersion>1?"COLOR_ATTACHMENT"+x:"COLOR_ATTACHMENT"+x+"_WEBGL"];R.push(M),y.push(q),p.activeTexture(p["TEXTURE"+x]),p.bindTexture(p.TEXTURE_2D,M._hardwareTexture.underlyingResource),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,U.mag),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,U.min),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE);var G=this._getRGBABufferInternalSizedFormat(w,5,A);p.texImage2D(p.TEXTURE_2D,0,G,E,T,0,p.RGBA,this._getWebGLTextureType(w),null),p.framebufferTexture2D(p.DRAW_FRAMEBUFFER,q,p.TEXTURE_2D,M._hardwareTexture.underlyingResource,0),i&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(p.TEXTURE_2D,null),M.baseWidth=E,M.baseHeight=T,M.width=E,M.height=T,M.isReady=!0,M.samples=1,M.generateMipMaps=i,M.samplingMode=S,M.type=w,M._useSRGBBuffer=A,this._internalTexturesCache.push(M)}if(s&&this._caps.depthTextureExtension){var O=new N(this,L.Depth),j=5,H=p.DEPTH_COMPONENT16,Y=p.DEPTH_COMPONENT,me=p.UNSIGNED_SHORT,re=p.DEPTH_ATTACHMENT;this.webGLVersion<2?H=p.DEPTH_COMPONENT:o===14?(j=1,me=p.FLOAT,H=p.DEPTH_COMPONENT32F):o===18?(j=0,me=p.FLOAT_32_UNSIGNED_INT_24_8_REV,H=p.DEPTH32F_STENCIL8,Y=p.DEPTH_STENCIL,re=p.DEPTH_STENCIL_ATTACHMENT):o===16?(j=0,me=p.UNSIGNED_INT,H=p.DEPTH_COMPONENT24,re=p.DEPTH_ATTACHMENT):(o===13||o===17)&&(j=12,me=p.UNSIGNED_INT_24_8,H=p.DEPTH24_STENCIL8,Y=p.DEPTH_STENCIL,re=p.DEPTH_STENCIL_ATTACHMENT),p.activeTexture(p.TEXTURE0),p.bindTexture(p.TEXTURE_2D,O._hardwareTexture.underlyingResource),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.NEAREST),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.NEAREST),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),p.texImage2D(p.TEXTURE_2D,0,H,E,T,0,Y,me,null),p.framebufferTexture2D(p.FRAMEBUFFER,re,p.TEXTURE_2D,O._hardwareTexture.underlyingResource,0),O.baseWidth=E,O.baseHeight=T,O.width=E,O.height=T,O.isReady=!0,O.samples=1,O.generateMipMaps=i,O.samplingMode=1,O.format=o,O.type=j,R.push(O),this._internalTexturesCache.push(O)}return v.setTextures(R),t&&p.drawBuffers(y),this._bindUnboundFramebuffer(null),this.resetTextureCache(),v};P.prototype.updateMultipleRenderTargetTextureSampleCount=function(r,e,t){if(t===void 0&&(t=!0),this.webGLVersion<2||!r||!r.texture)return 1;if(r.samples===e)return e;var i=r._attachments.length;if(i===0)return 1;var n=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),r._depthStencilBuffer&&(n.deleteRenderbuffer(r._depthStencilBuffer),r._depthStencilBuffer=null),r._MSAAFramebuffer&&(n.deleteFramebuffer(r._MSAAFramebuffer),r._MSAAFramebuffer=null);for(var a=0;a<i;a++){var s=r.textures[a]._hardwareTexture;s!=null&&s._MSAARenderBuffer&&(n.deleteRenderbuffer(s._MSAARenderBuffer),s._MSAARenderBuffer=null)}if(e>1&&n.renderbufferStorageMultisample){var o=n.createFramebuffer();if(!o)throw new Error("Unable to create multi sampled framebuffer");r._MSAAFramebuffer=o,this._bindUnboundFramebuffer(o);for(var u=[],a=0;a<i;a++){var l=r.textures[a],s=l._hardwareTexture,h=n[this.webGLVersion>1?"COLOR_ATTACHMENT"+a:"COLOR_ATTACHMENT"+a+"_WEBGL"],c=this._createRenderBuffer(l.width,l.height,e,-1,this._getRGBAMultiSampleBufferFormat(l.type),h);if(!c)throw new Error("Unable to create multi sampled framebuffer");s._MSAARenderBuffer=c,l.samples=e,u.push(h)}t&&n.drawBuffers(u)}else this._bindUnboundFramebuffer(r._framebuffer);return r._depthStencilBuffer=this._setupFramebufferDepthAttachments(r._generateStencilBuffer,r._generateDepthBuffer,r.texture.width,r.texture.height,e),this._bindUnboundFramebuffer(null),e};P.prototype._createDepthStencilCubeTexture=function(r,e,t){var i=new N(this,L.DepthStencil);if(i.isCube=!0,this.webGLVersion===1)return I.Error("Depth cube texture is not supported by WebGL 1."),i;var n=se({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},e),a=this._gl;this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,i,!0),this._setupDepthStencilTexture(i,r,n.generateStencil,n.bilinearFiltering,n.comparisonFunction),t._depthStencilTexture=i,t._depthStencilTextureWithStencil=n.generateStencil;for(var s=0;s<6;s++)n.generateStencil?a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+s,0,a.DEPTH24_STENCIL8,r,r,0,a.DEPTH_STENCIL,a.UNSIGNED_INT_24_8,null):a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+s,0,a.DEPTH_COMPONENT24,r,r,0,a.DEPTH_COMPONENT,a.UNSIGNED_INT,null);return this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(i),i};P.prototype._partialLoadFile=function(r,e,t,i,n){n===void 0&&(n=null);var a=function(o){t[e]=o,t._internalCount++,t._internalCount===6&&i(t)},s=function(o,u){n&&o&&n(o.status+" "+o.statusText,u)};this._loadFile(r,a,void 0,void 0,!0,s)};P.prototype._cascadeLoadFiles=function(r,e,t,i){i===void 0&&(i=null);var n=[];n._internalCount=0;for(var a=0;a<6;a++)this._partialLoadFile(t[a],a,n,e,i)};P.prototype._cascadeLoadImgs=function(r,e,t,i,n,a){n===void 0&&(n=null);var s=[];s._internalCount=0;for(var o=0;o<6;o++)this._partialLoadImg(i[o],o,s,r,e,t,n,a)};P.prototype._partialLoadImg=function(r,e,t,i,n,a,s,o){s===void 0&&(s=null);var u=gr(),l=function(c){t[e]=c,t._internalCount++,i&&i.removePendingData(u),t._internalCount===6&&a&&a(n,t)},h=function(c,_){i&&i.removePendingData(u),s&&s(c,_)};mr(r,l,h,i?i.offlineProvider:null,o),i&&i.addPendingData(u)};P.prototype._setCubeMapTextureParams=function(r,e,t){var i=this._gl;i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,e?i.LINEAR_MIPMAP_LINEAR:i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),r.samplingMode=e?3:2,e&&this.getCaps().textureMaxLevel&&t!==void 0&&t>0&&(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_LEVEL,t),r._maxLodLevel=t),this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)};P.prototype.createCubeTextureBase=function(r,e,t,i,n,a,s,o,u,l,h,c,_,d,g){var v=this;n===void 0&&(n=null),a===void 0&&(a=null),o===void 0&&(o=null),u===void 0&&(u=!1),l===void 0&&(l=0),h===void 0&&(h=0),c===void 0&&(c=null),_===void 0&&(_=null),d===void 0&&(d=null),g===void 0&&(g=!1);var p=c||new N(this,L.Cube);p.isCube=!0,p.url=r,p.generateMipMaps=!i,p._lodGenerationScale=l,p._lodGenerationOffset=h,p._useSRGBBuffer=!!g&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||!!i),this._doNotHandleContextLost||(p._extension=o,p._files=t);var m=r;this._transformTextureUrl&&!c&&(r=this._transformTextureUrl(r));for(var E=r.lastIndexOf("."),T=o||(E>-1?r.substring(E).toLowerCase():""),R=null,y=0,C=P._TextureLoaders;y<C.length;y++){var b=C[y];if(b.canLoad(T)){R=b;break}}var x=function(w,A){r===m?a&&w&&a(w.status+" "+w.statusText,A):(I.Warn("Failed to load ".concat(r,", falling back to the ").concat(m)),v.createCubeTextureBase(m,e,t,!!i,n,a,s,o,u,l,h,p,_,d,g))};if(R){var S=function(w){_&&_(p,w),R.loadCubeData(w,p,u,n,a)};t&&t.length===6?R.supportCascades?this._cascadeLoadFiles(e,function(w){return S(w.map(function(A){return new Uint8Array(A)}))},t,a):a?a("Textures type does not support cascades."):I.Warn("Texture loader does not support cascades."):this._loadFile(r,function(w){return S(new Uint8Array(w))},void 0,void 0,!0,x)}else{if(!t)throw new Error("Cannot load cubemap because files were not defined");this._cascadeLoadImgs(e,p,function(w,A){d&&d(w,A)},t,a)}return this._internalTexturesCache.push(p),p};P.prototype.createCubeTexture=function(r,e,t,i,n,a,s,o,u,l,h,c,_,d){var g=this;n===void 0&&(n=null),a===void 0&&(a=null),o===void 0&&(o=null),u===void 0&&(u=!1),l===void 0&&(l=0),h===void 0&&(h=0),c===void 0&&(c=null),d===void 0&&(d=!1);var v=this._gl;return this.createCubeTextureBase(r,e,t,!!i,n,a,s,o,u,l,h,c,function(p){return g._bindTextureDirectly(v.TEXTURE_CUBE_MAP,p,!0)},function(p,m){var E=g.needPOTTextures?P.GetExponentOfTwo(m[0].width,g._caps.maxCubemapTextureSize):m[0].width,T=E,R=[v.TEXTURE_CUBE_MAP_POSITIVE_X,v.TEXTURE_CUBE_MAP_POSITIVE_Y,v.TEXTURE_CUBE_MAP_POSITIVE_Z,v.TEXTURE_CUBE_MAP_NEGATIVE_X,v.TEXTURE_CUBE_MAP_NEGATIVE_Y,v.TEXTURE_CUBE_MAP_NEGATIVE_Z];g._bindTextureDirectly(v.TEXTURE_CUBE_MAP,p,!0),g._unpackFlipY(!1);var y=s?g._getInternalFormat(s,p._useSRGBBuffer):p._useSRGBBuffer?v.SRGB8_ALPHA8:v.RGBA,C=s?g._getInternalFormat(s):v.RGBA;p._useSRGBBuffer&&g.webGLVersion===1&&(C=y);for(var b=0;b<R.length;b++)if(m[b].width!==E||m[b].height!==T){if(g._prepareWorkingCanvas(),!g._workingCanvas||!g._workingContext){I.Warn("Cannot create canvas to resize texture.");return}g._workingCanvas.width=E,g._workingCanvas.height=T,g._workingContext.drawImage(m[b],0,0,m[b].width,m[b].height,0,0,E,T),v.texImage2D(R[b],0,y,C,v.UNSIGNED_BYTE,g._workingCanvas)}else v.texImage2D(R[b],0,y,C,v.UNSIGNED_BYTE,m[b]);i||v.generateMipmap(v.TEXTURE_CUBE_MAP),g._setCubeMapTextureParams(p,!i),p.width=E,p.height=T,p.isReady=!0,s&&(p.format=s),p.onLoadedObservable.notifyObservers(p),p.onLoadedObservable.clear(),n&&n()},!!d)};P.prototype.setTextureSampler=function(r,e){throw new Error("setTextureSampler: This engine does not support separate texture sampler objects!")};var ar=new ee,sr=new ee;Object.defineProperty(F.prototype,"onBeforeViewRenderObservable",{get:function(){return ar}});Object.defineProperty(F.prototype,"onAfterViewRenderObservable",{get:function(){return sr}});Object.defineProperty(F.prototype,"inputElement",{get:function(){return this._inputElement},set:function(r){var e;this._inputElement!==r&&(this._inputElement=r,(e=this._onEngineViewChanged)===null||e===void 0||e.call(this))}});F.prototype.getInputElement=function(){return this.inputElement||this.getRenderingCanvas()};F.prototype.registerView=function(r,e,t){var i=this;this.views||(this.views=[]);for(var n=0,a=this.views;n<a.length;n++){var s=a[n];if(s.target===r)return s}var o=this.getRenderingCanvas();o&&(r.width=o.width,r.height=o.height);var u={target:r,camera:e,clearBeforeCopy:t,enabled:!0,id:(Math.random()*1e5).toFixed()};return this.views.push(u),e&&e.onDisposeObservable.add(function(){i.unRegisterView(r)}),u};F.prototype.unRegisterView=function(r){if(!this.views)return this;for(var e=0,t=this.views;e<t.length;e++){var i=t[e];if(i.target===r){var n=this.views.indexOf(i);n!==-1&&this.views.splice(n,1);break}}return this};F.prototype._renderViews=function(){if(!this.views)return!1;var r=this.getRenderingCanvas();if(!r)return!1;for(var e=0,t=this.views;e<t.length;e++){var i=t[e];if(!!i.enabled){var n=i.target,a=n.getContext("2d");if(!!a){ar.notifyObservers(i);var s=i.camera,o=null,u=null;if(s){if(u=s.getScene(),u.activeCameras&&u.activeCameras.length)continue;this.activeView=i,o=u.activeCamera,u.activeCamera=s}if(i.customResize)i.customResize(n);else{var l=Math.floor(n.clientWidth/this._hardwareScalingLevel),h=Math.floor(n.clientHeight/this._hardwareScalingLevel),c=l!==n.width||r.width!==n.width||h!==n.height||r.height!==n.height;n.clientWidth&&n.clientHeight&&c&&(n.width=l,n.height=h,this.setSize(l,h))}if(!r.width||!r.height)return!1;this._renderFrame(),this.flushFramebuffer(),i.clearBeforeCopy&&a.clearRect(0,0,r.width,r.height),a.drawImage(r,0,0),o&&u&&(u.activeCamera=o),sr.notifyObservers(i)}}}return this.activeView=null,!0};P.prototype.createStorageBuffer=function(r,e){throw new Error("createStorageBuffer: Unsupported method in this engine!")};P.prototype.updateStorageBuffer=function(r,e,t,i){};P.prototype.readFromStorageBuffer=function(r,e,t,i){throw new Error("readFromStorageBuffer: Unsupported method in this engine!")};P.prototype.setStorageBuffer=function(r,e){throw new Error("setStorageBuffer: Unsupported method in this engine!")};function qr(r){var e=function(a){var s="\\b"+a+"\\b";return r&&(r===a||r.match(new RegExp(s,"g")))};if(this._excludedCompressedTextures&&this._excludedCompressedTextures.some(e))return r;var t=r.lastIndexOf("."),i=r.lastIndexOf("?"),n=i>-1?r.substring(i,r.length):"";return(t>-1?r.substring(0,t):r)+this._textureFormatInUse+n}Object.defineProperty(F.prototype,"texturesSupported",{get:function(){var r=new Array;return this._caps.astc&&r.push("-astc.ktx"),this._caps.s3tc&&r.push("-dxt.ktx"),this._caps.pvrtc&&r.push("-pvrtc.ktx"),this._caps.etc2&&r.push("-etc2.ktx"),this._caps.etc1&&r.push("-etc1.ktx"),r},enumerable:!0,configurable:!0});Object.defineProperty(F.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse||null},enumerable:!0,configurable:!0});F.prototype.setCompressedTextureExclusions=function(r){this._excludedCompressedTextures=r};F.prototype.setTextureFormatToUse=function(r){for(var e=this.texturesSupported,t=0,i=e.length;t<i;t++)for(var n=0,a=r.length;n<a;n++)if(e[t]===r[n].toLowerCase())return this._transformTextureUrl=qr.bind(this),this._textureFormatInUse=e[t];return this._textureFormatInUse="",this._transformTextureUrl=null,null};var bt=function(){function r(){var e=this,t=new ArrayBuffer(r.DEFAULT_BUFFER_SIZE);this._uint32s=new Uint32Array(t),this._int32s=new Int32Array(t),this._float32s=new Float32Array(t),this._length=r.DEFAULT_BUFFER_SIZE/4,this._position=0,this._nativeDataStream=new _native.NativeDataStream(function(){e._flush()})}return r.prototype.writeUint32=function(e){this._flushIfNecessary(1),this._uint32s[this._position++]=e},r.prototype.writeInt32=function(e){this._flushIfNecessary(1),this._int32s[this._position++]=e},r.prototype.writeFloat32=function(e){this._flushIfNecessary(1),this._float32s[this._position++]=e},r.prototype.writeUint32Array=function(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._uint32s.set(e,this._position),this._position+=e.length},r.prototype.writeInt32Array=function(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._int32s.set(e,this._position),this._position+=e.length},r.prototype.writeFloat32Array=function(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._float32s.set(e,this._position),this._position+=e.length},r.prototype.writeNativeData=function(e){this._flushIfNecessary(e.length),this._uint32s.set(e,this._position),this._position+=e.length},r.prototype.writeBoolean=function(e){this.writeUint32(e?1:0)},r.prototype._flushIfNecessary=function(e){this._position+e>this._length&&this._flush()},r.prototype._flush=function(){this._nativeDataStream.writeBuffer(this._uint32s.buffer,this._position),this._position=0},r.DEFAULT_BUFFER_SIZE=65536,r}(),et=function(){function r(e,t){t===void 0&&(t=20),this.debug=!1,this._sourceCode=e,this._numMaxIterations=t,this._functionDescr=[],this.inlineToken="#define inline"}return Object.defineProperty(r.prototype,"code",{get:function(){return this._sourceCode},enumerable:!1,configurable:!0}),r.prototype.processCode=function(){this.debug&&console.log("Start inlining process (code size=".concat(this._sourceCode.length,")...")),this._collectFunctions(),this._processInlining(this._numMaxIterations),this.debug&&console.log("End of inlining process.")},r.prototype._collectFunctions=function(){for(var e=0;e<this._sourceCode.length;){var t=this._sourceCode.indexOf(this.inlineToken,e);if(t<0)break;var i=this._sourceCode.indexOf("(",t+this.inlineToken.length);if(i<0){this.debug&&console.warn("Could not find the opening parenthesis after the token. startIndex=".concat(e)),e=t+this.inlineToken.length;continue}var n=r._RegexpFindFunctionNameAndType.exec(this._sourceCode.substring(t+this.inlineToken.length,i));if(!n){this.debug&&console.warn("Could not extract the name/type of the function from: ".concat(this._sourceCode.substring(t+this.inlineToken.length,i))),e=t+this.inlineToken.length;continue}var a=[n[3],n[4]],s=a[0],o=a[1],u=je("(",")",this._sourceCode,i);if(u<0){this.debug&&console.warn("Could not extract the parameters the function '".concat(o,"' (type=").concat(s,"). funcParamsStartIndex=").concat(i)),e=t+this.inlineToken.length;continue}var l=this._sourceCode.substring(i+1,u),h=St(this._sourceCode,u+1);if(h===this._sourceCode.length){this.debug&&console.warn("Could not extract the body of the function '".concat(o,"' (type=").concat(s,"). funcParamsEndIndex=").concat(u)),e=t+this.inlineToken.length;continue}var c=je("{","}",this._sourceCode,h);if(c<0){this.debug&&console.warn("Could not extract the body of the function '".concat(o,"' (type=").concat(s,"). funcBodyStartIndex=").concat(h)),e=t+this.inlineToken.length;continue}for(var _=this._sourceCode.substring(h,c+1),d=pt(l).split(","),g=[],v=0;v<d.length;++v){var p=d[v].trim(),m=p.lastIndexOf(" ");m>=0&&g.push(p.substring(m+1))}s!=="void"&&g.push("return"),this._functionDescr.push({name:o,type:s,parameters:g,body:_,callIndex:0}),e=c+1;var E=t>0?this._sourceCode.substring(0,t):"",T=c+1<this._sourceCode.length-1?this._sourceCode.substring(c+1):"";this._sourceCode=E+T,e-=c+1-t}this.debug&&console.log("Collect functions: ".concat(this._functionDescr.length," functions found. functionDescr="),this._functionDescr)},r.prototype._processInlining=function(e){for(e===void 0&&(e=20);e-->=0&&this._replaceFunctionCallsByCode(););return this.debug&&console.log("numMaxIterations is ".concat(e," after inlining process")),e>=0},r.prototype._replaceFunctionCallsByCode=function(){for(var e=!1,t=0,i=this._functionDescr;t<i.length;t++)for(var n=i[t],a=n.name,s=n.type,o=n.parameters,u=n.body,l=0;l<this._sourceCode.length;){var h=this._sourceCode.indexOf(a,l);if(h<0)break;if(h===0||lt(this._sourceCode.charAt(h-1))){l=h+a.length;continue}var c=St(this._sourceCode,h+a.length);if(c===this._sourceCode.length||this._sourceCode.charAt(c)!=="("){l=h+a.length;continue}var _=je("(",")",this._sourceCode,c);if(_<0){this.debug&&console.warn("Could not extract the parameters of the function call. Function '".concat(a,"' (type=").concat(s,"). callParamsStartIndex=").concat(c)),l=h+a.length;continue}var d=this._sourceCode.substring(c+1,_),g=function(S){for(var w=[],A=0,U=0;A<S.length;){if(S.charAt(A)==="("){var M=je("(",")",S,A);if(M<0)return null;A=M}else S.charAt(A)===","&&(w.push(S.substring(U,A)),U=A+1);A++}return U<A&&w.push(S.substring(U,A)),w},v=g(pt(d));if(v===null){this.debug&&console.warn("Invalid function call: can't extract the parameters of the function call. Function '".concat(a,"' (type=").concat(s,"). callParamsStartIndex=").concat(c,", callParams=")+d),l=h+a.length;continue}for(var p=[],m=0;m<v.length;++m){var E=v[m].trim();p.push(E)}var T=s!=="void"?a+"_"+n.callIndex++:null;if(T&&p.push(T+" ="),p.length!==o.length){this.debug&&console.warn("Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '".concat(a,"' (type=").concat(s,"). function parameters=").concat(o,", call parameters=").concat(p)),l=h+a.length;continue}l=_+1;var R=this._replaceNames(u,o,p),y=h>0?this._sourceCode.substring(0,h):"",C=_+1<this._sourceCode.length-1?this._sourceCode.substring(_+1):"";if(T){var b=vr(this._sourceCode,h-1,`
`);y=this._sourceCode.substring(0,b+1);var x=this._sourceCode.substring(b+1,h);this._sourceCode=y+s+" "+T+`;
`+R+`
`+x+T+C,this.debug&&console.log("Replace function call by code. Function '".concat(a,"' (type=").concat(s,"). injectDeclarationIndex=").concat(b,", call parameters=").concat(p))}else this._sourceCode=y+R+C,l+=R.length-(_+1-h),this.debug&&console.log("Replace function call by code. Function '".concat(a,"' (type=").concat(s,"). functionCallIndex=").concat(h,", call parameters=").concat(p));e=!0}return e},r.prototype._replaceNames=function(e,t,i){for(var n=function(s){var o=new RegExp(Er(t[s]),"g"),u=t[s].length,l=i[s];e=e.replace(o,function(h){for(var c=[],_=1;_<arguments.length;_++)c[_-1]=arguments[_];var d=c[0];return lt(e.charAt(d-1))||lt(e.charAt(d+u))?t[s]:l})},a=0;a<t.length;++a)n(a);return e},r._RegexpFindFunctionNameAndType=/((\s+?)(\w+)\s+(\w+)\s*?)$/,r}(),or=new ee;if(typeof self!="undefined"&&!Object.prototype.hasOwnProperty.call(self,"_native")){var ze;Object.defineProperty(self,"_native",{get:function(){return ze},set:function(r){ze=r,ze&&or.notifyObservers(ze)}})}function zr(){return new Promise(function(r){typeof _native=="undefined"?or.addOnce(function(e){return r(e)}):r(_native)})}function rn(r,e){return we(this,void 0,void 0,function(){return Fe(this,function(t){switch(t.label){case 0:return[4,zr()];case 1:return t.sent()[r]=e,[2]}})})}var Kr=function(){function r(e){this.isAsync=!1,this.isReady=!1,this._valueCache={},this.engine=e}return r.prototype._getVertexShaderCode=function(){return null},r.prototype._getFragmentShaderCode=function(){return null},r.prototype._handlesSpectorRebuildCallback=function(e){throw new Error("Not implemented")},r.prototype._fillEffectInformation=function(e,t,i,n,a,s,o,u){var l=this.engine;if(l.supportsUniformBuffers)for(var h in t)e.bindUniformBlock(h,t[h]);var c=this.engine.getUniforms(this,i);c.forEach(function(g,v){n[i[v]]=g}),this._uniforms=n;var _;for(_=0;_<a.length;_++){var d=e.getUniform(a[_]);d==null&&(a.splice(_,1),_--)}a.forEach(function(g,v){s[g]=v}),u.push.apply(u,l.getAttributes(this,o))},r.prototype.dispose=function(){this._uniforms={}},r.prototype._cacheMatrix=function(e,t){var i=this._valueCache[e],n=t.updateFlag;return i!==void 0&&i===n?!1:(this._valueCache[e]=n,!0)},r.prototype._cacheFloat2=function(e,t,i){var n=this._valueCache[e];if(!n)return n=[t,i],this._valueCache[e]=n,!0;var a=!1;return n[0]!==t&&(n[0]=t,a=!0),n[1]!==i&&(n[1]=i,a=!0),a},r.prototype._cacheFloat3=function(e,t,i,n){var a=this._valueCache[e];if(!a)return a=[t,i,n],this._valueCache[e]=a,!0;var s=!1;return a[0]!==t&&(a[0]=t,s=!0),a[1]!==i&&(a[1]=i,s=!0),a[2]!==n&&(a[2]=n,s=!0),s},r.prototype._cacheFloat4=function(e,t,i,n,a){var s=this._valueCache[e];if(!s)return s=[t,i,n,a],this._valueCache[e]=s,!0;var o=!1;return s[0]!==t&&(s[0]=t,o=!0),s[1]!==i&&(s[1]=i,o=!0),s[2]!==n&&(s[2]=n,o=!0),s[3]!==a&&(s[3]=a,o=!0),o},r.prototype.setInt=function(e,t){var i=this._valueCache[e];i!==void 0&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)},r.prototype.setInt2=function(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))},r.prototype.setInt3=function(e,t,i,n){this._cacheFloat3(e,t,i,n)&&(this.engine.setInt3(this._uniforms[e],t,i,n)||(this._valueCache[e]=null))},r.prototype.setInt4=function(e,t,i,n,a){this._cacheFloat4(e,t,i,n,a)&&(this.engine.setInt4(this._uniforms[e],t,i,n,a)||(this._valueCache[e]=null))},r.prototype.setIntArray=function(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)},r.prototype.setIntArray2=function(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)},r.prototype.setIntArray3=function(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)},r.prototype.setIntArray4=function(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)},r.prototype.setFloatArray=function(e,t){this._valueCache[e]=null,this.engine.setFloatArray(this._uniforms[e],t)},r.prototype.setFloatArray2=function(e,t){this._valueCache[e]=null,this.engine.setFloatArray2(this._uniforms[e],t)},r.prototype.setFloatArray3=function(e,t){this._valueCache[e]=null,this.engine.setFloatArray3(this._uniforms[e],t)},r.prototype.setFloatArray4=function(e,t){this._valueCache[e]=null,this.engine.setFloatArray4(this._uniforms[e],t)},r.prototype.setArray=function(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)},r.prototype.setArray2=function(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)},r.prototype.setArray3=function(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)},r.prototype.setArray4=function(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)},r.prototype.setMatrices=function(e,t){!t||(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))},r.prototype.setMatrix=function(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))},r.prototype.setMatrix3x3=function(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)},r.prototype.setMatrix2x2=function(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)},r.prototype.setFloat=function(e,t){var i=this._valueCache[e];i!==void 0&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)},r.prototype.setBool=function(e,t){var i=this._valueCache[e];i!==void 0&&i===t||this.engine.setInt(this._uniforms[e],t?1:0)&&(this._valueCache[e]=t?1:0)},r.prototype.setVector2=function(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))},r.prototype.setFloat2=function(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))},r.prototype.setVector3=function(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))},r.prototype.setFloat3=function(e,t,i,n){this._cacheFloat3(e,t,i,n)&&(this.engine.setFloat3(this._uniforms[e],t,i,n)||(this._valueCache[e]=null))},r.prototype.setVector4=function(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))},r.prototype.setQuaternion=function(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))},r.prototype.setFloat4=function(e,t,i,n,a){this._cacheFloat4(e,t,i,n,a)&&(this.engine.setFloat4(this._uniforms[e],t,i,n,a)||(this._valueCache[e]=null))},r.prototype.setColor3=function(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))},r.prototype.setColor4=function(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))},r.prototype.setDirectColor4=function(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))},r}(),Zr=function(r){J(e,r);function e(t,i,n,a){var s=r.call(this,t,i,n,a)||this;return s.__framebuffer=null,s.__framebufferDepthStencil=null,s._engine=a,s}return Object.defineProperty(e.prototype,"_framebuffer",{get:function(){return this.__framebuffer},set:function(t){this.__framebuffer&&this._engine._releaseFramebufferObjects(this.__framebuffer),this.__framebuffer=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_framebufferDepthStencil",{get:function(){return this.__framebufferDepthStencil},set:function(t){this.__framebufferDepthStencil&&this._engine._releaseFramebufferObjects(this.__framebufferDepthStencil),this.__framebufferDepthStencil=t},enumerable:!1,configurable:!0}),e.prototype.dispose=function(t){t===void 0&&(t=!1),this._framebuffer=null,this._framebufferDepthStencil=null,r.prototype.dispose.call(this,t)},e}(ot),wt=function(r){J(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}($e),Jr=function(){function r(e){this._engine=e,this._pending=new Array,this._isCommandBufferScopeActive=!1,this._commandStream=ur._createNativeDataStream(),this._engine.setCommandDataStream(this._commandStream)}return r.prototype.beginCommandScope=function(){if(this._isCommandBufferScopeActive)throw new Error("Command scope already active.");this._isCommandBufferScopeActive=!0},r.prototype.endCommandScope=function(){if(!this._isCommandBufferScopeActive)throw new Error("Command scope is not active.");this._isCommandBufferScopeActive=!1,this._submit()},r.prototype.startEncodingCommand=function(e){this._commandStream.writeNativeData(e)},r.prototype.encodeCommandArgAsUInt32=function(e){this._commandStream.writeUint32(e)},r.prototype.encodeCommandArgAsUInt32s=function(e){this._commandStream.writeUint32Array(e)},r.prototype.encodeCommandArgAsInt32=function(e){this._commandStream.writeInt32(e)},r.prototype.encodeCommandArgAsInt32s=function(e){this._commandStream.writeInt32Array(e)},r.prototype.encodeCommandArgAsFloat32=function(e){this._commandStream.writeFloat32(e)},r.prototype.encodeCommandArgAsFloat32s=function(e){this._commandStream.writeFloat32Array(e)},r.prototype.encodeCommandArgAsNativeData=function(e){this._commandStream.writeNativeData(e),this._pending.push(e)},r.prototype.finishEncodingCommand=function(){this._isCommandBufferScopeActive||this._submit()},r.prototype._submit=function(){this._engine.submitCommands(),this._pending.length=0},r}(),ur=function(r){J(e,r);function e(t){t===void 0&&(t={});var i=r.call(this,null,!1,void 0,t.adaptToDeviceRatio)||this;if(i._engine=new _native.Engine,i._camera=_native.Camera?new _native.Camera:null,i._commandBufferEncoder=new Jr(i._engine),i._boundBuffersVertexArray=null,i._currentDepthTest=_native.Engine.DEPTH_TEST_LEQUAL,i._stencilTest=!1,i._stencilMask=255,i._stencilFunc=519,i._stencilFuncRef=0,i._stencilFuncMask=255,i._stencilOpStencilFail=7680,i._stencilOpDepthFail=7680,i._stencilOpStencilDepthPass=7681,i._zOffset=0,i._zOffsetUnits=0,i._depthWrite=!0,_native.Engine.PROTOCOL_VERSION!==e.PROTOCOL_VERSION)throw new Error("Protocol version mismatch: ".concat(_native.Engine.PROTOCOL_VERSION," (Native) !== ").concat(e.PROTOCOL_VERSION," (JS)"));i._webGLVersion=2,i.disableUniformBuffers=!0,i._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_SIZE,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!0,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,textureFloat:!0,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloat:!1,textureHalfFloatLinearFiltering:!1,textureHalfFloatRender:!1,textureLOD:!0,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!0,instancedArrays:!0,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,blendMinMax:!1,maxMSAASamples:1,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!1,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_LAYERS},i._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!1,supportSSAO2:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,_collectUbosUpdatedInFrame:!1},ce.Log("Babylon Native (v"+F.Version+") launched"),ce.LoadScript=function(s,o,u,l){ce.LoadFile(s,function(h){Function(h).apply(null),o&&o()},void 0,void 0,!1,function(h,c){u&&u("LoadScript Error",c)})},typeof URL=="undefined"&&(window.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),typeof Blob=="undefined"&&(window.Blob=function(s){return s});var n=window&&window.devicePixelRatio||1;i._hardwareScalingLevel=t.adaptToDeviceRatio?n:1,i.resize();var a=i.getDepthFunction();return a&&i.setDepthFunction(a),i._shaderProcessor=new er,i.onNewSceneAddedObservable.add(function(s){var o=s.render;s.render=function(){for(var u=[],l=0;l<arguments.length;l++)u[l]=arguments[l];i._commandBufferEncoder.beginCommandScope(),o.apply(s,u),i._commandBufferEncoder.endCommandScope()}}),i}return e.prototype.getHardwareScalingLevel=function(){return this._engine.getHardwareScalingLevel()},e.prototype.setHardwareScalingLevel=function(t){this._engine.setHardwareScalingLevel(t)},e.prototype.dispose=function(){r.prototype.dispose.call(this),this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._engine.dispose()},e._createNativeDataStream=function(){return new bt},e.prototype._queueNewFrame=function(t,i){return i.requestAnimationFrame&&i!==window?i.requestAnimationFrame(t):this._engine.requestAnimationFrame(t),0},e.prototype._bindUnboundFramebuffer=function(t){this._currentFramebuffer!==t&&(this._currentFramebuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNBINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(this._currentFramebuffer),this._commandBufferEncoder.finishEncodingCommand()),t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()),this._currentFramebuffer=t)},e.prototype.getHostDocument=function(){return null},e.prototype.clear=function(t,i,n,a){if(a===void 0&&(a=!1),this.useReverseDepthBuffer)throw new Error("reverse depth buffer is not currently implemented");this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_CLEAR),this._commandBufferEncoder.encodeCommandArgAsUInt32(i&&t?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t?t.r:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t?t.g:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t?t.b:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t?t.a:1),this._commandBufferEncoder.encodeCommandArgAsUInt32(n?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(1),this._commandBufferEncoder.encodeCommandArgAsUInt32(a?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(0),this._commandBufferEncoder.finishEncodingCommand()},e.prototype.createIndexBuffer=function(t,i){var n=this._normalizeIndexData(t),a=new wt;return a.references=1,a.is32Bits=n.BYTES_PER_ELEMENT===4,n.byteLength&&(a.nativeIndexBuffer=this._engine.createIndexBuffer(n.buffer,n.byteOffset,n.byteLength,a.is32Bits,i!=null?i:!1)),a},e.prototype.createVertexBuffer=function(t,i){var n=ArrayBuffer.isView(t)?t:new Float32Array(t),a=new wt;return a.references=1,n.byteLength&&(a.nativeVertexBuffer=this._engine.createVertexBuffer(n.buffer,n.byteOffset,n.byteLength,i!=null?i:!1)),a},e.prototype._recordVertexArrayObject=function(t,i,n,a,s){n&&this._engine.recordIndexBuffer(t,n.nativeIndexBuffer);for(var o=a.getAttributesNames(),u=0;u<o.length;u++){var l=a.getAttributeLocation(u);if(l>=0){var h=o[u],c=null;if(s&&(c=s[h]),c||(c=i[h]),c){var _=c.getBuffer();_&&_.nativeVertexBuffer&&this._engine.recordVertexBuffer(t,_.nativeVertexBuffer,l,c.byteOffset,c.byteStride,c.getSize(),this._getNativeAttribType(c.type),c.normalized,c.getInstanceDivisor())}}}},e.prototype.bindBuffers=function(t,i,n){this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._boundBuffersVertexArray=this._engine.createVertexArray(),this._recordVertexArrayObject(this._boundBuffersVertexArray,t,i,n),this.bindVertexArrayObject(this._boundBuffersVertexArray)},e.prototype.recordVertexArrayObject=function(t,i,n,a){var s=this._engine.createVertexArray();return this._recordVertexArrayObject(s,t,i,n,a),s},e.prototype._deleteVertexArray=function(t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()},e.prototype.bindVertexArrayObject=function(t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()},e.prototype.releaseVertexArrayObject=function(t){this._deleteVertexArray(t)},e.prototype.getAttributes=function(t,i){var n=t;return this._engine.getAttributes(n.nativeProgram,i)},e.prototype.drawElementsType=function(t,i,n,a){this._drawCalls.addCount(1,!1),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXED),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.finishEncodingCommand()},e.prototype.drawArraysType=function(t,i,n,a){this._drawCalls.addCount(1,!1),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAW),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.finishEncodingCommand()},e.prototype.createPipelineContext=function(){return new Kr(this)},e.prototype.createMaterialContext=function(){},e.prototype.createDrawContext=function(){},e.prototype._preparePipelineContext=function(t,i,n,a,s,o,u,l,h){var c=t;a?c.nativeProgram=this.createRawShaderProgram(t,i,n,void 0,h):c.nativeProgram=this.createShaderProgram(t,i,n,l,void 0,h)},e.prototype._isRenderingStateCompiled=function(t){return!0},e.prototype._executeWhenRenderingStateIsCompiled=function(t,i){i()},e.prototype.createRawShaderProgram=function(t,i,n,a,s){throw new Error("Not Supported")},e.prototype.createShaderProgram=function(t,i,n,a,s,o){this.onBeforeShaderCompilationObservable.notifyObservers(this);var u=new et(i);u.processCode(),i=u.code;var l=new et(n);l.processCode(),n=l.code,i=P._ConcatenateShader(i,a),n=P._ConcatenateShader(n,a);var h=this._engine.createProgram(i,n);return this.onAfterShaderCompilationObservable.notifyObservers(this),h},e.prototype.inlineShaderCode=function(t){var i=new et(t);return i.debug=!1,i.processCode(),i.code},e.prototype._setProgram=function(t){this._currentProgram!==t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand(),this._currentProgram=t)},e.prototype._deletePipelineContext=function(t){var i=t;i&&i.nativeProgram&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(i.nativeProgram),this._commandBufferEncoder.finishEncodingCommand())},e.prototype.getUniforms=function(t,i){var n=t;return this._engine.getUniforms(n.nativeProgram,i)},e.prototype.bindUniformBlock=function(t,i,n){throw new Error("Not Implemented")},e.prototype.bindSamplers=function(t){var i=t.getPipelineContext();this._setProgram(i.nativeProgram);for(var n=t.getSamplers(),a=0;a<n.length;a++){var s=t.getUniform(n[a]);s&&(this._boundUniforms[a]=s)}this._currentEffect=null},e.prototype.setMatrix=function(t,i){if(!!t){var n=i.toArray();this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(n),this._commandBufferEncoder.finishEncodingCommand()}},e.prototype.getRenderWidth=function(t){return t===void 0&&(t=!1),!t&&this._currentRenderTarget?this._currentRenderTarget.width:this._engine.getRenderWidth()},e.prototype.getRenderHeight=function(t){return t===void 0&&(t=!1),!t&&this._currentRenderTarget?this._currentRenderTarget.height:this._engine.getRenderHeight()},e.prototype.setViewport=function(t,i,n){this._cachedViewport=t,this._engine.setViewPort(t.x,t.y,t.width,t.height)},e.prototype.setState=function(t,i,n,a,s,o,u){var l,h;i===void 0&&(i=0),a===void 0&&(a=!1),u===void 0&&(u=0),this._zOffset=i,this._zOffsetUnits=u,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTATE),this._commandBufferEncoder.encodeCommandArgAsUInt32(t?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(u),this._commandBufferEncoder.encodeCommandArgAsUInt32(!((h=(l=this.cullBackFaces)!==null&&l!==void 0?l:s)!==null&&h!==void 0)||h?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(a?1:0),this._commandBufferEncoder.finishEncodingCommand()},e.prototype.getInputElementClientRect=function(){var t={bottom:this.getRenderHeight(),height:this.getRenderHeight(),left:0,right:this.getRenderWidth(),top:0,width:this.getRenderWidth(),x:0,y:0,toJSON:function(){}};return t},e.prototype.setZOffset=function(t){t!==this._zOffset&&(this._zOffset=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSET),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-t:t),this._commandBufferEncoder.finishEncodingCommand())},e.prototype.getZOffset=function(){return this._zOffset},e.prototype.setZOffsetUnits=function(t){t!==this._zOffsetUnits&&(this._zOffsetUnits=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSETUNITS),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-t:t),this._commandBufferEncoder.finishEncodingCommand())},e.prototype.getZOffsetUnits=function(){return this._zOffsetUnits},e.prototype.setDepthBuffer=function(t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(t?this._currentDepthTest:_native.Engine.DEPTH_TEST_ALWAYS),this._commandBufferEncoder.finishEncodingCommand()},e.prototype.getDepthWrite=function(){return this._depthWrite},e.prototype.getDepthFunction=function(){switch(this._currentDepthTest){case _native.Engine.DEPTH_TEST_NEVER:return 512;case _native.Engine.DEPTH_TEST_ALWAYS:return 519;case _native.Engine.DEPTH_TEST_GREATER:return 516;case _native.Engine.DEPTH_TEST_GEQUAL:return 518;case _native.Engine.DEPTH_TEST_NOTEQUAL:return 517;case _native.Engine.DEPTH_TEST_EQUAL:return 514;case _native.Engine.DEPTH_TEST_LESS:return 513;case _native.Engine.DEPTH_TEST_LEQUAL:return 515}return null},e.prototype.setDepthFunction=function(t){var i=0;switch(t){case 512:i=_native.Engine.DEPTH_TEST_NEVER;break;case 519:i=_native.Engine.DEPTH_TEST_ALWAYS;break;case 516:i=_native.Engine.DEPTH_TEST_GREATER;break;case 518:i=_native.Engine.DEPTH_TEST_GEQUAL;break;case 517:i=_native.Engine.DEPTH_TEST_NOTEQUAL;break;case 514:i=_native.Engine.DEPTH_TEST_EQUAL;break;case 513:i=_native.Engine.DEPTH_TEST_LESS;break;case 515:i=_native.Engine.DEPTH_TEST_LEQUAL;break}this._currentDepthTest=i,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(this._currentDepthTest),this._commandBufferEncoder.finishEncodingCommand()},e.prototype.setDepthWrite=function(t){this._depthWrite=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(t)),this._commandBufferEncoder.finishEncodingCommand()},e.prototype.setColorWrite=function(t){this._colorWrite=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETCOLORWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(t)),this._commandBufferEncoder.finishEncodingCommand()},e.prototype.getColorWrite=function(){return this._colorWrite},e.prototype.applyStencil=function(){this._setStencil(this._stencilMask,this._getStencilOpFail(this._stencilOpStencilFail),this._getStencilDepthFail(this._stencilOpDepthFail),this._getStencilDepthPass(this._stencilOpStencilDepthPass),this._getStencilFunc(this._stencilFunc),this._stencilFuncRef)},e.prototype._setStencil=function(t,i,n,a,s,o){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTENCIL),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.encodeCommandArgAsUInt32(a),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.encodeCommandArgAsUInt32(o),this._commandBufferEncoder.finishEncodingCommand()},e.prototype.setStencilBuffer=function(t){this._stencilTest=t,t?this.applyStencil():this._setStencil(255,_native.Engine.STENCIL_OP_FAIL_S_KEEP,_native.Engine.STENCIL_OP_FAIL_Z_KEEP,_native.Engine.STENCIL_OP_PASS_Z_KEEP,_native.Engine.STENCIL_TEST_ALWAYS,0)},e.prototype.getStencilBuffer=function(){return this._stencilTest},e.prototype.getStencilOperationPass=function(){return this._stencilOpStencilDepthPass},e.prototype.setStencilOperationPass=function(t){this._stencilOpStencilDepthPass=t,this.applyStencil()},e.prototype.setStencilMask=function(t){this._stencilMask=t,this.applyStencil()},e.prototype.setStencilFunction=function(t){this._stencilFunc=t,this.applyStencil()},e.prototype.setStencilFunctionReference=function(t){this._stencilFuncRef=t,this.applyStencil()},e.prototype.setStencilFunctionMask=function(t){this._stencilFuncMask=t},e.prototype.setStencilOperationFail=function(t){this._stencilOpStencilFail=t,this.applyStencil()},e.prototype.setStencilOperationDepthFail=function(t){this._stencilOpDepthFail=t,this.applyStencil()},e.prototype.getStencilMask=function(){return this._stencilMask},e.prototype.getStencilFunction=function(){return this._stencilFunc},e.prototype.getStencilFunctionReference=function(){return this._stencilFuncRef},e.prototype.getStencilFunctionMask=function(){return this._stencilFuncMask},e.prototype.getStencilOperationFail=function(){return this._stencilOpStencilFail},e.prototype.getStencilOperationDepthFail=function(){return this._stencilOpDepthFail},e.prototype.setAlphaConstants=function(t,i,n,a){throw new Error("Setting alpha blend constant color not yet implemented.")},e.prototype.setAlphaMode=function(t,i){if(i===void 0&&(i=!1),this._alphaMode!==t){var n=this._getNativeAlphaMode(t);this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETBLENDMODE),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.finishEncodingCommand(),i||this.setDepthWrite(t===0),this._alphaMode=t}},e.prototype.getAlphaMode=function(){return this._alphaMode},e.prototype.setInt=function(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINT),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1},e.prototype.setIntArray=function(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1},e.prototype.setIntArray2=function(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1},e.prototype.setIntArray3=function(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1},e.prototype.setIntArray4=function(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1},e.prototype.setFloatArray=function(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1},e.prototype.setFloatArray2=function(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1},e.prototype.setFloatArray3=function(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1},e.prototype.setFloatArray4=function(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1},e.prototype.setArray=function(t,i){return t?this.setFloatArray(t,new Float32Array(i)):!1},e.prototype.setArray2=function(t,i){return t?this.setFloatArray2(t,new Float32Array(i)):!1},e.prototype.setArray3=function(t,i){return t?this.setFloatArray3(t,new Float32Array(i)):!1},e.prototype.setArray4=function(t,i){return t?this.setFloatArray4(t,new Float32Array(i)):!1},e.prototype.setMatrices=function(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRICES),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1},e.prototype.setMatrix3x3=function(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX3X3),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1},e.prototype.setMatrix2x2=function(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX2X2),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1},e.prototype.setFloat=function(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1},e.prototype.setFloat2=function(t,i,n){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT2),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(n),this._commandBufferEncoder.finishEncodingCommand(),!0):!1},e.prototype.setFloat3=function(t,i,n,a){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT3),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(n),this._commandBufferEncoder.encodeCommandArgAsFloat32(a),this._commandBufferEncoder.finishEncodingCommand(),!0):!1},e.prototype.setFloat4=function(t,i,n,a,s){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT4),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(n),this._commandBufferEncoder.encodeCommandArgAsFloat32(a),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.finishEncodingCommand(),!0):!1},e.prototype.setColor3=function(t,i){return t?(this.setFloat3(t,i.r,i.g,i.b),!0):!1},e.prototype.setColor4=function(t,i,n){return t?(this.setFloat4(t,i.r,i.g,i.b,n),!0):!1},e.prototype.wipeCaches=function(t){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,t&&(this._currentProgram=null,this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)},e.prototype._createTexture=function(){return this._engine.createTexture()},e.prototype._deleteTexture=function(t){t&&this._engine.deleteTexture(t)},e.prototype.updateDynamicTexture=function(t,i,n,a,s){if(!!t&&!!t._hardwareTexture){var o=i.getCanvasTexture(),u=t._hardwareTexture.underlyingResource;this._engine.copyTexture(u,o),t.isReady=!0}},e.prototype.createDynamicTexture=function(t,i,n,a){return t=Math.max(t,1),i=Math.max(i,1),this.createRawTexture(new Uint8Array(t*i*4),t,i,5,!1,!1,a)},e.prototype.createVideoElement=function(t){return this._camera?this._camera.createVideo(t):null},e.prototype.updateVideoTexture=function(t,i,n){if(t&&t._hardwareTexture&&this._camera){var a=t._hardwareTexture.underlyingResource;this._camera.updateVideoTexture(a,i,n)}},e.prototype.createRawTexture=function(t,i,n,a,s,o,u,l,h,c,_){l===void 0&&(l=null),h===void 0&&(h=0),_===void 0&&(_=!1);var d=new N(this,L.Raw);if(d.format=a,d.generateMipMaps=s,d.samplingMode=u,d.invertY=o,d.baseWidth=i,d.baseHeight=n,d.width=d.baseWidth,d.height=d.baseHeight,d._compression=l,d.type=h,d._useSRGBBuffer=this._getUseSRGBBuffer(_,!s),this.updateRawTexture(d,t,a,o,l,h,d._useSRGBBuffer),d._hardwareTexture){var g=d._hardwareTexture.underlyingResource,v=this._getNativeSamplingMode(u);this._setTextureSampling(g,v)}return this._internalTexturesCache.push(d),d},e.prototype.createRawTexture2DArray=function(t,i,n,a,s,o,u,l,h,c){c===void 0&&(c=0);var _=new N(this,L.Raw2DArray);if(_.baseWidth=i,_.baseHeight=n,_.baseDepth=a,_.width=i,_.height=n,_.depth=a,_.format=s,_.type=c,_.generateMipMaps=o,_.samplingMode=l,_.is2DArray=!0,_._hardwareTexture){var d=_._hardwareTexture.underlyingResource;this._engine.loadRawTexture2DArray(d,t,i,n,a,this._getNativeTextureFormat(s,c),o,u);var g=this._getNativeSamplingMode(l);this._setTextureSampling(d,g)}return _.isReady=!0,this._internalTexturesCache.push(_),_},e.prototype.updateRawTexture=function(t,i,n,a,s,o,u){if(o===void 0&&(o=0),!!t){if(i&&t._hardwareTexture){var l=t._hardwareTexture.underlyingResource;this._engine.loadRawTexture(l,i,t.width,t.height,this._getNativeTextureFormat(n,o),t.generateMipMaps,t.invertY)}t.isReady=!0}},e.prototype.createTexture=function(t,i,n,a,s,o,u,l,h,c,_,d,g,v,p){var m=this;s===void 0&&(s=3),o===void 0&&(o=null),u===void 0&&(u=null),l===void 0&&(l=null),h===void 0&&(h=null),c===void 0&&(c=null),_===void 0&&(_=null),p===void 0&&(p=!1),t=t||"";var E=t.substr(0,5)==="data:",T=E&&t.indexOf(";base64,")!==-1,R=h||new N(this,L.Url),y=t;this._transformTextureUrl&&!T&&!h&&!l&&(t=this._transformTextureUrl(t));for(var C=t.lastIndexOf("."),b=_||(C>-1?t.substring(C).toLowerCase():""),x=null,S=0,w=F._TextureLoaders;S<w.length;S++){var A=w[S];if(A.canLoad(b)){x=A;break}}a&&a.addPendingData(R),R.url=t,R.generateMipMaps=!i,R.samplingMode=s,R.invertY=n,R._useSRGBBuffer=this._getUseSRGBBuffer(p,i),this.doNotHandleContextLost||(R._buffer=l);var U=null;o&&!h&&(U=R.onLoadedObservable.add(o)),h||this._internalTexturesCache.push(R);var M=function(G,O){a&&a.removePendingData(R),t===y?(U&&R.onLoadedObservable.remove(U),Re.UseFallbackTexture&&m.createTexture(Re.FallbackTexture,i,R.invertY,a,s,null,u,l,R),u&&u((G||"Unknown error")+(Re.UseFallbackTexture?" - Fallback texture was used":""),O)):(I.Warn("Failed to load ".concat(t,", falling back to ").concat(y)),m.createTexture(y,i,R.invertY,a,s,o,u,l,R,c,_,d,g))};if(x)throw new Error("Loading textures from IInternalTextureLoader not yet implemented.");var q=function(G){if(!R._hardwareTexture){a&&a.removePendingData(R);return}var O=R._hardwareTexture.underlyingResource;m._engine.loadTexture(O,G,!i,n,p,function(){R.baseWidth=m._engine.getTextureWidth(O),R.baseHeight=m._engine.getTextureHeight(O),R.width=R.baseWidth,R.height=R.baseHeight,R.isReady=!0;var j=m._getNativeSamplingMode(s);m._setTextureSampling(O,j),a&&a.removePendingData(R),R.onLoadedObservable.notifyObservers(R),R.onLoadedObservable.clear()},function(){throw new Error("Could not load a native texture.")})};if(E&&l)if(l instanceof ArrayBuffer)q(new Uint8Array(l));else if(ArrayBuffer.isView(l))q(l);else if(typeof l=="string")q(new Uint8Array(ce.DecodeBase64(l)));else throw new Error("Unsupported buffer type");else T?q(new Uint8Array(ce.DecodeBase64(t))):this._loadFile(t,function(G){return q(new Uint8Array(G))},void 0,void 0,!0,function(G,O){M("Unable to load "+(G&&G.responseURL,O))});return R},e.prototype.wrapNativeTexture=function(t){var i=new yt(t,this._gl),n=new N(this,L.Unknown,!0);return n._hardwareTexture=i,n.isReady=!0,n},e.prototype.wrapWebGLTexture=function(){throw new Error("wrapWebGLTexture is not supported, use wrapNativeTexture instead.")},e.prototype._createDepthStencilTexture=function(t,i,n){var a=n,s=new N(this,L.DepthStencil),o=t.width||t,u=t.height||t,l=this._engine.createFrameBuffer(s._hardwareTexture.underlyingResource,o,u,_native.Engine.TEXTURE_FORMAT_RGBA8,!1,!0,!1);return a._framebufferDepthStencil=l,s},e.prototype._releaseFramebufferObjects=function(t){t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand())},e.prototype._createImageBitmapFromSource=function(t,i){var n=this,a=new Promise(function(s,o){var u=n.createCanvasImage();u.onload=function(){try{var l=n._engine.createImageBitmap(u);s(l)}catch(h){o("Error loading image ".concat(u.src," with exception: ").concat(h))}},u.onerror=function(l){o("Error loading image ".concat(u.src," with exception: ").concat(l))},u.src=t});return a},e.prototype.createImageBitmap=function(t,i){var n=this;return new Promise(function(a,s){if(Array.isArray(t)){var o=t;if(o.length){var u=n._engine.createImageBitmap(o[0]);if(u){a(u);return}}}s("Unsupported data for createImageBitmap.")})},e.prototype.resizeImageBitmap=function(t,i,n){return this._engine.resizeImageBitmap(t,i,n)},e.prototype.createCubeTexture=function(t,i,n,a,s,o,u,l,h,c,_,d,g,v){var p=this;s===void 0&&(s=null),o===void 0&&(o=null),l===void 0&&(l=null),c===void 0&&(c=0),_===void 0&&(_=0),d===void 0&&(d=null),v===void 0&&(v=!1);var m=d||new N(this,L.Cube);m.isCube=!0,m.url=t,m.generateMipMaps=!a,m._lodGenerationScale=c,m._lodGenerationOffset=_,this._doNotHandleContextLost||(m._extension=l,m._files=n);var E=t.lastIndexOf("."),T=l||(E>-1?t.substring(E).toLowerCase():"");if(T===".env"){var R=function(b){var x=yr(b);m.width=x.width,m.height=x.width,br(m,x);var S=x.specular;if(!S)throw new Error("Nothing else parsed so far");m._lodGenerationScale=S.lodGenerationScale;var w=Ar(b,x);m.format=5,m.type=0,m.generateMipMaps=!0,m.getEngine().updateTextureSamplingMode(Cr.TRILINEAR_SAMPLINGMODE,m),m._isRGBD=!0,m.invertY=!0,p._engine.loadCubeTextureWithMips(m._hardwareTexture.underlyingResource,w,!1,v,function(){m.isReady=!0,s&&s()},function(){throw new Error("Could not load a native cube texture.")})};if(n&&n.length===6)throw new Error("Multi-file loading not allowed on env files.");var y=function(b,x){o&&b&&o(b.status+" "+b.statusText,x)};this._loadFile(t,function(b){return R(new Uint8Array(b))},void 0,void 0,!0,y)}else{if(!n||n.length!==6)throw new Error("Cannot load cubemap because 6 files were not defined");var C=[n[0],n[3],n[1],n[4],n[2],n[5]];Promise.all(C.map(function(b){return ce.LoadFileAsync(b).then(function(x){return new Uint8Array(x)})})).then(function(b){return new Promise(function(x,S){p._engine.loadCubeTexture(m._hardwareTexture.underlyingResource,b,!a,!0,v,x,S)})}).then(function(){m.isReady=!0,s&&s()},function(b){o&&o("Failed to load cubemap: ".concat(b.message),b)})}return this._internalTexturesCache.push(m),m},e.prototype._createHardwareRenderTargetWrapper=function(t,i,n){var a=new Zr(t,i,n,this);return this._renderTargetWrapperCache.push(a),a},e.prototype.createRenderTargetTexture=function(t,i){var n=this._createHardwareRenderTargetWrapper(!1,!1,t),a={};i!==void 0&&typeof i=="object"?(a.generateMipMaps=i.generateMipMaps,a.generateDepthBuffer=i.generateDepthBuffer===void 0?!0:i.generateDepthBuffer,a.generateStencilBuffer=a.generateDepthBuffer&&i.generateStencilBuffer,a.type=i.type===void 0?0:i.type,a.samplingMode=i.samplingMode===void 0?3:i.samplingMode,a.format=i.format===void 0?5:i.format):(a.generateMipMaps=i,a.generateDepthBuffer=!0,a.generateStencilBuffer=!1,a.type=0,a.samplingMode=3,a.format=5),(a.type===1&&!this._caps.textureFloatLinearFiltering||a.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(a.samplingMode=1);var s=new N(this,L.RenderTarget),o=t.width||t,u=t.height||t;a.type===1&&!this._caps.textureFloat&&(a.type=0,I.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));var l=this._engine.createFrameBuffer(s._hardwareTexture.underlyingResource,o,u,this._getNativeTextureFormat(a.format,a.type),!!a.generateStencilBuffer,a.generateDepthBuffer,!!a.generateMipMaps);return n._framebuffer=l,n._generateDepthBuffer=a.generateDepthBuffer,n._generateStencilBuffer=!!a.generateStencilBuffer,s.baseWidth=o,s.baseHeight=u,s.width=o,s.height=u,s.isReady=!0,s.samples=1,s.generateMipMaps=!!a.generateMipMaps,s.samplingMode=a.samplingMode,s.type=a.type,s.format=a.format,this._internalTexturesCache.push(s),n.setTextures(s),n},e.prototype.updateTextureSamplingMode=function(t,i){if(i._hardwareTexture){var n=this._getNativeSamplingMode(t);this._setTextureSampling(i._hardwareTexture.underlyingResource,n)}i.samplingMode=t},e.prototype.bindFramebuffer=function(t,i,n,a,s){var o=t;if(i)throw new Error("Cuboid frame buffers are not yet supported in NativeEngine.");if(n||a)throw new Error("Required width/height for frame buffers not yet supported in NativeEngine.");o._framebufferDepthStencil?this._bindUnboundFramebuffer(o._framebufferDepthStencil):this._bindUnboundFramebuffer(o._framebuffer)},e.prototype.unBindFramebuffer=function(t,i,n){n&&n(),this._bindUnboundFramebuffer(null)},e.prototype.createDynamicVertexBuffer=function(t){return this.createVertexBuffer(t,!0)},e.prototype.updateDynamicIndexBuffer=function(t,i,n){n===void 0&&(n=0);var a=t,s=this._normalizeIndexData(i);a.is32Bits=s.BYTES_PER_ELEMENT===4,this._engine.updateDynamicIndexBuffer(a.nativeIndexBuffer,s.buffer,s.byteOffset,s.byteLength,n)},e.prototype.updateDynamicVertexBuffer=function(t,i,n,a){var s=t,o=ArrayBuffer.isView(i)?i:new Float32Array(i);this._engine.updateDynamicVertexBuffer(s.nativeVertexBuffer,o.buffer,o.byteOffset+(n!=null?n:0),a!=null?a:o.byteLength)},e.prototype._setTexture=function(t,i,n,a){a===void 0&&(a=!1);var s=this._boundUniforms[t];if(!s)return!1;if(!i)return this._boundTexturesCache[t]!=null&&(this._activeChannel=t,this._setTextureCore(s,null)),!1;if(i.video)this._activeChannel=t,i.update();else if(i.delayLoadState===4)return i.delayLoad(),!1;var o;return a?o=i.depthStencilTexture:i.isReady()?o=i.getInternalTexture():i.isCube?o=this.emptyCubeTexture:i.is3D?o=this.emptyTexture3D:i.is2DArray?o=this.emptyTexture2DArray:o=this.emptyTexture,this._activeChannel=t,!o||!o._hardwareTexture?!1:(this._setTextureWrapMode(o._hardwareTexture.underlyingResource,this._getAddressMode(i.wrapU),this._getAddressMode(i.wrapV),this._getAddressMode(i.wrapR)),this._updateAnisotropicLevel(i),this._setTextureCore(s,o._hardwareTexture.underlyingResource),!0)},e.prototype._setTextureSampling=function(t,i){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURESAMPLING),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand()},e.prototype._setTextureWrapMode=function(t,i,n,a){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREWRAPMODE),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.encodeCommandArgAsUInt32(a),this._commandBufferEncoder.finishEncodingCommand()},e.prototype._setTextureCore=function(t,i){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsNativeData(i),this._commandBufferEncoder.finishEncodingCommand()},e.prototype._updateAnisotropicLevel=function(t){var i=t.getInternalTexture(),n=t.anisotropicFilteringLevel;!i||!i._hardwareTexture||i._cachedAnisotropicFilteringLevel!==n&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREANISOTROPICLEVEL),this._commandBufferEncoder.encodeCommandArgAsNativeData(i._hardwareTexture.underlyingResource),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.finishEncodingCommand(),i._cachedAnisotropicFilteringLevel=n)},e.prototype._getAddressMode=function(t){switch(t){case 1:return _native.Engine.ADDRESS_MODE_WRAP;case 0:return _native.Engine.ADDRESS_MODE_CLAMP;case 2:return _native.Engine.ADDRESS_MODE_MIRROR;default:throw new Error("Unexpected wrap mode: "+t+".")}},e.prototype._bindTexture=function(t,i){var n=this._boundUniforms[t];if(!!n&&i&&i._hardwareTexture){var a=i._hardwareTexture.underlyingResource;this._setTextureCore(n,a)}},e.prototype._deleteBuffer=function(t){t.nativeIndexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEINDEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(t.nativeIndexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete t.nativeIndexBuffer),t.nativeVertexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(t.nativeVertexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete t.nativeVertexBuffer)},e.prototype.createCanvas=function(t,i){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");var n=new _native.Canvas;return n.width=t,n.height=i,n},e.prototype.createCanvasImage=function(){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");var t=new _native.Image;return t},e.prototype.updateTextureData=function(t,i,n,a,s,o,u,l,h){throw new Error("updateTextureData not implemented.")},e.prototype._uploadCompressedDataToTextureDirectly=function(t,i,n,a,s,o,u){throw new Error("_uploadCompressedDataToTextureDirectly not implemented.")},e.prototype._uploadDataToTextureDirectly=function(t,i,n,a){throw new Error("_uploadDataToTextureDirectly not implemented.")},e.prototype._uploadArrayBufferViewToTexture=function(t,i,n,a){throw new Error("_uploadArrayBufferViewToTexture not implemented.")},e.prototype._uploadImageToTexture=function(t,i,n,a){throw new Error("_uploadArrayBufferViewToTexture not implemented.")},e.prototype._getNativeSamplingMode=function(t){switch(t){case 1:return _native.Engine.TEXTURE_NEAREST_NEAREST;case 2:return _native.Engine.TEXTURE_LINEAR_LINEAR;case 3:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR;case 4:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST;case 5:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST;case 6:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR;case 7:return _native.Engine.TEXTURE_NEAREST_LINEAR;case 8:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR;case 9:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST;case 10:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR;case 11:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST;case 12:return _native.Engine.TEXTURE_LINEAR_NEAREST;default:throw new Error("Unsupported sampling mode: ".concat(t,"."))}},e.prototype._getStencilFunc=function(t){switch(t){case 513:return _native.Engine.STENCIL_TEST_LESS;case 515:return _native.Engine.STENCIL_TEST_LEQUAL;case 514:return _native.Engine.STENCIL_TEST_EQUAL;case 518:return _native.Engine.STENCIL_TEST_GEQUAL;case 516:return _native.Engine.STENCIL_TEST_GREATER;case 517:return _native.Engine.STENCIL_TEST_NOTEQUAL;case 512:return _native.Engine.STENCIL_TEST_NEVER;case 519:return _native.Engine.STENCIL_TEST_ALWAYS;default:throw new Error("Unsupported stencil func mode: ".concat(t,"."))}},e.prototype._getStencilOpFail=function(t){switch(t){case 7680:return _native.Engine.STENCIL_OP_FAIL_S_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_S_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_S_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_S_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_S_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_S_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_S_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_S_DECRSAT;default:throw new Error("Unsupported stencil OpFail mode: ".concat(t,"."))}},e.prototype._getStencilDepthFail=function(t){switch(t){case 7680:return _native.Engine.STENCIL_OP_FAIL_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_Z_DECRSAT;default:throw new Error("Unsupported stencil depthFail mode: ".concat(t,"."))}},e.prototype._getStencilDepthPass=function(t){switch(t){case 7680:return _native.Engine.STENCIL_OP_PASS_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_PASS_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_PASS_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_PASS_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_PASS_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_PASS_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_PASS_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_PASS_Z_DECRSAT;default:throw new Error("Unsupported stencil opPass mode: ".concat(t,"."))}},e.prototype._getNativeTextureFormat=function(t,i){if(t==4&&i==0)return _native.Engine.TEXTURE_FORMAT_RGB8;if(t==5&&i==0)return _native.Engine.TEXTURE_FORMAT_RGBA8;if(t==5&&i==1)return _native.Engine.TEXTURE_FORMAT_RGBA32F;throw new Tr("Unsupported texture format or type: format ".concat(t,", type ").concat(i,"."),Rr.UnsupportedTextureError)},e.prototype._getNativeAlphaMode=function(t){switch(t){case 0:return _native.Engine.ALPHA_DISABLE;case 1:return _native.Engine.ALPHA_ADD;case 2:return _native.Engine.ALPHA_COMBINE;case 3:return _native.Engine.ALPHA_SUBTRACT;case 4:return _native.Engine.ALPHA_MULTIPLY;case 5:return _native.Engine.ALPHA_MAXIMIZED;case 6:return _native.Engine.ALPHA_ONEONE;case 7:return _native.Engine.ALPHA_PREMULTIPLIED;case 8:return _native.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;case 9:return _native.Engine.ALPHA_INTERPOLATE;case 10:return _native.Engine.ALPHA_SCREENMODE;default:throw new Error("Unsupported alpha mode: ".concat(t,"."))}},e.prototype._getNativeAttribType=function(t){switch(t){case he.BYTE:return _native.Engine.ATTRIB_TYPE_INT8;case he.UNSIGNED_BYTE:return _native.Engine.ATTRIB_TYPE_UINT8;case he.SHORT:return _native.Engine.ATTRIB_TYPE_INT16;case he.UNSIGNED_SHORT:return _native.Engine.ATTRIB_TYPE_UINT16;case he.FLOAT:return _native.Engine.ATTRIB_TYPE_FLOAT;default:throw new Error("Unsupported attribute type: ".concat(t,"."))}},e.prototype.getFontOffset=function(t){var i={ascent:0,height:0,descent:0};return i},e.prototype._readTexturePixels=function(t,i,n,a,s,o,u,l,h,c){var _,d,g,v;if(a!==void 0&&a!==-1)throw new Error("Reading cubemap faces is not supported, but faceIndex is ".concat(a,"."));return this._engine.readTexture((_=t._hardwareTexture)===null||_===void 0?void 0:_.underlyingResource,s!=null?s:0,h!=null?h:0,c!=null?c:0,i,n,(d=o==null?void 0:o.buffer)!==null&&d!==void 0?d:null,(g=o==null?void 0:o.byteOffset)!==null&&g!==void 0?g:0,(v=o==null?void 0:o.byteLength)!==null&&v!==void 0?v:0).then(function(p){return o||(o=new Uint8Array(p)),o})},e.PROTOCOL_VERSION=6,e}(F);ur._createNativeDataStream=function(){return _native.NativeDataStream.VALIDATION_ENABLED?new $r:new bt};var $r=function(r){J(e,r);function e(){return r.call(this)||this}return e.prototype.writeUint32=function(t){r.prototype.writeUint32.call(this,_native.NativeDataStream.VALIDATION_UINT_32),r.prototype.writeUint32.call(this,t)},e.prototype.writeInt32=function(t){r.prototype.writeUint32.call(this,_native.NativeDataStream.VALIDATION_INT_32),r.prototype.writeInt32.call(this,t)},e.prototype.writeFloat32=function(t){r.prototype.writeUint32.call(this,_native.NativeDataStream.VALIDATION_FLOAT_32),r.prototype.writeFloat32.call(this,t)},e.prototype.writeUint32Array=function(t){r.prototype.writeUint32.call(this,_native.NativeDataStream.VALIDATION_UINT_32_ARRAY),r.prototype.writeUint32Array.call(this,t)},e.prototype.writeInt32Array=function(t){r.prototype.writeUint32.call(this,_native.NativeDataStream.VALIDATION_INT_32_ARRAY),r.prototype.writeInt32Array.call(this,t)},e.prototype.writeFloat32Array=function(t){r.prototype.writeUint32.call(this,_native.NativeDataStream.VALIDATION_FLOAT_32_ARRAY),r.prototype.writeFloat32Array.call(this,t)},e.prototype.writeNativeData=function(t){r.prototype.writeUint32.call(this,_native.NativeDataStream.VALIDATION_NATIVE_DATA),r.prototype.writeNativeData.call(this,t)},e.prototype.writeBoolean=function(t){r.prototype.writeUint32.call(this,_native.NativeDataStream.VALIDATION_BOOLEAN),r.prototype.writeBoolean.call(this,t)},e}(bt),Ft;(function(r){r.SRGB="srgb"})(Ft||(Ft={}));var Ut;(function(r){r.LowPower="low-power",r.HighPerformance="high-performance"})(Ut||(Ut={}));var Be;(function(r){r.DepthClipControl="depth-clip-control",r.Depth24UnormStencil8="depth24unorm-stencil8",r.Depth32FloatStencil8="depth32float-stencil8",r.TextureCompressionBC="texture-compression-bc",r.TextureCompressionETC2="texture-compression-etc2",r.TextureCompressionASTC="texture-compression-astc",r.TimestampQuery="timestamp-query",r.IndirectFirstInstance="indirect-first-instance",r.ShaderF16="shader-f16",r.BGRA8UnormStorage="bgra8unorm-storage"})(Be||(Be={}));var V;(function(r){r[r.MapRead=1]="MapRead",r[r.MapWrite=2]="MapWrite",r[r.CopySrc=4]="CopySrc",r[r.CopyDst=8]="CopyDst",r[r.Index=16]="Index",r[r.Vertex=32]="Vertex",r[r.Uniform=64]="Uniform",r[r.Storage=128]="Storage",r[r.Indirect=256]="Indirect",r[r.QueryResolve=512]="QueryResolve"})(V||(V={}));var Ue;(function(r){r[r.Read=1]="Read",r[r.Write=2]="Write"})(Ue||(Ue={}));var Se;(function(r){r.E1d="1d",r.E2d="2d",r.E3d="3d"})(Se||(Se={}));var X;(function(r){r[r.CopySrc=1]="CopySrc",r[r.CopyDst=2]="CopyDst",r[r.TextureBinding=4]="TextureBinding",r[r.StorageBinding=8]="StorageBinding",r[r.RenderAttachment=16]="RenderAttachment"})(X||(X={}));var W;(function(r){r.E1d="1d",r.E2d="2d",r.E2dArray="2d-array",r.Cube="cube",r.CubeArray="cube-array",r.E3d="3d"})(W||(W={}));var Te;(function(r){r.All="all",r.StencilOnly="stencil-only",r.DepthOnly="depth-only"})(Te||(Te={}));var f;(function(r){r.R8Unorm="r8unorm",r.R8Snorm="r8snorm",r.R8Uint="r8uint",r.R8Sint="r8sint",r.R16Uint="r16uint",r.R16Sint="r16sint",r.R16Float="r16float",r.RG8Unorm="rg8unorm",r.RG8Snorm="rg8snorm",r.RG8Uint="rg8uint",r.RG8Sint="rg8sint",r.R32Uint="r32uint",r.R32Sint="r32sint",r.R32Float="r32float",r.RG16Uint="rg16uint",r.RG16Sint="rg16sint",r.RG16Float="rg16float",r.RGBA8Unorm="rgba8unorm",r.RGBA8UnormSRGB="rgba8unorm-srgb",r.RGBA8Snorm="rgba8snorm",r.RGBA8Uint="rgba8uint",r.RGBA8Sint="rgba8sint",r.BGRA8Unorm="bgra8unorm",r.BGRA8UnormSRGB="bgra8unorm-srgb",r.RGB9E5UFloat="rgb9e5ufloat",r.RGB10A2Unorm="rgb10a2unorm",r.RG11B10UFloat="rg11b10ufloat",r.RG32Uint="rg32uint",r.RG32Sint="rg32sint",r.RG32Float="rg32float",r.RGBA16Uint="rgba16uint",r.RGBA16Sint="rgba16sint",r.RGBA16Float="rgba16float",r.RGBA32Uint="rgba32uint",r.RGBA32Sint="rgba32sint",r.RGBA32Float="rgba32float",r.Stencil8="stencil8",r.Depth16Unorm="depth16unorm",r.Depth24Plus="depth24plus",r.Depth24PlusStencil8="depth24plus-stencil8",r.Depth32Float="depth32float",r.BC1RGBAUnorm="bc1-rgba-unorm",r.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",r.BC2RGBAUnorm="bc2-rgba-unorm",r.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",r.BC3RGBAUnorm="bc3-rgba-unorm",r.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",r.BC4RUnorm="bc4-r-unorm",r.BC4RSnorm="bc4-r-snorm",r.BC5RGUnorm="bc5-rg-unorm",r.BC5RGSnorm="bc5-rg-snorm",r.BC6HRGBUFloat="bc6h-rgb-ufloat",r.BC6HRGBFloat="bc6h-rgb-float",r.BC7RGBAUnorm="bc7-rgba-unorm",r.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",r.ETC2RGB8Unorm="etc2-rgb8unorm",r.ETC2RGB8UnormSRGB="etc2-rgb8unorm-srgb",r.ETC2RGB8A1Unorm="etc2-rgb8a1unorm",r.ETC2RGB8A1UnormSRGB="etc2-rgb8a1unorm-srgb",r.ETC2RGBA8Unorm="etc2-rgba8unorm",r.ETC2RGBA8UnormSRGB="etc2-rgba8unorm-srgb",r.EACR11Unorm="eac-r11unorm",r.EACR11Snorm="eac-r11snorm",r.EACRG11Unorm="eac-rg11unorm",r.EACRG11Snorm="eac-rg11snorm",r.ASTC4x4Unorm="astc-4x4-unorm",r.ASTC4x4UnormSRGB="astc-4x4-unorm-srgb",r.ASTC5x4Unorm="astc-5x4-unorm",r.ASTC5x4UnormSRGB="astc-5x4-unorm-srgb",r.ASTC5x5Unorm="astc-5x5-unorm",r.ASTC5x5UnormSRGB="astc-5x5-unorm-srgb",r.ASTC6x5Unorm="astc-6x5-unorm",r.ASTC6x5UnormSRGB="astc-6x5-unorm-srgb",r.ASTC6x6Unorm="astc-6x6-unorm",r.ASTC6x6UnormSRGB="astc-6x6-unorm-srgb",r.ASTC8x5Unorm="astc-8x5-unorm",r.ASTC8x5UnormSRGB="astc-8x5-unorm-srgb",r.ASTC8x6Unorm="astc-8x6-unorm",r.ASTC8x6UnormSRGB="astc-8x6-unorm-srgb",r.ASTC8x8Unorm="astc-8x8-unorm",r.ASTC8x8UnormSRGB="astc-8x8-unorm-srgb",r.ASTC10x5Unorm="astc-10x5-unorm",r.ASTC10x5UnormSRGB="astc-10x5-unorm-srgb",r.ASTC10x6Unorm="astc-10x6-unorm",r.ASTC10x6UnormSRGB="astc-10x6-unorm-srgb",r.ASTC10x8Unorm="astc-10x8-unorm",r.ASTC10x8UnormSRGB="astc-10x8-unorm-srgb",r.ASTC10x10Unorm="astc-10x10-unorm",r.ASTC10x10UnormSRGB="astc-10x10-unorm-srgb",r.ASTC12x10Unorm="astc-12x10-unorm",r.ASTC12x10UnormSRGB="astc-12x10-unorm-srgb",r.ASTC12x12Unorm="astc-12x12-unorm",r.ASTC12x12UnormSRGB="astc-12x12-unorm-srgb",r.Depth24UnormStencil8="depth24unorm-stencil8",r.Depth32FloatStencil8="depth32float-stencil8"})(f||(f={}));var Me;(function(r){r.ClampToEdge="clamp-to-edge",r.Repeat="repeat",r.MirrorRepeat="mirror-repeat"})(Me||(Me={}));var D;(function(r){r.Nearest="nearest",r.Linear="linear"})(D||(D={}));var K;(function(r){r.Never="never",r.Less="less",r.Equal="equal",r.LessEqual="less-equal",r.Greater="greater",r.NotEqual="not-equal",r.GreaterEqual="greater-equal",r.Always="always"})(K||(K={}));var ye;(function(r){r[r.Vertex=1]="Vertex",r[r.Fragment=2]="Fragment",r[r.Compute=4]="Compute"})(ye||(ye={}));var Ce;(function(r){r.Uniform="uniform",r.Storage="storage",r.ReadOnlyStorage="read-only-storage"})(Ce||(Ce={}));var xe;(function(r){r.Filtering="filtering",r.NonFiltering="non-filtering",r.Comparison="comparison"})(xe||(xe={}));var oe;(function(r){r.Float="float",r.UnfilterableFloat="unfilterable-float",r.Depth="depth",r.Sint="sint",r.Uint="uint"})(oe||(oe={}));var mt;(function(r){r.WriteOnly="write-only"})(mt||(mt={}));var It;(function(r){r.Error="error",r.Warning="warning",r.Info="info"})(It||(It={}));var rt;(function(r){r.Auto="auto"})(rt||(rt={}));var le;(function(r){r.PointList="point-list",r.LineList="line-list",r.LineStrip="line-strip",r.TriangleList="triangle-list",r.TriangleStrip="triangle-strip"})(le||(le={}));var it;(function(r){r.CCW="ccw",r.CW="cw"})(it||(it={}));var Ne;(function(r){r.None="none",r.Front="front",r.Back="back"})(Ne||(Ne={}));var Dt;(function(r){r[r.Red=1]="Red",r[r.Green=2]="Green",r[r.Blue=4]="Blue",r[r.Alpha=8]="Alpha",r[r.All=15]="All"})(Dt||(Dt={}));var ie;(function(r){r.Zero="zero",r.One="one",r.Src="src",r.OneMinusSrc="one-minus-src",r.SrcAlpha="src-alpha",r.OneMinusSrcAlpha="one-minus-src-alpha",r.Dst="dst",r.OneMinusDst="one-minus-dst",r.DstAlpha="dst-alpha",r.OneMinusDstAlpha="one-minus-dst-alpha",r.SrcAlphaSaturated="src-alpha-saturated",r.Constant="constant",r.OneMinusConstant="one-minus-constant"})(ie||(ie={}));var be;(function(r){r.Add="add",r.Subtract="subtract",r.ReverseSubtract="reverse-subtract",r.Min="min",r.Max="max"})(be||(be={}));var ge;(function(r){r.Keep="keep",r.Zero="zero",r.Replace="replace",r.Invert="invert",r.IncrementClamp="increment-clamp",r.DecrementClamp="decrement-clamp",r.IncrementWrap="increment-wrap",r.DecrementWrap="decrement-wrap"})(ge||(ge={}));var Ie;(function(r){r.Uint16="uint16",r.Uint32="uint32"})(Ie||(Ie={}));var k;(function(r){r.Uint8x2="uint8x2",r.Uint8x4="uint8x4",r.Sint8x2="sint8x2",r.Sint8x4="sint8x4",r.Unorm8x2="unorm8x2",r.Unorm8x4="unorm8x4",r.Snorm8x2="snorm8x2",r.Snorm8x4="snorm8x4",r.Uint16x2="uint16x2",r.Uint16x4="uint16x4",r.Sint16x2="sint16x2",r.Sint16x4="sint16x4",r.Unorm16x2="unorm16x2",r.Unorm16x4="unorm16x4",r.Snorm16x2="snorm16x2",r.Snorm16x4="snorm16x4",r.Float16x2="float16x2",r.Float16x4="float16x4",r.Float32="float32",r.Float32x2="float32x2",r.Float32x3="float32x3",r.Float32x4="float32x4",r.Uint32="uint32",r.Uint32x2="uint32x2",r.Uint32x3="uint32x3",r.Uint32x4="uint32x4",r.Sint32="sint32",r.Sint32x2="sint32x2",r.Sint32x3="sint32x3",r.Sint32x4="sint32x4"})(k||(k={}));var nt;(function(r){r.Vertex="vertex",r.Instance="instance"})(nt||(nt={}));var Lt;(function(r){r.Beginning="beginning",r.End="end"})(Lt||(Lt={}));var Mt;(function(r){r.Beginning="beginning",r.End="end"})(Mt||(Mt={}));var z;(function(r){r.Load="load",r.Clear="clear"})(z||(z={}));var _e;(function(r){r.Store="store",r.Discard="discard"})(_e||(_e={}));var at;(function(r){r.Occlusion="occlusion",r.Timestamp="timestamp"})(at||(at={}));var st;(function(r){r.Opaque="opaque",r.Premultiplied="premultiplied"})(st||(st={}));var Ot;(function(r){r.Destroyed="destroyed"})(Ot||(Ot={}));var Gt;(function(r){r.OutOfMemory="out-of-memory",r.Validation="validation"})(Gt||(Gt={}));var te=function(){function r(){this.shaderLanguage=Z.GLSL}return r.prototype._addUniformToLeftOverUBO=function(e,t,i){var n,a=0;n=this._getArraySize(e,t,i),e=n[0],t=n[1],a=n[2];for(var s=0;s<this._webgpuProcessingContext.leftOverUniforms.length;s++)if(this._webgpuProcessingContext.leftOverUniforms[s].name===e)return;this._webgpuProcessingContext.leftOverUniforms.push({name:e,type:t,length:a})},r.prototype._buildLeftOverUBO=function(){if(!this._webgpuProcessingContext.leftOverUniforms.length)return"";var e=r.LeftOvertUBOName,t=this._webgpuProcessingContext.availableBuffers[e];return t||(t={binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[e]=t,this._addBufferBindingDescription(e,t,Ce.Uniform,!0),this._addBufferBindingDescription(e,t,Ce.Uniform,!1)),this._generateLeftOverUBOCode(e,t)},r.prototype._collectBindingNames=function(){for(var e=0;e<this._webgpuProcessingContext.bindGroupLayoutEntries.length;e++){var t=this._webgpuProcessingContext.bindGroupLayoutEntries[e];if(t===void 0){this._webgpuProcessingContext.bindGroupLayoutEntries[e]=[];continue}for(var i=0;i<t.length;i++){var n=this._webgpuProcessingContext.bindGroupLayoutEntries[e][i],a=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][n.binding].name,s=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][n.binding].nameInArrayOfTexture;n&&(n.texture||n.externalTexture||n.storageTexture?this._webgpuProcessingContext.textureNames.push(s):n.sampler?this._webgpuProcessingContext.samplerNames.push(a):n.buffer&&this._webgpuProcessingContext.bufferNames.push(a))}}},r.prototype._preCreateBindGroupEntries=function(){for(var e=this._webgpuProcessingContext.bindGroupEntries,t=0;t<this._webgpuProcessingContext.bindGroupLayoutEntries.length;t++){for(var i=this._webgpuProcessingContext.bindGroupLayoutEntries[t],n=[],a=0;a<i.length;a++){var s=this._webgpuProcessingContext.bindGroupLayoutEntries[t][a];s.sampler||s.texture||s.storageTexture||s.externalTexture?n.push({binding:s.binding,resource:void 0}):s.buffer&&n.push({binding:s.binding,resource:{buffer:void 0,offset:0,size:0}})}e[t]=n}},r.prototype._addTextureBindingDescription=function(e,t,i,n,a,s){var o=t.textures[i],u=o.groupIndex,l=o.bindingIndex;if(this._webgpuProcessingContext.bindGroupLayoutEntries[u]||(this._webgpuProcessingContext.bindGroupLayoutEntries[u]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[u]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[u][l]){var h=void 0;n===null?h=this._webgpuProcessingContext.bindGroupLayoutEntries[u].push({binding:l,visibility:0,externalTexture:{}}):a?h=this._webgpuProcessingContext.bindGroupLayoutEntries[u].push({binding:l,visibility:0,storageTexture:{access:mt.WriteOnly,format:a,viewDimension:n}}):h=this._webgpuProcessingContext.bindGroupLayoutEntries[u].push({binding:l,visibility:0,texture:{sampleType:t.sampleType,viewDimension:n,multisampled:!1}});var c=t.isTextureArray?e+i:e;this._webgpuProcessingContext.bindGroupLayoutEntryInfo[u][l]={name:e,index:h-1,nameInArrayOfTexture:c}}l=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[u][l].index,s?this._webgpuProcessingContext.bindGroupLayoutEntries[u][l].visibility|=ye.Vertex:this._webgpuProcessingContext.bindGroupLayoutEntries[u][l].visibility|=ye.Fragment},r.prototype._addSamplerBindingDescription=function(e,t,i){var n=t.binding,a=n.groupIndex,s=n.bindingIndex;if(this._webgpuProcessingContext.bindGroupLayoutEntries[a]||(this._webgpuProcessingContext.bindGroupLayoutEntries[a]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][s]){var o=this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:s,visibility:0,sampler:{type:t.type}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][s]={name:e,index:o-1}}s=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][s].index,i?this._webgpuProcessingContext.bindGroupLayoutEntries[a][s].visibility|=ye.Vertex:this._webgpuProcessingContext.bindGroupLayoutEntries[a][s].visibility|=ye.Fragment},r.prototype._addBufferBindingDescription=function(e,t,i,n){var a=t.binding,s=a.groupIndex,o=a.bindingIndex;if(this._webgpuProcessingContext.bindGroupLayoutEntries[s]||(this._webgpuProcessingContext.bindGroupLayoutEntries[s]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][o]){var u=this._webgpuProcessingContext.bindGroupLayoutEntries[s].push({binding:o,visibility:0,buffer:{type:i}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][o]={name:e,index:u-1}}o=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][o].index,n?this._webgpuProcessingContext.bindGroupLayoutEntries[s][o].visibility|=ye.Vertex:this._webgpuProcessingContext.bindGroupLayoutEntries[s][o].visibility|=ye.Fragment},r.prototype._injectStartingAndEndingCode=function(e,t,i,n){if(i){var a=e.indexOf(t);if(a>=0){for(;a++<e.length&&e.charAt(a)!="{";);if(a<e.length){for(;a++<e.length&&e.charAt(a)!=`
`;);if(a<e.length){var s=e.substring(0,a+1),o=e.substring(a+1);e=s+i+o}}}}if(n){var u=e.lastIndexOf("}");e=e.substring(0,u),e+=n+`
}`}return e},r.AutoSamplerSuffix="Sampler",r.LeftOvertUBOName="LeftOver",r.InternalsUBOName="Internals",r.UniformSizes={bool:1,int:1,float:1,vec2:2,ivec2:2,vec3:3,ivec3:3,vec4:4,ivec4:4,mat2:4,mat3:12,mat4:16,i32:1,u32:1,f32:1,mat2x2:4,mat3x3:12,mat4x4:16},r._SamplerFunctionByWebGLSamplerType={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube",sampler3D:"sampler3D"},r._TextureTypeByWebGLSamplerType={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray",sampler3D:"texture3D"},r._GpuTextureViewDimensionByWebGPUTextureType={textureCube:W.Cube,textureCubeArray:W.CubeArray,texture2D:W.E2d,texture2DArray:W.E2dArray,texture3D:W.E3d},r._SamplerTypeByWebGLSamplerType={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"},r._IsComparisonSamplerByWebGPUSamplerType={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1},r}(),ei=function(){function r(e,t){this._name="unnamed",this.shaderProcessingContext=e,this._leftOverUniformsByName={},this.engine=t}return Object.defineProperty(r.prototype,"isAsync",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isReady",{get:function(){return!!this.stages},enumerable:!1,configurable:!0}),r.prototype._handlesSpectorRebuildCallback=function(){},r.prototype._fillEffectInformation=function(e,t,i,n,a,s,o,u){var l=this.engine;e._fragmentSourceCode="",e._vertexSourceCode="";var h=this.shaderProcessingContext.availableTextures,c;for(c=0;c<a.length;c++){var _=a[c],d=h[a[c]];d==null||d==null?(a.splice(c,1),c--):s[_]=c}for(var g=0,v=l.getAttributes(this,o);g<v.length;g++){var p=v[g];u.push(p)}this.buildUniformLayout();var m=[],E=[];for(c=0;c<o.length;c++){var T=u[c];T>=0&&(m.push(o[c]),E.push(T))}this.shaderProcessingContext.attributeNamesFromEffect=m,this.shaderProcessingContext.attributeLocationsFromEffect=E},r.prototype.buildUniformLayout=function(){if(!!this.shaderProcessingContext.leftOverUniforms.length){this.uniformBuffer=new Oe(this.engine,void 0,void 0,"leftOver-"+this._name);for(var e=0,t=this.shaderProcessingContext.leftOverUniforms;e<t.length;e++){var i=t[e],n=i.type.replace(/^(.*?)(<.*>)?$/,"$1"),a=te.UniformSizes[n];this.uniformBuffer.addUniform(i.name,a,i.length),this._leftOverUniformsByName[i.name]=i.type}this.uniformBuffer.create()}},r.prototype.dispose=function(){this.uniformBuffer&&this.uniformBuffer.dispose()},r.prototype.setInt=function(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt(e,t)},r.prototype.setInt2=function(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt2(e,t,i)},r.prototype.setInt3=function(e,t,i,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt3(e,t,i,n)},r.prototype.setInt4=function(e,t,i,n,a){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt4(e,t,i,n,a)},r.prototype.setIntArray=function(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateIntArray(e,t)},r.prototype.setIntArray2=function(e,t){this.setIntArray(e,t)},r.prototype.setIntArray3=function(e,t){this.setIntArray(e,t)},r.prototype.setIntArray4=function(e,t){this.setIntArray(e,t)},r.prototype.setArray=function(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateArray(e,t)},r.prototype.setArray2=function(e,t){this.setArray(e,t)},r.prototype.setArray3=function(e,t){this.setArray(e,t)},r.prototype.setArray4=function(e,t){this.setArray(e,t)},r.prototype.setMatrices=function(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrices(e,t)},r.prototype.setMatrix=function(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix(e,t)},r.prototype.setMatrix3x3=function(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix3x3(e,t)},r.prototype.setMatrix2x2=function(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix2x2(e,t)},r.prototype.setFloat=function(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat(e,t)},r.prototype.setVector2=function(e,t){this.setFloat2(e,t.x,t.y)},r.prototype.setFloat2=function(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat2(e,t,i)},r.prototype.setVector3=function(e,t){this.setFloat3(e,t.x,t.y,t.z)},r.prototype.setFloat3=function(e,t,i,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat3(e,t,i,n)},r.prototype.setVector4=function(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)},r.prototype.setQuaternion=function(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)},r.prototype.setFloat4=function(e,t,i,n,a){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat4(e,t,i,n,a)},r.prototype.setColor3=function(e,t){this.setFloat3(e,t.r,t.g,t.b)},r.prototype.setColor4=function(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)},r.prototype.setDirectColor4=function(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)},r.prototype._getVertexShaderCode=function(){var e;return(e=this.sources)===null||e===void 0?void 0:e.vertex},r.prototype._getFragmentShaderCode=function(){var e;return(e=this.sources)===null||e===void 0?void 0:e.fragment},r}(),ti=4,ri=1<<16,Nt={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4},Xe=function(){function r(e){this.shaderLanguage=e,this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],this._findStartingGroupBinding()}return Object.defineProperty(r,"KnownUBOs",{get:function(){return r._SimplifiedKnownBindings?r._SimplifiedKnownUBOs:r._KnownUBOs},enumerable:!1,configurable:!0}),r.prototype._findStartingGroupBinding=function(){var e=r.KnownUBOs,t=[];for(var i in e){var n=e[i].binding;n.groupIndex!==-1&&(t[n.groupIndex]===void 0?t[n.groupIndex]=n.bindingIndex:t[n.groupIndex]=Math.max(t[n.groupIndex],n.bindingIndex))}this.freeGroupIndex=t.length-1,this.freeGroupIndex===0?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=t[t.length-1]+1},r.prototype.getAttributeNextLocation=function(e,t){var i;t===void 0&&(t=0);var n=this._attributeNextLocation;return this._attributeNextLocation+=((i=Nt[e])!==null&&i!==void 0?i:1)*(t||1),n},r.prototype.getVaryingNextLocation=function(e,t){var i;t===void 0&&(t=0);var n=this._varyingNextLocation;return this._varyingNextLocation+=((i=Nt[e])!==null&&i!==void 0?i:1)*(t||1),n},r.prototype.getNextFreeUBOBinding=function(){return this._getNextFreeBinding(1)},r.prototype._getNextFreeBinding=function(e){if(this.freeBindingIndex>ri-e&&(this.freeGroupIndex++,this.freeBindingIndex=0),this.freeGroupIndex===ti)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";var t={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=e,t},r._SimplifiedKnownBindings=!0,r._SimplifiedKnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}},r._KnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}},r}(),ii=function(r){J(e,r);function e(){var t=r!==null&&r.apply(this,arguments)||this;return t._missingVaryings=[],t._textureArrayProcessing=[],t.shaderLanguage=Z.GLSL,t}return e.prototype._getArraySize=function(t,i,n){var a=0,s=t.indexOf("["),o=t.indexOf("]");if(s>0&&o>0){var u=t.substring(s+1,o);a=+u,isNaN(a)&&(a=+n[u.trim()]),t=t.substr(0,s)}return[t,i,a]},e.prototype.initializeShaders=function(t){this._webgpuProcessingContext=t,this._missingVaryings.length=0,this._textureArrayProcessing.length=0},e.prototype.preProcessShaderCode=function(t,i){var n="uniform ".concat(te.InternalsUBOName,` {
float yFactor_;
float textureOutputHeight_;
};
`);return i?n+`##INJECTCODE##
`+t:n+t},e.prototype.varyingProcessor=function(t,i,n){this._preProcessors=n;var a=/\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,s=a.exec(t);if(s!=null){var o=s[1],u=s[2],l;i?(l=this._webgpuProcessingContext.availableVaryings[u],this._missingVaryings[l]="",l===void 0&&I.Warn('Invalid fragment shader: The varying named "'.concat(u,'" is not declared in the vertex shader! This declaration will be ignored.'))):(l=this._webgpuProcessingContext.getVaryingNextLocation(o,this._getArraySize(u,o,n)[2]),this._webgpuProcessingContext.availableVaryings[u]=l,this._missingVaryings[l]="layout(location = ".concat(l,") in ").concat(o," ").concat(u,";")),t=t.replace(s[0],l===void 0?"":"layout(location = ".concat(l,") ").concat(i?"in":"out"," ").concat(o," ").concat(u,";"))}return t},e.prototype.attributeProcessor=function(t,i){this._preProcessors=i;var n=/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm,a=n.exec(t);if(a!=null){var s=a[1],o=a[2],u=this._webgpuProcessingContext.getAttributeNextLocation(s,this._getArraySize(o,s,i)[2]);this._webgpuProcessingContext.availableAttributes[o]=u,this._webgpuProcessingContext.orderedAttributes[u]=o,t=t.replace(a[0],"layout(location = ".concat(u,") in ").concat(s," ").concat(o,";"))}return t},e.prototype.uniformProcessor=function(t,i,n){var a,s;this._preProcessors=n;var o=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,u=o.exec(t);if(u!=null){var l=u[1],h=u[2];if(l.indexOf("sampler")===0||l.indexOf("sampler")===1){var c=0;a=this._getArraySize(h,l,n),h=a[0],l=a[1],c=a[2];var _=this._webgpuProcessingContext.availableTextures[h];if(!_){_={autoBindSampler:!0,isTextureArray:c>0,isStorageTexture:!1,textures:[],sampleType:oe.Float};for(var d=0;d<(c||1);++d)_.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}var g=(s=te._SamplerTypeByWebGLSamplerType[l])!==null&&s!==void 0?s:"sampler",v=!!te._IsComparisonSamplerByWebGPUSamplerType[g],p=v?xe.Comparison:xe.Filtering,m=h+te.AutoSamplerSuffix,E=this._webgpuProcessingContext.availableSamplers[m];E||(E={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:p});var T=l.charAt(0)==="u"?"u":l.charAt(0)==="i"?"i":"";T&&(l=l.substr(1));var R=v?oe.Depth:T==="u"?oe.Uint:T==="i"?oe.Sint:oe.Float;_.sampleType=R;var y=c>0,C=E.binding.groupIndex,b=E.binding.bindingIndex,x=te._SamplerFunctionByWebGLSamplerType[l],S=te._TextureTypeByWebGLSamplerType[l],w=te._GpuTextureViewDimensionByWebGPUTextureType[S];if(!y)c=1,t="layout(set = ".concat(C,", binding = ").concat(b,") uniform ").concat(T).concat(g," ").concat(m,`;
                        layout(set = `).concat(_.textures[0].groupIndex,", binding = ").concat(_.textures[0].bindingIndex,") uniform ").concat(S," ").concat(h,`Texture;
                        #define `).concat(h," ").concat(T).concat(x,"(").concat(h,"Texture, ").concat(m,")");else{var A=[];A.push("layout(set = ".concat(C,", binding = ").concat(b,") uniform ").concat(T).concat(g," ").concat(m,";")),t=`\r
`;for(var d=0;d<c;++d){var U=_.textures[d].groupIndex,M=_.textures[d].bindingIndex;A.push("layout(set = ".concat(U,", binding = ").concat(M,") uniform ").concat(S," ").concat(h,"Texture").concat(d,";")),t+="".concat(d>0?`\r
`:"","#define ").concat(h).concat(d," ").concat(T).concat(x,"(").concat(h,"Texture").concat(d,", ").concat(m,")")}t=A.join(`\r
`)+t,this._textureArrayProcessing.push(h)}this._webgpuProcessingContext.availableTextures[h]=_,this._webgpuProcessingContext.availableSamplers[m]=E,this._addSamplerBindingDescription(m,E,!i);for(var d=0;d<c;++d)this._addTextureBindingDescription(h,_,d,w,null,!i)}else this._addUniformToLeftOverUBO(h,l,n),t=""}return t},e.prototype.uniformBufferProcessor=function(t,i){var n=/uniform\s+(\w+)/gm,a=n.exec(t);if(a!=null){var s=a[1],o=this._webgpuProcessingContext.availableBuffers[s];if(!o){var u=Xe.KnownUBOs[s],l=void 0;u&&u.binding.groupIndex!==-1?l=u.binding:l=this._webgpuProcessingContext.getNextFreeUBOBinding(),o={binding:l},this._webgpuProcessingContext.availableBuffers[s]=o}this._addBufferBindingDescription(s,o,Ce.Uniform,!i),t=t.replace("uniform","layout(set = ".concat(o.binding.groupIndex,", binding = ").concat(o.binding.bindingIndex,") uniform"))}return t},e.prototype.postProcessor=function(t,i,n,a,s){var o=t.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,u=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(t=t.replace(u,""),t=t.replace(/texture2D\s*\(/g,"texture("),n){var l=t.indexOf("gl_FragCoord")>=0,h=`
                glFragCoord_ = gl_FragCoord;
                if (yFactor_ == 1.) {
                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;
                }
            `,c=l?`vec4 glFragCoord_;
`:"";t=t.replace(/texture2DLodEXT\s*\(/g,"textureLod("),t=t.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),t=t.replace(/textureCube\s*\(/g,"texture("),t=t.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),t=t.replace(/gl_FragColor/g,"glFragColor"),t=t.replace(/gl_FragData/g,"glFragData"),t=t.replace(/gl_FragCoord/g,"glFragCoord_"),t=t.replace(/void\s+?main\s*\(/g,(o?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main("),t=t.replace(/dFdy/g,"(-yFactor_)*dFdy"),t=t.replace("##INJECTCODE##",c),l&&(t=this._injectStartingAndEndingCode(t,"void main",h))}else{t=t.replace(/gl_InstanceID/g,"gl_InstanceIndex"),t=t.replace(/gl_VertexID/g,"gl_VertexIndex");var _=i.indexOf("#define MULTIVIEW")!==-1;if(_)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+t}if(!n){var d=t.lastIndexOf("}");t=t.substring(0,d),t+=`gl_Position.y *= yFactor_;
`,s.isNDCHalfZRange||(t+=`gl_Position.z = (gl_Position.z + gl_Position.w) / 2.0;
`),t+="}"}return t},e.prototype._applyTextureArrayProcessing=function(t,i){for(var n=new RegExp(i+"\\s*\\[(.+)?\\]","gm"),a=n.exec(t);a!=null;){var s=a[1],o=+s;this._preProcessors&&isNaN(o)&&(o=+this._preProcessors[s.trim()]),t=t.replace(a[0],i+o),a=n.exec(t)}return t},e.prototype._generateLeftOverUBOCode=function(t,i){for(var n="layout(set = ".concat(i.binding.groupIndex,", binding = ").concat(i.binding.bindingIndex,") uniform ").concat(t,` {
    `),a=0,s=this._webgpuProcessingContext.leftOverUniforms;a<s.length;a++){var o=s[a];o.length>0?n+="    ".concat(o.type," ").concat(o.name,"[").concat(o.length,`];
`):n+="    ".concat(o.type," ").concat(o.name,`;
`)}return n+=`};

`,n},e.prototype.finalizeShaders=function(t,i){for(var n=0;n<this._textureArrayProcessing.length;++n){var a=this._textureArrayProcessing[n];t=this._applyTextureArrayProcessing(t,a),i=this._applyTextureArrayProcessing(i,a)}for(var n=0;n<this._missingVaryings.length;++n){var s=this._missingVaryings[n];s&&s.length>0&&(i=s+`
`+i)}var o=this._buildLeftOverUBO();return t=o+t,i=o+i,this._collectBindingNames(),this._preCreateBindGroupEntries(),this._preProcessors=null,{vertexCode:t,fragmentCode:i}},e}(te),Wt="gl_VertexID",Vt="gl_InstanceID",Xt="gl_Position",Ht="gl_FragCoord",kt="gl_FrontFacing",Ke="gl_FragDepth",Yt="gl_FragColor",ni="uniforms",ai="internals",si={texture_1d:W.E1d,texture_2d:W.E2d,texture_2d_array:W.E2dArray,texture_3d:W.E3d,texture_cube:W.Cube,texture_cube_array:W.CubeArray,texture_multisampled_2d:W.E2d,texture_depth_2d:W.E2d,texture_depth_2d_array:W.E2dArray,texture_depth_cube:W.Cube,texture_depth_cube_array:W.CubeArray,texture_depth_multisampled_2d:W.E2d,texture_storage_1d:W.E1d,texture_storage_2d:W.E2d,texture_storage_2d_array:W.E2dArray,texture_storage_3d:W.E3d,texture_external:null},oi=function(r){J(e,r);function e(){var t=r!==null&&r.apply(this,arguments)||this;return t.shaderLanguage=Z.WGSL,t.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,t.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,t.noPrecision=!0,t}return e.prototype._getArraySize=function(t,i,n){var a=0,s=i.lastIndexOf(">");if(i.indexOf("array")>=0&&s>0){for(var o=s;o>0&&i.charAt(o)!==" "&&i.charAt(o)!==",";)o--;var u=i.substring(o+1,s);for(a=+u,isNaN(a)&&(a=+n[u.trim()]);o>0&&(i.charAt(o)===" "||i.charAt(o)===",");)o--;i=i.substring(i.indexOf("<")+1,o+1)}return[t,i,a]},e.prototype.initializeShaders=function(t){this._webgpuProcessingContext=t,this._attributesWGSL=[],this._attributesDeclWGSL=[],this._attributeNamesWGSL=[],this._varyingsWGSL=[],this._varyingsDeclWGSL=[],this._varyingNamesWGSL=[],this._stridedUniformArrays=[]},e.prototype.preProcessShaderCode=function(t){return"struct ".concat(te.InternalsUBOName,` {
yFactor_: f32,
textureOutputHeight_: f32,
};
var<uniform> `).concat(ai," : ").concat(te.InternalsUBOName,`;
`)+pt(t)},e.prototype.varyingProcessor=function(t,i,n){var a=/\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm,s=a.exec(t);if(s!==null){var o=s[2],u=s[1],l;i?(l=this._webgpuProcessingContext.availableVaryings[u],l===void 0&&I.Warn('Invalid fragment shader: The varying named "'.concat(u,'" is not declared in the vertex shader! This declaration will be ignored.'))):(l=this._webgpuProcessingContext.getVaryingNextLocation(o,this._getArraySize(u,o,n)[2]),this._webgpuProcessingContext.availableVaryings[u]=l,this._varyingsWGSL.push("@location(".concat(l,") ").concat(u," : ").concat(o,",")),this._varyingsDeclWGSL.push("var<private> ".concat(u," : ").concat(o,";")),this._varyingNamesWGSL.push(u)),t=""}return t},e.prototype.attributeProcessor=function(t,i){var n=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm,a=n.exec(t);if(a!==null){var s=a[2],o=a[1],u=this._webgpuProcessingContext.getAttributeNextLocation(s,this._getArraySize(o,s,i)[2]);this._webgpuProcessingContext.availableAttributes[o]=u,this._webgpuProcessingContext.orderedAttributes[u]=o,this._attributesWGSL.push("@location(".concat(u,") ").concat(o," : ").concat(s,",")),this._attributesDeclWGSL.push("var<private> ".concat(o," : ").concat(s,";")),this._attributeNamesWGSL.push(o),t=""}return t},e.prototype.uniformProcessor=function(t,i,n){var a=this.uniformRegexp.exec(t);if(a!==null){var s=a[2],o=a[1];this._addUniformToLeftOverUBO(o,s,n),t=""}return t},e.prototype.textureProcessor=function(t,i,n){var a=this.textureRegexp.exec(t);if(a!==null){var s=a[1],o=a[2],u=!!a[3],l=a[4],h=l.indexOf("storage")>0,c=a[6],_=h?c.substring(0,c.indexOf(",")).trim():null,d=u?this._getArraySize(s,o,n)[2]:0,g=this._webgpuProcessingContext.availableTextures[s];if(g)d=g.textures.length;else{g={isTextureArray:d>0,isStorageTexture:h,textures:[],sampleType:oe.Float},d=d||1;for(var v=0;v<d;++v)g.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}this._webgpuProcessingContext.availableTextures[s]=g;var p=l.indexOf("depth")>0,m=si[l],E=p?oe.Depth:c==="u32"?oe.Uint:c==="i32"?oe.Sint:oe.Float;if(g.sampleType=E,m===void 0)throw`Can't get the texture dimension corresponding to the texture function "`.concat(l,'"!');for(var v=0;v<d;++v){var T=g.textures[v],R=T.groupIndex,y=T.bindingIndex;v===0&&(t="@group(".concat(R,") @binding(").concat(y,") ").concat(t)),this._addTextureBindingDescription(s,g,v,m,_,!i)}}return t},e.prototype.postProcessor=function(t){return t},e.prototype.finalizeShaders=function(t,i){var n=i.indexOf("gl_FragCoord")>=0?`
            if (internals.yFactor_ == 1.) {
                gl_FragCoord.y = internals.textureOutputHeight_ - gl_FragCoord.y;
            }
        `:"";t=this._processSamplers(t,!0),i=this._processSamplers(i,!1),t=this._processCustomBuffers(t,!0),i=this._processCustomBuffers(i,!1);var a=this._buildLeftOverUBO();t=a+t,i=a+i,t=t.replace(/#define /g,"//#define "),t=this._processStridedUniformArrays(t);var s=this._varyingsDeclWGSL.join(`
`)+`
`,o="var<private> ".concat(Wt,` : u32;
var<private> `).concat(Vt,` : u32;
var<private> `).concat(Xt,` : vec4<f32>;
`),u=this._attributesDeclWGSL.join(`
`)+`
`,l=`struct VertexInputs {
  @builtin(vertex_index) vertexIndex : u32,
  @builtin(instance_index) instanceIndex : u32,
`;this._attributesWGSL.length>0&&(l+=this._attributesWGSL.join(`
`)),l+=`
};
`;var h=`struct FragmentInputs {
  @builtin(position) position : vec4<f32>,
`;this._varyingsWGSL.length>0&&(h+=this._varyingsWGSL.join(`
`)),h+=`
};
`,t=o+l+u+h+s+t;for(var c=`  var output : FragmentInputs;
  `.concat(Wt,` = input.vertexIndex;
  `).concat(Vt,` = input.instanceIndex;
`),_=0;_<this._attributeNamesWGSL.length;++_){var d=this._attributeNamesWGSL[_];c+="  ".concat(d," = input.").concat(d,`;
`)}for(var g="  output.position = ".concat(Xt,`;
  output.position.y = output.position.y * internals.yFactor_;
`),_=0;_<this._varyingNamesWGSL.length;++_){var v=this._varyingNamesWGSL[_];g+="  output.".concat(v," = ").concat(v,`;
`)}g+="  return output;",t=this._injectStartingAndEndingCode(t,"fn main",c,g),i=i.replace(/#define /g,"//#define "),i=this._processStridedUniformArrays(i),i=i.replace(/dpdy/g,"(-internals.yFactor_)*dpdy");var p="var<private> ".concat(Ht,` : vec4<f32>;
var<private> `).concat(kt,` : bool;
var<private> `).concat(Yt,` : vec4<f32>;
var<private> `).concat(Ke,` : f32;
`),m=`struct FragmentInputs {
  @builtin(position) position : vec4<f32>,
  @builtin(front_facing) frontFacing : bool,
`;this._varyingsWGSL.length>0&&(m+=this._varyingsWGSL.join(`
`)),m+=`
};
`;for(var E=`struct FragmentOutputs {
  @location(0) color : vec4<f32>,
`,T=!1,R=0;!T&&(R=i.indexOf(Ke,R),!(R<0));){var y=R;for(T=!0;R>1&&i.charAt(R)!==`
`;){if(i.charAt(R)==="/"&&i.charAt(R-1)==="/"){T=!1;break}R--}R=y+Ke.length}T&&(E+=`  @builtin(frag_depth) fragDepth: f32,
`),E+=`};
`,i=p+m+s+E+i;for(var C=`  var output : FragmentOutputs;
  `.concat(Ht,` = input.position;
  `).concat(kt,` = input.frontFacing;
`)+n,_=0;_<this._varyingNamesWGSL.length;++_){var b=this._varyingNamesWGSL[_];C+="  ".concat(b," = input.").concat(b,`;
`)}var x="  output.color = ".concat(Yt,`;
`);return T&&(x+="  output.fragDepth = ".concat(Ke,`;
`)),x+="  return output;",i=this._injectStartingAndEndingCode(i,"fn main",C,x),this._collectBindingNames(),this._preCreateBindGroupEntries(),{vertexCode:t,fragmentCode:i}},e.prototype._generateLeftOverUBOCode=function(t,i){for(var n="",a="struct ".concat(t,` {
`),s=0,o=this._webgpuProcessingContext.leftOverUniforms;s<o.length;s++){var u=o[s],l=u.type.replace(/^(.*?)(<.*>)?$/,"$1"),h=te.UniformSizes[l];if(u.length>0)if(h<=2){var c="".concat(t,"_").concat(this._stridedUniformArrays.length,"_strided_arr");n+="struct ".concat(c,` {
                        @size(16)
                        el: `).concat(l,`,
                    }`),this._stridedUniformArrays.push(u.name),a+=" @align(16) ".concat(u.name," : array<").concat(c,", ").concat(u.length,`>,
`)}else a+=" ".concat(u.name," : array<").concat(u.type,", ").concat(u.length,`>,
`);else a+="  ".concat(u.name," : ").concat(u.type,`,
`)}return a+=`};
`,a="".concat(n,`
`).concat(a),a+="@group(".concat(i.binding.groupIndex,") @binding(").concat(i.binding.bindingIndex,") var<uniform> ").concat(ni," : ").concat(t,`;
`),a},e.prototype._processSamplers=function(t,i){for(var n=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;;){var a=n.exec(t);if(a===null)break;var s=a[1],o=a[2],u=s.indexOf(te.AutoSamplerSuffix)===s.length-te.AutoSamplerSuffix.length?s.substring(0,s.indexOf(te.AutoSamplerSuffix)):null,l=o==="sampler_comparison"?xe.Comparison:xe.Filtering;if(u){var h=this._webgpuProcessingContext.availableTextures[u];h&&(h.autoBindSampler=!0)}var c=this._webgpuProcessingContext.availableSamplers[s];c||(c={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:l},this._webgpuProcessingContext.availableSamplers[s]=c),this._addSamplerBindingDescription(s,c,i);var _=t.substring(0,a.index),d="@group(".concat(c.binding.groupIndex,") @binding(").concat(c.binding.bindingIndex,") "),g=t.substring(a.index);t=_+d+g,n.lastIndex+=d.length}return t},e.prototype._processCustomBuffers=function(t,i){for(var n=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;;){var a=n.exec(t);if(a===null)break;var s=a[1],o=a[3],u=a[4],l=a[5],h=this._webgpuProcessingContext.availableBuffers[u];if(!h){var c=s==="uniform"?Xe.KnownUBOs[l]:null,_=void 0;c?(u=l,_=c.binding,_.groupIndex===-1&&(_=this._webgpuProcessingContext.getNextFreeUBOBinding())):_=this._webgpuProcessingContext.getNextFreeUBOBinding(),h={binding:_},this._webgpuProcessingContext.availableBuffers[u]=h}this._addBufferBindingDescription(u,this._webgpuProcessingContext.availableBuffers[u],o==="read_write"?Ce.Storage:s==="storage"?Ce.ReadOnlyStorage:Ce.Uniform,i);var d=h.binding.groupIndex,g=h.binding.bindingIndex,v=t.substring(0,a.index),p="@group(".concat(d,") @binding(").concat(g,") "),m=t.substring(a.index);t=v+p+m,n.lastIndex+=p.length}return t},e.prototype._processStridedUniformArrays=function(t){for(var i=0,n=this._stridedUniformArrays;i<n.length;i++){var a=n[i];t=t.replace(new RegExp("".concat(a,"\\s*\\[(.*)\\]"),"g"),"".concat(a,"[$1].el"))}return t},e}(te),tt=function(){function r(e){e===void 0&&(e=null),this.format=f.RGBA8Unorm,this.textureUsages=0,this.textureAdditionalUsages=0,this._webgpuTexture=e,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}return Object.defineProperty(r.prototype,"underlyingResource",{get:function(){return this._webgpuTexture},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"msaaTexture",{get:function(){return this._webgpuMSAATexture},set:function(e){this._webgpuMSAATexture=e},enumerable:!1,configurable:!0}),r.prototype.set=function(e){this._webgpuTexture=e},r.prototype.setUsage=function(e,t,i,n,a){t=e===L.RenderTarget?!1:t,this.createView({format:this.format,dimension:i?W.Cube:W.E2d,mipLevelCount:t?$t.ILog2(Math.max(n,a))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:i?6:1,aspect:Te.All})},r.prototype.createView=function(e,t){if(t===void 0&&(t=!1),this.view=this._webgpuTexture.createView(e),t&&e){var i=e.mipLevelCount;e.mipLevelCount=1,this.viewForWriting=this._webgpuTexture.createView(e),e.mipLevelCount=i}},r.prototype.reset=function(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null},r.prototype.release=function(){var e,t,i;(e=this._webgpuTexture)===null||e===void 0||e.destroy(),(t=this._webgpuMSAATexture)===null||t===void 0||t.destroy(),(i=this._copyInvertYTempTexture)===null||i===void 0||i.destroy(),this.reset()},r}(),ui=`
    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));
    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));

    layout(location = 0) out vec2 vTex;

    void main() {
        vTex = tex[gl_VertexIndex];
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,li=`
    layout(set = 0, binding = 0) uniform sampler imgSampler;
    layout(set = 0, binding = 1) uniform texture2D img;

    layout(location = 0) in vec2 vTex;
    layout(location = 0) out vec4 outColor;

    void main() {
        outColor = texture(sampler2D(img, imgSampler), vTex);
    }
    `,lr=`
    #extension GL_EXT_samplerless_texture_functions : enable

    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));
    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));

    layout(set = 0, binding = 0) uniform texture2D img;

    #ifdef INVERTY
        layout(location = 0) out flat ivec2 vTextureSize;
    #endif

    void main() {
        #ifdef INVERTY
            vTextureSize = textureSize(img, 0);
        #endif
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,hi=`
    #extension GL_EXT_samplerless_texture_functions : enable

    layout(set = 0, binding = 0) uniform texture2D img;

    #ifdef INVERTY
        layout(location = 0) in flat ivec2 vTextureSize;
    #endif
    layout(location = 0) out vec4 outColor;

    void main() {
    #ifdef INVERTY
        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, vTextureSize.y - gl_FragCoord.y), 0);
    #else
        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color.rgb *= color.a;
    #endif
        outColor = color;
    }
    `,ci=lr,fi=`
    #extension GL_EXT_samplerless_texture_functions : enable

    layout(set = 0, binding = 0) uniform texture2D img;
    layout(set = 0, binding = 1) uniform Params {
        float ofstX;
        float ofstY;
        float width;
        float height;
    };

    #ifdef INVERTY
        layout(location = 0) in flat ivec2 vTextureSize;
    #endif
    layout(location = 0) out vec4 outColor;

    void main() {
        if (gl_FragCoord.x < ofstX || gl_FragCoord.x >= ofstX + width) {
            discard;
        }
        if (gl_FragCoord.y < ofstY || gl_FragCoord.y >= ofstY + height) {
            discard;
        }
    #ifdef INVERTY
        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, ofstY + height - (gl_FragCoord.y - ofstY)), 0);
    #else
        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color.rgb *= color.a;
    #endif
        outColor = color;
    }
    `,_i=`
    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));

    void main() {
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,di=`
    layout(set = 0, binding = 0) uniform Uniforms {
        uniform vec4 color;
    };

    layout(location = 0) out vec4 outColor;

    void main() {
        outColor = color;
    }
    `,fe;(function(r){r[r.MipMap=0]="MipMap",r[r.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",r[r.Clear=2]="Clear",r[r.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst"})(fe||(fe={}));var Qt=[{vertex:ui,fragment:li},{vertex:lr,fragment:hi},{vertex:_i,fragment:di},{vertex:ci,fragment:fi}],We={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2unorm:22,rg32uint:23,rg32sint:24,rg32float:25,rgba16uint:26,rgba16sint:27,rgba16float:28,rgba32uint:29,rgba32sint:30,rgba32float:31,stencil8:32,depth16unorm:33,depth24plus:34,"depth24plus-stencil8":35,depth32float:36,"depth24unorm-stencil8":37,"depth32float-stencil8":38},Ae=function(){function r(e,t,i,n){this._pipelines={},this._compiledShaders=[],this._deferredReleaseTextures=[],this._device=e,this._glslang=t,this._tintWASM=i,this._bufferManager=n,this._mipmapSampler=e.createSampler({minFilter:D.Linear}),this._ubCopyWithOfst=this._bufferManager.createBuffer(4*4,V.Uniform|V.CopyDst).underlyingResource,this._getPipeline(f.RGBA8Unorm)}return r.ComputeNumMipmapLevels=function(e,t){return $t.ILog2(Math.max(e,t))+1},r.prototype._getPipeline=function(e,t,i){t===void 0&&(t=fe.MipMap);var n=t===fe.MipMap?1<<0:t===fe.InvertYPremultiplyAlpha?((i.invertY?1:0)<<1)+((i.premultiplyAlpha?1:0)<<2):t===fe.Clear?1<<3:t===fe.InvertYPremultiplyAlphaWithOfst?((i.invertY?1:0)<<4)+((i.premultiplyAlpha?1:0)<<5):0;this._pipelines[e]||(this._pipelines[e]=[]);var a=this._pipelines[e][n];if(!a){var s=`#version 450\r
`;(t===fe.InvertYPremultiplyAlpha||t===fe.InvertYPremultiplyAlphaWithOfst)&&(i.invertY&&(s+=`#define INVERTY\r
`),i.premultiplyAlpha&&(s+=`#define PREMULTIPLYALPHA\r
`));var o=this._compiledShaders[n];if(!o){var u=this._glslang.compileGLSL(s+Qt[t].vertex,"vertex"),l=this._glslang.compileGLSL(s+Qt[t].fragment,"fragment");this._tintWASM&&(u=this._tintWASM.convertSpirV2WGSL(u),l=this._tintWASM.convertSpirV2WGSL(l));var h=this._device.createShaderModule({code:u}),c=this._device.createShaderModule({code:l});o=this._compiledShaders[n]=[h,c]}var _=this._device.createRenderPipeline({layout:rt.Auto,vertex:{module:o[0],entryPoint:"main"},fragment:{module:o[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:le.TriangleStrip,stripIndexFormat:Ie.Uint16}});a=this._pipelines[e][n]=[_,_.getBindGroupLayout(0)]}return a},r._GetTextureTypeFromFormat=function(e){switch(e){case f.R8Unorm:case f.R8Snorm:case f.R8Uint:case f.R8Sint:case f.RG8Unorm:case f.RG8Snorm:case f.RG8Uint:case f.RG8Sint:case f.RGBA8Unorm:case f.RGBA8UnormSRGB:case f.RGBA8Snorm:case f.RGBA8Uint:case f.RGBA8Sint:case f.BGRA8Unorm:case f.BGRA8UnormSRGB:case f.RGB10A2Unorm:case f.RGB9E5UFloat:case f.RG11B10UFloat:case f.Depth24UnormStencil8:case f.Depth32FloatStencil8:case f.BC7RGBAUnorm:case f.BC7RGBAUnormSRGB:case f.BC6HRGBUFloat:case f.BC6HRGBFloat:case f.BC5RGUnorm:case f.BC5RGSnorm:case f.BC3RGBAUnorm:case f.BC3RGBAUnormSRGB:case f.BC2RGBAUnorm:case f.BC2RGBAUnormSRGB:case f.BC4RUnorm:case f.BC4RSnorm:case f.BC1RGBAUnorm:case f.BC1RGBAUnormSRGB:case f.ETC2RGB8Unorm:case f.ETC2RGB8UnormSRGB:case f.ETC2RGB8A1Unorm:case f.ETC2RGB8A1UnormSRGB:case f.ETC2RGBA8Unorm:case f.ETC2RGBA8UnormSRGB:case f.EACR11Unorm:case f.EACR11Snorm:case f.EACRG11Unorm:case f.EACRG11Snorm:case f.ASTC4x4Unorm:case f.ASTC4x4UnormSRGB:case f.ASTC5x4Unorm:case f.ASTC5x4UnormSRGB:case f.ASTC5x5Unorm:case f.ASTC5x5UnormSRGB:case f.ASTC6x5Unorm:case f.ASTC6x5UnormSRGB:case f.ASTC6x6Unorm:case f.ASTC6x6UnormSRGB:case f.ASTC8x5Unorm:case f.ASTC8x5UnormSRGB:case f.ASTC8x6Unorm:case f.ASTC8x6UnormSRGB:case f.ASTC8x8Unorm:case f.ASTC8x8UnormSRGB:case f.ASTC10x5Unorm:case f.ASTC10x5UnormSRGB:case f.ASTC10x6Unorm:case f.ASTC10x6UnormSRGB:case f.ASTC10x8Unorm:case f.ASTC10x8UnormSRGB:case f.ASTC10x10Unorm:case f.ASTC10x10UnormSRGB:case f.ASTC12x10Unorm:case f.ASTC12x10UnormSRGB:case f.ASTC12x12Unorm:case f.ASTC12x12UnormSRGB:return 0;case f.R16Uint:case f.R16Sint:case f.RG16Uint:case f.RG16Sint:case f.RGBA16Uint:case f.RGBA16Sint:case f.Depth16Unorm:return 5;case f.R16Float:case f.RG16Float:case f.RGBA16Float:return 2;case f.R32Uint:case f.R32Sint:case f.RG32Uint:case f.RG32Sint:case f.RGBA32Uint:case f.RGBA32Sint:return 7;case f.R32Float:case f.RG32Float:case f.RGBA32Float:case f.Depth32Float:return 1;case f.Stencil8:throw"No fixed size for Stencil8 format!";case f.Depth24Plus:throw"No fixed size for Depth24Plus format!";case f.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!"}return 0},r._GetBlockInformationFromFormat=function(e){switch(e){case f.R8Unorm:case f.R8Snorm:case f.R8Uint:case f.R8Sint:return{width:1,height:1,length:1};case f.R16Uint:case f.R16Sint:case f.R16Float:case f.RG8Unorm:case f.RG8Snorm:case f.RG8Uint:case f.RG8Sint:return{width:1,height:1,length:2};case f.R32Uint:case f.R32Sint:case f.R32Float:case f.RG16Uint:case f.RG16Sint:case f.RG16Float:case f.RGBA8Unorm:case f.RGBA8UnormSRGB:case f.RGBA8Snorm:case f.RGBA8Uint:case f.RGBA8Sint:case f.BGRA8Unorm:case f.BGRA8UnormSRGB:case f.RGB9E5UFloat:case f.RGB10A2Unorm:case f.RG11B10UFloat:return{width:1,height:1,length:4};case f.RG32Uint:case f.RG32Sint:case f.RG32Float:case f.RGBA16Uint:case f.RGBA16Sint:case f.RGBA16Float:return{width:1,height:1,length:8};case f.RGBA32Uint:case f.RGBA32Sint:case f.RGBA32Float:return{width:1,height:1,length:16};case f.Stencil8:throw"No fixed size for Stencil8 format!";case f.Depth16Unorm:return{width:1,height:1,length:2};case f.Depth24Plus:throw"No fixed size for Depth24Plus format!";case f.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!";case f.Depth32Float:return{width:1,height:1,length:4};case f.Depth24UnormStencil8:return{width:1,height:1,length:4};case f.Depth32FloatStencil8:return{width:1,height:1,length:5};case f.BC7RGBAUnorm:case f.BC7RGBAUnormSRGB:case f.BC6HRGBUFloat:case f.BC6HRGBFloat:case f.BC5RGUnorm:case f.BC5RGSnorm:case f.BC3RGBAUnorm:case f.BC3RGBAUnormSRGB:case f.BC2RGBAUnorm:case f.BC2RGBAUnormSRGB:return{width:4,height:4,length:16};case f.BC4RUnorm:case f.BC4RSnorm:case f.BC1RGBAUnorm:case f.BC1RGBAUnormSRGB:return{width:4,height:4,length:8};case f.ETC2RGB8Unorm:case f.ETC2RGB8UnormSRGB:case f.ETC2RGB8A1Unorm:case f.ETC2RGB8A1UnormSRGB:case f.EACR11Unorm:case f.EACR11Snorm:return{width:4,height:4,length:8};case f.ETC2RGBA8Unorm:case f.ETC2RGBA8UnormSRGB:case f.EACRG11Unorm:case f.EACRG11Snorm:return{width:4,height:4,length:16};case f.ASTC4x4Unorm:case f.ASTC4x4UnormSRGB:return{width:4,height:4,length:16};case f.ASTC5x4Unorm:case f.ASTC5x4UnormSRGB:return{width:5,height:4,length:16};case f.ASTC5x5Unorm:case f.ASTC5x5UnormSRGB:return{width:5,height:5,length:16};case f.ASTC6x5Unorm:case f.ASTC6x5UnormSRGB:return{width:6,height:5,length:16};case f.ASTC6x6Unorm:case f.ASTC6x6UnormSRGB:return{width:6,height:6,length:16};case f.ASTC8x5Unorm:case f.ASTC8x5UnormSRGB:return{width:8,height:5,length:16};case f.ASTC8x6Unorm:case f.ASTC8x6UnormSRGB:return{width:8,height:6,length:16};case f.ASTC8x8Unorm:case f.ASTC8x8UnormSRGB:return{width:8,height:8,length:16};case f.ASTC10x5Unorm:case f.ASTC10x5UnormSRGB:return{width:10,height:5,length:16};case f.ASTC10x6Unorm:case f.ASTC10x6UnormSRGB:return{width:10,height:6,length:16};case f.ASTC10x8Unorm:case f.ASTC10x8UnormSRGB:return{width:10,height:8,length:16};case f.ASTC10x10Unorm:case f.ASTC10x10UnormSRGB:return{width:10,height:10,length:16};case f.ASTC12x10Unorm:case f.ASTC12x10UnormSRGB:return{width:12,height:10,length:16};case f.ASTC12x12Unorm:case f.ASTC12x12UnormSRGB:return{width:12,height:12,length:16}}return{width:1,height:1,length:4}},r._IsHardwareTexture=function(e){return!!e.release},r._IsInternalTexture=function(e){return!!e.dispose},r.IsImageBitmap=function(e){return e.close!==void 0},r.IsImageBitmapArray=function(e){return Array.isArray(e)&&e[0].close!==void 0},r.prototype.setCommandEncoder=function(e){this._commandEncoderForCreation=e},r.IsCompressedFormat=function(e){switch(e){case f.BC7RGBAUnormSRGB:case f.BC7RGBAUnorm:case f.BC6HRGBFloat:case f.BC6HRGBUFloat:case f.BC5RGSnorm:case f.BC5RGUnorm:case f.BC4RSnorm:case f.BC4RUnorm:case f.BC3RGBAUnormSRGB:case f.BC3RGBAUnorm:case f.BC2RGBAUnormSRGB:case f.BC2RGBAUnorm:case f.BC1RGBAUnormSRGB:case f.BC1RGBAUnorm:case f.ETC2RGB8Unorm:case f.ETC2RGB8UnormSRGB:case f.ETC2RGB8A1Unorm:case f.ETC2RGB8A1UnormSRGB:case f.ETC2RGBA8Unorm:case f.ETC2RGBA8UnormSRGB:case f.EACR11Unorm:case f.EACR11Snorm:case f.EACRG11Unorm:case f.EACRG11Snorm:case f.ASTC4x4Unorm:case f.ASTC4x4UnormSRGB:case f.ASTC5x4Unorm:case f.ASTC5x4UnormSRGB:case f.ASTC5x5Unorm:case f.ASTC5x5UnormSRGB:case f.ASTC6x5Unorm:case f.ASTC6x5UnormSRGB:case f.ASTC6x6Unorm:case f.ASTC6x6UnormSRGB:case f.ASTC8x5Unorm:case f.ASTC8x5UnormSRGB:case f.ASTC8x6Unorm:case f.ASTC8x6UnormSRGB:case f.ASTC8x8Unorm:case f.ASTC8x8UnormSRGB:case f.ASTC10x5Unorm:case f.ASTC10x5UnormSRGB:case f.ASTC10x6Unorm:case f.ASTC10x6UnormSRGB:case f.ASTC10x8Unorm:case f.ASTC10x8UnormSRGB:case f.ASTC10x10Unorm:case f.ASTC10x10UnormSRGB:case f.ASTC12x10Unorm:case f.ASTC12x10UnormSRGB:case f.ASTC12x12Unorm:case f.ASTC12x12UnormSRGB:return!0}return!1},r.GetWebGPUTextureFormat=function(e,t,i){switch(i===void 0&&(i=!1),t){case 15:return f.Depth16Unorm;case 16:return f.Depth24Plus;case 13:return f.Depth24PlusStencil8;case 14:return f.Depth32Float;case 17:return f.Depth24UnormStencil8;case 18:return f.Depth32FloatStencil8;case 36492:return i?f.BC7RGBAUnormSRGB:f.BC7RGBAUnorm;case 36495:return f.BC6HRGBUFloat;case 36494:return f.BC6HRGBFloat;case 33779:return i?f.BC3RGBAUnormSRGB:f.BC3RGBAUnorm;case 33778:return i?f.BC2RGBAUnormSRGB:f.BC2RGBAUnorm;case 33777:case 33776:return i?f.BC1RGBAUnormSRGB:f.BC1RGBAUnorm;case 37808:return i?f.ASTC4x4UnormSRGB:f.ASTC4x4Unorm;case 36196:case 37492:return i?f.ETC2RGB8UnormSRGB:f.ETC2RGB8Unorm;case 37496:return i?f.ETC2RGBA8UnormSRGB:f.ETC2RGBA8Unorm}switch(e){case 3:switch(t){case 6:return f.R8Snorm;case 7:return f.RG8Snorm;case 4:throw"RGB format not supported in WebGPU";case 8:return f.R8Sint;case 9:return f.RG8Sint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return f.RGBA8Sint;default:return f.RGBA8Snorm}case 0:switch(t){case 6:return f.R8Unorm;case 7:return f.RG8Unorm;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return i?f.RGBA8UnormSRGB:f.RGBA8Unorm;case 12:return i?f.BGRA8UnormSRGB:f.BGRA8Unorm;case 8:return f.R8Uint;case 9:return f.RG8Uint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return f.RGBA8Uint;case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return f.RGBA8Unorm}case 4:switch(t){case 8:return f.R16Sint;case 9:return f.RG16Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return f.RGBA16Sint;default:return f.RGBA16Sint}case 5:switch(t){case 8:return f.R16Uint;case 9:return f.RG16Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return f.RGBA16Uint;default:return f.RGBA16Uint}case 6:switch(t){case 8:return f.R32Sint;case 9:return f.RG32Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return f.RGBA32Sint;default:return f.RGBA32Sint}case 7:switch(t){case 8:return f.R32Uint;case 9:return f.RG32Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return f.RGBA32Uint;default:return f.RGBA32Uint}case 1:switch(t){case 6:return f.R32Float;case 7:return f.RG32Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return f.RGBA32Float;default:return f.RGBA32Float}case 2:switch(t){case 6:return f.R16Float;case 7:return f.RG16Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return f.RGBA16Float;default:return f.RGBA16Float}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:throw"TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV format not supported in WebGPU";case 14:throw"TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV format not supported in WebGPU";case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(t){case 5:return f.RGB10A2Unorm;case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV";default:return f.RGB10A2Unorm}}return i?f.RGBA8UnormSRGB:f.RGBA8Unorm},r.GetNumChannelsFromWebGPUTextureFormat=function(e){switch(e){case f.R8Unorm:case f.R8Snorm:case f.R8Uint:case f.R8Sint:case f.BC4RUnorm:case f.BC4RSnorm:case f.R16Uint:case f.R16Sint:case f.Depth16Unorm:case f.R16Float:case f.R32Uint:case f.R32Sint:case f.R32Float:case f.Depth32Float:case f.Stencil8:case f.Depth24Plus:case f.EACR11Unorm:case f.EACR11Snorm:return 1;case f.RG8Unorm:case f.RG8Snorm:case f.RG8Uint:case f.RG8Sint:case f.Depth24UnormStencil8:case f.Depth32FloatStencil8:case f.BC5RGUnorm:case f.BC5RGSnorm:case f.RG16Uint:case f.RG16Sint:case f.RG16Float:case f.RG32Uint:case f.RG32Sint:case f.RG32Float:case f.Depth24PlusStencil8:case f.EACRG11Unorm:case f.EACRG11Snorm:return 2;case f.RGB9E5UFloat:case f.RG11B10UFloat:case f.BC6HRGBUFloat:case f.BC6HRGBFloat:case f.ETC2RGB8Unorm:case f.ETC2RGB8UnormSRGB:return 3;case f.RGBA8Unorm:case f.RGBA8UnormSRGB:case f.RGBA8Snorm:case f.RGBA8Uint:case f.RGBA8Sint:case f.BGRA8Unorm:case f.BGRA8UnormSRGB:case f.RGB10A2Unorm:case f.BC7RGBAUnorm:case f.BC7RGBAUnormSRGB:case f.BC3RGBAUnorm:case f.BC3RGBAUnormSRGB:case f.BC2RGBAUnorm:case f.BC2RGBAUnormSRGB:case f.BC1RGBAUnorm:case f.BC1RGBAUnormSRGB:case f.RGBA16Uint:case f.RGBA16Sint:case f.RGBA16Float:case f.RGBA32Uint:case f.RGBA32Sint:case f.RGBA32Float:case f.ETC2RGB8A1Unorm:case f.ETC2RGB8A1UnormSRGB:case f.ETC2RGBA8Unorm:case f.ETC2RGBA8UnormSRGB:case f.ASTC4x4Unorm:case f.ASTC4x4UnormSRGB:case f.ASTC5x4Unorm:case f.ASTC5x4UnormSRGB:case f.ASTC5x5Unorm:case f.ASTC5x5UnormSRGB:case f.ASTC6x5Unorm:case f.ASTC6x5UnormSRGB:case f.ASTC6x6Unorm:case f.ASTC6x6UnormSRGB:case f.ASTC8x5Unorm:case f.ASTC8x5UnormSRGB:case f.ASTC8x6Unorm:case f.ASTC8x6UnormSRGB:case f.ASTC8x8Unorm:case f.ASTC8x8UnormSRGB:case f.ASTC10x5Unorm:case f.ASTC10x5UnormSRGB:case f.ASTC10x6Unorm:case f.ASTC10x6UnormSRGB:case f.ASTC10x8Unorm:case f.ASTC10x8UnormSRGB:case f.ASTC10x10Unorm:case f.ASTC10x10UnormSRGB:case f.ASTC12x10Unorm:case f.ASTC12x10UnormSRGB:case f.ASTC12x12Unorm:case f.ASTC12x12UnormSRGB:return 4}throw"Unknown format ".concat(e,"!")},r.HasStencilAspect=function(e){switch(e){case f.Stencil8:case f.Depth24UnormStencil8:case f.Depth32FloatStencil8:case f.Depth24PlusStencil8:return!0}return!1},r.HasDepthAndStencilAspects=function(e){switch(e){case f.Depth24UnormStencil8:case f.Depth32FloatStencil8:case f.Depth24PlusStencil8:return!0}return!1},r.prototype.invertYPreMultiplyAlpha=function(e,t,i,n,a,s,o,u,l,h,c,_,d,g,v){var p,m,E,T,R,y;a===void 0&&(a=!1),s===void 0&&(s=!1),o===void 0&&(o=0),u===void 0&&(u=0),l===void 0&&(l=1),h===void 0&&(h=0),c===void 0&&(c=0),_===void 0&&(_=0),d===void 0&&(d=0);var C=_!==0,b=g===void 0,x=this._getPipeline(n,C?fe.InvertYPremultiplyAlphaWithOfst:fe.InvertYPremultiplyAlpha,{invertY:a,premultiplyAlpha:s}),S=x[0],w=x[1];o=Math.max(o,0),b&&(g=this._device.createCommandEncoder({})),(m=(p=g).pushDebugGroup)===null||m===void 0||m.call(p,"internal process texture - invertY=".concat(a," premultiplyAlpha=").concat(s));var A;if(r._IsHardwareTexture(e)?(A=e.underlyingResource,a&&!s&&l===1&&o===0||(e=void 0)):(A=e,e=void 0),!!A){C&&this._bufferManager.setRawData(this._ubCopyWithOfst,0,new Float32Array([h,c,_,d]),0,4*4);var U=e,M=(E=U==null?void 0:U._copyInvertYTempTexture)!==null&&E!==void 0?E:this.createTexture({width:t,height:i,layers:1},!1,!1,!1,!1,!1,n,1,g,X.CopySrc|X.RenderAttachment|X.TextureBinding),q=(T=U==null?void 0:U._copyInvertYRenderPassDescr)!==null&&T!==void 0?T:{colorAttachments:[{view:M.createView({format:n,dimension:W.E2d,baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:z.Load,storeOp:_e.Store}]},G=g.beginRenderPass(q),O=C?U==null?void 0:U._copyInvertYBindGroupWithOfst:U==null?void 0:U._copyInvertYBindGroup;if(!O){var j={layout:w,entries:[{binding:0,resource:A.createView({format:n,dimension:W.E2d,baseMipLevel:u,mipLevelCount:1,arrayLayerCount:l,baseArrayLayer:o})}]};C&&j.entries.push({binding:1,resource:{buffer:this._ubCopyWithOfst}}),O=this._device.createBindGroup(j)}G.setPipeline(S),G.setBindGroup(0,O),G.draw(4,1,0,0),G.end(),g.copyTextureToTexture({texture:M},{texture:A,mipLevel:u,origin:{x:0,y:0,z:o}},{width:t,height:i,depthOrArrayLayers:1}),U?(U._copyInvertYTempTexture=M,U._copyInvertYRenderPassDescr=q,C?U._copyInvertYBindGroupWithOfst=O:U._copyInvertYBindGroup=O):this._deferredReleaseTextures.push([M,null]),(y=(R=g).popDebugGroup)===null||y===void 0||y.call(R),b&&(this._device.queue.submit([g.finish()]),g=null)}},r.prototype.copyWithInvertY=function(e,t,i,n){var a,s,o,u,l=n===void 0,h=this._getPipeline(t,fe.InvertYPremultiplyAlpha,{invertY:!0,premultiplyAlpha:!1}),c=h[0],_=h[1];l&&(n=this._device.createCommandEncoder({})),(s=(a=n).pushDebugGroup)===null||s===void 0||s.call(a,"internal copy texture with invertY");var d=n.beginRenderPass(i),g=this._device.createBindGroup({layout:_,entries:[{binding:0,resource:e}]});d.setPipeline(c),d.setBindGroup(0,g),d.draw(4,1,0,0),d.end(),(u=(o=n).popDebugGroup)===null||u===void 0||u.call(o),l&&(this._device.queue.submit([n.finish()]),n=null)},r.prototype.createTexture=function(e,t,i,n,a,s,o,u,l,h,c){t===void 0&&(t=!1),i===void 0&&(i=!1),n===void 0&&(n=!1),a===void 0&&(a=!1),s===void 0&&(s=!1),o===void 0&&(o=f.RGBA8Unorm),u===void 0&&(u=1),h===void 0&&(h=-1),c===void 0&&(c=0),u>1&&(u=4);var _=e.layers||1,d={width:e.width,height:e.height,depthOrArrayLayers:_},g=r.IsCompressedFormat(o),v=t?r.ComputeNumMipmapLevels(e.width,e.height):1,p=h>=0?h:X.CopySrc|X.CopyDst|X.TextureBinding;c|=t&&!g?X.CopySrc|X.RenderAttachment:0,!g&&!s&&(c|=X.RenderAttachment|X.CopyDst);var m=this._device.createTexture({size:d,dimension:s?Se.E3d:Se.E2d,format:o,usage:p|c,sampleCount:u,mipLevelCount:v});return r.IsImageBitmap(e)&&(this.updateTexture(e,m,e.width,e.height,_,o,0,0,n,a,0,0),t&&i&&this.generateMipmaps(m,o,v,0,l)),m},r.prototype.createCubeTexture=function(e,t,i,n,a,s,o,u,l,h){t===void 0&&(t=!1),i===void 0&&(i=!1),n===void 0&&(n=!1),a===void 0&&(a=!1),s===void 0&&(s=f.RGBA8Unorm),o===void 0&&(o=1),l===void 0&&(l=-1),h===void 0&&(h=0),o>1&&(o=4);var c=r.IsImageBitmapArray(e)?e[0].width:e.width,_=r.IsImageBitmapArray(e)?e[0].height:e.height,d=r.IsCompressedFormat(s),g=t?r.ComputeNumMipmapLevels(c,_):1,v=l>=0?l:X.CopySrc|X.CopyDst|X.TextureBinding;h|=t&&!d?X.CopySrc|X.RenderAttachment:0,d||(h|=X.RenderAttachment|X.CopyDst);var p=this._device.createTexture({size:{width:c,height:_,depthOrArrayLayers:6},dimension:Se.E2d,format:s,usage:v|h,sampleCount:o,mipLevelCount:g});return r.IsImageBitmapArray(e)&&(this.updateCubeTextures(e,p,c,_,s,n,a,0,0),t&&i&&this.generateCubeMipmaps(p,s,g,u)),p},r.prototype.generateCubeMipmaps=function(e,t,i,n){var a,s,o,u,l=n===void 0;l&&(n=this._device.createCommandEncoder({})),(s=(a=n).pushDebugGroup)===null||s===void 0||s.call(a,"create cube mipmaps - ".concat(i," levels"));for(var h=0;h<6;++h)this.generateMipmaps(e,t,i,h,n);(u=(o=n).popDebugGroup)===null||u===void 0||u.call(o),l&&(this._device.queue.submit([n.finish()]),n=null)},r.prototype.generateMipmaps=function(e,t,i,n,a){var s,o,u,l,h,c,_,d;n===void 0&&(n=0);var g=a===void 0,v=this._getPipeline(t),p=v[0],m=v[1];n=Math.max(n,0),g&&(a=this._device.createCommandEncoder({})),(o=(s=a).pushDebugGroup)===null||o===void 0||o.call(s,"create mipmaps for face #".concat(n," - ").concat(i," levels"));var E;if(r._IsHardwareTexture(e)?(E=e.underlyingResource,e._mipmapGenRenderPassDescr=e._mipmapGenRenderPassDescr||[],e._mipmapGenBindGroup=e._mipmapGenBindGroup||[]):(E=e,e=void 0),!!E){for(var T=e,R=1;R<i;++R){var y=(l=(u=T==null?void 0:T._mipmapGenRenderPassDescr[n])===null||u===void 0?void 0:u[R-1])!==null&&l!==void 0?l:{colorAttachments:[{view:E.createView({format:t,dimension:W.E2d,baseMipLevel:R,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:n}),loadOp:z.Load,storeOp:_e.Store}]};T&&(T._mipmapGenRenderPassDescr[n]=T._mipmapGenRenderPassDescr[n]||[],T._mipmapGenRenderPassDescr[n][R-1]=y);var C=a.beginRenderPass(y),b=(c=(h=T==null?void 0:T._mipmapGenBindGroup[n])===null||h===void 0?void 0:h[R-1])!==null&&c!==void 0?c:this._device.createBindGroup({layout:m,entries:[{binding:0,resource:this._mipmapSampler},{binding:1,resource:E.createView({format:t,dimension:W.E2d,baseMipLevel:R-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:n})}]});T&&(T._mipmapGenBindGroup[n]=T._mipmapGenBindGroup[n]||[],T._mipmapGenBindGroup[n][R-1]=b),C.setPipeline(p),C.setBindGroup(0,b),C.draw(4,1,0,0),C.end()}(d=(_=a).popDebugGroup)===null||d===void 0||d.call(_),g&&(this._device.queue.submit([a.finish()]),a=null)}},r.prototype.createGPUTextureForInternalTexture=function(e,t,i,n,a){e._hardwareTexture||(e._hardwareTexture=new tt),t===void 0&&(t=e.width),i===void 0&&(i=e.height),n===void 0&&(n=e.depth);var s=e._hardwareTexture,o=((a!=null?a:0)&1)!==0;s.format=r.GetWebGPUTextureFormat(e.type,e.format,e._useSRGBBuffer),s.textureUsages=e._source===L.RenderTarget||e.source===L.MultiRenderTarget?X.TextureBinding|X.CopySrc|X.RenderAttachment:e._source===L.DepthStencil?X.TextureBinding|X.RenderAttachment:-1,s.textureAdditionalUsages=o?X.StorageBinding:0;var u=e.generateMipMaps,l=n||1,h;if(e._maxLodLevel!==null?h=e._maxLodLevel:h=u?r.ComputeNumMipmapLevels(t,i):1,e.isCube){var c=this.createCubeTexture({width:t,height:i},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,s.format,1,this._commandEncoderForCreation,s.textureUsages,s.textureAdditionalUsages);s.set(c),s.createView({format:s.format,dimension:W.Cube,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6,aspect:r.HasDepthAndStencilAspects(s.format)?Te.DepthOnly:Te.All},o)}else{var c=this.createTexture({width:t,height:i,layers:l},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,e.is3D,s.format,1,this._commandEncoderForCreation,s.textureUsages,s.textureAdditionalUsages);s.set(c),s.createView({format:s.format,dimension:e.is2DArray?W.E2dArray:e.is3D?Se.E3d:W.E2d,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:e.is3D?1:l,aspect:r.HasDepthAndStencilAspects(s.format)?Te.DepthOnly:Te.All},o)}return e.width=e.baseWidth=t,e.height=e.baseHeight=i,e.depth=e.baseDepth=n,this.createMSAATexture(e,e.samples),s},r.prototype.createMSAATexture=function(e,t){var i=e._hardwareTexture;if(i!=null&&i.msaaTexture&&(this.releaseTexture(i.msaaTexture),i.msaaTexture=null),!(!i||(t!=null?t:1)<=1)){var n=e.width,a=e.height,s=e.depth||1;if(e.isCube){var o=this.createCubeTexture({width:n,height:a},!1,!1,e.invertY,!1,i.format,t,this._commandEncoderForCreation,i.textureUsages,i.textureAdditionalUsages);i.msaaTexture=o}else{var o=this.createTexture({width:n,height:a,layers:s},!1,!1,e.invertY,!1,e.is3D,i.format,t,this._commandEncoderForCreation,i.textureUsages,i.textureAdditionalUsages);i.msaaTexture=o}}},r.prototype.updateCubeTextures=function(e,t,i,n,a,s,o,u,l){s===void 0&&(s=!1),o===void 0&&(o=!1),u===void 0&&(u=0),l===void 0&&(l=0);for(var h=[0,3,1,4,2,5],c=0;c<h.length;++c){var _=e[h[c]];this.updateTexture(_,t,i,n,1,a,c,0,s,o,u,l)}},r.prototype.updateTexture=function(e,t,i,n,a,s,o,u,l,h,c,_,d){o===void 0&&(o=0),u===void 0&&(u=0),l===void 0&&(l=!1),h===void 0&&(h=!1),c===void 0&&(c=0),_===void 0&&(_=0);var g=r._IsInternalTexture(t)?t._hardwareTexture.underlyingResource:t,v=r._GetBlockInformationFromFormat(s),p=r._IsInternalTexture(t)?t._hardwareTexture:t,m={texture:g,origin:{x:c,y:_,z:Math.max(o,0)},mipLevel:u,premultipliedAlpha:h},E={width:Math.ceil(i/v.width)*v.width,height:Math.ceil(n/v.height)*v.height,depthOrArrayLayers:a||1};if(e.byteLength!==void 0){e=e;var T=Math.ceil(i/v.width)*v.length,R=Math.ceil(T/256)*256===T;if(R){var y=this._device.createCommandEncoder({}),C=this._bufferManager.createRawBuffer(e.byteLength,V.MapWrite|V.CopySrc,!0),b=C.getMappedRange();new Uint8Array(b).set(e),C.unmap(),y.copyBufferToTexture({buffer:C,offset:0,bytesPerRow:T,rowsPerImage:n},m,E),this._device.queue.submit([y.finish()]),this._bufferManager.releaseBuffer(C)}else this._device.queue.writeTexture(m,e,{offset:0,bytesPerRow:T,rowsPerImage:n},E);if(l||h)if(r._IsInternalTexture(t)){var x=c===0&&_===0&&i===t.width&&n===t.height;this.invertYPreMultiplyAlpha(p,t.width,t.height,s,l,h,o,u,a||1,c,_,x?0:i,x?0:n,void 0,d)}else throw"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!"}else if(e=e,l)if(m.premultipliedAlpha=!1,r._IsInternalTexture(t)&&c===0&&_===0&&i===t.width&&n===t.height)this._device.queue.copyExternalImageToTexture({source:e},m,E),this.invertYPreMultiplyAlpha(p,i,n,s,l,h,o,u,a||1,0,0,0,0,void 0,d);else{var y=this._device.createCommandEncoder({}),S=this.createTexture({width:i,height:n,layers:1},!1,!1,!1,!1,!1,s,1,y,X.CopySrc|X.TextureBinding);this._deferredReleaseTextures.push([S,null]),E.depthOrArrayLayers=1,this._device.queue.copyExternalImageToTexture({source:e},{texture:S},E),E.depthOrArrayLayers=a||1,this.invertYPreMultiplyAlpha(S,i,n,s,l,h,o,u,a||1,0,0,0,0,y,d),y.copyTextureToTexture({texture:S},m,E),this._device.queue.submit([y.finish()])}else this._device.queue.copyExternalImageToTexture({source:e},m,E)},r.prototype.readPixels=function(e,t,i,n,a,s,o,u,l,h){o===void 0&&(o=0),u===void 0&&(u=0),l===void 0&&(l=null),h===void 0&&(h=!1);var c=r._GetBlockInformationFromFormat(s),_=Math.ceil(n/c.width)*c.length,d=Math.ceil(_/256)*256,g=d*a,v=this._bufferManager.createRawBuffer(g,V.MapRead|V.CopyDst),p=this._device.createCommandEncoder({});return p.copyTextureToBuffer({texture:e,mipLevel:u,origin:{x:t,y:i,z:Math.max(o,0)}},{buffer:v,offset:0,bytesPerRow:d},{width:n,height:a,depthOrArrayLayers:1}),this._device.queue.submit([p.finish()]),this._bufferManager.readDataFromBuffer(v,g,n,a,_,d,r._GetTextureTypeFromFormat(s),0,l,!0,h)},r.prototype.releaseTexture=function(e){if(r._IsInternalTexture(e)){var t=e._hardwareTexture,i=e._irradianceTexture;this._deferredReleaseTextures.push([t,i])}else this._deferredReleaseTextures.push([e,null])},r.prototype.destroyDeferredTextures=function(){for(var e=0;e<this._deferredReleaseTextures.length;++e){var t=this._deferredReleaseTextures[e],i=t[0],n=t[1];i&&(r._IsHardwareTexture(i)?i.release():i.destroy()),n==null||n.dispose()}this._deferredReleaseTextures.length=0},r}(),pi=function(){function r(e){this._deferredReleaseBuffers=[],this._device=e}return r._IsGPUBuffer=function(e){return e.underlyingResource===void 0},r.prototype.createRawBuffer=function(e,t,i){i===void 0&&(i=!1);var n=e.byteLength!==void 0?e.byteLength+3&-4:e+3&-4,a={mappedAtCreation:i,size:n,usage:t};return this._device.createBuffer(a)},r.prototype.createBuffer=function(e,t){var i=e.byteLength!==void 0,n=this.createRawBuffer(e,t),a=new Br(n);return a.references=1,a.capacity=i?e.byteLength:e,i&&this.setSubData(a,0,e),a},r.prototype.setRawData=function(e,t,i,n,a){this._device.queue.writeBuffer(e,t,i.buffer,n,a)},r.prototype.setSubData=function(e,t,i,n,a){n===void 0&&(n=0),a===void 0&&(a=0);var s=e.underlyingResource;a=a||i.byteLength,a=Math.min(a,e.capacity-t);var o=i.byteOffset+n,u=o+a,l=a+3&-4;if(l!==a){var h=new Uint8Array(i.buffer.slice(o,u));i=new Uint8Array(l),i.set(h),n=0,o=0,u=l,a=l}for(var c=1024*1024*15,_=0;u-(o+_)>c;)this._device.queue.writeBuffer(s,t+_,i.buffer,o+_,c),_+=c;this._device.queue.writeBuffer(s,t+_,i.buffer,o+_,a-_)},r.prototype._getHalfFloatAsFloatRGBAArrayBuffer=function(e,t,i){i||(i=new Float32Array(e));for(var n=new Uint16Array(t);e--;)i[e]=Sr(n[e]);return i},r.prototype.readDataFromBuffer=function(e,t,i,n,a,s,o,u,l,h,c){var _=this;o===void 0&&(o=0),u===void 0&&(u=0),l===void 0&&(l=null),h===void 0&&(h=!0),c===void 0&&(c=!1);var d=o===1?2:o===2?1:0;return new Promise(function(g,v){e.mapAsync(Ue.Read,u,t).then(function(){var p=e.getMappedRange(u,t),m=l;if(c)m===null?m=gt(o,t,!0,p):m=gt(o,m.buffer,void 0,p);else if(m===null)switch(d){case 0:m=new Uint8Array(t),m.set(new Uint8Array(p));break;case 1:m=_._getHalfFloatAsFloatRGBAArrayBuffer(t/2,p);break;case 2:m=new Float32Array(t/4),m.set(new Float32Array(p));break}else switch(d){case 0:m=new Uint8Array(m.buffer),m.set(new Uint8Array(p));break;case 1:m=_._getHalfFloatAsFloatRGBAArrayBuffer(t/2,p,l);break;case 2:m=new Float32Array(m.buffer),m.set(new Float32Array(p));break}if(a!==s){d===1&&!c&&(a*=2,s*=2);for(var E=new Uint8Array(m.buffer),T=a,R=0,y=1;y<n;++y){R=y*s;for(var C=0;C<a;++C)E[T++]=E[R++]}d!==0&&!c?m=new Float32Array(E.buffer,0,T/4):m=new Uint8Array(E.buffer,0,T)}e.unmap(),h&&_.releaseBuffer(e),g(m)},function(p){return v(p)})})},r.prototype.releaseBuffer=function(e){return r._IsGPUBuffer(e)?(this._deferredReleaseBuffers.push(e),!0):(e.references--,e.references===0?(this._deferredReleaseBuffers.push(e.underlyingResource),!0):!1)},r.prototype.destroyDeferredBuffers=function(){for(var e=0;e<this._deferredReleaseBuffers.length;++e)this._deferredReleaseBuffers[e].destroy();this._deferredReleaseBuffers.length=0},r}(),jt=function(){function r(){this.colorAttachmentGPUTextures=[],this.reset()}return r.prototype.reset=function(e){e===void 0&&(e=!1),this.renderPass=null,e&&(this.renderPassDescriptor=null,this.colorAttachmentViewDescriptor=null,this.depthAttachmentViewDescriptor=null,this.colorAttachmentGPUTextures=[],this.depthTextureFormat=void 0)},r}(),gi=[0|0<<1|0<<2,0|0<<1|0<<2,1|1<<1|0<<2,1|1<<1|1<<2,0|0<<1|0<<2,0|1<<1|0<<2,0|1<<1|1<<2,0|1<<1|0<<2,0|0<<1|1<<2,1|0<<1|0<<2,1|0<<1|1<<2,1|1<<1|0<<2,1|0<<1|0<<2],mi=[0<<3|0<<4|0<<5|0<<6,0<<3|0<<4|0<<5|1<<6,0<<3|0<<4|1<<5|0<<6,0<<3|0<<4|1<<5|1<<6,0<<3|1<<4|0<<5|0<<6,0<<3|1<<4|0<<5|1<<6,0<<3|1<<4|1<<5|0<<6,0<<3|1<<4|1<<5|1<<6,1<<3|0<<4|0<<5|0<<6],vi=[0<<7,1<<7,1<<7,0<<7,0<<7,0<<7,0<<7,1<<7,0<<7,0<<7,0<<7,0<<7,1<<7],hr=function(){function r(e){this._samplers={},this._device=e,this.disabled=!1}return r.GetSamplerHashCode=function(e){var t,i,n,a=e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1,s=gi[e.samplingMode]+mi[(e._comparisonFunction||514)-512+1]+vi[e.samplingMode]+(((t=e._cachedWrapU)!==null&&t!==void 0?t:1)<<8)+(((i=e._cachedWrapV)!==null&&i!==void 0?i:1)<<10)+(((n=e._cachedWrapR)!==null&&n!==void 0?n:1)<<12)+((e.useMipMaps?1:0)<<14)+(a<<15);return s},r._GetSamplerFilterDescriptor=function(e,t){var i,n,a,s,o,u=e.useMipMaps;switch(e.samplingMode){case 11:i=D.Linear,n=D.Linear,a=D.Nearest,u||(s=o=0);break;case 3:case 3:i=D.Linear,n=D.Linear,u?a=D.Linear:(a=D.Nearest,s=o=0);break;case 8:i=D.Nearest,n=D.Nearest,u?a=D.Linear:(a=D.Nearest,s=o=0);break;case 4:i=D.Nearest,n=D.Nearest,a=D.Nearest,u||(s=o=0);break;case 5:i=D.Nearest,n=D.Linear,a=D.Nearest,u||(s=o=0);break;case 6:i=D.Nearest,n=D.Linear,u?a=D.Linear:(a=D.Nearest,s=o=0);break;case 7:i=D.Nearest,n=D.Linear,a=D.Nearest,s=o=0;break;case 1:case 1:i=D.Nearest,n=D.Nearest,a=D.Nearest,s=o=0;break;case 9:i=D.Linear,n=D.Nearest,a=D.Nearest,u||(s=o=0);break;case 10:i=D.Linear,n=D.Nearest,u?a=D.Linear:(a=D.Nearest,s=o=0);break;case 2:case 2:i=D.Linear,n=D.Linear,a=D.Nearest,s=o=0;break;case 12:i=D.Linear,n=D.Nearest,a=D.Nearest,s=o=0;break;default:i=D.Nearest,n=D.Nearest,a=D.Nearest,s=o=0;break}return t>1&&(s!==0||o!==0)?{magFilter:D.Linear,minFilter:D.Linear,mipmapFilter:D.Linear,anisotropyEnabled:!0}:{magFilter:i,minFilter:n,mipmapFilter:a,lodMinClamp:s,lodMaxClamp:o}},r._GetWrappingMode=function(e){switch(e){case 1:return Me.Repeat;case 0:return Me.ClampToEdge;case 2:return Me.MirrorRepeat}return Me.Repeat},r._GetSamplerWrappingDescriptor=function(e){return{addressModeU:this._GetWrappingMode(e._cachedWrapU),addressModeV:this._GetWrappingMode(e._cachedWrapV),addressModeW:this._GetWrappingMode(e._cachedWrapR)}},r._GetSamplerDescriptor=function(e){var t=e.useMipMaps&&e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1,i=this._GetSamplerFilterDescriptor(e,t);return se(se(se({},i),this._GetSamplerWrappingDescriptor(e)),{compare:e._comparisonFunction?r.GetCompareFunction(e._comparisonFunction):void 0,maxAnisotropy:i.anisotropyEnabled?t:1})},r.GetCompareFunction=function(e){switch(e){case 519:return K.Always;case 514:return K.Equal;case 516:return K.Greater;case 518:return K.GreaterEqual;case 513:return K.Less;case 515:return K.LessEqual;case 512:return K.Never;case 517:return K.NotEqual;default:return K.Less}},r.prototype.getSampler=function(e,t,i){if(t===void 0&&(t=!1),i===void 0&&(i=0),this.disabled)return this._device.createSampler(r._GetSamplerDescriptor(e));t?i=0:i===0&&(i=r.GetSamplerHashCode(e));var n=t?void 0:this._samplers[i];return n||(n=this._device.createSampler(r._GetSamplerDescriptor(e)),t||(this._samplers[i]=n)),n},r}(),Q;(function(r){r[r.StencilReadMask=0]="StencilReadMask",r[r.StencilWriteMask=1]="StencilWriteMask",r[r.DepthBias=2]="DepthBias",r[r.DepthBiasSlopeScale=3]="DepthBiasSlopeScale",r[r.DepthStencilState=4]="DepthStencilState",r[r.MRTAttachments1=5]="MRTAttachments1",r[r.MRTAttachments2=6]="MRTAttachments2",r[r.RasterizationState=7]="RasterizationState",r[r.ColorStates=8]="ColorStates",r[r.ShaderStage=9]="ShaderStage",r[r.TextureStage=10]="TextureStage",r[r.VertexState=11]="VertexState",r[r.NumStates=12]="NumStates"})(Q||(Q={}));var Ze={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:12,32772:13},Le={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7},Ei=function(){function r(e,t,i){this.mrtTextureCount=0,this._device=e,this._useTextureStage=i,this._states=new Array(30),this._statesLength=0,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=t,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=!1,this.vertexBuffers=[],this._kMaxVertexBufferStride=e.limits.maxVertexBufferArrayStride||2048,this.reset()}return r.prototype.reset=function(){this._isDirty=!0,this.vertexBuffers.length=0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setDepthBias(0),this._webgpuColorFormat=[f.BGRA8Unorm],this.setColorFormat(f.BGRA8Unorm),this.setMRT([]),this.setAlphaBlendEnabled(!1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat(f.Depth24PlusStencil8),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null),this._setTextureState(0)},Object.defineProperty(r.prototype,"colorFormats",{get:function(){return this._mrtAttachments1>0?this._mrtFormats:this._webgpuColorFormat},enumerable:!1,configurable:!0}),r.prototype.getRenderPipeline=function(e,t,i,n){if(n===void 0&&(n=0),i>1&&(i=4),this.disabled){var a=r._GetTopology(e);return this._setVertexState(t),this._parameter.pipeline=this._createRenderPipeline(t,a,i),r.NumCacheMiss++,r._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(t.uniqueId),this._setRasterizationState(e,i),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(t),this._setTextureState(n),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._statesLength,r.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=!1,this._stateDirtyLowestIndex=this._statesLength,this._parameter.pipeline)return r.NumCacheHitWithHash++,this._parameter.pipeline;var s=r._GetTopology(e);return this._parameter.pipeline=this._createRenderPipeline(t,s,i),this._setRenderPipeline(this._parameter),r.NumCacheMiss++,r._NumPipelineCreationCurrentFrame++,this._parameter.pipeline},r.prototype.endFrame=function(){r.NumPipelineCreationLastFrame=r._NumPipelineCreationCurrentFrame,r._NumPipelineCreationCurrentFrame=0},r.prototype.setAlphaToCoverage=function(e){this._alphaToCoverageEnabled=e},r.prototype.setFrontFace=function(e){this._frontFace=e},r.prototype.setCullEnabled=function(e){this._cullEnabled=e},r.prototype.setCullFace=function(e){this._cullFace=e},r.prototype.setClampDepth=function(e){this._clampDepth=e},r.prototype.resetDepthCullingState=function(){this.setDepthCullingState(!1,2,1,0,0,!0,!0,519)},r.prototype.setDepthCullingState=function(e,t,i,n,a,s,o,u){this._depthWriteEnabled=o,this._depthTestEnabled=s,this._depthCompare=(u!=null?u:519)-512,this._cullFace=i,this._cullEnabled=e,this._frontFace=t,this.setDepthBiasSlopeScale(n),this.setDepthBias(a)},r.prototype.setDepthBias=function(e){this._depthBias!==e&&(this._depthBias=e,this._states[Q.DepthBias]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Q.DepthBias))},r.prototype.setDepthBiasSlopeScale=function(e){this._depthBiasSlopeScale!==e&&(this._depthBiasSlopeScale=e,this._states[Q.DepthBiasSlopeScale]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Q.DepthBiasSlopeScale))},r.prototype.setColorFormat=function(e){this._webgpuColorFormat[0]=e,this._colorFormat=We[e!=null?e:""]},r.prototype.setMRTAttachments=function(e){this.mrtAttachments=e;for(var t=0,i=0;i<e.length;++i)e[i]!==0&&(t+=1<<i);this._mrtEnabledMask!==t&&(this._mrtEnabledMask=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Q.MRTAttachments1))},r.prototype.setMRT=function(e,t){var i,n;if(t=t!=null?t:e.length,t>10)throw"Can't handle more than 10 attachments for a MRT in cache render pipeline!";this.mrtTextureArray=e,this.mrtTextureCount=t,this._mrtEnabledMask=65535;for(var a=[0,0],s=0,o=0,u=0,l=0;l<t;++l){var h=e[l],c=h==null?void 0:h._hardwareTexture;this._mrtFormats[u]=(i=c==null?void 0:c.format)!==null&&i!==void 0?i:this._webgpuColorFormat[0],a[s]+=We[(n=this._mrtFormats[u])!==null&&n!==void 0?n:""]<<o,o+=6,u++,o>=32&&(o=0,s++)}this._mrtFormats.length=u,(this._mrtAttachments1!==a[0]||this._mrtAttachments2!==a[1])&&(this._mrtAttachments1=a[0],this._mrtAttachments2=a[1],this._states[Q.MRTAttachments1]=a[0],this._states[Q.MRTAttachments2]=a[1],this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Q.MRTAttachments1))},r.prototype.setAlphaBlendEnabled=function(e){this._alphaBlendEnabled=e},r.prototype.setAlphaBlendFactors=function(e,t){this._alphaBlendFuncParams=e,this._alphaBlendEqParams=t},r.prototype.setWriteMask=function(e){this._writeMask=e},r.prototype.setDepthStencilFormat=function(e){this._webgpuDepthStencilFormat=e,this._depthStencilFormat=e===void 0?0:We[e]},r.prototype.setDepthTestEnabled=function(e){this._depthTestEnabled=e},r.prototype.setDepthWriteEnabled=function(e){this._depthWriteEnabled=e},r.prototype.setDepthCompare=function(e){this._depthCompare=(e!=null?e:519)-512},r.prototype.setStencilEnabled=function(e){this._stencilEnabled=e},r.prototype.setStencilCompare=function(e){this._stencilFrontCompare=(e!=null?e:519)-512},r.prototype.setStencilDepthFailOp=function(e){this._stencilFrontDepthFailOp=e===null?1:Le[e]},r.prototype.setStencilPassOp=function(e){this._stencilFrontPassOp=e===null?2:Le[e]},r.prototype.setStencilFailOp=function(e){this._stencilFrontFailOp=e===null?1:Le[e]},r.prototype.setStencilReadMask=function(e){this._stencilReadMask!==e&&(this._stencilReadMask=e,this._states[Q.StencilReadMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Q.StencilReadMask))},r.prototype.setStencilWriteMask=function(e){this._stencilWriteMask!==e&&(this._stencilWriteMask=e,this._states[Q.StencilWriteMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Q.StencilWriteMask))},r.prototype.resetStencilState=function(){this.setStencilState(!1,519,7680,7681,7680,255,255)},r.prototype.setStencilState=function(e,t,i,n,a,s,o){this._stencilEnabled=e,this._stencilFrontCompare=(t!=null?t:519)-512,this._stencilFrontDepthFailOp=i===null?1:Le[i],this._stencilFrontPassOp=n===null?2:Le[n],this._stencilFrontFailOp=a===null?1:Le[a],this.setStencilReadMask(s),this.setStencilWriteMask(o)},r.prototype.setBuffers=function(e,t,i){this._vertexBuffers=e,this._overrideVertexBuffers=i,this._indexBuffer=t},r._GetTopology=function(e){switch(e){case 0:return le.TriangleList;case 2:return le.PointList;case 1:return le.LineList;case 3:return le.PointList;case 4:return le.LineList;case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return le.LineStrip;case 7:return le.TriangleStrip;case 8:throw"TriangleFan is an unsupported fillmode in WebGPU";default:return le.TriangleList}},r._GetAphaBlendOperation=function(e){switch(e){case 32774:return be.Add;case 32778:return be.Subtract;case 32779:return be.ReverseSubtract;case 32775:return be.Min;case 32776:return be.Max;default:return be.Add}},r._GetAphaBlendFactor=function(e){switch(e){case 0:return ie.Zero;case 1:return ie.One;case 768:return ie.Src;case 769:return ie.OneMinusSrc;case 770:return ie.SrcAlpha;case 771:return ie.OneMinusSrcAlpha;case 772:return ie.DstAlpha;case 773:return ie.OneMinusDstAlpha;case 774:return ie.Dst;case 775:return ie.OneMinusDst;case 776:return ie.SrcAlphaSaturated;case 32769:return ie.Constant;case 32770:return ie.OneMinusConstant;case 32771:return ie.Constant;case 32772:return ie.OneMinusConstant;default:return ie.One}},r._GetCompareFunction=function(e){switch(e){case 0:return K.Never;case 1:return K.Less;case 2:return K.Equal;case 3:return K.LessEqual;case 4:return K.Greater;case 5:return K.NotEqual;case 6:return K.GreaterEqual;case 7:return K.Always}return K.Never},r._GetStencilOpFunction=function(e){switch(e){case 0:return ge.Zero;case 1:return ge.Keep;case 2:return ge.Replace;case 3:return ge.IncrementClamp;case 4:return ge.DecrementClamp;case 5:return ge.Invert;case 6:return ge.IncrementWrap;case 7:return ge.DecrementWrap}return ge.Keep},r._GetVertexInputDescriptorFormat=function(e){var t=e.type,i=e.normalized,n=e.getSize();switch(t){case he.BYTE:switch(n){case 1:case 2:return i?k.Snorm8x2:k.Sint8x2;case 3:case 4:return i?k.Snorm8x4:k.Sint8x4}break;case he.UNSIGNED_BYTE:switch(n){case 1:case 2:return i?k.Unorm8x2:k.Uint8x2;case 3:case 4:return i?k.Unorm8x4:k.Uint8x4}break;case he.SHORT:switch(n){case 1:case 2:return i?k.Snorm16x2:k.Sint16x2;case 3:case 4:return i?k.Snorm16x4:k.Sint16x4}break;case he.UNSIGNED_SHORT:switch(n){case 1:case 2:return i?k.Unorm16x2:k.Uint16x2;case 3:case 4:return i?k.Unorm16x4:k.Uint16x4}break;case he.INT:switch(n){case 1:return k.Sint32;case 2:return k.Sint32x2;case 3:return k.Sint32x3;case 4:return k.Sint32x4}break;case he.UNSIGNED_INT:switch(n){case 1:return k.Uint32;case 2:return k.Uint32x2;case 3:return k.Uint32x3;case 4:return k.Uint32x4}break;case he.FLOAT:switch(n){case 1:return k.Float32;case 2:return k.Float32x2;case 3:return k.Float32x3;case 4:return k.Float32x4}break}throw new Error("Invalid Format '".concat(e.getKind(),"' - type=").concat(t,", normalized=").concat(i,", size=").concat(n))},r.prototype._getAphaBlendState=function(){return this._alphaBlendEnabled?{srcFactor:r._GetAphaBlendFactor(this._alphaBlendFuncParams[2]),dstFactor:r._GetAphaBlendFactor(this._alphaBlendFuncParams[3]),operation:r._GetAphaBlendOperation(this._alphaBlendEqParams[1])}:null},r.prototype._getColorBlendState=function(){return this._alphaBlendEnabled?{srcFactor:r._GetAphaBlendFactor(this._alphaBlendFuncParams[0]),dstFactor:r._GetAphaBlendFactor(this._alphaBlendFuncParams[1]),operation:r._GetAphaBlendOperation(this._alphaBlendEqParams[0])}:null},r.prototype._setShaderStage=function(e){this._shaderId!==e&&(this._shaderId=e,this._states[Q.ShaderStage]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Q.ShaderStage))},r.prototype._setRasterizationState=function(e,t){var i=this._frontFace,n=this._cullEnabled?this._cullFace:0,a=this._clampDepth?1:0,s=this._alphaToCoverageEnabled?1:0,o=i-1+(n<<1)+(a<<3)+(s<<4)+(e<<5)+(t<<8);this._rasterizationState!==o&&(this._rasterizationState=o,this._states[Q.RasterizationState]=this._rasterizationState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Q.RasterizationState))},r.prototype._setColorStates=function(){var e=((this._writeMask?1:0)<<22)+(this._colorFormat<<23)+((this._depthWriteEnabled?1:0)<<29);this._alphaBlendEnabled&&(e+=((this._alphaBlendFuncParams[0]===null?2:Ze[this._alphaBlendFuncParams[0]])<<0)+((this._alphaBlendFuncParams[1]===null?2:Ze[this._alphaBlendFuncParams[1]])<<4)+((this._alphaBlendFuncParams[2]===null?2:Ze[this._alphaBlendFuncParams[2]])<<8)+((this._alphaBlendFuncParams[3]===null?2:Ze[this._alphaBlendFuncParams[3]])<<12)+((this._alphaBlendEqParams[0]===null?1:this._alphaBlendEqParams[0]-32773)<<16)+((this._alphaBlendEqParams[1]===null?1:this._alphaBlendEqParams[1]-32773)<<19)),e!==this._colorStates&&(this._colorStates=e,this._states[Q.ColorStates]=this._colorStates,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Q.ColorStates))},r.prototype._setDepthStencilState=function(){var e=this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9):591,t=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+(e<<10);this._depthStencilState!==t&&(this._depthStencilState=t,this._states[Q.DepthStencilState]=this._depthStencilState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Q.DepthStencilState))},r.prototype._setVertexState=function(e){for(var t,i,n=this._statesLength,a=Q.VertexState,s=e._pipelineContext,o=s.shaderProcessingContext.attributeNamesFromEffect,u=s.shaderProcessingContext.attributeLocationsFromEffect,l,h=0,c=0;c<o.length;c++){var _=u[c],d=(t=this._overrideVertexBuffers&&this._overrideVertexBuffers[o[c]])!==null&&t!==void 0?t:this._vertexBuffers[o[c]];d||(d=this._emptyVertexBuffer);var g=(i=d.getBuffer())===null||i===void 0?void 0:i.underlyingResource;if(d._validOffsetRange===void 0){var v=d.byteOffset,p=d.getSize(!0),m=d.byteStride;d._validOffsetRange=v<=this._kMaxVertexBufferStride-p&&(m===0||v+p<=m)}l&&l===g&&d._validOffsetRange||(this.vertexBuffers[h++]=d,l=d._validOffsetRange?g:null);var E=d.hashCode+(_<<7);this._isDirty=this._isDirty||this._states[a]!==E,this._states[a++]=E}this.vertexBuffers.length=h,this._statesLength=a,this._isDirty=this._isDirty||a!==n,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Q.VertexState))},r.prototype._setTextureState=function(e){this._textureState!==e&&(this._textureState=e,this._states[Q.TextureStage]=this._textureState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Q.TextureStage))},r.prototype._createPipelineLayout=function(e){if(this._useTextureStage)return this._createPipelineLayoutWithTextureStage(e);for(var t=[],i=e.shaderProcessingContext.bindGroupLayoutEntries,n=0;n<i.length;n++){var a=i[n];t[n]=this._device.createBindGroupLayout({entries:a})}return e.bindGroupLayouts=t,this._device.createPipelineLayout({bindGroupLayouts:t})},r.prototype._createPipelineLayoutWithTextureStage=function(e){for(var t,i=e.shaderProcessingContext,n=i.bindGroupLayoutEntries,a=1,s=0;s<n.length;s++)for(var o=n[s],u=0;u<o.length;u++){var l=n[s][u];if(l.texture){var h=i.bindGroupLayoutEntryInfo[s][l.binding].name,c=i.availableTextures[h],_=c.autoBindSampler?i.availableSamplers[h+te.AutoSamplerSuffix]:null,d=c.sampleType,g=(t=_==null?void 0:_.type)!==null&&t!==void 0?t:xe.Filtering;if(this._textureState&a&&d!==oe.Depth&&(c.autoBindSampler&&(g=xe.NonFiltering),d=oe.UnfilterableFloat),l.texture.sampleType=d,_){var v=i.bindGroupLayoutEntryInfo[_.binding.groupIndex][_.binding.bindingIndex].index;n[_.binding.groupIndex][v].sampler.type=g}a=a<<1}}for(var p=[],s=0;s<n.length;++s)p[s]=this._device.createBindGroupLayout({entries:n[s]});return e.bindGroupLayouts=p,this._device.createPipelineLayout({bindGroupLayouts:p})},r.prototype._getVertexInputDescriptor=function(e){for(var t,i,n=[],a=e._pipelineContext,s=a.shaderProcessingContext.attributeNamesFromEffect,o=a.shaderProcessingContext.attributeLocationsFromEffect,u,l,h=0;h<s.length;h++){var c=o[h],_=(t=this._overrideVertexBuffers&&this._overrideVertexBuffers[s[h]])!==null&&t!==void 0?t:this._vertexBuffers[s[h]];_||(_=this._emptyVertexBuffer);var d=(i=_.getBuffer())===null||i===void 0?void 0:i.underlyingResource,g=_.byteOffset,v=!_._validOffsetRange;if(!(u&&l&&u===d)||v){var p={arrayStride:_.byteStride,stepMode:_.getIsInstanced()?nt.Instance:nt.Vertex,attributes:[]};n.push(p),l=p.attributes,v&&(g=0,d=null)}l.push({shaderLocation:c,offset:g,format:r._GetVertexInputDescriptorFormat(_)}),u=d}return n},r.prototype._createRenderPipeline=function(e,t,i){var n=e._pipelineContext,a=this._getVertexInputDescriptor(e),s=this._createPipelineLayout(n),o=[],u=this._getAphaBlendState(),l=this._getColorBlendState();if(this._mrtAttachments1>0)for(var h=0;h<this._mrtFormats.length;++h){var c=this._mrtFormats[h];if(c){var _={format:c,writeMask:(this._mrtEnabledMask&1<<h)!==0?this._writeMask:0};u&&l&&(_.blend={alpha:u,color:l}),o.push(_)}else o.push(null)}else if(this._webgpuColorFormat[0]){var _={format:this._webgpuColorFormat[0],writeMask:this._writeMask};u&&l&&(_.blend={alpha:u,color:l}),o.push(_)}else o.push(null);var d={compare:r._GetCompareFunction(this._stencilEnabled?this._stencilFrontCompare:7),depthFailOp:r._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontDepthFailOp:1),failOp:r._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontFailOp:1),passOp:r._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontPassOp:1)},g=void 0;(t===le.LineStrip||t===le.TriangleStrip)&&(g=!this._indexBuffer||this._indexBuffer.is32Bits?Ie.Uint32:Ie.Uint16);var v=this._webgpuDepthStencilFormat?Ae.HasStencilAspect(this._webgpuDepthStencilFormat):!1;return this._device.createRenderPipeline({layout:s,vertex:{module:n.stages.vertexStage.module,entryPoint:n.stages.vertexStage.entryPoint,buffers:a},primitive:{topology:t,stripIndexFormat:g,frontFace:this._frontFace===1?it.CCW:it.CW,cullMode:this._cullEnabled?this._cullFace===2?Ne.Front:Ne.Back:Ne.None},fragment:n.stages.fragmentStage?{module:n.stages.fragmentStage.module,entryPoint:n.stages.fragmentStage.entryPoint,targets:o}:void 0,multisample:{count:i},depthStencil:this._webgpuDepthStencilFormat===void 0?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?r._GetCompareFunction(this._depthCompare):K.Always,format:this._webgpuDepthStencilFormat,stencilFront:this._stencilEnabled&&v?d:void 0,stencilBack:this._stencilEnabled&&v?d:void 0,stencilReadMask:this._stencilEnabled&&v?this._stencilReadMask:void 0,stencilWriteMask:this._stencilEnabled&&v?this._stencilWriteMask:void 0,depthBias:this._depthBias,depthBiasClamp:this._depthBiasClamp,depthBiasSlopeScale:this._depthBiasSlopeScale}})},r.NumCacheHitWithoutHash=0,r.NumCacheHitWithHash=0,r.NumCacheMiss=0,r.NumPipelineCreationLastFrame=0,r._NumPipelineCreationCurrentFrame=0,r}(),qt=function(){function r(){this.values={}}return r.prototype.count=function(){var e=0,t=this.pipeline?1:0;for(var i in this.values){var n=this.values[i],a=n.count(),s=a[0],o=a[1];e+=s,t+=o,e++}return[e,t]},r}(),cr=function(r){J(e,r);function e(t,i,n){var a=r.call(this,t,i,n)||this;return a._nodeStack=[],a._nodeStack[0]=e._Cache,a}return e.GetNodeCounts=function(){var t=e._Cache.count();return{nodeCount:t[0],pipelineCount:t[1]}},e._GetPipelines=function(t,i,n,a){if(t.pipeline){var s=n.slice();s.length=a,i.push(s)}for(var o in t.values){var u=t.values[o];n[a]=parseInt(o),e._GetPipelines(u,i,n,a+1)}},e.GetPipelines=function(){var t=[];return e._GetPipelines(e._Cache,t,[],0),t},e.prototype._getRenderPipeline=function(t){for(var i=this._nodeStack[this._stateDirtyLowestIndex],n=this._stateDirtyLowestIndex;n<this._statesLength;++n){var a=i.values[this._states[n]];a||(a=new qt,i.values[this._states[n]]=a),i=a,this._nodeStack[n+1]=i}t.token=i,t.pipeline=i.pipeline},e.prototype._setRenderPipeline=function(t){t.token.pipeline=t.pipeline},e._Cache=new qt,e}(Ei),Ti=function(r){J(e,r);function e(t){var i=r.call(this,!1)||this;return i._cache=t,i.reset(),i}return Object.defineProperty(e.prototype,"func",{get:function(){return this._func},set:function(t){this._func!==t&&(this._func=t,this._cache.setStencilCompare(t))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"funcMask",{get:function(){return this._funcMask},set:function(t){this._funcMask!==t&&(this._funcMask=t,this._cache.setStencilReadMask(t))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"opStencilFail",{get:function(){return this._opStencilFail},set:function(t){this._opStencilFail!==t&&(this._opStencilFail=t,this._cache.setStencilFailOp(t))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"opDepthFail",{get:function(){return this._opDepthFail},set:function(t){this._opDepthFail!==t&&(this._opDepthFail=t,this._cache.setStencilDepthFailOp(t))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"opStencilDepthPass",{get:function(){return this._opStencilDepthPass},set:function(t){this._opStencilDepthPass!==t&&(this._opStencilDepthPass=t,this._cache.setStencilPassOp(t))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mask",{get:function(){return this._mask},set:function(t){this._mask!==t&&(this._mask=t,this._cache.setStencilWriteMask(t))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._cache.setStencilEnabled(t))},enumerable:!1,configurable:!0}),e.prototype.reset=function(){r.prototype.reset.call(this),this._cache.resetStencilState()},e.prototype.apply=function(){var t,i=(t=this.stencilMaterial)===null||t===void 0?void 0:t.enabled;this.enabled=i?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.func=i?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=i?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=i?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=i?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=i?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=i?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=i?this.stencilMaterial.mask:this.stencilGlobal.mask)},e}(Jt),Ri=function(r){J(e,r);function e(t){var i=r.call(this,!1)||this;return i._cache=t,i.reset(),i}return Object.defineProperty(e.prototype,"zOffset",{get:function(){return this._zOffset},set:function(t){this._zOffset!==t&&(this._zOffset=t,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(t))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"zOffsetUnits",{get:function(){return this._zOffsetUnits},set:function(t){this._zOffsetUnits!==t&&(this._zOffsetUnits=t,this._isZOffsetDirty=!0,this._cache.setDepthBias(t))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cullFace",{get:function(){return this._cullFace},set:function(t){this._cullFace!==t&&(this._cullFace=t,this._isCullFaceDirty=!0,this._cache.setCullFace(t!=null?t:1))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cull",{get:function(){return this._cull},set:function(t){this._cull!==t&&(this._cull=t,this._isCullDirty=!0,this._cache.setCullEnabled(!!t))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(t){this._depthFunc!==t&&(this._depthFunc=t,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(t))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthMask",{get:function(){return this._depthMask},set:function(t){this._depthMask!==t&&(this._depthMask=t,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(t))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthTest",{get:function(){return this._depthTest},set:function(t){this._depthTest!==t&&(this._depthTest=t,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(t))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"frontFace",{get:function(){return this._frontFace},set:function(t){this._frontFace!==t&&(this._frontFace=t,this._isFrontFaceDirty=!0,this._cache.setFrontFace(t!=null?t:2))},enumerable:!1,configurable:!0}),e.prototype.reset=function(){r.prototype.reset.call(this),this._cache.resetDepthCullingState()},e.prototype.apply=function(){},e}(Zt),yi=function(){function r(){this.uniqueId=r._Counter++,this.updateId=0,this.reset()}return Object.defineProperty(r.prototype,"forceBindGroupCreation",{get:function(){return this._numExternalTextures>0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasFloatTextures",{get:function(){return this._numFloatTextures>0},enumerable:!1,configurable:!0}),r.prototype.reset=function(){this.samplers={},this.textures={},this.isDirty=!0,this._numFloatTextures=0,this._numExternalTextures=0},r.prototype.setSampler=function(e,t){var i=this.samplers[e],n=-1;i?n=i.hashCode:this.samplers[e]=i={sampler:t,hashCode:0},i.sampler=t,i.hashCode=t?hr.GetSamplerHashCode(t):0;var a=n!==i.hashCode;a&&this.updateId++,this.isDirty||(this.isDirty=a)},r.prototype.setTexture=function(e,t){var i,n,a,s=this.textures[e],o=-1;s?o=(n=(i=s.texture)===null||i===void 0?void 0:i.uniqueId)!==null&&n!==void 0?n:-1:this.textures[e]=s={texture:t,isFloatTexture:!1,isExternalTexture:!1},s.isExternalTexture&&this._numExternalTextures--,s.isFloatTexture&&this._numFloatTextures--,t?(s.isFloatTexture=t.type===1,s.isExternalTexture=Kt.IsExternalTexture(t),s.isFloatTexture&&this._numFloatTextures++,s.isExternalTexture&&this._numExternalTextures++):(s.isFloatTexture=!1,s.isExternalTexture=!1),s.texture=t;var u=o!==((a=t==null?void 0:t.uniqueId)!==null&&a!==void 0?a:-1);u&&this.updateId++,this.isDirty||(this.isDirty=u)},r._Counter=0,r}(),bi=function(){function r(e){this._bufferManager=e,this.uniqueId=r._Counter++,this._useInstancing=!1,this._currentInstanceCount=0,this.reset()}return r.prototype.isDirty=function(e){return this._isDirty||this._materialContextUpdateId!==e},r.prototype.resetIsDirty=function(e){this._isDirty=!1,this._materialContextUpdateId=e},Object.defineProperty(r.prototype,"useInstancing",{get:function(){return this._useInstancing},set:function(e){this._useInstancing!==e&&(e?(this.indirectDrawBuffer=this._bufferManager.createRawBuffer(40,V.CopyDst|V.Indirect),this._indirectDrawData=new Uint32Array(5),this._indirectDrawData[3]=0,this._indirectDrawData[4]=0):(this.indirectDrawBuffer&&this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this._useInstancing=e,this._currentInstanceCount=-1)},enumerable:!1,configurable:!0}),r.prototype.reset=function(){this.buffers={},this._isDirty=!0,this._materialContextUpdateId=0,this.fastBundle=void 0,this.bindGroups=void 0},r.prototype.setBuffer=function(e,t){var i;this._isDirty||(this._isDirty=(t==null?void 0:t.uniqueId)!==((i=this.buffers[e])===null||i===void 0?void 0:i.uniqueId)),this.buffers[e]=t},r.prototype.setIndirectData=function(e,t,i){t===this._currentInstanceCount||!this.indirectDrawBuffer||!this._indirectDrawData||(this._currentInstanceCount=t,this._indirectDrawData[0]=e,this._indirectDrawData[1]=t,this._indirectDrawData[2]=i,this._bufferManager.setRawData(this.indirectDrawBuffer,0,this._indirectDrawData,0,20))},r.prototype.dispose=function(){this.indirectDrawBuffer&&(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this.fastBundle=void 0,this.bindGroups=void 0,this.buffers=void 0},r._Counter=0,r}(),Je=function(){function r(){this.values={}}return r}(),Ai=function(){function r(e,t,i){this.disabled=!1,this._device=e,this._cacheSampler=t,this._engine=i}return Object.defineProperty(r,"Statistics",{get:function(){return{totalCreated:r.NumBindGroupsCreatedTotal,lastFrameCreated:r.NumBindGroupsCreatedLastFrame,lookupLastFrame:r.NumBindGroupsLookupLastFrame,noLookupLastFrame:r.NumBindGroupsNoLookupLastFrame}},enumerable:!1,configurable:!0}),r.prototype.endFrame=function(){r.NumBindGroupsCreatedLastFrame=r._NumBindGroupsCreatedCurrentFrame,r.NumBindGroupsLookupLastFrame=r._NumBindGroupsLookupCurrentFrame,r.NumBindGroupsNoLookupLastFrame=r._NumBindGroupsNoLookupCurrentFrame,r._NumBindGroupsCreatedCurrentFrame=0,r._NumBindGroupsLookupCurrentFrame=0,r._NumBindGroupsNoLookupCurrentFrame=0},r.prototype.getBindGroups=function(e,t,i){var n,a,s,o,u,l,h,c,_,d,g=void 0,v=r._Cache,p=this.disabled||i.forceBindGroupCreation;if(!p){if(!t.isDirty(i.updateId)&&!i.isDirty)return r._NumBindGroupsNoLookupCurrentFrame++,t.bindGroups;for(var m=0,E=e.shaderProcessingContext.bufferNames;m<E.length;m++){var T=E[m],R=(a=(n=t.buffers[T])===null||n===void 0?void 0:n.uniqueId)!==null&&a!==void 0?a:0,y=v.values[R];y||(y=new Je,v.values[R]=y),v=y}for(var C=0,b=e.shaderProcessingContext.samplerNames;C<b.length;C++){var x=b[C],S=(o=(s=i.samplers[x])===null||s===void 0?void 0:s.hashCode)!==null&&o!==void 0?o:0,y=v.values[S];y||(y=new Je,v.values[S]=y),v=y}for(var w=0,A=e.shaderProcessingContext.textureNames;w<A.length;w++){var U=A[w],M=(h=(l=(u=i.textures[U])===null||u===void 0?void 0:u.texture)===null||l===void 0?void 0:l.uniqueId)!==null&&h!==void 0?h:0,y=v.values[M];y||(y=new Je,v.values[M]=y),v=y}g=v.bindGroups}if(t.resetIsDirty(i.updateId),i.isDirty=!1,g)return t.bindGroups=g,r._NumBindGroupsLookupCurrentFrame++,g;g=[],t.bindGroups=g,p||(v.bindGroups=g),r.NumBindGroupsCreatedTotal++,r._NumBindGroupsCreatedCurrentFrame++;for(var q=e.bindGroupLayouts,G=0;G<e.shaderProcessingContext.bindGroupLayoutEntries.length;G++){for(var O=e.shaderProcessingContext.bindGroupLayoutEntries[G],j=e.shaderProcessingContext.bindGroupEntries[G],H=0;H<O.length;H++){var Y=e.shaderProcessingContext.bindGroupLayoutEntries[G][H],me=e.shaderProcessingContext.bindGroupLayoutEntryInfo[G][Y.binding],re=(c=me.nameInArrayOfTexture)!==null&&c!==void 0?c:me.name;if(Y.sampler){var $=i.samplers[re];if($){var Ye=$.sampler;if(!Ye){this._engine.dbgSanityChecks&&I.Error("Trying to bind a null sampler! entry=".concat(JSON.stringify(Y),", name=").concat(re,", bindingInfo=").concat(JSON.stringify($,function(Qe,ne){return Qe==="texture"?"<no dump>":ne}),", materialContext.uniqueId=").concat(i.uniqueId),50);continue}j[H].resource=this._cacheSampler.getSampler(Ye,!1,$.hashCode)}else I.Error('Sampler "'.concat(re,'" could not be bound. entry=').concat(JSON.stringify(Y),", materialContext=").concat(JSON.stringify(i,function(Qe,ne){return Qe==="texture"||Qe==="sampler"?"<no dump>":ne})),50)}else if(Y.texture||Y.storageTexture){var $=i.textures[re];if($){if(this._engine.dbgSanityChecks&&$.texture===null){I.Error("Trying to bind a null texture! entry=".concat(JSON.stringify(Y),", bindingInfo=").concat(JSON.stringify($,function(ne,de){return ne==="texture"?"<no dump>":de}),", materialContext.uniqueId=").concat(i.uniqueId),50);continue}var Pe=$.texture._hardwareTexture;if(this._engine.dbgSanityChecks&&(!Pe||Y.texture&&!Pe.view||Y.storageTexture&&!Pe.viewForWriting)){I.Error("Trying to bind a null gpu texture or view! entry=".concat(JSON.stringify(Y),", name=").concat(re,", bindingInfo=").concat(JSON.stringify($,function(ne,de){return ne==="texture"?"<no dump>":de}),", isReady=").concat((_=$.texture)===null||_===void 0?void 0:_.isReady,", materialContext.uniqueId=").concat(i.uniqueId),50);continue}j[H].resource=Y.storageTexture?Pe.viewForWriting:Pe.view}else I.Error('Texture "'.concat(re,'" could not be bound. entry=').concat(JSON.stringify(Y),", materialContext=").concat(JSON.stringify(i,function(ne,de){return ne==="texture"||ne==="sampler"?"<no dump>":de})),50)}else if(Y.externalTexture){var $=i.textures[re];if($){if(this._engine.dbgSanityChecks&&$.texture===null){I.Error("Trying to bind a null external texture! entry=".concat(JSON.stringify(Y),", name=").concat(re,", bindingInfo=").concat(JSON.stringify($,function(ne,de){return ne==="texture"?"<no dump>":de}),", materialContext.uniqueId=").concat(i.uniqueId),50);continue}var At=$.texture.underlyingResource;if(this._engine.dbgSanityChecks&&!At){I.Error("Trying to bind a null gpu external texture! entry=".concat(JSON.stringify(Y),", name=").concat(re,", bindingInfo=").concat(JSON.stringify($,function(ne,de){return ne==="texture"?"<no dump>":de}),", isReady=").concat((d=$.texture)===null||d===void 0?void 0:d.isReady,", materialContext.uniqueId=").concat(i.uniqueId),50);continue}j[H].resource=this._device.importExternalTexture({source:At})}else I.Error('Texture "'.concat(re,'" could not be bound. entry=').concat(JSON.stringify(Y),", materialContext=").concat(JSON.stringify(i,function(ne,de){return ne==="texture"||ne==="sampler"?"<no dump>":de})),50)}else if(Y.buffer){var ut=t.buffers[re];if(ut){var _r=ut.underlyingResource;j[H].resource.buffer=_r,j[H].resource.size=ut.capacity}else I.Error(`Can't find buffer "`.concat(re,'". entry=').concat(JSON.stringify(Y),", buffers=").concat(JSON.stringify(t.buffers),", drawContext.uniqueId=").concat(t.uniqueId),50)}}var dr=q[G];g[G]=this._device.createBindGroup({layout:dr,entries:j})}return g},r.NumBindGroupsCreatedTotal=0,r.NumBindGroupsCreatedLastFrame=0,r.NumBindGroupsLookupLastFrame=0,r.NumBindGroupsNoLookupLastFrame=0,r._Cache=new Je,r._NumBindGroupsCreatedCurrentFrame=0,r._NumBindGroupsLookupCurrentFrame=0,r._NumBindGroupsNoLookupCurrentFrame=0,r}(),Si=function(){function r(e,t,i){this._bindGroups={},this._bundleCache={},this._keyTemp=[],this._device=e,this._engine=t,this._cacheRenderPipeline=new cr(this._device,i,!t._caps.textureFloatLinearFiltering),this._cacheRenderPipeline.setDepthTestEnabled(!1),this._cacheRenderPipeline.setStencilReadMask(255),this._effect=t.createEffect("clearQuad",[],["color","depthValue"])}return r.prototype.setDepthStencilFormat=function(e){this._depthTextureFormat=e,this._cacheRenderPipeline.setDepthStencilFormat(e)},r.prototype.setColorFormat=function(e){this._cacheRenderPipeline.setColorFormat(e)},r.prototype.setMRTAttachments=function(e,t,i){this._cacheRenderPipeline.setMRT(t,i),this._cacheRenderPipeline.setMRTAttachments(e)},r.prototype.clear=function(e,t,i,n,a){var s,o;a===void 0&&(a=1);var u,l=null,h,c=!!this._engine._currentRenderTarget;if(e)u=e;else{var _=0;this._keyTemp.length=0;for(var d=0;d<this._cacheRenderPipeline.colorFormats.length;++d)this._keyTemp[_++]=We[(s=this._cacheRenderPipeline.colorFormats[d])!==null&&s!==void 0?s:""];var g=We[(o=this._depthTextureFormat)!==null&&o!==void 0?o:0];if(this._keyTemp[_]=(t?t.r+t.g*256+t.b*256*256+t.a*256*256*256:0)+(i?Math.pow(2,32):0)+(n?Math.pow(2,33):0)+(this._engine.useReverseDepthBuffer?Math.pow(2,34):0)+(c?Math.pow(2,35):0)+(a>1?Math.pow(2,36):0)+g*Math.pow(2,37),h=this._keyTemp.join("_"),l=this._bundleCache[h],l)return l;u=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:a})}this._cacheRenderPipeline.setDepthWriteEnabled(!!i),this._cacheRenderPipeline.setStencilEnabled(!!n&&!!this._depthTextureFormat&&Ae.HasStencilAspect(this._depthTextureFormat)),this._cacheRenderPipeline.setStencilWriteMask(n?255:0),this._cacheRenderPipeline.setStencilCompare(n?519:512),this._cacheRenderPipeline.setStencilPassOp(n?7681:7680),this._cacheRenderPipeline.setWriteMask(t?15:0);var v=this._cacheRenderPipeline.getRenderPipeline(7,this._effect,a),p=this._effect._pipelineContext;t&&this._effect.setDirectColor4("color",t),this._effect.setFloat("depthValue",this._engine.useReverseDepthBuffer?this._engine._clearReverseDepthValue:this._engine._clearDepthValue),p.uniformBuffer.update();var m=c?this._engine._ubInvertY:this._engine._ubDontInvertY,E=p.uniformBuffer.getBuffer(),T=E.uniqueId+"-"+m.uniqueId,R=this._bindGroups[T];if(!R){var y=p.bindGroupLayouts;R=this._bindGroups[T]=[],R.push(this._device.createBindGroup({layout:y[0],entries:[]})),Xe._SimplifiedKnownBindings||R.push(this._device.createBindGroup({layout:y[1],entries:[]})),R.push(this._device.createBindGroup({layout:y[Xe._SimplifiedKnownBindings?1:2],entries:[{binding:0,resource:{buffer:m.underlyingResource,size:m.capacity}},{binding:1,resource:{buffer:E.underlyingResource,size:E.capacity}}]}))}u.setPipeline(v);for(var d=0;d<R.length;++d)u.setBindGroup(d,R[d]);return u.draw(4,1,0,0),e||(l=u.finish(),this._bundleCache[h]=l),l},r}(),Ci=function(){function r(e,t,i,n){this.x=Math.floor(e),this.y=Math.floor(t),this.w=Math.floor(i),this.h=Math.floor(n)}return r.prototype.run=function(e){e.setViewport(this.x,this.y,this.w,this.h,0,1)},r.prototype.clone=function(){return new r(this.x,this.y,this.w,this.h)},r}(),ft=function(){function r(e,t,i,n){this.x=e,this.y=t,this.w=i,this.h=n}return r.prototype.run=function(e){e.setScissorRect(this.x,this.y,this.w,this.h)},r.prototype.clone=function(){return new r(this.x,this.y,this.w,this.h)},r}(),_t=function(){function r(e){this.ref=e}return r.prototype.run=function(e){e.setStencilReference(this.ref)},r.prototype.clone=function(){return new r(this.ref)},r}(),xi=function(){function r(e){this.color=e}return r.prototype.run=function(e){e.setBlendConstant(this.color)},r.prototype.clone=function(){return new r(this.color)},r}(),Pi=function(){function r(e){this.query=e}return r.prototype.run=function(e){e.beginOcclusionQuery(this.query)},r.prototype.clone=function(){return new r(this.query)},r}(),Bi=function(){function r(){}return r.prototype.run=function(e){e.endOcclusionQuery()},r.prototype.clone=function(){return new r},r}(),wi=function(){function r(){this.bundles=[]}return r.prototype.run=function(e){e.executeBundles(this.bundles)},r.prototype.clone=function(){var e=new r;return e.bundles=this.bundles,e},r}(),zt=function(){function r(e){this.numDrawCalls=0,this._device=e,this._list=new Array(10),this._listLength=0}return r.prototype.addBundle=function(e){if(!this._currentItemIsBundle){var t=new wi;this._list[this._listLength++]=t,this._currentBundleList=t.bundles,this._currentItemIsBundle=!0}e&&this._currentBundleList.push(e)},r.prototype._finishBundle=function(){this._currentItemIsBundle&&this._bundleEncoder&&(this._currentBundleList.push(this._bundleEncoder.finish()),this._bundleEncoder=void 0,this._currentItemIsBundle=!1)},r.prototype.addItem=function(e){this._finishBundle(),this._list[this._listLength++]=e,this._currentItemIsBundle=!1},r.prototype.getBundleEncoder=function(e,t,i){return this._currentItemIsBundle||(this.addBundle(),this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,sampleCount:i})),this._bundleEncoder},r.prototype.close=function(){this._finishBundle()},r.prototype.run=function(e){this.close();for(var t=0;t<this._listLength;++t)this._list[t].run(e)},r.prototype.reset=function(){this._listLength=0,this._currentItemIsBundle=!1,this.numDrawCalls=0},r.prototype.clone=function(){this.close();var e=new r(this._device);e._list=new Array(this._listLength),e._listLength=this._listLength,e.numDrawCalls=this.numDrawCalls;for(var t=0;t<this._listLength;++t)e._list[t]=this._list[t].clone();return e},r}(),fr=function(){function r(e,t,i,n,a){a===void 0&&(a=!0),this._dstBuffers=[],this._device=i,this._bufferManager=n,this._count=e,this._canUseMultipleBuffers=a,this._querySet=i.createQuerySet({type:t,count:e}),this._queryBuffer=n.createRawBuffer(8*e,V.QueryResolve|V.CopySrc),a||this._dstBuffers.push(this._bufferManager.createRawBuffer(8*this._count,V.MapRead|V.CopyDst))}return Object.defineProperty(r.prototype,"querySet",{get:function(){return this._querySet},enumerable:!1,configurable:!0}),r.prototype._getBuffer=function(e,t){if(!this._canUseMultipleBuffers&&this._dstBuffers.length===0)return null;var i=this._device.createCommandEncoder(),n;return this._dstBuffers.length===0?n=this._bufferManager.createRawBuffer(8*this._count,V.MapRead|V.CopyDst):(n=this._dstBuffers[this._dstBuffers.length-1],this._dstBuffers.length--),i.resolveQuerySet(this._querySet,e,t,this._queryBuffer,0),i.copyBufferToBuffer(this._queryBuffer,0,n,0,8*t),this._device.queue.submit([i.finish()]),n},r.prototype.readValues=function(e,t){return e===void 0&&(e=0),t===void 0&&(t=1),we(this,void 0,void 0,function(){var i,n;return Fe(this,function(a){switch(a.label){case 0:return i=this._getBuffer(e,t),i===null?[2,null]:[4,i.mapAsync(Ue.Read)];case 1:return a.sent(),n=new BigUint64Array(i.getMappedRange()).slice(),i.unmap(),this._dstBuffers[this._dstBuffers.length]=i,[2,n]}})})},r.prototype.readValue=function(e){return e===void 0&&(e=0),we(this,void 0,void 0,function(){var t,i,n;return Fe(this,function(a){switch(a.label){case 0:return t=this._getBuffer(e,1),t===null?[2,null]:[4,t.mapAsync(Ue.Read)];case 1:return a.sent(),i=new BigUint64Array(t.getMappedRange()),n=Number(i[0]),t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,[2,n]}})})},r.prototype.readTwoValuesAndSubtract=function(e){return e===void 0&&(e=0),we(this,void 0,void 0,function(){var t,i,n;return Fe(this,function(a){switch(a.label){case 0:return t=this._getBuffer(e,2),t===null?[2,null]:[4,t.mapAsync(Ue.Read)];case 1:return a.sent(),i=new BigUint64Array(t.getMappedRange()),n=Number(i[1]-i[0]),t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,[2,n]}})})},r.prototype.dispose=function(){this._querySet.destroy(),this._bufferManager.releaseBuffer(this._queryBuffer);for(var e=0;e<this._dstBuffers.length;++e)this._bufferManager.releaseBuffer(this._dstBuffers[e])},r}(),Fi=function(){function r(e,t){this._enabled=!1,this._gpuFrameTimeCounter=new vt,this._measureDurationState=0,this._device=e,this._bufferManager=t}return Object.defineProperty(r.prototype,"gpuFrameTimeCounter",{get:function(){return this._gpuFrameTimeCounter},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"enable",{get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._measureDurationState=0,e?this._measureDuration=new Ui(this._device,this._bufferManager):this._measureDuration.dispose())},enumerable:!1,configurable:!0}),r.prototype.startFrame=function(e){this._enabled&&this._measureDurationState===0&&(this._measureDuration.start(e),this._measureDurationState=1)},r.prototype.endFrame=function(e){var t=this;this._measureDurationState===1&&(this._measureDurationState=2,this._measureDuration.stop(e).then(function(i){i!==null&&i>=0&&(t._gpuFrameTimeCounter.fetchNewFrame(),t._gpuFrameTimeCounter.addCount(i,!0)),t._measureDurationState=0}))},r}(),Ui=function(){function r(e,t){this._querySet=new fr(2,at.Timestamp,e,t)}return r.prototype.start=function(e){e.writeTimestamp(this._querySet.querySet,0)},r.prototype.stop=function(e){return we(this,void 0,void 0,function(){return Fe(this,function(t){return e.writeTimestamp(this._querySet.querySet,1),[2,this._querySet.readTwoValuesAndSubtract(0)]})})},r.prototype.dispose=function(){this._querySet.dispose()},r}(),Ii=function(){function r(e,t,i,n,a){n===void 0&&(n=50),a===void 0&&(a=100),this._availableIndices=[],this._engine=e,this._device=t,this._bufferManager=i,this._frameLastBuffer=-1,this._currentTotalIndices=0,this._countIncrement=a,this._allocateNewIndices(n)}return Object.defineProperty(r.prototype,"querySet",{get:function(){return this._querySet.querySet},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasQueries",{get:function(){return this._currentTotalIndices!==this._availableIndices.length},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"canBeginQuery",{get:function(){var e=this._engine._getCurrentRenderPassIndex();switch(e){case 0:return this._engine._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet!==void 0;case 1:return this._engine._rttRenderPassWrapper.renderPassDescriptor.occlusionQuerySet!==void 0}return!1},enumerable:!1,configurable:!0}),r.prototype.createQuery=function(){this._availableIndices.length===0&&this._allocateNewIndices();var e=this._availableIndices[this._availableIndices.length-1];return this._availableIndices.length--,e},r.prototype.deleteQuery=function(e){this._availableIndices[this._availableIndices.length-1]=e},r.prototype.isQueryResultAvailable=function(e){return this._retrieveQueryBuffer(),!!this._lastBuffer&&e<this._lastBuffer.length},r.prototype.getQueryResult=function(e){var t,i;return Number((i=(t=this._lastBuffer)===null||t===void 0?void 0:t[e])!==null&&i!==void 0?i:-1)},r.prototype._retrieveQueryBuffer=function(){var e=this;this._lastBuffer&&this._frameLastBuffer===this._engine.frameId||this._frameLastBuffer!==this._engine.frameId&&(this._frameLastBuffer=this._engine.frameId,this._querySet.readValues(0,this._currentTotalIndices).then(function(t){e._lastBuffer=t}))},r.prototype._allocateNewIndices=function(e){e=e!=null?e:this._countIncrement,this._delayQuerySetDispose();for(var t=0;t<e;++t)this._availableIndices.push(this._currentTotalIndices+t);this._currentTotalIndices+=e,this._querySet=new fr(this._currentTotalIndices,at.Occlusion,this._device,this._bufferManager,!1)},r.prototype._delayQuerySetDispose=function(){var e=this._querySet;e&&setTimeout(function(){return e.dispose},1e3)},r.prototype.dispose=function(){var e;(e=this._querySet)===null||e===void 0||e.dispose(),this._availableIndices.length=0},r}(),Di=function(){function r(){this._twgsl=null}return r.prototype.initTwgsl=function(e){return we(this,void 0,void 0,function(){var t;return Fe(this,function(i){switch(i.label){case 0:return e=e||{},e=se(se({},r._TWgslDefaultOptions),e),e.twgsl?(this._twgsl=e.twgsl,[2,Promise.resolve()]):e.jsPath&&e.wasmPath?ae()?[4,ce.LoadScriptAsync(e.jsPath)]:[3,2]:[3,3];case 1:return i.sent(),[3,3];case 2:importScripts(e.jsPath),i.label=3;case 3:return self.twgsl?(t=this,[4,self.twgsl(e.wasmPath)]):[3,5];case 4:return t._twgsl=i.sent(),[2,Promise.resolve()];case 5:return[2,Promise.reject("twgsl is not available.")]}})})},r.prototype.convertSpirV2WGSL=function(e){return this._twgsl.convertSpirV2WGSL(e)},r._TWgslDefaultOptions={jsPath:"https://preview.babylonjs.com/twgsl/twgsl.js",wasmPath:"https://preview.babylonjs.com/twgsl/twgsl.wasm"},r}(),Li=function(){function r(e,t,i,n){this._record=!1,this._play=!1,this._mainPassBundleList=[],this._enabled=!1,this._engine=e,this._mode=t,this._bundleList=i,this._bundleListRenderTarget=n}return Object.defineProperty(r.prototype,"enabled",{get:function(){return this._enabled},set:function(e){this._mainPassBundleList.length=0,this._record=this._enabled=e,this._play=!1,e&&(this._modeSaved=this._mode,this._mode=0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"play",{get:function(){return this._play},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"record",{get:function(){return this._record},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"mode",{get:function(){return this._mode},set:function(e){this._record?this._modeSaved=e:this._mode=e},enumerable:!1,configurable:!0}),r.prototype.endMainRenderPass=function(){this._record&&this._mainPassBundleList.push(this._bundleList.clone())},r.prototype.endRenderTargetPass=function(e,t){var i,n,a,s;if(this._play)(n=(i=t._bundleLists)===null||i===void 0?void 0:i[t._currentLayer])===null||n===void 0||n.run(e),this._mode===1&&this._engine._reportDrawCall((s=(a=t._bundleLists)===null||a===void 0?void 0:a[t._currentLayer])===null||s===void 0?void 0:s.numDrawCalls);else if(this._record)t._bundleLists||(t._bundleLists=[]),t._bundleLists[t._currentLayer]=this._bundleListRenderTarget.clone(),t._bundleLists[t._currentLayer].run(e),this._bundleListRenderTarget.reset();else return!1;return!0},r.prototype.endFrame=function(e){if(this._record&&(this._mainPassBundleList.push(this._bundleList.clone()),this._record=!1,this._play=!0,this._mode=this._modeSaved),e!==null&&this._play)for(var t=0;t<this._mainPassBundleList.length;++t)this._mainPassBundleList[t].run(e),this._mode===1&&this._engine._reportDrawCall(this._mainPassBundleList[t].numDrawCalls)},r.prototype.reset=function(){this.enabled=!1,this.enabled=!0},r}(),B=function(r){J(e,r);function e(t,i){i===void 0&&(i={});var n=this,a,s,o,u;if(n=r.call(this,null)||this,n._uploadEncoderDescriptor={label:"upload"},n._renderEncoderDescriptor={label:"render"},n._renderTargetEncoderDescriptor={label:"renderTarget"},n._clearDepthValue=1,n._clearReverseDepthValue=0,n._clearStencilValue=0,n._defaultSampleCount=4,n._glslang=null,n._tintWASM=null,n._compiledComputeEffects={},n._counters={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},n.countersLastFrame={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},n.numMaxUncapturedErrors=20,n._commandBuffers=[null,null,null],n._currentRenderPass=null,n._mainRenderPassWrapper=new jt,n._rttRenderPassWrapper=new jt,n._pendingDebugCommands=[],n._onAfterUnbindFrameBufferObservable=new ee,n._currentOverrideVertexBuffers=null,n._currentIndexBuffer=null,n._colorWriteLocal=!0,n._forceEnableEffect=!1,n.dbgShowShaderCode=!1,n.dbgSanityChecks=!0,n.dbgVerboseLogsForFirstFrames=!1,n.dbgVerboseLogsNumFrames=10,n.dbgLogIfNotDrawWrapper=!0,n.dbgShowEmptyEnableEffectCalls=!0,n._viewportsCurrent=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}],n._scissorsCurrent=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}],n._scissorCached={x:0,y:0,z:0,w:0},n._stencilRefsCurrent=[-1,-1],n._blendColorsCurrent=[[null,null,null,null],[null,null,null,null]],n._name="WebGPU",n.isNDCHalfZRange=!0,n.hasOriginBottomLeft=!1,i.deviceDescriptor=i.deviceDescriptor||{},i.swapChainFormat=i.swapChainFormat||f.BGRA8Unorm,i.antialiasing=i.antialiasing===void 0?!0:i.antialiasing,i.stencil=(a=i.stencil)!==null&&a!==void 0?a:!0,i.enableGPUDebugMarkers=(s=i.enableGPUDebugMarkers)!==null&&s!==void 0?s:!1,Rt.SetMatrixPrecision(!!i.useHighPrecisionMatrix),I.Log("Babylon.js v".concat(F.Version," - ").concat(n.description," engine")),!navigator.gpu)return I.Error("WebGPU is not supported by your browser."),n;n._isWebGPU=!0,n._shaderPlatformName="WEBGPU",i.deterministicLockstep===void 0&&(i.deterministicLockstep=!1),i.lockstepMaxSteps===void 0&&(i.lockstepMaxSteps=4),i.audioEngine===void 0&&(i.audioEngine=!0),n._deterministicLockstep=i.deterministicLockstep,n._lockstepMaxSteps=i.lockstepMaxSteps,n._timeStep=i.timeStep||1/60,n._doNotHandleContextLost=!!i.doNotHandleContextLost,n._canvas=t,n._options=i,n.premultipliedAlpha=(o=i.premultipliedAlpha)!==null&&o!==void 0?o:!0;var l=ae()&&window.devicePixelRatio||1,h=i.limitDeviceRatio||l,c=(u=i.adaptToDeviceRatio)!==null&&u!==void 0?u:!1;return n._hardwareScalingLevel=c?1/Math.min(h,l):1,n._mainPassSampleCount=i.antialiasing?n._defaultSampleCount:1,n._isStencilEnable=i.stencil,n._sharedInit(t,!!i.doNotHandleTouchAction,i.audioEngine),n._shaderProcessor=new ii,n._shaderProcessorWGSL=new oi,n}return Object.defineProperty(e.prototype,"snapshotRenderingMode",{get:function(){return this._snapshotRendering.mode},set:function(t){this._snapshotRendering.mode=t},enumerable:!1,configurable:!0}),e.prototype.snapshotRenderingReset=function(){this._snapshotRendering.reset()},Object.defineProperty(e.prototype,"snapshotRendering",{get:function(){return this._snapshotRendering.enabled},set:function(t){this._snapshotRendering.enabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"disableCacheSamplers",{get:function(){return this._cacheSampler?this._cacheSampler.disabled:!1},set:function(t){this._cacheSampler&&(this._cacheSampler.disabled=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"disableCacheRenderPipelines",{get:function(){return this._cacheRenderPipeline?this._cacheRenderPipeline.disabled:!1},set:function(t){this._cacheRenderPipeline&&(this._cacheRenderPipeline.disabled=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"disableCacheBindGroups",{get:function(){return this._cacheBindGroups?this._cacheBindGroups.disabled:!1},set:function(t){this._cacheBindGroups&&(this._cacheBindGroups.disabled=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e,"IsSupportedAsync",{get:function(){return navigator.gpu?navigator.gpu.requestAdapter().then(function(t){return!!t},function(){return!1}).catch(function(){return!1}):Promise.resolve(!1)},enumerable:!1,configurable:!0}),Object.defineProperty(e,"IsSupported",{get:function(){return I.Warn("You must call IsSupportedAsync for WebGPU!"),!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"supportsUniformBuffers",{get:function(){return!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"supportedExtensions",{get:function(){return this._adapterSupportedExtensions},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"enabledExtensions",{get:function(){return this._deviceEnabledExtensions},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"description",{get:function(){var t=this.name+this.version;return t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"version",{get:function(){return 1},enumerable:!1,configurable:!0}),e.prototype.getInfo=function(){return{vendor:"unknown vendor",renderer:"unknown renderer",version:"unknown version"}},Object.defineProperty(e.prototype,"compatibilityMode",{get:function(){return this._compatibilityMode},set:function(t){this._compatibilityMode=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentSampleCount",{get:function(){return this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount},enumerable:!1,configurable:!0}),e.CreateAsync=function(t,i){i===void 0&&(i={});var n=new e(t,i);return new Promise(function(a){n.initAsync(i.glslangOptions,i.twgslOptions).then(function(){return a(n)})})},e.prototype.initAsync=function(t,i){var n=this,a;return this._initGlslang(t!=null?t:(a=this._options)===null||a===void 0?void 0:a.glslangOptions).then(function(s){var o;return n._glslang=s,n._tintWASM=e.UseTWGSL?new Di:null,n._tintWASM?n._tintWASM.initTwgsl(i!=null?i:(o=n._options)===null||o===void 0?void 0:o.twgslOptions).then(function(){return navigator.gpu.requestAdapter(n._options)},function(u){throw I.Error("Can not initialize twgsl!"),I.Error(u),Error("WebGPU initializations stopped.")}):navigator.gpu.requestAdapter(n._options)},function(s){throw I.Error("Can not initialize glslang!"),I.Error(s),Error("WebGPU initializations stopped.")}).then(function(s){var o;if(s){n._adapter=s,n._adapterSupportedExtensions=[],(o=n._adapter.features)===null||o===void 0||o.forEach(function(g){return n._adapterSupportedExtensions.push(g)});var u=n._options.deviceDescriptor;if(u!=null&&u.requiredFeatures){for(var l=u.requiredFeatures,h=[],c=0,_=l;c<_.length;c++){var d=_[c];n._adapterSupportedExtensions.indexOf(d)!==-1&&h.push(d)}u.requiredFeatures=h}return n._adapter.requestDevice(n._options.deviceDescriptor)}else throw"Could not retrieve a WebGPU adapter (adapter is null)."}).then(function(s){var o,u;n._device=s,n._deviceEnabledExtensions=[],(o=n._device.features)===null||o===void 0||o.forEach(function(h){return n._deviceEnabledExtensions.push(h)});var l=-1;n._device.addEventListener("uncapturederror",function(h){++l<n.numMaxUncapturedErrors?I.Warn("WebGPU uncaptured error (".concat(l+1,"): ").concat(h.error," - ").concat(h.error.message)):l++===n.numMaxUncapturedErrors&&I.Warn("WebGPU uncaptured error: too many warnings (".concat(n.numMaxUncapturedErrors,"), no more warnings will be reported to the console for this engine."))}),n._doNotHandleContextLost||(u=n._device.lost)===null||u===void 0||u.then(function(h){n._contextWasLost=!0,I.Warn("WebGPU context lost. "+h),n.onContextLostObservable.notifyObservers(n),n._restoreEngineAfterContextLost(n.initAsync.bind(n))})},function(s){I.Error("Could not retrieve a WebGPU device."),I.Error(s)}).then(function(){n._bufferManager=new pi(n._device),n._textureHelper=new Ae(n._device,n._glslang,n._tintWASM,n._bufferManager),n._cacheSampler=new hr(n._device),n._cacheBindGroups=new Ai(n._device,n._cacheSampler,n),n._timestampQuery=new Fi(n._device,n._bufferManager),n._occlusionQuery=n._device.createQuerySet?new Ii(n,n._device,n._bufferManager):void 0,n._bundleList=new zt(n._device),n._bundleListRenderTarget=new zt(n._device),n._snapshotRendering=new Li(n,n._snapshotRenderingMode,n._bundleList,n._bundleListRenderTarget),n._ubInvertY=n._bufferManager.createBuffer(new Float32Array([-1,0]),V.Uniform|V.CopyDst),n._ubDontInvertY=n._bufferManager.createBuffer(new Float32Array([1,0]),V.Uniform|V.CopyDst),n.dbgVerboseLogsForFirstFrames&&n._count===void 0&&(n._count=0,console.log("%c frame #"+n._count+" - begin","background: #ffff00")),n._uploadEncoder=n._device.createCommandEncoder(n._uploadEncoderDescriptor),n._renderEncoder=n._device.createCommandEncoder(n._renderEncoderDescriptor),n._renderTargetEncoder=n._device.createCommandEncoder(n._renderTargetEncoderDescriptor),n._emptyVertexBuffer=new he(n,[0],"",!1,!1,1,!1,0,1),n._initializeLimits(),n._cacheRenderPipeline=new cr(n._device,n._emptyVertexBuffer,!n._caps.textureFloatLinearFiltering),n._depthCullingState=new Ri(n._cacheRenderPipeline),n._stencilStateComposer=new Ti(n._cacheRenderPipeline),n._stencilStateComposer.stencilGlobal=n._stencilState,n._depthCullingState.depthTest=!0,n._depthCullingState.depthFunc=515,n._depthCullingState.depthMask=!0,n._textureHelper.setCommandEncoder(n._uploadEncoder),n._clearQuad=new Si(n._device,n,n._emptyVertexBuffer),n._defaultDrawContext=n.createDrawContext(),n._currentDrawContext=n._defaultDrawContext,n._defaultMaterialContext=n.createMaterialContext(),n._currentMaterialContext=n._defaultMaterialContext,n._initializeContextAndSwapChain(),n._initializeMainAttachments(),n.resize()}).catch(function(s){I.Error("Can not create WebGPU Device and/or context."),I.Error(s),console.trace&&console.trace()})},e.prototype._initGlslang=function(t){return t=t||{},t=se(se({},e._GLSLslangDefaultOptions),t),t.glslang?Promise.resolve(t.glslang):self.glslang?self.glslang(t.wasmPath):t.jsPath&&t.wasmPath?ae()?ce.LoadScriptAsync(t.jsPath).then(function(){return self.glslang(t.wasmPath)}):(importScripts(t.jsPath),self.glslang(t.wasmPath)):Promise.reject("gslang is not available.")},e.prototype._initializeLimits=function(){this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:8192,maxCubemapTextureSize:2048,maxRenderTextureSize:8192,maxVertexAttribs:16,maxVaryingVectors:15,maxFragmentUniformVectors:1024,maxVertexUniformVectors:1024,standardDerivatives:!0,astc:this._deviceEnabledExtensions.indexOf(Be.TextureCompressionASTC)>=0?!0:void 0,s3tc:this._deviceEnabledExtensions.indexOf(Be.TextureCompressionBC)>=0?!0:void 0,pvrtc:null,etc1:null,etc2:this._deviceEnabledExtensions.indexOf(Be.TextureCompressionETC2)>=0?!0:void 0,bptc:this._deviceEnabledExtensions.indexOf(Be.TextureCompressionBC)>=0?!0:void 0,maxAnisotropy:4,uintIndices:!0,fragmentDepthSupported:!0,highPrecisionShaderSupported:!0,colorBufferFloat:!0,textureFloat:!0,textureFloatLinearFiltering:!1,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,drawBuffersExtension:!0,depthTextureExtension:!0,vertexArrayObject:!1,instancedArrays:!0,timerQuery:typeof BigUint64Array!="undefined"&&this.enabledExtensions.indexOf(Be.TimestampQuery)!==-1?!0:void 0,supportOcclusionQuery:typeof BigUint64Array!="undefined",canUseTimestampForTimerQuery:!0,multiview:!1,oculusMultiview:!1,parallelShaderCompile:void 0,blendMinMax:!0,maxMSAASamples:4,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!0,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!0,texture2DArrayMaxLayerCount:2048},this._caps.parallelShaderCompile=null,this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!0,supportDepthStencilTexture:!0,supportShadowSamplers:!0,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!0,trackUbosInFrame:!0,checkUbosContentBeforeUpload:!0,supportCSM:!0,basisNeedsPOT:!1,support3DTextures:!0,needTypeSuffixInShaderConstants:!0,supportMSAA:!0,supportSSAO2:!0,supportExtendedTextureFormats:!0,supportSwitchCaseInShader:!0,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!0,supportRenderPasses:!0,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}},e.prototype._initializeContextAndSwapChain=function(){this._context=this._canvas.getContext("webgpu"),this._configureContext(),this._colorFormat=this._options.swapChainFormat,this._mainRenderPassWrapper.colorAttachmentGPUTextures=[new tt],this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].format=this._colorFormat},e.prototype._initializeMainAttachments=function(){var t;this._mainTextureExtends={width:this.getRenderWidth(),height:this.getRenderHeight(),depthOrArrayLayers:1};var i=new Float32Array([this.getRenderHeight()]);this._bufferManager.setSubData(this._ubInvertY,4,i),this._bufferManager.setSubData(this._ubDontInvertY,4,i);var n;if(this._options.antialiasing){var a={size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:Se.E2d,format:this._options.swapChainFormat,usage:X.RenderAttachment};(t=this._mainTexture)===null||t===void 0||t.destroy(),this._mainTexture=this._device.createTexture(a),n=[{view:this._mainTexture.createView(),clearValue:new Pt(0,0,0,1),loadOp:z.Clear,storeOp:_e.Store}]}else n=[{view:void 0,clearValue:new Pt(0,0,0,1),loadOp:z.Clear,storeOp:_e.Store}];this._mainRenderPassWrapper.depthTextureFormat=this.isStencilEnable?f.Depth24PlusStencil8:f.Depth32Float,this._setDepthTextureFormat(this._mainRenderPassWrapper);var s={size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:Se.E2d,format:this._mainRenderPassWrapper.depthTextureFormat,usage:X.RenderAttachment};this._depthTexture&&this._depthTexture.destroy(),this._depthTexture=this._device.createTexture(s);var o={view:this._depthTexture.createView(),depthClearValue:this._clearDepthValue,depthLoadOp:z.Clear,depthStoreOp:_e.Store,stencilClearValue:this._clearStencilValue,stencilLoadOp:this.isStencilEnable?z.Clear:void 0,stencilStoreOp:this.isStencilEnable?_e.Store:void 0};this._mainRenderPassWrapper.renderPassDescriptor={colorAttachments:n,depthStencilAttachment:o},this._mainRenderPassWrapper.renderPass!==null&&this._endMainRenderPass()},e.prototype._configureContext=function(){this._context.configure({device:this._device,format:this._options.swapChainFormat,usage:X.RenderAttachment|X.CopySrc,alphaMode:this.premultipliedAlpha?st.Premultiplied:st.Opaque})},e.prototype.setSize=function(t,i,n){return n===void 0&&(n=!1),r.prototype.setSize.call(this,t,i,n)?(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - setSize called -",t,i)),this._initializeMainAttachments(),this.snapshotRendering&&this.snapshotRenderingReset(),!0):!1},e.prototype._getShaderProcessor=function(t){return t===Z.WGSL?this._shaderProcessorWGSL:this._shaderProcessor},e.prototype._getShaderProcessingContext=function(t){return new Xe(t)},e.prototype.applyStates=function(){this._stencilStateComposer.apply(),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend)},e.prototype.wipeCaches=function(t){this.preventCacheWipeBetweenFrames&&!t||(this._forceEnableEffect=!0,this._currentIndexBuffer=null,this._currentOverrideVertexBuffers=null,this._cacheRenderPipeline.setBuffers(null,null,null),t&&(this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=515,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters),this._cacheRenderPipeline.setAlphaBlendEnabled(!1),this.setColorWrite(!0)),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)},e.prototype.setColorWrite=function(t){this._colorWriteLocal=t,this._cacheRenderPipeline.setWriteMask(t?15:0)},e.prototype.getColorWrite=function(){return this._colorWriteLocal},e.prototype._resetCurrentViewport=function(t){this._viewportsCurrent[t].x=0,this._viewportsCurrent[t].y=0,this._viewportsCurrent[t].w=0,this._viewportsCurrent[t].h=0,t===1&&(this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0)},e.prototype._mustUpdateViewport=function(t){var i=t===this._mainRenderPassWrapper.renderPass?0:1,n=this._viewportCached.x,a=this._viewportCached.y,s=this._viewportCached.z,o=this._viewportCached.w,u=this._viewportsCurrent[i].x!==n||this._viewportsCurrent[i].y!==a||this._viewportsCurrent[i].w!==s||this._viewportsCurrent[i].h!==o;return u&&(this._viewportsCurrent[i].x=this._viewportCached.x,this._viewportsCurrent[i].y=this._viewportCached.y,this._viewportsCurrent[i].w=this._viewportCached.z,this._viewportsCurrent[i].h=this._viewportCached.w),u},e.prototype._applyViewport=function(t){var i=Math.floor(this._viewportCached.y),n=Math.floor(this._viewportCached.w);this._currentRenderTarget||(i=this.getRenderHeight()-i-n),t.setViewport(Math.floor(this._viewportCached.x),i,Math.floor(this._viewportCached.z),n,0,1),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - viewport applied - (",this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w,") current pass is main pass="+(t===this._mainRenderPassWrapper.renderPass)))},e.prototype._viewport=function(t,i,n,a){this._viewportCached.x=t,this._viewportCached.y=i,this._viewportCached.z=n,this._viewportCached.w=a},e.prototype._resetCurrentScissor=function(t){this._scissorsCurrent[t].x=0,this._scissorsCurrent[t].y=0,this._scissorsCurrent[t].w=0,this._scissorsCurrent[t].h=0},e.prototype._mustUpdateScissor=function(t){var i=t===this._mainRenderPassWrapper.renderPass?0:1,n=this._scissorCached.x,a=this._scissorCached.y,s=this._scissorCached.z,o=this._scissorCached.w,u=this._scissorsCurrent[i].x!==n||this._scissorsCurrent[i].y!==a||this._scissorsCurrent[i].w!==s||this._scissorsCurrent[i].h!==o;return u&&(this._scissorsCurrent[i].x=this._scissorCached.x,this._scissorsCurrent[i].y=this._scissorCached.y,this._scissorsCurrent[i].w=this._scissorCached.z,this._scissorsCurrent[i].h=this._scissorCached.w),u},e.prototype._applyScissor=function(t){t.setScissorRect(this._scissorCached.x,this._currentRenderTarget?this._scissorCached.y:this.getRenderHeight()-this._scissorCached.w-this._scissorCached.y,this._scissorCached.z,this._scissorCached.w),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - scissor applied - (",this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w,") current pass is main pass="+(t===this._mainRenderPassWrapper.renderPass)))},e.prototype._scissorIsActive=function(){return this._scissorCached.x!==0||this._scissorCached.y!==0||this._scissorCached.z!==0||this._scissorCached.w!==0},e.prototype.enableScissor=function(t,i,n,a){this._scissorCached.x=t,this._scissorCached.y=i,this._scissorCached.z=n,this._scissorCached.w=a},e.prototype.disableScissor=function(){this._scissorCached.x=0,this._scissorCached.y=0,this._scissorCached.z=0,this._scissorCached.w=0,this._resetCurrentScissor(0),this._resetCurrentScissor(1)},e.prototype._resetCurrentStencilRef=function(t){this._stencilRefsCurrent[t]=-1},e.prototype._mustUpdateStencilRef=function(t){var i=t===this._mainRenderPassWrapper.renderPass?0:1,n=this._stencilStateComposer.funcRef!==this._stencilRefsCurrent[i];return n&&(this._stencilRefsCurrent[i]=this._stencilStateComposer.funcRef),n},e.prototype._applyStencilRef=function(t){var i;t.setStencilReference((i=this._stencilStateComposer.funcRef)!==null&&i!==void 0?i:0)},e.prototype._resetCurrentColorBlend=function(t){this._blendColorsCurrent[t][0]=this._blendColorsCurrent[t][1]=this._blendColorsCurrent[t][2]=this._blendColorsCurrent[t][3]=null},e.prototype._mustUpdateBlendColor=function(t){var i=t===this._mainRenderPassWrapper.renderPass?0:1,n=this._alphaState._blendConstants,a=n[0]!==this._blendColorsCurrent[i][0]||n[1]!==this._blendColorsCurrent[i][1]||n[2]!==this._blendColorsCurrent[i][2]||n[3]!==this._blendColorsCurrent[i][3];return a&&(this._blendColorsCurrent[i][0]=n[0],this._blendColorsCurrent[i][1]=n[1],this._blendColorsCurrent[i][2]=n[2],this._blendColorsCurrent[i][3]=n[3]),a},e.prototype._applyBlendColor=function(t){t.setBlendConstant(this._alphaState._blendConstants)},e.prototype.clear=function(t,i,n,a){a===void 0&&(a=!1),t&&t.a===void 0&&(t.a=1);var s=this._scissorIsActive();this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - clear called - backBuffer=",i," depth=",n," stencil=",a," scissor is active=",s)),this._currentRenderTarget?s?(this._rttRenderPassWrapper.renderPass||this._startRenderTargetRenderPass(this._currentRenderTarget,!1,i?t:null,n,a),this.compatibilityMode?this._applyScissor(this._currentRenderPass):this._bundleListRenderTarget.addItem(new ft(this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w)),this._clearFullQuad(i?t:null,n,a)):(this._currentRenderPass&&this._endRenderTargetRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,!0,i?t:null,n,a)):((!this._mainRenderPassWrapper.renderPass||!s)&&this._startMainRenderPass(!s,i?t:null,n,a),s&&(this.compatibilityMode?this._applyScissor(this._currentRenderPass):this._bundleList.addItem(new ft(this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w)),this._clearFullQuad(i?t:null,n,a)))},e.prototype._clearFullQuad=function(t,i,n){var a,s,o,u=this.compatibilityMode?this._getCurrentRenderPass():null,l=this._getCurrentRenderPassIndex(),h=l===0?this._bundleList:this._bundleListRenderTarget;this._clearQuad.setColorFormat(this._colorFormat),this._clearQuad.setDepthStencilFormat(this._depthTextureFormat),this._clearQuad.setMRTAttachments((a=this._cacheRenderPipeline.mrtAttachments)!==null&&a!==void 0?a:[],(s=this._cacheRenderPipeline.mrtTextureArray)!==null&&s!==void 0?s:[],this._cacheRenderPipeline.mrtTextureCount),this.compatibilityMode?u.setStencilReference(this._clearStencilValue):h.addItem(new _t(this._clearStencilValue));var c=this._clearQuad.clear(u,t,i,n,this.currentSampleCount);this.compatibilityMode?this._applyStencilRef(u):(h.addBundle(c),h.addItem(new _t((o=this._stencilStateComposer.funcRef)!==null&&o!==void 0?o:0)),this._reportDrawCall())},e.prototype.createVertexBuffer=function(t){var i;t instanceof Array?i=new Float32Array(t):t instanceof ArrayBuffer?i=new Uint8Array(t):i=t;var n=this._bufferManager.createBuffer(i,V.Vertex|V.CopyDst);return n},e.prototype.createDynamicVertexBuffer=function(t){return this.createVertexBuffer(t)},e.prototype.createIndexBuffer=function(t){var i=!0,n;t instanceof Uint32Array||t instanceof Int32Array?n=t:t instanceof Uint16Array?(n=t,i=!1):t.length>65535?n=new Uint32Array(t):(n=new Uint16Array(t),i=!1);var a=this._bufferManager.createBuffer(n,V.Index|V.CopyDst);return a.is32Bits=i,a},e.prototype._createBuffer=function(t,i){var n;t instanceof Array?n=new Float32Array(t):t instanceof ArrayBuffer?n=new Uint8Array(t):n=t;var a=0;return i&1&&(a|=V.CopySrc),i&2&&(a|=V.CopyDst),i&4&&(a|=V.Uniform),i&8&&(a|=V.Vertex),i&16&&(a|=V.Index),i&32&&(a|=V.Storage),this._bufferManager.createBuffer(n,a)},e.prototype.bindBuffersDirectly=function(){throw"Not implemented on WebGPU"},e.prototype.updateAndBindInstancesBuffer=function(){throw"Not implemented on WebGPU"},e.prototype.bindBuffers=function(t,i,n,a){this._currentIndexBuffer=i,this._currentOverrideVertexBuffers=a!=null?a:null,this._cacheRenderPipeline.setBuffers(t,i,this._currentOverrideVertexBuffers)},e.prototype._releaseBuffer=function(t){return this._bufferManager.releaseBuffer(t)},e.prototype.createEffect=function(t,i,n,a,s,o,u,l,h,c){var _;c===void 0&&(c=Z.GLSL);var d=t.vertexElement||t.vertex||t.vertexToken||t.vertexSource||t,g=t.fragmentElement||t.fragment||t.fragmentToken||t.fragmentSource||t,v=this._getGlobalDefines(),p=(_=s!=null?s:i.defines)!==null&&_!==void 0?_:"";v&&(p+=`
`+v);var m=d+"+"+g+"@"+p;if(this._compiledEffects[m]){var E=this._compiledEffects[m];return u&&E.isReady()&&u(E),E}var T=new Ee(t,i,n,a,this,s,o,u,l,h,m,c);return this._compiledEffects[m]=T,T},e.prototype._compileRawShaderToSpirV=function(t,i){return this._glslang.compileGLSL(t,i)},e.prototype._compileShaderToSpirV=function(t,i,n,a){return this._compileRawShaderToSpirV(a+(n?n+`
`:"")+t,i)},e.prototype._getWGSLShader=function(t,i,n){return n?n="//"+n.split(`
`).join(`
//`)+`
`:n="",n+t},e.prototype._createPipelineStageDescriptor=function(t,i,n){return this._tintWASM&&n===Z.GLSL&&(t=this._tintWASM.convertSpirV2WGSL(t),i=this._tintWASM.convertSpirV2WGSL(i)),{vertexStage:{module:this._device.createShaderModule({code:t}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({code:i}),entryPoint:"main"}}},e.prototype._compileRawPipelineStageDescriptor=function(t,i,n){var a=n===Z.GLSL?this._compileRawShaderToSpirV(t,"vertex"):t,s=n===Z.GLSL?this._compileRawShaderToSpirV(i,"fragment"):i;return this._createPipelineStageDescriptor(a,s,n)},e.prototype._compilePipelineStageDescriptor=function(t,i,n,a){this.onBeforeShaderCompilationObservable.notifyObservers(this);var s=`#version 450
`,o=a===Z.GLSL?this._compileShaderToSpirV(t,"vertex",n,s):this._getWGSLShader(t,"vertex",n),u=a===Z.GLSL?this._compileShaderToSpirV(i,"fragment",n,s):this._getWGSLShader(i,"fragment",n),l=this._createPipelineStageDescriptor(o,u,a);return this.onAfterShaderCompilationObservable.notifyObservers(this),l},e.prototype.createRawShaderProgram=function(){throw"Not available on WebGPU"},e.prototype.createShaderProgram=function(){throw"Not available on WebGPU"},e.prototype.inlineShaderCode=function(t){var i=new et(t);return i.debug=!1,i.processCode(),i.code},e.prototype.createPipelineContext=function(t){return new ei(t,this)},e.prototype.createMaterialContext=function(){return new yi},e.prototype.createDrawContext=function(){return new bi(this._bufferManager)},e.prototype._preparePipelineContext=function(t,i,n,a,s,o,u,l){var h=t,c=h.shaderProcessingContext.shaderLanguage;this.dbgShowShaderCode&&(console.log(l),console.log(i),console.log(n)),h.sources={fragment:n,vertex:i,rawVertex:s,rawFragment:o},a?h.stages=this._compileRawPipelineStageDescriptor(i,n,c):h.stages=this._compilePipelineStageDescriptor(i,n,l,c)},e.prototype.getAttributes=function(t,i){for(var n=new Array(i.length),a=t,s=0;s<i.length;s++){var o=i[s],u=a.shaderProcessingContext.availableAttributes[o];u!==void 0&&(n[s]=u)}return n},e.prototype.enableEffect=function(t){if(!!t){var i=!0;if(!Et.IsWrapper(t))i=t!==this._currentEffect,this._currentEffect=t,this._currentMaterialContext=this._defaultMaterialContext,this._currentDrawContext=this._defaultDrawContext,this._counters.numEnableEffects++,this.dbgLogIfNotDrawWrapper&&I.Warn("enableEffect has been called with an Effect and not a Wrapper! effect.uniqueId=".concat(t.uniqueId,", effect.name=").concat(t.name,", effect.name.vertex=").concat(t.name.vertex,", effect.name.fragment=").concat(t.name.fragment),10);else if(!t.effect||t.effect===this._currentEffect&&t.materialContext===this._currentMaterialContext&&t.drawContext===this._currentDrawContext&&!this._forceEnableEffect){if(!t.effect&&this.dbgShowEmptyEnableEffectCalls)throw console.error("drawWrapper=",t),"Invalid call to enableEffect: the effect property is empty!";return}else if(i=t.effect!==this._currentEffect,this._currentEffect=t.effect,this._currentMaterialContext=t.materialContext,this._currentDrawContext=t.drawContext,this._counters.numEnableDrawWrapper++,!this._currentMaterialContext)throw console.error("drawWrapper=",t),"Invalid call to enableEffect: the materialContext property is empty!";this._stencilStateComposer.stencilMaterial=void 0,this._forceEnableEffect=i||this._forceEnableEffect?!1:this._forceEnableEffect,i&&(this._currentEffect.onBind&&this._currentEffect.onBind(this._currentEffect),this._currentEffect._onBindObservable&&this._currentEffect._onBindObservable.notifyObservers(this._currentEffect))}},e.prototype._releaseEffect=function(t){this._compiledEffects[t._key]&&(delete this._compiledEffects[t._key],this._deletePipelineContext(t.getPipelineContext()))},e.prototype.releaseEffects=function(){for(var t in this._compiledEffects){var i=this._compiledEffects[t].getPipelineContext();this._deletePipelineContext(i)}this._compiledEffects={}},e.prototype._deletePipelineContext=function(t){var i=t;i&&t.dispose()},Object.defineProperty(e.prototype,"needPOTTextures",{get:function(){return!1},enumerable:!1,configurable:!0}),e.prototype._createHardwareTexture=function(){return new tt},e.prototype._releaseTexture=function(t){var i=this._internalTexturesCache.indexOf(t);i!==-1&&this._internalTexturesCache.splice(i,1),this._textureHelper.releaseTexture(t)},e.prototype._getRGBABufferInternalSizedFormat=function(){return 5},e.prototype.updateTextureComparisonFunction=function(t,i){t._comparisonFunction=i},e.prototype._createInternalTexture=function(t,i,n,a){var s,o,u;n===void 0&&(n=!0),a===void 0&&(a=L.Unknown);var l={};i!==void 0&&typeof i=="object"?(l.generateMipMaps=i.generateMipMaps,l.type=i.type===void 0?0:i.type,l.samplingMode=i.samplingMode===void 0?3:i.samplingMode,l.format=i.format===void 0?5:i.format,l.samples=(s=i.samples)!==null&&s!==void 0?s:1,l.creationFlags=(o=i.creationFlags)!==null&&o!==void 0?o:0,l.useSRGBBuffer=(u=i.useSRGBBuffer)!==null&&u!==void 0?u:!1):(l.generateMipMaps=i,l.type=0,l.samplingMode=3,l.format=5,l.samples=1,l.creationFlags=0,l.useSRGBBuffer=!1),(l.type===1&&!this._caps.textureFloatLinearFiltering||l.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(l.samplingMode=1),l.type===1&&!this._caps.textureFloat&&(l.type=0,I.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));var h=new N(this,a),c=t.width||t,_=t.height||t,d=t.layers||0;return h.baseWidth=c,h.baseHeight=_,h.width=c,h.height=_,h.depth=d,h.isReady=!0,h.samples=l.samples,h.generateMipMaps=!!l.generateMipMaps,h.samplingMode=l.samplingMode,h.type=l.type,h.format=l.format,h.is2DArray=d>0,h._cachedWrapU=0,h._cachedWrapV=0,h._useSRGBBuffer=l.useSRGBBuffer,this._internalTexturesCache.push(h),n||this._textureHelper.createGPUTextureForInternalTexture(h,c,_,d||1,l.creationFlags),h},e.prototype.createTexture=function(t,i,n,a,s,o,u,l,h,c,_,d,g,v,p){var m=this;return s===void 0&&(s=3),o===void 0&&(o=null),u===void 0&&(u=null),l===void 0&&(l=null),h===void 0&&(h=null),c===void 0&&(c=null),_===void 0&&(_=null),this._createTextureBase(t,i,n,a,s,o,u,function(E,T,R,y,C,b,x,S){var w,A=y;if(E.baseWidth=A.width,E.baseHeight=A.height,E.width=A.width,E.height=A.height,E.format=c!=null?c:-1,S(E.width,E.height,A,T,E,function(){}),!((w=E._hardwareTexture)===null||w===void 0)&&w.underlyingResource)!b&&!x&&m._generateMipmaps(E,m._uploadEncoder);else{var U=m._textureHelper.createGPUTextureForInternalTexture(E,A.width,A.height,void 0,v);Ae.IsImageBitmap(A)&&(m._textureHelper.updateTexture(A,E,A.width,A.height,E.depth,U.format,0,0,C,!1,0,0),!b&&!x&&m._generateMipmaps(E,m._uploadEncoder))}R&&R.removePendingData(E),E.isReady=!0,E.onLoadedObservable.notifyObservers(E),E.onLoadedObservable.clear()},function(){return!1},l,h,c,_,d,g,p)},e.prototype.wrapWebGPUTexture=function(t){var i=new tt(t),n=new N(this,L.Unknown,!0);return n._hardwareTexture=i,n.isReady=!0,n},e.prototype.wrapWebGLTexture=function(){throw new Error("wrapWebGLTexture is not supported, use wrapWebGPUTexture instead.")},e.prototype.generateMipMapsForCubemap=function(t){var i;if(t.generateMipMaps){var n=(i=t._hardwareTexture)===null||i===void 0?void 0:i.underlyingResource;n||this._textureHelper.createGPUTextureForInternalTexture(t),this._generateMipmaps(t,t.source===L.RenderTarget||t.source===L.MultiRenderTarget?this._renderTargetEncoder:void 0)}},e.prototype.updateTextureSamplingMode=function(t,i,n){n===void 0&&(n=!1),n&&(i.generateMipMaps=!0,this._generateMipmaps(i)),i.samplingMode=t},e.prototype.updateTextureWrappingMode=function(t,i,n,a){n===void 0&&(n=null),a===void 0&&(a=null),i!==null&&(t._cachedWrapU=i),n!==null&&(t._cachedWrapV=n),(t.is2DArray||t.is3D)&&a!==null&&(t._cachedWrapR=a)},e.prototype.updateTextureDimensions=function(t,i,n,a){if(a===void 0&&(a=1),!!t._hardwareTexture&&!(t.width===i&&t.height===n&&t.depth===a)){var s=t._hardwareTexture.textureAdditionalUsages;t._hardwareTexture.release(),this._textureHelper.createGPUTextureForInternalTexture(t,i,n,a,s)}},e.prototype._setInternalTexture=function(t,i,n){if(n=n!=null?n:t,this._currentEffect){var a=this._currentEffect._pipelineContext,s=a.shaderProcessingContext.availableTextures[n];if(this._currentMaterialContext.setTexture(t,i),s&&s.autoBindSampler){var o=n+te.AutoSamplerSuffix;this._currentMaterialContext.setSampler(o,i)}}},e.prototype.setTexture=function(t,i,n,a){this._setTexture(t,n,!1,!1,a,a)},e.prototype.setTextureArray=function(t,i,n,a){for(var s=0;s<n.length;s++)this._setTexture(-1,n[s],!0,!1,a+s.toString(),a)},e.prototype._setTexture=function(t,i,n,a,s,o){if(a===void 0&&(a=!1),s===void 0&&(s=""),o=o!=null?o:s,this._currentEffect){if(!i)return this._currentMaterialContext.setTexture(s,null),!1;if(i.video)i.update();else if(i.delayLoadState===4)return i.delayLoad(),!1;var u=null;if(a?u=i.depthStencilTexture:i.isReady()?u=i.getInternalTexture():i.isCube?u=this.emptyCubeTexture:i.is3D?u=this.emptyTexture3D:i.is2DArray?u=this.emptyTexture2DArray:u=this.emptyTexture,u&&!u.isMultiview){if(u.isCube&&u._cachedCoordinatesMode!==i.coordinatesMode){u._cachedCoordinatesMode=i.coordinatesMode;var l=i.coordinatesMode!==3&&i.coordinatesMode!==5?1:0;i.wrapU=l,i.wrapV=l}u._cachedWrapU=i.wrapU,u._cachedWrapV=i.wrapV,u.is3D&&(u._cachedWrapR=i.wrapR),this._setAnisotropicLevel(0,u,i.anisotropicFilteringLevel)}this._setInternalTexture(s,u,o)}else this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - _setTexture called with a null _currentEffect! texture=",i));return!0},e.prototype._setAnisotropicLevel=function(t,i,n){i._cachedAnisotropicFilteringLevel!==n&&(i._cachedAnisotropicFilteringLevel=Math.min(n,this._caps.maxAnisotropy))},e.prototype._bindTexture=function(t,i,n){t!==void 0&&this._setInternalTexture(n,i)},e.prototype.generateMipmaps=function(t){this._generateMipmaps(t,this._renderTargetEncoder)},e.prototype._generateMipmaps=function(t,i){var n=t._hardwareTexture;if(!!n){i=i!=null?i:this._currentRenderTarget&&!this._currentRenderPass?this._renderTargetEncoder:this._currentRenderPass?this._uploadEncoder:this._renderEncoder;var a=t._hardwareTexture.format,s=Ae.ComputeNumMipmapLevels(t.width,t.height);this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - generate mipmaps called - width=",t.width,"height=",t.height,"isCube=",t.isCube)),t.isCube?this._textureHelper.generateCubeMipmaps(n,a,s,i):this._textureHelper.generateMipmaps(n,a,s,0,i)}},e.prototype.updateTextureData=function(t,i,n,a,s,o,u,l,h){var c;u===void 0&&(u=0),l===void 0&&(l=0),h===void 0&&(h=!1);var _=t._hardwareTexture;!((c=t._hardwareTexture)===null||c===void 0)&&c.underlyingResource||(_=this._textureHelper.createGPUTextureForInternalTexture(t));var d=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this._textureHelper.updateTexture(d,t,s,o,t.depth,_.format,u,l,t.invertY,!1,n,a),h&&this._generateMipmaps(t,this._renderTargetEncoder)},e.prototype._uploadCompressedDataToTextureDirectly=function(t,i,n,a,s,o,u){var l;o===void 0&&(o=0),u===void 0&&(u=0);var h=t._hardwareTexture;!((l=t._hardwareTexture)===null||l===void 0)&&l.underlyingResource||(t.format=i,h=this._textureHelper.createGPUTextureForInternalTexture(t,n,a));var c=new Uint8Array(s.buffer,s.byteOffset,s.byteLength);this._textureHelper.updateTexture(c,t,n,a,t.depth,h.format,o,u,!1,!1,0,0)},e.prototype._uploadDataToTextureDirectly=function(t,i,n,a,s,o){var u;n===void 0&&(n=0),a===void 0&&(a=0),o===void 0&&(o=!1);var l=Math.round(Math.log(t.width)*Math.LOG2E),h=Math.round(Math.log(t.height)*Math.LOG2E),c=o?t.width:Math.pow(2,Math.max(l-a,0)),_=o?t.height:Math.pow(2,Math.max(h-a,0)),d=t._hardwareTexture;!((u=t._hardwareTexture)===null||u===void 0)&&u.underlyingResource||(d=this._textureHelper.createGPUTextureForInternalTexture(t,c,_));var g=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this._textureHelper.updateTexture(g,t,c,_,t.depth,d.format,n,a,t.invertY,!1,0,0)},e.prototype._uploadArrayBufferViewToTexture=function(t,i,n,a){n===void 0&&(n=0),a===void 0&&(a=0),this._uploadDataToTextureDirectly(t,i,n,a)},e.prototype._uploadImageToTexture=function(t,i,n,a){var s;n===void 0&&(n=0),a===void 0&&(a=0);var o=t._hardwareTexture;!((s=t._hardwareTexture)===null||s===void 0)&&s.underlyingResource||(o=this._textureHelper.createGPUTextureForInternalTexture(t));var u=i,l=Math.ceil(t.width/(1<<a)),h=Math.ceil(t.height/(1<<a));this._textureHelper.updateTexture(u,t,l,h,t.depth,o.format,n,a,t.invertY,!1,0,0)},e.prototype.readPixels=function(t,i,n,a,s,o){o===void 0&&(o=!0);var u=this._rttRenderPassWrapper.renderPass?this._rttRenderPassWrapper:this._mainRenderPassWrapper,l=u.colorAttachmentGPUTextures[0];if(!l)return Promise.resolve(new Uint8Array(0));var h=l.underlyingResource,c=l.format;return h?(o&&this.flushFramebuffer(),this._textureHelper.readPixels(h,t,i,n,a,c)):Promise.resolve(new Uint8Array(0))},e.prototype.beginFrame=function(){r.prototype.beginFrame.call(this)},e.prototype.endFrame=function(){if(this._snapshotRendering.endFrame(this._mainRenderPassWrapper.renderPass),this._endMainRenderPass(),this._timestampQuery.endFrame(this._renderEncoder),this.flushFramebuffer(!1),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - counters")),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._features._collectUbosUpdatedInFrame){if(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){var t=[];for(var i in Oe._UpdatedUbosInFrame)t.push(i+":"+Oe._UpdatedUbosInFrame[i]);console.log("frame #"+this._count+" - updated ubos -",t.join(", "))}Oe._UpdatedUbosInFrame={}}this.countersLastFrame.numEnableEffects=this._counters.numEnableEffects,this.countersLastFrame.numEnableDrawWrapper=this._counters.numEnableDrawWrapper,this.countersLastFrame.numBundleCreationNonCompatMode=this._counters.numBundleCreationNonCompatMode,this.countersLastFrame.numBundleReuseNonCompatMode=this._counters.numBundleReuseNonCompatMode,this._counters.numEnableEffects=0,this._counters.numEnableDrawWrapper=0,this._counters.numBundleCreationNonCompatMode=0,this._counters.numBundleReuseNonCompatMode=0,this._cacheRenderPipeline.endFrame(),this._cacheBindGroups.endFrame(),this._pendingDebugCommands.length=0,r.prototype.endFrame.call(this),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),this._count<this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this._count+" - end","background: #ffff00"),this._count<this.dbgVerboseLogsNumFrames&&(this._count++,this._count!==this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this._count+" - begin","background: #ffff00")))},e.prototype.flushFramebuffer=function(t){t===void 0&&(t=!0);var i=!this._currentRenderPass,n=0;this._currentRenderPass&&this._currentRenderTarget&&(n|=1,this._endRenderTargetRenderPass()),this._mainRenderPassWrapper.renderPass&&(n|=2,this._endMainRenderPass()),this._commandBuffers[0]=this._uploadEncoder.finish(),this._commandBuffers[1]=this._renderTargetEncoder.finish(),this._commandBuffers[2]=this._renderEncoder.finish(),this._device.queue.submit(this._commandBuffers),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._renderTargetEncoder=this._device.createCommandEncoder(this._renderTargetEncoderDescriptor),this._timestampQuery.startFrame(this._uploadEncoder),this._textureHelper.setCommandEncoder(this._uploadEncoder),this._bundleList.reset(),this._bundleListRenderTarget.reset(),t&&(n&2&&this._startMainRenderPass(!1),n&1&&this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1),i&&this._currentRenderTarget&&(this._currentRenderPass=null))},e.prototype._currentFrameBufferIsDefaultFrameBuffer=function(){return this._currentRenderTarget===null},e.prototype._startRenderTargetRenderPass=function(t,i,n,a,s){var o,u,l,h=t,c=h._depthStencilTexture,_=c==null?void 0:c._hardwareTexture,d=_==null?void 0:_.underlyingResource,g=_==null?void 0:_.msaaTexture,v=d==null?void 0:d.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),p=g==null?void 0:g.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),m=_?Ae.HasStencilAspect(_.format):!1,E=[];this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();var T=i&&n,R=i&&a,y=i&&s;if(h._attachments&&h.isMulti){(!this._mrtAttachments||this._mrtAttachments.length===0)&&(this._mrtAttachments=h._defaultAttachments);for(var C=0;C<this._mrtAttachments.length;++C){var b=this._mrtAttachments[C],x=h.textures[C],S=x==null?void 0:x._hardwareTexture,w=S==null?void 0:S.underlyingResource;if(S&&w){var A=se(se({},this._rttRenderPassWrapper.colorAttachmentViewDescriptor),{format:S.format}),U=S.msaaTexture,M=w.createView(A),q=U==null?void 0:U.createView(A);E.push({view:q||M,resolveTarget:U?M:void 0,clearValue:b!==0&&T?n:void 0,loadOp:b!==0&&T?z.Clear:z.Load,storeOp:_e.Store})}}this._cacheRenderPipeline.setMRT(h.textures,this._mrtAttachments.length),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}else{var G=h.texture;if(G){var O=G._hardwareTexture,j=O.underlyingResource,U=O.msaaTexture,M=j.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),q=U==null?void 0:U.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor);E.push({view:q||M,resolveTarget:U?M:void 0,clearValue:T?n:void 0,loadOp:T?z.Clear:z.Load,storeOp:_e.Store})}else E.push(null)}if((o=this._debugPushGroup)===null||o===void 0||o.call(this,"render target pass",1),this._rttRenderPassWrapper.renderPassDescriptor={colorAttachments:E,depthStencilAttachment:c&&d?{view:p||v,depthClearValue:R?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,depthLoadOp:R?z.Clear:z.Load,depthStoreOp:_e.Store,stencilClearValue:h._depthStencilTextureWithStencil&&y?this._clearStencilValue:void 0,stencilLoadOp:m?h._depthStencilTextureWithStencil&&y?z.Clear:z.Load:void 0,stencilStoreOp:m?_e.Store:void 0}:void 0,occlusionQuerySet:!((u=this._occlusionQuery)===null||u===void 0)&&u.hasQueries?this._occlusionQuery.querySet:void 0},this._rttRenderPassWrapper.renderPass=this._renderTargetEncoder.beginRenderPass(this._rttRenderPassWrapper.renderPassDescriptor),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){var G=h.texture;console.log("frame #"+this._count+" - render target begin pass - internalTexture.uniqueId=",G.uniqueId,"width=",G.width,"height=",G.height,this._rttRenderPassWrapper.renderPassDescriptor)}this._currentRenderPass=this._rttRenderPassWrapper.renderPass,(l=this._debugFlushPendingCommands)===null||l===void 0||l.call(this),this._resetCurrentViewport(1),this._resetCurrentScissor(1),this._resetCurrentStencilRef(1),this._resetCurrentColorBlend(1),(!_||!Ae.HasStencilAspect(_.format))&&(this._stencilStateComposer.enabled=!1)},e.prototype._endRenderTargetRenderPass=function(){var t,i,n,a;if(this._currentRenderPass){var s=(t=this._currentRenderTarget.texture)===null||t===void 0?void 0:t._hardwareTexture;s&&!this._snapshotRendering.endRenderTargetPass(this._currentRenderPass,s)&&!this.compatibilityMode&&(this._bundleListRenderTarget.run(this._currentRenderPass),this._bundleListRenderTarget.reset()),this._currentRenderPass.end(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - render target end pass - internalTexture.uniqueId=",(n=(i=this._currentRenderTarget)===null||i===void 0?void 0:i.texture)===null||n===void 0?void 0:n.uniqueId)),(a=this._debugPopGroup)===null||a===void 0||a.call(this,1),this._resetCurrentViewport(1),this._resetCurrentScissor(1),this._resetCurrentStencilRef(1),this._resetCurrentColorBlend(1),this._currentRenderPass=null,this._rttRenderPassWrapper.reset()}},e.prototype._getCurrentRenderPass=function(){return this._currentRenderTarget&&!this._currentRenderPass?this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1):this._currentRenderPass||this._startMainRenderPass(!1),this._currentRenderPass},e.prototype._getCurrentRenderPassIndex=function(){return this._currentRenderPass===null?-1:this._currentRenderPass===this._mainRenderPassWrapper.renderPass?0:1},e.prototype._startMainRenderPass=function(t,i,n,a){var s,o,u;this._mainRenderPassWrapper.renderPass&&this._endMainRenderPass(),this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();var l=t&&i,h=t&&n,c=t&&a;this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].clearValue=l?i:void 0,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].loadOp=l?z.Clear:z.Load,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthClearValue=h?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthLoadOp=h?z.Clear:z.Load,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilClearValue=c?this._clearStencilValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilLoadOp=this.isStencilEnable?c?z.Clear:z.Load:void 0,this._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet=!((s=this._occlusionQuery)===null||s===void 0)&&s.hasQueries?this._occlusionQuery.querySet:void 0,this._swapChainTexture=this._context.getCurrentTexture(),this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].set(this._swapChainTexture),this._options.antialiasing?this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].resolveTarget=this._swapChainTexture.createView():this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].view=this._swapChainTexture.createView(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - main begin pass - texture width="+this._mainTextureExtends.width," height="+this._mainTextureExtends.height,this._mainRenderPassWrapper.renderPassDescriptor)),(o=this._debugPushGroup)===null||o===void 0||o.call(this,"main pass",0),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._mainRenderPassWrapper.renderPassDescriptor),this._mainRenderPassWrapper.renderPass=this._currentRenderPass,(u=this._debugFlushPendingCommands)===null||u===void 0||u.call(this),this._resetCurrentViewport(0),this._resetCurrentScissor(0),this._resetCurrentStencilRef(0),this._resetCurrentColorBlend(0),this._isStencilEnable||(this._stencilStateComposer.enabled=!1)},e.prototype._endMainRenderPass=function(){var t;this._mainRenderPassWrapper.renderPass!==null&&(this._snapshotRendering.endMainRenderPass(),!this.compatibilityMode&&!this._snapshotRendering.play&&(this._bundleList.run(this._mainRenderPassWrapper.renderPass),this._bundleList.reset()),this._mainRenderPassWrapper.renderPass.end(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - main end pass")),(t=this._debugPopGroup)===null||t===void 0||t.call(this,0),this._resetCurrentViewport(0),this._resetCurrentScissor(0),this._resetCurrentStencilRef(0),this._resetCurrentColorBlend(0),this._mainRenderPassWrapper.renderPass===this._currentRenderPass&&(this._currentRenderPass=null),this._mainRenderPassWrapper.reset(!1))},e.prototype.bindFramebuffer=function(t,i,n,a,s,o,u){var l,h;i===void 0&&(i=0),o===void 0&&(o=0),u===void 0&&(u=0);var c=(l=t.texture)===null||l===void 0?void 0:l._hardwareTexture;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=t,c&&(c._currentLayer=t.isCube?u*6+i:u),this._rttRenderPassWrapper.colorAttachmentGPUTextures[0]=c,this._rttRenderPassWrapper.depthTextureFormat=this._currentRenderTarget._depthStencilTexture?Ae.GetWebGPUTextureFormat(-1,this._currentRenderTarget._depthStencilTexture.format):void 0,this._setDepthTextureFormat(this._rttRenderPassWrapper),this._setColorFormat(this._rttRenderPassWrapper),this._rttRenderPassWrapper.colorAttachmentViewDescriptor={format:this._colorFormat,dimension:W.E2d,mipLevelCount:1,baseArrayLayer:t.isCube?u*6+i:u,baseMipLevel:o,arrayLayerCount:1,aspect:Te.All},this._rttRenderPassWrapper.depthAttachmentViewDescriptor={format:this._depthTextureFormat,dimension:W.E2d,mipLevelCount:1,baseArrayLayer:t.isCube?u*6+i:u,baseMipLevel:0,arrayLayerCount:1,aspect:Te.All},this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - bindFramebuffer called - internalTexture.uniqueId=",(h=t.texture)===null||h===void 0?void 0:h.uniqueId,"face=",i,"lodLevel=",o,"layer=",u,this._rttRenderPassWrapper.colorAttachmentViewDescriptor,this._rttRenderPassWrapper.depthAttachmentViewDescriptor)),this._currentRenderPass=null,this.snapshotRendering&&this.snapshotRenderingMode===1&&this._getCurrentRenderPass(),this._cachedViewport&&!s?this.setViewport(this._cachedViewport,n,a):(n||(n=t.width,o&&(n=n/Math.pow(2,o))),a||(a=t.height,o&&(a=a/Math.pow(2,o))),this._viewport(0,0,n,a)),this.wipeCaches()},e.prototype.unBindFramebuffer=function(t,i,n){var a,s;i===void 0&&(i=!1);var o=this._currentRenderTarget;this._currentRenderTarget=null,n&&n(),this._currentRenderTarget=o,this._currentRenderPass&&this._currentRenderPass!==this._mainRenderPassWrapper.renderPass&&this._endRenderTargetRenderPass(),((a=t.texture)===null||a===void 0?void 0:a.generateMipMaps)&&!i&&!t.isCube&&this._generateMipmaps(t.texture),this._currentRenderTarget=null,this._onAfterUnbindFrameBufferObservable.notifyObservers(this),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - unBindFramebuffer called - internalTexture.uniqueId=",(s=t.texture)===null||s===void 0?void 0:s.uniqueId)),this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments),this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)},e.prototype.restoreDefaultFramebuffer=function(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):(this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)),this._currentRenderPass&&this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()},e.prototype._setColorFormat=function(t){var i,n,a=(n=(i=t.colorAttachmentGPUTextures[0])===null||i===void 0?void 0:i.format)!==null&&n!==void 0?n:null;this._cacheRenderPipeline.setColorFormat(a),this._colorFormat!==a&&(this._colorFormat=a)},e.prototype._setDepthTextureFormat=function(t){this._cacheRenderPipeline.setDepthStencilFormat(t.depthTextureFormat),this._depthTextureFormat!==t.depthTextureFormat&&(this._depthTextureFormat=t.depthTextureFormat)},e.prototype.setDitheringState=function(){},e.prototype.setRasterizerState=function(){},e.prototype.setState=function(t,i,n,a,s,o,u){var l,h;i===void 0&&(i=0),a===void 0&&(a=!1),u===void 0&&(u=0),(this._depthCullingState.cull!==t||n)&&(this._depthCullingState.cull=t);var c=!((h=(l=this.cullBackFaces)!==null&&l!==void 0?l:s)!==null&&h!==void 0)||h?1:2;(this._depthCullingState.cullFace!==c||n)&&(this._depthCullingState.cullFace=c),this.setZOffset(i),this.setZOffsetUnits(u);var _=a?this._currentRenderTarget?1:2:this._currentRenderTarget?2:1;(this._depthCullingState.frontFace!==_||n)&&(this._depthCullingState.frontFace=_),this._stencilStateComposer.stencilMaterial=o},e.prototype._applyRenderPassChanges=function(t,i){var n,a=this._mustUpdateViewport(t),s=this._mustUpdateScissor(t),o=this._stencilStateComposer.enabled?this._mustUpdateStencilRef(t):!1,u=this._alphaState.alphaBlend?this._mustUpdateBlendColor(t):!1;i?(a&&i.addItem(new Ci(this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w)),s&&i.addItem(new ft(this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w)),o&&i.addItem(new _t((n=this._stencilStateComposer.funcRef)!==null&&n!==void 0?n:0)),u&&i.addItem(new xi(this._alphaState._blendConstants.slice()))):(a&&this._applyViewport(t),s&&this._applyScissor(t),o&&this._applyStencilRef(t),u&&this._applyBlendColor(t))},e.prototype._draw=function(t,i,n,a,s){var o,u=this._getCurrentRenderPass(),l=this._getCurrentRenderPassIndex(),h=l===0?this._bundleList:this._bundleListRenderTarget;this.applyStates();var c=this._currentEffect._pipelineContext;if(this.bindUniformBufferBase(this._currentRenderTarget?this._ubInvertY:this._ubDontInvertY,0,te.InternalsUBOName),c.uniformBuffer&&(c.uniformBuffer.update(),this.bindUniformBufferBase(c.uniformBuffer.getBuffer(),0,te.LeftOvertUBOName)),this._snapshotRendering.play){this._reportDrawCall();return}!this.compatibilityMode&&(this._currentDrawContext.isDirty(this._currentMaterialContext.updateId)||this._currentMaterialContext.isDirty||this._currentMaterialContext.forceBindGroupCreation)&&(this._currentDrawContext.fastBundle=void 0);var _=!this.compatibilityMode&&this._currentDrawContext.fastBundle,d=u;if(_||this._snapshotRendering.record){if(this._applyRenderPassChanges(u,h),!this._snapshotRendering.record){this._counters.numBundleReuseNonCompatMode++,this._currentDrawContext.indirectDrawBuffer&&this._currentDrawContext.setIndirectData(a,s||1,n),h.addBundle(this._currentDrawContext.fastBundle),this._reportDrawCall();return}d=h.getBundleEncoder(this._cacheRenderPipeline.colorFormats,this._depthTextureFormat,this.currentSampleCount),h.numDrawCalls++}var g=0;if(!this._caps.textureFloatLinearFiltering&&this._currentMaterialContext.hasFloatTextures)for(var v=1,p=0;p<c.shaderProcessingContext.textureNames.length;++p){var m=c.shaderProcessingContext.textureNames[p],E=(o=this._currentMaterialContext.textures[m])===null||o===void 0?void 0:o.texture;(E==null?void 0:E.type)===1&&(g|=v),v=v<<1}var T=this._cacheRenderPipeline.getRenderPipeline(i,this._currentEffect,this.currentSampleCount,g),R=this._cacheBindGroups.getBindGroups(c,this._currentDrawContext,this._currentMaterialContext);this._snapshotRendering.record||(this._applyRenderPassChanges(u,this.compatibilityMode?null:h),this.compatibilityMode||(this._counters.numBundleCreationNonCompatMode++,d=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:this.currentSampleCount}))),d.setPipeline(T),this._currentIndexBuffer&&d.setIndexBuffer(this._currentIndexBuffer.underlyingResource,this._currentIndexBuffer.is32Bits?Ie.Uint32:Ie.Uint16,0);for(var y=this._cacheRenderPipeline.vertexBuffers,C=0;C<y.length;C++){var b=y[C],x=b.getBuffer();x&&d.setVertexBuffer(C,x.underlyingResource,b._validOffsetRange?0:b.byteOffset)}for(var p=0;p<R.length;p++)d.setBindGroup(p,R[p]);var S=!this.compatibilityMode&&!this._snapshotRendering.record;S&&this._currentDrawContext.indirectDrawBuffer?(this._currentDrawContext.setIndirectData(a,s||1,n),t===0?d.drawIndexedIndirect(this._currentDrawContext.indirectDrawBuffer,0):d.drawIndirect(this._currentDrawContext.indirectDrawBuffer,0)):t===0?d.drawIndexed(a,s||1,n,0,0):d.draw(a,s||1,n,0),S&&(this._currentDrawContext.fastBundle=d.finish(),h.addBundle(this._currentDrawContext.fastBundle)),this._reportDrawCall()},e.prototype.drawElementsType=function(t,i,n,a){a===void 0&&(a=1),this._draw(0,t,i,n,a)},e.prototype.drawArraysType=function(t,i,n,a){a===void 0&&(a=1),this._currentIndexBuffer=null,this._draw(1,t,i,n,a)},e.prototype.dispose=function(){var t,i,n;(t=this._mainTexture)===null||t===void 0||t.destroy(),(i=this._mainTextureLastCopy)===null||i===void 0||i.destroy(),(n=this._depthTexture)===null||n===void 0||n.destroy(),r.prototype.dispose.call(this)},e.prototype.getRenderWidth=function(t){return t===void 0&&(t=!1),!t&&this._currentRenderTarget?this._currentRenderTarget.width:this._canvas.width},e.prototype.getRenderHeight=function(t){return t===void 0&&(t=!1),!t&&this._currentRenderTarget?this._currentRenderTarget.height:this._canvas.height},e.prototype.getRenderingCanvas=function(){return this._canvas},e.prototype.getError=function(){return 0},e.prototype.bindSamplers=function(){},e.prototype._bindTextureDirectly=function(){return!1},e.prototype.areAllEffectsReady=function(){return!0},e.prototype._executeWhenRenderingStateIsCompiled=function(t,i){i()},e.prototype._isRenderingStateCompiled=function(){return!0},e.prototype._getUnpackAlignement=function(){return 1},e.prototype._unpackFlipY=function(){},e.prototype._bindUnboundFramebuffer=function(){throw"_bindUnboundFramebuffer is not implementedin WebGPU! You probably want to use restoreDefaultFramebuffer or unBindFramebuffer instead"},e.prototype._getSamplingParameters=function(){throw"_getSamplingParameters is not available in WebGPU"},e.prototype.getUniforms=function(){return[]},e.prototype.setIntArray=function(){return!1},e.prototype.setIntArray2=function(){return!1},e.prototype.setIntArray3=function(){return!1},e.prototype.setIntArray4=function(){return!1},e.prototype.setArray=function(){return!1},e.prototype.setArray2=function(){return!1},e.prototype.setArray3=function(){return!1},e.prototype.setArray4=function(){return!1},e.prototype.setMatrices=function(){return!1},e.prototype.setMatrix3x3=function(){return!1},e.prototype.setMatrix2x2=function(){return!1},e.prototype.setFloat=function(){return!1},e.prototype.setFloat2=function(){return!1},e.prototype.setFloat3=function(){return!1},e.prototype.setFloat4=function(){return!1},e._GLSLslangDefaultOptions={jsPath:"https://preview.babylonjs.com/glslang/glslang.js",wasmPath:"https://preview.babylonjs.com/glslang/glslang.wasm"},e.UseTWGSL=!0,e}(F);B.prototype.setAlphaMode=function(r,e){if(e===void 0&&(e=!1),!(this._alphaMode===r&&(r===0&&!this._alphaState.alphaBlend||r!==0&&this._alphaState.alphaBlend))){switch(r){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,1),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,1),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(1,1,0,1),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(770,1,0,1),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(0,769,1,1),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(774,0,1,1),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(770,769,1,1),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(32769,32770,32771,32772),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(1,769,1,771),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,1),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(772,1,0,0),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(775,769,773,771),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,0),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(775,769,0,1),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,771),this._alphaState.alphaBlend=!0;break}e||(this.setDepthWrite(r===F.ALPHA_DISABLE),this._cacheRenderPipeline.setDepthWriteEnabled(r===F.ALPHA_DISABLE)),this._alphaMode=r,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)}};B.prototype.setAlphaEquation=function(r){F.prototype.setAlphaEquation.call(this,r),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};var Mi=function(){function r(e,t){this._device=e,this._cacheSampler=t,this.uniqueId=r._Counter++,this._bindGroupEntries=[],this.clear()}return r.prototype.getBindGroups=function(e,t,i){if(!i)throw new Error("WebGPUComputeContext.getBindGroups: bindingsMapping is required until browsers support reflection for wgsl shaders!");if(this._bindGroups.length===0){var n=this._bindGroupEntries.length>0;for(var a in e){var s=e[a],o=i[a],u=o.group,l=o.binding,h=s.type,c=s.object,_=s.indexInGroupEntries,d=this._bindGroupEntries[u];switch(d||(d=this._bindGroupEntries[u]=[]),h){case pe.Sampler:{var g=c;_!==void 0&&n?d[_].resource=this._cacheSampler.getSampler(g):(s.indexInGroupEntries=d.length,d.push({binding:l,resource:this._cacheSampler.getSampler(g)}));break}case pe.Texture:case pe.TextureWithoutSampler:{var v=c,p=v._texture._hardwareTexture;_!==void 0&&n?(h===pe.Texture&&(d[_++].resource=this._cacheSampler.getSampler(v._texture)),d[_].resource=p.view):(s.indexInGroupEntries=d.length,h===pe.Texture&&d.push({binding:l-1,resource:this._cacheSampler.getSampler(v._texture)}),d.push({binding:l,resource:p.view}));break}case pe.StorageTexture:{var v=c,p=v._texture._hardwareTexture;(p.textureAdditionalUsages&X.StorageBinding)===0&&I.Error("computeDispatch: The texture (name=".concat(v.name,", uniqueId=").concat(v.uniqueId,") is not a storage texture!"),50),_!==void 0&&n?d[_].resource=p.viewForWriting:(s.indexInGroupEntries=d.length,d.push({binding:l,resource:p.viewForWriting}));break}case pe.UniformBuffer:case pe.StorageBuffer:{var m=(h===pe.UniformBuffer,c),E=m.getBuffer(),T=E.underlyingResource;_!==void 0&&n?(d[_].resource.buffer=T,d[_].resource.size=E.capacity):(s.indexInGroupEntries=d.length,d.push({binding:l,resource:{buffer:T,offset:0,size:E.capacity}}));break}}}for(var R=0;R<this._bindGroupEntries.length;++R){var d=this._bindGroupEntries[R];if(!d){this._bindGroups[R]=void 0;continue}this._bindGroups[R]=this._device.createBindGroup({layout:t.getBindGroupLayout(R),entries:d})}this._bindGroups.length=this._bindGroupEntries.length}return this._bindGroups},r.prototype.clear=function(){this._bindGroups=[]},r._Counter=0,r}(),Oi=function(){function r(e){this._name="unnamed",this.engine=e}return Object.defineProperty(r.prototype,"isAsync",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isReady",{get:function(){return!!this.stage},enumerable:!1,configurable:!0}),r.prototype._getComputeShaderCode=function(){var e;return(e=this.sources)===null||e===void 0?void 0:e.compute},r.prototype.dispose=function(){},r}();B.prototype.createComputeContext=function(){return new Mi(this._device,this._cacheSampler)};B.prototype.createComputeEffect=function(r,e){var t=r.computeElement||r.compute||r.computeToken||r.computeSource||r,i=t+"@"+e.defines;if(this._compiledComputeEffects[i]){var n=this._compiledComputeEffects[i];return e.onCompiled&&n.isReady()&&e.onCompiled(n),n}var a=new Dr(r,e,this,i);return this._compiledComputeEffects[i]=a,a};B.prototype.createComputePipelineContext=function(){return new Oi(this)};B.prototype.areAllComputeEffectsReady=function(){for(var r in this._compiledComputeEffects){var e=this._compiledComputeEffects[r];if(!e.isReady())return!1}return!0};B.prototype.computeDispatch=function(r,e,t,i,n,a,s){var o=this;if(this._currentRenderTarget){this._onAfterUnbindFrameBufferObservable.addOnce(function(){o.computeDispatch(r,e,t,i,n,a,s)});return}var u=r._pipelineContext,l=e;u.computePipeline||(u.computePipeline=this._device.createComputePipeline({layout:rt.Auto,compute:u.stage}));var h=this._renderTargetEncoder,c=h.beginComputePass();c.setPipeline(u.computePipeline);for(var _=l.getBindGroups(t,u.computePipeline,s),d=0;d<_.length;++d){var g=_[d];!g||c.setBindGroup(d,g)}c.dispatchWorkgroups(i,n,a),c.end()};B.prototype.releaseComputeEffects=function(){for(var r in this._compiledComputeEffects){var e=this._compiledComputeEffects[r].getPipelineContext();this._deleteComputePipelineContext(e)}this._compiledComputeEffects={}};B.prototype._prepareComputePipelineContext=function(r,e,t,i,n){var a=r;this.dbgShowShaderCode&&(console.log(i),console.log(e)),a.sources={compute:e,rawCompute:t},a.stage=this._createComputePipelineStageDescriptor(e,i,n)};B.prototype._releaseComputeEffect=function(r){this._compiledComputeEffects[r._key]&&(delete this._compiledComputeEffects[r._key],this._deleteComputePipelineContext(r.getPipelineContext()))};B.prototype._rebuildComputeEffects=function(){for(var r in this._compiledComputeEffects){var e=this._compiledComputeEffects[r];e._pipelineContext=null,e._wasPreviouslyReady=!1,e._prepareEffect()}};B.prototype._deleteComputePipelineContext=function(r){var e=r;e&&r.dispose()};B.prototype._createComputePipelineStageDescriptor=function(r,e,t){return e?e="//"+e.split(`
`).join(`
//`)+`
`:e="",{module:this._device.createShaderModule({code:e+r}),entryPoint:t}};B.prototype._createDepthStencilCubeTexture=function(r,e){var t=new N(this,L.DepthStencil);t.isCube=!0;var i=se({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1},e);return t.format=i.generateStencil?13:14,this._setupDepthStencilTexture(t,r,i.generateStencil,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(t),this._internalTexturesCache.push(t),t};B.prototype.createCubeTexture=function(r,e,t,i,n,a,s,o,u,l,h,c,_){var d=this;return n===void 0&&(n=null),a===void 0&&(a=null),o===void 0&&(o=null),u===void 0&&(u=!1),l===void 0&&(l=0),h===void 0&&(h=0),c===void 0&&(c=null),_===void 0&&(_=!1),this.createCubeTextureBase(r,e,t,!!i,n,a,s,o,u,l,h,c,null,function(g,v){var p=v,m=p[0].width,E=m;d._setCubeMapTextureParams(g,!i),g.format=s!=null?s:-1;var T=d._textureHelper.createGPUTextureForInternalTexture(g,m,E);d._textureHelper.updateCubeTextures(p,T.underlyingResource,m,E,T.format,!1,!1,0,0),i||d._generateMipmaps(g,d._uploadEncoder),g.isReady=!0,g.onLoadedObservable.notifyObservers(g),g.onLoadedObservable.clear(),n&&n()},!!_)};B.prototype._setCubeMapTextureParams=function(r,e,t){r.samplingMode=e?3:2,r._cachedWrapU=0,r._cachedWrapV=0,t&&(r._maxLodLevel=t)};B.prototype._debugPushGroup=function(r,e){if(!!this._options.enableGPUDebugMarkers)if(e===0||e===1){var t=e===0?this._renderEncoder:this._renderTargetEncoder;t.pushDebugGroup(r)}else this._currentRenderPass?this._currentRenderPass.pushDebugGroup(r):this._pendingDebugCommands.push(["push",r])};B.prototype._debugPopGroup=function(r){if(!!this._options.enableGPUDebugMarkers)if(r===0||r===1){var e=r===0?this._renderEncoder:this._renderTargetEncoder;e.popDebugGroup()}else this._currentRenderPass?this._currentRenderPass.popDebugGroup():this._pendingDebugCommands.push(["pop",null])};B.prototype._debugInsertMarker=function(r,e){if(!!this._options.enableGPUDebugMarkers)if(e===0||e===1){var t=e===0?this._renderEncoder:this._renderTargetEncoder;t.insertDebugMarker(r)}else this._currentRenderPass?this._currentRenderPass.insertDebugMarker(r):this._pendingDebugCommands.push(["insert",r])};B.prototype._debugFlushPendingCommands=function(){for(var r=0;r<this._pendingDebugCommands.length;++r){var e=this._pendingDebugCommands[r],t=e[0],i=e[1];switch(t){case"push":this._debugPushGroup(i);break;case"pop":this._debugPopGroup();break;case"insert":this._debugInsertMarker(i);break}}this._pendingDebugCommands.length=0};B.prototype.updateDynamicIndexBuffer=function(r,e,t){t===void 0&&(t=0);var i=r,n;r.is32Bits?n=e instanceof Uint32Array?e:new Uint32Array(e):n=e instanceof Uint16Array?e:new Uint16Array(e),this._bufferManager.setSubData(i,t,n)};B.prototype.updateDynamicVertexBuffer=function(r,e,t,i){var n=r;t===void 0&&(t=0);var a;i===void 0?(e instanceof Array?a=new Float32Array(e):e instanceof ArrayBuffer?a=new Uint8Array(e):a=e,i=a.byteLength):e instanceof Array?a=new Float32Array(e):e instanceof ArrayBuffer?a=new Uint8Array(e):a=e,this._bufferManager.setSubData(n,t,a,0,i)};B.prototype.updateDynamicTexture=function(r,e,t,i,n,a,s){var o;if(i===void 0&&(i=!1),!!r){var u=e.width,l=e.height,h=r._hardwareTexture;!((o=r._hardwareTexture)===null||o===void 0)&&o.underlyingResource||(h=this._textureHelper.createGPUTextureForInternalTexture(r,u,l)),this._textureHelper.updateTexture(e,r,u,l,r.depth,h.format,0,0,t,i,0,0,s),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder),r.isReady=!0}};var Gi=function(r){J(e,r);function e(t){return r.call(this,t)||this}return e}(Kt);Ee.prototype.setExternalTexture=function(r,e){this._engine.setExternalTexture(r,e)};B.prototype.createExternalTexture=function(r){var e=new Gi(r);return e};B.prototype.setExternalTexture=function(r,e){if(!e){this._currentMaterialContext.setTexture(r,null);return}this._setInternalTexture(r,e)};B.prototype.unBindMultiColorAttachmentFramebuffer=function(r,e,t){e===void 0&&(e=!1),t&&t();var i=r._attachments,n=i.length;this._currentRenderPass&&this._currentRenderPass!==this._mainRenderPassWrapper.renderPass&&this._endRenderTargetRenderPass();for(var a=0;a<n;a++){var s=r.textures[a];s.generateMipMaps&&!e&&!s.isCube&&this._generateMipmaps(s)}this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments),this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)};B.prototype.createMultipleRenderTarget=function(r,e,t){var i,n=!1,a=!0,s=!1,o=!1,u=15,l=1,h=0,c=3,_=!1,d=new Array,g=new Array,v=new Array,p=this._createHardwareRenderTargetWrapper(!0,!1,r);e!==void 0&&(n=e.generateMipMaps===void 0?!1:e.generateMipMaps,a=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,s=e.generateStencilBuffer===void 0?!1:e.generateStencilBuffer,o=e.generateDepthTexture===void 0?!1:e.generateDepthTexture,l=e.textureCount||1,u=(i=e.depthTextureFormat)!==null&&i!==void 0?i:15,e.types&&(d=e.types),e.samplingModes&&(g=e.samplingModes),e.useSRGBBuffers&&(v=e.useSRGBBuffers));var m=r.width||r,E=r.height||r,T=null;(a||s||o)&&(T=p.createDepthStencilTexture(0,!1,s,1,u));var R=[],y=[],C=[];p._generateDepthBuffer=a,p._generateStencilBuffer=s,p._attachments=y,p._defaultAttachments=C;for(var b=0;b<l;b++){var x=g[b]||c,S=d[b]||h,w=v[b]||_;(S===1&&!this._caps.textureFloatLinearFiltering||S===2&&!this._caps.textureHalfFloatLinearFiltering)&&(x=1),S===1&&!this._caps.textureFloat&&(S=0,I.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));var A=new N(this,L.MultiRenderTarget);R.push(A),y.push(b+1),C.push(t?b+1:b===0?1:0),A.baseWidth=m,A.baseHeight=E,A.width=m,A.height=E,A.isReady=!0,A.samples=1,A.generateMipMaps=n,A.samplingMode=x,A.type=S,A._cachedWrapU=0,A._cachedWrapV=0,A._useSRGBBuffer=w,this._internalTexturesCache.push(A),this._textureHelper.createGPUTextureForInternalTexture(A)}return T&&(T.incrementReferences(),R.push(T),this._internalTexturesCache.push(T)),p.setTextures(R),p};B.prototype.updateMultipleRenderTargetTextureSampleCount=function(r,e){if(!r||!r.textures||r.textures[0].samples===e)return e;var t=r.textures.length;if(t===0)return 1;e=Math.min(e,this.getCaps().maxMSAASamples);for(var i=0;i<t;++i){var n=r.textures[i];this._textureHelper.createMSAATexture(n,e),n.samples=e}return r._depthStencilTexture&&r._depthStencilTexture!==r.textures[r.textures.length-1]&&(this._textureHelper.createMSAATexture(r._depthStencilTexture,e),r._depthStencilTexture.samples=e),e};B.prototype.bindAttachments=function(r){r.length===0||!this._currentRenderTarget||(this._mrtAttachments=r,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(r))};B.prototype.buildTextureLayout=function(r){for(var e=[],t=0;t<r.length;t++)r[t]?e.push(t+1):e.push(0);return e};B.prototype.restoreSingleAttachment=function(){};B.prototype.restoreSingleAttachmentForRenderTarget=function(){};B.prototype.getGPUFrameTimeCounter=function(){return this._timestampQuery.gpuFrameTimeCounter};B.prototype.captureGPUFrameTime=function(r){this._timestampQuery.enable=r&&!!this._caps.timerQuery};B.prototype.createQuery=function(){return this._occlusionQuery.createQuery()};B.prototype.deleteQuery=function(r){return this._occlusionQuery.deleteQuery(r),this};B.prototype.isQueryResultAvailable=function(r){return this._occlusionQuery.isQueryResultAvailable(r)};B.prototype.getQueryResult=function(r){return this._occlusionQuery.getQueryResult(r)};B.prototype.beginOcclusionQuery=function(r,e){var t;if(this.compatibilityMode){if(this._occlusionQuery.canBeginQuery)return(t=this._currentRenderPass)===null||t===void 0||t.beginOcclusionQuery(e),!0}else{var i=this._getCurrentRenderPassIndex(),n=i===0?this._bundleList:this._bundleListRenderTarget;return n.addItem(new Pi(e)),!0}return!1};B.prototype.endOcclusionQuery=function(){var r;if(this.compatibilityMode)(r=this._currentRenderPass)===null||r===void 0||r.endOcclusionQuery();else{var e=this._getCurrentRenderPassIndex(),t=e===0?this._bundleList:this._bundleListRenderTarget;t.addItem(new Bi)}return this};B.prototype.createRawTexture=function(r,e,t,i,n,a,s,o,u,l,h){o===void 0&&(o=null),u===void 0&&(u=0),l===void 0&&(l=0),h===void 0&&(h=!1);var c=new N(this,L.Raw);return c.baseWidth=e,c.baseHeight=t,c.width=e,c.height=t,c.format=i,c.generateMipMaps=n,c.samplingMode=s,c.invertY=a,c._compression=o,c.type=u,c._useSRGBBuffer=h,this._doNotHandleContextLost||(c._bufferView=r),this._textureHelper.createGPUTextureForInternalTexture(c,e,t,void 0,l),this.updateRawTexture(c,r,i,a,o,u,h),this._internalTexturesCache.push(c),c};B.prototype.updateRawTexture=function(r,e,t,i,n,a,s){if(n===void 0&&(n=null),a===void 0&&(a=0),s===void 0&&(s=!1),!!r){if(this._doNotHandleContextLost||(r._bufferView=e,r.invertY=i,r._compression=n,r._useSRGBBuffer=s),e){var o=r._hardwareTexture,u=t===4;u&&(e=ke(e,r.width,r.height,a));var l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,r,r.width,r.height,r.depth,o.format,0,0,i,!1,0,0),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder)}r.isReady=!0}};B.prototype.createRawCubeTexture=function(r,e,t,i,n,a,s,o){o===void 0&&(o=null);var u=new N(this,L.CubeRaw);return i===1&&!this._caps.textureFloatLinearFiltering?(n=!1,s=1,I.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):i===2&&!this._caps.textureHalfFloatLinearFiltering?(n=!1,s=1,I.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):i===1&&!this._caps.textureFloatRender?(n=!1,I.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):i===2&&!this._caps.colorBufferFloat&&(n=!1,I.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")),u.isCube=!0,u.format=t===4?5:t,u.type=i,u.generateMipMaps=n,u.width=e,u.height=e,u.samplingMode=s,this._doNotHandleContextLost||(u._bufferViewArray=r),u._cachedWrapU=0,u._cachedWrapV=0,this._textureHelper.createGPUTextureForInternalTexture(u),r&&this.updateRawCubeTexture(u,r,t,i,a,o),u};B.prototype.updateRawCubeTexture=function(r,e,t,i,n,a){a===void 0&&(a=null),r._bufferViewArray=e,r.invertY=n,r._compression=a;for(var s=r._hardwareTexture,o=t===4,u=[],l=0;l<e.length;++l){var h=e[l];o&&(h=ke(e[l],r.width,r.height,i)),u.push(new Uint8Array(h.buffer,h.byteOffset,h.byteLength))}this._textureHelper.updateCubeTextures(u,s.underlyingResource,r.width,r.height,s.format,n,!1,0,0),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder),r.isReady=!0};B.prototype.createRawCubeTextureFromUrl=function(r,e,t,i,n,a,s,o,u,l,h,c){var _=this;u===void 0&&(u=null),l===void 0&&(l=null),h===void 0&&(h=3),c===void 0&&(c=!1);var d=this.createRawCubeTexture(null,t,i,n,!a,c,h,null);e==null||e.addPendingData(d),d.url=r,this._internalTexturesCache.push(d);var g=function(p,m){e==null||e.removePendingData(d),l&&p&&l(p.status+" "+p.statusText,m)},v=function(p){var m=d.width,E=s(p);if(!!E){var T=[0,2,4,1,3,5];if(o)for(var R=i===4,y=o(E),C=d._hardwareTexture,b=[0,1,2,3,4,5],x=0;x<y.length;x++){for(var S=m>>x,w=[],A=0;A<6;A++){var U=y[x][b[A]];R&&(U=ke(U,S,S,n)),w.push(new Uint8Array(U.buffer,U.byteOffset,U.byteLength))}_._textureHelper.updateCubeTextures(w,C.underlyingResource,S,S,C.format,c,!1,0,0)}else{for(var w=[],A=0;A<6;A++)w.push(E[T[A]]);_.updateRawCubeTexture(d,w,i,n,c)}d.isReady=!0,e==null||e.removePendingData(d),u&&u()}};return this._loadFile(r,function(p){v(p)},void 0,e==null?void 0:e.offlineProvider,!0,g),d};B.prototype.createRawTexture3D=function(r,e,t,i,n,a,s,o,u,l,h){u===void 0&&(u=null),l===void 0&&(l=0),h===void 0&&(h=0);var c=L.Raw3D,_=new N(this,c);return _.baseWidth=e,_.baseHeight=t,_.baseDepth=i,_.width=e,_.height=t,_.depth=i,_.format=n,_.type=l,_.generateMipMaps=a,_.samplingMode=o,_.is3D=!0,this._doNotHandleContextLost||(_._bufferView=r),this._textureHelper.createGPUTextureForInternalTexture(_,e,t,void 0,h),this.updateRawTexture3D(_,r,n,s,u,l),this._internalTexturesCache.push(_),_};B.prototype.updateRawTexture3D=function(r,e,t,i,n,a){if(n===void 0&&(n=null),a===void 0&&(a=0),this._doNotHandleContextLost||(r._bufferView=e,r.format=t,r.invertY=i,r._compression=n),e){var s=r._hardwareTexture,o=t===4;o&&(e=ke(e,r.width,r.height,a));var u=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(u,r,r.width,r.height,r.depth,s.format,0,0,i,!1,0,0),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder)}r.isReady=!0};B.prototype.createRawTexture2DArray=function(r,e,t,i,n,a,s,o,u,l,h){u===void 0&&(u=null),l===void 0&&(l=0),h===void 0&&(h=0);var c=L.Raw2DArray,_=new N(this,c);return _.baseWidth=e,_.baseHeight=t,_.baseDepth=i,_.width=e,_.height=t,_.depth=i,_.format=n,_.type=l,_.generateMipMaps=a,_.samplingMode=o,_.is2DArray=!0,this._doNotHandleContextLost||(_._bufferView=r),this._textureHelper.createGPUTextureForInternalTexture(_,e,t,i,h),this.updateRawTexture2DArray(_,r,n,s,u,l),this._internalTexturesCache.push(_),_};B.prototype.updateRawTexture2DArray=function(r,e,t,i,n,a){if(n===void 0&&(n=null),a===void 0&&(a=0),this._doNotHandleContextLost||(r._bufferView=e,r.format=t,r.invertY=i,r._compression=n),e){var s=r._hardwareTexture,o=t===4;o&&(e=ke(e,r.width,r.height,a));var u=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(u,r,r.width,r.height,r.depth,s.format,0,0,i,!1,0,0),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder)}r.isReady=!0};function ke(r,e,t,i){var n,a=1;i===1?n=new Float32Array(e*t*4):i===2?(n=new Uint16Array(e*t*4),a=15360):i===7?n=new Uint32Array(e*t*4):n=new Uint8Array(e*t*4);for(var s=0;s<e;s++)for(var o=0;o<t;o++){var u=(o*e+s)*3,l=(o*e+s)*4;n[l+0]=r[u+0],n[l+1]=r[u+1],n[l+2]=r[u+2],n[l+3]=a}return n}B.prototype._readTexturePixels=function(r,e,t,i,n,a,s,o,u,l){i===void 0&&(i=-1),n===void 0&&(n=0),a===void 0&&(a=null),s===void 0&&(s=!0),o===void 0&&(o=!1),u===void 0&&(u=0),l===void 0&&(l=0);var h=r._hardwareTexture;return s&&this.flushFramebuffer(),this._textureHelper.readPixels(h.underlyingResource,u,l,e,t,h.format,i,n,a,o)};B.prototype._readTexturePixelsSync=function(){throw"_readTexturePixelsSync is unsupported in WebGPU!"};var Ni=function(r){J(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(ot);B.prototype._createHardwareRenderTargetWrapper=function(r,e,t){var i=new Ni(r,e,t,this);return this._renderTargetWrapperCache.push(i),i};B.prototype.createRenderTargetTexture=function(r,e){var t,i=this._createHardwareRenderTargetWrapper(!1,!1,r),n={};e!==void 0&&typeof e=="object"?(n.generateMipMaps=e.generateMipMaps,n.generateDepthBuffer=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,n.generateStencilBuffer=n.generateDepthBuffer&&e.generateStencilBuffer,n.samplingMode=e.samplingMode===void 0?3:e.samplingMode,n.creationFlags=(t=e.creationFlags)!==null&&t!==void 0?t:0,n.noColorTarget=!!e.noColorTarget):(n.generateMipMaps=e,n.generateDepthBuffer=!0,n.generateStencilBuffer=!1,n.samplingMode=3,n.creationFlags=0,n.noColorTarget=!1);var a=n.noColorTarget?null:this._createInternalTexture(r,e,!0,L.RenderTarget);return i._generateDepthBuffer=n.generateDepthBuffer,i._generateStencilBuffer=!!n.generateStencilBuffer,i.setTextures(a),(i._generateDepthBuffer||i._generateStencilBuffer)&&i.createDepthStencilTexture(0,n.samplingMode===void 0||n.samplingMode===2||n.samplingMode===2||n.samplingMode===3||n.samplingMode===3||n.samplingMode===5||n.samplingMode===6||n.samplingMode===7||n.samplingMode===11,i._generateStencilBuffer,i.samples),a&&(e!==void 0&&typeof e=="object"&&e.createMipMaps&&!n.generateMipMaps&&(a.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(a,void 0,void 0,void 0,n.creationFlags),e!==void 0&&typeof e=="object"&&e.createMipMaps&&!n.generateMipMaps&&(a.generateMipMaps=!1)),i};B.prototype._createDepthStencilTexture=function(r,e){var t=new N(this,L.DepthStencil),i=se({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:e.generateStencil?13:14},e);return t.format=i.depthTextureFormat,this._setupDepthStencilTexture(t,r,i.generateStencil,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(t),this._internalTexturesCache.push(t),t};B.prototype._setupDepthStencilTexture=function(r,e,t,i,n,a){a===void 0&&(a=1);var s=e.width||e,o=e.height||e,u=e.layers||0;r.baseWidth=s,r.baseHeight=o,r.width=s,r.height=o,r.is2DArray=u>0,r.depth=u,r.isReady=!0,r.samples=a,r.generateMipMaps=!1,r.samplingMode=i?2:1,r.type=1,r._comparisonFunction=n,r._cachedWrapU=0,r._cachedWrapV=0};B.prototype.updateRenderTargetTextureSampleCount=function(r,e){return!r||!r.texture||r.samples===e||(e=Math.min(e,this.getCaps().maxMSAASamples),this._textureHelper.createMSAATexture(r.texture,e),r._depthStencilTexture&&(this._textureHelper.createMSAATexture(r._depthStencilTexture,e),r._depthStencilTexture.samples=e),r.texture.samples=e),e};B.prototype.createRenderTargetCubeTexture=function(r,e){var t=this._createHardwareRenderTargetWrapper(!1,!0,r),i=se({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1},e);i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer;var n=new N(this,L.RenderTarget);return n.width=r,n.height=r,n.depth=0,n.isReady=!0,n.isCube=!0,n.samples=i.samples,n.generateMipMaps=i.generateMipMaps,n.samplingMode=i.samplingMode,n.type=i.type,n.format=i.format,this._internalTexturesCache.push(n),t.setTextures(n),(t._generateDepthBuffer||t._generateStencilBuffer)&&t.createDepthStencilTexture(0,i.samplingMode===void 0||i.samplingMode===2||i.samplingMode===2||i.samplingMode===3||i.samplingMode===3||i.samplingMode===5||i.samplingMode===6||i.samplingMode===7||i.samplingMode===11,t._generateStencilBuffer,t.samples),e&&e.createMipMaps&&!i.generateMipMaps&&(n.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(n),e&&e.createMipMaps&&!i.generateMipMaps&&(n.generateMipMaps=!1),t};Ee.prototype.setTextureSampler=function(r,e){this._engine.setTextureSampler(r,e)};B.prototype.setTextureSampler=function(r,e){var t;(t=this._currentMaterialContext)===null||t===void 0||t.setSampler(r,e)};Ee.prototype.setStorageBuffer=function(r,e){this._engine.setStorageBuffer(r,e)};B.prototype.createStorageBuffer=function(r,e){return this._createBuffer(r,e|32)};B.prototype.updateStorageBuffer=function(r,e,t,i){var n=r;t===void 0&&(t=0);var a;i===void 0?(e instanceof Array?a=new Float32Array(e):e instanceof ArrayBuffer?a=new Uint8Array(e):a=e,i=a.byteLength):e instanceof Array?a=new Float32Array(e):e instanceof ArrayBuffer?a=new Uint8Array(e):a=e,this._bufferManager.setSubData(n,t,a,0,i)};B.prototype.readFromStorageBuffer=function(r,e,t,i){var n=this;t=t||r.capacity;var a=this._bufferManager.createRawBuffer(t,V.MapRead|V.CopyDst);return this._renderTargetEncoder.copyBufferToBuffer(r.underlyingResource,e!=null?e:0,a,0,t),new Promise(function(s,o){n.onEndFrameObservable.addOnce(function(){a.mapAsync(Ue.Read,0,t).then(function(){var u=a.getMappedRange(0,t),l=i;if(l===void 0)l=new Uint8Array(t),l.set(new Uint8Array(u));else{var h=l.constructor;l=new h(l.buffer),l.set(new h(u))}a.unmap(),n._bufferManager.releaseBuffer(a),s(l)},function(u){return o(u)})})})};B.prototype.setStorageBuffer=function(r,e){var t,i;(t=this._currentDrawContext)===null||t===void 0||t.setBuffer(r,(i=e==null?void 0:e.getBuffer())!==null&&i!==void 0?i:null)};B.prototype.createUniformBuffer=function(r){var e;r instanceof Array?e=new Float32Array(r):e=r;var t=this._bufferManager.createBuffer(e,V.Uniform|V.CopyDst);return t};B.prototype.createDynamicUniformBuffer=function(r){return this.createUniformBuffer(r)};B.prototype.updateUniformBuffer=function(r,e,t,i){t===void 0&&(t=0);var n=r,a;i===void 0?(e instanceof Float32Array?a=e:a=new Float32Array(e),i=a.byteLength):e instanceof Float32Array?a=e:a=new Float32Array(e),this._bufferManager.setSubData(n,t,a,0,i)};B.prototype.bindUniformBufferBase=function(r,e,t){this._currentDrawContext.setBuffer(t,r)};B.prototype.bindUniformBlock=function(){};B.prototype.updateVideoTexture=function(r,e,t){var i=this,n;if(!(!r||r._isDisabled)){this._videoTextureSupported===void 0&&(this._videoTextureSupported=!0);var a=r._hardwareTexture;!((n=r._hardwareTexture)===null||n===void 0)&&n.underlyingResource||(a=this._textureHelper.createGPUTextureForInternalTexture(r)),this.createImageBitmap(e).then(function(s){i._textureHelper.updateTexture(s,r,r.width,r.height,r.depth,a.format,0,0,!t,!1,0,0),r.generateMipMaps&&i._generateMipmaps(r,i._uploadEncoder),r.isReady=!0}).catch(function(){r.isReady=!0})}};export{pe as C,Re as E,Rt as P,rn as R,en as S,P as T,yt as W,F as a,$i as b,tn as c};
