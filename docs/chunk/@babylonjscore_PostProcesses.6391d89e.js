import{a as d,_ as y}from"./tslibtslib.b6e59fa7.js";import"./@babylonjscore_Shaders.02c89b72.js";import{f as ee,S as O,G as fe,b as p,B as de,R as A,O as V,h as pe,a as N,L,a3 as ge,s as U,d as _e,g as Pe}from"./@babylonjscore_Misc.5aaba58d.js";import{V as R,j as me,M as I,a as D,T as ie,d as ve,c as be,C as Se,f as Ee,b as ye}from"./@babylonjscore_Maths.4b8bfdd1.js";import{d as Oe,b as _,I as k,D as Q,l as Re,k as Ae,S as xe,M as Ce}from"./@babylonjscore_Materials.d4538583.js";import{a as K,E as X}from"./@babylonjscore_Engines.77a493e8.js";import{G as Y,M as Te,S as Me,a as Fe}from"./@babylonjscore_Rendering.1459be29.js";import"./@babylonjscore_Animations.f48af9b8.js";import{V as F}from"./@babylonjscore_Buffers.c351261b.js";import{G as Be}from"./@babylonjscore_Layers.2238d076.js";import{S as J}from"./@babylonjscore_sceneComponent.5f0854c6.js";import{S as we}from"./@babylonjscore_scene.c0faa314.js";import{C as Le}from"./@babylonjscore_Cameras.05e2a1ea.js";import{C as Ie,A as De}from"./@babylonjscore_Meshes.9ddea1c8.js";var dt=function(){function l(t){this._vertexBuffers={},this._scene=t}return l.prototype._prepareBuffers=function(){if(!this._vertexBuffers[F.PositionKind]){var t=[];t.push(1,1),t.push(-1,1),t.push(-1,-1),t.push(1,-1),this._vertexBuffers[F.PositionKind]=new F(this._scene.getEngine(),t,F.PositionKind,!1,!1,2),this._buildIndexBuffer()}},l.prototype._buildIndexBuffer=function(){var t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(t)},l.prototype._rebuild=function(){var t=this._vertexBuffers[F.PositionKind];!t||(t._rebuild(),this._buildIndexBuffer())},l.prototype._prepareFrame=function(t,e){t===void 0&&(t=null),e===void 0&&(e=null);var i=this._scene.activeCamera;return!i||(e=e||i._postProcesses.filter(function(r){return r!=null}),!e||e.length===0||!this._scene.postProcessesEnabled)?!1:(e[0].activate(i,t,e!=null),!0)},l.prototype.directRender=function(t,e,i,r,n,a){var s;e===void 0&&(e=null),i===void 0&&(i=!1),r===void 0&&(r=0),n===void 0&&(n=0),a===void 0&&(a=!1);for(var o=this._scene.getEngine(),u=0;u<t.length;u++){u<t.length-1?t[u+1].activate(this._scene.activeCamera,e==null?void 0:e.texture):(e?o.bindFramebuffer(e,r,void 0,void 0,i,n):a||o.restoreDefaultFramebuffer(),(s=o._debugInsertMarker)===null||s===void 0||s.call(o,"post process ".concat(t[u].name," output")));var c=t[u],h=c.apply();h&&(c.onBeforeRenderObservable.notifyObservers(h),this._prepareBuffers(),o.bindBuffers(this._vertexBuffers,this._indexBuffer,h),o.drawElementsType(0,0,6),c.onAfterRenderObservable.notifyObservers(h))}o.setDepthBuffer(!0),o.setDepthWrite(!0)},l.prototype._finalizeFrame=function(t,e,i,r,n){var a;n===void 0&&(n=!1);var s=this._scene.activeCamera;if(!!s&&(r=r||s._postProcesses.filter(function(g){return g!=null}),!(r.length===0||!this._scene.postProcessesEnabled))){for(var o=this._scene.getEngine(),u=0,c=r.length;u<c;u++){var h=r[u];if(u<c-1?h._outputTexture=r[u+1].activate(s,e==null?void 0:e.texture):(e?(o.bindFramebuffer(e,i,void 0,void 0,n),h._outputTexture=e):(o.restoreDefaultFramebuffer(),h._outputTexture=null),(a=o._debugInsertMarker)===null||a===void 0||a.call(o,"post process ".concat(r[u].name," output"))),t)break;var f=h.apply();f&&(h.onBeforeRenderObservable.notifyObservers(f),this._prepareBuffers(),o.bindBuffers(this._vertexBuffers,this._indexBuffer,f),o.drawElementsType(0,0,6),h.onAfterRenderObservable.notifyObservers(f))}o.setDepthBuffer(!0),o.setDepthWrite(!0),o.setAlphaMode(0)}},l.prototype.dispose=function(){var t=this._vertexBuffers[F.PositionKind];t&&(t.dispose(),this._vertexBuffers[F.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)},l}(),v=function(){function l(t,e,i,r,n,a,s,o,u,c,h,f,g,m,P){s===void 0&&(s=1),c===void 0&&(c=null),h===void 0&&(h=0),f===void 0&&(f="postprocess"),m===void 0&&(m=!1),P===void 0&&(P=5),this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.alphaMode=0,this.animations=new Array,this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new ee(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new R(1,1),this._texelSize=R.Zero(),this.onActivateObservable=new V,this.onSizeChangedObservable=new V,this.onApplyObservable=new V,this.onBeforeRenderObservable=new V,this.onAfterRenderObservable=new V,this.name=t,a!=null?(this._camera=a,this._scene=a.getScene(),a.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):o&&(this._engine=o,this._engine.postProcesses.push(this)),this._options=n,this.renderTargetSamplingMode=s||1,this._reusable=u||!1,this._textureType=h,this._textureFormat=P,this._samplers=r||[],this._samplers.push("textureSampler"),this._fragmentUrl=e,this._vertexUrl=f,this._parameters=i||[],this._parameters.push("scale"),this._indexParameters=g,this._drawWrapper=new Oe(this._engine),m||this.updateEffect(c)}return Object.defineProperty(l.prototype,"samples",{get:function(){return this._samples},set:function(t){var e=this;this._samples=Math.min(t,this._engine.getCaps().maxMSAASamples),this._textures.forEach(function(i){i.samples!==e._samples&&e._engine.updateRenderTargetTextureSampleCount(i,e._samples)})},enumerable:!1,configurable:!0}),l.prototype.getEffectName=function(){return this._fragmentUrl},Object.defineProperty(l.prototype,"onActivate",{set:function(t){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),t&&(this._onActivateObserver=this.onActivateObservable.add(t))},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"onSizeChanged",{set:function(t){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"onApply",{set:function(t){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"onBeforeRender",{set:function(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"onAfterRender",{set:function(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"inputTexture",{get:function(){return this._textures.data[this._currentRenderTextureInd]},set:function(t){this._forcedOutputTexture=t},enumerable:!1,configurable:!0}),l.prototype.restoreDefaultInputTexture=function(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())},l.prototype.getCamera=function(){return this._camera},Object.defineProperty(l.prototype,"texelSize",{get:function(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)},enumerable:!1,configurable:!0}),l.prototype.getClassName=function(){return"PostProcess"},l.prototype.getEngine=function(){return this._engine},l.prototype.getEffect=function(){return this._drawWrapper.effect},l.prototype.shareOutputWith=function(t){return this._disposeTextures(),this._shareOutputWithPostProcess=t,this},l.prototype.useOwnOutput=function(){this._textures.length==0&&(this._textures=new ee(2)),this._shareOutputWithPostProcess=null},l.prototype.updateEffect=function(t,e,i,r,n,a,s,o){t===void 0&&(t=null),e===void 0&&(e=null),i===void 0&&(i=null),this._postProcessDefines=t,this._drawWrapper.effect=this._engine.createEffect({vertex:s!=null?s:this._vertexUrl,fragment:o!=null?o:this._fragmentUrl},["position"],e||this._parameters,i||this._samplers,t!==null?t:"",void 0,n,a,r||this._indexParameters)},l.prototype.isReusable=function(){return this._reusable},l.prototype.markTextureDirty=function(){this.width=-1},l.prototype._createRenderTargetTexture=function(t,e,i){i===void 0&&(i=0);for(var r=0;r<this._textureCache.length;r++)if(this._textureCache[r].texture.width===t.width&&this._textureCache[r].texture.height===t.height&&this._textureCache[r].postProcessChannel===i&&this._textureCache[r].texture._generateDepthBuffer===e.generateDepthBuffer)return this._textureCache[r].texture;var n=this._engine.createRenderTargetTexture(t,e);return this._textureCache.push({texture:n,postProcessChannel:i,lastUsedRenderId:-1}),n},l.prototype._flushTextureCache=function(){for(var t=this._renderId,e=this._textureCache.length-1;e>=0;e--)if(t-this._textureCache[e].lastUsedRenderId>100){for(var i=!1,r=0;r<this._textures.length;r++)if(this._textures.data[r]===this._textureCache[e].texture){i=!0;break}i||(this._textureCache[e].texture.dispose(),this._textureCache.splice(e,1))}},l.prototype._resize=function(t,e,i,r,n){this._textures.length>0&&this._textures.reset(),this.width=t,this.height=e;for(var a=null,s=0;s<i._postProcesses.length;s++)if(i._postProcesses[s]!==null){a=i._postProcesses[s];break}var o={width:this.width,height:this.height},u={generateMipMaps:r,generateDepthBuffer:n||a===this,generateStencilBuffer:(n||a===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat};this._textures.push(this._createRenderTargetTexture(o,u,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(o,u,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)},l.prototype.activate=function(t,e,i){var r=this,n,a;e===void 0&&(e=null),t=t||this._camera;var s=t.getScene(),o=s.getEngine(),u=o.getCaps().maxTextureSize,c=(e?e.width:this._engine.getRenderWidth(!0))*this._options|0,h=(e?e.height:this._engine.getRenderHeight(!0))*this._options|0,f=t.parent;f&&(f.leftCamera==t||f.rightCamera==t)&&(c/=2);var g=this._options.width||c,m=this._options.height||h,P=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){var S=o.currentViewport;S&&(g*=S.width,m*=S.height)}(P||this.alwaysForcePOT)&&(this._options.width||(g=o.needPOTTextures?K.GetExponentOfTwo(g,u,this.scaleMode):g),this._options.height||(m=o.needPOTTextures?K.GetExponentOfTwo(m,u,this.scaleMode):m)),(this.width!==g||this.height!==m)&&this._resize(g,m,t,P,i),this._textures.forEach(function(T){T.samples!==r.samples&&r._engine.updateRenderTargetTextureSampleCount(T,r.samples)}),this._flushTextureCache(),this._renderId++}var E;if(this._shareOutputWithPostProcess)E=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)E=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{E=this.inputTexture;for(var C=void 0,x=0;x<this._textureCache.length;x++)if(this._textureCache[x].texture===E){C=this._textureCache[x];break}C&&(C.lastUsedRenderId=this._renderId)}return this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(c/g,h/m),this._engine.bindFramebuffer(E,0,c,h,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(E,0,void 0,void 0,this.forceFullscreenViewport)),(a=(n=this._engine)._debugInsertMarker)===null||a===void 0||a.call(n,"post process ".concat(this.name," input")),this.onActivateObservable.notifyObservers(t),this.autoClear&&this.alphaMode===0&&this._engine.clear(this.clearColor?this.clearColor:s.clearColor,s._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),E},Object.defineProperty(l.prototype,"isSupported",{get:function(){return this._drawWrapper.effect.isSupported},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"aspectRatio",{get:function(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height},enumerable:!1,configurable:!0}),l.prototype.isReady=function(){var t,e;return(e=(t=this._drawWrapper.effect)===null||t===void 0?void 0:t.isReady())!==null&&e!==void 0?e:!1},l.prototype.apply=function(){var t;if(!(!((t=this._drawWrapper.effect)===null||t===void 0)&&t.isReady()))return null;this._engine.enableEffect(this._drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a);var e;return this._shareOutputWithPostProcess?e=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?e=this._forcedOutputTexture:e=this.inputTexture,this.externalTextureSamplerBinding||this._drawWrapper.effect._bindTexture("textureSampler",e==null?void 0:e.texture),this._drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._drawWrapper.effect),this._drawWrapper.effect},l.prototype._disposeTextures=function(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()},l.prototype._disposeTextureCache=function(){for(var t=this._textureCache.length-1;t>=0;t--)this._textureCache[t].texture.dispose();this._textureCache.length=0},l.prototype.setPrePassRenderer=function(t){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=t.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1},l.prototype.dispose=function(t){t=t||this._camera,this._disposeTextures();var e;if(this._scene&&(e=this._scene.postProcesses.indexOf(this),e!==-1&&this._scene.postProcesses.splice(e,1)),this._parentContainer){var i=this._parentContainer.postProcesses.indexOf(this);i>-1&&this._parentContainer.postProcesses.splice(i,1),this._parentContainer=null}if(e=this._engine.postProcesses.indexOf(this),e!==-1&&this._engine.postProcesses.splice(e,1),!!t){if(t.detachPostProcess(this),e=t._postProcesses.indexOf(this),e===0&&t._postProcesses.length>0){var r=this._camera._getFirstPostProcess();r&&r.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}},l.prototype.serialize=function(){var t=O.Serialize(this),e=this.getCamera()||this._scene&&this._scene.activeCamera;return t.customType="BABYLON."+this.getClassName(),t.cameraId=e?e.id:null,t.reusable=this._reusable,t.textureType=this._textureType,t.fragmentUrl=this._fragmentUrl,t.parameters=this._parameters,t.samplers=this._samplers,t.options=this._options,t.defines=this._postProcessDefines,t.textureFormat=this._textureFormat,t.vertexUrl=this._vertexUrl,t.indexParameters=this._indexParameters,t},l.prototype.clone=function(){var t=this.serialize();t._engine=this._engine,t.cameraId=null;var e=l.Parse(t,this._scene,"");return e?(e.onActivateObservable=this.onActivateObservable.clone(),e.onSizeChangedObservable=this.onSizeChangedObservable.clone(),e.onApplyObservable=this.onApplyObservable.clone(),e.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),e.onAfterRenderObservable=this.onAfterRenderObservable.clone(),e._prePassEffectConfiguration=this._prePassEffectConfiguration,e):null},l.Parse=function(t,e,i){var r=fe(t.customType);if(!r||!r._Parse)return null;var n=e?e.getCameraById(t.cameraId):null;return r._Parse(t,n,e,i)},l._Parse=function(t,e,i,r){return O.Parse(function(){return new l(t.name,t.fragmentUrl,t.parameters,t.samplers,t.options,e,t.renderTargetSamplingMode,t._engine,t.reusable,t.defines,t.textureType,t.vertexUrl,t.indexParameters,!1,t.textureFormat)},t,i,r)},d([p()],l.prototype,"uniqueId",void 0),d([p()],l.prototype,"name",void 0),d([p()],l.prototype,"width",void 0),d([p()],l.prototype,"height",void 0),d([p()],l.prototype,"renderTargetSamplingMode",void 0),d([de()],l.prototype,"clearColor",void 0),d([p()],l.prototype,"autoClear",void 0),d([p()],l.prototype,"alphaMode",void 0),d([p()],l.prototype,"alphaConstants",void 0),d([p()],l.prototype,"enablePixelPerfectMode",void 0),d([p()],l.prototype,"forceFullscreenViewport",void 0),d([p()],l.prototype,"scaleMode",void 0),d([p()],l.prototype,"alwaysForcePOT",void 0),d([p("samples")],l.prototype,"_samples",void 0),d([p()],l.prototype,"adaptScaleToCurrentViewport",void 0),l}();A("BABYLON.PostProcess",v);var Z=function(l){y(t,l);function t(e,i,r,n,a,s,o,u){return r===void 0&&(r=null),o===void 0&&(o=0),u===void 0&&(u=!1),l.call(this,e,"pass",null,null,i,r,n,a,s,void 0,o,void 0,null,u)||this}return t.prototype.getClassName=function(){return"PassPostProcess"},t._Parse=function(e,i,r,n){return O.Parse(function(){return new t(e.name,e.options,i,e.renderTargetSamplingMode,e._engine,e.reusable)},e,r,n)},t}(v);A("BABYLON.PassPostProcess",Z);(function(l){y(t,l);function t(e,i,r,n,a,s,o,u){r===void 0&&(r=null),o===void 0&&(o=0),u===void 0&&(u=!1);var c=l.call(this,e,"passCube",null,null,i,r,n,a,s,"#define POSITIVEX",o,void 0,null,u)||this;return c._face=0,c}return Object.defineProperty(t.prototype,"face",{get:function(){return this._face},set:function(e){if(!(e<0||e>5))switch(this._face=e,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ");break}},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"PassCubePostProcess"},t._Parse=function(e,i,r,n){return O.Parse(function(){return new t(e.name,e.options,i,e.renderTargetSamplingMode,e._engine,e.reusable)},e,r,n)},t})(v);K._RescalePostProcessFactory=function(l){return new Z("rescale",1,null,2,l,!1,0)};var Ne=function(l){y(t,l);function t(e,i,r,n,a,s){var o=l.call(this,e,"anaglyph",null,["leftSampler"],i,r[1],n,a,s)||this;return o._passedProcess=r[0]._rigPostProcess,o.onApplyObservable.add(function(u){u.setTextureFromPostProcess("leftSampler",o._passedProcess)}),o}return t.prototype.getClassName=function(){return"AnaglyphPostProcess"},t}(v);A("BABYLON.AnaglyphPostProcess",Ne);var pt=function(l){y(t,l);function t(e,i,r,n,a,s,o){var u=l.call(this,e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,i[1],a,s,o,n?"#define IS_STEREOSCOPIC_INTERLACED 1":r?"#define IS_STEREOSCOPIC_HORIZ 1":void 0)||this;return u._passedProcess=i[0]._rigPostProcess,u._stepSize=new R(1/u.width,1/u.height),u.onSizeChangedObservable.add(function(){u._stepSize=new R(1/u.width,1/u.height)}),u.onApplyObservable.add(function(c){c.setTextureFromPostProcess("camASampler",u._passedProcess),c.setFloat2("stepSize",u._stepSize.x,u._stepSize.y)}),u}return t.prototype.getClassName=function(){return"StereoscopicInterlacePostProcessI"},t}(v);(function(l){y(t,l);function t(e,i,r,n,a,s){var o=l.call(this,e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,i[1],n,a,s,r?"#define IS_STEREOSCOPIC_HORIZ 1":void 0)||this;return o._passedProcess=i[0]._rigPostProcess,o._stepSize=new R(1/o.width,1/o.height),o.onSizeChangedObservable.add(function(){o._stepSize=new R(1/o.width,1/o.height)}),o.onApplyObservable.add(function(u){u.setTextureFromPostProcess("camASampler",o._passedProcess),u.setFloat2("stepSize",o._stepSize.x,o._stepSize.y)}),o}return t.prototype.getClassName=function(){return"StereoscopicInterlacePostProcess"},t})(v);var gt=function(l){y(t,l);function t(e,i,r,n){var a=l.call(this,e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,n.postProcessScaleFactor,i,_.BILINEAR_SAMPLINGMODE)||this;return a._isRightEye=r,a._distortionFactors=n.distortionK,a._postProcessScaleFactor=n.postProcessScaleFactor,a._lensCenterOffset=n.lensCenterOffset,a.adaptScaleToCurrentViewport=!0,a.onSizeChangedObservable.add(function(){a._scaleIn=new R(2,2/a.aspectRatio),a._scaleFactor=new R(.5*(1/a._postProcessScaleFactor),.5*(1/a._postProcessScaleFactor)*a.aspectRatio),a._lensCenter=new R(a._isRightEye?.5-a._lensCenterOffset*.5:.5+a._lensCenterOffset*.5,.5)}),a.onApplyObservable.add(function(s){s.setFloat2("LensCenter",a._lensCenter.x,a._lensCenter.y),s.setFloat2("Scale",a._scaleFactor.x,a._scaleFactor.y),s.setFloat2("ScaleIn",a._scaleIn.x,a._scaleIn.y),s.setFloat4("HmdWarpParam",a._distortionFactors[0],a._distortionFactors[1],a._distortionFactors[2],a._distortionFactors[3])}),a}return t.prototype.getClassName=function(){return"VRDistortionCorrectionPostProcess"},t}(v),_t=function(l){y(t,l);function t(e,i,r){var n=l.call(this,e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],r,i,_.BILINEAR_SAMPLINGMODE)||this;return n.onSizeChangedObservable.add(function(){}),n.onApplyObservable.add(function(a){i._scene.activeCamera&&i._scene.activeCamera.isLeftCamera?a.setInt("imageIndex",0):a.setInt("imageIndex",1),a.setTexture("multiviewSampler",i._multiviewTexture)}),n}return t.prototype.getClassName=function(){return"VRMultiviewToSingleviewPostProcess"},t}(v),je=function(l){y(t,l);function t(e,i,r,n,a,s,o,u){r===void 0&&(r=null),o===void 0&&(o=0);var c=l.call(this,e,"imageProcessing",[],[],i,r,n,a,s,null,o,"postprocess",null,!0)||this;return c._fromLinearSpace=!0,c._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:!1,TONEMAPPING_ACES:!1,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1,SKIPFINALCOLORCLAMP:!1},u?(u.applyByPostProcess=!0,c._attachImageProcessingConfiguration(u,!0),c._updateParameters()):(c._attachImageProcessingConfiguration(null,!0),c.imageProcessingConfiguration.applyByPostProcess=!0),c.onApply=function(h){c.imageProcessingConfiguration.bind(h,c.aspectRatio)},c}return Object.defineProperty(t.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){e.applyByPostProcess=!0,this._attachImageProcessingConfiguration(e)},enumerable:!1,configurable:!0}),t.prototype._attachImageProcessingConfiguration=function(e,i){var r=this;if(i===void 0&&(i=!1),e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else{var n=null,a=this.getEngine(),s=this.getCamera();if(s)n=s.getScene();else if(a&&a.scenes){var o=a.scenes;n=o[o.length-1]}else n=X.LastCreatedScene;n?this._imageProcessingConfiguration=n.imageProcessingConfiguration:this._imageProcessingConfiguration=new k}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){r._updateParameters()})),i||this._updateParameters()}},Object.defineProperty(t.prototype,"isSupported",{get:function(){var e=this.getEffect();return!e||e.isSupported},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"colorCurves",{get:function(){return this.imageProcessingConfiguration.colorCurves},set:function(e){this.imageProcessingConfiguration.colorCurves=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"colorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(e){this.imageProcessingConfiguration.colorCurvesEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"colorGradingTexture",{get:function(){return this.imageProcessingConfiguration.colorGradingTexture},set:function(e){this.imageProcessingConfiguration.colorGradingTexture=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"colorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(e){this.imageProcessingConfiguration.colorGradingEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"exposure",{get:function(){return this.imageProcessingConfiguration.exposure},set:function(e){this.imageProcessingConfiguration.exposure=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"toneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(e){this._imageProcessingConfiguration.toneMappingEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"toneMappingType",{get:function(){return this._imageProcessingConfiguration.toneMappingType},set:function(e){this._imageProcessingConfiguration.toneMappingType=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"contrast",{get:function(){return this.imageProcessingConfiguration.contrast},set:function(e){this.imageProcessingConfiguration.contrast=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vignetteStretch",{get:function(){return this.imageProcessingConfiguration.vignetteStretch},set:function(e){this.imageProcessingConfiguration.vignetteStretch=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vignetteCentreX",{get:function(){return this.imageProcessingConfiguration.vignetteCentreX},set:function(e){this.imageProcessingConfiguration.vignetteCentreX=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vignetteCentreY",{get:function(){return this.imageProcessingConfiguration.vignetteCentreY},set:function(e){this.imageProcessingConfiguration.vignetteCentreY=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vignetteWeight",{get:function(){return this.imageProcessingConfiguration.vignetteWeight},set:function(e){this.imageProcessingConfiguration.vignetteWeight=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vignetteColor",{get:function(){return this.imageProcessingConfiguration.vignetteColor},set:function(e){this.imageProcessingConfiguration.vignetteColor=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vignetteCameraFov",{get:function(){return this.imageProcessingConfiguration.vignetteCameraFov},set:function(e){this.imageProcessingConfiguration.vignetteCameraFov=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vignetteBlendMode",{get:function(){return this.imageProcessingConfiguration.vignetteBlendMode},set:function(e){this.imageProcessingConfiguration.vignetteBlendMode=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vignetteEnabled",{get:function(){return this.imageProcessingConfiguration.vignetteEnabled},set:function(e){this.imageProcessingConfiguration.vignetteEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fromLinearSpace",{get:function(){return this._fromLinearSpace},set:function(e){this._fromLinearSpace!==e&&(this._fromLinearSpace=e,this._updateParameters())},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"ImageProcessingPostProcess"},t.prototype._updateParameters=function(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);var e="";for(var i in this._defines)this._defines[i]&&(e+="#define ".concat(i,`;\r
`));var r=["textureSampler"],n=["scale"];k&&(k.PrepareSamplers(r,this._defines),k.PrepareUniforms(n,this._defines)),this.updateEffect(e,n,r)},t.prototype.dispose=function(e){l.prototype.dispose.call(this,e),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)},d([p()],t.prototype,"_fromLinearSpace",void 0),t}(v),j=function(l){y(t,l);function t(e,i,r,n,a,s,o,u,c,h,f){s===void 0&&(s=_.BILINEAR_SAMPLINGMODE),c===void 0&&(c=0),h===void 0&&(h=""),f===void 0&&(f=!1);var g=l.call(this,e,"kernelBlur",["delta","direction","cameraMinMaxZ"],["circleOfConfusionSampler"],n,a,s,o,u,null,c,"kernelBlur",{varyingCount:0,depCount:0},!0)||this;return g._blockCompilation=f,g._packedFloat=!1,g._staticDefines="",g._staticDefines=h,g.direction=i,g.onApplyObservable.add(function(m){g._outputTexture?m.setFloat2("delta",1/g._outputTexture.width*g.direction.x,1/g._outputTexture.height*g.direction.y):m.setFloat2("delta",1/g.width*g.direction.x,1/g.height*g.direction.y)}),g.kernel=r,g}return Object.defineProperty(t.prototype,"kernel",{get:function(){return this._idealKernel},set:function(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this._blockCompilation||this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"packedFloat",{get:function(){return this._packedFloat},set:function(e){this._packedFloat!==e&&(this._packedFloat=e,this._blockCompilation||this._updateParameters())},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"BlurPostProcess"},t.prototype.updateEffect=function(e,i,r,n,a,s){this._updateParameters(a,s)},t.prototype._updateParameters=function(e,i){for(var r=this._kernel,n=(r-1)/2,a=[],s=[],o=0,u=0;u<r;u++){var c=u/(r-1),h=this._gaussianWeight(c*2-1);a[u]=u-n,s[u]=h,o+=h}for(var u=0;u<s.length;u++)s[u]/=o;for(var f=[],g=[],m=[],u=0;u<=n;u+=2){var P=Math.min(u+1,Math.floor(n)),S=u===P;if(S)m.push({o:a[u],w:s[u]});else{var E=P===n,C=s[u]+s[P]*(E?.5:1),x=a[u]+1/(1+s[u]/s[P]);x===0?(m.push({o:a[u],w:s[u]}),m.push({o:a[u+1],w:s[u+1]})):(m.push({o:x,w:C}),m.push({o:-x,w:C}))}}for(var u=0;u<m.length;u++)g[u]=m[u].o,f[u]=m[u].w;a=g,s=f;var T=this.getEngine().getCaps().maxVaryingVectors,M=Math.max(T,0)-1,w=Math.min(a.length,M),B="";B+=this._staticDefines,this._staticDefines.indexOf("DOF")!=-1&&(B+="#define CENTER_WEIGHT ".concat(this._glslFloat(s[w-1]),`\r
`),w--);for(var u=0;u<w;u++)B+="#define KERNEL_OFFSET".concat(u," ").concat(this._glslFloat(a[u]),`\r
`),B+="#define KERNEL_WEIGHT".concat(u," ").concat(this._glslFloat(s[u]),`\r
`);for(var G=0,u=M;u<a.length;u++)B+="#define KERNEL_DEP_OFFSET".concat(G," ").concat(this._glslFloat(a[u]),`\r
`),B+="#define KERNEL_DEP_WEIGHT".concat(G," ").concat(this._glslFloat(s[u]),`\r
`),G++;this.packedFloat&&(B+="#define PACKEDFLOAT 1"),this._blockCompilation=!1,l.prototype.updateEffect.call(this,B,null,null,{varyingCount:w,depCount:G},e,i)},t.prototype._nearestBestKernel=function(e){for(var i=Math.round(e),r=0,n=[i,i-1,i+1,i-2,i+2];r<n.length;r++){var a=n[r];if(a%2!==0&&Math.floor(a/2)%2===0&&a>0)return Math.max(a,3)}return Math.max(i,3)},t.prototype._gaussianWeight=function(e){var i=.3333333333333333,r=Math.sqrt(2*Math.PI)*i,n=-(e*e/(2*i*i)),a=1/r*Math.exp(n);return a},t.prototype._glslFloat=function(e,i){return i===void 0&&(i=8),e.toFixed(i).replace(/0+$/,"")},t._Parse=function(e,i,r,n){return O.Parse(function(){return new t(e.name,e.direction,e.kernel,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable,e.textureType,void 0,!1)},e,r,n)},d([p("kernel")],t.prototype,"_kernel",void 0),d([p("packedFloat")],t.prototype,"_packedFloat",void 0),d([pe()],t.prototype,"direction",void 0),t}(v);A("BABYLON.BlurPostProcess",j);var Ge=function(l){y(t,l);function t(e,i,r,n,a,s){var o=l.call(this,e,"blackAndWhite",["degree"],null,i,r,n,a,s)||this;return o.degree=1,o.onApplyObservable.add(function(u){u.setFloat("degree",o.degree)}),o}return t.prototype.getClassName=function(){return"BlackAndWhitePostProcess"},t._Parse=function(e,i,r,n){return O.Parse(function(){return new t(e.name,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable)},e,r,n)},d([p()],t.prototype,"degree",void 0),t}(v);A("BABYLON.BlackAndWhitePostProcess",Ge);var b=function(){function l(t,e,i,r){this._name=e,this._singleInstance=r||!0,this._getPostProcesses=i,this._cameras={},this._indicesForCamera={},this._postProcesses={}}return Object.defineProperty(l.prototype,"isSupported",{get:function(){for(var t in this._postProcesses)if(Object.prototype.hasOwnProperty.call(this._postProcesses,t)){for(var e=this._postProcesses[t],i=0;i<e.length;i++)if(!e[i].isSupported)return!1}return!0},enumerable:!1,configurable:!0}),l.prototype._update=function(){},l.prototype._attachCameras=function(t){var e=this,i,r=N.MakeArray(t||this._cameras);if(!!r)for(var n=function(o){var u=r[o];if(!u)return"continue";var c=u.name;if(a._singleInstance?i=0:i=c,!a._postProcesses[i]){var h=a._getPostProcesses();h&&(a._postProcesses[i]=Array.isArray(h)?h:[h])}a._indicesForCamera[c]||(a._indicesForCamera[c]=[]),a._postProcesses[i].forEach(function(f){var g=u.attachPostProcess(f);e._indicesForCamera[c].push(g)}),a._cameras[c]||(a._cameras[c]=u)},a=this,s=0;s<r.length;s++)n(s)},l.prototype._detachCameras=function(t){var e=N.MakeArray(t||this._cameras);if(!!e)for(var i=function(a){var s=e[a],o=s.name,u=r._postProcesses[r._singleInstance?0:o];u&&u.forEach(function(c){s.detachPostProcess(c)}),r._cameras[o]&&(r._cameras[o]=null)},r=this,n=0;n<e.length;n++)i(n)},l.prototype._enable=function(t){var e=this,i=N.MakeArray(t||this._cameras);if(!!i)for(var r=function(s){for(var o=i[s],u=o.name,c=function(f){(o._postProcesses[n._indicesForCamera[u][f]]===void 0||o._postProcesses[n._indicesForCamera[u][f]]===null)&&n._postProcesses[n._singleInstance?0:u].forEach(function(g){i[s].attachPostProcess(g,e._indicesForCamera[u][f])})},h=0;h<n._indicesForCamera[u].length;h++)c(h)},n=this,a=0;a<i.length;a++)r(a)},l.prototype._disable=function(t){var e=N.MakeArray(t||this._cameras);if(!!e)for(var i=function(a){var s=e[a],o=s.name;r._postProcesses[r._singleInstance?0:o].forEach(function(u){s.detachPostProcess(u)})},r=this,n=0;n<e.length;n++)i(n)},l.prototype.getPostProcesses=function(t){return this._singleInstance?this._postProcesses[0]:t?this._postProcesses[t.name]:null},l}(),se=function(l){y(t,l);function t(e,i,r,n,a,s,o,u){o===void 0&&(o=0),u===void 0&&(u=!1);var c=l.call(this,e,"extractHighlights",["threshold","exposure"],null,i,r,n,a,s,null,o,void 0,null,u)||this;return c.threshold=.9,c._exposure=1,c._inputPostProcess=null,c.onApplyObservable.add(function(h){c.externalTextureSamplerBinding=!!c._inputPostProcess,c._inputPostProcess&&h.setTextureFromPostProcess("textureSampler",c._inputPostProcess),h.setFloat("threshold",Math.pow(c.threshold,me)),h.setFloat("exposure",c._exposure)}),c}return t.prototype.getClassName=function(){return"ExtractHighlightsPostProcess"},d([p()],t.prototype,"threshold",void 0),t}(v);A("BABYLON.ExtractHighlightsPostProcess",se);var ne=function(l){y(t,l);function t(e,i,r,n,a,s,o,u,c,h,f){h===void 0&&(h=0),f===void 0&&(f=!1);var g=l.call(this,e,"bloomMerge",["bloomWeight"],["bloomBlur"],a,s,o,u,c,null,h,void 0,null,!0)||this;return g.weight=1,g.weight=n,g.externalTextureSamplerBinding=!0,g.onApplyObservable.add(function(m){m.setTextureFromPostProcess("textureSampler",i),m.setTextureFromPostProcessOutput("bloomBlur",r),m.setFloat("bloomWeight",g.weight)}),f||g.updateEffect(),g}return t.prototype.getClassName=function(){return"BloomMergePostProcess"},d([p()],t.prototype,"weight",void 0),t}(v);A("BABYLON.BloomMergePostProcess",ne);var te=function(l){y(t,l);function t(e,i,r,n,a,s){a===void 0&&(a=0),s===void 0&&(s=!1);var o=l.call(this,e.getEngine(),"bloom",function(){return o._effects},!0)||this;return o._bloomScale=i,o._effects=[],o._downscale=new se("highlights",1,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,a,s),o._blurX=new j("horizontal blur",new R(1,0),10,i,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,a,void 0,s),o._blurX.alwaysForcePOT=!0,o._blurX.autoClear=!1,o._blurY=new j("vertical blur",new R(0,1),10,i,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,a,void 0,s),o._blurY.alwaysForcePOT=!0,o._blurY.autoClear=!1,o.kernel=n,o._effects=[o._downscale,o._blurX,o._blurY],o._merge=new ne("bloomMerge",o._downscale,o._blurY,r,i,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,a,s),o._merge.autoClear=!1,o._effects.push(o._merge),o}return Object.defineProperty(t.prototype,"threshold",{get:function(){return this._downscale.threshold},set:function(e){this._downscale.threshold=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"weight",{get:function(){return this._merge.weight},set:function(e){this._merge.weight=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"kernel",{get:function(){return this._blurX.kernel/this._bloomScale},set:function(e){this._blurX.kernel=e*this._bloomScale,this._blurY.kernel=e*this._bloomScale},enumerable:!1,configurable:!0}),t.prototype.disposeEffects=function(e){for(var i=0;i<this._effects.length;i++)this._effects[i].dispose(e)},t.prototype._updateEffects=function(){for(var e=0;e<this._effects.length;e++)this._effects[e].updateEffect()},t.prototype._isReady=function(){for(var e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0},t}(b),oe=function(l){y(t,l);function t(e,i,r,n,a,s,o,u,c,h){c===void 0&&(c=0),h===void 0&&(h=!1);var f=l.call(this,e,"chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],n,a,s,o,u,null,c,void 0,null,h)||this;return f.aberrationAmount=30,f.radialIntensity=0,f.direction=new R(.707,.707),f.centerPosition=new R(.5,.5),f.screenWidth=i,f.screenHeight=r,f.onApplyObservable.add(function(g){g.setFloat("chromatic_aberration",f.aberrationAmount),g.setFloat("screen_width",i),g.setFloat("screen_height",r),g.setFloat("radialIntensity",f.radialIntensity),g.setFloat2("direction",f.direction.x,f.direction.y),g.setFloat2("centerPosition",f.centerPosition.x,f.centerPosition.y)}),f}return t.prototype.getClassName=function(){return"ChromaticAberrationPostProcess"},t._Parse=function(e,i,r,n){return O.Parse(function(){return new t(e.name,e.screenWidth,e.screenHeight,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable,e.textureType,!1)},e,r,n)},d([p()],t.prototype,"aberrationAmount",void 0),d([p()],t.prototype,"radialIntensity",void 0),d([p()],t.prototype,"direction",void 0),d([p()],t.prototype,"centerPosition",void 0),d([p()],t.prototype,"screenWidth",void 0),d([p()],t.prototype,"screenHeight",void 0),t}(v);A("BABYLON.ChromaticAberrationPostProcess",oe);var ae=function(l){y(t,l);function t(e,i,r,n,a,s,o,u,c){u===void 0&&(u=0),c===void 0&&(c=!1);var h=l.call(this,e,"circleOfConfusion",["cameraMinMaxZ","focusDistance","cocPrecalculation"],["depthSampler"],r,n,a,s,o,null,u,void 0,null,c)||this;return h.lensSize=50,h.fStop=1.4,h.focusDistance=2e3,h.focalLength=50,h._depthTexture=null,h._depthTexture=i,h.onApplyObservable.add(function(f){if(!h._depthTexture){L.Warn("No depth texture set on CircleOfConfusionPostProcess");return}f.setTexture("depthSampler",h._depthTexture);var g=h.lensSize/h.fStop,m=g*h.focalLength/(h.focusDistance-h.focalLength);f.setFloat("focusDistance",h.focusDistance),f.setFloat("cocPrecalculation",m),f.setFloat2("cameraMinMaxZ",h._depthTexture.activeCamera.minZ,h._depthTexture.activeCamera.maxZ)}),h}return t.prototype.getClassName=function(){return"CircleOfConfusionPostProcess"},Object.defineProperty(t.prototype,"depthTexture",{set:function(e){this._depthTexture=e},enumerable:!1,configurable:!0}),d([p()],t.prototype,"lensSize",void 0),d([p()],t.prototype,"fStop",void 0),d([p()],t.prototype,"focusDistance",void 0),d([p()],t.prototype,"focalLength",void 0),t}(v);A("BABYLON.CircleOfConfusionPostProcess",ae);var Ve=function(l){y(t,l);function t(e,i,r,n,a,s,o){var u=l.call(this,e,"colorCorrection",null,["colorTable"],r,n,a,s,o)||this;return u._colorTableTexture=new _(i,n.getScene(),!0,!1,_.TRILINEAR_SAMPLINGMODE),u._colorTableTexture.anisotropicFilteringLevel=1,u._colorTableTexture.wrapU=_.CLAMP_ADDRESSMODE,u._colorTableTexture.wrapV=_.CLAMP_ADDRESSMODE,u.colorTableUrl=i,u.onApply=function(c){c.setTexture("colorTable",u._colorTableTexture)},u}return t.prototype.getClassName=function(){return"ColorCorrectionPostProcess"},t._Parse=function(e,i,r,n){return O.Parse(function(){return new t(e.name,e.colorTableUrl,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable)},e,r,n)},d([p()],t.prototype,"colorTableUrl",void 0),t}(v);A("BABYLON.ColorCorrectionPostProcess",Ve);var He=function(l){y(t,l);function t(e,i,r,n,a,s,o,u){u===void 0&&(u=0);var c=l.call(this,e,"convolution",["kernel","screenSize"],null,r,n,a,s,o,null,u)||this;return c.kernel=i,c.onApply=function(h){h.setFloat2("screenSize",c.width,c.height),h.setArray("kernel",c.kernel)},c}return t.prototype.getClassName=function(){return"ConvolutionPostProcess"},t._Parse=function(e,i,r,n){return O.Parse(function(){return new t(e.name,e.kernel,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable,e.textureType)},e,r,n)},t.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],t.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],t.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],t.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],t.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],t.GaussianKernel=[0,1,0,1,1,1,0,1,0],d([p()],t.prototype,"kernel",void 0),t}(v);A("BABYLON.ConvolutionPostProcess",He);var q=function(l){y(t,l);function t(e,i,r,n,a,s,o,u,c,h,f,g,m){u===void 0&&(u=null),c===void 0&&(c=_.BILINEAR_SAMPLINGMODE),g===void 0&&(g=0),m===void 0&&(m=!1);var P=l.call(this,e,r,n,a,s,c=2,h,f,g,`#define DOF 1\r
`,m)||this;return P.direction=r,P.externalTextureSamplerBinding=!!u,P.onApplyObservable.add(function(S){u!=null&&S.setTextureFromPostProcess("textureSampler",u),S.setTextureFromPostProcessOutput("circleOfConfusionSampler",o),i.activeCamera&&S.setFloat2("cameraMinMaxZ",i.activeCamera.minZ,i.activeCamera.maxZ)}),P}return t.prototype.getClassName=function(){return"DepthOfFieldBlurPostProcess"},d([p()],t.prototype,"direction",void 0),t}(j);A("BABYLON.DepthOfFieldBlurPostProcess",q);var ze=function(l){y(t,l);function t(e,i,r,n,a,s,o,u,c,h,f){h===void 0&&(h=0),f===void 0&&(f=!1);var g=l.call(this,e,"depthOfFieldMerge",[],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"],a,s,o,u,c,null,h,void 0,null,!0)||this;return g._blurSteps=n,g.externalTextureSamplerBinding=!0,g.onApplyObservable.add(function(m){m.setTextureFromPostProcess("textureSampler",i),m.setTextureFromPostProcessOutput("circleOfConfusionSampler",r),n.forEach(function(P,S){m.setTextureFromPostProcessOutput("blurStep"+(n.length-S-1),P)})}),f||g.updateEffect(),g}return t.prototype.getClassName=function(){return"DepthOfFieldMergePostProcess"},t.prototype.updateEffect=function(e,i,r,n,a,s){e===void 0&&(e=null),i===void 0&&(i=null),r===void 0&&(r=null),e||(e="",e+="#define BLUR_LEVEL "+(this._blurSteps.length-1)+`
`),l.prototype.updateEffect.call(this,e,i,r,n,a,s)},t}(v),z;(function(l){l[l.Low=0]="Low",l[l.Medium=1]="Medium",l[l.High=2]="High"})(z||(z={}));var re=function(l){y(t,l);function t(e,i,r,n,a){r===void 0&&(r=z.Low),n===void 0&&(n=0),a===void 0&&(a=!1);var s=l.call(this,e.getEngine(),"depth of field",function(){return s._effects},!0)||this;s._effects=[],s._circleOfConfusion=new ae("circleOfConfusion",i,1,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,a),s._depthOfFieldBlurY=[],s._depthOfFieldBlurX=[];var o=1,u=15;switch(r){case z.High:{o=3,u=51;break}case z.Medium:{o=2,u=31;break}default:{u=15,o=1;break}}for(var c=u/Math.pow(2,o-1),h=1,f=0;f<o;f++){var g=new q("vertical blur",e,new R(0,1),c,h,null,s._circleOfConfusion,f==0?s._circleOfConfusion:null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,a);g.autoClear=!1,h=.75/Math.pow(2,f);var m=new q("horizontal blur",e,new R(1,0),c,h,null,s._circleOfConfusion,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,a);m.autoClear=!1,s._depthOfFieldBlurY.push(g),s._depthOfFieldBlurX.push(m)}s._effects=[s._circleOfConfusion];for(var f=0;f<s._depthOfFieldBlurX.length;f++)s._effects.push(s._depthOfFieldBlurY[f]),s._effects.push(s._depthOfFieldBlurX[f]);return s._dofMerge=new ze("dofMerge",s._circleOfConfusion,s._circleOfConfusion,s._depthOfFieldBlurX,h,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,a),s._dofMerge.autoClear=!1,s._effects.push(s._dofMerge),s}return Object.defineProperty(t.prototype,"focalLength",{get:function(){return this._circleOfConfusion.focalLength},set:function(e){this._circleOfConfusion.focalLength=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fStop",{get:function(){return this._circleOfConfusion.fStop},set:function(e){this._circleOfConfusion.fStop=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"focusDistance",{get:function(){return this._circleOfConfusion.focusDistance},set:function(e){this._circleOfConfusion.focusDistance=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lensSize",{get:function(){return this._circleOfConfusion.lensSize},set:function(e){this._circleOfConfusion.lensSize=e},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"DepthOfFieldEffect"},Object.defineProperty(t.prototype,"depthTexture",{set:function(e){this._circleOfConfusion.depthTexture=e},enumerable:!1,configurable:!0}),t.prototype.disposeEffects=function(e){for(var i=0;i<this._effects.length;i++)this._effects[i].dispose(e)},t.prototype._updateEffects=function(){for(var e=0;e<this._effects.length;e++)this._effects[e].updateEffect()},t.prototype._isReady=function(){for(var e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0},t}(b),We=function(l){y(t,l);function t(e,i,r,n,a,s){return l.call(this,e,"displayPass",["passSampler"],["passSampler"],i,r,n,a,s)||this}return t.prototype.getClassName=function(){return"DisplayPassPostProcess"},t._Parse=function(e,i,r,n){return O.Parse(function(){return new t(e.name,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable)},e,r,n)},t}(v);A("BABYLON.DisplayPassPostProcess",We);var Ue=function(l){y(t,l);function t(e,i,r,n,a,s,o){var u=l.call(this,e,"filter",["kernelMatrix"],null,r,n,a,s,o)||this;return u.kernelMatrix=i,u.onApply=function(c){c.setMatrix("kernelMatrix",u.kernelMatrix)},u}return t.prototype.getClassName=function(){return"FilterPostProcess"},t._Parse=function(e,i,r,n){return O.Parse(function(){return new t(e.name,e.kernelMatrix,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable)},e,r,n)},d([ge()],t.prototype,"kernelMatrix",void 0),t}(v);A("BABYLON.FilterPostProcess",Ue);var $=function(l){y(t,l);function t(e,i,r,n,a,s,o){r===void 0&&(r=null),o===void 0&&(o=0);var u=l.call(this,e,"fxaa",["texelSize"],null,i,r,n||_.BILINEAR_SAMPLINGMODE,a,s,null,o,"fxaa",void 0,!0)||this,c=u._getDefines();return u.updateEffect(c),u.onApplyObservable.add(function(h){var f=u.texelSize;h.setFloat2("texelSize",f.x,f.y)}),u}return t.prototype.getClassName=function(){return"FxaaPostProcess"},t.prototype._getDefines=function(){var e=this.getEngine();if(!e)return null;var i=e.getGlInfo();return i&&i.renderer&&i.renderer.toLowerCase().indexOf("mali")>-1?`#define MALI 1
`:null},t._Parse=function(e,i,r,n){return O.Parse(function(){return new t(e.name,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable)},e,r,n)},t}(v);A("BABYLON.FxaaPostProcess",$);var le=function(l){y(t,l);function t(e,i,r,n,a,s,o,u){o===void 0&&(o=0),u===void 0&&(u=!1);var c=l.call(this,e,"grain",["intensity","animatedSeed"],[],i,r,n,a,s,null,o,void 0,null,u)||this;return c.intensity=30,c.animated=!1,c.onApplyObservable.add(function(h){h.setFloat("intensity",c.intensity),h.setFloat("animatedSeed",c.animated?Math.random()+1:1)}),c}return t.prototype.getClassName=function(){return"GrainPostProcess"},t._Parse=function(e,i,r,n){return O.Parse(function(){return new t(e.name,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable)},e,r,n)},d([p()],t.prototype,"intensity",void 0),d([p()],t.prototype,"animated",void 0),t}(v);A("BABYLON.GrainPostProcess",le);(function(l){y(t,l);function t(e,i,r,n,a,s,o){return o===void 0&&(o=0),l.call(this,e,"highlights",null,null,i,r,n,a,s,null,o)||this}return t.prototype.getClassName=function(){return"HighlightsPostProcess"},t})(v);var ue=function(l){y(t,l);function t(e,i,r,n,a,s,o,u,c,h){u===void 0&&(u=0),c===void 0&&(c=!1),h===void 0&&(h=!1);var f=l.call(this,e,"motionBlur",["motionStrength","motionScale","screenSize","inverseViewProjection","prevViewProjection"],["velocitySampler"],r,n,a,s,o,`#define GEOMETRY_SUPPORTED
#define SAMPLES 64.0
#define OBJECT_BASED`,u,void 0,null,c)||this;return f.motionStrength=1,f._motionBlurSamples=32,f._isObjectBased=!0,f._forceGeometryBuffer=!1,f._invViewProjection=null,f._previousViewProjection=null,f._forceGeometryBuffer=h,f._forceGeometryBuffer?(i.enableGeometryBufferRenderer(),f._geometryBufferRenderer&&(f._geometryBufferRenderer.enableVelocity=!0)):(i.enablePrePassRenderer(),f._prePassRenderer&&(f._prePassRenderer.markAsDirty(),f._prePassEffectConfiguration=new Te)),f._applyMode(),f}return Object.defineProperty(t.prototype,"motionBlurSamples",{get:function(){return this._motionBlurSamples},set:function(e){this._motionBlurSamples=e,this._updateEffect()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isObjectBased",{get:function(){return this._isObjectBased},set:function(e){this._isObjectBased!==e&&(this._isObjectBased=e,this._applyMode())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_geometryBufferRenderer",{get:function(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_prePassRenderer",{get:function(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"MotionBlurPostProcess"},t.prototype.excludeSkinnedMesh=function(e){if(e.skeleton){var i=void 0;if(this._geometryBufferRenderer)i=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else if(this._prePassRenderer)i=this._prePassRenderer.excludedSkinnedMesh;else return;i.push(e)}},t.prototype.removeExcludedSkinnedMesh=function(e){if(e.skeleton){var i=void 0;if(this._geometryBufferRenderer)i=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else if(this._prePassRenderer)i=this._prePassRenderer.excludedSkinnedMesh;else return;var r=i.indexOf(e);r!==-1&&i.splice(r,1)}},t.prototype.dispose=function(e){this._geometryBufferRenderer&&(this._geometryBufferRenderer._previousTransformationMatrices={},this._geometryBufferRenderer._previousBonesTransformationMatrices={},this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity=[]),l.prototype.dispose.call(this,e)},t.prototype._applyMode=function(){var e=this;if(!this._geometryBufferRenderer&&!this._prePassRenderer)return L.Warn("Multiple Render Target support needed to compute object based motion blur"),this.updateEffect();this._updateEffect(),this._invViewProjection=null,this._previousViewProjection=null,this.isObjectBased?(this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=2),this.onApply=function(i){return e._onApplyObjectBased(i)}):(this._invViewProjection=I.Identity(),this._previousViewProjection=I.Identity(),this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=5),this.onApply=function(i){return e._onApplyScreenBased(i)})},t.prototype._onApplyObjectBased=function(e){if(e.setVector2("screenSize",new R(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){var i=this._geometryBufferRenderer.getTextureIndex(Y.VELOCITY_TEXTURE_TYPE);e.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[i])}else if(this._prePassRenderer){var i=this._prePassRenderer.getIndex(2);e.setTexture("velocitySampler",this._prePassRenderer.getRenderTarget().textures[i])}},t.prototype._onApplyScreenBased=function(e){var i=this._scene.getProjectionMatrix().multiply(this._scene.getViewMatrix());if(i.invertToRef(this._invViewProjection),e.setMatrix("inverseViewProjection",this._invViewProjection),e.setMatrix("prevViewProjection",this._previousViewProjection),this._previousViewProjection=i,e.setVector2("screenSize",new R(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){var r=this._geometryBufferRenderer.getTextureIndex(Y.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[r])}else if(this._prePassRenderer){var r=this._prePassRenderer.getIndex(5);e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[r])}},t.prototype._updateEffect=function(){if(this._geometryBufferRenderer||this._prePassRenderer){var e=["#define GEOMETRY_SUPPORTED","#define SAMPLES "+this._motionBlurSamples.toFixed(1),this._isObjectBased?"#define OBJECT_BASED":"#define SCREEN_BASED"];this.updateEffect(e.join(`
`))}},t._Parse=function(e,i,r,n){return O.Parse(function(){return new t(e.name,r,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable,e.textureType,!1)},e,r,n)},d([p()],t.prototype,"motionStrength",void 0),d([p()],t.prototype,"motionBlurSamples",null),d([p()],t.prototype,"isObjectBased",null),t}(v);A("BABYLON.MotionBlurPostProcess",ue);var ke=function(l){y(t,l);function t(e,i,r,n,a,s,o,u,c,h){var f=l.call(this,e,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],s,o,u,c,h)||this;return f._ownRefractionTexture=!0,f.color=r,f.depth=n,f.colorLevel=a,f.refractionTextureUrl=i,f.onActivateObservable.add(function(g){f._refTexture=f._refTexture||new _(i,g.getScene())}),f.onApplyObservable.add(function(g){g.setColor3("baseColor",f.color),g.setFloat("depth",f.depth),g.setFloat("colorLevel",f.colorLevel),g.setTexture("refractionSampler",f._refTexture)}),f}return Object.defineProperty(t.prototype,"refractionTexture",{get:function(){return this._refTexture},set:function(e){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=e,this._ownRefractionTexture=!1},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"RefractionPostProcess"},t.prototype.dispose=function(e){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),l.prototype.dispose.call(this,e)},t._Parse=function(e,i,r,n){return O.Parse(function(){return new t(e.name,e.refractionTextureUrl,e.color,e.depth,e.colorLevel,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.reusable)},e,r,n)},d([p()],t.prototype,"color",void 0),d([p()],t.prototype,"depth",void 0),d([p()],t.prototype,"colorLevel",void 0),d([p()],t.prototype,"refractionTextureUrl",void 0),t}(v);A("BABYLON.RefractionPostProcess",ke);var ce=function(l){y(t,l);function t(e,i,r,n,a,s,o,u){o===void 0&&(o=0),u===void 0&&(u=!1);var c=l.call(this,e,"sharpen",["sharpnessAmounts","screenSize"],null,i,r,n,a,s,null,o,void 0,null,u)||this;return c.colorAmount=1,c.edgeAmount=.3,c.onApply=function(h){h.setFloat2("screenSize",c.width,c.height),h.setFloat2("sharpnessAmounts",c.edgeAmount,c.colorAmount)},c}return t.prototype.getClassName=function(){return"SharpenPostProcess"},t._Parse=function(e,i,r,n){return O.Parse(function(){return new t(e.name,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.textureType,e.reusable)},e,r,n)},d([p()],t.prototype,"colorAmount",void 0),d([p()],t.prototype,"edgeAmount",void 0),t}(v);A("BABYLON.SharpenPostProcess",ce);var W=function(){function l(t,e){this._engine=t,this._name=e,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[]}return Object.defineProperty(l.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"cameras",{get:function(){return this._cameras},enumerable:!1,configurable:!0}),l.prototype.getClassName=function(){return"PostProcessRenderPipeline"},Object.defineProperty(l.prototype,"isSupported",{get:function(){for(var t in this._renderEffects)if(Object.prototype.hasOwnProperty.call(this._renderEffects,t)&&!this._renderEffects[t].isSupported)return!1;return!0},enumerable:!1,configurable:!0}),l.prototype.addEffect=function(t){this._renderEffects[t._name]=t},l.prototype._rebuild=function(){},l.prototype._enableEffect=function(t,e){var i=this._renderEffects[t];!i||i._enable(N.MakeArray(e||this._cameras))},l.prototype._disableEffect=function(t,e){var i=this._renderEffects[t];!i||i._disable(N.MakeArray(e||this._cameras))},l.prototype._attachCameras=function(t,e){var i=N.MakeArray(t||this._cameras);if(!!i){var r=[],n;for(n=0;n<i.length;n++){var a=i[n];if(!!a){var s=a.name;this._cameras.indexOf(a)===-1?this._cameras[s]=a:e&&r.push(n)}}for(n=0;n<r.length;n++)i.splice(r[n],1);for(var o in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,o)&&this._renderEffects[o]._attachCameras(i)}},l.prototype._detachCameras=function(t){var e=N.MakeArray(t||this._cameras);if(!!e){for(var i in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,i)&&this._renderEffects[i]._detachCameras(e);for(var r=0;r<e.length;r++)this._cameras.splice(this._cameras.indexOf(e[r]),1)}},l.prototype._update=function(){for(var t in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,t)&&this._renderEffects[t]._update();for(var e=0;e<this._cameras.length;e++)if(!!this._cameras[e]){var i=this._cameras[e].name;this._renderEffectsForIsolatedPass[i]&&this._renderEffectsForIsolatedPass[i]._update()}},l.prototype._reset=function(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array},l.prototype._enableMSAAOnFirstPostProcess=function(t){if(!this._engine._features.supportMSAA)return!1;var e=Object.keys(this._renderEffects);if(e.length>0){var i=this._renderEffects[e[0]].getPostProcesses();i&&(i[0].samples=t)}return!0},l.prototype.setPrePassRenderer=function(t){return!1},l.prototype.dispose=function(){},d([p()],l.prototype,"_name",void 0),l}(),Ye=function(){function l(){this._renderPipelines={}}return Object.defineProperty(l.prototype,"supportedPipelines",{get:function(){var t=[];for(var e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){var i=this._renderPipelines[e];i.isSupported&&t.push(i)}return t},enumerable:!1,configurable:!0}),l.prototype.addPipeline=function(t){this._renderPipelines[t._name]=t},l.prototype.attachCamerasToRenderPipeline=function(t,e,i){i===void 0&&(i=!1);var r=this._renderPipelines[t];!r||r._attachCameras(e,i)},l.prototype.detachCamerasFromRenderPipeline=function(t,e){var i=this._renderPipelines[t];!i||i._detachCameras(e)},l.prototype.enableEffectInPipeline=function(t,e,i){var r=this._renderPipelines[t];!r||r._enableEffect(e,i)},l.prototype.disableEffectInPipeline=function(t,e,i){var r=this._renderPipelines[t];!r||r._disableEffect(e,i)},l.prototype.update=function(){for(var t in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,t)){var e=this._renderPipelines[t];e.isSupported?e._update():(e.dispose(),delete this._renderPipelines[t])}},l.prototype._rebuild=function(){for(var t in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,t)){var e=this._renderPipelines[t];e._rebuild()}},l.prototype.dispose=function(){for(var t in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,t)){var e=this._renderPipelines[t];e.dispose()}},l}();Object.defineProperty(we.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){var l=this._getComponent(J.NAME_POSTPROCESSRENDERPIPELINEMANAGER);l||(l=new Xe(this),this._addComponent(l)),this._postProcessRenderPipelineManager=new Ye}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});var Xe=function(){function l(t){this.name=J.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=t}return l.prototype.register=function(){this.scene._gatherRenderTargetsStage.registerStep(J.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)},l.prototype.rebuild=function(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()},l.prototype.dispose=function(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()},l.prototype._gatherRenderTargets=function(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()},l}(),Ze=function(l){y(t,l);function t(e,i,r,n,a){e===void 0&&(e=""),i===void 0&&(i=!0),r===void 0&&(r=X.LastCreatedScene),a===void 0&&(a=!0);var s=l.call(this,r.getEngine(),e)||this;s._camerasToBeAttached=[],s.SharpenPostProcessId="SharpenPostProcessEffect",s.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",s.FxaaPostProcessId="FxaaPostProcessEffect",s.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",s.GrainPostProcessId="GrainPostProcessEffect",s._glowLayer=null,s.animations=[],s._imageProcessingConfigurationObserver=null,s._sharpenEnabled=!1,s._bloomEnabled=!1,s._depthOfFieldEnabled=!1,s._depthOfFieldBlurLevel=z.Low,s._fxaaEnabled=!1,s._imageProcessingEnabled=!0,s._bloomScale=.5,s._chromaticAberrationEnabled=!1,s._grainEnabled=!1,s._buildAllowed=!0,s.onBuildObservable=new V,s._resizeObserver=null,s._hardwareScaleLevel=1,s._bloomKernel=64,s._bloomWeight=.15,s._bloomThreshold=.9,s._samples=1,s._hasCleared=!1,s._prevPostProcess=null,s._prevPrevPostProcess=null,s._depthOfFieldSceneObserver=null,s._cameras=n||r.cameras,s._cameras=s._cameras.slice(),s._camerasToBeAttached=s._cameras.slice(),s._buildAllowed=a,s._scene=r;var o=s._scene.getEngine().getCaps();s._hdr=i&&(o.textureHalfFloatRender||o.textureFloatRender),s._hdr?o.textureHalfFloatRender?s._defaultPipelineTextureType=2:o.textureFloatRender&&(s._defaultPipelineTextureType=1):s._defaultPipelineTextureType=0,r.postProcessRenderPipelineManager.addPipeline(s);var u=s._scene.getEngine();return s.sharpen=new ce("sharpen",1,null,_.BILINEAR_SAMPLINGMODE,u,!1,s._defaultPipelineTextureType,!0),s._sharpenEffect=new b(u,s.SharpenPostProcessId,function(){return s.sharpen},!0),s.depthOfField=new re(s._scene,null,s._depthOfFieldBlurLevel,s._defaultPipelineTextureType,!0),s.bloom=new te(s._scene,s._bloomScale,s._bloomWeight,s.bloomKernel,s._defaultPipelineTextureType,!0),s.chromaticAberration=new oe("ChromaticAberration",u.getRenderWidth(),u.getRenderHeight(),1,null,_.BILINEAR_SAMPLINGMODE,u,!1,s._defaultPipelineTextureType,!0),s._chromaticAberrationEffect=new b(u,s.ChromaticAberrationPostProcessId,function(){return s.chromaticAberration},!0),s.grain=new le("Grain",1,null,_.BILINEAR_SAMPLINGMODE,u,!1,s._defaultPipelineTextureType,!0),s._grainEffect=new b(u,s.GrainPostProcessId,function(){return s.grain},!0),s._resizeObserver=u.onResizeObservable.add(function(){s._hardwareScaleLevel=u.getHardwareScalingLevel(),s.bloomKernel=s._bloomKernel}),s._imageProcessingConfigurationObserver=s._scene.imageProcessingConfiguration.onUpdateParameters.add(function(){s.bloom._downscale._exposure=s._scene.imageProcessingConfiguration.exposure,s.imageProcessingEnabled!==s._scene.imageProcessingConfiguration.isEnabled&&(s._imageProcessingEnabled=s._scene.imageProcessingConfiguration.isEnabled,s._buildPipeline())}),s._buildPipeline(),s}return Object.defineProperty(t.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"sharpenEnabled",{get:function(){return this._sharpenEnabled},set:function(e){this._sharpenEnabled!==e&&(this._sharpenEnabled=e,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bloomKernel",{get:function(){return this._bloomKernel},set:function(e){this._bloomKernel=e,this.bloom.kernel=e/this._hardwareScaleLevel},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bloomWeight",{get:function(){return this._bloomWeight},set:function(e){this._bloomWeight!==e&&(this.bloom.weight=e,this._bloomWeight=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bloomThreshold",{get:function(){return this._bloomThreshold},set:function(e){this._bloomThreshold!==e&&(this.bloom.threshold=e,this._bloomThreshold=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bloomScale",{get:function(){return this._bloomScale},set:function(e){this._bloomScale!==e&&(this._bloomScale=e,this._rebuildBloom(),this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bloomEnabled",{get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())},enumerable:!1,configurable:!0}),t.prototype._rebuildBloom=function(){var e=this.bloom;this.bloom=new te(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel,this._defaultPipelineTextureType,!1),this.bloom.threshold=e.threshold;for(var i=0;i<this._cameras.length;i++)e.disposeEffects(this._cameras[i])},Object.defineProperty(t.prototype,"depthOfFieldEnabled",{get:function(){return this._depthOfFieldEnabled},set:function(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"depthOfFieldBlurLevel",{get:function(){return this._depthOfFieldBlurLevel},set:function(e){if(this._depthOfFieldBlurLevel!==e){this._depthOfFieldBlurLevel=e;var i=this.depthOfField;this.depthOfField=new re(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=i.focalLength,this.depthOfField.focusDistance=i.focusDistance,this.depthOfField.fStop=i.fStop,this.depthOfField.lensSize=i.lensSize;for(var r=0;r<this._cameras.length;r++)i.disposeEffects(this._cameras[r]);this._buildPipeline()}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fxaaEnabled",{get:function(){return this._fxaaEnabled},set:function(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"samples",{get:function(){return this._samples},set:function(e){this._samples!==e&&(this._samples=e,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"imageProcessingEnabled",{get:function(){return this._imageProcessingEnabled},set:function(e){this._imageProcessingEnabled!==e&&(this._scene.imageProcessingConfiguration.isEnabled=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"glowLayerEnabled",{get:function(){return this._glowLayer!=null},set:function(e){e&&!this._glowLayer?this._glowLayer=new Be("",this._scene):!e&&this._glowLayer&&(this._glowLayer.dispose(),this._glowLayer=null)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"glowLayer",{get:function(){return this._glowLayer},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"chromaticAberrationEnabled",{get:function(){return this._chromaticAberrationEnabled},set:function(e){this._chromaticAberrationEnabled!==e&&(this._chromaticAberrationEnabled=e,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"grainEnabled",{get:function(){return this._grainEnabled},set:function(e){this._grainEnabled!==e&&(this._grainEnabled=e,this._buildPipeline())},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"DefaultRenderingPipeline"},t.prototype.prepare=function(){var e=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=e},t.prototype._setAutoClearAndTextureSharing=function(e,i){i===void 0&&(i=!1),this._hasCleared?e.autoClear=!1:(e.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),i||(this._prevPrevPostProcess?e.shareOutputWith(this._prevPrevPostProcess):e.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=e)},t.prototype._buildPipeline=function(){var e=this;if(!!this._buildAllowed){this._scene.autoClear=!0;var i=this._scene.getEngine();if(this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){if(this._cameras.length>1){for(var r=0,n=this._cameras;r<n.length;r++){var a=n[r],s=this._scene.enableDepthRenderer(a);s.useOnlyInActiveCamera=!0}this._depthOfFieldSceneObserver=this._scene.onAfterRenderTargetsRenderObservable.add(function(o){e._cameras.indexOf(o.activeCamera)>-1&&(e.depthOfField.depthTexture=o.enableDepthRenderer(o.activeCamera).getDepthMap())})}else{this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);var s=this._scene.enableDepthRenderer(this._cameras[0]);this.depthOfField.depthTexture=s.getDepthMap()}this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}else this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new je("imageProcessing",1,null,_.BILINEAR_SAMPLINGMODE,i,!1,this._defaultPipelineTextureType,this.scene.imageProcessingConfiguration),this._hdr?(this.addEffect(new b(i,this.ImageProcessingPostProcessId,function(){return e.imageProcessing},!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1,(!this.cameras||this.cameras.length===0)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.imageProcessing.getEffect()||this.imageProcessing._updateParameters()),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new $("fxaa",1,null,_.BILINEAR_SAMPLINGMODE,i,!1,this._defaultPipelineTextureType),this.addEffect(new b(i,this.FxaaPostProcessId,function(){return e.fxaa},!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),this._scene.activeCameras&&this._scene.activeCameras.length>1&&(this._scene.autoClear=!0),!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1&&L.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0"),this.onBuildObservable.notifyObservers(this)}},t.prototype._disposePostProcesses=function(e){e===void 0&&(e=!1);for(var i=0;i<this._cameras.length;i++){var r=this._cameras[i];this.imageProcessing&&this.imageProcessing.dispose(r),this.fxaa&&this.fxaa.dispose(r),e&&(this.sharpen&&this.sharpen.dispose(r),this.depthOfField&&(this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver),this.depthOfField.disposeEffects(r)),this.bloom&&this.bloom.disposeEffects(r),this.chromaticAberration&&this.chromaticAberration.dispose(r),this.grain&&this.grain.dispose(r),this._glowLayer&&this._glowLayer.dispose())}this.imageProcessing=null,this.fxaa=null,e&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null,this._glowLayer=null)},t.prototype.addCamera=function(e){this._camerasToBeAttached.push(e),this._buildPipeline()},t.prototype.removeCamera=function(e){var i=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(i,1),this._buildPipeline()},t.prototype.dispose=function(){this.onBuildObservable.clear(),this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),l.prototype.dispose.call(this)},t.prototype.serialize=function(){var e=O.Serialize(this);return e.customType="DefaultRenderingPipeline",e},t.Parse=function(e,i,r){return O.Parse(function(){return new t(e._name,e._name._hdr,i)},e,i,r)},d([p()],t.prototype,"sharpenEnabled",null),d([p()],t.prototype,"bloomKernel",null),d([p()],t.prototype,"_bloomWeight",void 0),d([p()],t.prototype,"_bloomThreshold",void 0),d([p()],t.prototype,"_hdr",void 0),d([p()],t.prototype,"bloomWeight",null),d([p()],t.prototype,"bloomThreshold",null),d([p()],t.prototype,"bloomScale",null),d([p()],t.prototype,"bloomEnabled",null),d([p()],t.prototype,"depthOfFieldEnabled",null),d([p()],t.prototype,"depthOfFieldBlurLevel",null),d([p()],t.prototype,"fxaaEnabled",null),d([p()],t.prototype,"samples",null),d([p()],t.prototype,"imageProcessingEnabled",null),d([p()],t.prototype,"glowLayerEnabled",null),d([p()],t.prototype,"chromaticAberrationEnabled",null),d([p()],t.prototype,"grainEnabled",null),t}(W);A("BABYLON.DefaultRenderingPipeline",Ze);(function(l){y(t,l);function t(e,i,r,n,a){n===void 0&&(n=1);var s=l.call(this,r.getEngine(),e)||this;return s.LensChromaticAberrationEffect="LensChromaticAberrationEffect",s.HighlightsEnhancingEffect="HighlightsEnhancingEffect",s.LensDepthOfFieldEffect="LensDepthOfFieldEffect",s._pentagonBokehIsEnabled=!1,s._scene=r,s._depthTexture=r.enableDepthRenderer().getDepthMap(),i.grain_texture?s._grainTexture=i.grain_texture:s._createGrainTexture(),s._edgeBlur=i.edge_blur?i.edge_blur:0,s._grainAmount=i.grain_amount?i.grain_amount:0,s._chromaticAberration=i.chromatic_aberration?i.chromatic_aberration:0,s._distortion=i.distortion?i.distortion:0,s._highlightsGain=i.dof_gain!==void 0?i.dof_gain:-1,s._highlightsThreshold=i.dof_threshold?i.dof_threshold:1,s._dofDistance=i.dof_focus_distance!==void 0?i.dof_focus_distance:-1,s._dofAperture=i.dof_aperture?i.dof_aperture:1,s._dofDarken=i.dof_darken?i.dof_darken:0,s._dofPentagon=i.dof_pentagon!==void 0?i.dof_pentagon:!0,s._blurNoise=i.blur_noise!==void 0?i.blur_noise:!0,s._createChromaticAberrationPostProcess(n),s._createHighlightsPostProcess(n),s._createDepthOfFieldPostProcess(n/4),s.addEffect(new b(r.getEngine(),s.LensChromaticAberrationEffect,function(){return s._chromaticAberrationPostProcess},!0)),s.addEffect(new b(r.getEngine(),s.HighlightsEnhancingEffect,function(){return s._highlightsPostProcess},!0)),s.addEffect(new b(r.getEngine(),s.LensDepthOfFieldEffect,function(){return s._depthOfFieldPostProcess},!0)),s._highlightsGain===-1&&s._disableEffect(s.HighlightsEnhancingEffect,null),r.postProcessRenderPipelineManager.addPipeline(s),a&&r.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,a),s}return t.prototype.getClassName=function(){return"LensRenderingPipeline"},Object.defineProperty(t.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"edgeBlur",{get:function(){return this._edgeBlur},set:function(e){this.setEdgeBlur(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"grainAmount",{get:function(){return this._grainAmount},set:function(e){this.setGrainAmount(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"chromaticAberration",{get:function(){return this._chromaticAberration},set:function(e){this.setChromaticAberration(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dofAperture",{get:function(){return this._dofAperture},set:function(e){this.setAperture(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"edgeDistortion",{get:function(){return this._distortion},set:function(e){this.setEdgeDistortion(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dofDistortion",{get:function(){return this._dofDistance},set:function(e){this.setFocusDistance(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"darkenOutOfFocus",{get:function(){return this._dofDarken},set:function(e){this.setDarkenOutOfFocus(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"blurNoise",{get:function(){return this._blurNoise},set:function(e){this._blurNoise=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"pentagonBokeh",{get:function(){return this._pentagonBokehIsEnabled},set:function(e){e?this.enablePentagonBokeh():this.disablePentagonBokeh()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"highlightsGain",{get:function(){return this._highlightsGain},set:function(e){this.setHighlightsGain(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"highlightsThreshold",{get:function(){return this._highlightsThreshold},set:function(e){this.setHighlightsThreshold(e)},enumerable:!1,configurable:!0}),t.prototype.setEdgeBlur=function(e){this._edgeBlur=e},t.prototype.disableEdgeBlur=function(){this._edgeBlur=0},t.prototype.setGrainAmount=function(e){this._grainAmount=e},t.prototype.disableGrain=function(){this._grainAmount=0},t.prototype.setChromaticAberration=function(e){this._chromaticAberration=e},t.prototype.disableChromaticAberration=function(){this._chromaticAberration=0},t.prototype.setEdgeDistortion=function(e){this._distortion=e},t.prototype.disableEdgeDistortion=function(){this._distortion=0},t.prototype.setFocusDistance=function(e){this._dofDistance=e},t.prototype.disableDepthOfField=function(){this._dofDistance=-1},t.prototype.setAperture=function(e){this._dofAperture=e},t.prototype.setDarkenOutOfFocus=function(e){this._dofDarken=e},t.prototype.enablePentagonBokeh=function(){this._highlightsPostProcess.updateEffect(`#define PENTAGON
`),this._pentagonBokehIsEnabled=!0},t.prototype.disablePentagonBokeh=function(){this._pentagonBokehIsEnabled=!1,this._highlightsPostProcess.updateEffect()},t.prototype.enableNoiseBlur=function(){this._blurNoise=!0},t.prototype.disableNoiseBlur=function(){this._blurNoise=!1},t.prototype.setHighlightsGain=function(e){this._highlightsGain=e},t.prototype.setHighlightsThreshold=function(e){this._highlightsGain===-1&&(this._highlightsGain=1),this._highlightsThreshold=e},t.prototype.disableHighlights=function(){this._highlightsGain=-1},t.prototype.dispose=function(e){e===void 0&&(e=!1),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),this._chromaticAberrationPostProcess=null,this._highlightsPostProcess=null,this._depthOfFieldPostProcess=null,this._grainTexture.dispose(),e&&this._scene.disableDepthRenderer()},t.prototype._createChromaticAberrationPostProcess=function(e){var i=this;this._chromaticAberrationPostProcess=new v("LensChromaticAberration","chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],e,null,_.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._chromaticAberrationPostProcess.onApply=function(r){r.setFloat("chromatic_aberration",i._chromaticAberration),r.setFloat("screen_width",i._scene.getEngine().getRenderWidth()),r.setFloat("screen_height",i._scene.getEngine().getRenderHeight()),r.setFloat("radialIntensity",1),r.setFloat2("direction",17,17),r.setFloat2("centerPosition",.5,.5)}},t.prototype._createHighlightsPostProcess=function(e){var i=this;this._highlightsPostProcess=new v("LensHighlights","lensHighlights",["gain","threshold","screen_width","screen_height"],[],e,null,_.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,this._dofPentagon?`#define PENTAGON
`:""),this._highlightsPostProcess.externalTextureSamplerBinding=!0,this._highlightsPostProcess.onApply=function(r){r.setFloat("gain",i._highlightsGain),r.setFloat("threshold",i._highlightsThreshold),r.setTextureFromPostProcess("textureSampler",i._chromaticAberrationPostProcess),r.setFloat("screen_width",i._scene.getEngine().getRenderWidth()),r.setFloat("screen_height",i._scene.getEngine().getRenderHeight())}},t.prototype._createDepthOfFieldPostProcess=function(e){var i=this;this._depthOfFieldPostProcess=new v("LensDepthOfField","depthOfField",["grain_amount","blur_noise","screen_width","screen_height","distortion","dof_enabled","screen_distance","aperture","darken","edge_blur","highlights","near","far"],["depthSampler","grainSampler","highlightsSampler"],e,null,_.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._depthOfFieldPostProcess.externalTextureSamplerBinding=!0,this._depthOfFieldPostProcess.onApply=function(r){r.setTexture("depthSampler",i._depthTexture),r.setTexture("grainSampler",i._grainTexture),r.setTextureFromPostProcess("textureSampler",i._highlightsPostProcess),r.setTextureFromPostProcess("highlightsSampler",i._depthOfFieldPostProcess),r.setFloat("grain_amount",i._grainAmount),r.setBool("blur_noise",i._blurNoise),r.setFloat("screen_width",i._scene.getEngine().getRenderWidth()),r.setFloat("screen_height",i._scene.getEngine().getRenderHeight()),r.setFloat("distortion",i._distortion),r.setBool("dof_enabled",i._dofDistance!==-1),r.setFloat("screen_distance",1/(.1-1/i._dofDistance)),r.setFloat("aperture",i._dofAperture),r.setFloat("darken",i._dofDarken),r.setFloat("edge_blur",i._edgeBlur),r.setBool("highlights",i._highlightsGain!==-1),i._scene.activeCamera&&(r.setFloat("near",i._scene.activeCamera.minZ),r.setFloat("far",i._scene.activeCamera.maxZ))}},t.prototype._createGrainTexture=function(){var e=512;this._grainTexture=new Q("LensNoiseTexture",e,this._scene,!1,_.BILINEAR_SAMPLINGMODE),this._grainTexture.wrapU=_.WRAP_ADDRESSMODE,this._grainTexture.wrapV=_.WRAP_ADDRESSMODE;for(var i=this._grainTexture.getContext(),r=function(o,u){return Math.random()*(u-o)+o},n,a=0;a<e;a++)for(var s=0;s<e;s++)n=Math.floor(r(.42,.58)*255),i.fillStyle="rgb("+n+", "+n+", "+n+")",i.fillRect(a,s,1,1);this._grainTexture.update(!1)},t})(W);var Ke=function(l){y(t,l);function t(e,i,r,n,a,s){a===void 0&&(a=!1),s===void 0&&(s=0);var o=l.call(this,i.getEngine(),e)||this;if(o.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",o.SSAORenderEffect="SSAORenderEffect",o.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",o.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",o.SSAOCombineRenderEffect="SSAOCombineRenderEffect",o.totalStrength=1,o.maxZ=100,o.minZAspect=.2,o._samples=8,o._textureSamples=1,o._forceGeometryBuffer=!1,o._expensiveBlur=!0,o.radius=2,o.base=0,o._bits=new Uint32Array(1),o._scene=i,o._ratio=r,o._forceGeometryBuffer=a,!o.isSupported)return L.Error("The current engine does not support SSAO 2."),o;var u=o._ratio.ssaoRatio||r,c=o._ratio.blurRatio||r;return o._forceGeometryBuffer?i.enableGeometryBufferRenderer():i.enablePrePassRenderer(),o._createRandomTexture(),o._originalColorPostProcess=new Z("SSAOOriginalSceneColor",1,null,_.BILINEAR_SAMPLINGMODE,i.getEngine(),void 0,s),o._originalColorPostProcess.samples=o.textureSamples,o._createSSAOPostProcess(1,s),o._createBlurPostProcess(u,c,s),o._createSSAOCombinePostProcess(c,s),o.addEffect(new b(i.getEngine(),o.SSAOOriginalSceneColorEffect,function(){return o._originalColorPostProcess},!0)),o.addEffect(new b(i.getEngine(),o.SSAORenderEffect,function(){return o._ssaoPostProcess},!0)),o.addEffect(new b(i.getEngine(),o.SSAOBlurHRenderEffect,function(){return o._blurHPostProcess},!0)),o.addEffect(new b(i.getEngine(),o.SSAOBlurVRenderEffect,function(){return o._blurVPostProcess},!0)),o.addEffect(new b(i.getEngine(),o.SSAOCombineRenderEffect,function(){return o._ssaoCombinePostProcess},!0)),i.postProcessRenderPipelineManager.addPipeline(o),n&&i.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,n),o}return Object.defineProperty(t.prototype,"samples",{get:function(){return this._samples},set:function(e){this._samples=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"textureSamples",{get:function(){return this._textureSamples},set:function(e){this._textureSamples=e,this._prePassRenderer?this._prePassRenderer.samples=e:this._originalColorPostProcess.samples=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_geometryBufferRenderer",{get:function(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_prePassRenderer",{get:function(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"expensiveBlur",{get:function(){return this._expensiveBlur},set:function(e){this._blurHPostProcess.updateEffect(`#define BILATERAL_BLUR
#define BILATERAL_BLUR_H
#define SAMPLES 16
#define EXPENSIVE `+(e?"1":"0")+`
`,null,["textureSampler","depthSampler"]),this._blurVPostProcess.updateEffect(`#define BILATERAL_BLUR
#define SAMPLES 16
#define EXPENSIVE `+(e?"1":"0")+`
`,null,["textureSampler","depthSampler"]),this._expensiveBlur=e},enumerable:!1,configurable:!0}),Object.defineProperty(t,"IsSupported",{get:function(){var e=X.LastCreatedEngine;return e?e._features.supportSSAO2:!1},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"SSAO2RenderingPipeline"},t.prototype.dispose=function(e){e===void 0&&(e=!1);for(var i=0;i<this._scene.cameras.length;i++){var r=this._scene.cameras[i];this._originalColorPostProcess.dispose(r),this._ssaoPostProcess.dispose(r),this._blurHPostProcess.dispose(r),this._blurVPostProcess.dispose(r),this._ssaoCombinePostProcess.dispose(r)}this._randomTexture.dispose(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),l.prototype.dispose.call(this)},t.prototype._createBlurPostProcess=function(e,i,r){var n=this;this._samplerOffsets=[];for(var a=this.expensiveBlur,s=-8;s<8;s++)this._samplerOffsets.push(s*2+.5);this._blurHPostProcess=new v("BlurH","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],e,null,_.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,`#define BILATERAL_BLUR
#define BILATERAL_BLUR_H
#define SAMPLES 16
#define EXPENSIVE `+(a?"1":"0")+`
`,r),this._blurHPostProcess.onApply=function(o){!n._scene.activeCamera||(o.setFloat("outSize",n._ssaoCombinePostProcess.width>0?n._ssaoCombinePostProcess.width:n._originalColorPostProcess.width),o.setFloat("near",n._scene.activeCamera.minZ),o.setFloat("far",n._scene.activeCamera.maxZ),o.setFloat("radius",n.radius),n._geometryBufferRenderer?o.setTexture("depthSampler",n._geometryBufferRenderer.getGBuffer().textures[0]):n._prePassRenderer&&o.setTexture("depthSampler",n._prePassRenderer.getRenderTarget().textures[n._prePassRenderer.getIndex(5)]),o.setArray("samplerOffsets",n._samplerOffsets))},this._blurVPostProcess=new v("BlurV","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],i,null,_.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,`#define BILATERAL_BLUR
#define BILATERAL_BLUR_V
#define SAMPLES 16
#define EXPENSIVE `+(a?"1":"0")+`
`,r),this._blurVPostProcess.onApply=function(o){!n._scene.activeCamera||(o.setFloat("outSize",n._ssaoCombinePostProcess.height>0?n._ssaoCombinePostProcess.height:n._originalColorPostProcess.height),o.setFloat("near",n._scene.activeCamera.minZ),o.setFloat("far",n._scene.activeCamera.maxZ),o.setFloat("radius",n.radius),n._geometryBufferRenderer?o.setTexture("depthSampler",n._geometryBufferRenderer.getGBuffer().textures[0]):n._prePassRenderer&&o.setTexture("depthSampler",n._prePassRenderer.getRenderTarget().textures[n._prePassRenderer.getIndex(5)]),o.setArray("samplerOffsets",n._samplerOffsets))},this._blurHPostProcess.samples=this.textureSamples,this._blurVPostProcess.samples=this.textureSamples},t.prototype._rebuild=function(){l.prototype._rebuild.call(this)},t.prototype._radicalInverse_VdC=function(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(this._bits[0]&1431655765)<<1|(this._bits[0]&2863311530)>>>1>>>0,this._bits[0]=(this._bits[0]&858993459)<<2|(this._bits[0]&3435973836)>>>2>>>0,this._bits[0]=(this._bits[0]&252645135)<<4|(this._bits[0]&4042322160)>>>4>>>0,this._bits[0]=(this._bits[0]&16711935)<<8|(this._bits[0]&4278255360)>>>8>>>0,this._bits[0]*23283064365386963e-26},t.prototype._hammersley=function(e,i){return[e/i,this._radicalInverse_VdC(e)]},t.prototype._hemisphereSample_uniform=function(e,i){var r=i*2*Math.PI,n=1-(e*.85+.15),a=Math.sqrt(1-n*n);return new D(Math.cos(r)*a,Math.sin(r)*a,n)},t.prototype._generateHemisphere=function(){for(var e=this.samples,i=[],r,n=0;n<e;){if(e<16)r=this._hemisphereSample_uniform(Math.random(),Math.random());else{var a=this._hammersley(n,e);r=this._hemisphereSample_uniform(a[0],a[1])}i.push(r.x,r.y,r.z),n++}return i},t.prototype._getDefinesForSSAO=function(){var e="#define SAMPLES "+this.samples+`
#define SSAO`;return e},t.prototype._createSSAOPostProcess=function(e,i){var r=this;this._sampleSphere=this._generateHemisphere();var n=this._getDefinesForSSAO(),a=["randomSampler","depthSampler","normalSampler"];this._ssaoPostProcess=new v("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","far","texelSize","xViewport","yViewport","maxZ","minZAspect","depthProjection"],a,e,null,_.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,n,i),this._ssaoPostProcess.onApply=function(s){var o,u,c,h;if(!!r._scene.activeCamera){if(s.setArray3("sampleSphere",r._sampleSphere),s.setFloat("randTextureTiles",32),s.setFloat("samplesFactor",1/r.samples),s.setFloat("totalStrength",r.totalStrength),s.setFloat2("texelSize",1/r._ssaoPostProcess.width,1/r._ssaoPostProcess.height),s.setFloat("radius",r.radius),s.setFloat("maxZ",r.maxZ),s.setFloat("minZAspect",r.minZAspect),s.setFloat("base",r.base),s.setFloat("near",r._scene.activeCamera.minZ),s.setFloat("far",r._scene.activeCamera.maxZ),r._scene.activeCamera.mode===Le.PERSPECTIVE_CAMERA)s.setMatrix3x3("depthProjection",t.PERSPECTIVE_DEPTH_PROJECTION),s.setFloat("xViewport",Math.tan(r._scene.activeCamera.fov/2)*r._scene.getEngine().getAspectRatio(r._scene.activeCamera,!0)),s.setFloat("yViewport",Math.tan(r._scene.activeCamera.fov/2));else{var f=r._scene.getEngine().getRenderWidth()/2,g=r._scene.getEngine().getRenderHeight()/2,m=(o=r._scene.activeCamera.orthoLeft)!==null&&o!==void 0?o:-f,P=(u=r._scene.activeCamera.orthoRight)!==null&&u!==void 0?u:f,S=(c=r._scene.activeCamera.orthoBottom)!==null&&c!==void 0?c:-g,E=(h=r._scene.activeCamera.orthoTop)!==null&&h!==void 0?h:g;s.setMatrix3x3("depthProjection",t.ORTHO_DEPTH_PROJECTION),s.setFloat("xViewport",(P-m)*.5),s.setFloat("yViewport",(E-S)*.5)}s.setMatrix("projection",r._scene.getProjectionMatrix()),r._geometryBufferRenderer?(s.setTexture("depthSampler",r._geometryBufferRenderer.getGBuffer().textures[0]),s.setTexture("normalSampler",r._geometryBufferRenderer.getGBuffer().textures[1])):r._prePassRenderer&&(s.setTexture("depthSampler",r._prePassRenderer.getRenderTarget().textures[r._prePassRenderer.getIndex(5)]),s.setTexture("normalSampler",r._prePassRenderer.getRenderTarget().textures[r._prePassRenderer.getIndex(6)])),s.setTexture("randomSampler",r._randomTexture)}},this._ssaoPostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoPostProcess._prePassEffectConfiguration=new Me)},t.prototype._createSSAOCombinePostProcess=function(e,i){var r=this;this._ssaoCombinePostProcess=new v("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,_.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,void 0,i),this._ssaoCombinePostProcess.onApply=function(n){var a=r._scene.activeCamera.viewport;n.setVector4("viewport",ie.Vector4[0].copyFromFloats(a.x,a.y,a.width,a.height)),n.setTextureFromPostProcessOutput("originalColor",r._originalColorPostProcess)},this._ssaoCombinePostProcess.samples=this.textureSamples},t.prototype._createRandomTexture=function(){var e=128;this._randomTexture=new Q("SSAORandomTexture",e,this._scene,!1,_.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=_.WRAP_ADDRESSMODE,this._randomTexture.wrapV=_.WRAP_ADDRESSMODE;for(var i=this._randomTexture.getContext(),r=function(o,u){return Math.random()*(u-o)+o},n=D.Zero(),a=0;a<e;a++)for(var s=0;s<e;s++)n.x=r(0,1),n.y=r(0,1),n.z=0,n.normalize(),n.scaleInPlace(255),n.x=Math.floor(n.x),n.y=Math.floor(n.y),i.fillStyle="rgb("+n.x+", "+n.y+", "+n.z+")",i.fillRect(a,s,1,1);this._randomTexture.update(!1)},t.prototype.serialize=function(){var e=O.Serialize(this);return e.customType="SSAO2RenderingPipeline",e},t.Parse=function(e,i,r){return O.Parse(function(){return new t(e._name,i,e._ratio)},e,i,r)},t.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1],t.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1],d([p()],t.prototype,"totalStrength",void 0),d([p()],t.prototype,"maxZ",void 0),d([p()],t.prototype,"minZAspect",void 0),d([p("samples")],t.prototype,"_samples",void 0),d([p("textureSamples")],t.prototype,"_textureSamples",void 0),d([p()],t.prototype,"_ratio",void 0),d([p("expensiveBlur")],t.prototype,"_expensiveBlur",void 0),d([p()],t.prototype,"radius",void 0),d([p()],t.prototype,"base",void 0),t}(W);A("BABYLON.SSAO2RenderingPipeline",Ke);(function(l){y(t,l);function t(e,i,r,n){var a=l.call(this,i.getEngine(),e)||this;a.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",a.SSAORenderEffect="SSAORenderEffect",a.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",a.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",a.SSAOCombineRenderEffect="SSAOCombineRenderEffect",a.totalStrength=1,a.radius=1e-4,a.area=.0075,a.fallOff=1e-6,a.base=.5,a._firstUpdate=!0,a._scene=i,a._createRandomTexture();var s=r.ssaoRatio||r,o=r.combineRatio||r;return a._originalColorPostProcess=new Z("SSAOOriginalSceneColor",o,null,_.BILINEAR_SAMPLINGMODE,i.getEngine(),!1),a._createSSAOPostProcess(s),a._createBlurPostProcess(s),a._createSSAOCombinePostProcess(o),a.addEffect(new b(i.getEngine(),a.SSAOOriginalSceneColorEffect,function(){return a._originalColorPostProcess},!0)),a.addEffect(new b(i.getEngine(),a.SSAORenderEffect,function(){return a._ssaoPostProcess},!0)),a.addEffect(new b(i.getEngine(),a.SSAOBlurHRenderEffect,function(){return a._blurHPostProcess},!0)),a.addEffect(new b(i.getEngine(),a.SSAOBlurVRenderEffect,function(){return a._blurVPostProcess},!0)),a.addEffect(new b(i.getEngine(),a.SSAOCombineRenderEffect,function(){return a._ssaoCombinePostProcess},!0)),i.postProcessRenderPipelineManager.addPipeline(a),n&&i.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,n),a}return Object.defineProperty(t.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),t.prototype._attachCameras=function(e,i){l.prototype._attachCameras.call(this,e,i);for(var r=0,n=this._cameras;r<n.length;r++){var a=n[r];this._scene.enableDepthRenderer(a).getDepthMap()}},t.prototype.getClassName=function(){return"SSAORenderingPipeline"},t.prototype.dispose=function(e){e===void 0&&(e=!1);for(var i=0;i<this._scene.cameras.length;i++){var r=this._scene.cameras[i];this._originalColorPostProcess.dispose(r),this._ssaoPostProcess.dispose(r),this._blurHPostProcess.dispose(r),this._blurVPostProcess.dispose(r),this._ssaoCombinePostProcess.dispose(r)}this._randomTexture.dispose(),e&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),l.prototype.dispose.call(this)},t.prototype._createBlurPostProcess=function(e){var i=this,r=16;this._blurHPostProcess=new j("BlurH",new R(1,0),r,e,null,_.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurVPostProcess=new j("BlurV",new R(0,1),r,e,null,_.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurHPostProcess.onActivateObservable.add(function(){var n=i._blurHPostProcess.width/i._scene.getEngine().getRenderWidth();i._blurHPostProcess.kernel=r*n}),this._blurVPostProcess.onActivateObservable.add(function(){var n=i._blurVPostProcess.height/i._scene.getEngine().getRenderHeight();i._blurVPostProcess.kernel=r*n})},t.prototype._rebuild=function(){this._firstUpdate=!0,l.prototype._rebuild.call(this)},t.prototype._createSSAOPostProcess=function(e){var i=this,r=16,n=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271],a=1/r;this._ssaoPostProcess=new v("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],e,null,_.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define SAMPLES "+r+`
#define SSAO`),this._ssaoPostProcess.externalTextureSamplerBinding=!0,this._ssaoPostProcess.onApply=function(s){i._firstUpdate&&(s.setArray3("sampleSphere",n),s.setFloat("samplesFactor",a),s.setFloat("randTextureTiles",4)),s.setFloat("totalStrength",i.totalStrength),s.setFloat("radius",i.radius),s.setFloat("area",i.area),s.setFloat("fallOff",i.fallOff),s.setFloat("base",i.base),s.setTexture("textureSampler",i._scene.enableDepthRenderer(i._scene.activeCamera).getDepthMap()),s.setTexture("randomSampler",i._randomTexture)}},t.prototype._createSSAOCombinePostProcess=function(e){var i=this;this._ssaoCombinePostProcess=new v("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,_.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=function(r){r.setVector4("viewport",ie.Vector4[0].copyFromFloats(0,0,1,1)),r.setTextureFromPostProcess("originalColor",i._originalColorPostProcess)}},t.prototype._createRandomTexture=function(){var e=512;this._randomTexture=new Q("SSAORandomTexture",e,this._scene,!1,_.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=_.WRAP_ADDRESSMODE,this._randomTexture.wrapV=_.WRAP_ADDRESSMODE;for(var i=this._randomTexture.getContext(),r=function(o,u){return Math.random()*(u-o)+o},n=D.Zero(),a=0;a<e;a++)for(var s=0;s<e;s++)n.x=Math.floor(r(-1,1)*255),n.y=Math.floor(r(-1,1)*255),n.z=Math.floor(r(-1,1)*255),i.fillStyle="rgb("+n.x+", "+n.y+", "+n.z+")",i.fillRect(a,s,1,1);this._randomTexture.update(!1)},d([p()],t.prototype,"totalStrength",void 0),d([p()],t.prototype,"radius",void 0),d([p()],t.prototype,"area",void 0),d([p()],t.prototype,"fallOff",void 0),d([p()],t.prototype,"base",void 0),t})(W);var he=function(l){y(t,l);function t(e,i,r,n,a,s,o,u,c,h){u===void 0&&(u=0),c===void 0&&(c=!1),h===void 0&&(h=!1);var f=l.call(this,e,"screenSpaceReflection",["projection","view","threshold","reflectionSpecularFalloffExponent","strength","stepSize","roughnessFactor"],["textureSampler","normalSampler","positionSampler","reflectivitySampler"],r,n,a,s,o,`#define SSR_SUPPORTED
#define REFLECTION_SAMPLES 64
#define SMOOTH_STEPS 5
`,u,void 0,null,c)||this;if(f.threshold=1.2,f.strength=1,f.reflectionSpecularFalloffExponent=3,f.step=1,f.roughnessFactor=.2,f._forceGeometryBuffer=!1,f._enableSmoothReflections=!1,f._reflectionSamples=64,f._smoothSteps=5,f._forceGeometryBuffer=h,f._forceGeometryBuffer){var g=i.enableGeometryBufferRenderer();g&&g.isSupported&&(g.enablePosition=!0,g.enableReflectivity=!0)}else{var m=i.enablePrePassRenderer();m==null||m.markAsDirty(),f._prePassEffectConfiguration=new Fe}return f._updateEffectDefines(),f.onApply=function(P){var S=f._geometryBufferRenderer,E=f._prePassRenderer;if(!(!E&&!S)){if(S){var C=S.getTextureIndex(Y.POSITION_TEXTURE_TYPE),x=S.getTextureIndex(Y.REFLECTIVITY_TEXTURE_TYPE);P.setTexture("normalSampler",S.getGBuffer().textures[1]),P.setTexture("positionSampler",S.getGBuffer().textures[C]),P.setTexture("reflectivitySampler",S.getGBuffer().textures[x])}else if(E){var C=E.getIndex(1),x=E.getIndex(3),T=E.getIndex(6);P.setTexture("normalSampler",E.getRenderTarget().textures[T]),P.setTexture("positionSampler",E.getRenderTarget().textures[C]),P.setTexture("reflectivitySampler",E.getRenderTarget().textures[x])}var M=i.activeCamera;if(!!M){var w=M.getViewMatrix(!0),B=M.getProjectionMatrix(!0);P.setMatrix("projection",B),P.setMatrix("view",w),P.setFloat("threshold",f.threshold),P.setFloat("reflectionSpecularFalloffExponent",f.reflectionSpecularFalloffExponent),P.setFloat("strength",f.strength),P.setFloat("stepSize",f.step),P.setFloat("roughnessFactor",f.roughnessFactor)}}},f._isSceneRightHanded=i.useRightHandedSystem,f}return Object.defineProperty(t.prototype,"_geometryBufferRenderer",{get:function(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_prePassRenderer",{get:function(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"ScreenSpaceReflectionPostProcess"},Object.defineProperty(t.prototype,"enableSmoothReflections",{get:function(){return this._enableSmoothReflections},set:function(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"reflectionSamples",{get:function(){return this._reflectionSamples},set:function(e){e!==this._reflectionSamples&&(this._reflectionSamples=e,this._updateEffectDefines())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"smoothSteps",{get:function(){return this._smoothSteps},set:function(e){e!==this._smoothSteps&&(this._smoothSteps=e,this._updateEffectDefines())},enumerable:!1,configurable:!0}),t.prototype._updateEffectDefines=function(){var e=[];(this._geometryBufferRenderer||this._prePassRenderer)&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define ENABLE_SMOOTH_REFLECTIONS"),this._isSceneRightHanded&&e.push("#define RIGHT_HANDED_SCENE"),e.push("#define REFLECTION_SAMPLES "+(this._reflectionSamples>>0)),e.push("#define SMOOTH_STEPS "+(this._smoothSteps>>0)),this.updateEffect(e.join(`
`))},t._Parse=function(e,i,r,n){return O.Parse(function(){return new t(e.name,r,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.textureType,e.reusable)},e,r,n)},d([p()],t.prototype,"threshold",void 0),d([p()],t.prototype,"strength",void 0),d([p()],t.prototype,"reflectionSpecularFalloffExponent",void 0),d([p()],t.prototype,"step",void 0),d([p()],t.prototype,"roughnessFactor",void 0),d([p()],t.prototype,"enableSmoothReflections",null),d([p()],t.prototype,"reflectionSamples",null),d([p()],t.prototype,"smoothSteps",null),t}(v);A("BABYLON.ScreenSpaceReflectionPostProcess",he);var Je=function(l){y(t,l);function t(e,i,r,n,a){n===void 0&&(n=null);var s=l.call(this,i.getEngine(),e)||this;return s.downSampleX4PostProcess=null,s.brightPassPostProcess=null,s.blurHPostProcesses=[],s.blurVPostProcesses=[],s.textureAdderPostProcess=null,s.volumetricLightPostProcess=null,s.volumetricLightSmoothXPostProcess=null,s.volumetricLightSmoothYPostProcess=null,s.volumetricLightMergePostProces=null,s.volumetricLightFinalPostProcess=null,s.luminancePostProcess=null,s.luminanceDownSamplePostProcesses=[],s.hdrPostProcess=null,s.textureAdderFinalPostProcess=null,s.lensFlareFinalPostProcess=null,s.hdrFinalPostProcess=null,s.lensFlarePostProcess=null,s.lensFlareComposePostProcess=null,s.motionBlurPostProcess=null,s.depthOfFieldPostProcess=null,s.fxaaPostProcess=null,s.screenSpaceReflectionPostProcess=null,s.brightThreshold=1,s.blurWidth=512,s.horizontalBlur=!1,s.lensTexture=null,s.volumetricLightCoefficient=.2,s.volumetricLightPower=4,s.volumetricLightBlurScale=64,s.sourceLight=null,s.hdrMinimumLuminance=1,s.hdrDecreaseRate=.5,s.hdrIncreaseRate=.5,s.lensColorTexture=null,s.lensFlareStrength=20,s.lensFlareGhostDispersal=1.4,s.lensFlareHaloWidth=.7,s.lensFlareDistortionStrength=16,s.lensFlareBlurWidth=512,s.lensStarTexture=null,s.lensFlareDirtTexture=null,s.depthOfFieldDistance=10,s.depthOfFieldBlurWidth=64,s.animations=[],s._currentDepthOfFieldSource=null,s._fixedExposure=1,s._currentExposure=1,s._hdrAutoExposure=!1,s._hdrCurrentLuminance=1,s._motionStrength=1,s._isObjectBasedMotionBlur=!1,s._camerasToBeAttached=[],s._bloomEnabled=!1,s._depthOfFieldEnabled=!1,s._vlsEnabled=!1,s._lensFlareEnabled=!1,s._hdrEnabled=!1,s._motionBlurEnabled=!1,s._fxaaEnabled=!1,s._screenSpaceReflectionsEnabled=!1,s._motionBlurSamples=64,s._volumetricLightStepsCount=50,s._samples=1,s._cameras=a||i.cameras,s._cameras=s._cameras.slice(),s._camerasToBeAttached=s._cameras.slice(),s._scene=i,s._basePostProcess=n,s._ratio=r,s._floatTextureType=i.getEngine().getCaps().textureFloatRender?1:2,i.postProcessRenderPipelineManager.addPipeline(s),s._buildPipeline(),s}return Object.defineProperty(t.prototype,"exposure",{get:function(){return this._fixedExposure},set:function(e){this._fixedExposure=e,this._currentExposure=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hdrAutoExposure",{get:function(){return this._hdrAutoExposure},set:function(e){if(this._hdrAutoExposure=e,this.hdrPostProcess){var i=["#define HDR"];e&&i.push("#define AUTO_EXPOSURE"),this.hdrPostProcess.updateEffect(i.join(`
`))}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"motionStrength",{get:function(){return this._motionStrength},set:function(e){this._motionStrength=e,this._isObjectBasedMotionBlur&&this.motionBlurPostProcess&&(this.motionBlurPostProcess.motionStrength=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"objectBasedMotionBlur",{get:function(){return this._isObjectBasedMotionBlur},set:function(e){var i=this._isObjectBasedMotionBlur!==e;this._isObjectBasedMotionBlur=e,i&&this._buildPipeline()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"BloomEnabled",{get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"DepthOfFieldEnabled",{get:function(){return this._depthOfFieldEnabled},set:function(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"LensFlareEnabled",{get:function(){return this._lensFlareEnabled},set:function(e){this._lensFlareEnabled!==e&&(this._lensFlareEnabled=e,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"HDREnabled",{get:function(){return this._hdrEnabled},set:function(e){this._hdrEnabled!==e&&(this._hdrEnabled=e,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"VLSEnabled",{get:function(){return this._vlsEnabled},set:function(e){if(this._vlsEnabled!==e){if(e){var i=this._scene.enableGeometryBufferRenderer();if(!i){L.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline");return}}this._vlsEnabled=e,this._buildPipeline()}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"MotionBlurEnabled",{get:function(){return this._motionBlurEnabled},set:function(e){this._motionBlurEnabled!==e&&(this._motionBlurEnabled=e,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fxaaEnabled",{get:function(){return this._fxaaEnabled},set:function(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"screenSpaceReflectionsEnabled",{get:function(){return this._screenSpaceReflectionsEnabled},set:function(e){this._screenSpaceReflectionsEnabled!==e&&(this._screenSpaceReflectionsEnabled=e,this._buildPipeline())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"volumetricLightStepsCount",{get:function(){return this._volumetricLightStepsCount},set:function(e){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect(`#define VLS
#define NB_STEPS `+e.toFixed(1)),this._volumetricLightStepsCount=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"motionBlurSamples",{get:function(){return this._motionBlurSamples},set:function(e){this.motionBlurPostProcess&&(this._isObjectBasedMotionBlur?this.motionBlurPostProcess.motionBlurSamples=e:this.motionBlurPostProcess.updateEffect(`#define MOTION_BLUR
#define MAX_MOTION_SAMPLES `+e.toFixed(1))),this._motionBlurSamples=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"samples",{get:function(){return this._samples},set:function(e){this._samples!==e&&(this._samples=e,this._buildPipeline())},enumerable:!1,configurable:!0}),t.prototype._buildPipeline=function(){var e=this,i=this._ratio,r=this._scene;this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._screenSpaceReflectionsEnabled&&(this.screenSpaceReflectionPostProcess=new he("HDRPass",r,i,null,_.BILINEAR_SAMPLINGMODE,r.getEngine(),!1,this._floatTextureType),this.screenSpaceReflectionPostProcess.onApplyObservable.add(function(){e._currentDepthOfFieldSource=e.screenSpaceReflectionPostProcess}),this.addEffect(new b(r.getEngine(),"HDRScreenSpaceReflections",function(){return e.screenSpaceReflectionPostProcess},!0))),this._basePostProcess?this.originalPostProcess=this._basePostProcess:this.originalPostProcess=new v("HDRPass","standard",[],[],i,null,_.BILINEAR_SAMPLINGMODE,r.getEngine(),!1,"#define PASS_POST_PROCESS",this._floatTextureType),this.originalPostProcess.autoClear=!this.screenSpaceReflectionPostProcess,this.originalPostProcess.onApplyObservable.add(function(){e._currentDepthOfFieldSource=e.originalPostProcess}),this.addEffect(new b(r.getEngine(),"HDRPassPostProcess",function(){return e.originalPostProcess},!0)),this._bloomEnabled&&(this._createDownSampleX4PostProcess(r,i/4),this._createBrightPassPostProcess(r,i/4),this._createBlurPostProcesses(r,i/4,1),this._createTextureAdderPostProcess(r,i),this.textureAdderFinalPostProcess=new v("HDRDepthOfFieldSource","standard",[],[],i,null,_.BILINEAR_SAMPLINGMODE,r.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new b(r.getEngine(),"HDRBaseDepthOfFieldSource",function(){return e.textureAdderFinalPostProcess},!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(r,i),this.volumetricLightFinalPostProcess=new v("HDRVLSFinal","standard",[],[],i,null,_.BILINEAR_SAMPLINGMODE,r.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new b(r.getEngine(),"HDRVLSFinal",function(){return e.volumetricLightFinalPostProcess},!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(r,i),this.lensFlareFinalPostProcess=new v("HDRPostLensFlareDepthOfFieldSource","standard",[],[],i,null,_.BILINEAR_SAMPLINGMODE,r.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new b(r.getEngine(),"HDRPostLensFlareDepthOfFieldSource",function(){return e.lensFlareFinalPostProcess},!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(r,this._floatTextureType),this._createHdrPostProcess(r,i),this.hdrFinalPostProcess=new v("HDRPostHDReDepthOfFieldSource","standard",[],[],i,null,_.BILINEAR_SAMPLINGMODE,r.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new b(r.getEngine(),"HDRPostHDReDepthOfFieldSource",function(){return e.hdrFinalPostProcess},!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(r,i/2,3,"depthOfFieldBlurWidth"),this._createDepthOfFieldPostProcess(r,i)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(r,i),this._fxaaEnabled&&(this.fxaaPostProcess=new $("fxaa",1,null,_.BILINEAR_SAMPLINGMODE,r.getEngine(),!1,0),this.addEffect(new b(r.getEngine(),"HDRFxaa",function(){return e.fxaaPostProcess},!0))),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this._samples)&&this._samples>1&&L.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")},t.prototype._createDownSampleX4PostProcess=function(e,i){var r=this,n=new Array(32);this.downSampleX4PostProcess=new v("HDRDownSampleX4","standard",["dsOffsets"],[],i,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DOWN_SAMPLE_X4",this._floatTextureType),this.downSampleX4PostProcess.onApply=function(a){for(var s=0,o=r.downSampleX4PostProcess.width,u=r.downSampleX4PostProcess.height,c=-2;c<2;c++)for(var h=-2;h<2;h++)n[s]=(c+.5)*(1/o),n[s+1]=(h+.5)*(1/u),s+=2;a.setArray2("dsOffsets",n)},this.addEffect(new b(e.getEngine(),"HDRDownSampleX4",function(){return r.downSampleX4PostProcess},!0))},t.prototype._createBrightPassPostProcess=function(e,i){var r=this,n=new Array(8);this.brightPassPostProcess=new v("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],i,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define BRIGHT_PASS",this._floatTextureType),this.brightPassPostProcess.onApply=function(a){var s=1/r.brightPassPostProcess.width,o=1/r.brightPassPostProcess.height;n[0]=-.5*s,n[1]=.5*o,n[2]=.5*s,n[3]=.5*o,n[4]=-.5*s,n[5]=-.5*o,n[6]=.5*s,n[7]=-.5*o,a.setArray2("dsOffsets",n),a.setFloat("brightThreshold",r.brightThreshold)},this.addEffect(new b(e.getEngine(),"HDRBrightPass",function(){return r.brightPassPostProcess},!0))},t.prototype._createBlurPostProcesses=function(e,i,r,n){var a=this;n===void 0&&(n="blurWidth");var s=e.getEngine(),o=new j("HDRBlurH_"+r,new R(1,0),this[n],i,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType),u=new j("HDRBlurV_"+r,new R(0,1),this[n],i,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType);o.onActivateObservable.add(function(){var c=o.width/s.getRenderWidth();o.kernel=a[n]*c}),u.onActivateObservable.add(function(){var c=u.height/s.getRenderHeight();u.kernel=a.horizontalBlur?64*c:a[n]*c}),this.addEffect(new b(e.getEngine(),"HDRBlurH"+r,function(){return o},!0)),this.addEffect(new b(e.getEngine(),"HDRBlurV"+r,function(){return u},!0)),this.blurHPostProcesses.push(o),this.blurVPostProcesses.push(u)},t.prototype._createTextureAdderPostProcess=function(e,i){var r=this;this.textureAdderPostProcess=new v("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],i,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define TEXTURE_ADDER",this._floatTextureType),this.textureAdderPostProcess.onApply=function(n){n.setTextureFromPostProcess("otherSampler",r._vlsEnabled?r._currentDepthOfFieldSource:r.originalPostProcess),n.setTexture("lensSampler",r.lensTexture),n.setFloat("exposure",r._currentExposure),r._currentDepthOfFieldSource=r.textureAdderFinalPostProcess},this.addEffect(new b(e.getEngine(),"HDRTextureAdder",function(){return r.textureAdderPostProcess},!0))},t.prototype._createVolumetricLightPostProcess=function(e,i){var r=this,n=e.enableGeometryBufferRenderer();n.enablePosition=!0;var a=n.getGBuffer();this.volumetricLightPostProcess=new v("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],i/8,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,`#define VLS
#define NB_STEPS `+this._volumetricLightStepsCount.toFixed(1));var s=R.Zero();this.volumetricLightPostProcess.onApply=function(o){if(r.sourceLight&&r.sourceLight.getShadowGenerator()&&r._scene.activeCamera){var u=r.sourceLight.getShadowGenerator();o.setTexture("shadowMapSampler",u.getShadowMap()),o.setTexture("positionSampler",a.textures[2]),o.setColor3("sunColor",r.sourceLight.diffuse),o.setVector3("sunDirection",r.sourceLight.getShadowDirection()),o.setVector3("cameraPosition",r._scene.activeCamera.globalPosition),o.setMatrix("shadowViewProjection",u.getTransformMatrix()),o.setFloat("scatteringCoefficient",r.volumetricLightCoefficient),o.setFloat("scatteringPower",r.volumetricLightPower),s.x=r.sourceLight.getDepthMinZ(r._scene.activeCamera),s.y=r.sourceLight.getDepthMaxZ(r._scene.activeCamera),o.setVector2("depthValues",s)}},this.addEffect(new b(e.getEngine(),"HDRVLS",function(){return r.volumetricLightPostProcess},!0)),this._createBlurPostProcesses(e,i/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new v("HDRVLSMerge","standard",[],["originalSampler"],i,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=function(o){o.setTextureFromPostProcess("originalSampler",r._bloomEnabled?r.textureAdderFinalPostProcess:r.originalPostProcess),r._currentDepthOfFieldSource=r.volumetricLightFinalPostProcess},this.addEffect(new b(e.getEngine(),"HDRVLSMerge",function(){return r.volumetricLightMergePostProces},!0))},t.prototype._createLuminancePostProcesses=function(e,i){var r=this,n=Math.pow(3,t.LuminanceSteps);this.luminancePostProcess=new v("HDRLuminance","standard",["lumOffsets"],[],{width:n,height:n},null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LUMINANCE",i);var a=[];this.luminancePostProcess.onApply=function(h){var f=1/r.luminancePostProcess.width,g=1/r.luminancePostProcess.height;a[0]=-.5*f,a[1]=.5*g,a[2]=.5*f,a[3]=.5*g,a[4]=-.5*f,a[5]=-.5*g,a[6]=.5*f,a[7]=-.5*g,h.setArray2("lumOffsets",a)},this.addEffect(new b(e.getEngine(),"HDRLuminance",function(){return r.luminancePostProcess},!0));for(var s=t.LuminanceSteps-1;s>=0;s--){n=Math.pow(3,s);var o=`#define LUMINANCE_DOWN_SAMPLE
`;s===0&&(o+="#define FINAL_DOWN_SAMPLER");var u=new v("HDRLuminanceDownSample"+s,"standard",["dsOffsets","halfDestPixelSize"],[],{width:n,height:n},null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,o,i);this.luminanceDownSamplePostProcesses.push(u)}var c=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach(function(h,f){var g=new Array(18);h.onApply=function(m){if(!!c){for(var P=0,S=-1;S<2;S++)for(var E=-1;E<2;E++)g[P]=S/c.width,g[P+1]=E/c.height,P+=2;m.setArray2("dsOffsets",g),m.setFloat("halfDestPixelSize",.5/c.width),f===r.luminanceDownSamplePostProcesses.length-1?c=r.luminancePostProcess:c=h}},f===r.luminanceDownSamplePostProcesses.length-1&&(h.onAfterRender=function(){var m=e.getEngine().readPixels(0,0,1,1),P=new be(1/(255*255*255),1/(255*255),1/255,1);m.then(function(S){var E=new Uint8Array(S.buffer);r._hdrCurrentLuminance=(E[0]*P.x+E[1]*P.y+E[2]*P.z+E[3]*P.w)/100})}),r.addEffect(new b(e.getEngine(),"HDRLuminanceDownSample"+f,function(){return h},!0))})},t.prototype._createHdrPostProcess=function(e,i){var r=this,n=["#define HDR"];this._hdrAutoExposure&&n.push("#define AUTO_EXPOSURE"),this.hdrPostProcess=new v("HDR","standard",["averageLuminance"],["textureAdderSampler"],i,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n.join(`
`),0);var a=1,s=0,o=0;this.hdrPostProcess.onApply=function(u){if(u.setTextureFromPostProcess("textureAdderSampler",r._currentDepthOfFieldSource),s+=e.getEngine().getDeltaTime(),a<0)a=r._hdrCurrentLuminance;else{var c=(o-s)/1e3;r._hdrCurrentLuminance<a+r.hdrDecreaseRate*c?a+=r.hdrDecreaseRate*c:r._hdrCurrentLuminance>a-r.hdrIncreaseRate*c?a-=r.hdrIncreaseRate*c:a=r._hdrCurrentLuminance}r.hdrAutoExposure?r._currentExposure=r._fixedExposure/a:(a=ve.Clamp(a,r.hdrMinimumLuminance,1e20),u.setFloat("averageLuminance",a)),o=s,r._currentDepthOfFieldSource=r.hdrFinalPostProcess},this.addEffect(new b(e.getEngine(),"HDR",function(){return r.hdrPostProcess},!0))},t.prototype._createLensFlarePostProcess=function(e,i){var r=this;this.lensFlarePostProcess=new v("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],i/2,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE",0),this.addEffect(new b(e.getEngine(),"HDRLensFlare",function(){return r.lensFlarePostProcess},!0)),this._createBlurPostProcesses(e,i/4,2,"lensFlareBlurWidth"),this.lensFlareComposePostProcess=new v("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],i,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE_COMPOSE",0),this.addEffect(new b(e.getEngine(),"HDRLensFlareCompose",function(){return r.lensFlareComposePostProcess},!0));var n=new R(0,0);this.lensFlarePostProcess.externalTextureSamplerBinding=!0,this.lensFlarePostProcess.onApply=function(o){o.setTextureFromPostProcess("textureSampler",r._bloomEnabled?r.blurHPostProcesses[0]:r.originalPostProcess),o.setTexture("lensColorSampler",r.lensColorTexture),o.setFloat("strength",r.lensFlareStrength),o.setFloat("ghostDispersal",r.lensFlareGhostDispersal),o.setFloat("haloWidth",r.lensFlareHaloWidth),n.x=r.lensFlarePostProcess.width,n.y=r.lensFlarePostProcess.height,o.setVector2("resolution",n),o.setFloat("distortionStrength",r.lensFlareDistortionStrength)};var a=I.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),s=I.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=function(o){if(!!r._scene.activeCamera){o.setTextureFromPostProcess("otherSampler",r.lensFlarePostProcess),o.setTexture("lensDirtSampler",r.lensFlareDirtTexture),o.setTexture("lensStarSampler",r.lensStarTexture);var u=r._scene.activeCamera.getViewMatrix().getRow(0),c=r._scene.activeCamera.getViewMatrix().getRow(2),h=D.Dot(u.toVector3(),new D(1,0,0))+D.Dot(c.toVector3(),new D(0,0,1));h*=4;var f=I.FromValues(Math.cos(h)*.5,-Math.sin(h),0,0,Math.sin(h),Math.cos(h)*.5,0,0,0,0,1,0,0,0,0,1),g=s.multiply(f).multiply(a);o.setMatrix("lensStarMatrix",g),r._currentDepthOfFieldSource=r.lensFlareFinalPostProcess}}},t.prototype._createDepthOfFieldPostProcess=function(e,i){var r=this;this.depthOfFieldPostProcess=new v("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],i,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DEPTH_OF_FIELD",0),this.depthOfFieldPostProcess.onApply=function(n){n.setTextureFromPostProcess("otherSampler",r._currentDepthOfFieldSource),n.setTexture("depthSampler",r._getDepthTexture()),n.setFloat("distance",r.depthOfFieldDistance)},this.addEffect(new b(e.getEngine(),"HDRDepthOfField",function(){return r.depthOfFieldPostProcess},!0))},t.prototype._createMotionBlurPostProcess=function(e,i){var r=this;if(this._isObjectBasedMotionBlur){var n=new ue("HDRMotionBlur",e,i,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,0);n.motionStrength=this.motionStrength,n.motionBlurSamples=this.motionBlurSamples,this.motionBlurPostProcess=n}else{this.motionBlurPostProcess=new v("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],i,null,_.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,`#define MOTION_BLUR
#define MAX_MOTION_SAMPLES `+this.motionBlurSamples.toFixed(1),0);var a=0,s=I.Identity(),o=I.Identity(),u=I.Identity(),c=R.Zero();this.motionBlurPostProcess.onApply=function(h){u=e.getProjectionMatrix().multiply(e.getViewMatrix()),u.invertToRef(o),h.setMatrix("inverseViewProjection",o),h.setMatrix("prevViewProjection",s),s=u,c.x=r.motionBlurPostProcess.width,c.y=r.motionBlurPostProcess.height,h.setVector2("screenSize",c),a=e.getEngine().getFps()/60,h.setFloat("motionScale",a),h.setFloat("motionStrength",r.motionStrength),h.setTexture("depthSampler",r._getDepthTexture())}}this.addEffect(new b(e.getEngine(),"HDRMotionBlur",function(){return r.motionBlurPostProcess},!0))},t.prototype._getDepthTexture=function(){if(this._scene.getEngine().getCaps().drawBuffersExtension){var e=this._scene.enableGeometryBufferRenderer();return e.getGBuffer().textures[0]}return this._scene.enableDepthRenderer().getDepthMap()},t.prototype._disposePostProcesses=function(){for(var e=0;e<this._cameras.length;e++){var i=this._cameras[e];this.originalPostProcess&&this.originalPostProcess.dispose(i),this.screenSpaceReflectionPostProcess&&this.screenSpaceReflectionPostProcess.dispose(i),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(i),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(i),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(i),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(i),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(i),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(i),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(i),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(i),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(i),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(i);for(var r=0;r<this.luminanceDownSamplePostProcesses.length;r++)this.luminanceDownSamplePostProcesses[r].dispose(i);this.luminancePostProcess&&this.luminancePostProcess.dispose(i),this.hdrPostProcess&&this.hdrPostProcess.dispose(i),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(i),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(i),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(i),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(i);for(var r=0;r<this.blurHPostProcesses.length;r++)this.blurHPostProcesses[r].dispose(i);for(var r=0;r<this.blurVPostProcesses.length;r++)this.blurVPostProcesses[r].dispose(i)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.luminanceDownSamplePostProcesses.length=0,this.blurHPostProcesses.length=0,this.blurVPostProcesses.length=0},t.prototype.dispose=function(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),l.prototype.dispose.call(this)},t.prototype.serialize=function(){var e=O.Serialize(this);return this.sourceLight&&(e.sourceLightId=this.sourceLight.id),this.screenSpaceReflectionPostProcess&&(e.screenSpaceReflectionPostProcess=O.Serialize(this.screenSpaceReflectionPostProcess)),e.customType="StandardRenderingPipeline",e},t.Parse=function(e,i,r){var n=O.Parse(function(){return new t(e._name,i,e._ratio)},e,i,r);return e.sourceLightId&&(n.sourceLight=i.getLightById(e.sourceLightId)),e.screenSpaceReflectionPostProcess&&O.Parse(function(){return n.screenSpaceReflectionPostProcess},e.screenSpaceReflectionPostProcess,i,r),n},t.LuminanceSteps=6,d([p()],t.prototype,"brightThreshold",void 0),d([p()],t.prototype,"blurWidth",void 0),d([p()],t.prototype,"horizontalBlur",void 0),d([p()],t.prototype,"exposure",null),d([U("lensTexture")],t.prototype,"lensTexture",void 0),d([p()],t.prototype,"volumetricLightCoefficient",void 0),d([p()],t.prototype,"volumetricLightPower",void 0),d([p()],t.prototype,"volumetricLightBlurScale",void 0),d([p()],t.prototype,"hdrMinimumLuminance",void 0),d([p()],t.prototype,"hdrDecreaseRate",void 0),d([p()],t.prototype,"hdrIncreaseRate",void 0),d([p()],t.prototype,"hdrAutoExposure",null),d([U("lensColorTexture")],t.prototype,"lensColorTexture",void 0),d([p()],t.prototype,"lensFlareStrength",void 0),d([p()],t.prototype,"lensFlareGhostDispersal",void 0),d([p()],t.prototype,"lensFlareHaloWidth",void 0),d([p()],t.prototype,"lensFlareDistortionStrength",void 0),d([p()],t.prototype,"lensFlareBlurWidth",void 0),d([U("lensStarTexture")],t.prototype,"lensStarTexture",void 0),d([U("lensFlareDirtTexture")],t.prototype,"lensFlareDirtTexture",void 0),d([p()],t.prototype,"depthOfFieldDistance",void 0),d([p()],t.prototype,"depthOfFieldBlurWidth",void 0),d([p()],t.prototype,"motionStrength",null),d([p()],t.prototype,"objectBasedMotionBlur",null),d([p()],t.prototype,"_ratio",void 0),d([p()],t.prototype,"BloomEnabled",null),d([p()],t.prototype,"DepthOfFieldEnabled",null),d([p()],t.prototype,"LensFlareEnabled",null),d([p()],t.prototype,"HDREnabled",null),d([p()],t.prototype,"VLSEnabled",null),d([p()],t.prototype,"MotionBlurEnabled",null),d([p()],t.prototype,"fxaaEnabled",null),d([p()],t.prototype,"screenSpaceReflectionsEnabled",null),d([p()],t.prototype,"volumetricLightStepsCount",null),d([p()],t.prototype,"motionBlurSamples",null),d([p()],t.prototype,"samples",null),t}(W);A("BABYLON.StandardRenderingPipeline",Je);var H;(function(l){l[l.Hable=0]="Hable",l[l.Reinhard=1]="Reinhard",l[l.HejiDawson=2]="HejiDawson",l[l.Photographic=3]="Photographic"})(H||(H={}));(function(l){y(t,l);function t(e,i,r,n,a,s,o,u){a===void 0&&(a=2),o===void 0&&(o=0);var c=l.call(this,e,"tonemap",["_ExposureAdjustment"],null,1,n,a,s,u,null,o)||this;c._operator=i,c.exposureAdjustment=r;var h="#define ";return c._operator===H.Hable?h+="HABLE_TONEMAPPING":c._operator===H.Reinhard?h+="REINHARD_TONEMAPPING":c._operator===H.HejiDawson?h+="OPTIMIZED_HEJIDAWSON_TONEMAPPING":c._operator===H.Photographic&&(h+="PHOTOGRAPHIC_TONEMAPPING"),c.updateEffect(h),c.onApply=function(f){f.setFloat("_ExposureAdjustment",c.exposureAdjustment)},c}return t.prototype.getClassName=function(){return"TonemapPostProcess"},t})(v);var qe=function(l){y(t,l);function t(e,i,r,n,a,s,o,u,c){a===void 0&&(a=100),s===void 0&&(s=_.BILINEAR_SAMPLINGMODE);var h=this,f;return h=l.call(this,e,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],i.postProcessRatio||i,r,s,o,u,"#define NUM_SAMPLES "+a)||this,h._screenCoordinates=R.Zero(),h.customMeshPosition=D.Zero(),h.useCustomMeshPosition=!1,h.invert=!0,h.excludedMeshes=new Array,h.exposure=.3,h.decay=.96815,h.weight=.58767,h.density=.926,c=(f=r==null?void 0:r.getScene())!==null&&f!==void 0?f:c,o=c.getEngine(),h._viewPort=new Ee(0,0,1,1).toGlobal(o.getRenderWidth(),o.getRenderHeight()),h.mesh=n!=null?n:t.CreateDefaultMesh("VolumetricLightScatteringMesh",c),h._createPass(c,i.passRatio||i),h.onActivate=function(g){h.isSupported||h.dispose(g),h.onActivate=null},h.onApplyObservable.add(function(g){h._updateMeshScreenCoordinates(c),g.setTexture("lightScatteringSampler",h._volumetricLightScatteringRTT),g.setFloat("exposure",h.exposure),g.setFloat("decay",h.decay),g.setFloat("weight",h.weight),g.setFloat("density",h.density),g.setVector2("meshPositionOnScreen",h._screenCoordinates)}),h}return Object.defineProperty(t.prototype,"useDiffuseColor",{get:function(){return L.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1},set:function(e){L.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"VolumetricLightScatteringPostProcess"},t.prototype._isReady=function(e,i){var r,n=e.getMesh();if(n===this.mesh&&n.material)return n.material.isReady(n);var a=(r=n._internalAbstractMeshDataInfo._materialForRenderPass)===null||r===void 0?void 0:r[this._scene.getEngine().currentRenderPassId];if(a)return a.isReadyForSubMesh(n,e,i);var s=[],o=[F.PositionKind],u=e.getMaterial();u&&(u.needAlphaTesting()&&s.push("#define ALPHATEST"),n.isVerticesDataPresent(F.UVKind)&&(o.push(F.UVKind),s.push("#define UV1")),n.isVerticesDataPresent(F.UV2Kind)&&(o.push(F.UV2Kind),s.push("#define UV2"))),n.useBones&&n.computeBonesUsingShaders?(o.push(F.MatricesIndicesKind),o.push(F.MatricesWeightsKind),s.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),s.push("#define BonesPerMesh "+(n.skeleton?n.skeleton.bones.length+1:0))):s.push("#define NUM_BONE_INFLUENCERS 0"),i&&(s.push("#define INSTANCES"),Re.PushAttributesForInstances(o),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES"));var c=e._getDrawWrapper(void 0,!0),h=c.defines,f=s.join(`
`);return h!==f&&c.setEffect(n.getScene().getEngine().createEffect("volumetricLightScatteringPass",o,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],f,void 0,void 0,void 0,{maxSimultaneousMorphTargets:n.numBoneInfluencers}),f),c.effect.isReady()},t.prototype.setCustomMeshPosition=function(e){this.customMeshPosition=e},t.prototype.getCustomMeshPosition=function(){return this.customMeshPosition},t.prototype.dispose=function(e){var i=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);i!==-1&&e.getScene().customRenderTargets.splice(i,1),this._volumetricLightScatteringRTT.dispose(),l.prototype.dispose.call(this,e)},t.prototype.getPass=function(){return this._volumetricLightScatteringRTT},t.prototype._meshExcluded=function(e){return this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1},t.prototype._createPass=function(e,i){var r=this,n=e.getEngine();this._volumetricLightScatteringRTT=new Ae("volumetricLightScatteringMap",{width:n.getRenderWidth()*i,height:n.getRenderHeight()*i},e,!1,!0,0),this._volumetricLightScatteringRTT.wrapU=_.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=_.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;var a=this.getCamera();a?a.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);var s=function(c){var h,f=c.getRenderingMesh(),g=c.getEffectiveMesh();if(!r._meshExcluded(f)){g._internalAbstractMeshDataInfo._isActiveIntermediate=!1;var m=c.getMaterial();if(!!m){var P=f.getScene(),S=P.getEngine();S.setState(m.backFaceCulling,void 0,void 0,void 0,m.cullBackFaces);var E=f._getInstancesRenderList(c._id,!!c.getReplacementMesh());if(!E.mustReturn){var C=S.getCaps().instancedArrays&&(E.visibleInstances[c._id]!==null||f.hasThinInstances);if(r._isReady(c,C)){var x=(h=g._internalAbstractMeshDataInfo._materialForRenderPass)===null||h===void 0?void 0:h[S.currentRenderPassId],T=c._getDrawWrapper();if(f===r.mesh&&!T&&(T=m._getDrawWrapper()),!T)return;var M=T.effect;if(S.enableEffect(T),C||f._bind(c,M,m.fillMode),f===r.mesh)m.bind(g.getWorldMatrix(),f);else if(x)x.bindForSubMesh(g.getWorldMatrix(),g,c);else{if(M.setMatrix("viewProjection",P.getTransformMatrix()),m&&m.needAlphaTesting()){var w=m.getAlphaTestTexture();M.setTexture("diffuseSampler",w),w&&M.setMatrix("diffuseMatrix",w.getTextureMatrix())}f.useBones&&f.computeBonesUsingShaders&&f.skeleton&&M.setMatrices("mBones",f.skeleton.getTransformMatrices(f))}C&&f.hasThinInstances&&M.setMatrix("world",g.getWorldMatrix()),f._processRendering(g,c,M,Ce.TriangleFillMode,E,C,function(B,G){B||M.setMatrix("world",G)})}}}}},o,u=new ye(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add(function(){o=e.clearColor,e.clearColor=u}),this._volumetricLightScatteringRTT.onAfterRenderObservable.add(function(){e.clearColor=o}),this._volumetricLightScatteringRTT.customIsReadyFunction=function(c,h){if(!c.isReady(!1))return!1;if(h===0&&c.subMeshes)for(var f=0;f<c.subMeshes.length;++f){var g=c.subMeshes[f],m=g.getMaterial(),P=g.getRenderingMesh();if(!!m){var S=P._getInstancesRenderList(g._id,!!g.getReplacementMesh()),E=n.getCaps().instancedArrays&&(S.visibleInstances[g._id]!==null||P.hasThinInstances);if(!r._isReady(g,E))return!1}}return!0},this._volumetricLightScatteringRTT.customRenderFunction=function(c,h,f,g){var m=e.getEngine(),P;if(g.length){for(m.setColorWrite(!1),P=0;P<g.length;P++)s(g.data[P]);m.setColorWrite(!0)}for(P=0;P<c.length;P++)s(c.data[P]);for(P=0;P<h.length;P++)s(h.data[P]);if(f.length){for(P=0;P<f.length;P++){var S=f.data[P],E=S.getBoundingInfo();E&&e.activeCamera&&(S._alphaIndex=S.getMesh().alphaIndex,S._distanceToCamera=E.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}var C=f.data.slice(0,f.length);for(C.sort(function(x,T){return x._alphaIndex>T._alphaIndex?1:x._alphaIndex<T._alphaIndex?-1:x._distanceToCamera<T._distanceToCamera?1:x._distanceToCamera>T._distanceToCamera?-1:0}),m.setAlphaMode(2),P=0;P<C.length;P++)s(C[P]);m.setAlphaMode(0)}}},t.prototype._updateMeshScreenCoordinates=function(e){var i=e.getTransformMatrix(),r;this.useCustomMeshPosition?r=this.customMeshPosition:this.attachedNode?r=this.attachedNode.position:r=this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;var n=D.Project(r,I.Identity(),i,this._viewPort);this._screenCoordinates.x=n.x/this._viewPort.width,this._screenCoordinates.y=n.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)},t.CreateDefaultMesh=function(e,i){var r=Ie(e,{size:1},i);r.billboardMode=De.BILLBOARDMODE_ALL;var n=new xe(e+"Material",i);return n.emissiveColor=new Se(1,1,1),r.material=n,r},d([_e()],t.prototype,"customMeshPosition",void 0),d([p()],t.prototype,"useCustomMeshPosition",void 0),d([p()],t.prototype,"invert",void 0),d([Pe()],t.prototype,"mesh",void 0),d([p()],t.prototype,"excludedMeshes",void 0),d([p()],t.prototype,"exposure",void 0),d([p()],t.prototype,"decay",void 0),d([p()],t.prototype,"weight",void 0),d([p()],t.prototype,"density",void 0),t}(v);A("BABYLON.VolumetricLightScatteringPostProcess",qe);var Qe=function(l){y(t,l);function t(e,i,r,n,a,s,o,u,c){u===void 0&&(u=0),c===void 0&&(c=!1);var h=l.call(this,e,"screenSpaceCurvature",["curvature_ridge","curvature_valley"],["textureSampler","normalSampler"],r,n,a,s,o,void 0,u,void 0,null,c)||this;return h.ridge=1,h.valley=1,h._geometryBufferRenderer=i.enableGeometryBufferRenderer(),h._geometryBufferRenderer?h.onApply=function(f){f.setFloat("curvature_ridge",.5/Math.max(h.ridge*h.ridge,1e-4)),f.setFloat("curvature_valley",.7/Math.max(h.valley*h.valley,1e-4));var g=h._geometryBufferRenderer.getGBuffer().textures[1];f.setTexture("normalSampler",g)}:L.Error("Multiple Render Target support needed for screen space curvature post process. Please use IsSupported test first."),h}return t.prototype.getClassName=function(){return"ScreenSpaceCurvaturePostProcess"},Object.defineProperty(t,"IsSupported",{get:function(){var e=X.LastCreatedEngine;return e?e.getCaps().drawBuffersExtension:!1},enumerable:!1,configurable:!0}),t._Parse=function(e,i,r,n){return O.Parse(function(){return new t(e.name,r,e.options,i,e.renderTargetSamplingMode,r.getEngine(),e.textureType,e.reusable)},e,r,n)},d([p()],t.prototype,"ridge",void 0),d([p()],t.prototype,"valley",void 0),t}(v);A("BABYLON.ScreenSpaceCurvaturePostProcess",Qe);var Pt=function(l){y(t,l);function t(e,i,r,n,a,s,o,u){n===void 0&&(n=null),u===void 0&&(u=0);var c=l.call(this,e,"subSurfaceScattering",["texelSize","viewportSize","metersPerUnit"],["diffusionS","diffusionD","filterRadii","irradianceSampler","depthSampler","albedoSampler"],r,n,a||_.BILINEAR_SAMPLINGMODE,s,o,null,u,"postprocess",void 0,!0)||this;return c._scene=i,c.updateEffect(),c.onApplyObservable.add(function(h){if(!i.prePassRenderer||!i.subSurfaceConfiguration){L.Error("PrePass and subsurface configuration needs to be enabled for subsurface scattering.");return}var f=c.texelSize;h.setFloat("metersPerUnit",i.subSurfaceConfiguration.metersPerUnit),h.setFloat2("texelSize",f.x,f.y),h.setTexture("irradianceSampler",i.prePassRenderer.getRenderTarget().textures[i.prePassRenderer.getIndex(0)]),h.setTexture("depthSampler",i.prePassRenderer.getRenderTarget().textures[i.prePassRenderer.getIndex(5)]),h.setTexture("albedoSampler",i.prePassRenderer.getRenderTarget().textures[i.prePassRenderer.getIndex(7)]),h.setFloat2("viewportSize",Math.tan(i.activeCamera.fov/2)*i.getEngine().getAspectRatio(i.activeCamera,!0),Math.tan(i.activeCamera.fov/2)),h.setArray3("diffusionS",i.subSurfaceConfiguration.ssDiffusionS),h.setArray("diffusionD",i.subSurfaceConfiguration.ssDiffusionD),h.setArray("filterRadii",i.subSurfaceConfiguration.ssFilterRadii)}),c}return t.prototype.getClassName=function(){return"SubSurfaceScatteringPostProcess"},t}(v);export{Ne as A,j as B,$ as F,je as I,Z as P,pt as S,_t as V,gt as a,v as b,dt as c,Pt as d};
