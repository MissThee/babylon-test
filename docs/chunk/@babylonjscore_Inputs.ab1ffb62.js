import{P as u,a as v,b as U,c as C,d as I,K as E}from"./@babylonjscore_Events.8e5561d2.js";import{A as h,a as O}from"./@babylonjscore_Actions.7cce3f43.js";import{P as m}from"./@babylonjscore_Collisions.6bd46217.js";import{V as k,M as D}from"./@babylonjscore_Maths.f3ef132c.js";import{P as _,D as N,a as w}from"./@babylonjscore_DeviceInput.c0f43152.js";import{E as x}from"./@babylonjscore_Engines.7287f97a.js";var S=function(){function P(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}return Object.defineProperty(P.prototype,"singleClick",{get:function(){return this._singleClick},set:function(i){this._singleClick=i},enumerable:!1,configurable:!0}),Object.defineProperty(P.prototype,"doubleClick",{get:function(){return this._doubleClick},set:function(i){this._doubleClick=i},enumerable:!1,configurable:!0}),Object.defineProperty(P.prototype,"hasSwiped",{get:function(){return this._hasSwiped},set:function(i){this._hasSwiped=i},enumerable:!1,configurable:!0}),Object.defineProperty(P.prototype,"ignore",{get:function(){return this._ignore},set:function(i){this._ignore=i},enumerable:!1,configurable:!0}),P}(),L=function(){function P(i){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new k(0,0),this._previousStartingPointerPosition=new k(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._deviceSourceManager=null,this._scene=i||x.LastCreatedScene,this._scene}return Object.defineProperty(P.prototype,"meshUnderPointer",{get:function(){return this._pointerOverMesh},enumerable:!1,configurable:!0}),P.prototype.getMeshUnderPointerByPointerId=function(i){return this._meshUnderPointerId[i]||null},Object.defineProperty(P.prototype,"unTranslatedPointer",{get:function(){return new k(this._unTranslatedPointerX,this._unTranslatedPointerY)},enumerable:!1,configurable:!0}),Object.defineProperty(P.prototype,"pointerX",{get:function(){return this._pointerX},set:function(i){this._pointerX=i},enumerable:!1,configurable:!0}),Object.defineProperty(P.prototype,"pointerY",{get:function(){return this._pointerY},set:function(i){this._pointerY=i},enumerable:!1,configurable:!0}),P.prototype._updatePointerPosition=function(i){var o=this._scene.getEngine().getInputElementClientRect();!o||(this._pointerX=i.clientX-o.left,this._pointerY=i.clientY-o.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)},P.prototype._processPointerMove=function(i,o){var s=this._scene,a=s.getEngine(),e=a.getInputElement();e&&(e.tabIndex=a.canvasTabIndex,s.doNotHandleCursors||(e.style.cursor=s.defaultCursor));var n=!!(i&&i.hit&&i.pickedMesh);if(n){if(s.setPointerOverMesh(i.pickedMesh,o.pointerId,i),!s.doNotHandleCursors&&e&&this._pointerOverMesh){var p=this._pointerOverMesh._getActionManagerForTrigger();p&&p.hasPointerTriggers&&(e.style.cursor=p.hoverCursor||s.hoverCursor)}}else s.setPointerOverMesh(null,o.pointerId,i);for(var t=0,r=s._pointerMoveStage;t<r.length;t++){var l=r[t];i=l.action(this._unTranslatedPointerX,this._unTranslatedPointerY,i,n,e)}if(i){var f=o.type==="wheel"||o.type==="mousewheel"||o.type==="DOMMouseScroll"?u.POINTERWHEEL:u.POINTERMOVE;if(s.onPointerMove&&s.onPointerMove(o,i,f),s.onPointerObservable.hasObservers()){var c=new v(f,o,i);this._setRayOnPointerInfo(c),s.onPointerObservable.notifyObservers(c,f)}}},P.prototype._setRayOnPointerInfo=function(i){var o=this._scene;i.pickInfo&&!i.pickInfo._pickingUnavailable&&(i.pickInfo.ray||(i.pickInfo.ray=o.createPickingRay(i.event.offsetX,i.event.offsetY,D.Identity(),o.activeCamera)))},P.prototype._checkPrePointerObservable=function(i,o,s){var a=this._scene,e=new U(s,o,this._unTranslatedPointerX,this._unTranslatedPointerY);return i&&(e.ray=i.ray,i.originMesh&&(e.nearInteractionPickingInfo=i)),a.onPrePointerObservable.notifyObservers(e,s),!!e.skipOnPointerObservable},P.prototype.simulatePointerMove=function(i,o){var s=new PointerEvent("pointermove",o);s.inputIndex=_.Move,!this._checkPrePointerObservable(i,s,u.POINTERMOVE)&&this._processPointerMove(i,s)},P.prototype.simulatePointerDown=function(i,o){var s=new PointerEvent("pointerdown",o);s.inputIndex=s.button+2,!this._checkPrePointerObservable(i,s,u.POINTERDOWN)&&this._processPointerDown(i,s)},P.prototype._processPointerDown=function(i,o){var s=this,a=this._scene;if(i&&i.hit&&i.pickedMesh){this._pickedDownMesh=i.pickedMesh;var e=i.pickedMesh._getActionManagerForTrigger();if(e){if(e.hasPickTriggers)switch(e.processTrigger(5,h.CreateNew(i.pickedMesh,o)),o.button){case 0:e.processTrigger(2,h.CreateNew(i.pickedMesh,o));break;case 1:e.processTrigger(4,h.CreateNew(i.pickedMesh,o));break;case 2:e.processTrigger(3,h.CreateNew(i.pickedMesh,o));break}e.hasSpecificTrigger(8)&&window.setTimeout(function(){var f=a.pick(s._unTranslatedPointerX,s._unTranslatedPointerY,function(c){return c.isPickable&&c.isVisible&&c.isReady()&&c.actionManager&&c.actionManager.hasSpecificTrigger(8)&&c===s._pickedDownMesh},!1,a.cameraToUseForPointers);f&&f.hit&&f.pickedMesh&&e&&s._totalPointersPressed!==0&&Date.now()-s._startingPointerTime>P.LongPressDelay&&!s._isPointerSwiping()&&(s._startingPointerTime=0,e.processTrigger(8,h.CreateNew(f.pickedMesh,o)))},P.LongPressDelay)}}else for(var n=0,p=a._pointerDownStage;n<p.length;n++){var t=p[n];i=t.action(this._unTranslatedPointerX,this._unTranslatedPointerY,i,o)}if(i){var r=u.POINTERDOWN;if(a.onPointerDown&&a.onPointerDown(o,i,r),a.onPointerObservable.hasObservers()){var l=new v(r,o,i);this._setRayOnPointerInfo(l),a.onPointerObservable.notifyObservers(l,r)}}},P.prototype._isPointerSwiping=function(){return Math.abs(this._startingPointerPosition.x-this._pointerX)>P.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>P.DragMovementThreshold},P.prototype.simulatePointerUp=function(i,o,s){var a=new PointerEvent("pointerup",o);a.inputIndex=_.Move;var e=new S;s?e.doubleClick=!0:e.singleClick=!0,!this._checkPrePointerObservable(i,a,u.POINTERUP)&&this._processPointerUp(i,a,e)},P.prototype._processPointerUp=function(i,o,s){var a=this._scene;if(i&&i.hit&&i.pickedMesh){if(this._pickedUpMesh=i.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(a.onPointerPick&&a.onPointerPick(o,i),s.singleClick&&!s.ignore&&a.onPointerObservable.hasObservers())){var e=u.POINTERPICK,n=new v(e,o,i);this._setRayOnPointerInfo(n),a.onPointerObservable.notifyObservers(n,e)}var p=i.pickedMesh._getActionManagerForTrigger();if(p&&!s.ignore){p.processTrigger(7,h.CreateNew(i.pickedMesh,o,i)),!s.hasSwiped&&s.singleClick&&p.processTrigger(1,h.CreateNew(i.pickedMesh,o,i));var t=i.pickedMesh._getActionManagerForTrigger(6);s.doubleClick&&t&&t.processTrigger(6,h.CreateNew(i.pickedMesh,o,i))}}else if(!s.ignore)for(var r=0,l=a._pointerUpStage;r<l.length;r++){var f=l[r];i=f.action(this._unTranslatedPointerX,this._unTranslatedPointerY,i,o)}if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){var c=this._pickedDownMesh._getActionManagerForTrigger(16);c&&c.processTrigger(16,h.CreateNew(this._pickedDownMesh,o))}var d=0;if(a.onPointerObservable.hasObservers()){if(!s.ignore&&!s.hasSwiped&&(s.singleClick&&a.onPointerObservable.hasSpecificMask(u.POINTERTAP)?d=u.POINTERTAP:s.doubleClick&&a.onPointerObservable.hasSpecificMask(u.POINTERDOUBLETAP)&&(d=u.POINTERDOUBLETAP),d)){var n=new v(d,o,i);this._setRayOnPointerInfo(n),a.onPointerObservable.notifyObservers(n,d)}if(!s.ignore){d=u.POINTERUP;var n=new v(d,o,i);this._setRayOnPointerInfo(n),a.onPointerObservable.notifyObservers(n,d)}}a.onPointerUp&&!s.ignore&&a.onPointerUp(o,i,d)},P.prototype.isPointerCaptured=function(i){return i===void 0&&(i=0),this._pointerCaptures[i]},P.prototype.attachControl=function(i,o,s,a){var e=this;i===void 0&&(i=!0),o===void 0&&(o=!0),s===void 0&&(s=!0),a===void 0&&(a=null);var n=this._scene,p=n.getEngine();a||(a=p.getInputElement()),this._alreadyAttached&&this.detachControl(),a&&(this._alreadyAttachedTo=a),this._deviceSourceManager=new N(p),this._initActionManager=function(t){if(!e._meshPickProceed){var r=n.skipPointerUpPicking?null:n.pick(e._unTranslatedPointerX,e._unTranslatedPointerY,n.pointerUpPredicate,!1,n.cameraToUseForPointers);e._currentPickResult=r,r&&(t=r.hit&&r.pickedMesh?r.pickedMesh._getActionManagerForTrigger():null),e._meshPickProceed=!0}return t},this._delayedSimpleClick=function(t,r,l){(Date.now()-e._previousStartingPointerTime>P.DoubleClickDelay&&!e._doubleClickOccured||t!==e._previousButtonPressed)&&(e._doubleClickOccured=!1,r.singleClick=!0,r.ignore=!1,l(r,e._currentPickResult))},this._initClickEvent=function(t,r,l,f){var c=new S;e._currentPickResult=null;var d=null,T=t.hasSpecificMask(u.POINTERPICK)||r.hasSpecificMask(u.POINTERPICK)||t.hasSpecificMask(u.POINTERTAP)||r.hasSpecificMask(u.POINTERTAP)||t.hasSpecificMask(u.POINTERDOUBLETAP)||r.hasSpecificMask(u.POINTERDOUBLETAP);!T&&O&&(d=e._initActionManager(d,c),d&&(T=d.hasPickTriggers));var y=!1;if(T){var g=l.button;if(c.hasSwiped=e._isPointerSwiping(),!c.hasSwiped){var b=!P.ExclusiveDoubleClickMode;b||(b=!t.hasSpecificMask(u.POINTERDOUBLETAP)&&!r.hasSpecificMask(u.POINTERDOUBLETAP),b&&!O.HasSpecificTrigger(6)&&(d=e._initActionManager(d,c),d&&(b=!d.hasSpecificTrigger(6)))),b?(Date.now()-e._previousStartingPointerTime>P.DoubleClickDelay||g!==e._previousButtonPressed)&&(c.singleClick=!0,f(c,e._currentPickResult),y=!0):(e._previousDelayedSimpleClickTimeout=e._delayedSimpleClickTimeout,e._delayedSimpleClickTimeout=window.setTimeout(e._delayedSimpleClick.bind(e,g,c,f),P.DoubleClickDelay));var M=t.hasSpecificMask(u.POINTERDOUBLETAP)||r.hasSpecificMask(u.POINTERDOUBLETAP);!M&&O.HasSpecificTrigger(6)&&(d=e._initActionManager(d,c),d&&(M=d.hasSpecificTrigger(6))),M&&(g===e._previousButtonPressed&&Date.now()-e._previousStartingPointerTime<P.DoubleClickDelay&&!e._doubleClickOccured?(!c.hasSwiped&&!e._isPointerSwiping()?(e._previousStartingPointerTime=0,e._doubleClickOccured=!0,c.doubleClick=!0,c.ignore=!1,P.ExclusiveDoubleClickMode&&e._previousDelayedSimpleClickTimeout&&clearTimeout(e._previousDelayedSimpleClickTimeout),e._previousDelayedSimpleClickTimeout=e._delayedSimpleClickTimeout,f(c,e._currentPickResult)):(e._doubleClickOccured=!1,e._previousStartingPointerTime=e._startingPointerTime,e._previousStartingPointerPosition.x=e._startingPointerPosition.x,e._previousStartingPointerPosition.y=e._startingPointerPosition.y,e._previousButtonPressed=g,P.ExclusiveDoubleClickMode?(e._previousDelayedSimpleClickTimeout&&clearTimeout(e._previousDelayedSimpleClickTimeout),e._previousDelayedSimpleClickTimeout=e._delayedSimpleClickTimeout,f(c,e._previousPickResult)):f(c,e._currentPickResult)),y=!0):(e._doubleClickOccured=!1,e._previousStartingPointerTime=e._startingPointerTime,e._previousStartingPointerPosition.x=e._startingPointerPosition.x,e._previousStartingPointerPosition.y=e._startingPointerPosition.y,e._previousButtonPressed=g))}}y||f(c,e._currentPickResult)},this._onPointerMove=function(t){if(t.pointerId===void 0&&(t.pointerId=0),e._updatePointerPosition(t),!e._checkPrePointerObservable(null,t,t.type==="wheel"||t.type==="mousewheel"||t.type==="DOMMouseScroll"?u.POINTERWHEEL:u.POINTERMOVE)&&!(!n.cameraToUseForPointers&&!n.activeCamera)){if(n.skipPointerMovePicking){e._processPointerMove(new m,t);return}n.pointerMovePredicate||(n.pointerMovePredicate=function(l){return l.isPickable&&l.isVisible&&l.isReady()&&l.isEnabled()&&(l.enablePointerMoveEvents||n.constantlyUpdateMeshUnderPointer||l._getActionManagerForTrigger()!==null)&&(!n.cameraToUseForPointers||(n.cameraToUseForPointers.layerMask&l.layerMask)!==0)});var r=n.pick(e._unTranslatedPointerX,e._unTranslatedPointerY,n.pointerMovePredicate,!1,n.cameraToUseForPointers,n.pointerMoveTrianglePredicate);e._processPointerMove(r,t)}},this._onPointerDown=function(t){if(e._totalPointersPressed++,e._pickedDownMesh=null,e._meshPickProceed=!1,t.pointerId===void 0&&(t.pointerId=0),e._updatePointerPosition(t),n.preventDefaultOnPointerDown&&a&&(t.preventDefault(),a.focus()),e._startingPointerPosition.x=e._pointerX,e._startingPointerPosition.y=e._pointerY,e._startingPointerTime=Date.now(),!e._checkPrePointerObservable(null,t,u.POINTERDOWN)&&!(!n.cameraToUseForPointers&&!n.activeCamera)){e._pointerCaptures[t.pointerId]=!0,n.pointerDownPredicate||(n.pointerDownPredicate=function(l){return l.isPickable&&l.isVisible&&l.isReady()&&l.isEnabled()&&(!n.cameraToUseForPointers||(n.cameraToUseForPointers.layerMask&l.layerMask)!==0)}),e._pickedDownMesh=null;var r;n.skipPointerDownPicking?r=new m:r=n.pick(e._unTranslatedPointerX,e._unTranslatedPointerY,n.pointerDownPredicate,!1,n.cameraToUseForPointers),e._processPointerDown(r,t)}},this._onPointerUp=function(t){e._totalPointersPressed!==0&&(e._totalPointersPressed--,e._pickedUpMesh=null,e._meshPickProceed=!1,t.pointerId===void 0&&(t.pointerId=0),e._updatePointerPosition(t),n.preventDefaultOnPointerUp&&a&&(t.preventDefault(),a.focus()),e._initClickEvent(n.onPrePointerObservable,n.onPointerObservable,t,function(r,l){n.onPrePointerObservable.hasObservers()&&!r.ignore&&(!r.hasSwiped&&(r.singleClick&&n.onPrePointerObservable.hasSpecificMask(u.POINTERTAP)&&e._checkPrePointerObservable(null,t,u.POINTERTAP)||r.doubleClick&&n.onPrePointerObservable.hasSpecificMask(u.POINTERDOUBLETAP)&&e._checkPrePointerObservable(null,t,u.POINTERDOUBLETAP))||e._checkPrePointerObservable(null,t,u.POINTERUP))||(e._pointerCaptures[t.pointerId]=!1,!(!n.cameraToUseForPointers&&!n.activeCamera)&&(n.pointerUpPredicate||(n.pointerUpPredicate=function(f){return f.isPickable&&f.isVisible&&f.isReady()&&f.isEnabled()&&(!n.cameraToUseForPointers||(n.cameraToUseForPointers.layerMask&f.layerMask)!==0)}),!e._meshPickProceed&&(O&&O.HasTriggers||n.onPointerObservable.hasObservers())&&e._initActionManager(null,r),l||(l=e._currentPickResult),e._processPointerUp(l,t,r),e._previousPickResult=e._currentPickResult))}))},this._onKeyDown=function(t){var r=E.KEYDOWN;if(n.onPreKeyboardObservable.hasObservers()){var l=new C(r,t);if(n.onPreKeyboardObservable.notifyObservers(l,r),l.skipOnKeyboardObservable)return}if(n.onKeyboardObservable.hasObservers()){var l=new I(r,t);n.onKeyboardObservable.notifyObservers(l,r)}n.actionManager&&n.actionManager.processTrigger(14,h.CreateNewFromScene(n,t))},this._onKeyUp=function(t){var r=E.KEYUP;if(n.onPreKeyboardObservable.hasObservers()){var l=new C(r,t);if(n.onPreKeyboardObservable.notifyObservers(l,r),l.skipOnKeyboardObservable)return}if(n.onKeyboardObservable.hasObservers()){var l=new I(r,t);n.onKeyboardObservable.notifyObservers(l,r)}n.actionManager&&n.actionManager.processTrigger(15,h.CreateNewFromScene(n,t))},this._deviceSourceManager.onDeviceConnectedObservable.add(function(t){t.deviceType===w.Mouse?t.onInputChangedObservable.add(function(r){r.inputIndex===_.LeftClick||r.inputIndex===_.MiddleClick||r.inputIndex===_.RightClick||r.inputIndex===_.BrowserBack||r.inputIndex===_.BrowserForward?o&&t.getInput(r.inputIndex)===1?e._onPointerDown(r):i&&t.getInput(r.inputIndex)===0&&e._onPointerUp(r):s&&(r.inputIndex===_.Move||r.inputIndex===_.MouseWheelX||r.inputIndex===_.MouseWheelY||r.inputIndex===_.MouseWheelZ)&&e._onPointerMove(r)}):t.deviceType===w.Touch?t.onInputChangedObservable.add(function(r){r.inputIndex===_.LeftClick&&(o&&t.getInput(r.inputIndex)===1?e._onPointerDown(r):i&&t.getInput(r.inputIndex)===0&&e._onPointerUp(r)),s&&r.inputIndex===_.Move&&e._onPointerMove(r)}):t.deviceType===w.Keyboard&&t.onInputChangedObservable.add(function(r){r.type==="keydown"?e._onKeyDown(r):r.type==="keyup"&&e._onKeyUp(r)})}),this._alreadyAttached=!0},P.prototype.detachControl=function(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)},P.prototype.setPointerOverMesh=function(i,o,s){if(o===void 0&&(o=0),this._meshUnderPointerId[o]!==i){var a=this._meshUnderPointerId[o],e;a&&(e=a._getActionManagerForTrigger(10),e&&e.processTrigger(10,h.CreateNew(a,void 0,{pointerId:o}))),i?(this._meshUnderPointerId[o]=i,this._pointerOverMesh=i,e=i._getActionManagerForTrigger(9),e&&e.processTrigger(9,h.CreateNew(i,void 0,{pointerId:o,pickResult:s}))):(delete this._meshUnderPointerId[o],this._pointerOverMesh=null)}},P.prototype.getPointerOverMesh=function(){return this._pointerOverMesh},P.prototype._invalidateMesh=function(i){this._pointerOverMesh===i&&(this._pointerOverMesh=null),this._pickedDownMesh===i&&(this._pickedDownMesh=null),this._pickedUpMesh===i&&(this._pickedUpMesh=null);for(var o in this._meshUnderPointerId)this._meshUnderPointerId[o]===i&&delete this._meshUnderPointerId[o]},P.DragMovementThreshold=10,P.LongPressDelay=500,P.DoubleClickDelay=300,P.ExclusiveDoubleClickMode=!1,P}();export{L as I};
