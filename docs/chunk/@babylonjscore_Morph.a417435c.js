import{a as x}from"./tslibtslib.b6e59fa7.js";import{S as m,b as P,O as y,G as V,L as v,f as C}from"./@babylonjscore_Misc.5aaba58d.js";import{E as b}from"./@babylonjscore_Engines.77a493e8.js";import{V as p}from"./@babylonjscore_Buffers.c351261b.js";import{p as I}from"./@babylonjscore_Materials.d4538583.js";var U=function(){function r(e,t,s){t===void 0&&(t=0),s===void 0&&(s=null),this.name=e,this.animations=new Array,this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new y,this._onDataLayoutChanged=new y,this._animationPropertiesOverride=null,this._scene=s||b.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}return Object.defineProperty(r.prototype,"influence",{get:function(){return this._influence},set:function(e){if(this._influence!==e){var t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(t===0||e===0)}},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"animationPropertiesOverride",{get:function(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride},set:function(e){this._animationPropertiesOverride=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasPositions",{get:function(){return!!this._positions},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasNormals",{get:function(){return!!this._normals},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasTangents",{get:function(){return!!this._tangents},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasUVs",{get:function(){return!!this._uvs},enumerable:!1,configurable:!0}),r.prototype.setPositions=function(e){var t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)},r.prototype.getPositions=function(){return this._positions},r.prototype.setNormals=function(e){var t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)},r.prototype.getNormals=function(){return this._normals},r.prototype.setTangents=function(e){var t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)},r.prototype.getTangents=function(){return this._tangents},r.prototype.setUVs=function(e){var t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)},r.prototype.getUVs=function(){return this._uvs},r.prototype.clone=function(){var e=this,t=m.Clone(function(){return new r(e.name,e.influence,e._scene)},this);return t._positions=this._positions,t._normals=this._normals,t._tangents=this._tangents,t._uvs=this._uvs,t},r.prototype.serialize=function(){var e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),this.id!=null&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),m.AppendSerializedAnimations(this,e),e},r.prototype.getClassName=function(){return"MorphTarget"},r.Parse=function(e,t){var s=new r(e.name,e.influence);if(s.setPositions(e.positions),e.id!=null&&(s.id=e.id),e.normals&&s.setNormals(e.normals),e.tangents&&s.setTangents(e.tangents),e.uvs&&s.setUVs(e.uvs),e.animations){for(var i=0;i<e.animations.length;i++){var a=e.animations[i],n=V("BABYLON.Animation");n&&s.animations.push(n.Parse(a))}e.autoAnimate&&t&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return s},r.FromMesh=function(e,t,s){t||(t=e.name);var i=new r(t,s,e.getScene());return i.setPositions(e.getVerticesData(p.PositionKind)),e.isVerticesDataPresent(p.NormalKind)&&i.setNormals(e.getVerticesData(p.NormalKind)),e.isVerticesDataPresent(p.TangentKind)&&i.setTangents(e.getVerticesData(p.TangentKind)),e.isVerticesDataPresent(p.UVKind)&&i.setUVs(e.getVerticesData(p.UVKind)),i},x([P()],r.prototype,"id",void 0),r}(),D=function(){function r(e){if(e===void 0&&(e=null),this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new C(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._parentContainer=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._useTextureToStoreTargets=!0,e||(e=b.LastCreatedScene),this._scene=e,this._scene){this._scene.morphTargetManagers.push(this),this._uniqueId=this._scene.getUniqueId();var t=this._scene.getEngine().getCaps();this._canUseTextureForTargets=t.canUseGLVertexID&&t.textureFloat&&t.maxVertexTextureImageUnits>0&&t.texture2DArrayMaxLayerCount>1}}return Object.defineProperty(r.prototype,"areUpdatesFrozen",{get:function(){return this._blockCounter>0},set:function(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(!0)))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"vertexCount",{get:function(){return this._vertexCount},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"supportsNormals",{get:function(){return this._supportsNormals&&this.enableNormalMorphing},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"supportsTangents",{get:function(){return this._supportsTangents&&this.enableTangentMorphing},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"supportsUVs",{get:function(){return this._supportsUVs&&this.enableUVMorphing},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"numTargets",{get:function(){return this._targets.length},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"numInfluencers",{get:function(){return this._activeTargets.length},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"influences",{get:function(){return this._influences},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"useTextureToStoreTargets",{get:function(){return this._useTextureToStoreTargets},set:function(e){this._useTextureToStoreTargets=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isUsingTextureForTargets",{get:function(){return r.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets},enumerable:!1,configurable:!0}),r.prototype.getActiveTarget=function(e){return this._activeTargets.data[e]},r.prototype.getTarget=function(e){return this._targets[e]},r.prototype.addTarget=function(e){var t=this;this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add(function(s){t._syncActiveTargets(s)})),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add(function(){t._syncActiveTargets(!0)})),this._syncActiveTargets(!0)},r.prototype.removeTarget=function(e){var t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._syncActiveTargets(!0))},r.prototype._bind=function(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture)},r.prototype.clone=function(){for(var e=new r(this._scene),t=0,s=this._targets;t<s.length;t++){var i=s[t];e.addTarget(i.clone())}return e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e},r.prototype.serialize=function(){var e={};e.id=this.uniqueId,e.targets=[];for(var t=0,s=this._targets;t<s.length;t++){var i=s[t];e.targets.push(i.serialize())}return e},r.prototype._syncActiveTargets=function(e){if(!this.areUpdatesFrozen){var t=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));for(var s=-1,i=0,a=this._targets;i<a.length;i++){var n=a[i];if(s++,!(n.influence===0&&this.optimizeInfluencers)){this._activeTargets.push(n),this._morphTargetTextureIndices[t]=s,this._tempInfluences[t++]=n.influence,this._supportsNormals=this._supportsNormals&&n.hasNormals,this._supportsTangents=this._supportsTangents&&n.hasTangents,this._supportsUVs=this._supportsUVs&&n.hasUVs;var h=n.getPositions();if(h){var g=h.length/3;if(this._vertexCount===0)this._vertexCount=g;else if(this._vertexCount!==g){v.Error("Incompatible target. Targets must all have the same vertices count.");return}}}}(!this._influences||this._influences.length!==t)&&(this._influences=new Float32Array(t));for(var u=0;u<t;u++)this._influences[u]=this._tempInfluences[u];e&&this.synchronize()}},r.prototype.synchronize=function(){if(!(!this._scene||this.areUpdatesFrozen)){if(this.isUsingTextureForTargets&&this._vertexCount){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride,this._textureHeight=1;var e=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>e&&(this._textureHeight=Math.ceil(this._textureWidth/e),this._textureWidth=e);var t=!0;if(this._targetStoreTexture){var s=this._targetStoreTexture.getSize();s.width===this._textureWidth&&s.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(t=!1)}if(t){this._targetStoreTexture&&this._targetStoreTexture.dispose();for(var i=this._targets.length,a=new Float32Array(i*this._textureWidth*this._textureHeight*4),n=0,h=0;h<i;h++){var g=this._targets[h],u=g.getPositions(),l=g.getNormals(),c=g.getUVs(),f=g.getTangents();if(!u){h===0&&v.Error("Invalid morph target. Target must have positions.");return}n=h*this._textureWidth*this._textureHeight*4;for(var o=0;o<this._vertexCount;o++)a[n]=u[o*3],a[n+1]=u[o*3+1],a[n+2]=u[o*3+2],n+=4,l&&(a[n]=l[o*3],a[n+1]=l[o*3+1],a[n+2]=l[o*3+2],n+=4),c&&(a[n]=c[o*2],a[n+1]=c[o*2+1],n+=4),f&&(a[n]=f[o*3],a[n+1]=f[o*3+1],a[n+2]=f[o*3+2],n+=4)}this._targetStoreTexture=I.CreateRGBATexture(a,this._textureWidth,this._textureHeight,i,this._scene,!1,!1,1,1)}}for(var _=0,d=this._scene.meshes;_<d.length;_++){var T=d[_];T.morphTargetManager===this&&T._syncGeometryWithMorphTargetManager()}}},r.prototype.dispose=function(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene&&(this._scene.removeMorphTargetManager(this),this._parentContainer)){var e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}},r.Parse=function(e,t){var s=new r(t);s._uniqueId=e.id;for(var i=0,a=e.targets;i<a.length;i++){var n=a[i];s.addTarget(U.Parse(n,t))}return s},r.EnableTextureStorage=!0,r}();export{D as M,U as a};
