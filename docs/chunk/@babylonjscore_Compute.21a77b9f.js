import{i as S,L as h,O as l,I as x,S as v,b,R as E,U as I}from"./@babylonjscore_Misc.329df4d9.js";import{S as f,b as m,C as u}from"./@babylonjscore_Engines.a7c830c0.js";import{a as C,T as R,b as O}from"./@babylonjscore_Materials.49fd589a.js";import{a as P,b as T}from"./tslibtslib.b6e59fa7.js";var B=function(){function n(e,t,i,r){r===void 0&&(r="");var o=this,s,a;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.uniqueId=0,this.onCompileObservable=new l,this.onErrorObservable=new l,this.onBindObservable=new l,this._wasPreviouslyReady=!1,this._isReady=!1,this._compilationError="",this._key="",this._computeSourceCodeOverride="",this._pipelineContext=null,this._computeSourceCode="",this._rawComputeSourceCode="",this._shaderLanguage=C.WGSL,this.name=e,this._key=r,this._engine=i,this.uniqueId=n._UniqueIdSeed++,this.defines=(s=t.defines)!==null&&s!==void 0?s:"",this.onError=t.onError,this.onCompiled=t.onCompiled,this._entryPoint=(a=t.entryPoint)!==null&&a!==void 0?a:"main",this._shaderStore=f.GetShadersStore(this._shaderLanguage),this._shaderRepository=f.GetShadersRepository(this._shaderLanguage),this._includeShaderStore=f.GetIncludesShadersStore(this._shaderLanguage);var p,c=x()?this._engine.getHostDocument():null;e.computeSource?p="source:"+e.computeSource:e.computeElement?(p=c?c.getElementById(e.computeElement):null,p||(p=e.computeElement)):p=e.compute||e;var d={defines:this.defines.split(`
`),indexParameters:void 0,isFragment:!1,shouldUseHighPrecisionShader:!1,processor:null,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:this._shaderRepository,includesShadersStore:this._includeShaderStore,version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:null,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer};this._loadShader(p,"Compute","",function(g){m.Initialize(d),m.PreProcess(g,d,function(_){o._rawComputeSourceCode=g,t.processFinalCode&&(_=t.processFinalCode(_));var y=m.Finalize(_,"",d);o._useFinalCode(y.vertexCode,e)},o._engine)})}return n.prototype._useFinalCode=function(e,t){if(t){var i=t.computeElement||t.compute||t.spectorName||t;this._computeSourceCode="//#define SHADER_NAME compute:"+i+`
`+e}else this._computeSourceCode=e;this._prepareEffect()},Object.defineProperty(n.prototype,"key",{get:function(){return this._key},enumerable:!1,configurable:!0}),n.prototype.isReady=function(){try{return this._isReadyInternal()}catch{return!1}},n.prototype._isReadyInternal=function(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1},n.prototype.getEngine=function(){return this._engine},n.prototype.getPipelineContext=function(){return this._pipelineContext},n.prototype.getCompilationError=function(){return this._compilationError},n.prototype.executeWhenCompiled=function(e){var t=this;if(this.isReady()){e(this);return}this.onCompileObservable.add(function(i){e(i)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(function(){t._checkIsReady(null)},16)},n.prototype._checkIsReady=function(e){var t=this;try{if(this._isReadyInternal())return}catch(i){this._processCompilationErrors(i,e);return}setTimeout(function(){t._checkIsReady(e)},16)},n.prototype._loadShader=function(e,t,i,r){if(typeof HTMLElement!="undefined"&&e instanceof HTMLElement){var o=S(e);r(o);return}if(e.substr(0,7)==="source:"){r(e.substr(7));return}if(e.substr(0,7)==="base64:"){var s=window.atob(e.substr(7));r(s);return}if(this._shaderStore[e+t+"Shader"]){r(this._shaderStore[e+t+"Shader"]);return}if(i&&this._shaderStore[e+i+"Shader"]){r(this._shaderStore[e+i+"Shader"]);return}var a;e[0]==="."||e[0]==="/"||e.indexOf("http")>-1?a=e:a=this._shaderRepository+e,this._engine._loadFile(a+"."+t.toLowerCase()+".fx",r)},Object.defineProperty(n.prototype,"computeSourceCode",{get:function(){var e,t;return this._computeSourceCodeOverride?this._computeSourceCodeOverride:(t=(e=this._pipelineContext)===null||e===void 0?void 0:e._getComputeShaderCode())!==null&&t!==void 0?t:this._computeSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rawComputeSourceCode",{get:function(){return this._rawComputeSourceCode},enumerable:!1,configurable:!0}),n.prototype._prepareEffect=function(){var e=this,t=this.defines,i=this._pipelineContext;this._isReady=!1;try{var r=this._engine;this._pipelineContext=r.createComputePipelineContext(),this._pipelineContext._name=this._key,r._prepareComputePipelineContext(this._pipelineContext,this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._computeSourceCode,this._rawComputeSourceCode,this._computeSourceCodeOverride?null:t,this._entryPoint),r._executeWhenComputeStateIsCompiled(this._pipelineContext,function(){e._compilationError="",e._isReady=!0,e.onCompiled&&e.onCompiled(e),e.onCompileObservable.notifyObservers(e),e.onCompileObservable.clear(),i&&e.getEngine()._deleteComputePipelineContext(i)}),this._pipelineContext.isAsync&&this._checkIsReady(i)}catch(o){this._processCompilationErrors(o,i)}},n.prototype._getShaderCodeAndErrorLine=function(e,t){var i=/COMPUTE SHADER ERROR: 0:(\d+?):/,r=null;if(t&&e){var o=t.match(i);if(o&&o.length===2){var s=parseInt(o[1]),a=e.split(`
`,-1);a.length>=s&&(r="Offending line [".concat(s,"] in compute code: ").concat(a[s-1]))}}return[e,r]},n.prototype._processCompilationErrors=function(e,t){var i,r;if(t===void 0&&(t=null),this._compilationError=e.message,h.Error("Unable to compile compute effect:"),h.Error(`Defines:\r
`+this.defines),n.LogShaderCodeOnCompilationError){var o=null,s=null;!((r=this._pipelineContext)===null||r===void 0)&&r._getComputeShaderCode()&&(i=this._getShaderCodeAndErrorLine(this._pipelineContext._getComputeShaderCode(),this._compilationError),s=i[0],o=i[1],s&&(h.Error("Compute code:"),h.Error(s))),o&&h.Error(o)}h.Error("Error: "+this._compilationError),t&&(this._pipelineContext=t,this._isReady=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this))},n.prototype.dispose=function(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseComputeEffect(this)},n.RegisterShader=function(e,t){f.GetShadersStore(C.WGSL)["".concat(e,"ComputeShader")]=t},n._UniqueIdSeed=0,n.LogShaderCodeOnCompilationError=!0,n}(),D=function(){function n(e,t,i,r){if(r===void 0&&(r={}),this._bindings={},this._samplers={},this._contextIsDirty=!1,this.onCompiled=null,this.onError=null,this.name=e,this._engine=t,this.uniqueId=I.UniqueId,!this._engine.getCaps().supportComputeShaders){h.Error("This engine does not support compute shaders!");return}if(!r.bindingsMapping){h.Error("You must provide the binding mappings as browsers don't support reflection for wgsl shaders yet!");return}this._context=t.createComputeContext(),this._shaderPath=i,this._options=T({bindingsMapping:{},defines:[]},r)}return Object.defineProperty(n.prototype,"options",{get:function(){return this._options},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"shaderPath",{get:function(){return this._shaderPath},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"ComputeShader"},n.prototype.setTexture=function(e,t,i){i===void 0&&(i=!0);var r=this._bindings[e];this._bindings[e]={type:i?u.Texture:u.TextureWithoutSampler,object:t,indexInGroupEntries:r==null?void 0:r.indexInGroupEntries},this._contextIsDirty||(this._contextIsDirty=!r||r.object!==t||r.type!==this._bindings[e].type)},n.prototype.setStorageTexture=function(e,t){var i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:u.StorageTexture,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}},n.prototype.setUniformBuffer=function(e,t){var i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:u.UniformBuffer,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}},n.prototype.setStorageBuffer=function(e,t){var i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:u.StorageBuffer,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}},n.prototype.setTextureSampler=function(e,t){var i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||!t.compareSampler(i.object)),this._bindings[e]={type:u.Sampler,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}},n.prototype.isReady=function(){var e=this._effect;for(var t in this._bindings){var i=this._bindings[t],r=i.type,o=i.object;switch(r){case u.Texture:case u.TextureWithoutSampler:case u.StorageTexture:{var s=o;if(!s.isReady())return!1;break}}}var a=[],p=this._shaderPath;if(this._options.defines)for(var c=0;c<this._options.defines.length;c++)a.push(this._options.defines[c]);var d=a.join(`
`);return this._cachedDefines!==d&&(this._cachedDefines=d,e=this._engine.createComputeEffect(p,{defines:d,entryPoint:this._options.entryPoint,onCompiled:this.onCompiled,onError:this.onError}),this._effect=e),!!e.isReady()},n.prototype.dispatch=function(e,t,i){var r;if(!this.isReady())return!1;for(var o in this._bindings){var s=this._bindings[o];if(!this._options.bindingsMapping[o])throw new Error("ComputeShader ('"+this.name+"'): No binding mapping has been provided for the property '"+o+"'");if(s.type===u.Texture){var a=this._samplers[o],p=s.object;(!a||!p._texture||!a.compareSampler(p._texture))&&(this._samplers[o]=new R().setParameters(p.wrapU,p.wrapV,p.wrapR,p.anisotropicFilteringLevel,p._texture.samplingMode,(r=p._texture)===null||r===void 0?void 0:r._comparisonFunction),this._contextIsDirty=!0)}}return this._contextIsDirty&&(this._contextIsDirty=!1,this._context.clear()),this._engine.computeDispatch(this._effect,this._context,this._bindings,e,t,i,this._options.bindingsMapping),!0},n.prototype.dispatchWhenReady=function(e,t,i,r){var o=this;return r===void 0&&(r=10),new Promise(function(s){var a=function(){o.dispatch(e,t,i)?s():setTimeout(a,r)};a()})},n.prototype.serialize=function(){var e=v.Serialize(this);e.options=this._options,e.shaderPath=this._shaderPath,e.bindings={},e.textures={};for(var t in this._bindings){var i=this._bindings[t],r=i.object;switch(i.type){case u.Texture:case u.TextureWithoutSampler:case u.StorageTexture:{var o=r.serialize();o&&(e.textures[t]=o,e.bindings[t]={type:i.type});break}case u.UniformBuffer:break}}return e},n.Parse=function(e,t,i){var r=v.Parse(function(){return new n(e.name,t.getEngine(),e.shaderPath,e.options)},e,t,i);for(var o in e.textures){var s=e.bindings[o],a=O.Parse(e.textures[o],t,i);s.type===u.Texture?r.setTexture(o,a):s.type===u.TextureWithoutSampler?r.setTexture(o,a,!1):r.setStorageTexture(o,a)}return r},P([b()],n.prototype,"name",void 0),n}();E("BABYLON.ComputeShader",D);export{B as C,D as a};
