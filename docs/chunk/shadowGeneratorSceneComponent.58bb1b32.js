import{R as X,P as I,S as b}from"./shadowGenerator.96706f33.js";import{a1 as H,C as j,a as S,b as K,O as Q,af as Y,_ as $,V as p,M as D,o as ee,L as te,ai as ie,r as U}from"./test1.990751a6.js";import{B as re}from"./boundingInfo.71d69726.js";import{T as x}from"./clipPlaneVertex.58e6a1d5.js";import{M as N,C as ne}from"./materialHelper.19d69264.js";import"./effectFallbacks.db57095f.js";import"./instancesDeclaration.872520ba.js";import"./light.40a4b08b.js";import"./node.0c51c0e0.js";import"../entry/index.a3769e15.js";import"./math.size.f34aa5eb.js";import"./thinMaterialHelper.ab63cfd8.js";var se="depthPixelShader",ae=`#ifdef ALPHATEST
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
varying float vDepthMetric;
#ifdef PACKED
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#ifdef NONLINEARDEPTH
#ifdef PACKED
gl_FragColor=pack(gl_FragCoord.z);
#else
gl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);
#endif
#else
#ifdef PACKED
gl_FragColor=pack(vDepthMetric);
#else
gl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);
#endif
#endif
}`;H.ShadersStore[se]=ae;var oe="depthVertexShader",he=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;
uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
varying float vDepthMetric;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#include<clipPlaneVertex>
gl_Position=viewProjection*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));
#else
vDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));
#endif
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
}
`;H.ShadersStore[oe]=he;var ue=function(){function f(i,e,t,n,r){e===void 0&&(e=1),t===void 0&&(t=null),n===void 0&&(n=!1),r===void 0&&(r=x.TRILINEAR_SAMPLINGMODE);var s=this;this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this._scene=i,this._storeNonLinearDepth=n,this.isPacked=e===0,this.isPacked?this._clearColor=new j(1,1,1,1):this._clearColor=new j(1,0,0,1),f._SceneComponentInitialization(this._scene);var c=i.getEngine();this._camera=t,r!==x.NEAREST_SAMPLINGMODE&&(e===1&&!c._caps.textureFloatLinearFiltering&&(r=x.NEAREST_SAMPLINGMODE),e===2&&!c._caps.textureHalfFloatLinearFiltering&&(r=x.NEAREST_SAMPLINGMODE));var o=this.isPacked||!c._features.supportExtendedTextureFormats?5:6;this._depthMap=new X("DepthRenderer",{width:c.getRenderWidth(),height:c.getRenderHeight()},this._scene,!1,!0,e,!1,r,void 0,void 0,void 0,o),this._depthMap.wrapU=x.CLAMP_ADDRESSMODE,this._depthMap.wrapV=x.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(function(h){h.clear(s._clearColor,!0,!0,!0)}),this._depthMap.onBeforeBindObservable.add(function(){var h;(h=c._debugPushGroup)===null||h===void 0||h.call(c,"depth renderer",1)}),this._depthMap.onAfterUnbindObservable.add(function(){var h;(h=c._debugPopGroup)===null||h===void 0||h.call(c,1)}),this._depthMap.customIsReadyFunction=function(h,v){if(!h.isReady(!1))return!1;if(v===0&&h.subMeshes)for(var l=0;l<h.subMeshes.length;++l){var d=h.subMeshes[l],u=d.getRenderingMesh(),m=u._getInstancesRenderList(d._id,!!d.getReplacementMesh()),_=c.getCaps().instancedArrays&&(m.visibleInstances[d._id]!==null&&m.visibleInstances[d._id]!==void 0||u.hasThinInstances);if(!s.isReady(d,_))return!1}return!0};var a=function(h){var v,l,d=h.getRenderingMesh(),u=h.getEffectiveMesh(),m=s._scene,_=m.getEngine(),C=h.getMaterial();if(u._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!(!C||u.infiniteDistance||C.disableDepthWrite||h.verticesCount===0||h._renderId===m.getRenderId())){var A=u._getWorldMatrixDeterminant()<0,R=(v=d.overrideMaterialSideOrientation)!==null&&v!==void 0?v:C.sideOrientation;A&&(R=R===0?1:0);var P=R===0;_.setState(C.backFaceCulling,0,!1,P,C.cullBackFaces);var E=d._getInstancesRenderList(h._id,!!h.getReplacementMesh());if(!E.mustReturn){var L=_.getCaps().instancedArrays&&(E.visibleInstances[h._id]!==null&&E.visibleInstances[h._id]!==void 0||d.hasThinInstances),y=s._camera||m.activeCamera;if(s.isReady(h,L)&&y){h._renderId=m.getRenderId();var w=(l=u._internalAbstractMeshDataInfo._materialForRenderPass)===null||l===void 0?void 0:l[_.currentRenderPassId],F=h._getDrawWrapper();!F&&w&&(F=w._getDrawWrapper());var q=y.mode===ne.ORTHOGRAPHIC_CAMERA;if(!F)return;var M=F.effect;_.enableEffect(F),L||d._bind(h,M,C.fillMode),w?w.bindForSubMesh(u.getWorldMatrix(),u,h):(M.setMatrix("viewProjection",m.getTransformMatrix()),M.setMatrix("world",u.getWorldMatrix()));var B=void 0,V=void 0;if(q?(B=!_.useReverseDepthBuffer&&_.isNDCHalfZRange?0:1,V=_.useReverseDepthBuffer&&_.isNDCHalfZRange?0:1):(B=_.useReverseDepthBuffer&&_.isNDCHalfZRange?y.minZ:_.isNDCHalfZRange?0:y.minZ,V=_.useReverseDepthBuffer&&_.isNDCHalfZRange?0:y.maxZ),M.setFloat2("depthValues",B,B+V),!w){if(C&&C.needAlphaTesting()){var W=C.getAlphaTestTexture();W&&(M.setTexture("diffuseSampler",W),M.setMatrix("diffuseMatrix",W.getTextureMatrix()))}if(d.useBones&&d.computeBonesUsingShaders&&d.skeleton){var O=d.skeleton;if(O.isUsingTextureForMatrices){var k=O.getTransformMatrixTexture(d);if(!k)return;M.setTexture("boneSampler",k),M.setFloat("boneTextureWidth",4*(O.bones.length+1))}else M.setMatrices("mBones",O.getTransformMatrices(d))}N.BindClipPlane(M,m),N.BindMorphTargetParameters(d,M),d.morphTargetManager&&d.morphTargetManager.isUsingTextureForTargets&&d.morphTargetManager._bind(M)}d._processRendering(u,h,M,C.fillMode,E,L,function(me,J){return M.setMatrix("world",J)})}}}};this._depthMap.customRenderFunction=function(h,v,l,d){var u;if(d.length)for(u=0;u<d.length;u++)a(d.data[u]);for(u=0;u<h.length;u++)a(h.data[u]);for(u=0;u<v.length;u++)a(v.data[u]);if(s.forceDepthWriteTransparentMeshes)for(u=0;u<l.length;u++)a(l.data[u]);else for(u=0;u<l.length;u++)l.data[u].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}return f.prototype.setMaterialForRendering=function(i,e){this._depthMap.setMaterialForRendering(i,e)},f.prototype.isReady=function(i,e){var t,n=this._scene.getEngine(),r=i.getMesh(),s=r.getScene(),c=(t=r._internalAbstractMeshDataInfo._materialForRenderPass)===null||t===void 0?void 0:t[n.currentRenderPassId];if(c)return c.isReadyForSubMesh(r,i,e);var o=i.getMaterial();if(!o||o.disableDepthWrite)return!1;var a=[],h=[S.PositionKind];if(o&&o.needAlphaTesting()&&o.getAlphaTestTexture()&&(a.push("#define ALPHATEST"),r.isVerticesDataPresent(S.UVKind)&&(h.push(S.UVKind),a.push("#define UV1")),r.isVerticesDataPresent(S.UV2Kind)&&(h.push(S.UV2Kind),a.push("#define UV2"))),r.useBones&&r.computeBonesUsingShaders){h.push(S.MatricesIndicesKind),h.push(S.MatricesWeightsKind),r.numBoneInfluencers>4&&(h.push(S.MatricesIndicesExtraKind),h.push(S.MatricesWeightsExtraKind)),a.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),a.push("#define BonesPerMesh "+(r.skeleton?r.skeleton.bones.length+1:0));var v=i.getRenderingMesh().skeleton;v!=null&&v.isUsingTextureForMatrices&&a.push("#define BONETEXTURE")}else a.push("#define NUM_BONE_INFLUENCERS 0");var l=r.morphTargetManager,d=0;l&&l.numInfluencers>0&&(d=l.numInfluencers,a.push("#define MORPHTARGETS"),a.push("#define NUM_MORPH_INFLUENCERS "+d),l.isUsingTextureForTargets&&a.push("#define MORPHTARGETS_TEXTURE"),N.PrepareAttributesForMorphTargetsInfluencers(h,r,d)),e&&(a.push("#define INSTANCES"),N.PushAttributesForInstances(h),i.getRenderingMesh().hasThinInstances&&a.push("#define THIN_INSTANCES")),this._storeNonLinearDepth&&a.push("#define NONLINEARDEPTH"),this.isPacked&&a.push("#define PACKED"),s.clipPlane&&a.push("#define CLIPPLANE"),s.clipPlane2&&a.push("#define CLIPPLANE2"),s.clipPlane3&&a.push("#define CLIPPLANE3"),s.clipPlane4&&a.push("#define CLIPPLANE4"),s.clipPlane5&&a.push("#define CLIPPLANE5"),s.clipPlane6&&a.push("#define CLIPPLANE6");var u=i._getDrawWrapper(void 0,!0),m=u.defines,_=a.join(`
`);return m!==_&&u.setEffect(n.createEffect("depth",h,["world","mBones","boneTextureWidth","viewProjection","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6"],["diffuseSampler","morphTargets","boneSampler"],_,void 0,void 0,void 0,{maxSimultaneousMorphTargets:d}),_),u.effect.isReady()},f.prototype.getDepthMap=function(){return this._depthMap},f.prototype.dispose=function(){var i=[];for(var e in this._scene._depthRenderer){var t=this._scene._depthRenderer[e];t===this&&i.push(e)}if(i.length>0){this._depthMap.dispose();for(var n=0,r=i;n<r.length;n++){var e=r[n];delete this._scene._depthRenderer[e]}}},f._SceneComponentInitialization=function(i){throw K("DepthRendererSceneComponent")},f}(),fe="minmaxReduxPixelShader",ce=`varying vec2 vUV;
uniform sampler2D textureSampler;
#if defined(INITIAL)
uniform sampler2D sourceTexture;
uniform vec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*(texSize-1.0));
float f1=texelFetch(sourceTexture,coord,0).r;
float f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;
float f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;
float f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;
float minz=min(min(min(f1,f2),f3),f4);
#ifdef DEPTH_REDUX
float maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);
#else
float maxz=max(max(max(f1,f2),f3),f4);
#endif
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(MAIN)
uniform vec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*(texSize-1.0));
vec2 f1=texelFetch(textureSampler,coord,0).rg;
vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;
vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;
vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;
float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);
float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(ONEBEFORELAST)
uniform ivec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*vec2(texSize-1));
vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;
vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;
vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;
vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;
float minz=min(f1.x,f2.x);
float maxz=max(f1.y,f2.y);
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(LAST)
void main(void)
{
glFragColor=vec4(0.);
if (true) { 
discard;
}
}
#endif
`;H.ShadersStore[fe]=ce;var de=function(){function f(i){var e=this;this.onAfterReductionPerformed=new Q,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=i,this._postProcessManager=new Y(i.getScene()),this._onContextRestoredObserver=i.getEngine().onContextRestoredObservable.add(function(){e._postProcessManager._rebuild()})}return Object.defineProperty(f.prototype,"sourceTexture",{get:function(){return this._sourceTexture},enumerable:!1,configurable:!0}),f.prototype.setSourceTexture=function(i,e,t,n){var r=this;if(t===void 0&&(t=2),n===void 0&&(n=!0),i!==this._sourceTexture){this.dispose(!1),this._sourceTexture=i,this._reductionSteps=[],this._forceFullscreenViewport=n;var s=this._camera.getScene(),c=new I("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,s.getEngine(),!1,"#define INITIAL"+(e?`
#define DEPTH_REDUX`:""),t,void 0,void 0,void 0,7);c.autoClear=!1,c.forceFullscreenViewport=n;var o=this._sourceTexture.getRenderWidth(),a=this._sourceTexture.getRenderHeight();c.onApply=function(d,u){return function(m){m.setTexture("sourceTexture",r._sourceTexture),m.setFloat2("texSize",d,u)}}(o,a),this._reductionSteps.push(c);for(var h=1;o>1||a>1;){o=Math.max(Math.round(o/2),1),a=Math.max(Math.round(a/2),1);var v=new I("Reduction phase "+h,"minmaxRedux",["texSize"],null,{width:o,height:a},null,1,s.getEngine(),!1,"#define "+(o==1&&a==1?"LAST":o==1||a==1?"ONEBEFORELAST":"MAIN"),t,void 0,void 0,void 0,7);if(v.autoClear=!1,v.forceFullscreenViewport=n,v.onApply=function(d,u){return function(m){d==1||u==1?m.setInt2("texSize",d,u):m.setFloat2("texSize",d,u)}}(o,a),this._reductionSteps.push(v),h++,o==1&&a==1){var l=function(d,u,m){var _=new Float32Array(4*d*u),C={min:0,max:0};return function(){s.getEngine()._readTexturePixels(m.inputTexture.texture,d,u,-1,0,_,!1),C.min=_[0],C.max=_[1],r.onAfterReductionPerformed.notifyObservers(C)}};v.onAfterRenderObservable.add(l(o,a,v))}}}},Object.defineProperty(f.prototype,"refreshRate",{get:function(){return this._sourceTexture?this._sourceTexture.refreshRate:-1},set:function(i){this._sourceTexture&&(this._sourceTexture.refreshRate=i)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"activated",{get:function(){return this._activated},enumerable:!1,configurable:!0}),f.prototype.activate=function(){var i=this;this._onAfterUnbindObserver||!this._sourceTexture||(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add(function(){var e,t,n=i._camera.getScene().getEngine();(e=n._debugPushGroup)===null||e===void 0||e.call(n,"min max reduction",1),i._reductionSteps[0].activate(i._camera),i._postProcessManager.directRender(i._reductionSteps,i._reductionSteps[0].inputTexture,i._forceFullscreenViewport),n.unBindFramebuffer(i._reductionSteps[0].inputTexture,!1),(t=n._debugPopGroup)===null||t===void 0||t.call(n,1)}),this._activated=!0)},f.prototype.deactivate=function(){!this._onAfterUnbindObserver||!this._sourceTexture||(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)},f.prototype.dispose=function(i){if(i===void 0&&(i=!0),i&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(var e=0;e<this._reductionSteps.length;++e)this._reductionSteps[e].dispose();this._reductionSteps=null}this._postProcessManager&&i&&this._postProcessManager.dispose(),this._sourceTexture=null},f}(),le=function(f){$(i,f);function i(e){return f.call(this,e)||this}return Object.defineProperty(i.prototype,"depthRenderer",{get:function(){return this._depthRenderer},enumerable:!1,configurable:!0}),i.prototype.setDepthRenderer=function(e,t,n){e===void 0&&(e=null),t===void 0&&(t=2),n===void 0&&(n=!0);var r=this._camera.getScene();this._depthRenderer&&(delete r._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),e===null&&(r._depthRenderer||(r._depthRenderer={}),e=this._depthRenderer=new ue(r,t,this._camera,!1,1),e.enabled=!1,this._depthRendererId="minmax"+this._camera.id,r._depthRenderer[this._depthRendererId]=e),f.prototype.setSourceTexture.call(this,e.getDepthMap(),!0,t,n)},i.prototype.setSourceTexture=function(e,t,n,r){n===void 0&&(n=2),r===void 0&&(r=!0),f.prototype.setSourceTexture.call(this,e,t,n,r)},i.prototype.activate=function(){this._depthRenderer&&(this._depthRenderer.enabled=!0),f.prototype.activate.call(this)},i.prototype.deactivate=function(){f.prototype.deactivate.call(this),this._depthRenderer&&(this._depthRenderer.enabled=!1)},i.prototype.dispose=function(e){if(e===void 0&&(e=!0),f.prototype.dispose.call(this,e),this._depthRenderer&&e){var t=this._depthRenderer.getDepthMap().getScene();t&&delete t._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}},i}(de),Z=p.Up(),_e=p.Zero(),g=new p,T=new p,z=new D,G=function(f){$(i,f);function i(e,t,n){var r=this;return i.IsSupported?(r=f.call(this,e,t,n)||this,r.usePercentageCloserFiltering=!0,r):(te.Error("CascadedShadowMap is not supported by the current engine."),r)}return i.prototype._validateFilter=function(e){return e===b.FILTER_NONE||e===b.FILTER_PCF||e===b.FILTER_PCSS?e:(console.error('Unsupported filter "'+e+'"!'),b.FILTER_NONE)},Object.defineProperty(i.prototype,"numCascades",{get:function(){return this._numCascades},set:function(e){e=Math.min(Math.max(e,i.MIN_CASCADES_COUNT),i.MAX_CASCADES_COUNT),e!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"freezeShadowCastersBoundingInfo",{get:function(){return this._freezeShadowCastersBoundingInfo},set:function(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),!this._freezeShadowCastersBoundingInfoObservable&&!e&&(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(this._computeShadowCastersBoundingInfo.bind(this))),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()},enumerable:!1,configurable:!0}),i.prototype._computeShadowCastersBoundingInfo=function(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._shadowMap&&this._shadowMap.renderList){for(var e=this._shadowMap.renderList,t=0;t<e.length;t++){var n=e[t];if(!!n){var r=n.getBoundingInfo(),s=r.boundingBox;this._scbiMin.minimizeInPlace(s.minimumWorld),this._scbiMax.maximizeInPlace(s.maximumWorld)}}for(var c=this._scene.meshes,t=0;t<c.length;t++){var n=c[t];if(!(!n||!n.isVisible||!n.isEnabled||!n.receiveShadows)){var r=n.getBoundingInfo(),s=r.boundingBox;this._scbiMin.minimizeInPlace(s.minimumWorld),this._scbiMax.maximizeInPlace(s.maximumWorld)}}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)},Object.defineProperty(i.prototype,"shadowCastersBoundingInfo",{get:function(){return this._shadowCastersBoundingInfo},set:function(e){this._shadowCastersBoundingInfo=e},enumerable:!1,configurable:!0}),i.prototype.setMinMaxDistance=function(e,t){this._minDistance===e&&this._maxDistance===t||(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)},Object.defineProperty(i.prototype,"minDistance",{get:function(){return this._minDistance},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"maxDistance",{get:function(){return this._maxDistance},enumerable:!1,configurable:!0}),i.prototype.getClassName=function(){return i.CLASSNAME},i.prototype.getCascadeMinExtents=function(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null},i.prototype.getCascadeMaxExtents=function(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null},Object.defineProperty(i.prototype,"shadowMaxZ",{get:function(){return!this._scene||!this._scene.activeCamera?0:this._shadowMaxZ},set:function(e){if(!this._scene||!this._scene.activeCamera){this._shadowMaxZ=e;return}this._shadowMaxZ===e||e<this._scene.activeCamera.minZ||e>this._scene.activeCamera.maxZ||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"debug",{get:function(){return this._debug},set:function(e){this._debug=e,this._light._markMeshesAsLightDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"depthClamp",{get:function(){return this._depthClamp},set:function(e){this._depthClamp=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"cascadeBlendPercentage",{get:function(){return this._cascadeBlendPercentage},set:function(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"lambda",{get:function(){return this._lambda},set:function(e){var t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)},enumerable:!1,configurable:!0}),i.prototype.getCascadeViewMatrix=function(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null},i.prototype.getCascadeProjectionMatrix=function(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null},i.prototype.getCascadeTransformMatrix=function(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null},i.prototype.setDepthRenderer=function(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)},Object.defineProperty(i.prototype,"autoCalcDepthBounds",{get:function(){return this._autoCalcDepthBounds},set:function(e){var t=this,n=this._scene.activeCamera;if(!!n){if(this._autoCalcDepthBounds=e,!e){this._depthReducer&&this._depthReducer.deactivate(),this.setMinMaxDistance(0,1);return}this._depthReducer||(this._depthReducer=new le(n),this._depthReducer.onAfterReductionPerformed.add(function(r){var s=r.min,c=r.max;s>=c&&(s=0,c=1),(s!=t._minDistance||c!=t._maxDistance)&&t.setMinMaxDistance(s,c)}),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"autoCalcDepthBoundsRefreshRate",{get:function(){var e,t,n;return(n=(t=(e=this._depthReducer)===null||e===void 0?void 0:e.depthRenderer)===null||t===void 0?void 0:t.getDepthMap().refreshRate)!==null&&n!==void 0?n:-1},set:function(e){var t;!((t=this._depthReducer)===null||t===void 0)&&t.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)},enumerable:!1,configurable:!0}),i.prototype.splitFrustum=function(){this._breaksAreDirty=!0},i.prototype._splitFrustum=function(){var e=this._scene.activeCamera;if(!!e){for(var t=e.minZ,n=e.maxZ,r=n-t,s=this._minDistance,c=this._shadowMaxZ<n&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(n-t),this._maxDistance):this._maxDistance,o=t+s*r,a=t+c*r,h=a-o,v=a/o,l=0;l<this._cascades.length;++l){var d=(l+1)/this._numCascades,u=o*Math.pow(v,d),m=o+h*d,_=this._lambda*(u-m)+m;this._cascades[l].prevBreakDistance=l===0?s:this._cascades[l-1].breakDistance,this._cascades[l].breakDistance=(_-t)/r,this._viewSpaceFrustumsZ[l]=_,this._frustumLengths[l]=(this._cascades[l].breakDistance-this._cascades[l].prevBreakDistance)*r}this._breaksAreDirty=!1}},i.prototype._computeMatrices=function(){var e=this._scene,t=e.activeCamera;if(!!t){p.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),Math.abs(p.Dot(this._lightDirection,p.Up()))===1&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);for(var n=e.getEngine().useReverseDepthBuffer,r=0;r<this._numCascades;++r){this._computeFrustumInWorldSpace(r),this._computeCascadeFrustum(r),this._cascadeMaxExtents[r].subtractToRef(this._cascadeMinExtents[r],g),this._frustumCenter[r].addToRef(this._lightDirection.scale(this._cascadeMinExtents[r].z),this._shadowCameraPos[r]),D.LookAtLHToRef(this._shadowCameraPos[r],this._frustumCenter[r],Z,this._viewMatrices[r]);var s=0,c=g.z,o=this._shadowCastersBoundingInfo;o.update(this._viewMatrices[r]),c=Math.min(c,o.boundingBox.maximumWorld.z),!this._depthClamp||this.filter===b.FILTER_PCSS?s=Math.min(s,o.boundingBox.minimumWorld.z):s=Math.max(s,o.boundingBox.minimumWorld.z),D.OrthoOffCenterLHToRef(this._cascadeMinExtents[r].x,this._cascadeMaxExtents[r].x,this._cascadeMinExtents[r].y,this._cascadeMaxExtents[r].y,n?c:s,n?s:c,this._projectionMatrices[r],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[r].z=s,this._cascadeMaxExtents[r].z=c,this._viewMatrices[r].multiplyToRef(this._projectionMatrices[r],this._transformMatrices[r]),p.TransformCoordinatesToRef(_e,this._transformMatrices[r],g),g.scaleInPlace(this._mapSize/2),T.copyFromFloats(Math.round(g.x),Math.round(g.y),Math.round(g.z)),T.subtractInPlace(g).scaleInPlace(2/this._mapSize),D.TranslationToRef(T.x,T.y,0,z),this._projectionMatrices[r].multiplyToRef(z,this._projectionMatrices[r]),this._viewMatrices[r].multiplyToRef(this._projectionMatrices[r],this._transformMatrices[r]),this._transformMatrices[r].copyToArray(this._transformMatricesAsArray,r*16)}}},i.prototype._computeFrustumInWorldSpace=function(e){if(!!this._scene.activeCamera){var t=this._cascades[e].prevBreakDistance,n=this._cascades[e].breakDistance,r=this._scene.getEngine().isNDCHalfZRange;this._scene.activeCamera.getViewMatrix();for(var s=D.Invert(this._scene.activeCamera.getTransformationMatrix()),c=this._scene.getEngine().useReverseDepthBuffer?4:0,o=0;o<i._FrustumCornersNDCSpace.length;++o)g.copyFrom(i._FrustumCornersNDCSpace[(o+c)%i._FrustumCornersNDCSpace.length]),r&&g.z===-1&&(g.z=0),p.TransformCoordinatesToRef(g,s,this._frustumCornersWorldSpace[e][o]);for(var o=0;o<i._FrustumCornersNDCSpace.length/2;++o)g.copyFrom(this._frustumCornersWorldSpace[e][o+4]).subtractInPlace(this._frustumCornersWorldSpace[e][o]),T.copyFrom(g).scaleInPlace(t),g.scaleInPlace(n),g.addInPlace(this._frustumCornersWorldSpace[e][o]),this._frustumCornersWorldSpace[e][o+4].copyFrom(g),this._frustumCornersWorldSpace[e][o].addInPlace(T)}},i.prototype._computeCascadeFrustum=function(e){this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0);var t=this._scene.activeCamera;if(!!t){for(var n=0;n<this._frustumCornersWorldSpace[e].length;++n)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][n]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){for(var r=0,n=0;n<this._frustumCornersWorldSpace[e].length;++n){var s=this._frustumCornersWorldSpace[e][n].subtractToRef(this._frustumCenter[e],g).length();r=Math.max(r,s)}r=Math.ceil(r*16)/16,this._cascadeMaxExtents[e].copyFromFloats(r,r,r),this._cascadeMinExtents[e].copyFromFloats(-r,-r,-r)}else{var c=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,g),D.LookAtLHToRef(c,g,Z,z);for(var n=0;n<this._frustumCornersWorldSpace[e].length;++n)p.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][n],z,g),this._cascadeMinExtents[e].minimizeInPlace(g),this._cascadeMaxExtents[e].maximizeInPlace(g)}}},i.prototype._recreateSceneUBOs=function(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(var e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer('Scene for CSM Shadow Generator (light "'.concat(this._light.name,'" cascade #').concat(e,")")))},Object.defineProperty(i,"IsSupported",{get:function(){var e=ee.LastCreatedEngine;return e?e._features.supportCSM:!1},enumerable:!1,configurable:!0}),i.prototype._initializeGenerator=function(){var e,t,n,r,s,c,o,a,h,v,l,d,u,m,_,C,A,R,P,E;this.penumbraDarkness=(e=this.penumbraDarkness)!==null&&e!==void 0?e:1,this._numCascades=(t=this._numCascades)!==null&&t!==void 0?t:i.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=(n=this.stabilizeCascades)!==null&&n!==void 0?n:!1,this._freezeShadowCastersBoundingInfoObservable=(r=this._freezeShadowCastersBoundingInfoObservable)!==null&&r!==void 0?r:null,this.freezeShadowCastersBoundingInfo=(s=this.freezeShadowCastersBoundingInfo)!==null&&s!==void 0?s:!1,this._scbiMin=(c=this._scbiMin)!==null&&c!==void 0?c:new p(0,0,0),this._scbiMax=(o=this._scbiMax)!==null&&o!==void 0?o:new p(0,0,0),this._shadowCastersBoundingInfo=(a=this._shadowCastersBoundingInfo)!==null&&a!==void 0?a:new re(new p(0,0,0),new p(0,0,0)),this._breaksAreDirty=(h=this._breaksAreDirty)!==null&&h!==void 0?h:!0,this._minDistance=(v=this._minDistance)!==null&&v!==void 0?v:0,this._maxDistance=(l=this._maxDistance)!==null&&l!==void 0?l:1,this._currentLayer=(d=this._currentLayer)!==null&&d!==void 0?d:0,this._shadowMaxZ=(_=(u=this._shadowMaxZ)!==null&&u!==void 0?u:(m=this._scene.activeCamera)===null||m===void 0?void 0:m.maxZ)!==null&&_!==void 0?_:1e4,this._debug=(C=this._debug)!==null&&C!==void 0?C:!1,this._depthClamp=(A=this._depthClamp)!==null&&A!==void 0?A:!0,this._cascadeBlendPercentage=(R=this._cascadeBlendPercentage)!==null&&R!==void 0?R:.1,this._lambda=(P=this._lambda)!==null&&P!==void 0?P:.5,this._autoCalcDepthBounds=(E=this._autoCalcDepthBounds)!==null&&E!==void 0?E:!1,this._recreateSceneUBOs(),f.prototype._initializeGenerator.call(this)},i.prototype._createTargetRenderTexture=function(){var e=this._scene.getEngine(),t={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new X(this._light.name+"_CSMShadowMap",t,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0)},i.prototype._initializeShadowMap=function(){var e=this;if(f.prototype._initializeShadowMap.call(this),this._shadowMap!==null){this._transformMatricesAsArray=new Float32Array(this._numCascades*16),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(this._numCascades*2),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(var t=0;t<this._numCascades;++t){this._cascades[t]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[t]=D.Zero(),this._projectionMatrices[t]=D.Zero(),this._transformMatrices[t]=D.Zero(),this._cascadeMinExtents[t]=new p,this._cascadeMaxExtents[t]=new p,this._frustumCenter[t]=new p,this._shadowCameraPos[t]=new p,this._frustumCornersWorldSpace[t]=new Array(i._FrustumCornersNDCSpace.length);for(var n=0;n<i._FrustumCornersNDCSpace.length;++n)this._frustumCornersWorldSpace[t][n]=new p}var r=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add(function(s){e._sceneUBOs&&e._scene.setSceneUniformBuffer(e._sceneUBOs[s]),e._currentLayer=s,e._filter===b.FILTER_PCF&&r.setColorWrite(!1),e._scene.setTransformMatrix(e.getCascadeViewMatrix(s),e.getCascadeProjectionMatrix(s)),e._useUBO&&(e._scene.getSceneUniformBuffer().unbindEffect(),e._scene.finalizeSceneUbo())}),this._shadowMap.onBeforeBindObservable.add(function(){var s;e._currentSceneUBO=e._scene.getSceneUniformBuffer(),(s=r._debugPushGroup)===null||s===void 0||s.call(r,"cascaded shadow map generation for pass id ".concat(r.currentRenderPassId),1),e._breaksAreDirty&&e._splitFrustum(),e._computeMatrices()}),this._splitFrustum()}},i.prototype._bindCustomEffectForRenderSubMeshForShadowMap=function(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))},i.prototype._isReadyCustomDefines=function(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==b.FILTER_PCSS?"1":"0"))},i.prototype.prepareDefines=function(e,t){f.prototype.prepareDefines.call(this,e,t);var n=this._scene,r=this._light;if(!(!n.shadowsEnabled||!r.shadowEnabled)){e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=n.useRightHandedSystem;var s=n.activeCamera;s&&this._shadowMaxZ<s.maxZ&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),this.cascadeBlendPercentage===0&&(e["SHADOWCSMNOBLEND"+t]=!0)}},i.prototype.bindShadowLight=function(e,t){var n=this._light,r=this._scene;if(!(!r.shadowsEnabled||!n.shadowEnabled)){var s=r.activeCamera;if(!!s){var c=this.getShadowMap();if(!!c){var o=c.getSize().width;if(t.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,this.cascadeBlendPercentage===0?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===b.FILTER_PCF)t.setDepthStencilTexture("shadowSampler"+e,c),n._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),o,1/o,this.frustumEdgeFalloff,e);else if(this._filter===b.FILTER_PCSS){for(var a=0;a<this._numCascades;++a)this._lightSizeUVCorrection[a*2+0]=a===0?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[a].x-this._cascadeMinExtents[a].x),this._lightSizeUVCorrection[a*2+1]=a===0?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[a].y-this._cascadeMinExtents[a].y),this._depthCorrection[a]=a===0?1:(this._cascadeMaxExtents[a].z-this._cascadeMinExtents[a].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowSampler"+e,c),t.setTexture("depthSampler"+e,c),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),n._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/o,this._contactHardeningLightSizeUVRatio*o,this.frustumEdgeFalloff,e)}else t.setTexture("shadowSampler"+e,c),n._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),o,1/o,this.frustumEdgeFalloff,e);n._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(s),this.getLight().getDepthMinZ(s)+this.getLight().getDepthMaxZ(s),e)}}}},i.prototype.getTransformMatrix=function(){return this.getCascadeTransformMatrix(0)},i.prototype.dispose=function(){f.prototype.dispose.call(this),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)},i.prototype.serialize=function(){var e=f.prototype.serialize.call(this),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(var n=0;n<t.renderList.length;n++){var r=t.renderList[n];e.renderList.push(r.id)}return e},i.Parse=function(e,t){var n=b.Parse(e,t,function(r,s){return new i(r,s)});return e.numCascades!==void 0&&(n.numCascades=e.numCascades),e.debug!==void 0&&(n.debug=e.debug),e.stabilizeCascades!==void 0&&(n.stabilizeCascades=e.stabilizeCascades),e.lambda!==void 0&&(n.lambda=e.lambda),e.cascadeBlendPercentage!==void 0&&(n.cascadeBlendPercentage=e.cascadeBlendPercentage),e.depthClamp!==void 0&&(n.depthClamp=e.depthClamp),e.autoCalcDepthBounds!==void 0&&(n.autoCalcDepthBounds=e.autoCalcDepthBounds),e.shadowMaxZ!==void 0&&(n.shadowMaxZ=e.shadowMaxZ),e.penumbraDarkness!==void 0&&(n.penumbraDarkness=e.penumbraDarkness),e.freezeShadowCastersBoundingInfo!==void 0&&(n.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),e.minDistance!==void 0&&e.maxDistance!==void 0&&n.setMinMaxDistance(e.minDistance,e.maxDistance),n},i._FrustumCornersNDCSpace=[new p(-1,1,-1),new p(1,1,-1),new p(1,-1,-1),new p(-1,-1,-1),new p(-1,1,1),new p(1,1,1),new p(1,-1,1),new p(-1,-1,1)],i.CLASSNAME="CascadedShadowGenerator",i.DEFAULT_CASCADES_COUNT=4,i.MIN_CASCADES_COUNT=2,i.MAX_CASCADES_COUNT=4,i._SceneComponentInitialization=function(e){throw K("ShadowGeneratorSceneComponent")},i}(b);ie.AddParser(U.NAME_SHADOWGENERATOR,function(f,i){if(f.shadowGenerators!==void 0&&f.shadowGenerators!==null)for(var e=0,t=f.shadowGenerators.length;e<t;e++){var n=f.shadowGenerators[e];n.className===G.CLASSNAME?G.Parse(n,i):b.Parse(n,i)}});var pe=function(){function f(i){this.name=U.NAME_SHADOWGENERATOR,this.scene=i}return f.prototype.register=function(){this.scene._gatherRenderTargetsStage.registerStep(U.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)},f.prototype.rebuild=function(){},f.prototype.serialize=function(i){i.shadowGenerators=[];for(var e=this.scene.lights,t=0,n=e;t<n.length;t++){var r=n[t],s=r.getShadowGenerator();s&&i.shadowGenerators.push(s.serialize())}},f.prototype.addFromContainer=function(i){},f.prototype.removeFromContainer=function(i,e){},f.prototype.dispose=function(){},f.prototype._gatherRenderTargets=function(i){var e=this.scene;if(this.scene.shadowsEnabled)for(var t=0;t<e.lights.length;t++){var n=e.lights[t],r=n.getShadowGenerator();if(n.isEnabled()&&n.shadowEnabled&&r){var s=r.getShadowMap();e.textures.indexOf(s)!==-1&&i.push(s)}}},f}();b._SceneComponentInitialization=function(f){var i=f._getComponent(U.NAME_SHADOWGENERATOR);i||(i=new pe(f),f._addComponent(i))};export{pe as ShadowGeneratorSceneComponent};
