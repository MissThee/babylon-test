import{E as fe,M as j,d as _e,e as k,f as m,T as ge,V as ve}from"./@babylonjscore_Meshes.307935b5.js";import{C as _,a as l,A as H,T as i,M,b as U}from"./@babylonjscore_Maths.f3ef132c.js";import{E as ne,a as be}from"./@babylonjscore_Engines.7287f97a.js";import{S as T,E as te,c as ie,M as se,D as ye}from"./@babylonjscore_Materials.00e32dae.js";import"./@babylonjscore_Physics.24606c9c.js";import{U as me}from"./@babylonjscore_Rendering.3a43e73e.js";import{a as Pe,O as re}from"./@babylonjscore_Misc.d81f49ec.js";import{A as N}from"./@babylonjscore_Gizmos.8d63c4cf.js";import{_ as Se,b as Ve}from"./tslibtslib.b6e59fa7.js";import{S as Ae}from"./@babylonjscore_scene.fc9d9dc0.js";import{V as I}from"./@babylonjscore_Buffers.f937a5fd.js";var xe=function(){function s(e,t,o,n,h,r,a){if(t===void 0&&(t=1),o===void 0&&(o=2),a===void 0&&(a=1),this._scaleLinesFactor=4,this._instanced=!1,this.scene=null,this.scaleLines=1,e=e||ne.LastCreatedScene,!!e){if(this.scaleLines=t,!n){var u=new T("",e);u.disableLighting=!0,u.emissiveColor=_.Red().scale(.5),n=N._CreateArrow(e,u,a)}if(!h){var c=new T("",e);c.disableLighting=!0,c.emissiveColor=_.Green().scale(.5),h=N._CreateArrow(e,c,a)}if(!r){var d=new T("",e);d.disableLighting=!0,d.emissiveColor=_.Blue().scale(.5),r=N._CreateArrow(e,d,a)}this._xAxis=n,this._xAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._yAxis=h,this._yAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._zAxis=r,this._zAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),o!=null&&(s._SetRenderingGroupId(this._xAxis,o),s._SetRenderingGroupId(this._yAxis,o),s._SetRenderingGroupId(this._zAxis,o)),this.scene=e,this.update(new l,l.Right(),l.Up(),l.Forward())}}return Object.defineProperty(s.prototype,"xAxis",{get:function(){return this._xAxis},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"yAxis",{get:function(){return this._yAxis},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"zAxis",{get:function(){return this._zAxis},enumerable:!1,configurable:!0}),s.prototype.update=function(e,t,o,n){this._xAxis.position.copyFrom(e),this._xAxis.setDirection(t),this._xAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._yAxis.position.copyFrom(e),this._yAxis.setDirection(o),this._yAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._zAxis.position.copyFrom(e),this._zAxis.setDirection(n),this._zAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor)},s.prototype.createInstance=function(){var e=N._CreateArrowInstance(this.scene,this._xAxis),t=N._CreateArrowInstance(this.scene,this._yAxis),o=N._CreateArrowInstance(this.scene,this._zAxis),n=new s(this.scene,this.scaleLines,null,e,t,o);return n._instanced=!0,n},s.prototype.dispose=function(){this._xAxis&&this._xAxis.dispose(!1,!this._instanced),this._yAxis&&this._yAxis.dispose(!1,!this._instanced),this._zAxis&&this._zAxis.dispose(!1,!this._instanced),this.scene=null},s._SetRenderingGroupId=function(e,t){e.getChildMeshes().forEach(function(o){o.renderingGroupId=t})},s}();(function(s){Se(e,s);function e(t,o,n,h){h===void 0&&(h=1);var r=s.call(this,t,h)||this;return r.pos=l.Zero(),r.xaxis=l.Zero(),r.yaxis=l.Zero(),r.zaxis=l.Zero(),r.mesh=n,r.bone=o,r}return e.prototype.update=function(){if(!(!this.mesh||!this.bone)){var t=this.bone;t.getAbsolutePositionToRef(this.mesh,this.pos),t.getDirectionToRef(H.X,this.mesh,this.xaxis),t.getDirectionToRef(H.Y,this.mesh,this.yaxis),t.getDirectionToRef(H.Z,this.mesh,this.zaxis),s.prototype.update.call(this,this.pos,this.xaxis,this.yaxis,this.zaxis)}},e.prototype.dispose=function(){this.mesh&&(this.mesh=null,this.bone=null,s.prototype.dispose.call(this))},e})(xe);Object.defineProperty(Ae.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new Le(this)),this._debugLayer},enumerable:!0,configurable:!0});var oe;(function(s){s[s.Properties=0]="Properties",s[s.Debug=1]="Debug",s[s.Statistics=2]="Statistics",s[s.Tools=3]="Tools",s[s.Settings=4]="Settings"})(oe||(oe={}));var Le=function(){function s(e){var t=this;this.BJSINSPECTOR=this._getGlobalInspector(),this._scene=e||ne.LastCreatedScene,this._scene&&this._scene.onDisposeObservable.add(function(){t._scene._debugLayer&&t._scene._debugLayer.hide()})}return Object.defineProperty(s.prototype,"onPropertyChangedObservable",{get:function(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable:(this._onPropertyChangedObservable||(this._onPropertyChangedObservable=new re),this._onPropertyChangedObservable)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"onSelectionChangedObservable",{get:function(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable:(this._onSelectionChangedObservable||(this._onSelectionChangedObservable=new re),this._onSelectionChangedObservable)},enumerable:!1,configurable:!0}),s.prototype._createInspector=function(e){if(!this.isVisible()){if(this._onPropertyChangedObservable){for(var t=0,o=this._onPropertyChangedObservable.observers;t<o.length;t++){var n=o[t];this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable.add(n)}this._onPropertyChangedObservable.clear(),this._onPropertyChangedObservable=void 0}if(this._onSelectionChangedObservable){for(var h=0,r=this._onSelectionChangedObservable.observers;h<r.length;h++){var n=r[h];this.BJSINSPECTOR.Inspector.OnSelectionChangedObservable.add(n)}this._onSelectionChangedObservable.clear(),this._onSelectionChangedObservable=void 0}var a=Ve({overlay:!1,showExplorer:!0,showInspector:!0,embedMode:!1,handleResize:!0,enablePopup:!0},e);this.BJSINSPECTOR=this.BJSINSPECTOR||this._getGlobalInspector(),this.BJSINSPECTOR.Inspector.Show(this._scene,a)}},s.prototype.select=function(e,t){this.BJSINSPECTOR&&(t&&(Object.prototype.toString.call(t)=="[object String]"?this.BJSINSPECTOR.Inspector.MarkLineContainerTitleForHighlighting(t):this.BJSINSPECTOR.Inspector.MarkMultipleLineContainerTitlesForHighlighting(t)),this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable.notifyObservers(e))},s.prototype._getGlobalInspector=function(){if(typeof INSPECTOR!="undefined")return INSPECTOR;if(typeof BABYLON!="undefined"&&typeof BABYLON.Inspector!="undefined")return BABYLON},s.prototype.isVisible=function(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.IsVisible},s.prototype.hide=function(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.Hide()},s.prototype.setAsActiveScene=function(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector._SetNewScene(this._scene)},s.prototype.show=function(e){var t=this;return new Promise(function(o){if(typeof t.BJSINSPECTOR=="undefined"){var n=e&&e.inspectorURL?e.inspectorURL:s.InspectorURL;Pe.LoadScript(n,function(){t._createInspector(e),o(t)})}else t._createInspector(e),o(t)})},s.InspectorURL="https://unpkg.com/babylonjs-inspector@".concat(be.Version,"/babylon.inspector.bundle.js"),s}();(function(){function s(e,t,o,n,h,r){n===void 0&&(n=!0),h===void 0&&(h=3),r===void 0&&(r={});var a,u,c,d,v,g,f,b,y,p,P,x,O,R;this.skeleton=e,this.mesh=t,this.autoUpdateBonesMatrices=n,this.renderingGroupId=h,this.options=r,this.color=_.White(),this._debugLines=new Array,this._localAxes=null,this._isEnabled=!0,this._obs=null,this._scene=o,this._ready=!1,r.pauseAnimations=(a=r.pauseAnimations)!==null&&a!==void 0?a:!0,r.returnToRest=(u=r.returnToRest)!==null&&u!==void 0?u:!1,r.displayMode=(c=r.displayMode)!==null&&c!==void 0?c:s.DISPLAY_LINES,r.displayOptions=(d=r.displayOptions)!==null&&d!==void 0?d:{},r.displayOptions.midStep=(v=r.displayOptions.midStep)!==null&&v!==void 0?v:.235,r.displayOptions.midStepFactor=(g=r.displayOptions.midStepFactor)!==null&&g!==void 0?g:.155,r.displayOptions.sphereBaseSize=(f=r.displayOptions.sphereBaseSize)!==null&&f!==void 0?f:.15,r.displayOptions.sphereScaleUnit=(b=r.displayOptions.sphereScaleUnit)!==null&&b!==void 0?b:2,r.displayOptions.sphereFactor=(y=r.displayOptions.sphereFactor)!==null&&y!==void 0?y:.865,r.displayOptions.spurFollowsChild=(p=r.displayOptions.spurFollowsChild)!==null&&p!==void 0?p:!1,r.displayOptions.showLocalAxes=(P=r.displayOptions.showLocalAxes)!==null&&P!==void 0?P:!1,r.displayOptions.localAxesSize=(x=r.displayOptions.localAxesSize)!==null&&x!==void 0?x:.075,r.computeBonesUsingShaders=(O=r.computeBonesUsingShaders)!==null&&O!==void 0?O:!0,r.useAllBones=(R=r.useAllBones)!==null&&R!==void 0?R:!0;var L=t.getVerticesData(I.MatricesIndicesKind),A=t.getVerticesData(I.MatricesWeightsKind);if(this._boneIndices=new Set,!r.useAllBones&&L&&A)for(var w=0;w<L.length;++w){var C=L[w],S=A[w];S!==0&&this._boneIndices.add(C)}this._utilityLayer=new me(this._scene,!1),this._utilityLayer.pickUtilitySceneFirst=!1,this._utilityLayer.utilityLayerScene.autoClearDepthAndStencil=!0;var V=this.options.displayMode||0;V>s.DISPLAY_SPHERE_AND_SPURS&&(V=s.DISPLAY_LINES),this.displayMode=V,this.update(),this._bindObs()}return s.CreateBoneWeightShader=function(e,t){var o,n,h,r,a,u,c=e.skeleton,d=(o=e.colorBase)!==null&&o!==void 0?o:_.Black(),v=(n=e.colorZero)!==null&&n!==void 0?n:_.Blue(),g=(h=e.colorQuarter)!==null&&h!==void 0?h:_.Green(),f=(r=e.colorHalf)!==null&&r!==void 0?r:_.Yellow(),b=(a=e.colorFull)!==null&&a!==void 0?a:_.Red(),y=(u=e.targetBoneIndex)!==null&&u!==void 0?u:0;te.ShadersStore["boneWeights:"+c.name+"VertexShader"]=`precision highp float;

        attribute vec3 position;
        attribute vec2 uv;

        uniform mat4 view;
        uniform mat4 projection;
        uniform mat4 worldViewProjection;

        #include<bonesDeclaration>
        #if NUM_BONE_INFLUENCERS == 0
            attribute vec4 matricesIndices;
            attribute vec4 matricesWeights;
        #endif
        #include<bakedVertexAnimationDeclaration>

        #include<instancesDeclaration>

        varying vec3 vColor;

        uniform vec3 colorBase;
        uniform vec3 colorZero;
        uniform vec3 colorQuarter;
        uniform vec3 colorHalf;
        uniform vec3 colorFull;

        uniform float targetBoneIndex;

        void main() {
            vec3 positionUpdated = position;

            #include<instancesVertex>
            #include<bonesVertex>
            #include<bakedVertexAnimation>

            vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);

            vec3 color = colorBase;
            float totalWeight = 0.;
            if(matricesIndices[0] == targetBoneIndex && matricesWeights[0] > 0.){
                totalWeight += matricesWeights[0];
            }
            if(matricesIndices[1] == targetBoneIndex && matricesWeights[1] > 0.){
                totalWeight += matricesWeights[1];
            }
            if(matricesIndices[2] == targetBoneIndex && matricesWeights[2] > 0.){
                totalWeight += matricesWeights[2];
            }
            if(matricesIndices[3] == targetBoneIndex && matricesWeights[3] > 0.){
                totalWeight += matricesWeights[3];
            }

            color = mix(color, colorZero, smoothstep(0., 0.25, totalWeight));
            color = mix(color, colorQuarter, smoothstep(0.25, 0.5, totalWeight));
            color = mix(color, colorHalf, smoothstep(0.5, 0.75, totalWeight));
            color = mix(color, colorFull, smoothstep(0.75, 1.0, totalWeight));
            vColor = color;

        gl_Position = projection * view * worldPos;
        }`,te.ShadersStore["boneWeights:"+c.name+"FragmentShader"]=`
            precision highp float;
            varying vec3 vPosition;

            varying vec3 vColor;

            void main() {
                vec4 color = vec4(vColor, 1.0);
                gl_FragColor = color;
            }
        `;var p=new ie("boneWeight:"+c.name,t,{vertex:"boneWeights:"+c.name,fragment:"boneWeights:"+c.name},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorBase","colorZero","colorQuarter","colorHalf","colorFull","targetBoneIndex"]});return p.setColor3("colorBase",d),p.setColor3("colorZero",v),p.setColor3("colorQuarter",g),p.setColor3("colorHalf",f),p.setColor3("colorFull",b),p.setFloat("targetBoneIndex",y),p.getClassName=function(){return"BoneWeightShader"},p.transparencyMode=se.MATERIAL_OPAQUE,p},s.CreateSkeletonMapShader=function(e,t){var o,n=e.skeleton,h=(o=e.colorMap)!==null&&o!==void 0?o:[{color:new _(1,.38,.18),location:0},{color:new _(.59,.18,1),location:.2},{color:new _(.59,1,.18),location:.4},{color:new _(1,.87,.17),location:.6},{color:new _(1,.17,.42),location:.8},{color:new _(.17,.68,1),location:1}],r=n.bones.length+1,a=s._CreateBoneMapColorBuffer(r,h,t),u=new ie("boneWeights:"+n.name,t,{vertexSource:`precision highp float;

            attribute vec3 position;
            attribute vec2 uv;

            uniform mat4 view;
            uniform mat4 projection;
            uniform mat4 worldViewProjection;
            uniform float colorMap[`+n.bones.length*4+`];

            #include<bonesDeclaration>
            #if NUM_BONE_INFLUENCERS == 0
                attribute vec4 matricesIndices;
                attribute vec4 matricesWeights;
            #endif
            #include<bakedVertexAnimationDeclaration>
            #include<instancesDeclaration>

            varying vec3 vColor;

            void main() {
                vec3 positionUpdated = position;

                #include<instancesVertex>
                #include<bonesVertex>
                #include<bakedVertexAnimation>

                vec3 color = vec3(0.);
                bool first = true;

                for (int i = 0; i < 4; i++) {
                    int boneIdx = int(matricesIndices[i]);
                    float boneWgt = matricesWeights[i];

                    vec3 c = vec3(colorMap[boneIdx * 4 + 0], colorMap[boneIdx * 4 + 1], colorMap[boneIdx * 4 + 2]);

                    if (boneWgt > 0.) {
                        if (first) {
                            first = false;
                            color = c;
                        } else {
                            color = mix(color, c, boneWgt);
                        }
                    }
                }

                vColor = color;

                vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);

                gl_Position = projection * view * worldPos;
            }`,fragmentSource:`
            precision highp float;
            varying vec3 vColor;

            void main() {
                vec4 color = vec4( vColor, 1.0 );
                gl_FragColor = color;
            }
            `},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorMap"]});return u.setFloats("colorMap",a),u.getClassName=function(){return"SkeletonMapShader"},u.transparencyMode=se.MATERIAL_OPAQUE,u},s._CreateBoneMapColorBuffer=function(e,t,o){var n=new ye("temp",{width:e,height:1},o,!1),h=n.getContext(),r=h.createLinearGradient(0,0,e,0);t.forEach(function(v){r.addColorStop(v.location,v.color.toHexString())}),h.fillStyle=r,h.fillRect(0,0,e,1),n.update();for(var a=[],u=h.getImageData(0,0,e,1).data,c=1/255,d=0;d<u.length;d++)a.push(u[d]*c);return n.dispose(),a},Object.defineProperty(s.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"utilityLayer",{get:function(){return this._utilityLayer},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"isReady",{get:function(){return this._ready},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"ready",{set:function(e){this._ready=e},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"debugMesh",{get:function(){return this._debugMesh},set:function(e){this._debugMesh=e},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"displayMode",{get:function(){return this.options.displayMode||s.DISPLAY_LINES},set:function(e){e>s.DISPLAY_SPHERE_AND_SPURS&&(e=s.DISPLAY_LINES),this.options.displayMode=e},enumerable:!1,configurable:!0}),s.prototype._bindObs=function(){var e=this;switch(this.displayMode){case s.DISPLAY_LINES:{this._obs=this.scene.onBeforeRenderObservable.add(function(){e._displayLinesUpdate()});break}}},s.prototype.update=function(){switch(this.displayMode){case s.DISPLAY_LINES:{this._displayLinesUpdate();break}case s.DISPLAY_SPHERES:{this._buildSpheresAndSpurs(!0);break}case s.DISPLAY_SPHERE_AND_SPURS:{this._buildSpheresAndSpurs(!1);break}}this._buildLocalAxes()},Object.defineProperty(s.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this.isEnabled!==e&&(this._isEnabled=e,this.debugMesh&&this.debugMesh.setEnabled(e),e&&!this._obs?this._bindObs():!e&&this._obs&&(this.scene.onBeforeRenderObservable.remove(this._obs),this._obs=null))},enumerable:!1,configurable:!0}),s.prototype._getBonePosition=function(e,t,o,n,h,r){n===void 0&&(n=0),h===void 0&&(h=0),r===void 0&&(r=0);var a=i.Matrix[0],u=t.getParent();if(a.copyFrom(t.getLocalMatrix()),n!==0||h!==0||r!==0){var c=i.Matrix[1];M.IdentityToRef(c),c.setTranslationFromFloats(n,h,r),c.multiplyToRef(a,a)}u&&a.multiplyToRef(u.getAbsoluteTransform(),a),a.multiplyToRef(o,a),e.x=a.m[12],e.y=a.m[13],e.z=a.m[14]},s.prototype._getLinesForBonesWithLength=function(e,t){for(var o=e.length,n=this.mesh,h=n.position,r=0,a=0;a<o;a++){var u=e[a],c=this._debugLines[r];u._index===-1||!this._boneIndices.has(u.getIndex())&&!this.options.useAllBones||(c||(c=[l.Zero(),l.Zero()],this._debugLines[r]=c),this._getBonePosition(c[0],u,t),this._getBonePosition(c[1],u,t,0,u.length,0),c[0].subtractInPlace(h),c[1].subtractInPlace(h),r++)}},s.prototype._getLinesForBonesNoLength=function(e){for(var t=e.length,o=0,n=this.mesh,h=n.position,r=t-1;r>=0;r--){var a=e[r],u=a.getParent();if(!(!u||!this._boneIndices.has(a.getIndex())&&!this.options.useAllBones)){var c=this._debugLines[o];c||(c=[l.Zero(),l.Zero()],this._debugLines[o]=c),a.getAbsolutePositionToRef(n,c[0]),u.getAbsolutePositionToRef(n,c[1]),c[0].subtractInPlace(h),c[1].subtractInPlace(h),o++}}},s.prototype._revert=function(e){this.options.pauseAnimations&&(this.scene.animationsEnabled=e,this.utilityLayer.utilityLayerScene.animationsEnabled=e)},s.prototype._getAbsoluteBindPoseToRef=function(e,t){if(e===null||e._index===-1){t.copyFrom(M.Identity());return}this._getAbsoluteBindPoseToRef(e.getParent(),t),e.getBaseMatrix().multiplyToRef(t,t)},s.prototype._buildSpheresAndSpurs=function(e){var t,o;e===void 0&&(e=!0),this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this._ready=!1;var n=(t=this.utilityLayer)===null||t===void 0?void 0:t.utilityLayerScene,h=this.skeleton.bones,r=[],a=[],u=this.scene.animationsEnabled;try{this.options.pauseAnimations&&(this.scene.animationsEnabled=!1,n.animationsEnabled=!1),this.options.returnToRest&&this.skeleton.returnToRest(),this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteTransforms();for(var c=Number.NEGATIVE_INFINITY,d=this.options.displayOptions||{},v=function(C){var S=h[C];if(S._index===-1||!g._boneIndices.has(S.getIndex())&&!g.options.useAllBones)return"continue";var V=new M;g._getAbsoluteBindPoseToRef(S,V);var B=new l;V.decompose(void 0,void 0,B),S.children.forEach(function(G){var Q=new M;G.getBaseMatrix().multiplyToRef(V,Q);var D=new l;Q.decompose(void 0,void 0,D);var K=l.Distance(B,D);if(K>c&&(c=K),!e){for(var q=D.clone().subtract(B.clone()),X=q.length(),$=q.normalize().scale(X),he=d.midStep||.165,ce=d.midStepFactor||.215,ue=$.scale(he),E=fe("skeletonViewer",{shape:[new l(1,-1,0),new l(1,1,0),new l(-1,1,0),new l(-1,-1,0),new l(1,-1,0)],path:[l.Zero(),ue,$],scaleFunction:function(pe){switch(pe){case 0:case 2:return 0;case 1:return X*ce}return 0},sideOrientation:j.DEFAULTSIDE,updatable:!1},n),de=E.getTotalVertices(),ee=[],Z=[],W=0;W<de;W++)ee.push(1,0,0,0),d.spurFollowsChild&&W>9?Z.push(G.getIndex(),0,0,0):Z.push(S.getIndex(),0,0,0);E.position=B.clone(),E.setVerticesData(I.MatricesWeightsKind,ee,!1),E.setVerticesData(I.MatricesIndicesKind,Z,!1),E.convertToFlatShadedMesh(),a.push(E)}});for(var ae=d.sphereBaseSize||.2,F=_e("skeletonViewer",{segments:6,diameter:ae,updatable:!0},n),le=F.getTotalVertices(),z=[],J=[],Y=0;Y<le;Y++)z.push(1,0,0,0),J.push(S.getIndex(),0,0,0);F.setVerticesData(I.MatricesWeightsKind,z,!1),F.setVerticesData(I.MatricesIndicesKind,J,!1),F.position=B.clone(),r.push([F,S])},g=this,f=0;f<h.length;f++)v(f);for(var b=d.sphereScaleUnit||2,y=d.sphereFactor||.85,p=[],f=0;f<r.length;f++){for(var P=r[f],x=P[0],O=P[1],R=1/(b/c),L=0,A=O;A.getParent()&&A.getParent().getIndex()!==-1;)L++,A=A.getParent();x.scaling.scaleInPlace(R*Math.pow(y,L)),p.push(x)}this.debugMesh=j.MergeMeshes(p.concat(a),!0,!0),this.debugMesh&&(this.debugMesh.renderingGroupId=this.renderingGroupId,this.debugMesh.skeleton=this.skeleton,this.debugMesh.parent=this.mesh,this.debugMesh.computeBonesUsingShaders=(o=this.options.computeBonesUsingShaders)!==null&&o!==void 0?o:!0,this.debugMesh.alwaysSelectAsActiveMesh=!0);var w=this.utilityLayer._getSharedGizmoLight();w.intensity=.7,this._revert(u),this.ready=!0}catch(C){console.error(C),this._revert(u),this.dispose()}},s.prototype._buildLocalAxes=function(){var e;this._localAxes&&this._localAxes.dispose(),this._localAxes=null;var t=this.options.displayOptions||{};if(!!t.showLocalAxes){var o=this._utilityLayer.utilityLayerScene,n=t.localAxesSize||.075,h=[],r=[],a=new U(1,0,0,1),u=new U(0,1,0,1),c=new U(0,0,1,1),d=[],v=[],g=6;for(var f in this.skeleton.bones){var b=this.skeleton.bones[f];if(!(b._index===-1||!this._boneIndices.has(b.getIndex())&&!this.options.useAllBones)){var y=new M,p=new l;this._getAbsoluteBindPoseToRef(b,y),y.decompose(void 0,i.Quaternion[0],p);var P=new M;i.Quaternion[0].toRotationMatrix(P);var x=l.TransformCoordinates(new l(0+n,0,0),P),O=l.TransformCoordinates(new l(0,0+n,0),P),R=l.TransformCoordinates(new l(0,0,0+n),P),L=[p,p.add(x)],A=[p,p.add(O)],w=[p,p.add(R)],C=[L,A,w],S=[[a,a],[u,u],[c,c]];h.push.apply(h,C),r.push.apply(r,S);for(var V=0;V<g;V++)d.push(1,0,0,0),v.push(b.getIndex(),0,0,0)}}this._localAxes=k("localAxes",{lines:h,colors:r,updatable:!0},o),this._localAxes.setVerticesData(I.MatricesWeightsKind,d,!1),this._localAxes.setVerticesData(I.MatricesIndicesKind,v,!1),this._localAxes.skeleton=this.skeleton,this._localAxes.renderingGroupId=this.renderingGroupId+1,this._localAxes.parent=this.mesh,this._localAxes.computeBonesUsingShaders=(e=this.options.computeBonesUsingShaders)!==null&&e!==void 0?e:!0}},s.prototype._displayLinesUpdate=function(){if(!!this._utilityLayer){this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteTransforms(),this.skeleton.bones[0].length===void 0?this._getLinesForBonesNoLength(this.skeleton.bones):this._getLinesForBonesWithLength(this.skeleton.bones,this.mesh.getWorldMatrix());var e=this._utilityLayer.utilityLayerScene;e&&(this._debugMesh?k("",{lines:this._debugLines,updatable:!0,instance:this._debugMesh},e):(this._debugMesh=k("",{lines:this._debugLines,updatable:!0,instance:null},e),this._debugMesh.renderingGroupId=this.renderingGroupId),this._debugMesh.position.copyFrom(this.mesh.position),this._debugMesh.color=this.color)}},s.prototype.changeDisplayMode=function(e){var t=!!this.isEnabled;this.displayMode!==e&&(this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.displayMode=e,this.update(),this._bindObs(),this.isEnabled=t)},s.prototype.changeDisplayOptions=function(e,t){var o=!!this.isEnabled;this.options.displayOptions[e]=t,this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.update(),this._bindObs(),this.isEnabled=o},s.prototype.dispose=function(){this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null),this._utilityLayer&&(this._utilityLayer.dispose(),this._utilityLayer=null),this.ready=!1},s.DISPLAY_LINES=0,s.DISPLAY_SPHERES=1,s.DISPLAY_SPHERE_AND_SPURS=2,s})();(function(){function s(e,t){this._oldPosition=new l(Number.NaN,Number.NaN,Number.NaN),this._oldDirection=new l(Number.NaN,Number.NaN,Number.NaN),this._transparency=.3,this._showLines=!0,this._showPlanes=!0,this._scene=e.getScene(),this._light=e,this._camera=t,this._inverseViewMatrix=M.Identity(),this._lightHelperFrustumMeshes=[],this._createGeometry(),this.show(),this.update()}return Object.defineProperty(s.prototype,"transparency",{get:function(){return this._transparency},set:function(e){this._transparency=e;for(var t=6;t<12;++t)this._lightHelperFrustumMeshes[t].material.alpha=e},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"showLines",{get:function(){return this._showLines},set:function(e){if(this._showLines!==e){this._showLines=e;for(var t=0;t<6;++t)this._lightHelperFrustumMeshes[t].setEnabled(e)}},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"showPlanes",{get:function(){return this._showPlanes},set:function(e){if(this._showPlanes!==e){this._showPlanes=e;for(var t=6;t<12;++t)this._lightHelperFrustumMeshes[t].setEnabled(e)}},enumerable:!1,configurable:!0}),s.prototype.show=function(){var e=this;this._lightHelperFrustumMeshes.forEach(function(t,o){t.setEnabled(o<6&&e._showLines||o>=6&&e._showPlanes)}),this._oldPosition.set(Number.NaN,Number.NaN,Number.NaN),this._visible=!0},s.prototype.hide=function(){this._lightHelperFrustumMeshes.forEach(function(e){e.setEnabled(!1)}),this._visible=!1},s.prototype.update=function(){var e,t,o,n,h,r;if(!!this._visible&&!(this._oldPosition.equals(this._light.position)&&this._oldDirection.equals(this._light.direction)&&this._oldAutoCalc===this._light.autoCalcShadowZBounds&&this._oldMinZ===this._light.shadowMinZ&&this._oldMaxZ===this._light.shadowMaxZ)){this._oldPosition.copyFrom(this._light.position),this._oldDirection.copyFrom(this._light.direction),this._oldAutoCalc=this._light.autoCalcShadowZBounds,this._oldMinZ=this._light.shadowMinZ,this._oldMaxZ=this._light.shadowMaxZ,i.Vector3[0].set(this._light.orthoLeft,this._light.orthoBottom,this._light.shadowMinZ!==void 0?this._light.shadowMinZ:this._camera.minZ),i.Vector3[1].set(this._light.orthoRight,this._light.orthoTop,this._light.shadowMaxZ!==void 0?this._light.shadowMaxZ:this._camera.maxZ);var a=this._getInvertViewMatrix();i.Vector3[2].copyFromFloats(i.Vector3[1].x,i.Vector3[1].y,i.Vector3[0].z),i.Vector3[3].copyFromFloats(i.Vector3[1].x,i.Vector3[0].y,i.Vector3[0].z),i.Vector3[4].copyFromFloats(i.Vector3[0].x,i.Vector3[0].y,i.Vector3[0].z),i.Vector3[5].copyFromFloats(i.Vector3[0].x,i.Vector3[1].y,i.Vector3[0].z),l.TransformCoordinatesToRef(i.Vector3[2],a,i.Vector3[2]),l.TransformCoordinatesToRef(i.Vector3[3],a,i.Vector3[3]),l.TransformCoordinatesToRef(i.Vector3[4],a,i.Vector3[4]),l.TransformCoordinatesToRef(i.Vector3[5],a,i.Vector3[5]),i.Vector3[6].copyFromFloats(i.Vector3[1].x,i.Vector3[1].y,i.Vector3[1].z),i.Vector3[7].copyFromFloats(i.Vector3[1].x,i.Vector3[0].y,i.Vector3[1].z),i.Vector3[8].copyFromFloats(i.Vector3[0].x,i.Vector3[0].y,i.Vector3[1].z),i.Vector3[9].copyFromFloats(i.Vector3[0].x,i.Vector3[1].y,i.Vector3[1].z),l.TransformCoordinatesToRef(i.Vector3[6],a,i.Vector3[6]),l.TransformCoordinatesToRef(i.Vector3[7],a,i.Vector3[7]),l.TransformCoordinatesToRef(i.Vector3[8],a,i.Vector3[8]),l.TransformCoordinatesToRef(i.Vector3[9],a,i.Vector3[9]),m("nearlines",{updatable:!0,points:this._nearLinesPoints,instance:this._lightHelperFrustumMeshes[0]},this._scene),m("farlines",{updatable:!0,points:this._farLinesPoints,instance:this._lightHelperFrustumMeshes[1]},this._scene),m("trlines",{updatable:!0,points:this._trLinesPoints,instance:this._lightHelperFrustumMeshes[2]},this._scene),m("brlines",{updatable:!0,points:this._brLinesPoints,instance:this._lightHelperFrustumMeshes[3]},this._scene),m("tllines",{updatable:!0,points:this._tlLinesPoints,instance:this._lightHelperFrustumMeshes[4]},this._scene),m("bllines",{updatable:!0,points:this._blLinesPoints,instance:this._lightHelperFrustumMeshes[5]},this._scene),i.Vector3[2].toArray(this._nearPlaneVertices,0),i.Vector3[3].toArray(this._nearPlaneVertices,3),i.Vector3[4].toArray(this._nearPlaneVertices,6),i.Vector3[5].toArray(this._nearPlaneVertices,9),(e=this._lightHelperFrustumMeshes[6].geometry)===null||e===void 0||e.updateVerticesDataDirectly("position",this._nearPlaneVertices,0),i.Vector3[6].toArray(this._farPlaneVertices,0),i.Vector3[7].toArray(this._farPlaneVertices,3),i.Vector3[8].toArray(this._farPlaneVertices,6),i.Vector3[9].toArray(this._farPlaneVertices,9),(t=this._lightHelperFrustumMeshes[7].geometry)===null||t===void 0||t.updateVerticesDataDirectly("position",this._farPlaneVertices,0),i.Vector3[2].toArray(this._rightPlaneVertices,0),i.Vector3[6].toArray(this._rightPlaneVertices,3),i.Vector3[7].toArray(this._rightPlaneVertices,6),i.Vector3[3].toArray(this._rightPlaneVertices,9),(o=this._lightHelperFrustumMeshes[8].geometry)===null||o===void 0||o.updateVerticesDataDirectly("position",this._rightPlaneVertices,0),i.Vector3[5].toArray(this._leftPlaneVertices,0),i.Vector3[9].toArray(this._leftPlaneVertices,3),i.Vector3[8].toArray(this._leftPlaneVertices,6),i.Vector3[4].toArray(this._leftPlaneVertices,9),(n=this._lightHelperFrustumMeshes[9].geometry)===null||n===void 0||n.updateVerticesDataDirectly("position",this._leftPlaneVertices,0),i.Vector3[2].toArray(this._topPlaneVertices,0),i.Vector3[6].toArray(this._topPlaneVertices,3),i.Vector3[9].toArray(this._topPlaneVertices,6),i.Vector3[5].toArray(this._topPlaneVertices,9),(h=this._lightHelperFrustumMeshes[10].geometry)===null||h===void 0||h.updateVerticesDataDirectly("position",this._topPlaneVertices,0),i.Vector3[3].toArray(this._bottomPlaneVertices,0),i.Vector3[7].toArray(this._bottomPlaneVertices,3),i.Vector3[8].toArray(this._bottomPlaneVertices,6),i.Vector3[4].toArray(this._bottomPlaneVertices,9),(r=this._lightHelperFrustumMeshes[11].geometry)===null||r===void 0||r.updateVerticesDataDirectly("position",this._bottomPlaneVertices,0)}},s.prototype.dispose=function(){this._lightHelperFrustumMeshes.forEach(function(e){var t;(t=e.material)===null||t===void 0||t.dispose(),e.dispose()}),this._rootNode.dispose()},s.prototype._createGeometry=function(){var e=this;this._rootNode=new ge("directionalLightHelperRoot_"+this._light.name,this._scene),this._rootNode.parent=this._light.parent,this._nearLinesPoints=[l.ZeroReadOnly,l.ZeroReadOnly,l.ZeroReadOnly,l.ZeroReadOnly,l.ZeroReadOnly];var t=m("nearlines",{updatable:!0,points:this._nearLinesPoints},this._scene);t.parent=this._rootNode,t.alwaysSelectAsActiveMesh=!0,this._farLinesPoints=[l.ZeroReadOnly,l.ZeroReadOnly,l.ZeroReadOnly,l.ZeroReadOnly,l.ZeroReadOnly];var o=m("farlines",{updatable:!0,points:this._farLinesPoints},this._scene);o.parent=this._rootNode,o.alwaysSelectAsActiveMesh=!0,this._trLinesPoints=[l.ZeroReadOnly,l.ZeroReadOnly];var n=m("trlines",{updatable:!0,points:this._trLinesPoints},this._scene);n.parent=this._rootNode,n.alwaysSelectAsActiveMesh=!0,this._brLinesPoints=[l.ZeroReadOnly,l.ZeroReadOnly];var h=m("brlines",{updatable:!0,points:this._brLinesPoints},this._scene);h.parent=this._rootNode,h.alwaysSelectAsActiveMesh=!0,this._tlLinesPoints=[l.ZeroReadOnly,l.ZeroReadOnly];var r=m("tllines",{updatable:!0,points:this._tlLinesPoints},this._scene);r.parent=this._rootNode,r.alwaysSelectAsActiveMesh=!0,this._blLinesPoints=[l.ZeroReadOnly,l.ZeroReadOnly];var a=m("bllines",{updatable:!0,points:this._blLinesPoints},this._scene);a.parent=this._rootNode,a.alwaysSelectAsActiveMesh=!0,this._lightHelperFrustumMeshes.push(t,o,n,h,r,a);var u=function(c,d,v){var g=new j(c+"plane",e._scene),f=new T(c+"PlaneMat",e._scene);g.material=f,g.parent=e._rootNode,g.alwaysSelectAsActiveMesh=!0,f.emissiveColor=d,f.alpha=e.transparency,f.backFaceCulling=!1,f.disableLighting=!0;var b=[0,1,2,0,2,3],y=new ve;y.positions=v,y.indices=b,y.applyToMesh(g,!0),e._lightHelperFrustumMeshes.push(g)};this._nearPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._farPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._rightPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._leftPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._topPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._bottomPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],u("near",new _(1,0,0),this._nearPlaneVertices),u("far",new _(.3,0,0),this._farPlaneVertices),u("right",new _(0,1,0),this._rightPlaneVertices),u("left",new _(0,.3,0),this._leftPlaneVertices),u("top",new _(0,0,1),this._topPlaneVertices),u("bottom",new _(0,0,.3),this._bottomPlaneVertices),this._nearLinesPoints[0]=i.Vector3[2],this._nearLinesPoints[1]=i.Vector3[3],this._nearLinesPoints[2]=i.Vector3[4],this._nearLinesPoints[3]=i.Vector3[5],this._nearLinesPoints[4]=i.Vector3[2],this._farLinesPoints[0]=i.Vector3[6],this._farLinesPoints[1]=i.Vector3[7],this._farLinesPoints[2]=i.Vector3[8],this._farLinesPoints[3]=i.Vector3[9],this._farLinesPoints[4]=i.Vector3[6],this._trLinesPoints[0]=i.Vector3[2],this._trLinesPoints[1]=i.Vector3[6],this._brLinesPoints[0]=i.Vector3[3],this._brLinesPoints[1]=i.Vector3[7],this._tlLinesPoints[0]=i.Vector3[4],this._tlLinesPoints[1]=i.Vector3[8],this._blLinesPoints[0]=i.Vector3[5],this._blLinesPoints[1]=i.Vector3[9]},s.prototype._getInvertViewMatrix=function(){return M.LookAtLHToRef(this._light.position,this._light.position.add(this._light.direction),l.UpReadOnly,this._inverseViewMatrix),this._inverseViewMatrix.invertToRef(this._inverseViewMatrix),this._inverseViewMatrix},s})();
