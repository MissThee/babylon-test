import{_ as A,a as h,b as Re,e as zr,c as er,d as tr}from"./tslibtslib.b6e59fa7.js";import{S as Ne,b as rt,E as de,a as Q}from"./@babylonjscore_Engines.77a493e8.js";import{V as L}from"./@babylonjscore_Buffers.c351261b.js";import{b as ve,C as G,P as ct,S as rr,M as q,a as K,T as Ee,c as Me,V as Te,h as X,Q as Gr,d as Ze,i as Hr,f as jr,j as xt}from"./@babylonjscore_Maths.4b8bfdd1.js";import{O as J,i as Wr,L as $,I as Yr,S as j,b,a as ae,Q as Xr,s as U,B as Kr,T as it,R as P,o as hr,X as ut,Y as qr,Z as Zr,$ as Qr,a0 as Jr,_ as Rt,G as Qe,U as $r,W as lt,e as S,K as le,a1 as We,f as Yt,a2 as dr,a3 as ei,d as ti,a4 as _r,h as ri,a5 as Xt,a6 as ke,x as ii,y as ni,a7 as ai,a8 as Ot,a9 as ir,aa as Bt,ab as Pt,D as oi,p as si,ac as ui,ad as li,ae as ci,af as nr,ag as ar,ah as fi}from"./@babylonjscore_Misc.5aaba58d.js";import{C as pi}from"./@babylonjscore_Cameras.05e2a1ea.js";import{S as Ke}from"./@babylonjscore_scene.c0faa314.js";import{a as Ye,P as hi}from"./@babylonjscore_Lights.894f8849.js";import{S as di,A as Nt}from"./@babylonjscore_Meshes.9ddea1c8.js";import"./@babylonjscore_Shaders.02c89b72.js";import{c as _i,b as mi,B as or,I as gi}from"./@babylonjscore_PostProcesses.6391d89e.js";import{S as Vt}from"./@babylonjscore_sceneComponent.5f0854c6.js";import{B as sr}from"./@babylonjscore_Particles.f14de036.js";import{C as ur}from"./@babylonjscore_Compat.1e5a884f.js";import{R as vi}from"./@babylonjscore_Rendering.1459be29.js";var Le;(function(n){n[n.GLSL=0]="GLSL",n[n.WGSL=1]="WGSL"})(Le||(Le={}));var se=function(){function n(r,e,t,i,a,o,s,u,l,c,p,d){i===void 0&&(i=null),o===void 0&&(o=null),s===void 0&&(s=null),u===void 0&&(u=null),l===void 0&&(l=null),p===void 0&&(p=""),d===void 0&&(d=Le.GLSL);var g=this,m,y,v;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new J,this.onErrorObservable=new J,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._wasPreviouslyUsingInstances=null,this._isDisposed=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this.name=r,this._key=p;var T=void 0,x=null;if(e.attributes){var E=e;if(this._engine=t,this._attributesNames=E.attributes,this._uniformsNames=E.uniformsNames.concat(E.samplers),this._samplerList=E.samplers.slice(),this.defines=E.defines,this.onError=E.onError,this.onCompiled=E.onCompiled,this._fallbacks=E.fallbacks,this._indexParameters=E.indexParameters,this._transformFeedbackVaryings=E.transformFeedbackVaryings||null,this._multiTarget=!!E.multiTarget,this._shaderLanguage=(m=E.shaderLanguage)!==null&&m!==void 0?m:Le.GLSL,E.uniformBuffersNames){this._uniformBuffersNamesList=E.uniformBuffersNames.slice();for(var O=0;O<E.uniformBuffersNames.length;O++)this._uniformBuffersNames[E.uniformBuffersNames[O]]=O}x=(y=E.processFinalCode)!==null&&y!==void 0?y:null,T=(v=E.processCodeAfterIncludes)!==null&&v!==void 0?v:void 0}else this._engine=a,this.defines=o==null?"":o,this._uniformsNames=t.concat(i),this._samplerList=i?i.slice():[],this._attributesNames=e,this._uniformBuffersNamesList=[],this._shaderLanguage=d,this.onError=l,this.onCompiled=u,this._indexParameters=c,this._fallbacks=s;this._attributeLocationByName={},this.uniqueId=n._UniqueIdSeed++;var N,w,k=Yr()?this._engine.getHostDocument():null;r.vertexSource?N="source:"+r.vertexSource:r.vertexElement?(N=k?k.getElementById(r.vertexElement):null,N||(N=r.vertexElement)):N=r.vertex||r,r.fragmentSource?w="source:"+r.fragmentSource:r.fragmentElement?(w=k?k.getElementById(r.fragmentElement):null,w||(w=r.fragmentElement)):w=r.fragment||r,this._processingContext=this._engine._getShaderProcessingContext(this._shaderLanguage);var W={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:Ne.GetShadersRepository(this._shaderLanguage),includesShadersStore:Ne.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:T},Z=[void 0,void 0],ie=function(){if(Z[0]&&Z[1]){W.isFragment=!0;var D=Z[0],ne=Z[1];rt.Process(ne,W,function(he){x&&(he=x("fragment",he));var oe=rt.Finalize(D,he,W);g._useFinalCode(oe.vertexCode,oe.fragmentCode,r)},g._engine)}};this._loadShader(N,"Vertex","",function(D){rt.Initialize(W),rt.Process(D,W,function(ne){g._rawVertexSourceCode=D,x&&(ne=x("vertex",ne)),Z[0]=ne,ie()},g._engine)}),this._loadShader(w,"Fragment","Pixel",function(D){g._rawFragmentSourceCode=D,Z[1]=D,ie()})}return Object.defineProperty(n,"ShadersRepository",{get:function(){return Ne.ShadersRepository},set:function(r){Ne.ShadersRepository=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"onBindObservable",{get:function(){return this._onBindObservable||(this._onBindObservable=new J),this._onBindObservable},enumerable:!1,configurable:!0}),n.prototype._useFinalCode=function(r,e,t){if(t){var i=t.vertexElement||t.vertex||t.spectorName||t,a=t.fragmentElement||t.fragment||t.spectorName||t;this._vertexSourceCode=(this._shaderLanguage===Le.WGSL?"//":"")+"#define SHADER_NAME vertex:"+i+`
`+r,this._fragmentSourceCode=(this._shaderLanguage===Le.WGSL?"//":"")+"#define SHADER_NAME fragment:"+a+`
`+e}else this._vertexSourceCode=r,this._fragmentSourceCode=e;this._prepareEffect()},Object.defineProperty(n.prototype,"key",{get:function(){return this._key},enumerable:!1,configurable:!0}),n.prototype.isReady=function(){try{return this._isReadyInternal()}catch{return!1}},n.prototype._isReadyInternal=function(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1},n.prototype.getEngine=function(){return this._engine},n.prototype.getPipelineContext=function(){return this._pipelineContext},n.prototype.getAttributesNames=function(){return this._attributesNames},n.prototype.getAttributeLocation=function(r){return this._attributes[r]},n.prototype.getAttributeLocationByName=function(r){return this._attributeLocationByName[r]},n.prototype.getAttributesCount=function(){return this._attributes.length},n.prototype.getUniformIndex=function(r){return this._uniformsNames.indexOf(r)},n.prototype.getUniform=function(r){return this._uniforms[r]},n.prototype.getSamplers=function(){return this._samplerList},n.prototype.getUniformNames=function(){return this._uniformsNames},n.prototype.getUniformBuffersNames=function(){return this._uniformBuffersNamesList},n.prototype.getIndexParameters=function(){return this._indexParameters},n.prototype.getCompilationError=function(){return this._compilationError},n.prototype.allFallbacksProcessed=function(){return this._allFallbacksProcessed},n.prototype.executeWhenCompiled=function(r){var e=this;if(this.isReady()){r(this);return}this.onCompileObservable.add(function(t){r(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(function(){e._checkIsReady(null)},16)},n.prototype._checkIsReady=function(r){var e=this;try{if(this._isReadyInternal())return}catch(t){this._processCompilationErrors(t,r);return}this._isDisposed||setTimeout(function(){e._checkIsReady(r)},16)},n.prototype._loadShader=function(r,e,t,i){if(typeof HTMLElement!="undefined"&&r instanceof HTMLElement){var a=Wr(r);i(a);return}if(r.substr(0,7)==="source:"){i(r.substr(7));return}if(r.substr(0,7)==="base64:"){var o=window.atob(r.substr(7));i(o);return}var s=Ne.GetShadersStore(this._shaderLanguage);if(s[r+e+"Shader"]){i(s[r+e+"Shader"]);return}if(t&&s[r+t+"Shader"]){i(s[r+t+"Shader"]);return}var u;r[0]==="."||r[0]==="/"||r.indexOf("http")>-1?u=r:u=Ne.GetShadersRepository(this._shaderLanguage)+r,this._engine._loadFile(u+"."+e.toLowerCase()+".fx",i)},Object.defineProperty(n.prototype,"vertexSourceCode",{get:function(){var r,e;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:(e=(r=this._pipelineContext)===null||r===void 0?void 0:r._getVertexShaderCode())!==null&&e!==void 0?e:this._vertexSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"fragmentSourceCode",{get:function(){var r,e;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:(e=(r=this._pipelineContext)===null||r===void 0?void 0:r._getFragmentShaderCode())!==null&&e!==void 0?e:this._fragmentSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rawVertexSourceCode",{get:function(){return this._rawVertexSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rawFragmentSourceCode",{get:function(){return this._rawFragmentSourceCode},enumerable:!1,configurable:!0}),n.prototype._rebuildProgram=function(r,e,t,i){var a=this;this._isReady=!1,this._vertexSourceCodeOverride=r,this._fragmentSourceCodeOverride=e,this.onError=function(o,s){i&&i(s)},this.onCompiled=function(){var o=a.getEngine().scenes;if(o)for(var s=0;s<o.length;s++)o[s].markAllMaterialsAsDirty(63);a._pipelineContext._handlesSpectorRebuildCallback(t)},this._fallbacks=null,this._prepareEffect()},n.prototype._prepareEffect=function(){var r=this,e=this._attributesNames,t=this.defines,i=this._pipelineContext;this._isReady=!1;try{var a=this._engine;this._pipelineContext=a.createPipelineContext(this._processingContext),this._pipelineContext._name=this._key;var o=this._rebuildProgram.bind(this);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?a._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,this._rawVertexSourceCode,this._rawFragmentSourceCode,o,null,this._transformFeedbackVaryings,this._key):a._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,this._rawVertexSourceCode,this._rawFragmentSourceCode,o,t,this._transformFeedbackVaryings,this._key),a._executeWhenRenderingStateIsCompiled(this._pipelineContext,function(){if(r._attributes=[],r._pipelineContext._fillEffectInformation(r,r._uniformBuffersNames,r._uniformsNames,r._uniforms,r._samplerList,r._samplers,e,r._attributes),e)for(var s=0;s<e.length;s++){var u=e[s];r._attributeLocationByName[u]=r._attributes[s]}a.bindSamplers(r),r._compilationError="",r._isReady=!0,r.onCompiled&&r.onCompiled(r),r.onCompileObservable.notifyObservers(r),r.onCompileObservable.clear(),r._fallbacks&&r._fallbacks.unBindMesh(),i&&r.getEngine()._deletePipelineContext(i)}),this._pipelineContext.isAsync&&this._checkIsReady(i)}catch(s){this._processCompilationErrors(s,i)}},n.prototype._getShaderCodeAndErrorLine=function(r,e,t){var i=t?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/,a=null;if(e&&r){var o=e.match(i);if(o&&o.length===2){var s=parseInt(o[1]),u=r.split(`
`,-1);u.length>=s&&(a="Offending line [".concat(s,"] in ").concat(t?"fragment":"vertex"," code: ").concat(u[s-1]))}}return[r,a]},n.prototype._processCompilationErrors=function(r,e){var t,i,a,o,s;e===void 0&&(e=null),this._compilationError=r.message;var u=this._attributesNames,l=this._fallbacks;if($.Error("Unable to compile effect:"),$.Error("Uniforms: "+this._uniformsNames.map(function(g){return" "+g})),$.Error("Attributes: "+u.map(function(g){return" "+g})),$.Error(`Defines:\r
`+this.defines),n.LogShaderCodeOnCompilationError){var c=null,p=null,d=null;!((a=this._pipelineContext)===null||a===void 0)&&a._getVertexShaderCode()&&(t=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),d=t[0],c=t[1],d&&($.Error("Vertex code:"),$.Error(d))),!((o=this._pipelineContext)===null||o===void 0)&&o._getFragmentShaderCode()&&(i=this._getShaderCodeAndErrorLine((s=this._pipelineContext)===null||s===void 0?void 0:s._getFragmentShaderCode(),this._compilationError,!0),d=i[0],p=i[1],d&&($.Error("Fragment code:"),$.Error(d))),c&&$.Error(c),p&&$.Error(p)}$.Error("Error: "+this._compilationError),e&&(this._pipelineContext=e,this._isReady=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)),l?(this._pipelineContext=null,l.hasMoreFallbacks?(this._allFallbacksProcessed=!1,$.Error("Trying next fallback."),this.defines=l.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):this._allFallbacksProcessed=!0},Object.defineProperty(n.prototype,"isSupported",{get:function(){return this._compilationError===""},enumerable:!1,configurable:!0}),n.prototype._bindTexture=function(r,e){this._engine._bindTexture(this._samplers[r],e,r)},n.prototype.setTexture=function(r,e){this._engine.setTexture(this._samplers[r],this._uniforms[r],e,r)},n.prototype.setDepthStencilTexture=function(r,e){this._engine.setDepthStencilTexture(this._samplers[r],this._uniforms[r],e,r)},n.prototype.setTextureArray=function(r,e){var t=r+"Ex";if(this._samplerList.indexOf(t+"0")===-1){for(var i=this._samplerList.indexOf(r),a=1;a<e.length;a++){var o=t+(a-1).toString();this._samplerList.splice(i+a,0,o)}for(var s=0,u=0,l=this._samplerList;u<l.length;u++){var c=l[u];this._samplers[c]=s,s+=1}}this._engine.setTextureArray(this._samplers[r],this._uniforms[r],e,r)},n.prototype.setTextureFromPostProcess=function(r,e){this._engine.setTextureFromPostProcess(this._samplers[r],e,r)},n.prototype.setTextureFromPostProcessOutput=function(r,e){this._engine.setTextureFromPostProcessOutput(this._samplers[r],e,r)},n.prototype.bindUniformBuffer=function(r,e){var t=this._uniformBuffersNames[e];t===void 0||n._BaseCache[t]===r&&this._engine._features.useUBOBindingCache||(n._BaseCache[t]=r,this._engine.bindUniformBufferBase(r,t,e))},n.prototype.bindUniformBlock=function(r,e){this._engine.bindUniformBlock(this._pipelineContext,r,e)},n.prototype.setInt=function(r,e){return this._pipelineContext.setInt(r,e),this},n.prototype.setInt2=function(r,e,t){return this._pipelineContext.setInt2(r,e,t),this},n.prototype.setInt3=function(r,e,t,i){return this._pipelineContext.setInt3(r,e,t,i),this},n.prototype.setInt4=function(r,e,t,i,a){return this._pipelineContext.setInt4(r,e,t,i,a),this},n.prototype.setIntArray=function(r,e){return this._pipelineContext.setIntArray(r,e),this},n.prototype.setIntArray2=function(r,e){return this._pipelineContext.setIntArray2(r,e),this},n.prototype.setIntArray3=function(r,e){return this._pipelineContext.setIntArray3(r,e),this},n.prototype.setIntArray4=function(r,e){return this._pipelineContext.setIntArray4(r,e),this},n.prototype.setFloatArray=function(r,e){return this._pipelineContext.setArray(r,e),this},n.prototype.setFloatArray2=function(r,e){return this._pipelineContext.setArray2(r,e),this},n.prototype.setFloatArray3=function(r,e){return this._pipelineContext.setArray3(r,e),this},n.prototype.setFloatArray4=function(r,e){return this._pipelineContext.setArray4(r,e),this},n.prototype.setArray=function(r,e){return this._pipelineContext.setArray(r,e),this},n.prototype.setArray2=function(r,e){return this._pipelineContext.setArray2(r,e),this},n.prototype.setArray3=function(r,e){return this._pipelineContext.setArray3(r,e),this},n.prototype.setArray4=function(r,e){return this._pipelineContext.setArray4(r,e),this},n.prototype.setMatrices=function(r,e){return this._pipelineContext.setMatrices(r,e),this},n.prototype.setMatrix=function(r,e){return this._pipelineContext.setMatrix(r,e),this},n.prototype.setMatrix3x3=function(r,e){return this._pipelineContext.setMatrix3x3(r,e),this},n.prototype.setMatrix2x2=function(r,e){return this._pipelineContext.setMatrix2x2(r,e),this},n.prototype.setFloat=function(r,e){return this._pipelineContext.setFloat(r,e),this},n.prototype.setBool=function(r,e){return this._pipelineContext.setInt(r,e?1:0),this},n.prototype.setVector2=function(r,e){return this._pipelineContext.setVector2(r,e),this},n.prototype.setFloat2=function(r,e,t){return this._pipelineContext.setFloat2(r,e,t),this},n.prototype.setVector3=function(r,e){return this._pipelineContext.setVector3(r,e),this},n.prototype.setFloat3=function(r,e,t,i){return this._pipelineContext.setFloat3(r,e,t,i),this},n.prototype.setVector4=function(r,e){return this._pipelineContext.setVector4(r,e),this},n.prototype.setQuaternion=function(r,e){return this._pipelineContext.setQuaternion(r,e),this},n.prototype.setFloat4=function(r,e,t,i,a){return this._pipelineContext.setFloat4(r,e,t,i,a),this},n.prototype.setColor3=function(r,e){return this._pipelineContext.setColor3(r,e),this},n.prototype.setColor4=function(r,e,t){return this._pipelineContext.setColor4(r,e,t),this},n.prototype.setDirectColor4=function(r,e){return this._pipelineContext.setDirectColor4(r,e),this},n.prototype.dispose=function(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseEffect(this),this._isDisposed=!0},n.RegisterShader=function(r,e,t,i){i===void 0&&(i=Le.GLSL),e&&(Ne.GetShadersStore(i)["".concat(r,"PixelShader")]=e),t&&(Ne.GetShadersStore(i)["".concat(r,"VertexShader")]=t)},n.ResetCache=function(){n._BaseCache={}},n.LogShaderCodeOnCompilationError=!0,n._UniqueIdSeed=0,n._BaseCache={},n.ShadersStore=Ne.ShadersStore,n.IncludesShadersStore=Ne.IncludesShadersStore,n}(),bi=function(){function n(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}return Object.defineProperty(n.prototype,"wrapU",{get:function(){return this._cachedWrapU},set:function(r){this._cachedWrapU=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wrapV",{get:function(){return this._cachedWrapV},set:function(r){this._cachedWrapV=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wrapR",{get:function(){return this._cachedWrapR},set:function(r){this._cachedWrapR=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"anisotropicFilteringLevel",{get:function(){return this._cachedAnisotropicFilteringLevel},set:function(r){this._cachedAnisotropicFilteringLevel=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"comparisonFunction",{get:function(){return this._comparisonFunction},set:function(r){this._comparisonFunction=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"useMipMaps",{get:function(){return this._useMipMaps},set:function(r){this._useMipMaps=r},enumerable:!1,configurable:!0}),n.prototype.setParameters=function(r,e,t,i,a,o){return r===void 0&&(r=1),e===void 0&&(e=1),t===void 0&&(t=1),i===void 0&&(i=1),a===void 0&&(a=2),o===void 0&&(o=0),this._cachedWrapU=r,this._cachedWrapV=e,this._cachedWrapR=t,this._cachedAnisotropicFilteringLevel=i,this.samplingMode=a,this._comparisonFunction=o,this},n.prototype.compareSampler=function(r){return this._cachedWrapU===r._cachedWrapU&&this._cachedWrapV===r._cachedWrapV&&this._cachedWrapR===r._cachedWrapR&&this._cachedAnisotropicFilteringLevel===r._cachedAnisotropicFilteringLevel&&this.samplingMode===r.samplingMode&&this._comparisonFunction===r._comparisonFunction&&this._useMipMaps===r._useMipMaps},n}(),ge;(function(n){n[n.Unknown=0]="Unknown",n[n.Url=1]="Url",n[n.Temp=2]="Temp",n[n.Raw=3]="Raw",n[n.Dynamic=4]="Dynamic",n[n.RenderTarget=5]="RenderTarget",n[n.MultiRenderTarget=6]="MultiRenderTarget",n[n.Cube=7]="Cube",n[n.CubeRaw=8]="CubeRaw",n[n.CubePrefiltered=9]="CubePrefiltered",n[n.Raw3D=10]="Raw3D",n[n.Raw2DArray=11]="Raw2DArray",n[n.DepthStencil=12]="DepthStencil",n[n.CubeRawRGBD=13]="CubeRawRGBD",n[n.Depth=14]="Depth"})(ge||(ge={}));var yi=function(n){A(r,n);function r(e,t,i){i===void 0&&(i=!1);var a=n.call(this)||this;return a.isReady=!1,a.isCube=!1,a.is3D=!1,a.is2DArray=!1,a.isMultiview=!1,a.url="",a.generateMipMaps=!1,a.samples=0,a.type=-1,a.format=-1,a.onLoadedObservable=new J,a.onErrorObservable=new J,a.onRebuildCallback=null,a.width=0,a.height=0,a.depth=0,a.baseWidth=0,a.baseHeight=0,a.baseDepth=0,a.invertY=!1,a._invertVScale=!1,a._associatedChannel=-1,a._source=ge.Unknown,a._buffer=null,a._bufferView=null,a._bufferViewArray=null,a._bufferViewArrayArray=null,a._size=0,a._extension="",a._files=null,a._workingCanvas=null,a._workingContext=null,a._cachedCoordinatesMode=null,a._isDisabled=!1,a._compression=null,a._sphericalPolynomial=null,a._sphericalPolynomialPromise=null,a._sphericalPolynomialComputed=!1,a._lodGenerationScale=0,a._lodGenerationOffset=0,a._useSRGBBuffer=!1,a._lodTextureHigh=null,a._lodTextureMid=null,a._lodTextureLow=null,a._isRGBD=!1,a._linearSpecularLOD=!1,a._irradianceTexture=null,a._hardwareTexture=null,a._maxLodLevel=null,a._references=1,a._gammaSpace=null,a._engine=e,a._source=t,a._uniqueId=r._Counter++,i||(a._hardwareTexture=e._createHardwareTexture()),a}return Object.defineProperty(r.prototype,"useMipMaps",{get:function(){return this.generateMipMaps},set:function(e){this.generateMipMaps=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),r.prototype.getEngine=function(){return this._engine},Object.defineProperty(r.prototype,"source",{get:function(){return this._source},enumerable:!1,configurable:!0}),r.prototype.incrementReferences=function(){this._references++},r.prototype.updateSize=function(e,t,i){i===void 0&&(i=1),this._engine.updateTextureDimensions(this,e,t,i),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i},r.prototype._rebuild=function(){var e=this,t;if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){var i=this.onRebuildCallback(this),a=function(s){s._swapAndDie(e,!1),e.isReady=i.isReady};i.isAsync?i.proxy.then(a):a(i.proxy);return}var o;switch(this.source){case ge.Temp:break;case ge.Url:o=this._engine.createTexture((t=this._originalUrl)!==null&&t!==void 0?t:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,function(){o._swapAndDie(e,!1),e.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case ge.Raw:o=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,void 0,this._useSRGBBuffer),o._swapAndDie(this,!1),this.isReady=!0;break;case ge.Raw3D:o=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),o._swapAndDie(this,!1),this.isReady=!0;break;case ge.Raw2DArray:o=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),o._swapAndDie(this,!1),this.isReady=!0;break;case ge.Dynamic:o=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),o._swapAndDie(this,!1),this._engine.updateDynamicTexture(this,this._engine.getRenderingCanvas(),this.invertY,void 0,void 0,!0);break;case ge.Cube:o=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,function(){o._swapAndDie(e,!1),e.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer);return;case ge.CubeRaw:o=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),o._swapAndDie(this,!1),this.isReady=!0;break;case ge.CubeRawRGBD:return;case ge.CubePrefiltered:o=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,function(s){s&&s._swapAndDie(e,!1),e.isReady=!0},null,this.format,this._extension),o._sphericalPolynomial=this._sphericalPolynomial;return}},r.prototype._swapAndDie=function(e,t){var i;t===void 0&&(t=!0),(i=this._hardwareTexture)===null||i===void 0||i.setUsage(e._source,this.generateMipMaps,this.isCube,this.width,this.height),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);var a=this._engine.getLoadedTexturesCache(),o=a.indexOf(this);o!==-1&&a.splice(o,1),o=a.indexOf(e),o===-1&&a.push(e)},r.prototype.dispose=function(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._references===0&&(this._engine._releaseTexture(this),this._hardwareTexture=null)},r._Counter=0,r}(bi),qe=function(){function n(r,e){e===void 0&&(e=!0),this.effect=null,this.defines=null,this.drawContext=r.createDrawContext(),e&&(this.materialContext=r.createMaterialContext())}return n.IsWrapper=function(r){return r.getPipelineContext===void 0},n.GetEffect=function(r){return r.getPipelineContext===void 0?r.effect:r},n.prototype.setEffect=function(r,e,t){var i;t===void 0&&(t=!0),this.effect=r,e!==void 0&&(this.defines=e),t&&((i=this.drawContext)===null||i===void 0||i.reset())},n.prototype.dispose=function(){var r;(r=this.drawContext)===null||r===void 0||r.dispose()},n}(),Ae=function(){function n(r){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=r,r)for(var e in r)Object.prototype.hasOwnProperty.call(r,e)&&this._setDefaultValue(e)}return Object.defineProperty(n.prototype,"isDirty",{get:function(){return this._isDirty},enumerable:!1,configurable:!0}),n.prototype.markAsProcessed=function(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1},n.prototype.markAsUnprocessed=function(){this._isDirty=!0},n.prototype.markAllAsDirty=function(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._areImageProcessingDirty=!0,this._isDirty=!0},n.prototype.markAsImageProcessingDirty=function(){this._areImageProcessingDirty=!0,this._isDirty=!0},n.prototype.markAsLightDirty=function(r){r===void 0&&(r=!1),this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||r,this._isDirty=!0},n.prototype.markAsAttributesDirty=function(){this._areAttributesDirty=!0,this._isDirty=!0},n.prototype.markAsTexturesDirty=function(){this._areTexturesDirty=!0,this._isDirty=!0},n.prototype.markAsFresnelDirty=function(){this._areFresnelDirty=!0,this._isDirty=!0},n.prototype.markAsMiscDirty=function(){this._areMiscDirty=!0,this._isDirty=!0},n.prototype.markAsPrePassDirty=function(){this._arePrePassDirty=!0,this._isDirty=!0},n.prototype.rebuild=function(){this._keys.length=0;for(var r=0,e=Object.keys(this);r<e.length;r++){var t=e[r];t[0]!=="_"&&this._keys.push(t)}if(this._externalProperties)for(var i in this._externalProperties)this._keys.indexOf(i)===-1&&this._keys.push(i)},n.prototype.isEqual=function(r){if(this._keys.length!==r._keys.length)return!1;for(var e=0;e<this._keys.length;e++){var t=this._keys[e];if(this[t]!==r[t])return!1}return!0},n.prototype.cloneTo=function(r){this._keys.length!==r._keys.length&&(r._keys=this._keys.slice(0));for(var e=0;e<this._keys.length;e++){var t=this._keys[e];r[t]=this[t]}},n.prototype.reset=function(){var r=this;this._keys.forEach(function(e){return r._setDefaultValue(e)})},n.prototype._setDefaultValue=function(r){var e,t,i,a,o,s=(i=(t=(e=this._externalProperties)===null||e===void 0?void 0:e[r])===null||t===void 0?void 0:t.type)!==null&&i!==void 0?i:typeof this[r],u=(o=(a=this._externalProperties)===null||a===void 0?void 0:a[r])===null||o===void 0?void 0:o.default;switch(s){case"number":this[r]=u!=null?u:0;break;case"string":this[r]=u!=null?u:"";break;default:this[r]=u!=null?u:!1;break}},n.prototype.toString=function(){for(var r="",e=0;e<this._keys.length;e++){var t=this._keys[e],i=this[t],a=typeof i;switch(a){case"number":case"string":r+="#define "+t+" "+i+`
`;break;default:i&&(r+="#define "+t+`
`);break}}return r},n}(),at=function(){function n(){this._dirty=!0,this._tempColor=new ve(0,0,0,0),this._globalCurve=new ve(0,0,0,0),this._highlightsCurve=new ve(0,0,0,0),this._midtonesCurve=new ve(0,0,0,0),this._shadowsCurve=new ve(0,0,0,0),this._positiveCurve=new ve(0,0,0,0),this._negativeCurve=new ve(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}return Object.defineProperty(n.prototype,"globalHue",{get:function(){return this._globalHue},set:function(r){this._globalHue=r,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"globalDensity",{get:function(){return this._globalDensity},set:function(r){this._globalDensity=r,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"globalSaturation",{get:function(){return this._globalSaturation},set:function(r){this._globalSaturation=r,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"globalExposure",{get:function(){return this._globalExposure},set:function(r){this._globalExposure=r,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"highlightsHue",{get:function(){return this._highlightsHue},set:function(r){this._highlightsHue=r,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"highlightsDensity",{get:function(){return this._highlightsDensity},set:function(r){this._highlightsDensity=r,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"highlightsSaturation",{get:function(){return this._highlightsSaturation},set:function(r){this._highlightsSaturation=r,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"highlightsExposure",{get:function(){return this._highlightsExposure},set:function(r){this._highlightsExposure=r,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"midtonesHue",{get:function(){return this._midtonesHue},set:function(r){this._midtonesHue=r,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"midtonesDensity",{get:function(){return this._midtonesDensity},set:function(r){this._midtonesDensity=r,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"midtonesSaturation",{get:function(){return this._midtonesSaturation},set:function(r){this._midtonesSaturation=r,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"midtonesExposure",{get:function(){return this._midtonesExposure},set:function(r){this._midtonesExposure=r,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"shadowsHue",{get:function(){return this._shadowsHue},set:function(r){this._shadowsHue=r,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"shadowsDensity",{get:function(){return this._shadowsDensity},set:function(r){this._shadowsDensity=r,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"shadowsSaturation",{get:function(){return this._shadowsSaturation},set:function(r){this._shadowsSaturation=r,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"shadowsExposure",{get:function(){return this._shadowsExposure},set:function(r){this._shadowsExposure=r,this._dirty=!0},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"ColorCurves"},n.Bind=function(r,e,t,i,a){t===void 0&&(t="vCameraColorCurvePositive"),i===void 0&&(i="vCameraColorCurveNeutral"),a===void 0&&(a="vCameraColorCurveNegative"),r._dirty&&(r._dirty=!1,r._getColorGradingDataToRef(r._globalHue,r._globalDensity,r._globalSaturation,r._globalExposure,r._globalCurve),r._getColorGradingDataToRef(r._highlightsHue,r._highlightsDensity,r._highlightsSaturation,r._highlightsExposure,r._tempColor),r._tempColor.multiplyToRef(r._globalCurve,r._highlightsCurve),r._getColorGradingDataToRef(r._midtonesHue,r._midtonesDensity,r._midtonesSaturation,r._midtonesExposure,r._tempColor),r._tempColor.multiplyToRef(r._globalCurve,r._midtonesCurve),r._getColorGradingDataToRef(r._shadowsHue,r._shadowsDensity,r._shadowsSaturation,r._shadowsExposure,r._tempColor),r._tempColor.multiplyToRef(r._globalCurve,r._shadowsCurve),r._highlightsCurve.subtractToRef(r._midtonesCurve,r._positiveCurve),r._midtonesCurve.subtractToRef(r._shadowsCurve,r._negativeCurve)),e&&(e.setFloat4(t,r._positiveCurve.r,r._positiveCurve.g,r._positiveCurve.b,r._positiveCurve.a),e.setFloat4(i,r._midtonesCurve.r,r._midtonesCurve.g,r._midtonesCurve.b,r._midtonesCurve.a),e.setFloat4(a,r._negativeCurve.r,r._negativeCurve.g,r._negativeCurve.b,r._negativeCurve.a))},n.PrepareUniforms=function(r){r.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")},n.prototype._getColorGradingDataToRef=function(r,e,t,i,a){r!=null&&(r=n._Clamp(r,0,360),e=n._Clamp(e,-100,100),t=n._Clamp(t,-100,100),i=n._Clamp(i,-100,100),e=n._ApplyColorGradingSliderNonlinear(e),e*=.5,i=n._ApplyColorGradingSliderNonlinear(i),e<0&&(e*=-1,r=(r+180)%360),n._FromHSBToRef(r,e,50+.25*i,a),a.scaleToRef(2,a),a.a=1+.01*t)},n._ApplyColorGradingSliderNonlinear=function(r){r/=100;var e=Math.abs(r);return e=Math.pow(e,2),r<0&&(e*=-1),e*=100,e},n._FromHSBToRef=function(r,e,t,i){var a=n._Clamp(r,0,360),o=n._Clamp(e/100,0,1),s=n._Clamp(t/100,0,1);if(o===0)i.r=s,i.g=s,i.b=s;else{a/=60;var u=Math.floor(a),l=a-u,c=s*(1-o),p=s*(1-o*l),d=s*(1-o*(1-l));switch(u){case 0:i.r=s,i.g=d,i.b=c;break;case 1:i.r=p,i.g=s,i.b=c;break;case 2:i.r=c,i.g=s,i.b=d;break;case 3:i.r=c,i.g=p,i.b=s;break;case 4:i.r=d,i.g=c,i.b=s;break;default:i.r=s,i.g=c,i.b=p;break}}i.a=1},n._Clamp=function(r,e,t){return Math.min(Math.max(r,e),t)},n.prototype.clone=function(){return j.Clone(function(){return new n},this)},n.prototype.serialize=function(){return j.Serialize(this)},n.Parse=function(r){return j.Parse(function(){return new n},r,null,null)},h([b()],n.prototype,"_globalHue",void 0),h([b()],n.prototype,"_globalDensity",void 0),h([b()],n.prototype,"_globalSaturation",void 0),h([b()],n.prototype,"_globalExposure",void 0),h([b()],n.prototype,"_highlightsHue",void 0),h([b()],n.prototype,"_highlightsDensity",void 0),h([b()],n.prototype,"_highlightsSaturation",void 0),h([b()],n.prototype,"_highlightsExposure",void 0),h([b()],n.prototype,"_midtonesHue",void 0),h([b()],n.prototype,"_midtonesDensity",void 0),h([b()],n.prototype,"_midtonesSaturation",void 0),h([b()],n.prototype,"_midtonesExposure",void 0),n}();j._ColorCurvesParser=at.Parse;var La=function(n){A(r,n);function r(){var e=n.call(this)||this;return e.IMAGEPROCESSING=!1,e.VIGNETTE=!1,e.VIGNETTEBLENDMODEMULTIPLY=!1,e.VIGNETTEBLENDMODEOPAQUE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=!1,e.SAMPLER3DBGRMAP=!1,e.IMAGEPROCESSINGPOSTPROCESS=!1,e.EXPOSURE=!1,e.SKIPFINALCOLORCLAMP=!1,e.rebuild(),e}return r}(Ae),Ie=function(){function n(){this.colorCurves=new at,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=n.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCentreX=0,this.vignetteCentreY=0,this.vignetteWeight=1.5,this.vignetteColor=new ve(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=n.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new J}return Object.defineProperty(n.prototype,"colorCurvesEnabled",{get:function(){return this._colorCurvesEnabled},set:function(r){this._colorCurvesEnabled!==r&&(this._colorCurvesEnabled=r,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"colorGradingTexture",{get:function(){return this._colorGradingTexture},set:function(r){this._colorGradingTexture!==r&&(this._colorGradingTexture=r,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"colorGradingEnabled",{get:function(){return this._colorGradingEnabled},set:function(r){this._colorGradingEnabled!==r&&(this._colorGradingEnabled=r,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"colorGradingWithGreenDepth",{get:function(){return this._colorGradingWithGreenDepth},set:function(r){this._colorGradingWithGreenDepth!==r&&(this._colorGradingWithGreenDepth=r,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"colorGradingBGR",{get:function(){return this._colorGradingBGR},set:function(r){this._colorGradingBGR!==r&&(this._colorGradingBGR=r,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"exposure",{get:function(){return this._exposure},set:function(r){this._exposure!==r&&(this._exposure=r,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"toneMappingEnabled",{get:function(){return this._toneMappingEnabled},set:function(r){this._toneMappingEnabled!==r&&(this._toneMappingEnabled=r,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"toneMappingType",{get:function(){return this._toneMappingType},set:function(r){this._toneMappingType!==r&&(this._toneMappingType=r,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"contrast",{get:function(){return this._contrast},set:function(r){this._contrast!==r&&(this._contrast=r,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"vignetteBlendMode",{get:function(){return this._vignetteBlendMode},set:function(r){this._vignetteBlendMode!==r&&(this._vignetteBlendMode=r,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"vignetteEnabled",{get:function(){return this._vignetteEnabled},set:function(r){this._vignetteEnabled!==r&&(this._vignetteEnabled=r,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"skipFinalColorClamp",{get:function(){return this._skipFinalColorClamp},set:function(r){this._skipFinalColorClamp!==r&&(this._skipFinalColorClamp=r,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"applyByPostProcess",{get:function(){return this._applyByPostProcess},set:function(r){this._applyByPostProcess!==r&&(this._applyByPostProcess=r,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(r){this._isEnabled!==r&&(this._isEnabled=r,this._updateParameters())},enumerable:!1,configurable:!0}),n.prototype._updateParameters=function(){this.onUpdateParameters.notifyObservers(this)},n.prototype.getClassName=function(){return"ImageProcessingConfiguration"},n.PrepareUniforms=function(r,e){e.EXPOSURE&&r.push("exposureLinear"),e.CONTRAST&&r.push("contrast"),e.COLORGRADING&&r.push("colorTransformSettings"),e.VIGNETTE&&(r.push("vInverseScreenSize"),r.push("vignetteSettings1"),r.push("vignetteSettings2")),e.COLORCURVES&&at.PrepareUniforms(r)},n.PrepareSamplers=function(r,e){e.COLORGRADING&&r.push("txColorTransform")},n.prototype.prepareDefines=function(r,e){if(e===void 0&&(e=!1),e!==this.applyByPostProcess||!this._isEnabled){r.VIGNETTE=!1,r.TONEMAPPING=!1,r.TONEMAPPING_ACES=!1,r.CONTRAST=!1,r.EXPOSURE=!1,r.COLORCURVES=!1,r.COLORGRADING=!1,r.COLORGRADING3D=!1,r.IMAGEPROCESSING=!1,r.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,r.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}switch(r.VIGNETTE=this.vignetteEnabled,r.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===n._VIGNETTEMODE_MULTIPLY,r.VIGNETTEBLENDMODEOPAQUE=!r.VIGNETTEBLENDMODEMULTIPLY,r.TONEMAPPING=this.toneMappingEnabled,this._toneMappingType){case n.TONEMAPPING_ACES:r.TONEMAPPING_ACES=!0;break;default:r.TONEMAPPING_ACES=!1;break}r.CONTRAST=this.contrast!==1,r.EXPOSURE=this.exposure!==1,r.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,r.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,r.COLORGRADING?r.COLORGRADING3D=this.colorGradingTexture.is3D:r.COLORGRADING3D=!1,r.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,r.SAMPLER3DBGRMAP=this.colorGradingBGR,r.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,r.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,r.IMAGEPROCESSING=r.VIGNETTE||r.TONEMAPPING||r.CONTRAST||r.EXPOSURE||r.COLORCURVES||r.COLORGRADING},n.prototype.isReady=function(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()},n.prototype.bind=function(r,e){if(this._colorCurvesEnabled&&this.colorCurves&&at.Bind(this.colorCurves,r),this._vignetteEnabled){var t=1/r.getEngine().getRenderWidth(),i=1/r.getEngine().getRenderHeight();r.setFloat2("vInverseScreenSize",t,i);var a=e!=null?e:i/t,o=Math.tan(this.vignetteCameraFov*.5),s=o*a,u=Math.sqrt(s*o);s=ae.Mix(s,u,this.vignetteStretch),o=ae.Mix(o,u,this.vignetteStretch),r.setFloat4("vignetteSettings1",s,o,-s*this.vignetteCentreX,-o*this.vignetteCentreY);var l=-2*this.vignetteWeight;r.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,l)}if(r.setFloat("exposureLinear",this.exposure),r.setFloat("contrast",this.contrast),this.colorGradingTexture){r.setTexture("txColorTransform",this.colorGradingTexture);var c=this.colorGradingTexture.getSize().height;r.setFloat4("colorTransformSettings",(c-1)/c,.5/c,c,this.colorGradingTexture.level)}},n.prototype.clone=function(){return j.Clone(function(){return new n},this)},n.prototype.serialize=function(){return j.Serialize(this)},n.Parse=function(r){return j.Parse(function(){return new n},r,null,null)},Object.defineProperty(n,"VIGNETTEMODE_MULTIPLY",{get:function(){return this._VIGNETTEMODE_MULTIPLY},enumerable:!1,configurable:!0}),Object.defineProperty(n,"VIGNETTEMODE_OPAQUE",{get:function(){return this._VIGNETTEMODE_OPAQUE},enumerable:!1,configurable:!0}),n.TONEMAPPING_STANDARD=0,n.TONEMAPPING_ACES=1,n._VIGNETTEMODE_MULTIPLY=0,n._VIGNETTEMODE_OPAQUE=1,h([Xr()],n.prototype,"colorCurves",void 0),h([b()],n.prototype,"_colorCurvesEnabled",void 0),h([U("colorGradingTexture")],n.prototype,"_colorGradingTexture",void 0),h([b()],n.prototype,"_colorGradingEnabled",void 0),h([b()],n.prototype,"_colorGradingWithGreenDepth",void 0),h([b()],n.prototype,"_colorGradingBGR",void 0),h([b()],n.prototype,"_exposure",void 0),h([b()],n.prototype,"_toneMappingEnabled",void 0),h([b()],n.prototype,"_toneMappingType",void 0),h([b()],n.prototype,"_contrast",void 0),h([b()],n.prototype,"vignetteStretch",void 0),h([b()],n.prototype,"vignetteCentreX",void 0),h([b()],n.prototype,"vignetteCentreY",void 0),h([b()],n.prototype,"vignetteWeight",void 0),h([Kr()],n.prototype,"vignetteColor",void 0),h([b()],n.prototype,"vignetteCameraFov",void 0),h([b()],n.prototype,"_vignetteBlendMode",void 0),h([b()],n.prototype,"_vignetteEnabled",void 0),h([b()],n.prototype,"_skipFinalColorClamp",void 0),h([b()],n.prototype,"_applyByPostProcess",void 0),h([b()],n.prototype,"_isEnabled",void 0),n}();j._ImageProcessingConfigurationParser=Ie.Parse;var Ti=function(){function n(r,e,t,i,a){a===void 0&&(a=!1),this._valueCache={},this._engine=r,this._noUBO=!r.supportsUniformBuffers||a,this._dynamic=t,this._name=i!=null?i:"no-name",this._data=e||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform)}return Object.defineProperty(n.prototype,"useUbo",{get:function(){return!this._noUBO},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isSync",{get:function(){return!this._needSync},enumerable:!1,configurable:!0}),n.prototype.isDynamic=function(){return this._dynamic!==void 0},n.prototype.getData=function(){return this._bufferData},n.prototype.getBuffer=function(){return this._buffer},n.prototype._fillAlignment=function(r){var e;if(r<=2?e=r:e=4,this._uniformLocationPointer%e!==0){var t=this._uniformLocationPointer;this._uniformLocationPointer+=e-this._uniformLocationPointer%e;for(var i=this._uniformLocationPointer-t,a=0;a<i;a++)this._data.push(0)}},n.prototype.addUniform=function(r,e,t){if(t===void 0&&(t=0),!this._noUBO&&this._uniformLocations[r]===void 0){var i;if(t>0){if(e instanceof Array)throw"addUniform should not be use with Array in UBO: "+r;if(this._fillAlignment(4),this._uniformArraySizes[r]={strideSize:e,arraySize:t},e==16)e=e*t;else{var a=4-e,o=a*t;e=e*t+o}i=[];for(var s=0;s<e;s++)i.push(0)}else{if(e instanceof Array)i=e,e=i.length;else{e=e,i=[];for(var s=0;s<e;s++)i.push(0)}this._fillAlignment(e)}this._uniformSizes[r]=e,this._uniformLocations[r]=this._uniformLocationPointer,this._uniformLocationPointer+=e;for(var s=0;s<e;s++)this._data.push(i[s]);this._needSync=!0}},n.prototype.addMatrix=function(r,e){this.addUniform(r,Array.prototype.slice.call(e.toArray()))},n.prototype.addFloat2=function(r,e,t){var i=[e,t];this.addUniform(r,i)},n.prototype.addFloat3=function(r,e,t,i){var a=[e,t,i];this.addUniform(r,a)},n.prototype.addColor3=function(r,e){var t=[e.r,e.g,e.b];this.addUniform(r,t)},n.prototype.addColor4=function(r,e,t){var i=[e.r,e.g,e.b,t];this.addUniform(r,i)},n.prototype.addVector3=function(r,e){var t=[e.x,e.y,e.z];this.addUniform(r,t)},n.prototype.addMatrix3x3=function(r){this.addUniform(r,12)},n.prototype.addMatrix2x2=function(r){this.addUniform(r,8)},n.prototype.create=function(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)},n.prototype._rebuild=function(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData):this._buffer=this._engine.createUniformBuffer(this._bufferData),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))},Object.defineProperty(n.prototype,"_numBuffers",{get:function(){return this._buffers.length},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"_indexBuffer",{get:function(){return this._bufferIndex},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),n.prototype._buffersEqual=function(r,e){for(var t=0;t<r.length;++t)if(r[t]!==e[t])return!1;return!0},n.prototype._copyBuffer=function(r,e){for(var t=0;t<r.length;++t)e[t]=r[t]},n.prototype.update=function(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(n._UpdatedUbosInFrame[this._name]||(n._UpdatedUbosInFrame[this._name]=0),n._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}},n.prototype._createNewBuffer=function(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()},n.prototype._checkNewFrame=function(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)},n.prototype.updateUniform=function(r,e,t){this._checkNewFrame();var i=this._uniformLocations[r];if(i===void 0){if(this._buffer){$.Error("Cannot add an uniform after UBO has been created.");return}this.addUniform(r,t),i=this._uniformLocations[r]}if(this._buffer||this.create(),this._dynamic)for(var o=0;o<t;o++)this._bufferData[i+o]=e[o];else{for(var a=!1,o=0;o<t;o++)(t===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[i+o]!==ae.FloatRound(e[o]))&&(a=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[i+o]=e[o]);this._needSync=this._needSync||a}},n.prototype.updateUniformArray=function(r,e,t){this._checkNewFrame();var i=this._uniformLocations[r];if(i===void 0){$.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform.");return}this._buffer||this.create();var a=this._uniformArraySizes[r];if(this._dynamic)for(var l=0;l<t;l++)this._bufferData[i+l]=e[l];else{for(var o=!1,s=0,u=0,l=0;l<t;l++)if(this._bufferData[i+u*4+s]!==ae.FloatRound(e[l])&&(o=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[i+u*4+s]=e[l]),s++,s===a.strideSize){for(;s<4;s++)this._bufferData[i+u*4+s]=0;s=0,u++}this._needSync=this._needSync||o}},n.prototype._cacheMatrix=function(r,e){this._checkNewFrame();var t=this._valueCache[r],i=e.updateFlag;return t!==void 0&&t===i?!1:(this._valueCache[r]=i,!0)},n.prototype._updateMatrix3x3ForUniform=function(r,e){for(var t=0;t<3;t++)n._TempBuffer[t*4]=e[t*3],n._TempBuffer[t*4+1]=e[t*3+1],n._TempBuffer[t*4+2]=e[t*3+2],n._TempBuffer[t*4+3]=0;this.updateUniform(r,n._TempBuffer,12)},n.prototype._updateMatrix3x3ForEffect=function(r,e){this._currentEffect.setMatrix3x3(r,e)},n.prototype._updateMatrix2x2ForEffect=function(r,e){this._currentEffect.setMatrix2x2(r,e)},n.prototype._updateMatrix2x2ForUniform=function(r,e){for(var t=0;t<2;t++)n._TempBuffer[t*4]=e[t*2],n._TempBuffer[t*4+1]=e[t*2+1],n._TempBuffer[t*4+2]=0,n._TempBuffer[t*4+3]=0;this.updateUniform(r,n._TempBuffer,8)},n.prototype._updateFloatForEffect=function(r,e){this._currentEffect.setFloat(r,e)},n.prototype._updateFloatForUniform=function(r,e){n._TempBuffer[0]=e,this.updateUniform(r,n._TempBuffer,1)},n.prototype._updateFloat2ForEffect=function(r,e,t,i){i===void 0&&(i=""),this._currentEffect.setFloat2(r+i,e,t)},n.prototype._updateFloat2ForUniform=function(r,e,t){n._TempBuffer[0]=e,n._TempBuffer[1]=t,this.updateUniform(r,n._TempBuffer,2)},n.prototype._updateFloat3ForEffect=function(r,e,t,i,a){a===void 0&&(a=""),this._currentEffect.setFloat3(r+a,e,t,i)},n.prototype._updateFloat3ForUniform=function(r,e,t,i){n._TempBuffer[0]=e,n._TempBuffer[1]=t,n._TempBuffer[2]=i,this.updateUniform(r,n._TempBuffer,3)},n.prototype._updateFloat4ForEffect=function(r,e,t,i,a,o){o===void 0&&(o=""),this._currentEffect.setFloat4(r+o,e,t,i,a)},n.prototype._updateFloat4ForUniform=function(r,e,t,i,a){n._TempBuffer[0]=e,n._TempBuffer[1]=t,n._TempBuffer[2]=i,n._TempBuffer[3]=a,this.updateUniform(r,n._TempBuffer,4)},n.prototype._updateFloatArrayForEffect=function(r,e){this._currentEffect.setFloatArray(r,e)},n.prototype._updateFloatArrayForUniform=function(r,e){this.updateUniformArray(r,e,e.length)},n.prototype._updateArrayForEffect=function(r,e){this._currentEffect.setArray(r,e)},n.prototype._updateArrayForUniform=function(r,e){this.updateUniformArray(r,e,e.length)},n.prototype._updateIntArrayForEffect=function(r,e){this._currentEffect.setIntArray(r,e)},n.prototype._updateIntArrayForUniform=function(r,e){n._TempBufferInt32View.set(e),this.updateUniformArray(r,n._TempBuffer,e.length)},n.prototype._updateMatrixForEffect=function(r,e){this._currentEffect.setMatrix(r,e)},n.prototype._updateMatrixForUniform=function(r,e){this._cacheMatrix(r,e)&&this.updateUniform(r,e.toArray(),16)},n.prototype._updateMatricesForEffect=function(r,e){this._currentEffect.setMatrices(r,e)},n.prototype._updateMatricesForUniform=function(r,e){this.updateUniform(r,e,e.length)},n.prototype._updateVector3ForEffect=function(r,e){this._currentEffect.setVector3(r,e)},n.prototype._updateVector3ForUniform=function(r,e){n._TempBuffer[0]=e.x,n._TempBuffer[1]=e.y,n._TempBuffer[2]=e.z,this.updateUniform(r,n._TempBuffer,3)},n.prototype._updateVector4ForEffect=function(r,e){this._currentEffect.setVector4(r,e)},n.prototype._updateVector4ForUniform=function(r,e){n._TempBuffer[0]=e.x,n._TempBuffer[1]=e.y,n._TempBuffer[2]=e.z,n._TempBuffer[3]=e.w,this.updateUniform(r,n._TempBuffer,4)},n.prototype._updateColor3ForEffect=function(r,e,t){t===void 0&&(t=""),this._currentEffect.setColor3(r+t,e)},n.prototype._updateColor3ForUniform=function(r,e){n._TempBuffer[0]=e.r,n._TempBuffer[1]=e.g,n._TempBuffer[2]=e.b,this.updateUniform(r,n._TempBuffer,3)},n.prototype._updateColor4ForEffect=function(r,e,t,i){i===void 0&&(i=""),this._currentEffect.setColor4(r+i,e,t)},n.prototype._updateDirectColor4ForEffect=function(r,e,t){t===void 0&&(t=""),this._currentEffect.setDirectColor4(r+t,e)},n.prototype._updateColor4ForUniform=function(r,e,t){n._TempBuffer[0]=e.r,n._TempBuffer[1]=e.g,n._TempBuffer[2]=e.b,n._TempBuffer[3]=t,this.updateUniform(r,n._TempBuffer,4)},n.prototype._updateDirectColor4ForUniform=function(r,e){n._TempBuffer[0]=e.r,n._TempBuffer[1]=e.g,n._TempBuffer[2]=e.b,n._TempBuffer[3]=e.a,this.updateUniform(r,n._TempBuffer,4)},n.prototype._updateIntForEffect=function(r,e,t){t===void 0&&(t=""),this._currentEffect.setInt(r+t,e)},n.prototype._updateIntForUniform=function(r,e){n._TempBufferInt32View[0]=e,this.updateUniform(r,n._TempBuffer,1)},n.prototype._updateInt2ForEffect=function(r,e,t,i){i===void 0&&(i=""),this._currentEffect.setInt2(r+i,e,t)},n.prototype._updateInt2ForUniform=function(r,e,t){n._TempBufferInt32View[0]=e,n._TempBufferInt32View[1]=t,this.updateUniform(r,n._TempBuffer,2)},n.prototype._updateInt3ForEffect=function(r,e,t,i,a){a===void 0&&(a=""),this._currentEffect.setInt3(r+a,e,t,i)},n.prototype._updateInt3ForUniform=function(r,e,t,i){n._TempBufferInt32View[0]=e,n._TempBufferInt32View[1]=t,n._TempBufferInt32View[2]=i,this.updateUniform(r,n._TempBuffer,3)},n.prototype._updateInt4ForEffect=function(r,e,t,i,a,o){o===void 0&&(o=""),this._currentEffect.setInt4(r+o,e,t,i,a)},n.prototype._updateInt4ForUniform=function(r,e,t,i,a){n._TempBufferInt32View[0]=e,n._TempBufferInt32View[1]=t,n._TempBufferInt32View[2]=i,n._TempBufferInt32View[3]=a,this.updateUniform(r,n._TempBuffer,4)},n.prototype.setTexture=function(r,e){this._currentEffect.setTexture(r,e)},n.prototype.updateUniformDirectly=function(r,e){this.updateUniform(r,e,e.length),this.update()},n.prototype.bindToEffect=function(r,e){this._currentEffect=r,this._currentEffectName=e},n.prototype.bindUniformBuffer=function(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)},n.prototype.unbindEffect=function(){this._currentEffect=void 0,this._currentEffectName=void 0},n.prototype.setDataBuffer=function(r){if(!this._buffers)return this._buffer===r;for(var e=0;e<this._buffers.length;++e){var t=this._buffers[e];if(t[0]===r)return this._bufferIndex=e,this._buffer=r,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0}return!1},n.prototype.dispose=function(){if(!this._noUBO){var r=this._engine._uniformBuffers,e=r.indexOf(this);if(e!==-1&&(r[e]=r[r.length-1],r.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(var t=0;t<this._buffers.length;++t){var i=this._buffers[t][0];this._engine._releaseBuffer(i)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}},n._UpdatedUbosInFrame={},n._MAX_UNIFORM_SIZE=256,n._TempBuffer=new Float32Array(n._MAX_UNIFORM_SIZE),n._TempBufferInt32View=new Uint32Array(n._TempBuffer.buffer),n}(),Si=function(){function n(){}return n.BindClipPlane=function(r,e){if(e.clipPlane){var t=e.clipPlane;r.setFloat4("vClipPlane",t.normal.x,t.normal.y,t.normal.z,t.d)}if(e.clipPlane2){var t=e.clipPlane2;r.setFloat4("vClipPlane2",t.normal.x,t.normal.y,t.normal.z,t.d)}if(e.clipPlane3){var t=e.clipPlane3;r.setFloat4("vClipPlane3",t.normal.x,t.normal.y,t.normal.z,t.d)}if(e.clipPlane4){var t=e.clipPlane4;r.setFloat4("vClipPlane4",t.normal.x,t.normal.y,t.normal.z,t.d)}if(e.clipPlane5){var t=e.clipPlane5;r.setFloat4("vClipPlane5",t.normal.x,t.normal.y,t.normal.z,t.d)}if(e.clipPlane6){var t=e.clipPlane6;r.setFloat4("vClipPlane6",t.normal.x,t.normal.y,t.normal.z,t.d)}},n}(),C=function(){function n(){}return n.BindSceneUniformBuffer=function(r,e){e.bindToEffect(r,"Scene")},n.PrepareDefinesForMergedUV=function(r,e,t){e._needUVs=!0,e[t]=!0,r.getTextureMatrix().isIdentityAs3x2()?(e[t+"DIRECTUV"]=r.coordinatesIndex+1,e["MAINUV"+(r.coordinatesIndex+1)]=!0):e[t+"DIRECTUV"]=0},n.BindTextureMatrix=function(r,e,t){var i=r.getTextureMatrix();e.updateMatrix(t+"Matrix",i)},n.GetFogState=function(r,e){return e.fogEnabled&&r.applyFog&&e.fogMode!==Ke.FOGMODE_NONE},n.PrepareDefinesForMisc=function(r,e,t,i,a,o,s){s._areMiscDirty&&(s.LOGARITHMICDEPTH=t,s.POINTSIZE=i,s.FOG=a&&this.GetFogState(r,e),s.NONUNIFORMSCALING=r.nonUniformScaling,s.ALPHATEST=o)},n.PrepareDefinesForFrameBoundValues=function(r,e,t,i,a,o){a===void 0&&(a=null),o===void 0&&(o=!1);var s=!1,u=!1,l=!1,c=!1,p=!1,d=!1,g=!1;u=a==null?r.clipPlane!==void 0&&r.clipPlane!==null:a,l=a==null?r.clipPlane2!==void 0&&r.clipPlane2!==null:a,c=a==null?r.clipPlane3!==void 0&&r.clipPlane3!==null:a,p=a==null?r.clipPlane4!==void 0&&r.clipPlane4!==null:a,d=a==null?r.clipPlane5!==void 0&&r.clipPlane5!==null:a,g=a==null?r.clipPlane6!==void 0&&r.clipPlane6!==null:a,t.CLIPPLANE!==u&&(t.CLIPPLANE=u,s=!0),t.CLIPPLANE2!==l&&(t.CLIPPLANE2=l,s=!0),t.CLIPPLANE3!==c&&(t.CLIPPLANE3=c,s=!0),t.CLIPPLANE4!==p&&(t.CLIPPLANE4=p,s=!0),t.CLIPPLANE5!==d&&(t.CLIPPLANE5=d,s=!0),t.CLIPPLANE6!==g&&(t.CLIPPLANE6=g,s=!0),t.DEPTHPREPASS!==!e.getColorWrite()&&(t.DEPTHPREPASS=!t.DEPTHPREPASS,s=!0),t.INSTANCES!==i&&(t.INSTANCES=i,s=!0),t.INSTANCESCOLOR&&!t.INSTANCES&&(t.INSTANCESCOLOR=!1,s=!0),t.THIN_INSTANCES!==o&&(t.THIN_INSTANCES=o,s=!0),s&&t.markAsUnprocessed()},n.PrepareDefinesForBones=function(r,e){if(r.useBones&&r.computeBonesUsingShaders&&r.skeleton){e.NUM_BONE_INFLUENCERS=r.numBoneInfluencers;var t=e.BONETEXTURE!==void 0;if(r.skeleton.isUsingTextureForMatrices&&t)e.BONETEXTURE=!0;else{e.BonesPerMesh=r.skeleton.bones.length+1,e.BONETEXTURE=t?!1:void 0;var i=r.getScene().prePassRenderer;if(i&&i.enabled){var a=i.excludedSkinnedMesh.indexOf(r)===-1;e.BONES_VELOCITY_ENABLED=a}}}else e.NUM_BONE_INFLUENCERS=0,e.BonesPerMesh=0},n.PrepareDefinesForMorphTargets=function(r,e){var t=r.morphTargetManager;t?(e.MORPHTARGETS_UV=t.supportsUVs&&e.UV1,e.MORPHTARGETS_TANGENT=t.supportsTangents&&e.TANGENT,e.MORPHTARGETS_NORMAL=t.supportsNormals&&e.NORMAL,e.MORPHTARGETS=t.numInfluencers>0,e.NUM_MORPH_INFLUENCERS=t.numInfluencers,e.MORPHTARGETS_TEXTURE=t.isUsingTextureForTargets):(e.MORPHTARGETS_UV=!1,e.MORPHTARGETS_TANGENT=!1,e.MORPHTARGETS_NORMAL=!1,e.MORPHTARGETS=!1,e.NUM_MORPH_INFLUENCERS=0)},n.PrepareDefinesForBakedVertexAnimation=function(r,e){var t=r.bakedVertexAnimationManager;e.BAKED_VERTEX_ANIMATION_TEXTURE=!!(t&&t.isEnabled)},n.PrepareDefinesForAttributes=function(r,e,t,i,a,o,s){if(a===void 0&&(a=!1),o===void 0&&(o=!0),s===void 0&&(s=!0),!e._areAttributesDirty&&e._needNormals===e._normals&&e._needUVs===e._uvs)return!1;e._normals=e._needNormals,e._uvs=e._needUVs,e.NORMAL=e._needNormals&&r.isVerticesDataPresent(L.NormalKind),e._needNormals&&r.isVerticesDataPresent(L.TangentKind)&&(e.TANGENT=!0);for(var u=1;u<=6;++u)e["UV"+u]=e._needUVs?r.isVerticesDataPresent("uv".concat(u===1?"":u)):!1;if(t){var l=r.useVertexColors&&r.isVerticesDataPresent(L.ColorKind);e.VERTEXCOLOR=l,e.VERTEXALPHA=r.hasVertexAlpha&&l&&o}return r.isVerticesDataPresent(L.ColorInstanceKind)&&(r.hasInstances||r.hasThinInstances)&&(e.INSTANCESCOLOR=!0),i&&this.PrepareDefinesForBones(r,e),a&&this.PrepareDefinesForMorphTargets(r,e),s&&this.PrepareDefinesForBakedVertexAnimation(r,e),!0},n.PrepareDefinesForMultiview=function(r,e){if(r.activeCamera){var t=e.MULTIVIEW;e.MULTIVIEW=r.activeCamera.outputRenderTarget!==null&&r.activeCamera.outputRenderTarget.getViewCount()>1,e.MULTIVIEW!=t&&e.markAsUnprocessed()}},n.PrepareDefinesForOIT=function(r,e,t){var i=e.ORDER_INDEPENDENT_TRANSPARENCY,a=e.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;e.ORDER_INDEPENDENT_TRANSPARENCY=r.useOrderIndependentTransparency&&t,e.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!r.getEngine().getCaps().textureFloatLinearFiltering,(i!==e.ORDER_INDEPENDENT_TRANSPARENCY||a!==e.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&e.markAsUnprocessed()},n.PrepareDefinesForPrePass=function(r,e,t){var i=e.PREPASS;if(!!e._arePrePassDirty){var a=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"}];if(r.prePassRenderer&&r.prePassRenderer.enabled&&t){e.PREPASS=!0,e.SCENE_MRT_COUNT=r.prePassRenderer.mrtCount;for(var o=0;o<a.length;o++){var s=r.prePassRenderer.getIndex(a[o].type);s!==-1?(e[a[o].define]=!0,e[a[o].index]=s):e[a[o].define]=!1}}else{e.PREPASS=!1;for(var o=0;o<a.length;o++)e[a[o].define]=!1}e.PREPASS!=i&&(e.markAsUnprocessed(),e.markAsImageProcessingDirty())}},n.PrepareDefinesForLight=function(r,e,t,i,a,o,s){switch(s.needNormals=!0,a["LIGHT"+i]===void 0&&(s.needRebuild=!0),a["LIGHT"+i]=!0,a["SPOTLIGHT"+i]=!1,a["HEMILIGHT"+i]=!1,a["POINTLIGHT"+i]=!1,a["DIRLIGHT"+i]=!1,t.prepareLightSpecificDefines(a,i),a["LIGHT_FALLOFF_PHYSICAL"+i]=!1,a["LIGHT_FALLOFF_GLTF"+i]=!1,a["LIGHT_FALLOFF_STANDARD"+i]=!1,t.falloffType){case Ye.FALLOFF_GLTF:a["LIGHT_FALLOFF_GLTF"+i]=!0;break;case Ye.FALLOFF_PHYSICAL:a["LIGHT_FALLOFF_PHYSICAL"+i]=!0;break;case Ye.FALLOFF_STANDARD:a["LIGHT_FALLOFF_STANDARD"+i]=!0;break}if(o&&!t.specular.equalsFloats(0,0,0)&&(s.specularEnabled=!0),a["SHADOW"+i]=!1,a["SHADOWCSM"+i]=!1,a["SHADOWCSMDEBUG"+i]=!1,a["SHADOWCSMNUM_CASCADES"+i]=!1,a["SHADOWCSMUSESHADOWMAXZ"+i]=!1,a["SHADOWCSMNOBLEND"+i]=!1,a["SHADOWCSM_RIGHTHANDED"+i]=!1,a["SHADOWPCF"+i]=!1,a["SHADOWPCSS"+i]=!1,a["SHADOWPOISSON"+i]=!1,a["SHADOWESM"+i]=!1,a["SHADOWCLOSEESM"+i]=!1,a["SHADOWCUBE"+i]=!1,a["SHADOWLOWQUALITY"+i]=!1,a["SHADOWMEDIUMQUALITY"+i]=!1,e&&e.receiveShadows&&r.shadowsEnabled&&t.shadowEnabled){var u=t.getShadowGenerator();if(u){var l=u.getShadowMap();l&&l.renderList&&l.renderList.length>0&&(s.shadowEnabled=!0,u.prepareDefines(a,i))}}t.lightmapMode!=Ye.LIGHTMAP_DEFAULT?(s.lightmapMode=!0,a["LIGHTMAPEXCLUDED"+i]=!0,a["LIGHTMAPNOSPECULAR"+i]=t.lightmapMode==Ye.LIGHTMAP_SHADOWSONLY):(a["LIGHTMAPEXCLUDED"+i]=!1,a["LIGHTMAPNOSPECULAR"+i]=!1)},n.PrepareDefinesForLights=function(r,e,t,i,a,o){if(a===void 0&&(a=4),o===void 0&&(o=!1),!t._areLightsDirty)return t._needNormals;var s=0,u={needNormals:t._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(r.lightsEnabled&&!o)for(var l=0,c=e.lightSources;l<c.length;l++){var p=c[l];if(this.PrepareDefinesForLight(r,e,p,s,t,i,u),s++,s===a)break}t.SPECULARTERM=u.specularEnabled,t.SHADOWS=u.shadowEnabled;for(var d=s;d<a;d++)t["LIGHT"+d]!==void 0&&(t["LIGHT"+d]=!1,t["HEMILIGHT"+d]=!1,t["POINTLIGHT"+d]=!1,t["DIRLIGHT"+d]=!1,t["SPOTLIGHT"+d]=!1,t["SHADOW"+d]=!1,t["SHADOWCSM"+d]=!1,t["SHADOWCSMDEBUG"+d]=!1,t["SHADOWCSMNUM_CASCADES"+d]=!1,t["SHADOWCSMUSESHADOWMAXZ"+d]=!1,t["SHADOWCSMNOBLEND"+d]=!1,t["SHADOWCSM_RIGHTHANDED"+d]=!1,t["SHADOWPCF"+d]=!1,t["SHADOWPCSS"+d]=!1,t["SHADOWPOISSON"+d]=!1,t["SHADOWESM"+d]=!1,t["SHADOWCLOSEESM"+d]=!1,t["SHADOWCUBE"+d]=!1,t["SHADOWLOWQUALITY"+d]=!1,t["SHADOWMEDIUMQUALITY"+d]=!1);var g=r.getEngine().getCaps();return t.SHADOWFLOAT===void 0&&(u.needRebuild=!0),t.SHADOWFLOAT=u.shadowEnabled&&(g.textureFloatRender&&g.textureFloatLinearFiltering||g.textureHalfFloatRender&&g.textureHalfFloatLinearFiltering),t.LIGHTMAPEXCLUDED=u.lightmapMode,u.needRebuild&&t.rebuild(),u.needNormals},n.PrepareUniformsAndSamplersForLight=function(r,e,t,i,a,o){a===void 0&&(a=null),o===void 0&&(o=!1),a&&a.push("Light"+r),!o&&(e.push("vLightData"+r,"vLightDiffuse"+r,"vLightSpecular"+r,"vLightDirection"+r,"vLightFalloff"+r,"vLightGround"+r,"lightMatrix"+r,"shadowsInfo"+r,"depthValues"+r),t.push("shadowSampler"+r),t.push("depthSampler"+r),e.push("viewFrustumZ"+r,"cascadeBlendFactor"+r,"lightSizeUVCorrection"+r,"depthCorrection"+r,"penumbraDarkness"+r,"frustumLengths"+r),i&&(t.push("projectionLightSampler"+r),e.push("textureProjectionMatrix"+r)))},n.PrepareUniformsAndSamplersList=function(r,e,t,i){i===void 0&&(i=4);var a,o=null;if(r.uniformsNames){var s=r;a=s.uniformsNames,o=s.uniformBuffersNames,e=s.samplers,t=s.defines,i=s.maxSimultaneousLights||0}else a=r,e||(e=[]);for(var u=0;u<i&&t["LIGHT"+u];u++)this.PrepareUniformsAndSamplersForLight(u,a,e,t["PROJECTEDLIGHTTEXTURE"+u],o);t.NUM_MORPH_INFLUENCERS&&a.push("morphTargetInfluences"),t.BAKED_VERTEX_ANIMATION_TEXTURE&&(a.push("bakedVertexAnimationSettings"),a.push("bakedVertexAnimationTextureSizeInverted"),a.push("bakedVertexAnimationTime"),e.push("bakedVertexAnimationTexture"))},n.HandleFallbacksForShadows=function(r,e,t,i){t===void 0&&(t=4),i===void 0&&(i=0);for(var a=0,o=0;o<t&&r["LIGHT"+o];o++)o>0&&(a=i+o,e.addFallback(a,"LIGHT"+o)),r.SHADOWS||(r["SHADOW"+o]&&e.addFallback(i,"SHADOW"+o),r["SHADOWPCF"+o]&&e.addFallback(i,"SHADOWPCF"+o),r["SHADOWPCSS"+o]&&e.addFallback(i,"SHADOWPCSS"+o),r["SHADOWPOISSON"+o]&&e.addFallback(i,"SHADOWPOISSON"+o),r["SHADOWESM"+o]&&e.addFallback(i,"SHADOWESM"+o),r["SHADOWCLOSEESM"+o]&&e.addFallback(i,"SHADOWCLOSEESM"+o));return a++},n.PrepareAttributesForMorphTargetsInfluencers=function(r,e,t){this._TmpMorphInfluencers.NUM_MORPH_INFLUENCERS=t,this.PrepareAttributesForMorphTargets(r,e,this._TmpMorphInfluencers)},n.PrepareAttributesForMorphTargets=function(r,e,t){var i=t.NUM_MORPH_INFLUENCERS;if(i>0&&de.LastCreatedEngine){var a=de.LastCreatedEngine.getCaps().maxVertexAttribs,o=e.morphTargetManager;if(o!=null&&o.isUsingTextureForTargets)return;for(var s=o&&o.supportsNormals&&t.NORMAL,u=o&&o.supportsTangents&&t.TANGENT,l=o&&o.supportsUVs&&t.UV1,c=0;c<i;c++)r.push(L.PositionKind+c),s&&r.push(L.NormalKind+c),u&&r.push(L.TangentKind+c),l&&r.push(L.UVKind+"_"+c),r.length>a&&$.Error("Cannot add more vertex attributes for mesh "+e.name)}},n.PrepareAttributesForBakedVertexAnimation=function(r,e,t){var i=t.BAKED_VERTEX_ANIMATION_TEXTURE&&t.INSTANCES;i&&r.push("bakedVertexAnimationSettingsInstanced")},n.PrepareAttributesForBones=function(r,e,t,i){t.NUM_BONE_INFLUENCERS>0&&(i.addCPUSkinningFallback(0,e),r.push(L.MatricesIndicesKind),r.push(L.MatricesWeightsKind),t.NUM_BONE_INFLUENCERS>4&&(r.push(L.MatricesIndicesExtraKind),r.push(L.MatricesWeightsExtraKind)))},n.PrepareAttributesForInstances=function(r,e){(e.INSTANCES||e.THIN_INSTANCES)&&this.PushAttributesForInstances(r,!!e.PREPASS_VELOCITY),e.INSTANCESCOLOR&&r.push(L.ColorInstanceKind)},n.PushAttributesForInstances=function(r,e){e===void 0&&(e=!1),r.push("world0"),r.push("world1"),r.push("world2"),r.push("world3"),e&&(r.push("previousWorld0"),r.push("previousWorld1"),r.push("previousWorld2"),r.push("previousWorld3"))},n.BindLightProperties=function(r,e,t){r.transferToEffect(e,t+"")},n.BindLight=function(r,e,t,i,a,o){o===void 0&&(o=!0),r._bindLight(e,t,i,a,o)},n.BindLights=function(r,e,t,i,a){a===void 0&&(a=4);for(var o=Math.min(e.lightSources.length,a),s=0;s<o;s++){var u=e.lightSources[s];this.BindLight(u,s,r,t,typeof i=="boolean"?i:i.SPECULARTERM,e.receiveShadows)}},n.BindFogParameters=function(r,e,t,i){i===void 0&&(i=!1),r.fogEnabled&&e.applyFog&&r.fogMode!==Ke.FOGMODE_NONE&&(t.setFloat4("vFogInfos",r.fogMode,r.fogStart,r.fogEnd,r.fogDensity),i?(r.fogColor.toLinearSpaceToRef(this._TempFogColor),t.setColor3("vFogColor",this._TempFogColor)):t.setColor3("vFogColor",r.fogColor))},n.BindBonesParameters=function(r,e,t){if(!(!e||!r)&&(r.computeBonesUsingShaders&&e._bonesComputationForcedToCPU&&(r.computeBonesUsingShaders=!1),r.useBones&&r.computeBonesUsingShaders&&r.skeleton)){var i=r.skeleton;if(i.isUsingTextureForMatrices&&e.getUniformIndex("boneTextureWidth")>-1){var a=i.getTransformMatrixTexture(r);e.setTexture("boneSampler",a),e.setFloat("boneTextureWidth",4*(i.bones.length+1))}else{var o=i.getTransformMatrices(r);o&&(e.setMatrices("mBones",o),t&&r.getScene().prePassRenderer&&r.getScene().prePassRenderer.getIndex(2)&&(t.previousBones[r.uniqueId]||(t.previousBones[r.uniqueId]=o.slice()),e.setMatrices("mPreviousBones",t.previousBones[r.uniqueId]),n._CopyBonesTransformationMatrices(o,t.previousBones[r.uniqueId])))}}},n._CopyBonesTransformationMatrices=function(r,e){return e.set(r),e},n.BindMorphTargetParameters=function(r,e){var t=r.morphTargetManager;!r||!t||e.setFloatArray("morphTargetInfluences",t.influences)},n.BindLogDepth=function(r,e,t){if(!r||r.LOGARITHMICDEPTH){var i=t.activeCamera;i.mode===pi.ORTHOGRAPHIC_CAMERA&&$.Error("Logarithmic depth is not compatible with orthographic cameras!",20),e.setFloat("logarithmicDepthConstant",2/(Math.log(i.maxZ+1)/Math.LN2))}},n.BindClipPlane=function(r,e){Si.BindClipPlane(r,e)},n._TmpMorphInfluencers={NUM_MORPH_INFLUENCERS:0},n._TempFogColor=G.Black(),n}(),Ei=function(){function n(){this.reset()}return n.prototype.reset=function(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681},Object.defineProperty(n.prototype,"func",{get:function(){return this._func},set:function(r){this._func=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"funcRef",{get:function(){return this._funcRef},set:function(r){this._funcRef=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"funcMask",{get:function(){return this._funcMask},set:function(r){this._funcMask=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"opStencilFail",{get:function(){return this._opStencilFail},set:function(r){this._opStencilFail=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"opDepthFail",{get:function(){return this._opDepthFail},set:function(r){this._opDepthFail=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"opStencilDepthPass",{get:function(){return this._opStencilDepthPass},set:function(r){this._opStencilDepthPass=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"mask",{get:function(){return this._mask},set:function(r){this._mask=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"enabled",{get:function(){return this._enabled},set:function(r){this._enabled=r},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"MaterialStencilState"},n.prototype.copyTo=function(r){j.Clone(function(){return r},this)},n.prototype.serialize=function(){return j.Serialize(this)},n.prototype.parse=function(r,e,t){var i=this;j.Parse(function(){return i},r,e,t)},h([b()],n.prototype,"func",null),h([b()],n.prototype,"funcRef",null),h([b()],n.prototype,"funcMask",null),h([b()],n.prototype,"opStencilFail",null),h([b()],n.prototype,"opDepthFail",null),h([b()],n.prototype,"opStencilDepthPass",null),h([b()],n.prototype,"mask",null),h([b()],n.prototype,"enabled",null),n}(),ue;(function(n){n[n.Created=1]="Created",n[n.Disposed=2]="Disposed",n[n.GetDefineNames=4]="GetDefineNames",n[n.PrepareUniformBuffer=8]="PrepareUniformBuffer",n[n.IsReadyForSubMesh=16]="IsReadyForSubMesh",n[n.PrepareDefines=32]="PrepareDefines",n[n.BindForSubMesh=64]="BindForSubMesh",n[n.PrepareEffect=128]="PrepareEffect",n[n.GetAnimatables=256]="GetAnimatables",n[n.GetActiveTextures=512]="GetActiveTextures",n[n.HasTexture=1024]="HasTexture",n[n.FillRenderTargetTextures=2048]="FillRenderTargetTextures",n[n.HasRenderTargetTextures=4096]="HasRenderTargetTextures",n[n.HardBindForSubMesh=8192]="HardBindForSubMesh"})(ue||(ue={}));var xe=function(){function n(r,e,t){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new J,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new Ei,this._useUBO=!1,this._fillMode=n.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=function(){},this._callbackPluginEventIsReadyForSubMesh=function(){},this._callbackPluginEventPrepareDefines=function(){},this._callbackPluginEventPrepareDefinesBeforeAttributes=function(){},this._callbackPluginEventHardBindForSubMesh=function(){},this._callbackPluginEventBindForSubMesh=function(){},this._callbackPluginEventHasRenderTargetTextures=function(){},this._callbackPluginEventFillRenderTargetTextures=function(){},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=r;var i=e||de.LastCreatedScene;!i||(this._scene=i,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=r||ae.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new qe(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._scene.useRightHandedSystem?this.sideOrientation=n.ClockWiseSideOrientation:this.sideOrientation=n.CounterClockWiseSideOrientation,this._uniformBuffer=new Ti(this._scene.getEngine(),void 0,void 0,r),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,t||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),n.OnEventObservable.notifyObservers(this,ue.Created))}return Object.defineProperty(n.prototype,"canRenderToMRT",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"alpha",{get:function(){return this._alpha},set:function(r){if(this._alpha!==r){var e=this._alpha;this._alpha=r,(e===1||r===1)&&this.markAsDirty(n.MiscDirtyFlag)}},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"backFaceCulling",{get:function(){return this._backFaceCulling},set:function(r){this._backFaceCulling!==r&&(this._backFaceCulling=r,this.markAsDirty(n.TextureDirtyFlag))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cullBackFaces",{get:function(){return this._cullBackFaces},set:function(r){this._cullBackFaces!==r&&(this._cullBackFaces=r,this.markAsDirty(n.TextureDirtyFlag))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"hasRenderTargetTextures",{get:function(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"onDispose",{set:function(r){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(r)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"onBindObservable",{get:function(){return this._onBindObservable||(this._onBindObservable=new J),this._onBindObservable},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"onBind",{set:function(r){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(r)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"onUnBindObservable",{get:function(){return this._onUnBindObservable||(this._onUnBindObservable=new J),this._onUnBindObservable},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"onEffectCreatedObservable",{get:function(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new J),this._onEffectCreatedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"alphaMode",{get:function(){return this._alphaMode},set:function(r){this._alphaMode!==r&&(this._alphaMode=r,this.markAsDirty(n.TextureDirtyFlag))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"needDepthPrePass",{get:function(){return this._needDepthPrePass},set:function(r){this._needDepthPrePass!==r&&(this._needDepthPrePass=r,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isPrePassCapable",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"fogEnabled",{get:function(){return this._fogEnabled},set:function(r){this._fogEnabled!==r&&(this._fogEnabled=r,this.markAsDirty(n.MiscDirtyFlag))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wireframe",{get:function(){switch(this._fillMode){case n.WireFrameFillMode:case n.LineListDrawMode:case n.LineLoopDrawMode:case n.LineStripDrawMode:return!0}return this._scene.forceWireframe},set:function(r){this.fillMode=r?n.WireFrameFillMode:n.TriangleFillMode},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"pointsCloud",{get:function(){switch(this._fillMode){case n.PointFillMode:case n.PointListDrawMode:return!0}return this._scene.forcePointsCloud},set:function(r){this.fillMode=r?n.PointFillMode:n.TriangleFillMode},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"fillMode",{get:function(){return this._fillMode},set:function(r){this._fillMode!==r&&(this._fillMode=r,this.markAsDirty(n.MiscDirtyFlag))},enumerable:!1,configurable:!0}),n.prototype._getDrawWrapper=function(){return this._drawWrapper},n.prototype._setDrawWrapper=function(r){this._drawWrapper=r},n.prototype.toString=function(r){var e="Name: "+this.name;return e},n.prototype.getClassName=function(){return"Material"},Object.defineProperty(n.prototype,"isFrozen",{get:function(){return this.checkReadyOnlyOnce},enumerable:!1,configurable:!0}),n.prototype.freeze=function(){this.markDirty(),this.checkReadyOnlyOnce=!0},n.prototype.unfreeze=function(){this.markDirty(),this.checkReadyOnlyOnce=!1},n.prototype.isReady=function(r,e){return!0},n.prototype.isReadyForSubMesh=function(r,e,t){var i=e.materialDefines;return i?(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=i,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh):!1},n.prototype.getEffect=function(){return this._drawWrapper.effect},n.prototype.getScene=function(){return this._scene},Object.defineProperty(n.prototype,"transparencyMode",{get:function(){return this._transparencyMode},set:function(r){this._transparencyMode!==r&&(this._transparencyMode=r,this._forceAlphaTest=r===n.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"_disableAlphaBlending",{get:function(){return this._transparencyMode===n.MATERIAL_OPAQUE||this._transparencyMode===n.MATERIAL_ALPHATEST},enumerable:!1,configurable:!0}),n.prototype.needAlphaBlending=function(){return this._disableAlphaBlending?!1:this.alpha<1},n.prototype.needAlphaBlendingForMesh=function(r){return this._disableAlphaBlending&&r.visibility>=1?!1:this.needAlphaBlending()||r.visibility<1||r.hasVertexAlpha},n.prototype.needAlphaTesting=function(){return!!this._forceAlphaTest},n.prototype._shouldTurnAlphaTestOn=function(r){return!this.needAlphaBlendingForMesh(r)&&this.needAlphaTesting()},n.prototype.getAlphaTestTexture=function(){return null},n.prototype.markDirty=function(){for(var r=this.getScene().meshes,e=0,t=r;e<t.length;e++){var i=t[e];if(!!i.subMeshes)for(var a=0,o=i.subMeshes;a<o.length;a++){var s=o[a];s.getMaterial()===this&&(!s.effect||(s.effect._wasPreviouslyReady=!1,s.effect._wasPreviouslyUsingInstances=null))}}},n.prototype._preBind=function(r,e){e===void 0&&(e=null);var t=this._scene.getEngine(),i=e==null?this.sideOrientation:e,a=i===n.ClockWiseSideOrientation;return t.enableEffect(r||this._getDrawWrapper()),t.setState(this.backFaceCulling,this.zOffset,!1,a,this.cullBackFaces,this.stencil,this.zOffsetUnits),a},n.prototype.bind=function(r,e){},n.prototype.buildUniformLayout=function(){var r=this._uniformBuffer;this._eventInfo.ubo=r,this._callbackPluginEventGeneric(ue.PrepareUniformBuffer,this._eventInfo),r.create(),this._uniformBufferLayoutBuilt=!0},n.prototype.bindForSubMesh=function(r,e,t){var i=t.effect;!i||(this._eventInfo.subMesh=t,this._callbackPluginEventBindForSubMesh(this._eventInfo))},n.prototype.bindOnlyWorldMatrix=function(r){},n.prototype.bindView=function(r){this._useUBO?this._needToBindSceneUbo=!0:r.setMatrix("view",this.getScene().getViewMatrix())},n.prototype.bindViewProjection=function(r){this._useUBO?this._needToBindSceneUbo=!0:(r.setMatrix("viewProjection",this.getScene().getTransformMatrix()),r.setMatrix("projection",this.getScene().getProjectionMatrix()))},n.prototype.bindEyePosition=function(r,e){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(r,e)},n.prototype._afterBind=function(r,e){if(e===void 0&&(e=null),this._scene._cachedMaterial=this,this._needToBindSceneUbo&&e&&(this._needToBindSceneUbo=!1,C.BindSceneUniformBuffer(e,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),r?this._scene._cachedVisibility=r.visibility:this._scene._cachedVisibility=1,this._onBindObservable&&r&&this._onBindObservable.notifyObservers(r),this.disableDepthWrite){var t=this._scene.getEngine();this._cachedDepthWriteState=t.getDepthWrite(),t.setDepthWrite(!1)}if(this.disableColorWrite){var t=this._scene.getEngine();this._cachedColorWriteState=t.getColorWrite(),t.setColorWrite(!1)}if(this.depthFunction!==0){var t=this._scene.getEngine();this._cachedDepthFunctionState=t.getDepthFunction()||0,t.setDepthFunction(this.depthFunction)}},n.prototype.unbind=function(){if(this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),this.depthFunction!==0){var r=this._scene.getEngine();r.setDepthFunction(this._cachedDepthFunctionState)}if(this.disableDepthWrite){var r=this._scene.getEngine();r.setDepthWrite(this._cachedDepthWriteState)}if(this.disableColorWrite){var r=this._scene.getEngine();r.setColorWrite(this._cachedColorWriteState)}},n.prototype.getAnimatables=function(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(ue.GetAnimatables,this._eventInfo),this._eventInfo.animatables},n.prototype.getActiveTextures=function(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(ue.GetActiveTextures,this._eventInfo),this._eventInfo.activeTextures},n.prototype.hasTexture=function(r){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=r,this._callbackPluginEventGeneric(ue.HasTexture,this._eventInfo),this._eventInfo.hasTexture},n.prototype.clone=function(r){return null},n.prototype.getBindedMeshes=function(){var r=this;if(this.meshMap){var e=new Array;for(var t in this.meshMap){var i=this.meshMap[t];i&&e.push(i)}return e}else{var a=this._scene.meshes;return a.filter(function(o){return o.material===r})}},n.prototype.forceCompilation=function(r,e,t,i){var a=this,o=Re({clipPlane:!1,useInstances:!1},t),s=this.getScene(),u=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;var l=function(){if(!(!a._scene||!a._scene.getEngine())){var c=s.clipPlane;if(o.clipPlane&&(s.clipPlane=new ct(0,0,0,1)),a._storeEffectOnSubMeshes){var p=!0,d=null;if(r.subMeshes){var g=new di(0,0,0,0,0,r,void 0,!1,!1);g.materialDefines&&(g.materialDefines._renderId=-1),a.isReadyForSubMesh(r,g,o.useInstances)||(g.effect&&g.effect.getCompilationError()&&g.effect.allFallbacksProcessed()?d=g.effect.getCompilationError():(p=!1,setTimeout(l,16)))}p&&(a.allowShaderHotSwapping=u,d&&i&&i(d),e&&e(a))}else a.isReady()?(a.allowShaderHotSwapping=u,e&&e(a)):setTimeout(l,16);o.clipPlane&&(s.clipPlane=c)}};l()},n.prototype.forceCompilationAsync=function(r,e){var t=this;return new Promise(function(i,a){t.forceCompilation(r,function(){i()},e,function(o){a(o)})})},n.prototype.markAsDirty=function(r){this.getScene().blockMaterialDirtyMechanism||(n._DirtyCallbackArray.length=0,r&n.TextureDirtyFlag&&n._DirtyCallbackArray.push(n._TextureDirtyCallBack),r&n.LightDirtyFlag&&n._DirtyCallbackArray.push(n._LightsDirtyCallBack),r&n.FresnelDirtyFlag&&n._DirtyCallbackArray.push(n._FresnelDirtyCallBack),r&n.AttributesDirtyFlag&&n._DirtyCallbackArray.push(n._AttributeDirtyCallBack),r&n.MiscDirtyFlag&&n._DirtyCallbackArray.push(n._MiscDirtyCallBack),r&n.PrePassDirtyFlag&&n._DirtyCallbackArray.push(n._PrePassDirtyCallBack),n._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(n._RunDirtyCallBacks),this.getScene().resetCachedMaterial())},n.prototype.resetDrawCache=function(){for(var r=this.getScene().meshes,e=0,t=r;e<t.length;e++){var i=t[e];if(!!i.subMeshes)for(var a=0,o=i.subMeshes;a<o.length;a++){var s=o[a];s.getMaterial()===this&&s.resetDrawCache()}}},n.prototype._markAllSubMeshesAsDirty=function(r){if(!this.getScene().blockMaterialDirtyMechanism)for(var e=this.getScene().meshes,t=0,i=e;t<i.length;t++){var a=i[t];if(!!a.subMeshes)for(var o=0,s=a.subMeshes;o<s.length;o++){var u=s[o];if(u.getMaterial(!1)===this)for(var l=0,c=u._drawWrappers;l<c.length;l++){var p=c[l];!p||!p.defines||!p.defines.markAllAsDirty||this._materialContext===p.materialContext&&r(p.defines)}}}},n.prototype._markScenePrePassDirty=function(){if(!this.getScene().blockMaterialDirtyMechanism){var r=this.getScene().enablePrePassRenderer();r&&r.markAsDirty()}},n.prototype._markAllSubMeshesAsAllDirty=function(){this._markAllSubMeshesAsDirty(n._AllDirtyCallBack)},n.prototype._markAllSubMeshesAsImageProcessingDirty=function(){this._markAllSubMeshesAsDirty(n._ImageProcessingDirtyCallBack)},n.prototype._markAllSubMeshesAsTexturesDirty=function(){this._markAllSubMeshesAsDirty(n._TextureDirtyCallBack)},n.prototype._markAllSubMeshesAsFresnelDirty=function(){this._markAllSubMeshesAsDirty(n._FresnelDirtyCallBack)},n.prototype._markAllSubMeshesAsFresnelAndMiscDirty=function(){this._markAllSubMeshesAsDirty(n._FresnelAndMiscDirtyCallBack)},n.prototype._markAllSubMeshesAsLightsDirty=function(){this._markAllSubMeshesAsDirty(n._LightsDirtyCallBack)},n.prototype._markAllSubMeshesAsAttributesDirty=function(){this._markAllSubMeshesAsDirty(n._AttributeDirtyCallBack)},n.prototype._markAllSubMeshesAsMiscDirty=function(){this._markAllSubMeshesAsDirty(n._MiscDirtyCallBack)},n.prototype._markAllSubMeshesAsPrePassDirty=function(){this._markAllSubMeshesAsDirty(n._MiscDirtyCallBack)},n.prototype._markAllSubMeshesAsTexturesAndMiscDirty=function(){this._markAllSubMeshesAsDirty(n._TextureAndMiscDirtyCallBack)},n.prototype.setPrePassRenderer=function(r){return!1},n.prototype.dispose=function(r,e,t){var i=this.getScene();if(i.stopAnimation(this),i.freeProcessedMaterials(),i.removeMaterial(this),this._eventInfo.forceDisposeTextures=e,this._callbackPluginEventGeneric(ue.Disposed,this._eventInfo),this._parentContainer){var a=this._parentContainer.materials.indexOf(this);a>-1&&this._parentContainer.materials.splice(a,1),this._parentContainer=null}if(t!==!0)if(this.meshMap)for(var o in this.meshMap){var s=this.meshMap[o];s&&(s.material=null,this.releaseVertexArrayObject(s,r))}else for(var u=i.meshes,l=0,c=u;l<c.length;l++){var s=c[l];s.material===this&&!s.sourceMesh&&(s.material=null,this.releaseVertexArrayObject(s,r))}this._uniformBuffer.dispose(),r&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear()},n.prototype.releaseVertexArrayObject=function(r,e){if(r.geometry){var t=r.geometry;if(this._storeEffectOnSubMeshes)for(var i=0,a=r.subMeshes;i<a.length;i++){var o=a[i];t._releaseVertexArrayObject(o.effect),e&&o.effect&&o.effect.dispose()}else t._releaseVertexArrayObject(this._drawWrapper.effect)}},n.prototype.serialize=function(){var r=j.Serialize(this);return r.stencil=this.stencil.serialize(),r.uniqueId=this.uniqueId,r},n.Parse=function(r,e,t){if(!r.customType)r.customType="BABYLON.StandardMaterial";else if(r.customType==="BABYLON.PBRMaterial"&&r.overloadedAlbedo&&(r.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return $.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null;var i=ae.Instantiate(r.customType),a=i.Parse(r,e,t);return a._loadedUniqueId=r.uniqueId,a},n.TriangleFillMode=0,n.WireFrameFillMode=1,n.PointFillMode=2,n.PointListDrawMode=3,n.LineListDrawMode=4,n.LineLoopDrawMode=5,n.LineStripDrawMode=6,n.TriangleStripDrawMode=7,n.TriangleFanDrawMode=8,n.ClockWiseSideOrientation=0,n.CounterClockWiseSideOrientation=1,n.TextureDirtyFlag=1,n.LightDirtyFlag=2,n.FresnelDirtyFlag=4,n.AttributesDirtyFlag=8,n.MiscDirtyFlag=16,n.PrePassDirtyFlag=32,n.AllDirtyFlag=63,n.MATERIAL_OPAQUE=0,n.MATERIAL_ALPHATEST=1,n.MATERIAL_ALPHABLEND=2,n.MATERIAL_ALPHATESTANDBLEND=3,n.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0,n.MATERIAL_NORMALBLENDMETHOD_RNM=1,n.OnEventObservable=new J,n._AllDirtyCallBack=function(r){return r.markAllAsDirty()},n._ImageProcessingDirtyCallBack=function(r){return r.markAsImageProcessingDirty()},n._TextureDirtyCallBack=function(r){return r.markAsTexturesDirty()},n._FresnelDirtyCallBack=function(r){return r.markAsFresnelDirty()},n._MiscDirtyCallBack=function(r){return r.markAsMiscDirty()},n._PrePassDirtyCallBack=function(r){return r.markAsPrePassDirty()},n._LightsDirtyCallBack=function(r){return r.markAsLightDirty()},n._AttributeDirtyCallBack=function(r){return r.markAsAttributesDirty()},n._FresnelAndMiscDirtyCallBack=function(r){n._FresnelDirtyCallBack(r),n._MiscDirtyCallBack(r)},n._TextureAndMiscDirtyCallBack=function(r){n._TextureDirtyCallBack(r),n._MiscDirtyCallBack(r)},n._DirtyCallbackArray=[],n._RunDirtyCallBacks=function(r){for(var e=0,t=n._DirtyCallbackArray;e<t.length;e++){var i=t[e];i(r)}},h([b()],n.prototype,"id",void 0),h([b()],n.prototype,"uniqueId",void 0),h([b()],n.prototype,"name",void 0),h([b()],n.prototype,"metadata",void 0),h([b()],n.prototype,"checkReadyOnEveryCall",void 0),h([b()],n.prototype,"checkReadyOnlyOnce",void 0),h([b()],n.prototype,"state",void 0),h([b("alpha")],n.prototype,"_alpha",void 0),h([b("backFaceCulling")],n.prototype,"_backFaceCulling",void 0),h([b("cullBackFaces")],n.prototype,"_cullBackFaces",void 0),h([b()],n.prototype,"sideOrientation",void 0),h([b("alphaMode")],n.prototype,"_alphaMode",void 0),h([b()],n.prototype,"_needDepthPrePass",void 0),h([b()],n.prototype,"disableDepthWrite",void 0),h([b()],n.prototype,"disableColorWrite",void 0),h([b()],n.prototype,"forceDepthWrite",void 0),h([b()],n.prototype,"depthFunction",void 0),h([b()],n.prototype,"separateCullingPass",void 0),h([b("fogEnabled")],n.prototype,"_fogEnabled",void 0),h([b()],n.prototype,"pointSize",void 0),h([b()],n.prototype,"zOffset",void 0),h([b()],n.prototype,"zOffsetUnits",void 0),h([b()],n.prototype,"pointsCloud",null),h([b()],n.prototype,"fillMode",null),h([b()],n.prototype,"transparencyMode",null),n}(),Ai=function(n){A(r,n);function r(e,t){var i=n.call(this,e,t,!0)||this;return i._waitingSubMaterialsUniqueIds=[],i.getScene().multiMaterials.push(i),i.subMaterials=new Array,i._storeEffectOnSubMeshes=!0,i}return Object.defineProperty(r.prototype,"subMaterials",{get:function(){return this._subMaterials},set:function(e){this._subMaterials=e,this._hookArray(e)},enumerable:!1,configurable:!0}),r.prototype.getChildren=function(){return this.subMaterials},r.prototype._hookArray=function(e){var t=this,i=e.push;e.push=function(){for(var o=[],s=0;s<arguments.length;s++)o[s]=arguments[s];var u=i.apply(e,o);return t._markAllSubMeshesAsTexturesDirty(),u};var a=e.splice;e.splice=function(o,s){var u=a.apply(e,[o,s]);return t._markAllSubMeshesAsTexturesDirty(),u}},r.prototype.getSubMaterial=function(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]},r.prototype.getActiveTextures=function(){var e;return(e=n.prototype.getActiveTextures.call(this)).concat.apply(e,this.subMaterials.map(function(t){return t?t.getActiveTextures():[]}))},r.prototype.hasTexture=function(e){var t;if(n.prototype.hasTexture.call(this,e))return!0;for(var i=0;i<this.subMaterials.length;i++)if(!((t=this.subMaterials[i])===null||t===void 0)&&t.hasTexture(e))return!0;return!1},r.prototype.getClassName=function(){return"MultiMaterial"},r.prototype.isReadyForSubMesh=function(e,t,i){for(var a=0;a<this.subMaterials.length;a++){var o=this.subMaterials[a];if(o){if(o._storeEffectOnSubMeshes){if(!o.isReadyForSubMesh(e,t,i))return!1;continue}if(!o.isReady(e))return!1}}return!0},r.prototype.clone=function(e,t){for(var i=new r(e,this.getScene()),a=0;a<this.subMaterials.length;a++){var o=null,s=this.subMaterials[a];t&&s?o=s.clone(e+"-"+s.name):o=this.subMaterials[a],i.subMaterials.push(o)}return i},r.prototype.serialize=function(){var e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,it&&(e.tags=it.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(var t=0;t<this.subMaterials.length;t++){var i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e},r.prototype.dispose=function(e,t,i){var a=this.getScene();if(!!a){if(i)for(var o=0;o<this.subMaterials.length;o++){var s=this.subMaterials[o];s&&s.dispose(e,t)}var u=a.multiMaterials.indexOf(this);u>=0&&a.multiMaterials.splice(u,1),n.prototype.dispose.call(this,e,t)}},r.ParseMultiMaterial=function(e,t){var i=new r(e.name,t);return i.id=e.id,i._loadedUniqueId=e.uniqueId,it&&it.AddTagsTo(i,e.tags),e.materialsUniqueIds?i._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach(function(a){return i.subMaterials.push(t.getLastMaterialById(a))}),i},r}(xe);P("BABYLON.MultiMaterial",Ai);var mr=function(){function n(r){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=rr.Zero(),this._cachedBaseSize=rr.Zero(),this._initialSamplingMode=2,this._texture=r,this._texture&&(this._engine=this._texture.getEngine())}return Object.defineProperty(n.prototype,"wrapU",{get:function(){return this._wrapU},set:function(r){this._wrapU=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wrapV",{get:function(){return this._wrapV},set:function(r){this._wrapV=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"coordinatesMode",{get:function(){return 0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isCube",{get:function(){return this._texture?this._texture.isCube:!1},set:function(r){!this._texture||(this._texture.isCube=r)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"is3D",{get:function(){return this._texture?this._texture.is3D:!1},set:function(r){!this._texture||(this._texture.is3D=r)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"is2DArray",{get:function(){return this._texture?this._texture.is2DArray:!1},set:function(r){!this._texture||(this._texture.is2DArray=r)},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"ThinTexture"},n.prototype.isReady=function(){return this.delayLoadState===4?(this.delayLoad(),!1):this._texture?this._texture.isReady:!1},n.prototype.delayLoad=function(){},n.prototype.getInternalTexture=function(){return this._texture},n.prototype.getSize=function(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize},n.prototype.getBaseSize=function(){return!this.isReady()||!this._texture?(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize):this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize)},Object.defineProperty(n.prototype,"samplingMode",{get:function(){return this._texture?this._texture.samplingMode:this._initialSamplingMode},enumerable:!1,configurable:!0}),n.prototype.updateSamplingMode=function(r){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(r,this._texture)},n.prototype.releaseInternalTexture=function(){this._texture&&(this._texture.dispose(),this._texture=null)},n.prototype.dispose=function(){this._texture&&(this.releaseInternalTexture(),this._engine=null)},n}(),De=function(n){A(r,n);function r(e,t){t===void 0&&(t=null);var i=n.call(this,null)||this;return i.metadata=null,i.reservedDataStore=null,i._hasAlpha=!1,i._getAlphaFromRGB=!1,i.level=1,i._coordinatesIndex=0,i._coordinatesMode=0,i.wrapR=1,i.anisotropicFilteringLevel=r.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,i._isCube=!1,i._gammaSpace=!0,i.invertZ=!1,i.lodLevelInAlpha=!1,i.isRenderTarget=!1,i._prefiltered=!1,i._forceSerialize=!1,i.animations=new Array,i.onDisposeObservable=new J,i._onDisposeObserver=null,i._scene=null,i._uid=null,i._parentContainer=null,i._loadingError=!1,e?r._IsScene(e)?i._scene=e:i._engine=e:i._scene=de.LastCreatedScene,i._scene&&(i.uniqueId=i._scene.getUniqueId(),i._scene.addTexture(i),i._engine=i._scene.getEngine()),i._texture=t,i._uid=null,i}return Object.defineProperty(r.prototype,"hasAlpha",{get:function(){return this._hasAlpha},set:function(e){var t=this;this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,function(i){return i.hasTexture(t)}))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"getAlphaFromRGB",{get:function(){return this._getAlphaFromRGB},set:function(e){var t=this;this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,function(i){return i.hasTexture(t)}))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"coordinatesIndex",{get:function(){return this._coordinatesIndex},set:function(e){var t=this;this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,function(i){return i.hasTexture(t)}))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"coordinatesMode",{get:function(){return this._coordinatesMode},set:function(e){var t=this;this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,function(i){return i.hasTexture(t)}))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"wrapU",{get:function(){return this._wrapU},set:function(e){this._wrapU=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"wrapV",{get:function(){return this._wrapV},set:function(e){this._wrapV=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isCube",{get:function(){return this._texture?this._texture.isCube:this._isCube},set:function(e){this._texture?this._texture.isCube=e:this._isCube=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"is3D",{get:function(){return this._texture?this._texture.is3D:!1},set:function(e){!this._texture||(this._texture.is3D=e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"is2DArray",{get:function(){return this._texture?this._texture.is2DArray:!1},set:function(e){!this._texture||(this._texture.is2DArray=e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"gammaSpace",{get:function(){if(this._texture)this._texture._gammaSpace===null&&(this._texture._gammaSpace=this._gammaSpace);else return this._gammaSpace;return this._texture._gammaSpace&&!this._texture._useSRGBBuffer},set:function(e){if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isRGBD",{get:function(){return this._texture!=null&&this._texture._isRGBD},set:function(e){this._texture&&(this._texture._isRGBD=e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"noMipmap",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"lodGenerationOffset",{get:function(){return this._texture?this._texture._lodGenerationOffset:0},set:function(e){this._texture&&(this._texture._lodGenerationOffset=e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"lodGenerationScale",{get:function(){return this._texture?this._texture._lodGenerationScale:0},set:function(e){this._texture&&(this._texture._lodGenerationScale=e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"linearSpecularLOD",{get:function(){return this._texture?this._texture._linearSpecularLOD:!1},set:function(e){this._texture&&(this._texture._linearSpecularLOD=e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"irradianceTexture",{get:function(){return this._texture?this._texture._irradianceTexture:null},set:function(e){this._texture&&(this._texture._irradianceTexture=e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"uid",{get:function(){return this._uid||(this._uid=hr()),this._uid},enumerable:!1,configurable:!0}),r.prototype.toString=function(){return this.name},r.prototype.getClassName=function(){return"BaseTexture"},Object.defineProperty(r.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isBlocking",{get:function(){return!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"loadingError",{get:function(){return this._loadingError},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"errorObject",{get:function(){return this._errorObject},enumerable:!1,configurable:!0}),r.prototype.getScene=function(){return this._scene},r.prototype._getEngine=function(){return this._engine},r.prototype.checkTransformsAreIdentical=function(e){return e!==null},r.prototype.getTextureMatrix=function(){return q.IdentityReadOnly},r.prototype.getReflectionTextureMatrix=function(){return q.IdentityReadOnly},r.prototype.isReadyOrNotBlocking=function(){return!this.isBlocking||this.isReady()||this.loadingError},r.prototype.scale=function(e){},Object.defineProperty(r.prototype,"canRescale",{get:function(){return!1},enumerable:!1,configurable:!0}),r.prototype._getFromCache=function(e,t,i,a,o,s){var u=this._getEngine();if(!u)return null;for(var l=u._getUseSRGBBuffer(!!o,t),c=u.getLoadedTexturesCache(),p=0;p<c.length;p++){var d=c[p];if((o===void 0||l===d._useSRGBBuffer)&&(a===void 0||a===d.invertY)&&d.url===e&&d.generateMipMaps===!t&&(!i||i===d.samplingMode)&&(s===void 0||s===d.isCube))return d.incrementReferences(),d}return null},r.prototype._rebuild=function(){},r.prototype.clone=function(){return null},Object.defineProperty(r.prototype,"textureType",{get:function(){return this._texture&&this._texture.type!==void 0?this._texture.type:0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"textureFormat",{get:function(){return this._texture&&this._texture.format!==void 0?this._texture.format:5},enumerable:!1,configurable:!0}),r.prototype._markAllSubMeshesAsTexturesDirty=function(){var e=this.getScene();!e||e.markAllMaterialsAsDirty(1)},r.prototype.readPixels=function(e,t,i,a,o,s,u,l,c){if(e===void 0&&(e=0),t===void 0&&(t=0),i===void 0&&(i=null),a===void 0&&(a=!0),o===void 0&&(o=!1),s===void 0&&(s=0),u===void 0&&(u=0),l===void 0&&(l=Number.MAX_VALUE),c===void 0&&(c=Number.MAX_VALUE),!this._texture)return null;var p=this._getEngine();if(!p)return null;var d=this.getSize(),g=d.width,m=d.height;t!==0&&(g=g/Math.pow(2,t),m=m/Math.pow(2,t),g=Math.round(g),m=Math.round(m)),l=Math.min(g,l),c=Math.min(m,c);try{return this._texture.isCube?p._readTexturePixels(this._texture,l,c,e,t,i,a,o,s,u):p._readTexturePixels(this._texture,l,c,-1,t,i,a,o,s,u)}catch{return null}},r.prototype._readPixelsSync=function(e,t,i,a,o){if(e===void 0&&(e=0),t===void 0&&(t=0),i===void 0&&(i=null),a===void 0&&(a=!0),o===void 0&&(o=!1),!this._texture)return null;var s=this.getSize(),u=s.width,l=s.height,c=this._getEngine();if(!c)return null;t!=0&&(u=u/Math.pow(2,t),l=l/Math.pow(2,t),u=Math.round(u),l=Math.round(l));try{return this._texture.isCube?c._readTexturePixelsSync(this._texture,u,l,e,t,i,a,o):c._readTexturePixelsSync(this._texture,u,l,-1,t,i,a,o)}catch{return null}},Object.defineProperty(r.prototype,"_lodTextureHigh",{get:function(){return this._texture?this._texture._lodTextureHigh:null},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"_lodTextureMid",{get:function(){return this._texture?this._texture._lodTextureMid:null},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"_lodTextureLow",{get:function(){return this._texture?this._texture._lodTextureLow:null},enumerable:!1,configurable:!0}),r.prototype.dispose=function(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);var e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){var t=this._parentContainer.textures.indexOf(this);t>-1&&this._parentContainer.textures.splice(t,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,n.prototype.dispose.call(this)},r.prototype.serialize=function(){if(!this.name)return null;var e=j.Serialize(this);return j.AppendSerializedAnimations(this,e),e},r.WhenAllReady=function(e,t){var i=e.length;if(i===0){t();return}for(var a=0;a<e.length;a++){var o=e[a];if(o.isReady())--i===0&&t();else{var s=o.onLoadObservable;s?s.addOnce(function(){--i===0&&t()}):--i===0&&t()}}},r._IsScene=function(e){return e.getClassName()==="Scene"},r.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4,h([b()],r.prototype,"uniqueId",void 0),h([b()],r.prototype,"name",void 0),h([b()],r.prototype,"metadata",void 0),h([b("hasAlpha")],r.prototype,"_hasAlpha",void 0),h([b("getAlphaFromRGB")],r.prototype,"_getAlphaFromRGB",void 0),h([b()],r.prototype,"level",void 0),h([b("coordinatesIndex")],r.prototype,"_coordinatesIndex",void 0),h([b("coordinatesMode")],r.prototype,"_coordinatesMode",void 0),h([b()],r.prototype,"wrapU",null),h([b()],r.prototype,"wrapV",null),h([b()],r.prototype,"wrapR",void 0),h([b()],r.prototype,"anisotropicFilteringLevel",void 0),h([b()],r.prototype,"isCube",null),h([b()],r.prototype,"is3D",null),h([b()],r.prototype,"is2DArray",null),h([b()],r.prototype,"gammaSpace",null),h([b()],r.prototype,"invertZ",void 0),h([b()],r.prototype,"lodLevelInAlpha",void 0),h([b()],r.prototype,"lodGenerationOffset",null),h([b()],r.prototype,"lodGenerationScale",null),h([b()],r.prototype,"linearSpecularLOD",null),h([U()],r.prototype,"irradianceTexture",null),h([b()],r.prototype,"isRenderTarget",void 0),r}(mr),I=function(n){A(r,n);function r(e,t,i,a,o,s,u,l,c,p,d,g,m,y){o===void 0&&(o=r.TRILINEAR_SAMPLINGMODE),s===void 0&&(s=null),u===void 0&&(u=null),l===void 0&&(l=null),c===void 0&&(c=!1);var v=this,T,x,E,O,N,w,k,W,Z;v=n.call(this,t)||this,v.url=null,v.uOffset=0,v.vOffset=0,v.uScale=1,v.vScale=1,v.uAng=0,v.vAng=0,v.wAng=0,v.uRotationCenter=.5,v.vRotationCenter=.5,v.wRotationCenter=.5,v.homogeneousRotationInUVTransform=!1,v.inspectableCustomProperties=null,v._noMipmap=!1,v._invertY=!1,v._rowGenerationMatrix=null,v._cachedTextureMatrix=null,v._projectionModeMatrix=null,v._t0=null,v._t1=null,v._t2=null,v._cachedUOffset=-1,v._cachedVOffset=-1,v._cachedUScale=0,v._cachedVScale=0,v._cachedUAng=-1,v._cachedVAng=-1,v._cachedWAng=-1,v._cachedProjectionMatrixId=-1,v._cachedURotationCenter=-1,v._cachedVRotationCenter=-1,v._cachedWRotationCenter=-1,v._cachedHomogeneousRotationInUVTransform=!1,v._cachedCoordinatesMode=-1,v._buffer=null,v._deleteBuffer=!1,v._format=null,v._delayedOnLoad=null,v._delayedOnError=null,v.onLoadObservable=new J,v._isBlocking=!0,v.name=e||"",v.url=e;var ie,D=!1,ne=null;typeof i=="object"&&i!==null?(ie=(T=i.noMipmap)!==null&&T!==void 0?T:!1,a=(x=i.invertY)!==null&&x!==void 0?x:!ur.UseOpenGLOrientationForUV,o=(E=i.samplingMode)!==null&&E!==void 0?E:r.TRILINEAR_SAMPLINGMODE,s=(O=i.onLoad)!==null&&O!==void 0?O:null,u=(N=i.onError)!==null&&N!==void 0?N:null,l=(w=i.buffer)!==null&&w!==void 0?w:null,c=(k=i.deleteBuffer)!==null&&k!==void 0?k:!1,p=i.format,d=i.mimeType,g=i.loaderOptions,m=i.creationFlags,D=(W=i.useSRGBBuffer)!==null&&W!==void 0?W:!1,ne=(Z=i.internalTexture)!==null&&Z!==void 0?Z:null):ie=!!i,v._noMipmap=ie,v._invertY=a===void 0?!ur.UseOpenGLOrientationForUV:a,v._initialSamplingMode=o,v._buffer=l,v._deleteBuffer=c,v._mimeType=d,v._loaderOptions=g,v._creationFlags=m,v._useSRGBBuffer=D,v._forcedExtension=y,p&&(v._format=p);var he=v.getScene(),oe=v._getEngine();if(!oe)return v;oe.onBeforeTextureInitObservable.notifyObservers(v);var Se=function(){v._texture&&(v._texture._invertVScale&&(v.vScale*=-1,v.vOffset+=1),v._texture._cachedWrapU!==null&&(v.wrapU=v._texture._cachedWrapU,v._texture._cachedWrapU=null),v._texture._cachedWrapV!==null&&(v.wrapV=v._texture._cachedWrapV,v._texture._cachedWrapV=null),v._texture._cachedWrapR!==null&&(v.wrapR=v._texture._cachedWrapR,v._texture._cachedWrapR=null)),v.onLoadObservable.hasObservers()&&v.onLoadObservable.notifyObservers(v),s&&s(),!v.isBlocking&&he&&he.resetCachedMaterial()},Ce=function(te,Pe){v._loadingError=!0,v._errorObject={message:te,exception:Pe},u&&u(te,Pe),r.OnTextureLoadErrorObservable.notifyObservers(v)};if(!v.url)return v._delayedOnLoad=Se,v._delayedOnError=Ce,v;if(v._texture=ne!=null?ne:v._getFromCache(v.url,ie,o,v._invertY,D),v._texture)if(v._texture.isReady)ut.SetImmediate(function(){return Se()});else{var Oe=v._texture.onLoadedObservable.add(Se);v._texture.onErrorObservable.add(function(te){var Pe;Ce(te.message,te.exception),(Pe=v._texture)===null||Pe===void 0||Pe.onLoadedObservable.remove(Oe)})}else if(!he||!he.useDelayedTextureLoading){try{v._texture=oe.createTexture(v.url,ie,v._invertY,he,o,Se,Ce,v._buffer,void 0,v._format,v._forcedExtension,d,g,m,D)}catch(te){throw Ce("error loading",te),te}c&&(v._buffer=null)}else v.delayLoadState=4,v._delayedOnLoad=Se,v._delayedOnError=Ce;return v}return Object.defineProperty(r.prototype,"noMipmap",{get:function(){return this._noMipmap},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"mimeType",{get:function(){return this._mimeType},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isBlocking",{get:function(){return this._isBlocking},set:function(e){this._isBlocking=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"invertY",{get:function(){return this._invertY},enumerable:!1,configurable:!0}),r.prototype.updateURL=function(e,t,i,a){t===void 0&&(t=null),this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1)),(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=a,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()},r.prototype.delayLoad=function(){if(this.delayLoadState===4){var e=this.getScene();!e||(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer),this._texture?this._delayedOnLoad&&(this._texture.isReady?ut.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}},r.prototype._prepareRowForTextureGeneration=function(e,t,i,a){e*=this._cachedUScale,t*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,K.TransformCoordinatesFromFloatsToRef(e,t,i,this._rowGenerationMatrix,a),a.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,a.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,a.z+=this.wRotationCenter},r.prototype.checkTransformsAreIdentical=function(e){return e!==null&&this.uOffset===e.uOffset&&this.vOffset===e.vOffset&&this.uScale===e.uScale&&this.vScale===e.vScale&&this.uAng===e.uAng&&this.vAng===e.vAng&&this.wAng===e.wAng},r.prototype.getTextureMatrix=function(e){var t=this;if(e===void 0&&(e=1),this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=q.Zero(),this._rowGenerationMatrix=new q,this._t0=K.Zero(),this._t1=K.Zero(),this._t2=K.Zero()),q.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(q.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,Ee.Matrix[0]),q.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,Ee.Matrix[1]),q.ScalingToRef(this._cachedUScale,this._cachedVScale,0,Ee.Matrix[2]),q.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,Ee.Matrix[3]),Ee.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(Ee.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(Ee.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(Ee.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),q.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));var i=this.getScene();return i?(i.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(t)}),this._cachedTextureMatrix):this._cachedTextureMatrix},r.prototype.getReflectionTextureMatrix=function(){var e=this,t=this.getScene();if(!t)return this._cachedTextureMatrix;if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.coordinatesMode===this._cachedCoordinatesMode)if(this.coordinatesMode===r.PROJECTION_MODE){if(this._cachedProjectionMatrixId===t.getProjectionMatrix().updateFlag)return this._cachedTextureMatrix}else return this._cachedTextureMatrix;this._cachedTextureMatrix||(this._cachedTextureMatrix=q.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=q.Zero());var i=this._cachedCoordinatesMode!==this.coordinatesMode;switch(this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale,this._cachedVScale=this.vScale,this._cachedCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case r.PLANAR_MODE:{q.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix[0]=this.uScale,this._cachedTextureMatrix[5]=this.vScale,this._cachedTextureMatrix[12]=this.uOffset,this._cachedTextureMatrix[13]=this.vOffset;break}case r.PROJECTION_MODE:{q.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);var a=t.getProjectionMatrix();this._cachedProjectionMatrixId=a.updateFlag,a.multiplyToRef(this._projectionModeMatrix,this._cachedTextureMatrix);break}default:q.IdentityToRef(this._cachedTextureMatrix);break}return i&&t.markAllMaterialsAsDirty(1,function(o){return o.getActiveTextures().indexOf(e)!==-1}),this._cachedTextureMatrix},r.prototype.clone=function(){var e=this,t={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return j.Clone(function(){return new r(e._texture?e._texture.url:null,e.getScene(),t)},this)},r.prototype.serialize=function(){var e=this.name;r.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");var t=n.prototype.serialize.call(this);return t?((r.SerializeBuffers||r.ForceSerializeBuffers)&&(typeof this._buffer=="string"&&this._buffer.substr(0,5)==="data:"?(t.base64String=this._buffer,t.name=t.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?t.base64String="data:image/png;base64,"+qr(this._buffer):(r.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(t.base64String=!this._engine||this._engine._features.supportSyncTextureRead?Zr(this):Qr(this))),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t._creationFlags=this._creationFlags,t._useSRGBBuffer=this._useSRGBBuffer,this.name=e,t):null},r.prototype.getClassName=function(){return"Texture"},r.prototype.dispose=function(){n.prototype.dispose.call(this),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null},r.Parse=function(e,t,i){if(e.customType){var a=Jr.Instantiate(e.customType),o=a.Parse(e,t,i);return e.samplingMode&&o.updateSamplingMode&&o._samplingMode&&o._samplingMode!==e.samplingMode&&o.updateSamplingMode(e.samplingMode),o}if(e.isCube&&!e.isRenderTarget)return r._CubeTextureParser(e,t,i);if(!e.name&&!e.isRenderTarget)return null;var s=function(l){if(l&&l._texture&&(l._texture._cachedWrapU=null,l._texture._cachedWrapV=null,l._texture._cachedWrapR=null),e.samplingMode){var c=e.samplingMode;l&&l.samplingMode!==c&&l.updateSamplingMode(c)}if(l&&e.animations)for(var p=0;p<e.animations.length;p++){var d=e.animations[p],g=Qe("BABYLON.Animation");g&&l.animations.push(g.Parse(d))}},u=j.Parse(function(){var l,c,p,d=!0;if(e.noMipmap&&(d=!1),e.mirrorPlane){var g=r._CreateMirror(e.name,e.renderTargetSize,t,d);return g._waitingRenderList=e.renderList,g.mirrorPlane=ct.FromArray(e.mirrorPlane),s(g),g}else if(e.isRenderTarget){var m=null;if(e.isCube){if(t.reflectionProbes)for(var y=0;y<t.reflectionProbes.length;y++){var v=t.reflectionProbes[y];if(v.name===e.name)return v.cubeTexture}}else m=r._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,d,(l=e._creationFlags)!==null&&l!==void 0?l:0),m._waitingRenderList=e.renderList;return s(m),m}else{var T;if(e.base64String)T=r.CreateFromBase64String(e.base64String,e.name,t,!d,e.invertY,e.samplingMode,function(){s(T)},(c=e._creationFlags)!==null&&c!==void 0?c:0,(p=e._useSRGBBuffer)!==null&&p!==void 0?p:!1);else{var x=void 0;e.name&&e.name.indexOf("://")>0?x=e.name:x=i+e.name,e.url&&(e.url.startsWith("data:")||r.UseSerializedUrlIfAny)&&(x=e.url),T=new r(x,t,!d,e.invertY,e.samplingMode,function(){s(T)})}return T}},e,t);return u},r.CreateFromBase64String=function(e,t,i,a,o,s,u,l,c,p){return s===void 0&&(s=r.TRILINEAR_SAMPLINGMODE),u===void 0&&(u=null),l===void 0&&(l=null),c===void 0&&(c=5),new r("data:"+t,i,a,o,s,u,l,e,!1,c,void 0,void 0,p)},r.LoadFromDataString=function(e,t,i,a,o,s,u,l,c,p,d){return a===void 0&&(a=!1),s===void 0&&(s=!0),u===void 0&&(u=r.TRILINEAR_SAMPLINGMODE),l===void 0&&(l=null),c===void 0&&(c=null),p===void 0&&(p=5),e.substr(0,5)!=="data:"&&(e="data:"+e),new r(e,i,o,s,u,l,c,t,a,p,void 0,void 0,d)},r.SerializeBuffers=!0,r.ForceSerializeBuffers=!1,r.OnTextureLoadErrorObservable=new J,r._CubeTextureParser=function(e,t,i){throw Rt("CubeTexture")},r._CreateMirror=function(e,t,i,a){throw Rt("MirrorTexture")},r._CreateRenderTargetTexture=function(e,t,i,a,o){throw Rt("RenderTargetTexture")},r.NEAREST_SAMPLINGMODE=1,r.NEAREST_NEAREST_MIPLINEAR=8,r.BILINEAR_SAMPLINGMODE=2,r.LINEAR_LINEAR_MIPNEAREST=11,r.TRILINEAR_SAMPLINGMODE=3,r.LINEAR_LINEAR_MIPLINEAR=3,r.NEAREST_NEAREST_MIPNEAREST=4,r.NEAREST_LINEAR_MIPNEAREST=5,r.NEAREST_LINEAR_MIPLINEAR=6,r.NEAREST_LINEAR=7,r.NEAREST_NEAREST=1,r.LINEAR_NEAREST_MIPNEAREST=9,r.LINEAR_NEAREST_MIPLINEAR=10,r.LINEAR_LINEAR=2,r.LINEAR_NEAREST=12,r.EXPLICIT_MODE=0,r.SPHERICAL_MODE=1,r.PLANAR_MODE=2,r.CUBIC_MODE=3,r.PROJECTION_MODE=4,r.SKYBOX_MODE=5,r.INVCUBIC_MODE=6,r.EQUIRECTANGULAR_MODE=7,r.FIXED_EQUIRECTANGULAR_MODE=8,r.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,r.CLAMP_ADDRESSMODE=0,r.WRAP_ADDRESSMODE=1,r.MIRROR_ADDRESSMODE=2,r.UseSerializedUrlIfAny=!1,h([b()],r.prototype,"url",void 0),h([b()],r.prototype,"uOffset",void 0),h([b()],r.prototype,"vOffset",void 0),h([b()],r.prototype,"uScale",void 0),h([b()],r.prototype,"vScale",void 0),h([b()],r.prototype,"uAng",void 0),h([b()],r.prototype,"vAng",void 0),h([b()],r.prototype,"wAng",void 0),h([b()],r.prototype,"uRotationCenter",void 0),h([b()],r.prototype,"vRotationCenter",void 0),h([b()],r.prototype,"wRotationCenter",void 0),h([b()],r.prototype,"homogeneousRotationInUVTransform",void 0),h([b()],r.prototype,"isBlocking",null),r}(De);P("BABYLON.Texture",I);j._TextureParser=I.Parse;var Ba=function(n){A(r,n);function r(e,t,i,a,o,s,u,l,c,p,d){s===void 0&&(s=!0),u===void 0&&(u=!1),l===void 0&&(l=3),c===void 0&&(c=0);var g=n.call(this,null,o,!s,u,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,p)||this;return g.format=a,g._engine&&(!g._engine._caps.textureFloatLinearFiltering&&c===1&&(l=1),!g._engine._caps.textureHalfFloatLinearFiltering&&c===2&&(l=1),g._texture=g._engine.createRawTexture(e,t,i,a,s,u,l,null,c,p!=null?p:0,d!=null?d:!1),g.wrapU=I.CLAMP_ADDRESSMODE,g.wrapV=I.CLAMP_ADDRESSMODE),g}return r.prototype.update=function(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer)},r.CreateLuminanceTexture=function(e,t,i,a,o,s,u){return o===void 0&&(o=!0),s===void 0&&(s=!1),u===void 0&&(u=3),new r(e,t,i,1,a,o,s,u)},r.CreateLuminanceAlphaTexture=function(e,t,i,a,o,s,u){return o===void 0&&(o=!0),s===void 0&&(s=!1),u===void 0&&(u=3),new r(e,t,i,2,a,o,s,u)},r.CreateAlphaTexture=function(e,t,i,a,o,s,u){return o===void 0&&(o=!0),s===void 0&&(s=!1),u===void 0&&(u=3),new r(e,t,i,0,a,o,s,u)},r.CreateRGBTexture=function(e,t,i,a,o,s,u,l,c,p){return o===void 0&&(o=!0),s===void 0&&(s=!1),u===void 0&&(u=3),l===void 0&&(l=0),c===void 0&&(c=0),p===void 0&&(p=!1),new r(e,t,i,4,a,o,s,u,l,c,p)},r.CreateRGBATexture=function(e,t,i,a,o,s,u,l,c,p){return o===void 0&&(o=!0),s===void 0&&(s=!1),u===void 0&&(u=3),l===void 0&&(l=0),c===void 0&&(c=0),p===void 0&&(p=!1),new r(e,t,i,5,a,o,s,u,l,c,p)},r.CreateRGBAStorageTexture=function(e,t,i,a,o,s,u,l,c){return o===void 0&&(o=!0),s===void 0&&(s=!1),u===void 0&&(u=3),l===void 0&&(l=0),c===void 0&&(c=!1),new r(e,t,i,5,a,o,s,u,l,1,c)},r.CreateRTexture=function(e,t,i,a,o,s,u,l){return o===void 0&&(o=!0),s===void 0&&(s=!1),u===void 0&&(u=I.TRILINEAR_SAMPLINGMODE),l===void 0&&(l=1),new r(e,t,i,6,a,o,s,u,l)},r.CreateRStorageTexture=function(e,t,i,a,o,s,u,l){return o===void 0&&(o=!0),s===void 0&&(s=!1),u===void 0&&(u=I.TRILINEAR_SAMPLINGMODE),l===void 0&&(l=1),new r(e,t,i,6,a,o,s,u,l,1)},r}(I),Je=function(n){A(r,n);function r(e,t,i){i===void 0&&(i=!0);var a=n.call(this,e,t)||this;return a._normalMatrix=new q,a._storeEffectOnSubMeshes=i,a}return r.prototype.getEffect=function(){return this._storeEffectOnSubMeshes?this._activeEffect:n.prototype.getEffect.call(this)},r.prototype.isReady=function(e,t){return e?!this._storeEffectOnSubMeshes||!e.subMeshes||e.subMeshes.length===0?!0:this.isReadyForSubMesh(e,e.subMeshes[0],t):!1},r.prototype._isReadyForSubMesh=function(e){var t=e.materialDefines;return!!(!this.checkReadyOnEveryCall&&e.effect&&t&&t._renderId===this.getScene().getRenderId())},r.prototype.bindOnlyWorldMatrix=function(e){this._activeEffect.setMatrix("world",e)},r.prototype.bindOnlyNormalMatrix=function(e){this._activeEffect.setMatrix("normalMatrix",e)},r.prototype.bind=function(e,t){!t||this.bindForSubMesh(e,t,t.subMeshes[0])},r.prototype._afterBind=function(e,t){t===void 0&&(t=null),n.prototype._afterBind.call(this,e,t),this.getScene()._cachedEffect=t},r.prototype._mustRebind=function(e,t,i){return i===void 0&&(i=1),e.isCachedMaterialInvalid(this,t,i)},r}(xe),f;(function(n){n[n.Float=1]="Float",n[n.Int=2]="Int",n[n.Vector2=4]="Vector2",n[n.Vector3=8]="Vector3",n[n.Vector4=16]="Vector4",n[n.Color3=32]="Color3",n[n.Color4=64]="Color4",n[n.Matrix=128]="Matrix",n[n.Object=256]="Object",n[n.AutoDetect=1024]="AutoDetect",n[n.BasedOnInput=2048]="BasedOnInput"})(f||(f={}));var _;(function(n){n[n.Vertex=1]="Vertex",n[n.Fragment=2]="Fragment",n[n.Neutral=4]="Neutral",n[n.VertexAndFragment=3]="VertexAndFragment"})(_||(_={}));var lr=function(){function n(){this.supportUniformBuffers=!1,this.attributes=new Array,this.uniforms=new Array,this.constants=new Array,this.samplers=new Array,this.functions={},this.extensions={},this.counters={},this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}return n.prototype.finalize=function(r){var e=r.sharedData.emitComments,t=this.target===_.Fragment;this.compilationString=`\r
`.concat(e?`//Entry point\r
`:"",`void main(void) {\r
`).concat(this.compilationString),this._constantDeclaration&&(this.compilationString=`\r
`.concat(e?`//Constants\r
`:"").concat(this._constantDeclaration,`\r
`).concat(this.compilationString));var i="";for(var a in this.functions)i+=this.functions[a]+`\r
`;this.compilationString=`\r
`.concat(i,`\r
`).concat(this.compilationString),!t&&this._varyingTransfer&&(this.compilationString="".concat(this.compilationString,`\r
`).concat(this._varyingTransfer)),this._injectAtEnd&&(this.compilationString="".concat(this.compilationString,`\r
`).concat(this._injectAtEnd)),this.compilationString="".concat(this.compilationString,`\r
}`),this.sharedData.varyingDeclaration&&(this.compilationString=`\r
`.concat(e?`//Varyings\r
`:"").concat(this.sharedData.varyingDeclaration,`\r
`).concat(this.compilationString)),this._samplerDeclaration&&(this.compilationString=`\r
`.concat(e?`//Samplers\r
`:"").concat(this._samplerDeclaration,`\r
`).concat(this.compilationString)),this._uniformDeclaration&&(this.compilationString=`\r
`.concat(e?`//Uniforms\r
`:"").concat(this._uniformDeclaration,`\r
`).concat(this.compilationString)),this._attributeDeclaration&&!t&&(this.compilationString=`\r
`.concat(e?`//Attributes\r
`:"").concat(this._attributeDeclaration,`\r
`).concat(this.compilationString)),this.compilationString=`precision highp float;\r
`+this.compilationString;for(var o in this.extensions){var s=this.extensions[o];this.compilationString=`\r
`.concat(s,`\r
`).concat(this.compilationString)}this._builtCompilationString=this.compilationString},Object.defineProperty(n.prototype,"_repeatableContentAnchor",{get:function(){return"###___ANCHOR".concat(this._repeatableContentAnchorIndex++,"___###")},enumerable:!1,configurable:!0}),n.prototype._getFreeVariableName=function(r){return r=r.replace(/[^a-zA-Z_]+/g,""),this.sharedData.variableNames[r]===void 0?(this.sharedData.variableNames[r]=0,r==="output"||r==="texture"?r+this.sharedData.variableNames[r]:r):(this.sharedData.variableNames[r]++,r+this.sharedData.variableNames[r])},n.prototype._getFreeDefineName=function(r){return this.sharedData.defineNames[r]===void 0?this.sharedData.defineNames[r]=0:this.sharedData.defineNames[r]++,r+this.sharedData.defineNames[r]},n.prototype._excludeVariableName=function(r){this.sharedData.variableNames[r]=0},n.prototype._emit2DSampler=function(r){this.samplers.indexOf(r)<0&&(this._samplerDeclaration+="uniform sampler2D ".concat(r,`;\r
`),this.samplers.push(r))},n.prototype._getGLType=function(r){switch(r){case f.Float:return"float";case f.Int:return"int";case f.Vector2:return"vec2";case f.Color3:case f.Vector3:return"vec3";case f.Color4:case f.Vector4:return"vec4";case f.Matrix:return"mat4"}return""},n.prototype._emitExtension=function(r,e,t){t===void 0&&(t=""),!this.extensions[r]&&(t&&(e="#if ".concat(t,`\r
`).concat(e,`\r
#endif`)),this.extensions[r]=e)},n.prototype._emitFunction=function(r,e,t){this.functions[r]||(this.sharedData.emitComments&&(e=t+`\r
`+e),this.functions[r]=e)},n.prototype._emitCodeFromInclude=function(r,e,t){if(t&&t.repeatKey)return"#include<".concat(r,">[0..").concat(t.repeatKey,`]\r
`);var i=se.IncludesShadersStore[r]+`\r
`;if(this.sharedData.emitComments&&(i=e+`\r
`+i),!t)return i;if(t.replaceStrings)for(var a=0;a<t.replaceStrings.length;a++){var o=t.replaceStrings[a];i=i.replace(o.search,o.replace)}return i},n.prototype._emitFunctionFromInclude=function(r,e,t,i){i===void 0&&(i="");var a=r+i;if(!this.functions[a]){if(!t||!t.removeAttributes&&!t.removeUniforms&&!t.removeVaryings&&!t.removeIfDef&&!t.replaceStrings){t&&t.repeatKey?this.functions[a]="#include<".concat(r,">[0..").concat(t.repeatKey,`]\r
`):this.functions[a]="#include<".concat(r,`>\r
`),this.sharedData.emitComments&&(this.functions[a]=e+`\r
`+this.functions[a]);return}if(this.functions[a]=se.IncludesShadersStore[r],this.sharedData.emitComments&&(this.functions[a]=e+`\r
`+this.functions[a]),t.removeIfDef&&(this.functions[a]=this.functions[a].replace(/^\s*?#ifdef.+$/gm,""),this.functions[a]=this.functions[a].replace(/^\s*?#endif.*$/gm,""),this.functions[a]=this.functions[a].replace(/^\s*?#else.*$/gm,""),this.functions[a]=this.functions[a].replace(/^\s*?#elif.*$/gm,"")),t.removeAttributes&&(this.functions[a]=this.functions[a].replace(/^\s*?attribute.+$/gm,"")),t.removeUniforms&&(this.functions[a]=this.functions[a].replace(/^\s*?uniform.+$/gm,"")),t.removeVaryings&&(this.functions[a]=this.functions[a].replace(/^\s*?varying.+$/gm,"")),t.replaceStrings)for(var o=0;o<t.replaceStrings.length;o++){var s=t.replaceStrings[o];this.functions[a]=this.functions[a].replace(s.search,s.replace)}}},n.prototype._registerTempVariable=function(r){return this.sharedData.temps.indexOf(r)!==-1?!1:(this.sharedData.temps.push(r),!0)},n.prototype._emitVaryingFromString=function(r,e,t,i){return t===void 0&&(t=""),i===void 0&&(i=!1),this.sharedData.varyings.indexOf(r)!==-1?!1:(this.sharedData.varyings.push(r),t&&(t.startsWith("defined(")?this.sharedData.varyingDeclaration+="#if ".concat(t,`\r
`):this.sharedData.varyingDeclaration+="".concat(i?"#ifndef":"#ifdef"," ").concat(t,`\r
`)),this.sharedData.varyingDeclaration+="varying ".concat(e," ").concat(r,`;\r
`),t&&(this.sharedData.varyingDeclaration+=`#endif\r
`),!0)},n.prototype._emitUniformFromString=function(r,e,t,i){t===void 0&&(t=""),i===void 0&&(i=!1),this.uniforms.indexOf(r)===-1&&(this.uniforms.push(r),t&&(t.startsWith("defined(")?this._uniformDeclaration+="#if ".concat(t,`\r
`):this._uniformDeclaration+="".concat(i?"#ifndef":"#ifdef"," ").concat(t,`\r
`)),this._uniformDeclaration+="uniform ".concat(e," ").concat(r,`;\r
`),t&&(this._uniformDeclaration+=`#endif\r
`))},n.prototype._emitFloat=function(r){return r.toString()===r.toFixed(0)?"".concat(r,".0"):r.toString()},n}(),Ci=function(){function n(){this.temps=new Array,this.varyings=new Array,this.varyingDeclaration="",this.inputBlocks=new Array,this.textureBlocks=new Array,this.bindableBlocks=new Array,this.forcedBindableBlocks=new Array,this.blocksWithFallbacks=new Array,this.blocksWithDefines=new Array,this.repeatableContentBlocks=new Array,this.dynamicUniformBlocks=new Array,this.blockingBlocks=new Array,this.animatedInputs=new Array,this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}return n.prototype.emitErrors=function(){var r="";!this.checks.emitVertex&&!this.allowEmptyVertexProgram&&(r+=`NodeMaterial does not have a vertex output. You need to at least add a block that generates a glPosition value.\r
`),this.checks.emitFragment||(r+=`NodeMaterial does not have a fragment output. You need to at least add a block that generates a glFragColor value.\r
`);for(var e=0,t=this.checks.notConnectedNonOptionalInputs;e<t.length;e++){var i=t[e];r+="input ".concat(i.name," from block ").concat(i.ownerBlock.name,"[").concat(i.ownerBlock.getClassName(),`] is not connected and is not optional.\r
`)}if(r)throw`Build of NodeMaterial failed:\r
`+r},n}(),ye;(function(n){n[n.Compatible=0]="Compatible",n[n.TypeIncompatible=1]="TypeIncompatible",n[n.TargetIncompatible=2]="TargetIncompatible",n[n.HierarchyIssue=3]="HierarchyIssue"})(ye||(ye={}));var ee;(function(n){n[n.Input=0]="Input",n[n.Output=1]="Output"})(ee||(ee={}));var wt=function(){function n(r,e,t){this._connectedPoint=null,this._endpoints=new Array,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this._linkedConnectionSource=null,this._acceptedConnectionPointType=null,this._type=f.Float,this._enforceAssociatedVariableName=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=new Array,this.excludedConnectionPointTypes=new Array,this.onConnectionObservable=new J,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=_.VertexAndFragment,this._ownerBlock=e,this.name=r,this._direction=t}return n.AreEquivalentTypes=function(r,e){switch(r){case f.Vector3:{if(e===f.Color3)return!0;break}case f.Vector4:{if(e===f.Color4)return!0;break}case f.Color3:{if(e===f.Vector3)return!0;break}case f.Color4:{if(e===f.Vector4)return!0;break}}return!1},Object.defineProperty(n.prototype,"direction",{get:function(){return this._direction},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"associatedVariableName",{get:function(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.associatedVariableName:this._associatedVariableName},set:function(r){this._associatedVariableName=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"innerType",{get:function(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"type",{get:function(){if(this._type===f.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}if(this._type===f.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type},set:function(r){this._type=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"target",{get:function(){return!this._prioritizeVertex||!this._ownerBlock?this._target:this._target!==_.VertexAndFragment?this._target:this._ownerBlock.target===_.Fragment?_.Fragment:_.Vertex},set:function(r){this._target=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isConnected",{get:function(){return this.connectedPoint!==null||this.hasEndpoints},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isConnectedToInputBlock",{get:function(){return this.connectedPoint!==null&&this.connectedPoint.ownerBlock.isInput},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"connectInputBlock",{get:function(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"connectedPoint",{get:function(){return this._connectedPoint},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"ownerBlock",{get:function(){return this._ownerBlock},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"sourceBlock",{get:function(){return this._connectedPoint?this._connectedPoint.ownerBlock:null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"connectedBlocks",{get:function(){return this._endpoints.length===0?[]:this._endpoints.map(function(r){return r.ownerBlock})},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"endpoints",{get:function(){return this._endpoints},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"hasEndpoints",{get:function(){return this._endpoints&&this._endpoints.length>0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isDirectlyConnectedToVertexOutput",{get:function(){if(!this.hasEndpoints)return!1;for(var r=0,e=this._endpoints;r<e.length;r++){var t=e[r];if(t.ownerBlock.target===_.Vertex||(t.ownerBlock.target===_.Neutral||t.ownerBlock.target===_.VertexAndFragment)&&t.ownerBlock.outputs.some(function(i){return i.isDirectlyConnectedToVertexOutput}))return!0}return!1},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isConnectedInVertexShader",{get:function(){if(this.target===_.Vertex)return!0;if(!this.hasEndpoints)return!1;for(var r=0,e=this._endpoints;r<e.length;r++){var t=e[r];if(t.ownerBlock.target===_.Vertex||t.target===_.Vertex||(t.ownerBlock.target===_.Neutral||t.ownerBlock.target===_.VertexAndFragment)&&t.ownerBlock.outputs.some(function(i){return i.isConnectedInVertexShader}))return!0}return!1},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isConnectedInFragmentShader",{get:function(){if(this.target===_.Fragment)return!0;if(!this.hasEndpoints)return!1;for(var r=0,e=this._endpoints;r<e.length;r++){var t=e[r];if(t.ownerBlock.target===_.Fragment||(t.ownerBlock.target===_.Neutral||t.ownerBlock.target===_.VertexAndFragment)&&t.ownerBlock.outputs.some(function(i){return i.isConnectedInFragmentShader}))return!0}return!1},enumerable:!1,configurable:!0}),n.prototype.createCustomInputBlock=function(){return null},n.prototype.getClassName=function(){return"NodeMaterialConnectionPoint"},n.prototype.canConnectTo=function(r){return this.checkCompatibilityState(r)===ye.Compatible},n.prototype.checkCompatibilityState=function(r){var e=this._ownerBlock,t=r.ownerBlock;if(e.target===_.Fragment){if(t.target===_.Vertex)return ye.TargetIncompatible;for(var i=0,a=t.outputs;i<a.length;i++){var o=a[i];if(o.ownerBlock.target!=_.Neutral&&o.isConnectedInVertexShader)return ye.TargetIncompatible}}if(this.type!==r.type&&r.innerType!==f.AutoDetect)return n.AreEquivalentTypes(this.type,r.type)||r.acceptedConnectionPointTypes&&r.acceptedConnectionPointTypes.indexOf(this.type)!==-1||r._acceptedConnectionPointType&&n.AreEquivalentTypes(r._acceptedConnectionPointType.type,this.type)?ye.Compatible:ye.TypeIncompatible;if(r.excludedConnectionPointTypes&&r.excludedConnectionPointTypes.indexOf(this.type)!==-1)return ye.TypeIncompatible;var s=t,u=e;return this.direction===ee.Input&&(s=e,u=t),s.isAnAncestorOf(u)?ye.HierarchyIssue:ye.Compatible},n.prototype.connectTo=function(r,e){if(e===void 0&&(e=!1),!e&&!this.canConnectTo(r))throw"Cannot connect these two connectors.";return this._endpoints.push(r),r._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(r),r.onConnectionObservable.notifyObservers(this),this},n.prototype.disconnectFrom=function(r){var e=this._endpoints.indexOf(r);return e===-1?this:(this._endpoints.splice(e,1),r._connectedPoint=null,this._enforceAssociatedVariableName=!1,r._enforceAssociatedVariableName=!1,this)},n.prototype.serialize=function(r){r===void 0&&(r=!0);var e={};return e.name=this.name,e.displayName=this.displayName,r&&this.connectedPoint&&(e.inputName=this.name,e.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,e.targetConnectionName=this.connectedPoint.name,e.isExposedOnFrame=!0,e.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(e.isExposedOnFrame=!0,e.exposedPortPosition=this.exposedPortPosition),e},n.prototype.dispose=function(){this.onConnectionObservable.clear()},n}(),F=function(){function n(r,e,t,i){e===void 0&&(e=_.Vertex),t===void 0&&(t=!1),i===void 0&&(i=!1),this._isFinalMerger=!1,this._isInput=!1,this._name="",this._isUnique=!1,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=e,this._originalTargetIsNeutral=e===_.Neutral,this._isFinalMerger=t,this._isInput=i,this._name=r,this.uniqueId=$r.UniqueId}return Object.defineProperty(n.prototype,"name",{get:function(){return this._name},set:function(r){!this.validateBlockName(r)||(this._name=r)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isUnique",{get:function(){return this._isUnique},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isFinalMerger",{get:function(){return this._isFinalMerger},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isInput",{get:function(){return this._isInput},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buildId",{get:function(){return this._buildId},set:function(r){this._buildId=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"target",{get:function(){return this._target},set:function(r){(this._target&r)===0&&(this._target=r)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"inputs",{get:function(){return this._inputs},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"outputs",{get:function(){return this._outputs},enumerable:!1,configurable:!0}),n.prototype.getInputByName=function(r){var e=this._inputs.filter(function(t){return t.name===r});return e.length?e[0]:null},n.prototype.getOutputByName=function(r){var e=this._outputs.filter(function(t){return t.name===r});return e.length?e[0]:null},n.prototype.initialize=function(r){},n.prototype.bind=function(r,e,t,i){},n.prototype._declareOutput=function(r,e){return"".concat(e._getGLType(r.type)," ").concat(r.associatedVariableName)},n.prototype._writeVariable=function(r){var e=r.connectedPoint;return e?"".concat(r.associatedVariableName):"0."},n.prototype._writeFloat=function(r){var e=r.toString();return e.indexOf(".")===-1&&(e+=".0"),"".concat(e)},n.prototype.getClassName=function(){return"NodeMaterialBlock"},n.prototype.registerInput=function(r,e,t,i,a){return t===void 0&&(t=!1),a=a!=null?a:new wt(r,this,ee.Input),a.type=e,a.isOptional=t,i&&(a.target=i),this._inputs.push(a),this},n.prototype.registerOutput=function(r,e,t,i){return i=i!=null?i:new wt(r,this,ee.Output),i.type=e,t&&(i.target=t),this._outputs.push(i),this},n.prototype.getFirstAvailableInput=function(r){r===void 0&&(r=null);for(var e=0,t=this._inputs;e<t.length;e++){var i=t[e];if(!i.connectedPoint&&(!r||r.type===i.type||i.type===f.AutoDetect))return i}return null},n.prototype.getFirstAvailableOutput=function(r){r===void 0&&(r=null);for(var e=0,t=this._outputs;e<t.length;e++){var i=t[e];if(!r||!r.target||r.target===_.Neutral||(r.target&i.target)!==0)return i}return null},n.prototype.getSiblingOutput=function(r){var e=this._outputs.indexOf(r);return e===-1||e>=this._outputs.length?null:this._outputs[e+1]},n.prototype.isAnAncestorOf=function(r){for(var e=0,t=this._outputs;e<t.length;e++){var i=t[e];if(!!i.hasEndpoints)for(var a=0,o=i.endpoints;a<o.length;a++){var s=o[a];if(s.ownerBlock===r||s.ownerBlock.isAnAncestorOf(r))return!0}}return!1},n.prototype.connectTo=function(r,e){if(this._outputs.length!==0){for(var t=e&&e.output?this.getOutputByName(e.output):this.getFirstAvailableOutput(r),i=!0;i;){var a=e&&e.input?r.getInputByName(e.input):r.getFirstAvailableInput(t);if(t&&a&&t.canConnectTo(a))t.connectTo(a),i=!1;else if(t)t=this.getSiblingOutput(t);else throw"Unable to find a compatible match"}return this}},n.prototype._buildBlock=function(r){},n.prototype.updateUniformsAndSamples=function(r,e,t,i){},n.prototype.provideFallbacks=function(r,e){},n.prototype.initializeDefines=function(r,e,t,i){},n.prototype.prepareDefines=function(r,e,t,i,a){},n.prototype.autoConfigure=function(r){},n.prototype.replaceRepeatableContent=function(r,e,t,i){},Object.defineProperty(n.prototype,"willBeGeneratedIntoVertexShaderFromFragmentShader",{get:function(){return this.isInput||this.isFinalMerger||this._outputs.some(function(r){return r.isDirectlyConnectedToVertexOutput})||this.target===_.Vertex?!1:!!((this.target===_.VertexAndFragment||this.target===_.Neutral)&&this._outputs.some(function(r){return r.isConnectedInVertexShader}))},enumerable:!1,configurable:!0}),n.prototype.isReady=function(r,e,t,i){return!0},n.prototype._linkConnectionTypes=function(r,e,t){t===void 0&&(t=!1),t?this._inputs[e]._acceptedConnectionPointType=this._inputs[r]:this._inputs[r]._linkedConnectionSource=this._inputs[e],this._inputs[e]._linkedConnectionSource=this._inputs[r]},n.prototype._processBuild=function(r,e,t,i){r.build(e,i);var a=e._vertexState!=null,o=r._buildTarget===_.Vertex&&r.target!==_.VertexAndFragment;if(a&&((r.target&r._buildTarget)===0||(r.target&t.target)===0||this.target!==_.VertexAndFragment&&o)&&(!r.isInput&&e.target!==r._buildTarget||r.isInput&&r.isAttribute&&!r._noContextSwitch)){var s=t.connectedPoint;e._vertexState._emitVaryingFromString("v_"+s.associatedVariableName,e._getGLType(s.type))&&(e._vertexState.compilationString+="".concat("v_"+s.associatedVariableName," = ").concat(s.associatedVariableName,`;\r
`)),t.associatedVariableName="v_"+s.associatedVariableName,t._enforceAssociatedVariableName=!0}},n.prototype.validateBlockName=function(r){for(var e=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"],t=0,i=e;t<i.length;t++){var a=i[t];if(r===a)return!1}return!0},n.prototype.build=function(r,e){if(this._buildId===r.sharedData.buildId)return!0;if(!this.isInput)for(var t=0,i=this._outputs;t<i.length;t++){var a=i[t];a.associatedVariableName||(a.associatedVariableName=r._getFreeVariableName(a.name))}for(var o=0,s=this._inputs;o<s.length;o++){var u=s[o];if(!u.connectedPoint){u.isOptional||r.sharedData.checks.notConnectedNonOptionalInputs.push(u);continue}if(!(this.target!==_.Neutral&&((u.target&this.target)===0||(u.target&r.target)===0))){var l=u.connectedPoint.ownerBlock;l&&l!==this&&this._processBuild(l,r,u,e)}}if(this._buildId===r.sharedData.buildId)return!0;if(r.sharedData.verbose&&console.log("".concat(r.target===_.Vertex?"Vertex shader":"Fragment shader",": Building ").concat(this.name," [").concat(this.getClassName(),"]")),this.isFinalMerger)switch(r.target){case _.Vertex:r.sharedData.checks.emitVertex=!0;break;case _.Fragment:r.sharedData.checks.emitFragment=!0;break}!this.isInput&&r.sharedData.emitComments&&(r.compilationString+=`\r
//`.concat(this.name,`\r
`)),this._buildBlock(r),this._buildId=r.sharedData.buildId,this._buildTarget=r.target;for(var c=0,p=this._outputs;c<p.length;c++){var a=p[c];if((a.target&r.target)!==0)for(var d=0,g=a.endpoints;d<g.length;d++){var m=g[d],l=m.ownerBlock;l&&(l.target&r.target)!==0&&e.indexOf(l)!==-1&&this._processBuild(l,r,m,e)}}return!1},n.prototype._inputRename=function(r){return r},n.prototype._outputRename=function(r){return r},n.prototype._dumpPropertiesCode=function(){var r=this._codeVariableName;return"".concat(r,".visibleInInspector = ").concat(this.visibleInInspector,`;\r
`).concat(r,".visibleOnFrame = ").concat(this.visibleOnFrame,`;\r
`).concat(r,".target = ").concat(this.target,`;\r
`)},n.prototype._dumpCode=function(r,e){e.push(this);var t,i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||"".concat(this.getClassName(),"_").concat(this.uniqueId),r.indexOf(this._codeVariableName)!==-1){var a=0;do a++,this._codeVariableName=i+a;while(r.indexOf(this._codeVariableName)!==-1)}r.push(this._codeVariableName),t=`\r
// `.concat(this.getClassName(),`\r
`),this.comments&&(t+="// ".concat(this.comments,`\r
`)),t+="var ".concat(this._codeVariableName," = new BABYLON.").concat(this.getClassName(),'("').concat(this.name,`");\r
`),t+=this._dumpPropertiesCode();for(var o=0,s=this.inputs;o<s.length;o++){var u=s[o];if(!!u.isConnected){var l=u.connectedPoint,c=l.ownerBlock;e.indexOf(c)===-1&&(t+=c._dumpCode(r,e))}}for(var p=0,d=this.outputs;p<d.length;p++){var g=d[p];if(!!g.hasEndpoints)for(var m=0,y=g.endpoints;m<y.length;m++){var v=y[m],c=v.ownerBlock;c&&e.indexOf(c)===-1&&(t+=c._dumpCode(r,e))}}return t},n.prototype._dumpCodeForOutputConnections=function(r){var e="";if(r.indexOf(this)!==-1)return e;r.push(this);for(var t=0,i=this.inputs;t<i.length;t++){var a=i[t];if(!!a.isConnected){var o=a.connectedPoint,s=o.ownerBlock;e+=s._dumpCodeForOutputConnections(r),e+="".concat(s._codeVariableName,".").concat(s._outputRename(o.name),".connectTo(").concat(this._codeVariableName,".").concat(this._inputRename(a.name),`);\r
`)}}return e},n.prototype.clone=function(r,e){e===void 0&&(e="");var t=this.serialize(),i=Qe(t.customType);if(i){var a=new i;return a._deserialize(t,r,e),a}return null},n.prototype.serialize=function(){var r={};r.customType="BABYLON."+this.getClassName(),r.id=this.uniqueId,r.name=this.name,r.comments=this.comments,r.visibleInInspector=this.visibleInInspector,r.visibleOnFrame=this.visibleOnFrame,r.target=this.target,r.inputs=[],r.outputs=[];for(var e=0,t=this.inputs;e<t.length;e++){var i=t[e];r.inputs.push(i.serialize())}for(var a=0,o=this.outputs;a<o.length;a++){var s=o[a];r.outputs.push(s.serialize(!1))}return r},n.prototype._deserialize=function(r,e,t){var i;this.name=r.name,this.comments=r.comments,this.visibleInInspector=!!r.visibleInInspector,this.visibleOnFrame=!!r.visibleOnFrame,this._target=(i=r.target)!==null&&i!==void 0?i:this.target,this._deserializePortDisplayNamesAndExposedOnFrame(r)},n.prototype._deserializePortDisplayNamesAndExposedOnFrame=function(r){var e=this,t=r.inputs,i=r.outputs;t&&t.forEach(function(a,o){a.displayName&&(e.inputs[o].displayName=a.displayName),a.isExposedOnFrame&&(e.inputs[o].isExposedOnFrame=a.isExposedOnFrame,e.inputs[o].exposedPortPosition=a.exposedPortPosition)}),i&&i.forEach(function(a,o){a.displayName&&(e.outputs[o].displayName=a.displayName),a.isExposedOnFrame&&(e.outputs[o].isExposedOnFrame=a.isExposedOnFrame,e.outputs[o].exposedPortPosition=a.exposedPortPosition)})},n.prototype.dispose=function(){for(var r=0,e=this.inputs;r<e.length;r++){var t=e[r];t.dispose()}for(var i=0,a=this.outputs;i<a.length;i++){var o=a[i];o.dispose()}},n}(),kt=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.complementW=1,t.complementZ=0,t.target=_.Vertex,t.registerInput("vector",f.AutoDetect),t.registerInput("transform",f.Matrix),t.registerOutput("output",f.Vector4),t.registerOutput("xyz",f.Vector3),t._inputs[0].onConnectionObservable.add(function(i){if(i.ownerBlock.isInput){var a=i.ownerBlock;(a.name==="normal"||a.name==="tangent")&&(t.complementW=0)}}),t}return r.prototype.getClassName=function(){return"TransformBlock"},Object.defineProperty(r.prototype,"vector",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"xyz",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"transform",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this.vector,i=this.transform;if(t.connectedPoint){if(this.complementW===0){var a="//".concat(this.name);e._emitFunctionFromInclude("helperFunctions",a),e.sharedData.blocksWithDefines.push(this);var o=e._getFreeVariableName("".concat(i.associatedVariableName,"_NUS"));switch(e.compilationString+="mat3 ".concat(o," = mat3(").concat(i.associatedVariableName,`);\r
`),e.compilationString+=`#ifdef NONUNIFORMSCALING\r
`,e.compilationString+="".concat(o," = transposeMat3(inverseMat3(").concat(o,`));\r
`),e.compilationString+=`#endif\r
`,t.connectedPoint.type){case f.Vector2:e.compilationString+=this._declareOutput(this.output,e)+" = vec4(".concat(o," * vec3(").concat(t.associatedVariableName,", ").concat(this._writeFloat(this.complementZ),"), ").concat(this._writeFloat(this.complementW),`);\r
`);break;case f.Vector3:case f.Color3:e.compilationString+=this._declareOutput(this.output,e)+" = vec4(".concat(o," * ").concat(t.associatedVariableName,", ").concat(this._writeFloat(this.complementW),`);\r
`);break;default:e.compilationString+=this._declareOutput(this.output,e)+" = vec4(".concat(o," * ").concat(t.associatedVariableName,".xyz, ").concat(this._writeFloat(this.complementW),`);\r
`);break}}else{var o=i.associatedVariableName;switch(t.connectedPoint.type){case f.Vector2:e.compilationString+=this._declareOutput(this.output,e)+" = ".concat(o," * vec4(").concat(t.associatedVariableName,", ").concat(this._writeFloat(this.complementZ),", ").concat(this._writeFloat(this.complementW),`);\r
`);break;case f.Vector3:case f.Color3:e.compilationString+=this._declareOutput(this.output,e)+" = ".concat(o," * vec4(").concat(t.associatedVariableName,", ").concat(this._writeFloat(this.complementW),`);\r
`);break;default:e.compilationString+=this._declareOutput(this.output,e)+" = ".concat(o," * ").concat(t.associatedVariableName,`;\r
`);break}}this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+" = ".concat(this.output.associatedVariableName,`.xyz;\r
`))}return this},r.prototype.prepareDefines=function(e,t,i){e.nonUniformScaling&&i.setValue("NONUNIFORMSCALING",!0)},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.complementZ=this.complementZ,e.complementW=this.complementW,e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),this.complementZ=e.complementZ!==void 0?e.complementZ:0,this.complementW=e.complementW!==void 0?e.complementW:1},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this)+"".concat(this._codeVariableName,".complementZ = ").concat(this.complementZ,`;\r
`);return e+="".concat(this._codeVariableName,".complementW = ").concat(this.complementW,`;\r
`),e},r}(F);P("BABYLON.TransformBlock",kt);var ot=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Vertex,!0)||this;return t.registerInput("vector",f.Vector4),t}return r.prototype.getClassName=function(){return"VertexOutputBlock"},Object.defineProperty(r.prototype,"vector",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),r.prototype._isLogarithmicDepthEnabled=function(e){for(var t=0,i=e;t<i.length;t++){var a=i[t];if(a.useLogarithmicDepth)return!0}return!1},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this.vector;return e.compilationString+="gl_Position = ".concat(t.associatedVariableName,`;\r
`),this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes)&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.compilationString+=`vFragmentDepth = 1.0 + gl_Position.w;\r
`,e.compilationString+=`gl_Position.z = log2(max(0.000001, vFragmentDepth)) * logarithmicDepthConstant;\r
`),this},r}(F);P("BABYLON.VertexOutputBlock",ot);var z;(function(n){n[n.Boolean=0]="Boolean",n[n.Float=1]="Float",n[n.Int=2]="Int",n[n.Vector2=3]="Vector2",n[n.List=4]="List"})(z||(z={}));function H(n,r,e,t){return r===void 0&&(r=z.Boolean),e===void 0&&(e="PROPERTIES"),function(i,a){var o=i._propStore;o||(o=[],i._propStore=o),o.push({propertyName:a,displayName:n,type:r,groupName:e,options:t!=null?t:{}})}}var Xe=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment,!0)||this;return t.convertToGammaSpace=!1,t.convertToLinearSpace=!1,t.useLogarithmicDepth=!1,t.registerInput("rgba",f.Color4,!0),t.registerInput("rgb",f.Color3,!0),t.registerInput("a",f.Float,!0),t.rgb.acceptedConnectionPointTypes.push(f.Float),t}return r.prototype.getClassName=function(){return"FragmentOutputBlock"},r.prototype.initialize=function(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")},Object.defineProperty(r.prototype,"rgba",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rgb",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"a",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),r.prototype.prepareDefines=function(e,t,i){i.setValue(this._linearDefineName,this.convertToLinearSpace,!0),i.setValue(this._gammaDefineName,this.convertToGammaSpace,!0)},r.prototype.bind=function(e,t,i){this.useLogarithmicDepth&&i&&C.BindLogDepth(void 0,e,i.getScene())},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this.rgba,i=this.rgb,a=this.a;e.sharedData.hints.needAlphaBlending=t.isConnected||a.isConnected,e.sharedData.blocksWithDefines.push(this),this.useLogarithmicDepth&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.sharedData.bindableBlocks.push(this)),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");var o="//".concat(this.name);if(e._emitFunctionFromInclude("helperFunctions",o),t.connectedPoint)a.isConnected?e.compilationString+="gl_FragColor = vec4(".concat(t.associatedVariableName,".rgb, ").concat(a.associatedVariableName,`);\r
`):e.compilationString+="gl_FragColor = ".concat(t.associatedVariableName,`;\r
`);else if(i.connectedPoint){var s="1.0";a.connectedPoint&&(s=a.associatedVariableName),i.connectedPoint.type===f.Float?e.compilationString+="gl_FragColor = vec4(".concat(i.associatedVariableName,", ").concat(i.associatedVariableName,", ").concat(i.associatedVariableName,", ").concat(s,`);\r
`):e.compilationString+="gl_FragColor = vec4(".concat(i.associatedVariableName,", ").concat(s,`);\r
`)}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);return e.compilationString+="#ifdef ".concat(this._linearDefineName,`\r
`),e.compilationString+=`gl_FragColor = toLinearSpace(gl_FragColor);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+="#ifdef ".concat(this._gammaDefineName,`\r
`),e.compilationString+=`gl_FragColor = toGammaSpace(gl_FragColor);\r
`,e.compilationString+=`#endif\r
`,this.useLogarithmicDepth&&(e.compilationString+=`gl_FragDepthEXT = log2(vFragmentDepth) * logarithmicDepthConstant * 0.5;\r
`),this},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,".convertToGammaSpace = ").concat(this.convertToGammaSpace,`;\r
`),e+="".concat(this._codeVariableName,".convertToLinearSpace = ").concat(this.convertToLinearSpace,`;\r
`),e+="".concat(this._codeVariableName,".useLogarithmicDepth = ").concat(this.useLogarithmicDepth,`;\r
`),e},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e},r.prototype._deserialize=function(e,t,i){var a;n.prototype._deserialize.call(this,e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=e.convertToLinearSpace,this.useLogarithmicDepth=(a=e.useLogarithmicDepth)!==null&&a!==void 0?a:!1},h([H("Convert to gamma space",z.Boolean,"PROPERTIES",{notifiers:{update:!0}})],r.prototype,"convertToGammaSpace",void 0),h([H("Convert to linear space",z.Boolean,"PROPERTIES",{notifiers:{update:!0}})],r.prototype,"convertToLinearSpace",void 0),h([H("Use logarithmic depth",z.Boolean,"PROPERTIES")],r.prototype,"useLogarithmicDepth",void 0),r}(F);P("BABYLON.FragmentOutputBlock",Xe);var fe;(function(n){n[n.Uniform=0]="Uniform",n[n.Attribute=1]="Attribute",n[n.Varying=2]="Varying",n[n.Undefined=3]="Undefined"})(fe||(fe={}));var V;(function(n){n[n.World=1]="World",n[n.View=2]="View",n[n.Projection=3]="Projection",n[n.ViewProjection=4]="ViewProjection",n[n.WorldView=5]="WorldView",n[n.WorldViewProjection=6]="WorldViewProjection",n[n.CameraPosition=7]="CameraPosition",n[n.FogColor=8]="FogColor",n[n.DeltaTime=9]="DeltaTime",n[n.CameraParameters=10]="CameraParameters",n[n.MaterialAlpha=11]="MaterialAlpha"})(V||(V={}));var Be;(function(n){n[n.None=0]="None",n[n.Time=1]="Time"})(Be||(Be={}));var xi={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},It={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},cr={particle_texturemask:!0},B=function(n){A(r,n);function r(e,t,i){t===void 0&&(t=_.Vertex),i===void 0&&(i=f.AutoDetect);var a=n.call(this,e,t,!1,!0)||this;return a._mode=fe.Undefined,a._animationType=Be.None,a.min=0,a.max=0,a.isBoolean=!1,a.matrixMode=0,a._systemValue=null,a.isConstant=!1,a.groupInInspector="",a.onValueChangedObservable=new J,a.convertToGammaSpace=!1,a.convertToLinearSpace=!1,a._type=i,a.setDefaultValue(),a.registerOutput("output",i),a}return Object.defineProperty(r.prototype,"type",{get:function(){if(this._type===f.AutoDetect){if(this.isUniform&&this.value!=null){if(!isNaN(this.value))return this._type=f.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=f.Vector2,this._type;case"Vector3":return this._type=f.Vector3,this._type;case"Vector4":return this._type=f.Vector4,this._type;case"Color3":return this._type=f.Color3,this._type;case"Color4":return this._type=f.Color4,this._type;case"Matrix":return this._type=f.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"position":case"normal":case"particle_positionw":return this._type=f.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":return this._type=f.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=f.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":return this._type=f.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case V.World:case V.WorldView:case V.WorldViewProjection:case V.View:case V.ViewProjection:case V.Projection:return this._type=f.Matrix,this._type;case V.CameraPosition:return this._type=f.Vector3,this._type;case V.FogColor:return this._type=f.Color3,this._type;case V.DeltaTime:case V.MaterialAlpha:return this._type=f.Float,this._type;case V.CameraParameters:return this._type=f.Vector4,this._type}}return this._type},enumerable:!1,configurable:!0}),r.prototype.validateBlockName=function(e){return this.isAttribute?!0:n.prototype.validateBlockName.call(this,e)},Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype.setAsAttribute=function(e){return this._mode=fe.Attribute,e&&(this.name=e),this},r.prototype.setAsSystemValue=function(e){return this.systemValue=e,this},Object.defineProperty(r.prototype,"value",{get:function(){return this._storedValue},set:function(e){this.type===f.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=fe.Uniform,this.onValueChangedObservable.notifyObservers(this)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"valueCallback",{get:function(){return this._valueCallback},set:function(e){this._valueCallback=e,this._mode=fe.Uniform},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"associatedVariableName",{get:function(){return this._associatedVariableName},set:function(e){this._associatedVariableName=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"animationType",{get:function(){return this._animationType},set:function(e){this._animationType=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isUndefined",{get:function(){return this._mode===fe.Undefined},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isUniform",{get:function(){return this._mode===fe.Uniform},set:function(e){this._mode=e?fe.Uniform:fe.Undefined,this.associatedVariableName=""},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isAttribute",{get:function(){return this._mode===fe.Attribute},set:function(e){this._mode=e?fe.Attribute:fe.Undefined,this.associatedVariableName=""},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isVarying",{get:function(){return this._mode===fe.Varying},set:function(e){this._mode=e?fe.Varying:fe.Undefined,this.associatedVariableName=""},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isSystemValue",{get:function(){return this._systemValue!=null},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"systemValue",{get:function(){return this._systemValue},set:function(e){this._mode=fe.Uniform,this.associatedVariableName="",this._systemValue=e},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"InputBlock"},r.prototype.animate=function(e){switch(this._animationType){case Be.Time:{this.type===f.Float&&(this.value+=e.getAnimationRatio()*.01);break}}},r.prototype._emitDefine=function(e){return e[0]==="!"?"#ifndef ".concat(e.substring(1),`\r
`):"#ifdef ".concat(e,`\r
`)},r.prototype.initialize=function(){this.associatedVariableName=""},r.prototype.setDefaultValue=function(){switch(this.type){case f.Float:this.value=0;break;case f.Vector2:this.value=Te.Zero();break;case f.Vector3:this.value=K.Zero();break;case f.Vector4:this.value=Me.Zero();break;case f.Color3:this.value=G.White();break;case f.Color4:this.value=new ve(1,1,1,1);break;case f.Matrix:this.value=q.Identity();break}},r.prototype._emitConstant=function(e){switch(this.type){case f.Float:return"".concat(e._emitFloat(this.value));case f.Vector2:return"vec2(".concat(this.value.x,", ").concat(this.value.y,")");case f.Vector3:return"vec3(".concat(this.value.x,", ").concat(this.value.y,", ").concat(this.value.z,")");case f.Vector4:return"vec4(".concat(this.value.x,", ").concat(this.value.y,", ").concat(this.value.z,", ").concat(this.value.w,")");case f.Color3:return X.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&X.Color3[0].toGammaSpaceToRef(X.Color3[0]),this.convertToLinearSpace&&X.Color3[0].toLinearSpaceToRef(X.Color3[0]),"vec3(".concat(X.Color3[0].r,", ").concat(X.Color3[0].g,", ").concat(X.Color3[0].b,")");case f.Color4:return X.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&X.Color4[0].toGammaSpaceToRef(X.Color4[0]),this.convertToLinearSpace&&X.Color4[0].toLinearSpaceToRef(X.Color4[0]),"vec4(".concat(X.Color4[0].r,", ").concat(X.Color4[0].g,", ").concat(X.Color4[0].b,", ").concat(X.Color4[0].a,")")}return""},Object.defineProperty(r.prototype,"_noContextSwitch",{get:function(){return It[this.name]},enumerable:!1,configurable:!0}),r.prototype._emit=function(e,t){var i;if(this.isUniform){if(this.associatedVariableName||(this.associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(e.constants.indexOf(this.associatedVariableName)!==-1)return;e.constants.push(this.associatedVariableName),e._constantDeclaration+=this._declareOutput(this.output,e)+" = ".concat(this._emitConstant(e),`;\r
`);return}if(e.uniforms.indexOf(this.associatedVariableName)!==-1)return;e.uniforms.push(this.associatedVariableName),t&&(e._uniformDeclaration+=this._emitDefine(t)),e._uniformDeclaration+="uniform ".concat(e._getGLType(this.type)," ").concat(this.associatedVariableName,`;\r
`),t&&(e._uniformDeclaration+=`#endif\r
`);var a=e.sharedData.hints;if(this._systemValue!==null&&this._systemValue!==void 0)switch(this._systemValue){case V.WorldView:a.needWorldViewMatrix=!0;break;case V.WorldViewProjection:a.needWorldViewProjectionMatrix=!0;break}else this._animationType!==Be.None&&e.sharedData.animatedInputs.push(this);return}if(this.isAttribute){if(this.associatedVariableName=(i=xi[this.name])!==null&&i!==void 0?i:this.name,this.target===_.Vertex&&e._vertexState){It[this.name]?cr[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):this._emit(e._vertexState,t);return}if(e.attributes.indexOf(this.associatedVariableName)!==-1)return;e.attributes.push(this.associatedVariableName),It[this.name]?cr[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):(t&&(e._attributeDeclaration+=this._emitDefine(t)),e._attributeDeclaration+="attribute ".concat(e._getGLType(this.type)," ").concat(this.associatedVariableName,`;\r
`),t&&(e._attributeDeclaration+=`#endif\r
`))}},r.prototype._transmitWorld=function(e,t,i,a){if(!!this._systemValue){var o=this.associatedVariableName;switch(this._systemValue){case V.World:e.setMatrix(o,t);break;case V.WorldView:e.setMatrix(o,i);break;case V.WorldViewProjection:e.setMatrix(o,a);break}}},r.prototype._transmit=function(e,t,i){if(!this.isAttribute){var a=this.associatedVariableName;if(this._systemValue){switch(this._systemValue){case V.World:case V.WorldView:case V.WorldViewProjection:return;case V.View:e.setMatrix(a,t.getViewMatrix());break;case V.Projection:e.setMatrix(a,t.getProjectionMatrix());break;case V.ViewProjection:e.setMatrix(a,t.getTransformMatrix());break;case V.CameraPosition:t.bindEyePosition(e,a,!0);break;case V.FogColor:e.setColor3(a,t.fogColor);break;case V.DeltaTime:e.setFloat(a,t.deltaTime/1e3);break;case V.CameraParameters:t.activeCamera&&e.setFloat4(a,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case V.MaterialAlpha:e.setFloat(a,i.alpha);break}return}var o=this._valueCallback?this._valueCallback():this._storedValue;if(o!==null)switch(this.type){case f.Float:e.setFloat(a,o);break;case f.Int:e.setInt(a,o);break;case f.Color3:X.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&X.Color3[0].toGammaSpaceToRef(X.Color3[0]),this.convertToLinearSpace&&X.Color3[0].toLinearSpaceToRef(X.Color3[0]),e.setColor3(a,X.Color3[0]);break;case f.Color4:X.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&X.Color4[0].toGammaSpaceToRef(X.Color4[0]),this.convertToLinearSpace&&X.Color4[0].toLinearSpaceToRef(X.Color4[0]),e.setDirectColor4(a,X.Color4[0]);break;case f.Vector2:e.setVector2(a,o);break;case f.Vector3:e.setVector3(a,o);break;case f.Vector4:e.setVector4(a,o);break;case f.Matrix:e.setMatrix(a,o);break}}},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)},r.prototype._dumpPropertiesCode=function(){var e=this._codeVariableName;if(this.isAttribute)return n.prototype._dumpPropertiesCode.call(this)+"".concat(e,'.setAsAttribute("').concat(this.name,`");\r
`);if(this.isSystemValue)return n.prototype._dumpPropertiesCode.call(this)+"".concat(e,".setAsSystemValue(BABYLON.NodeMaterialSystemValues.").concat(V[this._systemValue],`);\r
`);if(this.isUniform){var t=[],i="";switch(this.type){case f.Float:i="".concat(this.value);break;case f.Vector2:i="new BABYLON.Vector2(".concat(this.value.x,", ").concat(this.value.y,")");break;case f.Vector3:i="new BABYLON.Vector3(".concat(this.value.x,", ").concat(this.value.y,", ").concat(this.value.z,")");break;case f.Vector4:i="new BABYLON.Vector4(".concat(this.value.x,", ").concat(this.value.y,", ").concat(this.value.z,", ").concat(this.value.w,")");break;case f.Color3:i="new BABYLON.Color3(".concat(this.value.r,", ").concat(this.value.g,", ").concat(this.value.b,")"),this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case f.Color4:i="new BABYLON.Color4(".concat(this.value.r,", ").concat(this.value.g,", ").concat(this.value.b,", ").concat(this.value.a,")"),this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case f.Matrix:i="BABYLON.Matrix.FromArray([".concat(this.value.m,"])");break}return t.push("".concat(e,".value = ").concat(i)),this.type===f.Float&&t.push("".concat(e,".min = ").concat(this.min),"".concat(e,".max = ").concat(this.max),"".concat(e,".isBoolean = ").concat(this.isBoolean),"".concat(e,".matrixMode = ").concat(this.matrixMode),"".concat(e,".animationType = BABYLON.AnimatedInputBlockTypes.").concat(Be[this.animationType])),t.push("".concat(e,".isConstant = ").concat(this.isConstant)),t.push(""),n.prototype._dumpPropertiesCode.call(this)+t.join(`;\r
`)}return n.prototype._dumpPropertiesCode.call(this)},r.prototype.dispose=function(){this.onValueChangedObservable.clear(),n.prototype.dispose.call(this)},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this._storedValue!=null&&this._mode===fe.Uniform&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e},r.prototype._deserialize=function(e,t,i){if(this._mode=e.mode,n.prototype._deserialize.call(this,e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.name==="tangent"&&e.mode===fe.Attribute&&e.type===f.Vector3&&(this._type=f.Vector4),!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{var a=Qe(e.valueType);a&&(this._storedValue=a.FromArray(e.value))}},r}(F);P("BABYLON.InputBlock",B);var gr=function(n){A(r,n);function r(e){var t=n.call(this,e,_.VertexAndFragment)||this;return t._samplerName="textureSampler",t.convertToGammaSpace=!1,t.convertToLinearSpace=!1,t._isUnique=!1,t.registerInput("uv",f.Vector2,!1,_.VertexAndFragment),t.registerOutput("rgba",f.Color4,_.Neutral),t.registerOutput("rgb",f.Color3,_.Neutral),t.registerOutput("r",f.Float,_.Neutral),t.registerOutput("g",f.Float,_.Neutral),t.registerOutput("b",f.Float,_.Neutral),t.registerOutput("a",f.Float,_.Neutral),t._inputs[0].acceptedConnectionPointTypes.push(f.Vector3),t._inputs[0].acceptedConnectionPointTypes.push(f.Vector4),t._inputs[0]._prioritizeVertex=!1,t}return r.prototype.getClassName=function(){return"CurrentScreenBlock"},Object.defineProperty(r.prototype,"uv",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rgba",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rgb",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"r",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"g",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"b",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"a",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),r.prototype.initialize=function(e){e._excludeVariableName("textureSampler")},Object.defineProperty(r.prototype,"target",{get:function(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?_.VertexAndFragment:_.Fragment},enumerable:!1,configurable:!0}),r.prototype.prepareDefines=function(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)},r.prototype.isReady=function(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())},r.prototype._injectVertexCode=function(e){var t=this.uv;if(t.connectedPoint.ownerBlock.isInput){var i=t.connectedPoint.ownerBlock;i.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec2")}if(this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+="".concat(this._mainUVName," = ").concat(t.associatedVariableName,`.xy;\r
`),!!this._outputs.some(function(u){return u.isConnectedInVertexShader})){this._writeTextureRead(e,!0);for(var a=0,o=this._outputs;a<o.length;a++){var s=o[a];s.hasEndpoints&&this._writeOutput(e,s,s.name,!0)}}},r.prototype._writeTextureRead=function(e,t){t===void 0&&(t=!1);var i=this.uv;if(t){if(e.target===_.Fragment)return;e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(this._samplerName,", ").concat(i.associatedVariableName,`);\r
`);return}if(this.uv.ownerBlock.target===_.Fragment){e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(this._samplerName,", ").concat(i.associatedVariableName,`);\r
`);return}e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(this._samplerName,", ").concat(this._mainUVName,`);\r
`)},r.prototype._writeOutput=function(e,t,i,a){if(a===void 0&&(a=!1),a){if(e.target===_.Fragment)return;e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`);return}if(this.uv.ownerBlock.target===_.Fragment){e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`);return}e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`),e.compilationString+="#ifdef ".concat(this._linearDefineName,`\r
`),e.compilationString+="".concat(t.associatedVariableName," = toGammaSpace(").concat(t.associatedVariableName,`);\r
`),e.compilationString+=`#endif\r
`,e.compilationString+="#ifdef ".concat(this._gammaDefineName,`\r
`),e.compilationString+="".concat(t.associatedVariableName," = toLinearSpace(").concat(t.associatedVariableName,`);\r
`),e.compilationString+=`#endif\r
`},r.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==_.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(!!this._outputs.some(function(s){return s.isConnectedInFragmentShader})){e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");var t="//".concat(this.name);e._emitFunctionFromInclude("helperFunctions",t),this._writeTextureRead(e);for(var i=0,a=this._outputs;i<a.length;i++){var o=a[i];o.hasEndpoints&&this._writeOutput(e,o,o.name)}return this}},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=I.Parse(e.texture,t,i))},r}(F);P("BABYLON.CurrentScreenBlock",gr);var vr=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t._samplerName="diffuseSampler",t.convertToGammaSpace=!1,t.convertToLinearSpace=!1,t._isUnique=!1,t.registerInput("uv",f.Vector2,!1,_.VertexAndFragment),t.registerOutput("rgba",f.Color4,_.Neutral),t.registerOutput("rgb",f.Color3,_.Neutral),t.registerOutput("r",f.Float,_.Neutral),t.registerOutput("g",f.Float,_.Neutral),t.registerOutput("b",f.Float,_.Neutral),t.registerOutput("a",f.Float,_.Neutral),t._inputs[0].acceptedConnectionPointTypes.push(f.Vector3),t._inputs[0].acceptedConnectionPointTypes.push(f.Vector4),t}return r.prototype.getClassName=function(){return"ParticleTextureBlock"},Object.defineProperty(r.prototype,"uv",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rgba",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rgb",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"r",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"g",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"b",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"a",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),r.prototype.initialize=function(e){e._excludeVariableName("diffuseSampler")},r.prototype.autoConfigure=function(e){if(!this.uv.isConnected){var t=e.getInputBlockByPredicate(function(i){return i.isAttribute&&i.name==="particle_uv"});t||(t=new B("uv"),t.setAsAttribute("particle_uv")),t.output.connectTo(this.uv)}},r.prototype.prepareDefines=function(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)},r.prototype.isReady=function(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())},r.prototype._writeOutput=function(e,t,i){e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`),e.compilationString+="#ifdef ".concat(this._linearDefineName,`\r
`),e.compilationString+="".concat(t.associatedVariableName," = toGammaSpace(").concat(t.associatedVariableName,`);\r
`),e.compilationString+=`#endif\r
`,e.compilationString+="#ifdef ".concat(this._gammaDefineName,`\r
`),e.compilationString+="".concat(t.associatedVariableName," = toLinearSpace(").concat(t.associatedVariableName,`);\r
`),e.compilationString+=`#endif\r
`},r.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target!==_.Vertex){this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");var t="//".concat(this.name);e._emitFunctionFromInclude("helperFunctions",t),e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(this._samplerName,", ").concat(this.uv.associatedVariableName,`);\r
`);for(var i=0,a=this._outputs;i<a.length;i++){var o=a[i];o.hasEndpoints&&this._writeOutput(e,o,o.name)}return this}},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=I.Parse(e.texture,t,i))},r}(F);P("BABYLON.ParticleTextureBlock",vr);var br=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t._isUnique=!0,t.registerInput("color",f.Color4,!1,_.Fragment),t.registerOutput("rampColor",f.Color4,_.Fragment),t}return r.prototype.getClassName=function(){return"ParticleRampGradientBlock"},Object.defineProperty(r.prototype,"color",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rampColor",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype.initialize=function(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor"),e._excludeVariableName("finalAlpha")},r.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target!==_.Vertex)return e._emit2DSampler("rampSampler"),e._emitVaryingFromString("remapRanges","vec4","RAMPGRADIENT"),e.compilationString+=`
            #ifdef RAMPGRADIENT
                vec4 baseColor = `.concat(this.color.associatedVariableName,`;
                float alpha = `).concat(this.color.associatedVariableName,`.a;

                float remappedColorIndex = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);

                vec4 rampColor = texture2D(rampSampler, vec2(1.0 - remappedColorIndex, 0.));
                baseColor.rgb *= rampColor.rgb;

                // Remapped alpha
                float finalAlpha = baseColor.a;
                baseColor.a = clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0);

                `).concat(this._declareOutput(this.rampColor,e),` = baseColor;
            #else
                `).concat(this._declareOutput(this.rampColor,e)," = ").concat(this.color.associatedVariableName,`;
            #endif
        `),this},r}(F);P("BABYLON.ParticleRampGradientBlock",br);var yr=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t._isUnique=!0,t.registerInput("color",f.Color4,!1,_.Fragment),t.registerInput("alphaTexture",f.Float,!1,_.Fragment),t.registerInput("alphaColor",f.Float,!1,_.Fragment),t.registerOutput("blendColor",f.Color4,_.Fragment),t}return r.prototype.getClassName=function(){return"ParticleBlendMultiplyBlock"},Object.defineProperty(r.prototype,"color",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"alphaTexture",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"alphaColor",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"blendColor",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype.initialize=function(e){e._excludeVariableName("sourceAlpha")},r.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target!==_.Vertex)return e.compilationString+=`
            #ifdef BLENDMULTIPLYMODE
                `.concat(this._declareOutput(this.blendColor,e),`;
                float sourceAlpha = `).concat(this.alphaColor.associatedVariableName," * ").concat(this.alphaTexture.associatedVariableName,`;
                `).concat(this.blendColor.associatedVariableName,".rgb = ").concat(this.color.associatedVariableName,`.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha);
                `).concat(this.blendColor.associatedVariableName,".a = ").concat(this.color.associatedVariableName,`.a;
            #else
                `).concat(this._declareOutput(this.blendColor,e)," = ").concat(this.color.associatedVariableName,`;
            #endif
        `),this},r}(F);P("BABYLON.ParticleBlendMultiplyBlock",yr);var $e=function(){function n(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}return n.prototype.unBindMesh=function(){this._mesh=null},n.prototype.addFallback=function(r,e){this._defines[r]||(r<this._currentRank&&(this._currentRank=r),r>this._maxRank&&(this._maxRank=r),this._defines[r]=new Array),this._defines[r].push(e)},n.prototype.addCPUSkinningFallback=function(r,e){this._mesh=e,r<this._currentRank&&(this._currentRank=r),r>this._maxRank&&(this._maxRank=r)},Object.defineProperty(n.prototype,"hasMoreFallbacks",{get:function(){return this._currentRank<=this._maxRank},enumerable:!1,configurable:!0}),n.prototype.reduce=function(r,e){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,r=r.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),e._bonesComputationForcedToCPU=!0;for(var t=this._mesh.getScene(),i=0;i<t.meshes.length;i++){var a=t.meshes[i];if(!a.material){!this._mesh.material&&a.computeBonesUsingShaders&&a.numBoneInfluencers>0&&(a.computeBonesUsingShaders=!1);continue}if(!(!a.computeBonesUsingShaders||a.numBoneInfluencers===0)){if(a.material.getEffect()===e)a.computeBonesUsingShaders=!1;else if(a.subMeshes)for(var o=0,s=a.subMeshes;o<s.length;o++){var u=s[o],l=u.effect;if(l===e){a.computeBonesUsingShaders=!1;break}}}}}else{var c=this._defines[this._currentRank];if(c)for(var i=0;i<c.length;i++)r=r.replace("#define "+c[i],"");this._currentRank++}return r},n}(),st=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.xSwizzle="x",t.ySwizzle="y",t.zSwizzle="z",t.wSwizzle="w",t.registerInput("xyzw ",f.Vector4,!0),t.registerInput("xyz ",f.Vector3,!0),t.registerInput("xy ",f.Vector2,!0),t.registerInput("zw ",f.Vector2,!0),t.registerInput("x",f.Float,!0),t.registerInput("y",f.Float,!0),t.registerInput("z",f.Float,!0),t.registerInput("w",f.Float,!0),t.registerOutput("xyzw",f.Vector4),t.registerOutput("xyz",f.Vector3),t.registerOutput("xy",f.Vector2),t.registerOutput("zw",f.Vector2),t}return r.prototype.getClassName=function(){return"VectorMergerBlock"},Object.defineProperty(r.prototype,"xyzwIn",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"xyzIn",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"xyIn",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"zwIn",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"x",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"z",{get:function(){return this._inputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"w",{get:function(){return this._inputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"xyzw",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"xyzOut",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"xyOut",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"zwOut",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"xy",{get:function(){return this.xyOut},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"xyz",{get:function(){return this.xyzOut},enumerable:!1,configurable:!0}),r.prototype._inputRename=function(e){return e==="xyzw "?"xyzwIn":e==="xyz "?"xyzIn":e==="xy "?"xyIn":e==="zw "?"zwIn":e},r.prototype._buildSwizzle=function(e){var t=this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle;return"."+t.substr(0,e)},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this.x,i=this.y,a=this.z,o=this.w,s=this.xyIn,u=this.zwIn,l=this.xyzIn,c=this.xyzwIn,p=this._outputs[0],d=this._outputs[1],g=this._outputs[2],m=this._outputs[3];return c.isConnected?(p.hasEndpoints&&(e.compilationString+=this._declareOutput(p,e)+" = ".concat(c.associatedVariableName).concat(this._buildSwizzle(4),`;\r
`)),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+" = ".concat(c.associatedVariableName).concat(this._buildSwizzle(3),`;\r
`)),g.hasEndpoints&&(e.compilationString+=this._declareOutput(g,e)+" = ".concat(c.associatedVariableName).concat(this._buildSwizzle(2),`;\r
`))):l.isConnected?(p.hasEndpoints&&(e.compilationString+=this._declareOutput(p,e)+" = vec4(".concat(l.associatedVariableName,", ").concat(o.isConnected?this._writeVariable(o):"0.0",")").concat(this._buildSwizzle(4),`;\r
`)),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+" = ".concat(l.associatedVariableName).concat(this._buildSwizzle(3),`;\r
`)),g.hasEndpoints&&(e.compilationString+=this._declareOutput(g,e)+" = ".concat(l.associatedVariableName).concat(this._buildSwizzle(2),`;\r
`))):s.isConnected?(p.hasEndpoints&&(u.isConnected?e.compilationString+=this._declareOutput(p,e)+" = vec4(".concat(s.associatedVariableName,", ").concat(u.associatedVariableName,")").concat(this._buildSwizzle(4),`;\r
`):e.compilationString+=this._declareOutput(p,e)+" = vec4(".concat(s.associatedVariableName,", ").concat(a.isConnected?this._writeVariable(a):"0.0",", ").concat(o.isConnected?this._writeVariable(o):"0.0",")").concat(this._buildSwizzle(4),`;\r
`)),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+" = vec3(".concat(s.associatedVariableName,", ").concat(a.isConnected?this._writeVariable(a):"0.0",")").concat(this._buildSwizzle(3),`;\r
`)),g.hasEndpoints&&(e.compilationString+=this._declareOutput(g,e)+" = ".concat(s.associatedVariableName).concat(this._buildSwizzle(2),`;\r
`)),m.hasEndpoints&&(u.isConnected?e.compilationString+=this._declareOutput(m,e)+" = ".concat(u.associatedVariableName).concat(this._buildSwizzle(2),`;\r
`):e.compilationString+=this._declareOutput(m,e)+" = vec2(".concat(a.isConnected?this._writeVariable(a):"0.0",", ").concat(o.isConnected?this._writeVariable(o):"0.0",")").concat(this._buildSwizzle(2),`;\r
`))):(p.hasEndpoints&&(u.isConnected?e.compilationString+=this._declareOutput(p,e)+" = vec4(".concat(t.isConnected?this._writeVariable(t):"0.0",", ").concat(i.isConnected?this._writeVariable(i):"0.0",", ").concat(u.associatedVariableName,")").concat(this._buildSwizzle(4),`;\r
`):e.compilationString+=this._declareOutput(p,e)+" = vec4(".concat(t.isConnected?this._writeVariable(t):"0.0",", ").concat(i.isConnected?this._writeVariable(i):"0.0",", ").concat(a.isConnected?this._writeVariable(a):"0.0",", ").concat(o.isConnected?this._writeVariable(o):"0.0",")").concat(this._buildSwizzle(4),`;\r
`)),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+" = vec3(".concat(t.isConnected?this._writeVariable(t):"0.0",", ").concat(i.isConnected?this._writeVariable(i):"0.0",", ").concat(a.isConnected?this._writeVariable(a):"0.0",")").concat(this._buildSwizzle(3),`;\r
`)),g.hasEndpoints&&(e.compilationString+=this._declareOutput(g,e)+" = vec2(".concat(t.isConnected?this._writeVariable(t):"0.0",", ").concat(i.isConnected?this._writeVariable(i):"0.0",")").concat(this._buildSwizzle(2),`;\r
`)),m.hasEndpoints&&(u.isConnected?e.compilationString+=this._declareOutput(m,e)+" = ".concat(u.associatedVariableName).concat(this._buildSwizzle(2),`;\r
`):e.compilationString+=this._declareOutput(m,e)+" = vec2(".concat(a.isConnected?this._writeVariable(a):"0.0",", ").concat(o.isConnected?this._writeVariable(o):"0.0",")").concat(this._buildSwizzle(2),`;\r
`))),this},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e},r.prototype._deserialize=function(e,t,i){var a,o,s,u;n.prototype._deserialize.call(this,e,t,i),this.xSwizzle=(a=e.xSwizzle)!==null&&a!==void 0?a:"x",this.ySwizzle=(o=e.ySwizzle)!==null&&o!==void 0?o:"y",this.zSwizzle=(s=e.zSwizzle)!==null&&s!==void 0?s:"z",this.wSwizzle=(u=e.wSwizzle)!==null&&u!==void 0?u:"w"},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,'.xSwizzle = "').concat(this.xSwizzle,`";\r
`),e+="".concat(this._codeVariableName,'.ySwizzle = "').concat(this.ySwizzle,`";\r
`),e+="".concat(this._codeVariableName,'.zSwizzle = "').concat(this.zSwizzle,`";\r
`),e+="".concat(this._codeVariableName,'.wSwizzle = "').concat(this.wSwizzle,`";\r
`),e},r}(F);P("BABYLON.VectorMergerBlock",st);var Tr=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.sourceRange=new Te(-1,1),t.targetRange=new Te(0,1),t.registerInput("input",f.AutoDetect),t.registerInput("sourceMin",f.Float,!0),t.registerInput("sourceMax",f.Float,!0),t.registerInput("targetMin",f.Float,!0),t.registerInput("targetMax",f.Float,!0),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t}return r.prototype.getClassName=function(){return"RemapBlock"},Object.defineProperty(r.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"sourceMin",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"sourceMax",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"targetMin",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"targetMax",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),a=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),o=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),s=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=this._declareOutput(t,e)+" = ".concat(o," + (").concat(this._inputs[0].associatedVariableName," - ").concat(i,") * (").concat(s," - ").concat(o,") / (").concat(a," - ").concat(i,`);\r
`),this},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this)+"".concat(this._codeVariableName,".sourceRange = new BABYLON.Vector2(").concat(this.sourceRange.x,", ").concat(this.sourceRange.y,`);\r
`);return e+="".concat(this._codeVariableName,".targetRange = new BABYLON.Vector2(").concat(this.targetRange.x,", ").concat(this.targetRange.y,`);\r
`),e},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),this.sourceRange=Te.FromArray(e.sourceRange),this.targetRange=Te.FromArray(e.targetRange)},h([H("From",z.Vector2)],r.prototype,"sourceRange",void 0),h([H("To",z.Vector2)],r.prototype,"targetRange",void 0),r}(F);P("BABYLON.RemapBlock",Tr);var Ut=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("left",f.AutoDetect),t.registerInput("right",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t}return r.prototype.getClassName=function(){return"MultiplyBlock"},Object.defineProperty(r.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.left.associatedVariableName," * ").concat(this.right.associatedVariableName,`;\r
`),this},r}(F);P("BABYLON.MultiplyBlock",Ut);var me;(function(n){n[n.Material=0]="Material",n[n.PostProcess=1]="PostProcess",n[n.Particle=2]="Particle",n[n.ProceduralTexture=3]="ProceduralTexture"})(me||(me={}));var Sr=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("rgba",f.Color4,!0),t.registerInput("rgb ",f.Color3,!0),t.registerOutput("rgb",f.Color3),t.registerOutput("r",f.Float),t.registerOutput("g",f.Float),t.registerOutput("b",f.Float),t.registerOutput("a",f.Float),t.inputsAreExclusive=!0,t}return r.prototype.getClassName=function(){return"ColorSplitterBlock"},Object.defineProperty(r.prototype,"rgba",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rgbIn",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rgbOut",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"r",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"g",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"b",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"a",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),r.prototype._inputRename=function(e){return e==="rgb "?"rgbIn":e},r.prototype._outputRename=function(e){return e==="rgb"?"rgbOut":e},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!!t.isConnected){var i=this._outputs[0],a=this._outputs[1],o=this._outputs[2],s=this._outputs[3],u=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+" = ".concat(t.associatedVariableName,`.rgb;\r
`)),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+" = ".concat(t.associatedVariableName,`.r;\r
`)),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+" = ".concat(t.associatedVariableName,`.g;\r
`)),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+" = ".concat(t.associatedVariableName,`.b;\r
`)),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+" = ".concat(t.associatedVariableName,`.a;\r
`)),this}},r}(F);P("BABYLON.ColorSplitterBlock",Sr);var Ve=function(n){A(r,n);function r(e,t,i,a,o,s,u,l,c,p,d,g,m,y,v,T,x){o===void 0&&(o=!0),s===void 0&&(s=0),u===void 0&&(u=!1),l===void 0&&(l=I.TRILINEAR_SAMPLINGMODE),c===void 0&&(c=!0),p===void 0&&(p=!1),d===void 0&&(d=!1),g===void 0&&(g=5),m===void 0&&(m=!1),T===void 0&&(T=!1),x===void 0&&(x=!1);var E=this,O;if(E=n.call(this,null,i,!a,void 0,l,void 0,void 0,void 0,void 0,g)||this,E.renderParticles=!0,E.renderSprites=!1,E.ignoreCameraViewport=!1,E.onBeforeBindObservable=new J,E.onAfterUnbindObservable=new J,E.onBeforeRenderObservable=new J,E.onAfterRenderObservable=new J,E.onClearObservable=new J,E.onResizeObservable=new J,E._cleared=!1,E.skipInitialClear=!1,E._currentRefreshId=-1,E._refreshRate=1,E._samples=1,E._canRescale=!0,E._renderTarget=null,E.boundingBoxPosition=K.Zero(),i=E.getScene(),!i)return E;var N=E.getScene().getEngine();return E._coordinatesMode=I.PROJECTION_MODE,E.renderList=new Array,E.name=e,E.isRenderTarget=!0,E._initialSizeParameter=t,E._renderPassIds=[],E._isCubeData=u,E._processSizeParameter(t),E.renderPassId=E._renderPassIds[0],E._resizeObserver=N.onResizeObservable.add(function(){}),E._generateMipMaps=!!a,E._doNotChangeAspectRatio=o,E._renderingManager=new vi(i),E._renderingManager._useSceneAutoClearSetup=!0,d||(E._renderTargetOptions={generateMipMaps:a,type:s,format:(O=E._format)!==null&&O!==void 0?O:void 0,samplingMode:E.samplingMode,generateDepthBuffer:c,generateStencilBuffer:p,samples:y,creationFlags:v,noColorTarget:T,useSRGBBuffer:x},E.samplingMode===I.NEAREST_SAMPLINGMODE&&(E.wrapU=I.CLAMP_ADDRESSMODE,E.wrapV=I.CLAMP_ADDRESSMODE),m||(u?(E._renderTarget=i.getEngine().createRenderTargetCubeTexture(E.getRenderSize(),E._renderTargetOptions),E.coordinatesMode=I.INVCUBIC_MODE,E._textureMatrix=q.Identity()):E._renderTarget=i.getEngine().createRenderTargetTexture(E._size,E._renderTargetOptions),E._texture=E._renderTarget.texture,y!==void 0&&(E.samples=y))),E}return Object.defineProperty(r.prototype,"renderList",{get:function(){return this._renderList},set:function(e){this._renderList=e,this._renderList&&this._hookArray(this._renderList)},enumerable:!1,configurable:!0}),r.prototype._hookArray=function(e){var t=this;if(!e.hasBeenHooked){var i=e.push;e.push=function(){for(var o,s=[],u=0;u<arguments.length;u++)s[u]=arguments[u];var l=e.length===0,c=i.apply(e,s);return l&&((o=t.getScene())===null||o===void 0||o.meshes.forEach(function(p){p._markSubMeshesAsLightDirty()})),c};var a=e.splice;e.splice=function(o,s){for(var u,l=[],c=2;c<arguments.length;c++)l[c-2]=arguments[c];s=s===void 0?e.length:s;var p=a.apply(e,zr([o,s],l,!0));return e.length===0&&((u=t.getScene())===null||u===void 0||u.meshes.forEach(function(d){d._markSubMeshesAsLightDirty()})),p},e.hasBeenHooked=!0}},Object.defineProperty(r.prototype,"postProcesses",{get:function(){return this._postProcesses},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"_prePassEnabled",{get:function(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onAfterUnbind",{set:function(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onBeforeRender",{set:function(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onAfterRender",{set:function(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onClear",{set:function(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"renderPassIds",{get:function(){return this._renderPassIds},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"currentRefreshId",{get:function(){return this._currentRefreshId},enumerable:!1,configurable:!0}),r.prototype.setMaterialForRendering=function(e,t){var i;Array.isArray(e)?i=e:i=[e];for(var a=0;a<i.length;++a)for(var o=0;o<this._renderPassIds.length;++o)i[a].setMaterialForRenderPass(this._renderPassIds[o],t!==void 0?Array.isArray(t)?t[o]:t:void 0)},Object.defineProperty(r.prototype,"renderTargetOptions",{get:function(){return this._renderTargetOptions},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"renderTarget",{get:function(){return this._renderTarget},enumerable:!1,configurable:!0}),r.prototype._onRatioRescale=function(){this._sizeRatio&&this.resize(this._initialSizeParameter)},Object.defineProperty(r.prototype,"boundingBoxSize",{get:function(){return this._boundingBoxSize},set:function(e){if(!(this._boundingBoxSize&&this._boundingBoxSize.equals(e))){this._boundingBoxSize=e;var t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"depthStencilTexture",{get:function(){var e,t;return(t=(e=this._renderTarget)===null||e===void 0?void 0:e._depthStencilTexture)!==null&&t!==void 0?t:null},enumerable:!1,configurable:!0}),r.prototype.createDepthStencilTexture=function(e,t,i,a,o){var s;e===void 0&&(e=0),t===void 0&&(t=!0),i===void 0&&(i=!1),a===void 0&&(a=1),o===void 0&&(o=14),(s=this._renderTarget)===null||s===void 0||s.createDepthStencilTexture(e,t,i,a,o)},r.prototype._releaseRenderPassId=function(){if(this._scene)for(var e=this._scene.getEngine(),t=0;t<this._renderPassIds.length;++t)e.releaseRenderPassId(this._renderPassIds[t]);this._renderPassIds=[]},r.prototype._createRenderPassId=function(){this._releaseRenderPassId();for(var e=this._scene.getEngine(),t=this._isCubeData?6:this.getRenderLayers()||1,i=0;i<t;++i)this._renderPassIds[i]=e.createRenderPassId("RenderTargetTexture - ".concat(this.name,"#").concat(i))},r.prototype._processSizeParameter=function(e){if(e.ratio){this._sizeRatio=e.ratio;var t=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(t.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(t.getRenderHeight(),this._sizeRatio)}}else this._size=e;this._createRenderPassId()},Object.defineProperty(r.prototype,"samples",{get:function(){var e,t;return(t=(e=this._renderTarget)===null||e===void 0?void 0:e.samples)!==null&&t!==void 0?t:this._samples},set:function(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))},enumerable:!1,configurable:!0}),r.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1},Object.defineProperty(r.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(e){this._refreshRate=e,this.resetRefreshCounter()},enumerable:!1,configurable:!0}),r.prototype.addPostProcess=function(e){if(!this._postProcessManager){var t=this.getScene();if(!t)return;this._postProcessManager=new _i(t),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1},r.prototype.clearPostProcesses=function(e){if(e===void 0&&(e=!1),!!this._postProcesses){if(e)for(var t=0,i=this._postProcesses;t<i.length;t++){var a=i[t];a.dispose()}this._postProcesses=[]}},r.prototype.removePostProcess=function(e){if(!!this._postProcesses){var t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}},r.prototype._shouldRender=function(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)},r.prototype.getRenderSize=function(){return this.getRenderWidth()},r.prototype.getRenderWidth=function(){return this._size.width?this._size.width:this._size},r.prototype.getRenderHeight=function(){return this._size.width?this._size.height:this._size},r.prototype.getRenderLayers=function(){var e=this._size.layers;return e||0},r.prototype.disableRescaling=function(){this._canRescale=!1},Object.defineProperty(r.prototype,"canRescale",{get:function(){return this._canRescale},enumerable:!1,configurable:!0}),r.prototype.scale=function(e){var t=Math.max(1,this.getRenderSize()*e);this.resize(t)},r.prototype.getReflectionTextureMatrix=function(){return this.isCube?this._textureMatrix:n.prototype.getReflectionTextureMatrix.call(this)},r.prototype.resize=function(e){var t,i=this.isCube;(t=this._renderTarget)===null||t===void 0||t.dispose(),this._renderTarget=null;var a=this.getScene();!a||(this._processSizeParameter(e),i?this._renderTarget=a.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._renderTarget=a.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))},r.prototype.render=function(e,t){e===void 0&&(e=!1),t===void 0&&(t=!1),this._render(e,t)},r.prototype.isReadyForRendering=function(){return this._render(!1,!1,!0)},r.prototype._render=function(e,t,i){var a;e===void 0&&(e=!1),t===void 0&&(t=!1),i===void 0&&(i=!1);var o=this.getScene();if(!o)return i;var s=o.getEngine();if(this.useCameraPostProcesses!==void 0&&(e=this.useCameraPostProcesses),this._waitingRenderList){this.renderList=[];for(var u=0;u<this._waitingRenderList.length;u++){var l=this._waitingRenderList[u],c=o.getMeshById(l);c&&this.renderList.push(c)}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];var p=this.getScene();if(!p)return i;for(var d=p.meshes,u=0;u<d.length;u++){var c=d[u];this.renderListPredicate(c)&&this.renderList.push(c)}}var g=s.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);var m=(a=this.activeCamera)!==null&&a!==void 0?a:o.activeCamera,y=o.activeCamera;m&&(m!==o.activeCamera&&(o.setTransformMatrix(m.getViewMatrix(),m.getProjectionMatrix(!0)),o.activeCamera=m),s.setViewport(m.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;var v=i;if(i){o.getViewMatrix()||o.updateTransformMatrix();for(var E=this.is2DArray?this.getRenderLayers():this.isCube?6:1,T=0;T<E&&v;T++){var O=null,N=this.renderList?this.renderList:o.getActiveMeshes().data,w=this.renderList?this.renderList.length:o.getActiveMeshes().length;s.currentRenderPassId=this._renderPassIds[T],this.onBeforeRenderObservable.notifyObservers(T),this.getCustomRenderList&&(O=this.getCustomRenderList(T,N,w)),O||(O=N),this._doNotChangeAspectRatio||o.updateTransformMatrix(!0);for(var k=0;k<O.length&&v;++k){var c=O[k];if(!(!c.isEnabled()||c.isBlocked||!c.isVisible||!c.subMeshes)){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(c,this.refreshRate)){v=!1;break}}else if(!c.isReady(!0)){v=!1;break}}}this.onAfterRenderObservable.notifyObservers(T)}}else if(this.is2DArray)for(var T=0;T<this.getRenderLayers();T++)this._renderToTarget(0,e,t,T,m),o.incrementRenderId(),o.resetCachedMaterial();else if(this.isCube)for(var x=0;x<6;x++)this._renderToTarget(x,e,t,void 0,m),o.incrementRenderId(),o.resetCachedMaterial();else this._renderToTarget(0,e,t,void 0,m);return this.onAfterUnbindObservable.notifyObservers(this),s.currentRenderPassId=g,y&&(o.activeCamera=y,(o.getEngine().scenes.length>1||this.activeCamera&&this.activeCamera!==o.activeCamera)&&o.setTransformMatrix(o.activeCamera.getViewMatrix(),o.activeCamera.getProjectionMatrix(!0)),s.setViewport(o.activeCamera.viewport)),o.resetCachedMaterial(),v},r.prototype._bestReflectionRenderTargetDimension=function(e,t){var i=128,a=e*t,o=Q.NearestPOT(a+i*i/(i+a));return Math.min(Q.FloorPOT(e),o)},r.prototype._prepareRenderingManager=function(e,t,i,a){var o=this.getScene();if(!!o){this._renderingManager.reset();for(var s=o.getRenderId(),u=0;u<t;u++){var l=e[u];if(l&&!l.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(l,this.refreshRate)){this.resetRefreshCounter();continue}}else if(!l.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}if(!l._internalAbstractMeshDataInfo._currentLODIsUpToDate&&o.activeCamera&&(l._internalAbstractMeshDataInfo._currentLOD=o.customLODSelector?o.customLODSelector(l,this.activeCamera||o.activeCamera):l.getLOD(this.activeCamera||o.activeCamera),l._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!l._internalAbstractMeshDataInfo._currentLOD)continue;var c=l._internalAbstractMeshDataInfo._currentLOD;c._preActivateForIntermediateRendering(s);var p=void 0;if(a&&i?p=(l.layerMask&i.layerMask)===0:p=!1,l.isEnabled()&&l.isVisible&&l.subMeshes&&!p&&(c!==l&&c._activate(s,!0),l._activate(s,!0)&&l.subMeshes.length)){l.isAnInstance?l._internalAbstractMeshDataInfo._actAsRegularMesh&&(c=l):c._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,c._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(var d=0;d<c.subMeshes.length;d++){var g=c.subMeshes[d];this._renderingManager.dispatch(g,c)}}}}for(var m=0;m<o.particleSystems.length;m++){var y=o.particleSystems[m],v=y.emitter;!y.isStarted()||!v||!v.position||!v.isEnabled()||e.indexOf(v)>=0&&this._renderingManager.dispatchParticles(y)}}},r.prototype._bindFrameBuffer=function(e,t){e===void 0&&(e=0),t===void 0&&(t=0);var i=this.getScene();if(!!i){var a=i.getEngine();this._renderTarget&&a.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}},r.prototype._unbindFrameBuffer=function(e,t){var i=this;!this._renderTarget||e.unBindFramebuffer(this._renderTarget,this.isCube,function(){i.onAfterRenderObservable.notifyObservers(t)})},r.prototype._prepareFrame=function(e,t,i,a){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!a||!e.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(t,i)},r.prototype._renderToTarget=function(e,t,i,a,o){var s,u,l,c,p,d;a===void 0&&(a=0),o===void 0&&(o=null);var g=this.getScene();if(!!g){var m=g.getEngine();(s=m._debugPushGroup)===null||s===void 0||s.call(m,"render to face #".concat(e," layer #").concat(a),1),this._prepareFrame(g,e,a,t),this.is2DArray?(m.currentRenderPassId=this._renderPassIds[a],this.onBeforeRenderObservable.notifyObservers(a)):(m.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e));var y=m.snapshotRendering&&m.snapshotRenderingMode===1;if(y)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(m):this.skipInitialClear||m.clear(this.clearColor||g.clearColor,!0,!0,!0);else{var v=null,T=this.renderList?this.renderList:g.getActiveMeshes().data,x=this.renderList?this.renderList.length:g.getActiveMeshes().length;this.getCustomRenderList&&(v=this.getCustomRenderList(this.is2DArray?a:e,T,x)),v?this._prepareRenderingManager(v,v.length,o,!1):(this._defaultRenderListPrepared||(this._prepareRenderingManager(T,x,o,!this.renderList),this._defaultRenderListPrepared=!0),v=T);for(var E=0,O=g._beforeRenderTargetClearStage;E<O.length;E++){var N=O[E];N.action(this,e,a)}this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(m):this.skipInitialClear||m.clear(this.clearColor||g.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||g.updateTransformMatrix(!0);for(var w=0,k=g._beforeRenderTargetDrawStage;w<k.length;w++){var N=k[w];N.action(this,e,a)}this._renderingManager.render(this.customRenderFunction,v,this.renderParticles,this.renderSprites);for(var W=0,Z=g._afterRenderTargetDrawStage;W<Z.length;W++){var N=Z[W];N.action(this,e,a)}var ie=(l=(u=this._texture)===null||u===void 0?void 0:u.generateMipMaps)!==null&&l!==void 0?l:!1;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,(c=this._renderTarget)!==null&&c!==void 0?c:void 0,e,this._postProcesses,this.ignoreCameraViewport):t&&g.postProcessManager._finalizeFrame(!1,(p=this._renderTarget)!==null&&p!==void 0?p:void 0,e),this._texture&&(this._texture.generateMipMaps=ie),this._doNotChangeAspectRatio||g.updateTransformMatrix(!0),i&&ae.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),m)}this._unbindFrameBuffer(m,e),this._texture&&this.isCube&&e===5&&m.generateMipMapsForCubemap(this._texture),(d=m._debugPopGroup)===null||d===void 0||d.call(m,1)}},r.prototype.setRenderingOrder=function(e,t,i,a){t===void 0&&(t=null),i===void 0&&(i=null),a===void 0&&(a=null),this._renderingManager.setRenderingOrder(e,t,i,a)},r.prototype.setRenderingAutoClearDepthStencil=function(e,t){this._renderingManager.setRenderingAutoClearDepthStencil(e,t),this._renderingManager._useSceneAutoClearSetup=!1},r.prototype.clone=function(){var e=this.getSize(),t=new r(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t},r.prototype.serialize=function(){if(!this.name)return null;var e=n.prototype.serialize.call(this);if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(var t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e},r.prototype.disposeFramebufferObjects=function(){var e;(e=this._renderTarget)===null||e===void 0||e.dispose(!0)},r.prototype.releaseInternalTexture=function(){var e;(e=this._renderTarget)===null||e===void 0||e.releaseTextures(),this._texture=null},r.prototype.dispose=function(){var e;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;var t=this.getScene();if(!!t){var i=t.customRenderTargets.indexOf(this);i>=0&&t.customRenderTargets.splice(i,1);for(var a=0,o=t.cameras;a<o.length;a++){var s=o[a];i=s.customRenderTargets.indexOf(this),i>=0&&s.customRenderTargets.splice(i,1)}(e=this._renderTarget)===null||e===void 0||e.dispose(),this._renderTarget=null,this._texture=null,n.prototype.dispose.call(this)}},r.prototype._rebuild=function(){this.refreshRate===r.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=r.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()},r.prototype.freeRenderingGroups=function(){this._renderingManager&&this._renderingManager.freeRenderingGroups()},r.prototype.getViewCount=function(){return 1},r.REFRESHRATE_RENDER_ONCE=0,r.REFRESHRATE_RENDER_ONEVERYFRAME=1,r.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,r}(I);I._CreateRenderTargetTexture=function(n,r,e,t,i){return new Ve(n,r,e,t)};var Ri=function(){function n(r){this.name=Vt.NAME_PROCEDURALTEXTURE,this.scene=r,this.scene.proceduralTextures=new Array}return n.prototype.register=function(){this.scene._beforeClearStage.registerStep(Vt.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)},n.prototype.rebuild=function(){},n.prototype.dispose=function(){},n.prototype._beforeClear=function(){if(this.scene.proceduralTexturesEnabled){ae.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(var r=0;r<this.scene.proceduralTextures.length;r++){var e=this.scene.proceduralTextures[r];e._shouldRender()&&e.render()}ae.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}},n}(),ft=function(n){A(r,n);function r(e,t,i,a,o,s,u,l){o===void 0&&(o=null),s===void 0&&(s=!0),u===void 0&&(u=!1),l===void 0&&(l=0);var c=n.call(this,null,a,!s)||this;c.isEnabled=!0,c.autoClear=!0,c.onGeneratedObservable=new J,c.onBeforeGenerationObservable=new J,c.nodeMaterialSource=null,c._textures={},c._currentRefreshId=-1,c._frameId=-1,c._refreshRate=1,c._vertexBuffers={},c._uniforms=new Array,c._samplers=new Array,c._floats={},c._ints={},c._floatsArrays={},c._colors3={},c._colors4={},c._vectors2={},c._vectors3={},c._matrices={},c._fallbackTextureUsed=!1,c._cachedDefines=null,c._contentUpdateId=-1,c._rtWrapper=null,a=c.getScene()||de.LastCreatedScene;var p=a._getComponent(Vt.NAME_PROCEDURALTEXTURE);p||(p=new Ri(a),a._addComponent(p)),a.proceduralTextures.push(c),c._fullEngine=a.getEngine(),c.name=e,c.isRenderTarget=!0,c._size=t,c._textureType=l,c._generateMipMaps=s,c._drawWrapper=new qe(c._fullEngine),c.setFragment(i),c._fallbackTexture=o;var d=c._createRtWrapper(u,t,s,l);c._texture=d.texture;var g=[];return g.push(1,1),g.push(-1,1),g.push(-1,-1),g.push(1,-1),c._vertexBuffers[L.PositionKind]=new L(c._fullEngine,g,L.PositionKind,!1,!1,2),c._createIndexBuffer(),c}return r.prototype._createRtWrapper=function(e,t,i,a){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:a}),this.setFloat("face",0)):this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:a}),this._rtWrapper},r.prototype.getEffect=function(){return this._drawWrapper.effect},r.prototype._setEffect=function(e){this._drawWrapper.effect=e},r.prototype.getContent=function(){var e=this;return this._contentData&&this._frameId===this._contentUpdateId?this._contentData:(this._contentData?this._contentData.then(function(t){e._contentData=e.readPixels(0,0,t),e._contentUpdateId=e._frameId}):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId),this._contentData)},r.prototype._createIndexBuffer=function(){var e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)},r.prototype._rebuild=function(){var e=this._vertexBuffers[L.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===Ve.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Ve.REFRESHRATE_RENDER_ONCE)},r.prototype.reset=function(){var e;(e=this._drawWrapper.effect)===null||e===void 0||e.dispose()},r.prototype._getDefines=function(){return""},r.prototype.isReady=function(){var e=this,t=this._fullEngine,i;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;var a=this._getDefines();return this._drawWrapper.effect&&a===this._cachedDefines&&this._drawWrapper.effect.isReady()?!0:(this._fragment.fragmentElement!==void 0?i={vertex:"procedural",fragmentElement:this._fragment.fragmentElement}:i={vertex:"procedural",fragment:this._fragment},this._cachedDefines!==a&&(this._cachedDefines=a,this._drawWrapper.effect=t.createEffect(i,[L.PositionKind],this._uniforms,this._samplers,a,void 0,void 0,function(){var o;(o=e._rtWrapper)===null||o===void 0||o.dispose(),e._rtWrapper=e._texture=null,e._fallbackTexture&&(e._texture=e._fallbackTexture._texture,e._texture&&e._texture.incrementReferences()),e._fallbackTextureUsed=!0})),this._drawWrapper.effect.isReady())},r.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1},r.prototype.setFragment=function(e){this._fragment=e},Object.defineProperty(r.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(e){this._refreshRate=e,this.resetRefreshCounter()},enumerable:!1,configurable:!0}),r.prototype._shouldRender=function(){return!this.isEnabled||!this.isReady()||!this._texture?(this._texture&&(this._texture.isReady=!1),!1):this._fallbackTextureUsed?!1:this._currentRefreshId===-1?(this._currentRefreshId=1,this._frameId++,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)},r.prototype.getRenderSize=function(){return this._size},r.prototype.resize=function(e,t){if(!(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)){var i=this._texture.isCube;this._rtWrapper.dispose();var a=this._createRtWrapper(i,e,t,this._textureType);this._texture=a.texture,this._size=e,this._generateMipMaps=t}},r.prototype._checkUniform=function(e){this._uniforms.indexOf(e)===-1&&this._uniforms.push(e)},r.prototype.setTexture=function(e,t){return this._samplers.indexOf(e)===-1&&this._samplers.push(e),this._textures[e]=t,this},r.prototype.setFloat=function(e,t){return this._checkUniform(e),this._floats[e]=t,this},r.prototype.setInt=function(e,t){return this._checkUniform(e),this._ints[e]=t,this},r.prototype.setFloats=function(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this},r.prototype.setColor3=function(e,t){return this._checkUniform(e),this._colors3[e]=t,this},r.prototype.setColor4=function(e,t){return this._checkUniform(e),this._colors4[e]=t,this},r.prototype.setVector2=function(e,t){return this._checkUniform(e),this._vectors2[e]=t,this},r.prototype.setVector3=function(e,t){return this._checkUniform(e),this._vectors3[e]=t,this},r.prototype.setMatrix=function(e,t){return this._checkUniform(e),this._matrices[e]=t,this},r.prototype.render=function(e){var t,i,a=this.getScene();if(!!a){var o=this._fullEngine;if(o.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),o.setState(!1),!this.nodeMaterialSource){for(var s in this._textures)this._drawWrapper.effect.setTexture(s,this._textures[s]);for(var u in this._ints)this._drawWrapper.effect.setInt(u,this._ints[u]);for(var l in this._floats)this._drawWrapper.effect.setFloat(l,this._floats[l]);for(var c in this._floatsArrays)this._drawWrapper.effect.setArray(c,this._floatsArrays[c]);for(var p in this._colors3)this._drawWrapper.effect.setColor3(p,this._colors3[p]);for(var d in this._colors4){var g=this._colors4[d];this._drawWrapper.effect.setFloat4(d,g.r,g.g,g.b,g.a)}for(var m in this._vectors2)this._drawWrapper.effect.setVector2(m,this._vectors2[m]);for(var y in this._vectors3)this._drawWrapper.effect.setVector3(y,this._vectors3[y]);for(var v in this._matrices)this._drawWrapper.effect.setMatrix(v,this._matrices[v])}if(!(!this._texture||!this._rtWrapper)){(t=o._debugPushGroup)===null||t===void 0||t.call(o,"procedural texture generation for ".concat(this.name),1);var T=o.currentViewport;if(this.isCube)for(var x=0;x<6;x++)o.bindFramebuffer(this._rtWrapper,x,void 0,void 0,!0),o.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",x),this.autoClear&&o.clear(a.clearColor,!0,!1,!1),o.drawElementsType(xe.TriangleFillMode,0,6);else o.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0),o.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this.autoClear&&o.clear(a.clearColor,!0,!1,!1),o.drawElementsType(xe.TriangleFillMode,0,6);o.unBindFramebuffer(this._rtWrapper,this.isCube),T&&o.setViewport(T),this.isCube&&o.generateMipMapsForCubemap(this._texture),(i=o._debugPopGroup)===null||i===void 0||i.call(o,1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}}},r.prototype.clone=function(){var e=this.getSize(),t=new r(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t},r.prototype.dispose=function(){var e=this.getScene();if(!!e){var t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);var i=this._vertexBuffers[L.PositionKind];i&&(i.dispose(),this._vertexBuffers[L.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),n.prototype.dispose.call(this)}},h([b()],r.prototype,"isEnabled",void 0),h([b()],r.prototype,"autoClear",void 0),h([b()],r.prototype,"_generateMipMaps",void 0),h([b()],r.prototype,"_size",void 0),h([b()],r.prototype,"refreshRate",null),r}(I);P("BABYLON.ProceduralTexture",ft);var re;(function(n){n[n.Cos=0]="Cos",n[n.Sin=1]="Sin",n[n.Abs=2]="Abs",n[n.Exp=3]="Exp",n[n.Exp2=4]="Exp2",n[n.Round=5]="Round",n[n.Floor=6]="Floor",n[n.Ceiling=7]="Ceiling",n[n.Sqrt=8]="Sqrt",n[n.Log=9]="Log",n[n.Tan=10]="Tan",n[n.ArcTan=11]="ArcTan",n[n.ArcCos=12]="ArcCos",n[n.ArcSin=13]="ArcSin",n[n.Fract=14]="Fract",n[n.Sign=15]="Sign",n[n.Radians=16]="Radians",n[n.Degrees=17]="Degrees"})(re||(re={}));var Er=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.operation=re.Cos,t.registerInput("input",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t}return r.prototype.getClassName=function(){return"TrigonometryBlock"},Object.defineProperty(r.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0],i="";switch(this.operation){case re.Cos:{i="cos";break}case re.Sin:{i="sin";break}case re.Abs:{i="abs";break}case re.Exp:{i="exp";break}case re.Exp2:{i="exp2";break}case re.Round:{i="round";break}case re.Floor:{i="floor";break}case re.Ceiling:{i="ceil";break}case re.Sqrt:{i="sqrt";break}case re.Log:{i="log";break}case re.Tan:{i="tan";break}case re.ArcTan:{i="atan";break}case re.ArcCos:{i="acos";break}case re.ArcSin:{i="asin";break}case re.Fract:{i="fract";break}case re.Sign:{i="sign";break}case re.Radians:{i="radians";break}case re.Degrees:{i="degrees";break}}return e.compilationString+=this._declareOutput(t,e)+" = ".concat(i,"(").concat(this.input.associatedVariableName,`);\r
`),this},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.operation=this.operation,e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),this.operation=e.operation},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this)+"".concat(this._codeVariableName,".operation = BABYLON.TrigonometryBlockOperations.").concat(re[this.operation],`;\r
`);return e},r}(F);P("BABYLON.TrigonometryBlock",Er);var Ft={effect:null,subMesh:null},nt=function(n){A(r,n);function r(){var e=n.call(this)||this;return e.NORMAL=!1,e.TANGENT=!1,e.UV1=!1,e.UV2=!1,e.UV3=!1,e.UV4=!1,e.UV5=!1,e.UV6=!1,e.NUM_BONE_INFLUENCERS=0,e.BonesPerMesh=0,e.BONETEXTURE=!1,e.MORPHTARGETS=!1,e.MORPHTARGETS_NORMAL=!1,e.MORPHTARGETS_TANGENT=!1,e.MORPHTARGETS_UV=!1,e.NUM_MORPH_INFLUENCERS=0,e.MORPHTARGETS_TEXTURE=!1,e.IMAGEPROCESSING=!1,e.VIGNETTE=!1,e.VIGNETTEBLENDMODEMULTIPLY=!1,e.VIGNETTEBLENDMODEOPAQUE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=!1,e.SAMPLER3DBGRMAP=!1,e.IMAGEPROCESSINGPOSTPROCESS=!1,e.SKIPFINALCOLORCLAMP=!1,e.BUMPDIRECTUV=0,e.rebuild(),e}return r.prototype.setValue=function(e,t,i){i===void 0&&(i=!1),this[e]===void 0&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t},r}(Ae),Kt=function(n){A(r,n);function r(e,t,i){i===void 0&&(i={});var a=n.call(this,e,t||de.LastCreatedScene)||this;return a._buildId=r._BuildIdGenerator++,a._buildWasSuccessful=!1,a._cachedWorldViewMatrix=new q,a._cachedWorldViewProjectionMatrix=new q,a._optimizers=new Array,a._animationFrame=-1,a.BJSNODEMATERIALEDITOR=a._getGlobalNodeMaterialEditor(),a.editorData=null,a.ignoreAlpha=!1,a.maxSimultaneousLights=4,a.onBuildObservable=new J,a._vertexOutputNodes=new Array,a._fragmentOutputNodes=new Array,a.attachedBlocks=new Array,a._mode=me.Material,a.forceAlphaBlending=!1,a._options=Re({emitComments:!1},i),a._attachImageProcessingConfiguration(null),a}return r.prototype._getGlobalNodeMaterialEditor=function(){if(typeof NODEEDITOR!="undefined")return NODEEDITOR;if(typeof BABYLON!="undefined"&&typeof BABYLON.NodeEditor!="undefined")return BABYLON},Object.defineProperty(r.prototype,"options",{get:function(){return this._options},set:function(e){this._options=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"mode",{get:function(){return this._mode},set:function(e){this._mode=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"buildId",{get:function(){return this._buildId},set:function(e){this._buildId=e},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"NodeMaterial"},r.prototype._attachImageProcessingConfiguration=function(e){var t=this;e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){t._markAllSubMeshesAsImageProcessingDirty()})))},r.prototype.getBlockByName=function(e){for(var t=null,i=0,a=this.attachedBlocks;i<a.length;i++){var o=a[i];if(o.name===e)if(!t)t=o;else return ae.Warn("More than one block was found with the name `"+e+"`"),t}return t},r.prototype.getBlockByPredicate=function(e){for(var t=0,i=this.attachedBlocks;t<i.length;t++){var a=i[t];if(e(a))return a}return null},r.prototype.getInputBlockByPredicate=function(e){for(var t=0,i=this.attachedBlocks;t<i.length;t++){var a=i[t];if(a.isInput&&e(a))return a}return null},r.prototype.getInputBlocks=function(){for(var e=[],t=0,i=this.attachedBlocks;t<i.length;t++){var a=i[t];a.isInput&&e.push(a)}return e},r.prototype.registerOptimizer=function(e){var t=this._optimizers.indexOf(e);if(!(t>-1))return this._optimizers.push(e),this},r.prototype.unregisterOptimizer=function(e){var t=this._optimizers.indexOf(e);if(t!==-1)return this._optimizers.splice(t,1),this},r.prototype.addOutputNode=function(e){if(e.target===null)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return(e.target&_.Vertex)!==0&&this._addVertexOutputNode(e),(e.target&_.Fragment)!==0&&this._addFragmentOutputNode(e),this},r.prototype.removeOutputNode=function(e){return e.target===null?this:((e.target&_.Vertex)!==0&&this._removeVertexOutputNode(e),(e.target&_.Fragment)!==0&&this._removeFragmentOutputNode(e),this)},r.prototype._addVertexOutputNode=function(e){if(this._vertexOutputNodes.indexOf(e)===-1)return e.target=_.Vertex,this._vertexOutputNodes.push(e),this},r.prototype._removeVertexOutputNode=function(e){var t=this._vertexOutputNodes.indexOf(e);if(t!==-1)return this._vertexOutputNodes.splice(t,1),this},r.prototype._addFragmentOutputNode=function(e){if(this._fragmentOutputNodes.indexOf(e)===-1)return e.target=_.Fragment,this._fragmentOutputNodes.push(e),this},r.prototype._removeFragmentOutputNode=function(e){var t=this._fragmentOutputNodes.indexOf(e);if(t!==-1)return this._fragmentOutputNodes.splice(t,1),this},r.prototype.needAlphaBlending=function(){return this.ignoreAlpha?!1:this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending},r.prototype.needAlphaTesting=function(){return this._sharedData&&this._sharedData.hints.needAlphaTesting},r.prototype._initializeBlock=function(e,t,i,a){if(a===void 0&&(a=!0),e.initialize(t),a&&e.autoConfigure(this),e._preparationId=this._buildId,this.attachedBlocks.indexOf(e)===-1){if(e.isUnique)for(var o=e.getClassName(),s=0,u=this.attachedBlocks;s<u.length;s++){var l=u[s];if(l.getClassName()===o)throw"Cannot have multiple blocks of type ".concat(o," in the same NodeMaterial")}this.attachedBlocks.push(e)}for(var c=0,p=e.inputs;c<p.length;c++){var d=p[c];d.associatedVariableName="";var g=d.connectedPoint;if(g){var m=g.ownerBlock;m!==e&&((m.target===_.VertexAndFragment||t.target===_.Fragment&&m.target===_.Vertex&&m._preparationId!==this._buildId)&&i.push(m),this._initializeBlock(m,t,i,a))}}for(var y=0,v=e.outputs;y<v.length;y++){var T=v[y];T.associatedVariableName=""}},r.prototype._resetDualBlocks=function(e,t){e.target===_.VertexAndFragment&&(e.buildId=t);for(var i=0,a=e.inputs;i<a.length;i++){var o=a[i],s=o.connectedPoint;if(s){var u=s.ownerBlock;u!==e&&this._resetDualBlocks(u,t)}}},r.prototype.removeBlock=function(e){var t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)},r.prototype.build=function(e,t,i){e===void 0&&(e=!1),t===void 0&&(t=!0),i===void 0&&(i=!0),this._buildWasSuccessful=!1;var a=this.getScene().getEngine(),o=this._mode===me.Particle;if(this._vertexOutputNodes.length===0&&!o)throw"You must define at least one vertexOutputNode";if(this._fragmentOutputNodes.length===0)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new lr,this._vertexCompilationState.supportUniformBuffers=a.supportsUniformBuffers,this._vertexCompilationState.target=_.Vertex,this._fragmentCompilationState=new lr,this._fragmentCompilationState.supportUniformBuffers=a.supportsUniformBuffers,this._fragmentCompilationState.target=_.Fragment,this._sharedData=new Ci,this._sharedData.fragmentOutputNodes=this._fragmentOutputNodes,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=o;for(var s=[],u=[],l=0,c=this._vertexOutputNodes;l<c.length;l++){var p=c[l];s.push(p),this._initializeBlock(p,this._vertexCompilationState,u,i)}for(var d=0,g=this._fragmentOutputNodes;d<g.length;d++){var m=g[d];u.push(m),this._initializeBlock(m,this._fragmentCompilationState,s,i)}this.optimize();for(var y=0,v=s;y<v.length;y++){var p=v[y];p.build(this._vertexCompilationState,s)}this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(var T=0,x=u;T<x.length;T++){var m=x[T];this._resetDualBlocks(m,this._buildId-1)}for(var E=0,O=u;E<O.length;E++){var m=O[E];m.build(this._fragmentCompilationState,u)}this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=r._BuildIdGenerator++),this._sharedData.emitErrors(),e&&(console.log("Vertex shader:"),console.log(this._vertexCompilationState.compilationString),console.log("Fragment shader:"),console.log(this._fragmentCompilationState.compilationString)),this._buildWasSuccessful=!0,this.onBuildObservable.notifyObservers(this);for(var N=this.getScene().meshes,w=0,k=N;w<k.length;w++){var W=k[w];if(!!W.subMeshes)for(var Z=0,ie=W.subMeshes;Z<ie.length;Z++){var D=ie[Z];if(D.getMaterial()===this&&!!D.materialDefines){var ne=D.materialDefines;ne.markAllAsDirty(),ne.reset()}}}},r.prototype.optimize=function(){for(var e=0,t=this._optimizers;e<t.length;e++){var i=t[e];i.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}},r.prototype._prepareDefinesForAttributes=function(e,t){var i=t.NORMAL,a=t.TANGENT;t.NORMAL=e.isVerticesDataPresent(L.NormalKind),t.TANGENT=e.isVerticesDataPresent(L.TangentKind);for(var o=!1,s=1;s<=6;++s){var u=t["UV"+s];t["UV"+s]=e.isVerticesDataPresent("uv".concat(s===1?"":s)),o=o||t["UV"+s]!==u}(i!==t.NORMAL||a!==t.TANGENT||o)&&t.markAsAttributesDirty()},r.prototype.createPostProcess=function(e,t,i,a,o,s,u){return t===void 0&&(t=1),i===void 0&&(i=1),s===void 0&&(s=0),u===void 0&&(u=5),this.mode!==me.PostProcess?(console.log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,a,o,s,u)},r.prototype.createEffectForPostProcess=function(e){this._createEffectForPostProcess(e)},r.prototype._createEffectForPostProcess=function(e,t,i,a,o,s,u,l){var c=this;i===void 0&&(i=1),a===void 0&&(a=1),u===void 0&&(u=0),l===void 0&&(l=5);var p=this.name+this._buildId,d=new nt,g=new Nt(p+"PostProcess",this.getScene()),m=this._buildId;return this._processDefines(g,d),se.RegisterShader(p,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),e?e.updateEffect(d.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,p,p):e=new mi(this.name+"PostProcess",p,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,a,o,s,d.toString(),u,p,{maxSimultaneousLights:this.maxSimultaneousLights},!1,l),e.nodeMaterialSource=this,e.onApplyObservable.add(function(y){m!==c._buildId&&(delete se.ShadersStore[p+"VertexShader"],delete se.ShadersStore[p+"PixelShader"],p=c.name+c._buildId,d.markAllAsDirty(),m=c._buildId);var v=c._processDefines(g,d);v&&(se.RegisterShader(p,c._fragmentCompilationState._builtCompilationString,c._vertexCompilationState._builtCompilationString),ut.SetImmediate(function(){return e.updateEffect(d.toString(),c._fragmentCompilationState.uniforms,c._fragmentCompilationState.samplers,{maxSimultaneousLights:c.maxSimultaneousLights},void 0,void 0,p,p)})),c._checkInternals(y)}),e},r.prototype.createProceduralTexture=function(e,t){var i=this;if(this.mode!==me.ProceduralTexture)return console.log("Incompatible material mode"),null;var a=this.name+this._buildId,o=new ft(a,e,null,t),s=new Nt(a+"Procedural",this.getScene());s.reservedDataStore={hidden:!0};var u=new nt,l=this._processDefines(s,u);se.RegisterShader(a,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString);var c=this.getScene().getEngine().createEffect({vertexElement:a,fragmentElement:a},[L.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,u.toString(),l==null?void 0:l.fallbacks,void 0);o.nodeMaterialSource=this,o._setEffect(c);var p=this._buildId;return o.onBeforeGenerationObservable.add(function(){p!==i._buildId&&(delete se.ShadersStore[a+"VertexShader"],delete se.ShadersStore[a+"PixelShader"],a=i.name+i._buildId,u.markAllAsDirty(),p=i._buildId);var d=i._processDefines(s,u);d&&(se.RegisterShader(a,i._fragmentCompilationState._builtCompilationString,i._vertexCompilationState._builtCompilationString),ut.SetImmediate(function(){c=i.getScene().getEngine().createEffect({vertexElement:a,fragmentElement:a},[L.PositionKind],i._fragmentCompilationState.uniforms,i._fragmentCompilationState.samplers,u.toString(),d==null?void 0:d.fallbacks,void 0),o._setEffect(c)})),i._checkInternals(c)}),o},r.prototype._createEffectForParticles=function(e,t,i,a,o,s,u,l){var c=this;l===void 0&&(l="");var p=this.name+this._buildId+"_"+t;s||(s=new nt),u||(u=this.getScene().getMeshByName(this.name+"Particle"),u||(u=new Nt(this.name+"Particle",this.getScene()),u.reservedDataStore={hidden:!0}));var d=this._buildId,g=[],m=l;if(!o){var y=this._processDefines(u,s);se.RegisterShader(p,this._fragmentCompilationState._builtCompilationString),e.fillDefines(g,t),m=g.join(`
`),o=this.getScene().getEngine().createEffectForParticles(p,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,s.toString()+`
`+m,y==null?void 0:y.fallbacks,i,a,e),e.setCustomEffect(o,t)}o.onBindObservable.add(function(v){d!==c._buildId&&(delete se.ShadersStore[p+"PixelShader"],p=c.name+c._buildId+"_"+t,s.markAllAsDirty(),d=c._buildId),g.length=0,e.fillDefines(g,t);var T=g.join(`
`);T!==m&&(s.markAllAsDirty(),m=T);var x=c._processDefines(u,s);if(x){se.RegisterShader(p,c._fragmentCompilationState._builtCompilationString),v=c.getScene().getEngine().createEffectForParticles(p,c._fragmentCompilationState.uniforms,c._fragmentCompilationState.samplers,s.toString()+`
`+m,x==null?void 0:x.fallbacks,i,a,e),e.setCustomEffect(v,t),c._createEffectForParticles(e,t,i,a,v,s,u,l);return}c._checkInternals(v)})},r.prototype._checkInternals=function(e){if(this._sharedData.animatedInputs){var t=this.getScene(),i=t.getFrameId();if(this._animationFrame!==i){for(var a=0,o=this._sharedData.animatedInputs;a<o.length;a++){var s=o[a];s.animate(t)}this._animationFrame=i}}for(var u=0,l=this._sharedData.bindableBlocks;u<l.length;u++){var c=l[u];c.bind(e,this)}for(var p=0,d=this._sharedData.inputBlocks;p<d.length;p++){var g=d[p];g._transmit(e,this.getScene(),this)}},r.prototype.createEffectForParticles=function(e,t,i){if(this.mode!==me.Particle){console.log("Incompatible material mode");return}this._createEffectForParticles(e,sr.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,sr.BLENDMODE_MULTIPLY,t,i)},r.prototype.createAsShadowDepthWrapper=function(e){if(this.mode!==me.Material){console.log("Incompatible material mode");return}e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene())},r.prototype._processDefines=function(e,t,i,a){var o=this;i===void 0&&(i=!1);var s=null;if(this._sharedData.blocksWithDefines.forEach(function(g){g.initializeDefines(e,o,t,i)}),this._sharedData.blocksWithDefines.forEach(function(g){g.prepareDefines(e,o,t,i,a)}),t.isDirty){var u=t._areLightsDisposed;t.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach(function(g){g.replaceRepeatableContent(o._vertexCompilationState,o._fragmentCompilationState,e,t)});var l=[];this._sharedData.dynamicUniformBlocks.forEach(function(g){g.updateUniformsAndSamples(o._vertexCompilationState,o,t,l)});var c=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach(function(g){var m=c.indexOf(g);m===-1&&c.push(g)});var p=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach(function(g){var m=p.indexOf(g);m===-1&&p.push(g)});var d=new $e;this._sharedData.blocksWithFallbacks.forEach(function(g){g.provideFallbacks(e,d)}),s={lightDisposed:u,uniformBuffers:l,mergedUniforms:c,mergedSamplers:p,fallbacks:d}}return s},r.prototype.isReadyForSubMesh=function(e,t,i){var a=this;if(i===void 0&&(i=!1),!this._buildWasSuccessful)return!1;var o=this.getScene();if(this._sharedData.animatedInputs){var s=o.getFrameId();if(this._animationFrame!==s){for(var u=0,l=this._sharedData.animatedInputs;u<l.length;u++){var c=l[u];c.animate(o)}this._animationFrame=s}}if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new nt);var p=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;var d=o.getEngine();if(this._prepareDefinesForAttributes(e,p),this._sharedData.blockingBlocks.some(function(T){return!T.isReady(e,a,p,i)}))return!1;var g=this._processDefines(e,p,i,t);if(g){var m=t.effect,y=p.toString(),v=d.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:g.mergedUniforms,uniformBuffersNames:g.uniformBuffers,samplers:g.mergedSamplers,defines:y,fallbacks:g.fallbacks,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:p.NUM_MORPH_INFLUENCERS}},d);if(v)if(this._onEffectCreatedObservable&&(Ft.effect=v,Ft.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Ft)),this.allowShaderHotSwapping&&m&&!v.isReady()){if(v=m,p.markAsUnprocessed(),g.lightDisposed)return p._areLightsDisposed=!0,!1}else o.resetCachedMaterial(),t.setEffect(v,p,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(p._renderId=o.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,!0)},Object.defineProperty(r.prototype,"compiledShaders",{get:function(){return`// Vertex shader\r
`.concat(this._vertexCompilationState.compilationString,`\r
\r
// Fragment shader\r
`).concat(this._fragmentCompilationState.compilationString)},enumerable:!1,configurable:!0}),r.prototype.bindOnlyWorldMatrix=function(e){var t=this.getScene();if(!!this._activeEffect){var i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(var a=0,o=this._sharedData.inputBlocks;a<o.length;a++){var s=o[a];s._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}}},r.prototype.bindForSubMesh=function(e,t,i){var a=this.getScene(),o=i.effect;if(!!o){this._activeEffect=o,this.bindOnlyWorldMatrix(e);var s=this._mustRebind(a,o,t.visibility),u=this._sharedData;if(s){for(var l=0,c=u.bindableBlocks;l<c.length;l++){var p=c[l];p.bind(o,this,t,i)}for(var d=0,g=u.forcedBindableBlocks;d<g.length;d++){var p=g[d];p.bind(o,this,t,i)}for(var m=0,y=u.inputBlocks;m<y.length;m++){var v=y[m];v._transmit(o,a,this)}}else if(!this.isFrozen)for(var T=0,x=u.forcedBindableBlocks;T<x.length;T++){var p=x[T];p.bind(o,this,t,i)}this._afterBind(t,this._activeEffect)}},r.prototype.getActiveTextures=function(){var e=n.prototype.getActiveTextures.call(this);return this._sharedData&&e.push.apply(e,this._sharedData.textureBlocks.filter(function(t){return t.texture}).map(function(t){return t.texture})),e},r.prototype.getTextureBlocks=function(){return this._sharedData?this._sharedData.textureBlocks:[]},r.prototype.hasTexture=function(e){if(n.prototype.hasTexture.call(this,e))return!0;if(!this._sharedData)return!1;for(var t=0,i=this._sharedData.textureBlocks;t<i.length;t++){var a=i[t];if(a.texture===e)return!0}return!1},r.prototype.dispose=function(e,t,i){if(t)for(var a=0,o=this.getTextureBlocks().filter(function(p){return p.texture}).map(function(p){return p.texture});a<o.length;a++){var s=o[a];s.dispose()}for(var u=0,l=this.attachedBlocks;u<l.length;u++){var c=l[u];c.dispose()}this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),n.prototype.dispose.call(this,e,t,i)},r.prototype._createNodeEditor=function(){this.BJSNODEMATERIALEDITOR.NodeEditor.Show({nodeMaterial:this})},r.prototype.edit=function(e){var t=this;return new Promise(function(i){if(t.BJSNODEMATERIALEDITOR=t.BJSNODEMATERIALEDITOR||t._getGlobalNodeMaterialEditor(),typeof t.BJSNODEMATERIALEDITOR=="undefined"){var a=e&&e.editorURL?e.editorURL:r.EditorURL;ae.LoadScript(a,function(){t.BJSNODEMATERIALEDITOR=t.BJSNODEMATERIALEDITOR||t._getGlobalNodeMaterialEditor(),t._createNodeEditor(),i()})}else t._createNodeEditor(),i()})},r.prototype.clear=function(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0},r.prototype.setToDefault=function(){this.clear(),this.editorData=null;var e=new B("Position");e.setAsAttribute("position");var t=new B("World");t.setAsSystemValue(V.World);var i=new kt("WorldPos");e.connectTo(i),t.connectTo(i);var a=new B("ViewProjection");a.setAsSystemValue(V.ViewProjection);var o=new kt("WorldPos * ViewProjectionTransform");i.connectTo(o),a.connectTo(o);var s=new ot("VertexOutput");o.connectTo(s);var u=new B("color");u.value=new ve(.8,.8,.8,1);var l=new Xe("FragmentOutput");u.connectTo(l),this.addOutputNode(s),this.addOutputNode(l),this._mode=me.Material},r.prototype.setToDefaultPostProcess=function(){this.clear(),this.editorData=null;var e=new B("Position");e.setAsAttribute("position2d");var t=new B("Constant1");t.isConstant=!0,t.value=1;var i=new st("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});var a=new ot("VertexOutput");i.connectTo(a);var o=new B("Scale");o.visibleInInspector=!0,o.value=new Te(1,1);var s=new Tr("uv0");e.connectTo(s);var u=new Ut("UV scale");s.connectTo(u),o.connectTo(u);var l=new gr("CurrentScreen");u.connectTo(l),l.texture=new I("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());var c=new Xe("FragmentOutput");l.connectTo(c,{output:"rgba"}),this.addOutputNode(a),this.addOutputNode(c),this._mode=me.PostProcess},r.prototype.setToDefaultProceduralTexture=function(){this.clear(),this.editorData=null;var e=new B("Position");e.setAsAttribute("position2d");var t=new B("Constant1");t.isConstant=!0,t.value=1;var i=new st("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});var a=new ot("VertexOutput");i.connectTo(a);var o=new B("Time");o.value=0,o.min=0,o.max=0,o.isBoolean=!1,o.matrixMode=0,o.animationType=Be.Time,o.isConstant=!1;var s=new B("Color3");s.value=new G(1,1,1),s.isConstant=!1;var u=new Xe("FragmentOutput"),l=new st("VectorMerger");l.visibleInInspector=!1;var c=new Er("Cos");c.operation=re.Cos,e.connectTo(l),o.output.connectTo(c.input),c.output.connectTo(l.z),l.xyzOut.connectTo(u.rgb),this.addOutputNode(a),this.addOutputNode(u),this._mode=me.ProceduralTexture},r.prototype.setToDefaultParticle=function(){this.clear(),this.editorData=null;var e=new B("uv");e.setAsAttribute("particle_uv");var t=new vr("ParticleTexture");e.connectTo(t);var i=new B("Color");i.setAsAttribute("particle_color");var a=new Ut("Texture * Color");t.connectTo(a),i.connectTo(a);var o=new br("ParticleRampGradient");a.connectTo(o);var s=new Sr("ColorSplitter");i.connectTo(s);var u=new yr("ParticleBlendMultiply");o.connectTo(u),t.connectTo(u,{output:"a"}),s.connectTo(u,{output:"a"});var l=new Xe("FragmentOutput");u.connectTo(l),this.addOutputNode(l),this._mode=me.Particle},r.prototype.loadAsync=function(e,t){return t===void 0&&(t=""),er(this,void 0,void 0,function(){return tr(this,function(i){return[2,r.ParseFromFileAsync("",e,this.getScene(),t,!0,this)]})})},r.prototype._gatherBlocks=function(e,t){if(t.indexOf(e)===-1){t.push(e);for(var i=0,a=e.inputs;i<a.length;i++){var o=a[i],s=o.connectedPoint;if(s){var u=s.ownerBlock;u!==e&&this._gatherBlocks(u,t)}}}},r.prototype.generateCode=function(){for(var e=[],t=[],i=["const","var","let"],a=0,o=this._vertexOutputNodes;a<o.length;a++){var s=o[a];this._gatherBlocks(s,t)}for(var u=[],l=0,c=this._fragmentOutputNodes;l<c.length;l++){var s=c[l];this._gatherBlocks(s,u)}for(var p='var nodeMaterial = new BABYLON.NodeMaterial("'.concat(this.name||"node material",`");\r
`),d=0,g=t;d<g.length;d++){var m=g[d];m.isInput&&e.indexOf(m)===-1&&(p+=m._dumpCode(i,e))}for(var y=0,v=u;y<v.length;y++){var m=v[y];m.isInput&&e.indexOf(m)===-1&&(p+=m._dumpCode(i,e))}e=[],p+=`\r
// Connections\r
`;for(var T=0,x=this._vertexOutputNodes;T<x.length;T++){var m=x[T];p+=m._dumpCodeForOutputConnections(e)}for(var E=0,O=this._fragmentOutputNodes;E<O.length;E++){var m=O[E];p+=m._dumpCodeForOutputConnections(e)}p+=`\r
// Output nodes\r
`;for(var N=0,w=this._vertexOutputNodes;N<w.length;N++){var m=w[N];p+="nodeMaterial.addOutputNode(".concat(m._codeVariableName,`);\r
`)}for(var k=0,W=this._fragmentOutputNodes;k<W.length;k++){var m=W[k];p+="nodeMaterial.addOutputNode(".concat(m._codeVariableName,`);\r
`)}return p+=`nodeMaterial.build();\r
`,p},r.prototype.serialize=function(e){var t=e?{}:j.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));var i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(var a=0,o=this._vertexOutputNodes;a<o.length;a++){var s=o[a];this._gatherBlocks(s,i),t.outputNodes.push(s.uniqueId)}for(var u=0,l=this._fragmentOutputNodes;u<l.length;u++){var s=l[u];this._gatherBlocks(s,i),t.outputNodes.indexOf(s.uniqueId)===-1&&t.outputNodes.push(s.uniqueId)}}t.blocks=[];for(var c=0,p=i;c<p.length;c++){var d=p[c];t.blocks.push(d.serialize())}if(!e)for(var g=0,m=this.attachedBlocks;g<m.length;g++){var d=m[g];i.indexOf(d)===-1&&t.blocks.push(d.serialize())}return t},r.prototype._restoreConnections=function(e,t,i){for(var a=0,o=e.outputs;a<o.length;a++)for(var s=o[a],u=0,l=t.blocks;u<l.length;u++){var c=l[u],p=i[c.id];if(!!p)for(var d=0,g=c.inputs;d<g.length;d++){var m=g[d];if(i[m.targetBlockId]===e&&m.targetConnectionName===s.name){var y=p.getInputByName(m.inputName);if(!y||y.isConnected)continue;s.connectTo(y,!0),this._restoreConnections(p,t,i);continue}}}},r.prototype.parseSerializedObject=function(e,t,i){var a;t===void 0&&(t=""),i===void 0&&(i=!1),i||this.clear();for(var o={},s=0,u=e.blocks;s<u.length;s++){var l=u[s],c=Qe(l.customType);if(c){var p=new c;p._deserialize(l,this.getScene(),t),o[l.id]=p,this.attachedBlocks.push(p)}}for(var d=0;d<e.blocks.length;d++){var l=e.blocks[d],p=o[l.id];!p||p.inputs.length&&!i||this._restoreConnections(p,e,o)}if(e.outputNodes)for(var g=0,m=e.outputNodes;g<m.length;g++){var y=m[g];this.addOutputNode(o[y])}if(e.locations||e.editorData&&e.editorData.locations){for(var v=e.locations||e.editorData.locations,T=0,x=v;T<x.length;T++){var E=x[T];o[E.blockId]&&(E.blockId=o[E.blockId].uniqueId)}i&&this.editorData&&this.editorData.locations&&v.concat(this.editorData.locations),e.locations?this.editorData={locations:v}:(this.editorData=e.editorData,this.editorData.locations=v);var O=[];for(var N in o)O[N]=o[N].uniqueId;this.editorData.map=O}this.comment=e.comment,e.forceAlphaBlending!==void 0&&(this.forceAlphaBlending=e.forceAlphaBlending),i||(this._mode=(a=e.mode)!==null&&a!==void 0?a:me.Material)},r.prototype.loadFromSerialization=function(e,t,i){t===void 0&&(t=""),i===void 0&&(i=!1),this.parseSerializedObject(e,t,i)},r.prototype.clone=function(e,t){var i=this;t===void 0&&(t=!1);var a=this.serialize(),o=j.Clone(function(){return new r(e,i.getScene(),i.options)},this);return o.id=e,o.name=e,o.parseSerializedObject(a),o._buildId=this._buildId,o.build(!1,!t),o},r.Parse=function(e,t,i){i===void 0&&(i="");var a=j.Parse(function(){return new r(e.name,t)},e,t,i);return a.parseSerializedObject(e,i),a.build(),a},r.ParseFromFileAsync=function(e,t,i,a,o,s){return a===void 0&&(a=""),o===void 0&&(o=!1),er(this,void 0,void 0,function(){var u,l,c;return tr(this,function(p){switch(p.label){case 0:return u=s!=null?s:new r(e,i),[4,i._loadFileAsync(t)];case 1:return l=p.sent(),c=JSON.parse(l),u.parseSerializedObject(c,a),o||u.build(),[2,u]}})})},r.ParseFromSnippetAsync=function(e,t,i,a,o){var s=this;return t===void 0&&(t=de.LastCreatedScene),i===void 0&&(i=""),o===void 0&&(o=!1),e==="_BLANK"?Promise.resolve(r.CreateDefault("blank",t)):new Promise(function(u,l){var c=new lt;c.addEventListener("readystatechange",function(){if(c.readyState==4)if(c.status==200){var p=JSON.parse(JSON.parse(c.responseText).jsonPayload),d=JSON.parse(p.nodeMaterial);a||(a=j.Parse(function(){return new r(e,t)},d,t,i),a.uniqueId=t.getUniqueId()),a.parseSerializedObject(d),a.snippetId=e;try{o||a.build(),u(a)}catch(g){l(g)}}else l("Unable to load the snippet "+e)}),c.open("GET",s.SnippetUrl+"/"+e.replace(/#/g,"/")),c.send()})},r.CreateDefault=function(e,t){var i=new r(e,t);return i.setToDefault(),i.build(),i},r._BuildIdGenerator=0,r.EditorURL="https://unpkg.com/babylonjs-node-editor@".concat(Q.Version,"/babylon.nodeEditor.js"),r.SnippetUrl="https://snippet.babylonjs.com",r.IgnoreTexturesAtLoadTime=!1,h([b()],r.prototype,"ignoreAlpha",void 0),h([b()],r.prototype,"maxSimultaneousLights",void 0),h([b("mode")],r.prototype,"_mode",void 0),h([b("comment")],r.prototype,"comment",void 0),h([b()],r.prototype,"forceAlphaBlending",void 0),r}(Je);P("BABYLON.NodeMaterial",Kt);var Va=function(n){A(r,n);function r(e,t){t===void 0&&(t=512);var i=n.call(this,"multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0)||this;return i._renderTarget=i.getScene().getEngine().createMultiviewRenderTargetTexture(i.getRenderWidth(),i.getRenderHeight()),i._texture=i._renderTarget.texture,i._texture.isMultiview=!0,i._texture.format=5,i.samples=i._getEngine().getCaps().maxSamples||i.samples,i._texture.samples=i._samples,i}return Object.defineProperty(r.prototype,"samples",{set:function(e){this._samples=e},enumerable:!1,configurable:!0}),r.prototype._bindFrameBuffer=function(){!this._renderTarget||this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)},r.prototype.getViewCount=function(){return 2},r}(Ve),Ge=function(){function n(){this.previousWorldMatrices={},this.previousBones={}}return n.AddUniforms=function(r){r.push("previousWorld","previousViewProjection","mPreviousBones")},n.AddSamplers=function(r){},n.prototype.bindForSubMesh=function(r,e,t,i,a){if(e.prePassRenderer&&e.prePassRenderer.enabled&&e.prePassRenderer.currentRTisSceneRT&&e.prePassRenderer.getIndex(2)!==-1){this.previousWorldMatrices[t.uniqueId]||(this.previousWorldMatrices[t.uniqueId]=i.clone()),this.previousViewProjection||(this.previousViewProjection=e.getTransformMatrix().clone(),this.currentViewProjection=e.getTransformMatrix().clone());var o=e.getEngine();this.currentViewProjection.updateFlag!==e.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=o.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(e.getTransformMatrix())):this._lastUpdateFrameId!==o.frameId&&(this._lastUpdateFrameId=o.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),r.setMatrix("previousWorld",this.previousWorldMatrices[t.uniqueId]),r.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[t.uniqueId]=i.clone()}},n}(),R=function(){function n(){}return Object.defineProperty(n,"DiffuseTextureEnabled",{get:function(){return this._DiffuseTextureEnabled},set:function(r){this._DiffuseTextureEnabled!==r&&(this._DiffuseTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"DetailTextureEnabled",{get:function(){return this._DetailTextureEnabled},set:function(r){this._DetailTextureEnabled!==r&&(this._DetailTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"AmbientTextureEnabled",{get:function(){return this._AmbientTextureEnabled},set:function(r){this._AmbientTextureEnabled!==r&&(this._AmbientTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"OpacityTextureEnabled",{get:function(){return this._OpacityTextureEnabled},set:function(r){this._OpacityTextureEnabled!==r&&(this._OpacityTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"ReflectionTextureEnabled",{get:function(){return this._ReflectionTextureEnabled},set:function(r){this._ReflectionTextureEnabled!==r&&(this._ReflectionTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"EmissiveTextureEnabled",{get:function(){return this._EmissiveTextureEnabled},set:function(r){this._EmissiveTextureEnabled!==r&&(this._EmissiveTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"SpecularTextureEnabled",{get:function(){return this._SpecularTextureEnabled},set:function(r){this._SpecularTextureEnabled!==r&&(this._SpecularTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"BumpTextureEnabled",{get:function(){return this._BumpTextureEnabled},set:function(r){this._BumpTextureEnabled!==r&&(this._BumpTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"LightmapTextureEnabled",{get:function(){return this._LightmapTextureEnabled},set:function(r){this._LightmapTextureEnabled!==r&&(this._LightmapTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"RefractionTextureEnabled",{get:function(){return this._RefractionTextureEnabled},set:function(r){this._RefractionTextureEnabled!==r&&(this._RefractionTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"ColorGradingTextureEnabled",{get:function(){return this._ColorGradingTextureEnabled},set:function(r){this._ColorGradingTextureEnabled!==r&&(this._ColorGradingTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"FresnelEnabled",{get:function(){return this._FresnelEnabled},set:function(r){this._FresnelEnabled!==r&&(this._FresnelEnabled=r,Q.MarkAllMaterialsAsDirty(4))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"ClearCoatTextureEnabled",{get:function(){return this._ClearCoatTextureEnabled},set:function(r){this._ClearCoatTextureEnabled!==r&&(this._ClearCoatTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"ClearCoatBumpTextureEnabled",{get:function(){return this._ClearCoatBumpTextureEnabled},set:function(r){this._ClearCoatBumpTextureEnabled!==r&&(this._ClearCoatBumpTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"ClearCoatTintTextureEnabled",{get:function(){return this._ClearCoatTintTextureEnabled},set:function(r){this._ClearCoatTintTextureEnabled!==r&&(this._ClearCoatTintTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"SheenTextureEnabled",{get:function(){return this._SheenTextureEnabled},set:function(r){this._SheenTextureEnabled!==r&&(this._SheenTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"AnisotropicTextureEnabled",{get:function(){return this._AnisotropicTextureEnabled},set:function(r){this._AnisotropicTextureEnabled!==r&&(this._AnisotropicTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"ThicknessTextureEnabled",{get:function(){return this._ThicknessTextureEnabled},set:function(r){this._ThicknessTextureEnabled!==r&&(this._ThicknessTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"RefractionIntensityTextureEnabled",{get:function(){return this._ThicknessTextureEnabled},set:function(r){this._RefractionIntensityTextureEnabled!==r&&(this._RefractionIntensityTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"TranslucencyIntensityTextureEnabled",{get:function(){return this._ThicknessTextureEnabled},set:function(r){this._TranslucencyIntensityTextureEnabled!==r&&(this._TranslucencyIntensityTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(n,"IridescenceTextureEnabled",{get:function(){return this._IridescenceTextureEnabled},set:function(r){this._IridescenceTextureEnabled!==r&&(this._IridescenceTextureEnabled=r,Q.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),n._DiffuseTextureEnabled=!0,n._DetailTextureEnabled=!0,n._AmbientTextureEnabled=!0,n._OpacityTextureEnabled=!0,n._ReflectionTextureEnabled=!0,n._EmissiveTextureEnabled=!0,n._SpecularTextureEnabled=!0,n._BumpTextureEnabled=!0,n._LightmapTextureEnabled=!0,n._RefractionTextureEnabled=!0,n._ColorGradingTextureEnabled=!0,n._FresnelEnabled=!0,n._ClearCoatTextureEnabled=!0,n._ClearCoatBumpTextureEnabled=!0,n._ClearCoatTintTextureEnabled=!0,n._SheenTextureEnabled=!0,n._AnisotropicTextureEnabled=!0,n._ThicknessTextureEnabled=!0,n._RefractionIntensityTextureEnabled=!0,n._TranslucencyIntensityTextureEnabled=!0,n._IridescenceTextureEnabled=!0,n}(),Oi=function(){function n(r){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=r,this._scene=r.getScene(),this._engine=this._scene.getEngine()}return n.prototype._addPlugin=function(r){for(var e=0;e<this._plugins.length;++e)if(this._plugins[e].name===r.name)throw'Plugin "'.concat(r.name,'" already added to the material "').concat(this._material.name,'"!');if(this._material._uniformBufferLayoutBuilt)throw'The plugin "'.concat(r.name,`" can't be added to the material "`).concat(this._material.name,'" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.');var t=r.getClassName();n._MaterialPluginClassToMainDefine[t]||(n._MaterialPluginClassToMainDefine[t]="MATERIALPLUGIN_"+ ++n._MaterialPluginCounter),this._material._callbackPluginEventGeneric=this._handlePluginEvent.bind(this),this._plugins.push(r),this._plugins.sort(function(u,l){return u.priority-l.priority}),this._codeInjectionPoints={};var i={};i[n._MaterialPluginClassToMainDefine[t]]={type:"boolean",default:!0};for(var a=0,o=this._plugins;a<o.length;a++){var s=o[a];s.collectDefines(i),this._collectPointNames("vertex",s.getCustomCode("vertex")),this._collectPointNames("fragment",s.getCustomCode("fragment"))}this._defineNamesFromPlugins=i},n.prototype._activatePlugin=function(r){this._activePlugins.indexOf(r)===-1&&(this._activePlugins.push(r),this._activePlugins.sort(function(e,t){return e.priority-t.priority}),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),r.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(r),this._activePluginsForExtraEvents.sort(function(e,t){return e.priority-t.priority}),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))},n.prototype.getPlugin=function(r){for(var e=0;e<this._plugins.length;++e)if(this._plugins[e].name===r)return this._plugins[e];return null},n.prototype._handlePluginEventIsReadyForSubMesh=function(r){for(var e=!0,t=0,i=this._activePlugins;t<i.length;t++){var a=i[t];e=e&&a.isReadyForSubMesh(r.defines,this._scene,this._engine,r.subMesh)}r.isReadyForSubMesh=e},n.prototype._handlePluginEventPrepareDefinesBeforeAttributes=function(r){for(var e=0,t=this._activePlugins;e<t.length;e++){var i=t[e];i.prepareDefinesBeforeAttributes(r.defines,this._scene,r.mesh)}},n.prototype._handlePluginEventPrepareDefines=function(r){for(var e=0,t=this._activePlugins;e<t.length;e++){var i=t[e];i.prepareDefines(r.defines,this._scene,r.mesh)}},n.prototype._handlePluginEventHardBindForSubMesh=function(r){for(var e=0,t=this._activePluginsForExtraEvents;e<t.length;e++){var i=t[e];i.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,r.subMesh)}},n.prototype._handlePluginEventBindForSubMesh=function(r){for(var e=0,t=this._activePlugins;e<t.length;e++){var i=t[e];i.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,r.subMesh)}},n.prototype._handlePluginEventHasRenderTargetTextures=function(r){for(var e=!1,t=0,i=this._activePluginsForExtraEvents;t<i.length;t++){var a=i[t];if(e=a.hasRenderTargetTextures(),e)break}r.hasRenderTargetTextures=e},n.prototype._handlePluginEventFillRenderTargetTextures=function(r){for(var e=0,t=this._activePluginsForExtraEvents;e<t.length;e++){var i=t[e];i.fillRenderTargetTextures(r.renderTargets)}},n.prototype._handlePluginEvent=function(r,e){var t,i,a;switch(r){case ue.GetActiveTextures:{for(var o=e,s=0,u=this._activePlugins;s<u.length;s++){var l=u[s];l.getActiveTextures(o.activeTextures)}break}case ue.GetAnimatables:{for(var o=e,c=0,p=this._activePlugins;c<p.length;c++){var l=p[c];l.getAnimatables(o.animatables)}break}case ue.HasTexture:{for(var o=e,d=!1,g=0,m=this._activePlugins;g<m.length;g++){var l=m[g];if(d=l.hasTexture(o.texture),d)break}o.hasTexture=d;break}case ue.Disposed:{for(var o=e,y=0,v=this._plugins;y<v.length;y++){var l=v[y];l.dispose(o.forceDisposeTextures)}break}case ue.GetDefineNames:{var o=e;o.defineNames=this._defineNamesFromPlugins;break}case ue.PrepareEffect:{for(var o=e,T=0,x=this._activePlugins;T<x.length;T++){var l=x[T];o.fallbackRank=l.addFallbacks(o.defines,o.fallbacks,o.fallbackRank),l.getAttributes(o.attributes,this._scene,o.mesh)}this._uniformList.length>0&&(t=o.uniforms).push.apply(t,this._uniformList),this._samplerList.length>0&&(i=o.samplers).push.apply(i,this._samplerList),this._uboList.length>0&&(a=o.uniformBuffersNames).push.apply(a,this._uboList),o.customCode=this._injectCustomCode(o.customCode);break}case ue.PrepareUniformBuffer:{var o=e;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];for(var E=0,O=this._plugins;E<O.length;E++){var l=O[E],N=l.getUniforms();if(N){if(N.ubo)for(var w=0,k=N.ubo;w<k.length;w++){var W=k[w];o.ubo.addUniform(W.name,W.size),this._uboDeclaration+="".concat(W.type," ").concat(W.name,`;\r
`),this._uniformList.push(W.name)}N.vertex&&(this._vertexDeclaration+=N.vertex+`\r
`),N.fragment&&(this._fragmentDeclaration+=N.fragment+`\r
`)}l.getSamplers(this._samplerList),l.getUniformBuffersNames(this._uboList)}break}}},n.prototype._collectPointNames=function(r,e){if(!!e)for(var t in e)this._codeInjectionPoints[r]||(this._codeInjectionPoints[r]={}),this._codeInjectionPoints[r][t]=!0},n.prototype._injectCustomCode=function(r){var e=this;return function(t,i){var a;r&&(i=r(t,i)),e._uboDeclaration&&(i=i.replace("#define ADDITIONAL_UBO_DECLARATION",e._uboDeclaration)),e._vertexDeclaration&&(i=i.replace("#define ADDITIONAL_VERTEX_DECLARATION",e._vertexDeclaration)),e._fragmentDeclaration&&(i=i.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",e._fragmentDeclaration));var o=(a=e._codeInjectionPoints)===null||a===void 0?void 0:a[t];if(!o)return i;for(var s in o){for(var u="",l=0,c=e._activePlugins;l<c.length;l++){var p=c[l],d=p.getCustomCode(t);d!=null&&d[s]&&(u+=d[s]+`\r
`)}if(u.length>0)if(s.charAt(0)==="!")for(var g=new RegExp(s.substring(1),"g"),m=g.exec(i);m!==null;){for(var y=u,v=0;v<m.length;++v)y=y.replace("$"+v,m[v]);i=i.replace(m[0],y),m=g.exec(i)}else{var T="#define "+s;i=i.replace(T,`\r
`+u+`\r
`+T)}}return i}},n._MaterialPluginClassToMainDefine={},n._MaterialPluginCounter=0,n}(),we=function(){function n(r,e,t,i,a,o){a===void 0&&(a=!0),o===void 0&&(o=!1),this.priority=500,this.registerForExtraEvents=!1,this._material=r,this.name=e,this.priority=t,r.pluginManager||(r.pluginManager=new Oi(r)),this._pluginDefineNames=i,this._pluginManager=r.pluginManager,a&&this._pluginManager._addPlugin(this),o&&this._enable(!0),this.markAllDefinesAsDirty=r._dirtyCallbacks[63]}return n.prototype._enable=function(r){r&&this._pluginManager._activatePlugin(this)},n.prototype.getClassName=function(){return"MaterialPluginBase"},n.prototype.isReadyForSubMesh=function(r,e,t,i){return!0},n.prototype.hardBindForSubMesh=function(r,e,t,i){},n.prototype.bindForSubMesh=function(r,e,t,i){},n.prototype.dispose=function(r){},n.prototype.getCustomCode=function(r){return null},n.prototype.collectDefines=function(r){if(!!this._pluginDefineNames)for(var e=0,t=Object.keys(this._pluginDefineNames);e<t.length;e++){var i=t[e];if(i[0]!=="_"){var a=typeof this._pluginDefineNames[i];r[i]={type:a==="number"?"number":a==="string"?"string":a==="boolean"?"boolean":"object",default:this._pluginDefineNames[i]}}}},n.prototype.prepareDefinesBeforeAttributes=function(r,e,t){},n.prototype.prepareDefines=function(r,e,t){},n.prototype.hasTexture=function(r){return!1},n.prototype.hasRenderTargetTextures=function(){return!1},n.prototype.fillRenderTargetTextures=function(r){},n.prototype.getActiveTextures=function(r){},n.prototype.getAnimatables=function(r){},n.prototype.addFallbacks=function(r,e,t){return t},n.prototype.getSamplers=function(r){},n.prototype.getAttributes=function(r,e,t){},n.prototype.getUniformBuffersNames=function(r){},n.prototype.getUniforms=function(){return{}},n.prototype.copyTo=function(r){j.Clone(function(){return r},this)},n.prototype.serialize=function(){return j.Serialize(this)},n.prototype.parse=function(r,e,t){var i=this;j.Parse(function(){return i},r,e,t)},h([b()],n.prototype,"name",void 0),h([b()],n.prototype,"priority",void 0),h([b()],n.prototype,"registerForExtraEvents",void 0),n}(),Pi=function(n){A(r,n);function r(){var e=n!==null&&n.apply(this,arguments)||this;return e.DETAIL=!1,e.DETAILDIRECTUV=0,e.DETAIL_NORMALBLENDMETHOD=0,e}return r}(Ae),Ar=function(n){A(r,n);function r(e,t){t===void 0&&(t=!0);var i=n.call(this,e,"DetailMap",140,new Pi,t)||this;return i._texture=null,i.diffuseBlendLevel=1,i.roughnessBlendLevel=1,i.bumpLevel=1,i._normalBlendMethod=xe.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,i._isEnabled=!1,i.isEnabled=!1,i._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],i}return r.prototype._markAllSubMeshesAsTexturesDirty=function(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()},r.prototype.isReadyForSubMesh=function(e,t,i){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&R.DetailTextureEnabled&&!this._texture.isReady()):!0},r.prototype.prepareDefines=function(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;var i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&R.DetailTextureEnabled&&this._isEnabled?(C.PrepareDefinesForMergedUV(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1},r.prototype.bindForSubMesh=function(e,t){if(!!this._isEnabled){var i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&this._texture&&R.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),C.BindTextureMatrix(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&R.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture)}},r.prototype.hasTexture=function(e){return this._texture===e},r.prototype.getActiveTextures=function(e){this._texture&&e.push(this._texture)},r.prototype.getAnimatables=function(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)},r.prototype.dispose=function(e){var t;e&&((t=this._texture)===null||t===void 0||t.dispose())},r.prototype.getClassName=function(){return"DetailMapConfiguration"},r.prototype.getSamplers=function(e){e.push("detailSampler")},r.prototype.getUniforms=function(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}},h([U("detailTexture"),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"texture",void 0),h([b()],r.prototype,"diffuseBlendLevel",void 0),h([b()],r.prototype,"roughnessBlendLevel",void 0),h([b()],r.prototype,"bumpLevel",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"normalBlendMethod",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"isEnabled",void 0),r}(we),Mt={effect:null,subMesh:null},Ni=function(n){A(r,n);function r(e){var t=n.call(this,e)||this;return t.MAINUV1=!1,t.MAINUV2=!1,t.MAINUV3=!1,t.MAINUV4=!1,t.MAINUV5=!1,t.MAINUV6=!1,t.DIFFUSE=!1,t.DIFFUSEDIRECTUV=0,t.BAKED_VERTEX_ANIMATION_TEXTURE=!1,t.AMBIENT=!1,t.AMBIENTDIRECTUV=0,t.OPACITY=!1,t.OPACITYDIRECTUV=0,t.OPACITYRGB=!1,t.REFLECTION=!1,t.EMISSIVE=!1,t.EMISSIVEDIRECTUV=0,t.SPECULAR=!1,t.SPECULARDIRECTUV=0,t.BUMP=!1,t.BUMPDIRECTUV=0,t.PARALLAX=!1,t.PARALLAXOCCLUSION=!1,t.SPECULAROVERALPHA=!1,t.CLIPPLANE=!1,t.CLIPPLANE2=!1,t.CLIPPLANE3=!1,t.CLIPPLANE4=!1,t.CLIPPLANE5=!1,t.CLIPPLANE6=!1,t.ALPHATEST=!1,t.DEPTHPREPASS=!1,t.ALPHAFROMDIFFUSE=!1,t.POINTSIZE=!1,t.FOG=!1,t.SPECULARTERM=!1,t.DIFFUSEFRESNEL=!1,t.OPACITYFRESNEL=!1,t.REFLECTIONFRESNEL=!1,t.REFRACTIONFRESNEL=!1,t.EMISSIVEFRESNEL=!1,t.FRESNEL=!1,t.NORMAL=!1,t.TANGENT=!1,t.UV1=!1,t.UV2=!1,t.UV3=!1,t.UV4=!1,t.UV5=!1,t.UV6=!1,t.VERTEXCOLOR=!1,t.VERTEXALPHA=!1,t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,t.BONETEXTURE=!1,t.BONES_VELOCITY_ENABLED=!1,t.INSTANCES=!1,t.THIN_INSTANCES=!1,t.INSTANCESCOLOR=!1,t.GLOSSINESS=!1,t.ROUGHNESS=!1,t.EMISSIVEASILLUMINATION=!1,t.LINKEMISSIVEWITHDIFFUSE=!1,t.REFLECTIONFRESNELFROMSPECULAR=!1,t.LIGHTMAP=!1,t.LIGHTMAPDIRECTUV=0,t.OBJECTSPACE_NORMALMAP=!1,t.USELIGHTMAPASSHADOWMAP=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.INVERTCUBICMAP=!1,t.LOGARITHMICDEPTH=!1,t.REFRACTION=!1,t.REFRACTIONMAP_3D=!1,t.REFLECTIONOVERALPHA=!1,t.TWOSIDEDLIGHTING=!1,t.SHADOWFLOAT=!1,t.MORPHTARGETS=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_UV=!1,t.NUM_MORPH_INFLUENCERS=0,t.MORPHTARGETS_TEXTURE=!1,t.NONUNIFORMSCALING=!1,t.PREMULTIPLYALPHA=!1,t.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,t.ALPHABLEND=!0,t.PREPASS=!1,t.PREPASS_IRRADIANCE=!1,t.PREPASS_IRRADIANCE_INDEX=-1,t.PREPASS_ALBEDO_SQRT=!1,t.PREPASS_ALBEDO_SQRT_INDEX=-1,t.PREPASS_DEPTH=!1,t.PREPASS_DEPTH_INDEX=-1,t.PREPASS_NORMAL=!1,t.PREPASS_NORMAL_INDEX=-1,t.PREPASS_POSITION=!1,t.PREPASS_POSITION_INDEX=-1,t.PREPASS_VELOCITY=!1,t.PREPASS_VELOCITY_INDEX=-1,t.PREPASS_REFLECTIVITY=!1,t.PREPASS_REFLECTIVITY_INDEX=-1,t.SCENE_MRT_COUNT=0,t.RGBDLIGHTMAP=!1,t.RGBDREFLECTION=!1,t.RGBDREFRACTION=!1,t.IMAGEPROCESSING=!1,t.VIGNETTE=!1,t.VIGNETTEBLENDMODEMULTIPLY=!1,t.VIGNETTEBLENDMODEOPAQUE=!1,t.TONEMAPPING=!1,t.TONEMAPPING_ACES=!1,t.CONTRAST=!1,t.COLORCURVES=!1,t.COLORGRADING=!1,t.COLORGRADING3D=!1,t.SAMPLER3DGREENDEPTH=!1,t.SAMPLER3DBGRMAP=!1,t.IMAGEPROCESSINGPOSTPROCESS=!1,t.SKIPFINALCOLORCLAMP=!1,t.MULTIVIEW=!1,t.ORDER_INDEPENDENT_TRANSPARENCY=!1,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,t.IS_REFLECTION_LINEAR=!1,t.IS_REFRACTION_LINEAR=!1,t.EXPOSURE=!1,t.rebuild(),t}return r.prototype.setReflectionMode=function(e){for(var t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"],i=0,a=t;i<a.length;i++){var o=a[i];this[o]=o===e}},r}(Ae),Cr=function(n){A(r,n);function r(e,t){var i=n.call(this,e,t)||this;return i._diffuseTexture=null,i._ambientTexture=null,i._opacityTexture=null,i._reflectionTexture=null,i._emissiveTexture=null,i._specularTexture=null,i._bumpTexture=null,i._lightmapTexture=null,i._refractionTexture=null,i.ambientColor=new G(0,0,0),i.diffuseColor=new G(1,1,1),i.specularColor=new G(1,1,1),i.emissiveColor=new G(0,0,0),i.specularPower=64,i._useAlphaFromDiffuseTexture=!1,i._useEmissiveAsIllumination=!1,i._linkEmissiveWithDiffuse=!1,i._useSpecularOverAlpha=!1,i._useReflectionOverAlpha=!1,i._disableLighting=!1,i._useObjectSpaceNormalMap=!1,i._useParallax=!1,i._useParallaxOcclusion=!1,i.parallaxScaleBias=.05,i._roughness=0,i.indexOfRefraction=.98,i.invertRefractionY=!0,i.alphaCutOff=.4,i._useLightmapAsShadowmap=!1,i._useReflectionFresnelFromSpecular=!1,i._useGlossinessFromSpecularMapAlpha=!1,i._maxSimultaneousLights=4,i._invertNormalMapX=!1,i._invertNormalMapY=!1,i._twoSidedLighting=!1,i._renderTargets=new Yt(16),i._worldViewProjectionMatrix=q.Zero(),i._globalAmbientColor=new G(0,0,0),i._cacheHasRenderTargetTextures=!1,i.detailMap=new Ar(i),i._attachImageProcessingConfiguration(null),i.prePassConfiguration=new Ge,i.getRenderTargetTextures=function(){return i._renderTargets.reset(),r.ReflectionTextureEnabled&&i._reflectionTexture&&i._reflectionTexture.isRenderTarget&&i._renderTargets.push(i._reflectionTexture),r.RefractionTextureEnabled&&i._refractionTexture&&i._refractionTexture.isRenderTarget&&i._renderTargets.push(i._refractionTexture),i._eventInfo.renderTargets=i._renderTargets,i._callbackPluginEventFillRenderTargetTextures(i._eventInfo),i._renderTargets},i}return Object.defineProperty(r.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),r.prototype._attachImageProcessingConfiguration=function(e){var t=this;e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){t._markAllSubMeshesAsImageProcessingDirty()})))},Object.defineProperty(r.prototype,"isPrePassCapable",{get:function(){return!this.disableDepthWrite},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(e){this.imageProcessingConfiguration.colorCurvesEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(e){this.imageProcessingConfiguration.colorGradingEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(e){this._imageProcessingConfiguration.toneMappingEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(e){this._imageProcessingConfiguration.exposure=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(e){this._imageProcessingConfiguration.contrast=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(e){this._imageProcessingConfiguration.colorGradingTexture=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraColorCurves",{get:function(){return this._imageProcessingConfiguration.colorCurves},set:function(e){this._imageProcessingConfiguration.colorCurves=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"canRenderToMRT",{get:function(){return!0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasRenderTargetTextures",{get:function(){return r.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||r.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"StandardMaterial"},Object.defineProperty(r.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported,this._markAllSubMeshesAsMiscDirty()},enumerable:!1,configurable:!0}),r.prototype.needAlphaBlending=function(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled},r.prototype.needAlphaTesting=function(){return this._forceAlphaTest?!0:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===xe.MATERIAL_ALPHATEST)},r.prototype._shouldUseAlphaFromDiffuseTexture=function(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==xe.MATERIAL_OPAQUE},r.prototype._hasAlphaChannel=function(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._opacityTexture!=null},r.prototype.getAlphaTestTexture=function(){return this._diffuseTexture},r.prototype.isReadyForSubMesh=function(e,t,i){if(i===void 0&&(i=!1),this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(ue.GetDefineNames,this._eventInfo),t.materialDefines=new Ni(this._eventInfo.defineNames));var a=this.getScene(),o=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;var s=a.getEngine();o._needNormals=C.PrepareDefinesForLights(a,e,o,!0,this._maxSimultaneousLights,this._disableLighting),C.PrepareDefinesForMultiview(a,o);var u=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(C.PrepareDefinesForPrePass(a,o,this.canRenderToMRT&&!u),C.PrepareDefinesForOIT(a,o,u),o._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,o._needUVs=!1;for(var l=1;l<=6;++l)o["MAINUV"+l]=!1;if(a.texturesEnabled){if(o.DIFFUSEDIRECTUV=0,o.BUMPDIRECTUV=0,o.AMBIENTDIRECTUV=0,o.OPACITYDIRECTUV=0,o.EMISSIVEDIRECTUV=0,o.SPECULARDIRECTUV=0,o.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&r.DiffuseTextureEnabled)if(this._diffuseTexture.isReadyOrNotBlocking())C.PrepareDefinesForMergedUV(this._diffuseTexture,o,"DIFFUSE");else return!1;else o.DIFFUSE=!1;if(this._ambientTexture&&r.AmbientTextureEnabled)if(this._ambientTexture.isReadyOrNotBlocking())C.PrepareDefinesForMergedUV(this._ambientTexture,o,"AMBIENT");else return!1;else o.AMBIENT=!1;if(this._opacityTexture&&r.OpacityTextureEnabled)if(this._opacityTexture.isReadyOrNotBlocking())C.PrepareDefinesForMergedUV(this._opacityTexture,o,"OPACITY"),o.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;else return!1;else o.OPACITY=!1;if(this._reflectionTexture&&r.ReflectionTextureEnabled)if(this._reflectionTexture.isReadyOrNotBlocking()){switch(o._needNormals=!0,o.REFLECTION=!0,o.ROUGHNESS=this._roughness>0,o.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,o.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===I.INVCUBIC_MODE,o.REFLECTIONMAP_3D=this._reflectionTexture.isCube,o.REFLECTIONMAP_OPPOSITEZ=o.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,o.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case I.EXPLICIT_MODE:o.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case I.PLANAR_MODE:o.setReflectionMode("REFLECTIONMAP_PLANAR");break;case I.PROJECTION_MODE:o.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case I.SKYBOX_MODE:o.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case I.SPHERICAL_MODE:o.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case I.EQUIRECTANGULAR_MODE:o.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case I.FIXED_EQUIRECTANGULAR_MODE:o.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case I.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:o.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case I.CUBIC_MODE:case I.INVCUBIC_MODE:default:o.setReflectionMode("REFLECTIONMAP_CUBIC");break}o.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else return!1;else o.REFLECTION=!1,o.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&r.EmissiveTextureEnabled)if(this._emissiveTexture.isReadyOrNotBlocking())C.PrepareDefinesForMergedUV(this._emissiveTexture,o,"EMISSIVE");else return!1;else o.EMISSIVE=!1;if(this._lightmapTexture&&r.LightmapTextureEnabled)if(this._lightmapTexture.isReadyOrNotBlocking())C.PrepareDefinesForMergedUV(this._lightmapTexture,o,"LIGHTMAP"),o.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,o.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;else return!1;else o.LIGHTMAP=!1;if(this._specularTexture&&r.SpecularTextureEnabled)if(this._specularTexture.isReadyOrNotBlocking())C.PrepareDefinesForMergedUV(this._specularTexture,o,"SPECULAR"),o.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;else return!1;else o.SPECULAR=!1;if(a.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&r.BumpTextureEnabled){if(this._bumpTexture.isReady())C.PrepareDefinesForMergedUV(this._bumpTexture,o,"BUMP"),o.PARALLAX=this._useParallax,o.PARALLAXOCCLUSION=this._useParallaxOcclusion;else return!1;o.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else o.BUMP=!1,o.PARALLAX=!1,o.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&r.RefractionTextureEnabled)if(this._refractionTexture.isReadyOrNotBlocking())o._needUVs=!0,o.REFRACTION=!0,o.REFRACTIONMAP_3D=this._refractionTexture.isCube,o.RGBDREFRACTION=this._refractionTexture.isRGBD,o.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;else return!1;else o.REFRACTION=!1;o.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else o.DIFFUSE=!1,o.AMBIENT=!1,o.OPACITY=!1,o.REFLECTION=!1,o.EMISSIVE=!1,o.LIGHTMAP=!1,o.BUMP=!1,o.REFRACTION=!1;o.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),o.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,o.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,o.SPECULAROVERALPHA=this._useSpecularOverAlpha,o.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,o.ALPHATEST_AFTERALLALPHACOMPUTATIONS=this.transparencyMode!==null,o.ALPHABLEND=this.transparencyMode===null||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=o,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(o._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(o),o.IS_REFLECTION_LINEAR=this.reflectionTexture!=null&&!this.reflectionTexture.gammaSpace,o.IS_REFRACTION_LINEAR=this.refractionTexture!=null&&!this.refractionTexture.gammaSpace}if(o._areFresnelDirty&&(r.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(o.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,o.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,o.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,o.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,o.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,o.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,o._needNormals=!0,o.FRESNEL=!0):o.FRESNEL=!1),C.PrepareDefinesForMisc(e,a,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,o),C.PrepareDefinesForFrameBoundValues(a,s,o,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=o,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),C.PrepareDefinesForAttributes(e,o,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo),o.isDirty){var c=o._areLightsDisposed;o.markAsProcessed();var p=new $e;o.REFLECTION&&p.addFallback(0,"REFLECTION"),o.SPECULAR&&p.addFallback(0,"SPECULAR"),o.BUMP&&p.addFallback(0,"BUMP"),o.PARALLAX&&p.addFallback(1,"PARALLAX"),o.PARALLAXOCCLUSION&&p.addFallback(0,"PARALLAXOCCLUSION"),o.SPECULAROVERALPHA&&p.addFallback(0,"SPECULAROVERALPHA"),o.FOG&&p.addFallback(1,"FOG"),o.POINTSIZE&&p.addFallback(0,"POINTSIZE"),o.LOGARITHMICDEPTH&&p.addFallback(0,"LOGARITHMICDEPTH"),C.HandleFallbacksForShadows(o,p,this._maxSimultaneousLights),o.SPECULARTERM&&p.addFallback(0,"SPECULARTERM"),o.DIFFUSEFRESNEL&&p.addFallback(1,"DIFFUSEFRESNEL"),o.OPACITYFRESNEL&&p.addFallback(2,"OPACITYFRESNEL"),o.REFLECTIONFRESNEL&&p.addFallback(3,"REFLECTIONFRESNEL"),o.EMISSIVEFRESNEL&&p.addFallback(4,"EMISSIVEFRESNEL"),o.FRESNEL&&p.addFallback(4,"FRESNEL"),o.MULTIVIEW&&p.addFallback(0,"MULTIVIEW");var d=[L.PositionKind];o.NORMAL&&d.push(L.NormalKind),o.TANGENT&&d.push(L.TangentKind);for(var l=1;l<=6;++l)o["UV"+l]&&d.push("uv".concat(l===1?"":l));o.VERTEXCOLOR&&d.push(L.ColorKind),C.PrepareAttributesForBones(d,e,o,p),C.PrepareAttributesForInstances(d,o),C.PrepareAttributesForMorphTargets(d,e,o),C.PrepareAttributesForBakedVertexAnimation(d,e,o);var g="default",m=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],y=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],v=["Material","Scene","Mesh"];this._eventInfo.fallbacks=p,this._eventInfo.fallbackRank=0,this._eventInfo.defines=o,this._eventInfo.uniforms=m,this._eventInfo.attributes=d,this._eventInfo.samplers=y,this._eventInfo.uniformBuffersNames=v,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._callbackPluginEventGeneric(ue.PrepareEffect,this._eventInfo),Ge.AddUniforms(m),Ge.AddSamplers(y),Ie&&(Ie.PrepareUniforms(m,o),Ie.PrepareSamplers(y,o)),C.PrepareUniformsAndSamplersList({uniformsNames:m,uniformBuffersNames:v,samplers:y,defines:o,maxSimultaneousLights:this._maxSimultaneousLights});var T={};this.customShaderNameResolve&&(g=this.customShaderNameResolve(g,m,v,y,o,d,T));var x=o.toString(),E=t.effect,O=a.getEngine().createEffect(g,{attributes:d,uniformsNames:m,uniformBuffersNames:v,samplers:y,defines:x,fallbacks:p,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:o.NUM_MORPH_INFLUENCERS},processFinalCode:T.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:o.PREPASS},s);if(O)if(this._onEffectCreatedObservable&&(Mt.effect=O,Mt.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Mt)),this.allowShaderHotSwapping&&E&&!O.isReady()){if(O=E,o.markAsUnprocessed(),c)return o._areLightsDisposed=!0,!1}else a.resetCachedMaterial(),t.setEffect(O,o,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(o._renderId=a.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,!0)},r.prototype.buildUniformLayout=function(){var e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),n.prototype.buildUniformLayout.call(this)},r.prototype.bindForSubMesh=function(e,t,i){var a,o=this.getScene(),s=i.materialDefines;if(!!s){var u=i.effect;if(!!u){this._activeEffect=u,t.getMeshUniformBuffer().bindToEffect(u,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(u,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,o,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),s.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));var l=this._mustRebind(o,u,t.visibility);C.BindBonesParameters(t,u);var c=this._uniformBuffer;if(l){if(this.bindViewProjection(u),!c.useUbo||!this.isFrozen||!c.isSync){if(r.FresnelEnabled&&s.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(c.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),c.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&c.updateColor4("opacityParts",new G(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(c.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),c.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(c.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),c.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(c.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),c.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),o.texturesEnabled){if(this._diffuseTexture&&r.DiffuseTextureEnabled&&(c.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),C.BindTextureMatrix(this._diffuseTexture,c,"diffuse")),this._ambientTexture&&r.AmbientTextureEnabled&&(c.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),C.BindTextureMatrix(this._ambientTexture,c,"ambient")),this._opacityTexture&&r.OpacityTextureEnabled&&(c.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),C.BindTextureMatrix(this._opacityTexture,c,"opacity")),this._hasAlphaChannel()&&c.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&r.ReflectionTextureEnabled&&(c.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),c.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){var p=this._reflectionTexture;c.updateVector3("vReflectionPosition",p.boundingBoxPosition),c.updateVector3("vReflectionSize",p.boundingBoxSize)}if(this._emissiveTexture&&r.EmissiveTextureEnabled&&(c.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),C.BindTextureMatrix(this._emissiveTexture,c,"emissive")),this._lightmapTexture&&r.LightmapTextureEnabled&&(c.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),C.BindTextureMatrix(this._lightmapTexture,c,"lightmap")),this._specularTexture&&r.SpecularTextureEnabled&&(c.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),C.BindTextureMatrix(this._specularTexture,c,"specular")),this._bumpTexture&&o.getEngine().getCaps().standardDerivatives&&r.BumpTextureEnabled&&(c.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),C.BindTextureMatrix(this._bumpTexture,c,"bump"),o._mirroredCameraPosition?c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&r.RefractionTextureEnabled){var d=1;if(this._refractionTexture.isCube||(c.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(d=this._refractionTexture.depth)),c.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,d,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){var p=this._refractionTexture;c.updateVector3("vRefractionPosition",p.boundingBoxPosition),c.updateVector3("vRefractionSize",p.boundingBoxSize)}}}this.pointsCloud&&c.updateFloat("pointSize",this.pointSize),s.SPECULARTERM&&c.updateColor4("vSpecularColor",this.specularColor,this.specularPower),c.updateColor3("vEmissiveColor",r.EmissiveTextureEnabled?this.emissiveColor:G.BlackReadOnly),c.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),o.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),c.updateColor3("vAmbientColor",this._globalAmbientColor)}o.texturesEnabled&&(this._diffuseTexture&&r.DiffuseTextureEnabled&&u.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&r.AmbientTextureEnabled&&u.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&r.OpacityTextureEnabled&&u.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&r.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?u.setTexture("reflectionCubeSampler",this._reflectionTexture):u.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&r.EmissiveTextureEnabled&&u.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&r.LightmapTextureEnabled&&u.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&r.SpecularTextureEnabled&&u.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&o.getEngine().getCaps().standardDerivatives&&r.BumpTextureEnabled&&u.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&r.RefractionTextureEnabled&&(this._refractionTexture.isCube?u.setTexture("refractionCubeSampler",this._refractionTexture):u.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(u),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),C.BindClipPlane(u,o),this.bindEyePosition(u)}else o.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(l||!this.isFrozen)&&(o.lightsEnabled&&!this._disableLighting&&C.BindLights(o,t,u,s,this._maxSimultaneousLights),(o.fogEnabled&&t.applyFog&&o.fogMode!==Ke.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||s.PREPASS)&&this.bindView(u),C.BindFogParameters(o,t,u),s.NUM_MORPH_INFLUENCERS&&C.BindMorphTargetParameters(t,u),s.BAKED_VERTEX_ANIMATION_TEXTURE&&((a=t.bakedVertexAnimationManager)===null||a===void 0||a.bind(u,s.INSTANCES)),this.useLogarithmicDepth&&C.BindLogDepth(s,u,o),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),c.update()}}},r.prototype.getAnimatables=function(){var e=n.prototype.getAnimatables.call(this);return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e},r.prototype.getActiveTextures=function(){var e=n.prototype.getActiveTextures.call(this);return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e},r.prototype.hasTexture=function(e){return!!(n.prototype.hasTexture.call(this,e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e)},r.prototype.dispose=function(e,t){var i,a,o,s,u,l,c,p,d;t&&((i=this._diffuseTexture)===null||i===void 0||i.dispose(),(a=this._ambientTexture)===null||a===void 0||a.dispose(),(o=this._opacityTexture)===null||o===void 0||o.dispose(),(s=this._reflectionTexture)===null||s===void 0||s.dispose(),(u=this._emissiveTexture)===null||u===void 0||u.dispose(),(l=this._specularTexture)===null||l===void 0||l.dispose(),(c=this._bumpTexture)===null||c===void 0||c.dispose(),(p=this._lightmapTexture)===null||p===void 0||p.dispose(),(d=this._refractionTexture)===null||d===void 0||d.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),n.prototype.dispose.call(this,e,t)},r.prototype.clone=function(e){var t=this,i=j.Clone(function(){return new r(e,t.getScene())},this);return i.name=e,i.id=e,this.stencil.copyTo(i.stencil),i},r.Parse=function(e,t,i){var a=j.Parse(function(){return new r(e.name,t)},e,t,i);return e.stencil&&a.stencil.parse(e.stencil,t,i),a},Object.defineProperty(r,"DiffuseTextureEnabled",{get:function(){return R.DiffuseTextureEnabled},set:function(e){R.DiffuseTextureEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"DetailTextureEnabled",{get:function(){return R.DetailTextureEnabled},set:function(e){R.DetailTextureEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"AmbientTextureEnabled",{get:function(){return R.AmbientTextureEnabled},set:function(e){R.AmbientTextureEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"OpacityTextureEnabled",{get:function(){return R.OpacityTextureEnabled},set:function(e){R.OpacityTextureEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"ReflectionTextureEnabled",{get:function(){return R.ReflectionTextureEnabled},set:function(e){R.ReflectionTextureEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"EmissiveTextureEnabled",{get:function(){return R.EmissiveTextureEnabled},set:function(e){R.EmissiveTextureEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"SpecularTextureEnabled",{get:function(){return R.SpecularTextureEnabled},set:function(e){R.SpecularTextureEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"BumpTextureEnabled",{get:function(){return R.BumpTextureEnabled},set:function(e){R.BumpTextureEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"LightmapTextureEnabled",{get:function(){return R.LightmapTextureEnabled},set:function(e){R.LightmapTextureEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"RefractionTextureEnabled",{get:function(){return R.RefractionTextureEnabled},set:function(e){R.RefractionTextureEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"ColorGradingTextureEnabled",{get:function(){return R.ColorGradingTextureEnabled},set:function(e){R.ColorGradingTextureEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r,"FresnelEnabled",{get:function(){return R.FresnelEnabled},set:function(e){R.FresnelEnabled=e},enumerable:!1,configurable:!0}),h([U("diffuseTexture")],r.prototype,"_diffuseTexture",void 0),h([S("_markAllSubMeshesAsTexturesAndMiscDirty")],r.prototype,"diffuseTexture",void 0),h([U("ambientTexture")],r.prototype,"_ambientTexture",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"ambientTexture",void 0),h([U("opacityTexture")],r.prototype,"_opacityTexture",void 0),h([S("_markAllSubMeshesAsTexturesAndMiscDirty")],r.prototype,"opacityTexture",void 0),h([U("reflectionTexture")],r.prototype,"_reflectionTexture",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionTexture",void 0),h([U("emissiveTexture")],r.prototype,"_emissiveTexture",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"emissiveTexture",void 0),h([U("specularTexture")],r.prototype,"_specularTexture",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"specularTexture",void 0),h([U("bumpTexture")],r.prototype,"_bumpTexture",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"bumpTexture",void 0),h([U("lightmapTexture")],r.prototype,"_lightmapTexture",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"lightmapTexture",void 0),h([U("refractionTexture")],r.prototype,"_refractionTexture",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"refractionTexture",void 0),h([le("ambient")],r.prototype,"ambientColor",void 0),h([le("diffuse")],r.prototype,"diffuseColor",void 0),h([le("specular")],r.prototype,"specularColor",void 0),h([le("emissive")],r.prototype,"emissiveColor",void 0),h([b()],r.prototype,"specularPower",void 0),h([b("useAlphaFromDiffuseTexture")],r.prototype,"_useAlphaFromDiffuseTexture",void 0),h([S("_markAllSubMeshesAsTexturesAndMiscDirty")],r.prototype,"useAlphaFromDiffuseTexture",void 0),h([b("useEmissiveAsIllumination")],r.prototype,"_useEmissiveAsIllumination",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useEmissiveAsIllumination",void 0),h([b("linkEmissiveWithDiffuse")],r.prototype,"_linkEmissiveWithDiffuse",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"linkEmissiveWithDiffuse",void 0),h([b("useSpecularOverAlpha")],r.prototype,"_useSpecularOverAlpha",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useSpecularOverAlpha",void 0),h([b("useReflectionOverAlpha")],r.prototype,"_useReflectionOverAlpha",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useReflectionOverAlpha",void 0),h([b("disableLighting")],r.prototype,"_disableLighting",void 0),h([S("_markAllSubMeshesAsLightsDirty")],r.prototype,"disableLighting",void 0),h([b("useObjectSpaceNormalMap")],r.prototype,"_useObjectSpaceNormalMap",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useObjectSpaceNormalMap",void 0),h([b("useParallax")],r.prototype,"_useParallax",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useParallax",void 0),h([b("useParallaxOcclusion")],r.prototype,"_useParallaxOcclusion",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useParallaxOcclusion",void 0),h([b()],r.prototype,"parallaxScaleBias",void 0),h([b("roughness")],r.prototype,"_roughness",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"roughness",void 0),h([b()],r.prototype,"indexOfRefraction",void 0),h([b()],r.prototype,"invertRefractionY",void 0),h([b()],r.prototype,"alphaCutOff",void 0),h([b("useLightmapAsShadowmap")],r.prototype,"_useLightmapAsShadowmap",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useLightmapAsShadowmap",void 0),h([We("diffuseFresnelParameters")],r.prototype,"_diffuseFresnelParameters",void 0),h([S("_markAllSubMeshesAsFresnelDirty")],r.prototype,"diffuseFresnelParameters",void 0),h([We("opacityFresnelParameters")],r.prototype,"_opacityFresnelParameters",void 0),h([S("_markAllSubMeshesAsFresnelAndMiscDirty")],r.prototype,"opacityFresnelParameters",void 0),h([We("reflectionFresnelParameters")],r.prototype,"_reflectionFresnelParameters",void 0),h([S("_markAllSubMeshesAsFresnelDirty")],r.prototype,"reflectionFresnelParameters",void 0),h([We("refractionFresnelParameters")],r.prototype,"_refractionFresnelParameters",void 0),h([S("_markAllSubMeshesAsFresnelDirty")],r.prototype,"refractionFresnelParameters",void 0),h([We("emissiveFresnelParameters")],r.prototype,"_emissiveFresnelParameters",void 0),h([S("_markAllSubMeshesAsFresnelDirty")],r.prototype,"emissiveFresnelParameters",void 0),h([b("useReflectionFresnelFromSpecular")],r.prototype,"_useReflectionFresnelFromSpecular",void 0),h([S("_markAllSubMeshesAsFresnelDirty")],r.prototype,"useReflectionFresnelFromSpecular",void 0),h([b("useGlossinessFromSpecularMapAlpha")],r.prototype,"_useGlossinessFromSpecularMapAlpha",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useGlossinessFromSpecularMapAlpha",void 0),h([b("maxSimultaneousLights")],r.prototype,"_maxSimultaneousLights",void 0),h([S("_markAllSubMeshesAsLightsDirty")],r.prototype,"maxSimultaneousLights",void 0),h([b("invertNormalMapX")],r.prototype,"_invertNormalMapX",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"invertNormalMapX",void 0),h([b("invertNormalMapY")],r.prototype,"_invertNormalMapY",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"invertNormalMapY",void 0),h([b("twoSidedLighting")],r.prototype,"_twoSidedLighting",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"twoSidedLighting",void 0),h([b()],r.prototype,"useLogarithmicDepth",null),r}(Je);P("BABYLON.StandardMaterial",Cr);Ke.DefaultMaterialFactory=function(n){return new Cr("default material",n)};var wa=function(n){A(r,n);function r(e,t,i,a,o,s,u){i===void 0&&(i=null),a===void 0&&(a=!1),o===void 0&&(o=3),s===void 0&&(s=5);var l=n.call(this,null,i,!a,u,o,void 0,void 0,void 0,void 0,s)||this;l.name=e,l.wrapU=I.CLAMP_ADDRESSMODE,l.wrapV=I.CLAMP_ADDRESSMODE,l._generateMipMaps=a;var c=l._getEngine();if(!c)return l;t.getContext?(l._canvas=t,l._texture=c.createDynamicTexture(t.width,t.height,a,o)):(l._canvas=c.createCanvas(1,1),t.width||t.width===0?l._texture=c.createDynamicTexture(t.width,t.height,a,o):l._texture=c.createDynamicTexture(t,t,a,o));var p=l.getSize();return l._canvas.width!==p.width&&(l._canvas.width=p.width),l._canvas.height!==p.height&&(l._canvas.height=p.height),l._context=l._canvas.getContext("2d"),l}return r.prototype.getClassName=function(){return"DynamicTexture"},Object.defineProperty(r.prototype,"canRescale",{get:function(){return!0},enumerable:!1,configurable:!0}),r.prototype._recreate=function(e){this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this.samplingMode)},r.prototype.scale=function(e){var t=this.getSize();t.width*=e,t.height*=e,this._recreate(t)},r.prototype.scaleTo=function(e,t){var i=this.getSize();i.width=e,i.height=t,this._recreate(i)},r.prototype.getContext=function(){return this._context},r.prototype.clear=function(){var e=this.getSize();this._context.fillRect(0,0,e.width,e.height)},r.prototype.update=function(e,t,i){t===void 0&&(t=!1),i===void 0&&(i=!1),this._getEngine().updateDynamicTexture(this._texture,this._canvas,e===void 0?!0:e,t,this._format||void 0,void 0,i)},r.prototype.drawText=function(e,t,i,a,o,s,u,l){l===void 0&&(l=!0);var c=this.getSize();if(s&&(this._context.fillStyle=s,this._context.fillRect(0,0,c.width,c.height)),this._context.font=a,t==null){var p=this._context.measureText(e);t=(c.width-p.width)/2}if(i==null){var d=parseInt(a.replace(/\D/g,""));i=c.height/2+d/3.65}this._context.fillStyle=o||"",this._context.fillText(e,t,i),l&&this.update(u)},r.prototype.clone=function(){var e=this.getScene();if(!e)return this;var t=this.getSize(),i=new r(this.name,t,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i},r.prototype.serialize=function(){var e=this.getScene();e&&!e.isReady()&&$.Warn("The scene must be ready before serializing the dynamic texture");var t=n.prototype.serialize.call(this);return r._IsCanvasElement(this._canvas)&&(t.base64String=this._canvas.toDataURL()),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t},r._IsCanvasElement=function(e){return e.toDataURL!==void 0},r.prototype._rebuild=function(){this.update()},r}(I),Dt={effect:null,subMesh:null},xr=function(n){A(r,n);function r(e,t,i,a,o){a===void 0&&(a={}),o===void 0&&(o=!0);var s=n.call(this,e,t,o)||this;return s._textures={},s._textureArrays={},s._externalTextures={},s._floats={},s._ints={},s._floatsArrays={},s._colors3={},s._colors3Arrays={},s._colors4={},s._colors4Arrays={},s._vectors2={},s._vectors3={},s._vectors4={},s._quaternions={},s._quaternionsArrays={},s._matrices={},s._matrixArrays={},s._matrices3x3={},s._matrices2x2={},s._vectors2Arrays={},s._vectors3Arrays={},s._vectors4Arrays={},s._uniformBuffers={},s._textureSamplers={},s._storageBuffers={},s._cachedWorldViewMatrix=new q,s._cachedWorldViewProjectionMatrix=new q,s._multiview=!1,s._shaderPath=i,s._options=Re({needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1},a),s}return Object.defineProperty(r.prototype,"shaderPath",{get:function(){return this._shaderPath},set:function(e){this._shaderPath=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"options",{get:function(){return this._options},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"ShaderMaterial"},r.prototype.needAlphaBlending=function(){return this.alpha<1||this._options.needAlphaBlending},r.prototype.needAlphaTesting=function(){return this._options.needAlphaTesting},r.prototype._checkUniform=function(e){this._options.uniforms.indexOf(e)===-1&&this._options.uniforms.push(e)},r.prototype.setTexture=function(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._textures[e]=t,this},r.prototype.setTextureArray=function(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this},r.prototype.setExternalTexture=function(e,t){return this._options.externalTextures.indexOf(e)===-1&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this},r.prototype.setFloat=function(e,t){return this._checkUniform(e),this._floats[e]=t,this},r.prototype.setInt=function(e,t){return this._checkUniform(e),this._ints[e]=t,this},r.prototype.setFloats=function(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this},r.prototype.setColor3=function(e,t){return this._checkUniform(e),this._colors3[e]=t,this},r.prototype.setColor3Array=function(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce(function(i,a){return a.toArray(i,i.length),i},[]),this},r.prototype.setColor4=function(e,t){return this._checkUniform(e),this._colors4[e]=t,this},r.prototype.setColor4Array=function(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce(function(i,a){return a.toArray(i,i.length),i},[]),this},r.prototype.setVector2=function(e,t){return this._checkUniform(e),this._vectors2[e]=t,this},r.prototype.setVector3=function(e,t){return this._checkUniform(e),this._vectors3[e]=t,this},r.prototype.setVector4=function(e,t){return this._checkUniform(e),this._vectors4[e]=t,this},r.prototype.setQuaternion=function(e,t){return this._checkUniform(e),this._quaternions[e]=t,this},r.prototype.setQuaternionArray=function(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce(function(i,a){return a.toArray(i,i.length),i},[]),this},r.prototype.setMatrix=function(e,t){return this._checkUniform(e),this._matrices[e]=t,this},r.prototype.setMatrices=function(e,t){this._checkUniform(e);for(var i=new Float32Array(t.length*16),a=0;a<t.length;a++){var o=t[a];o.copyToArray(i,a*16)}return this._matrixArrays[e]=i,this},r.prototype.setMatrix3x3=function(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this},r.prototype.setMatrix2x2=function(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this},r.prototype.setArray2=function(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this},r.prototype.setArray3=function(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this},r.prototype.setArray4=function(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this},r.prototype.setUniformBuffer=function(e,t){return this._options.uniformBuffers.indexOf(e)===-1&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this},r.prototype.setTextureSampler=function(e,t){return this._options.samplerObjects.indexOf(e)===-1&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this},r.prototype.setStorageBuffer=function(e,t){return this._options.storageBuffers.indexOf(e)===-1&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this},r.prototype.isReadyForSubMesh=function(e,t,i){return this.isReady(e,i,t)},r.prototype.isReady=function(e,t,i){var a,o,s,u,l=i&&this._storeEffectOnSubMeshes;if(this.isFrozen)if(l){if(i.effect&&i.effect._wasPreviouslyReady)return!0}else{var c=this._drawWrapper.effect;if(c&&c._wasPreviouslyReady&&c._wasPreviouslyUsingInstances===t)return!0}var p=this.getScene(),d=p.getEngine(),g=[],m=[],y=new $e,v=this._shaderPath,T=this._options.uniforms,x=this._options.uniformBuffers,E=this._options.samplers;d.getCaps().multiview&&p.activeCamera&&p.activeCamera.outputRenderTarget&&p.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,g.push("#define MULTIVIEW"),this._options.uniforms.indexOf("viewProjection")!==-1&&this._options.uniforms.indexOf("viewProjectionR")===-1&&this._options.uniforms.push("viewProjectionR"));for(var O=0;O<this._options.defines.length;O++){var N=this._options.defines[O].indexOf("#define")===0?this._options.defines[O]:"#define ".concat(this._options.defines[O]);g.push(N)}for(var O=0;O<this._options.attributes.length;O++)m.push(this._options.attributes[O]);if(e&&e.isVerticesDataPresent(L.ColorKind)&&(m.push(L.ColorKind),g.push("#define VERTEXCOLOR")),t&&(g.push("#define INSTANCES"),C.PushAttributesForInstances(m),e!=null&&e.hasThinInstances&&(g.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(L.ColorInstanceKind)&&(m.push(L.ColorInstanceKind),g.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){m.push(L.MatricesIndicesKind),m.push(L.MatricesWeightsKind),e.numBoneInfluencers>4&&(m.push(L.MatricesIndicesExtraKind),m.push(L.MatricesWeightsExtraKind));var w=e.skeleton;g.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),y.addCPUSkinningFallback(0,e),w.isUsingTextureForMatrices?(g.push("#define BONETEXTURE"),this._options.uniforms.indexOf("boneTextureWidth")===-1&&this._options.uniforms.push("boneTextureWidth"),this._options.samplers.indexOf("boneSampler")===-1&&this._options.samplers.push("boneSampler")):(g.push("#define BonesPerMesh "+(w.bones.length+1)),this._options.uniforms.indexOf("mBones")===-1&&this._options.uniforms.push("mBones"))}else g.push("#define NUM_BONE_INFLUENCERS 0");var k=0,W=e?e.morphTargetManager:null;if(W){var Z=W.supportsUVs&&g.indexOf("#define UV1")!==-1,ie=W.supportsTangents&&g.indexOf("#define TANGENT")!==-1,D=W.supportsNormals&&g.indexOf("#define NORMAL")!==-1;k=W.numInfluencers,Z&&g.push("#define MORPHTARGETS_UV"),ie&&g.push("#define MORPHTARGETS_TANGENT"),D&&g.push("#define MORPHTARGETS_NORMAL"),k>0&&g.push("#define MORPHTARGETS"),W.isUsingTextureForTargets&&(g.push("#define MORPHTARGETS_TEXTURE"),this._options.uniforms.indexOf("morphTargetTextureIndices")===-1&&this._options.uniforms.push("morphTargetTextureIndices"),this._options.samplers.indexOf("morphTargets")===-1&&this._options.samplers.push("morphTargets")),g.push("#define NUM_MORPH_INFLUENCERS "+k);for(var O=0;O<k;O++)m.push(L.PositionKind+O),D&&m.push(L.NormalKind+O),ie&&m.push(L.TangentKind+O),Z&&m.push(L.UVKind+"_"+O);k>0&&(T=T.slice(),T.push("morphTargetInfluences"),T.push("morphTargetTextureInfo"),T.push("morphTargetTextureIndices"))}else g.push("#define NUM_MORPH_INFLUENCERS 0");if(e){var ne=e.bakedVertexAnimationManager;ne&&ne.isEnabled&&(g.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),this._options.uniforms.indexOf("bakedVertexAnimationSettings")===-1&&this._options.uniforms.push("bakedVertexAnimationSettings"),this._options.uniforms.indexOf("bakedVertexAnimationTextureSizeInverted")===-1&&this._options.uniforms.push("bakedVertexAnimationTextureSizeInverted"),this._options.uniforms.indexOf("bakedVertexAnimationTime")===-1&&this._options.uniforms.push("bakedVertexAnimationTime"),this._options.samplers.indexOf("bakedVertexAnimationTexture")===-1&&this._options.samplers.push("bakedVertexAnimationTexture")),C.PrepareAttributesForBakedVertexAnimation(m,e,g)}for(var he in this._textures)if(!this._textures[he].isReady())return!1;e&&this._shouldTurnAlphaTestOn(e)&&g.push("#define ALPHATEST"),(this._options.useClipPlane===null&&!!p.clipPlane||this._options.useClipPlane)&&(g.push("#define CLIPPLANE"),T.indexOf("vClipPlane")===-1&&T.push("vClipPlane")),(this._options.useClipPlane===null&&!!p.clipPlane2||this._options.useClipPlane)&&(g.push("#define CLIPPLANE2"),T.indexOf("vClipPlane2")===-1&&T.push("vClipPlane2")),(this._options.useClipPlane===null&&!!p.clipPlane3||this._options.useClipPlane)&&(g.push("#define CLIPPLANE3"),T.indexOf("vClipPlane3")===-1&&T.push("vClipPlane3")),(this._options.useClipPlane===null&&!!p.clipPlane4||this._options.useClipPlane)&&(g.push("#define CLIPPLANE4"),T.indexOf("vClipPlane4")===-1&&T.push("vClipPlane4")),(this._options.useClipPlane===null&&!!p.clipPlane5||this._options.useClipPlane)&&(g.push("#define CLIPPLANE5"),T.indexOf("vClipPlane5")===-1&&T.push("vClipPlane5")),(this._options.useClipPlane===null&&!!p.clipPlane6||this._options.useClipPlane)&&(g.push("#define CLIPPLANE6"),T.indexOf("vClipPlane6")===-1&&T.push("vClipPlane6")),this.customShaderNameResolve&&(T=T.slice(),x=x.slice(),E=E.slice(),v=this.customShaderNameResolve(v,T,x,E,g,m));var oe=l?i._getDrawWrapper():this._drawWrapper,Se=(a=oe==null?void 0:oe.effect)!==null&&a!==void 0?a:null,Ce=(o=oe==null?void 0:oe.defines)!==null&&o!==void 0?o:null,Oe=g.join(`
`),te=Se;return Ce!==Oe&&(te=d.createEffect(v,{attributes:m,uniformsNames:T,uniformBuffersNames:x,samplers:E,defines:Oe,fallbacks:y,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:k},shaderLanguage:this._options.shaderLanguage},d),l?i.setEffect(te,Oe,this._materialContext):oe&&oe.setEffect(te,Oe),this._onEffectCreatedObservable&&(Dt.effect=te,Dt.subMesh=(s=i!=null?i:e==null?void 0:e.subMeshes[0])!==null&&s!==void 0?s:null,this._onEffectCreatedObservable.notifyObservers(Dt))),te._wasPreviouslyUsingInstances=!!t,!((u=!(te!=null&&te.isReady()))!==null&&u!==void 0)||u?!1:(Se!==te&&p.resetCachedMaterial(),te._wasPreviouslyReady=!0,!0)},r.prototype.bindOnlyWorldMatrix=function(e,t){var i=this.getScene(),a=t!=null?t:this.getEffect();!a||(this._options.uniforms.indexOf("world")!==-1&&a.setMatrix("world",e),this._options.uniforms.indexOf("worldView")!==-1&&(e.multiplyToRef(i.getViewMatrix(),this._cachedWorldViewMatrix),a.setMatrix("worldView",this._cachedWorldViewMatrix)),this._options.uniforms.indexOf("worldViewProjection")!==-1&&(e.multiplyToRef(i.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),a.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)))},r.prototype.bindForSubMesh=function(e,t,i){var a;this.bind(e,t,(a=i._drawWrapperOverride)===null||a===void 0?void 0:a.effect,i)},r.prototype.bind=function(e,t,i,a){var o,s=a&&this._storeEffectOnSubMeshes,u=i!=null?i:s?a.effect:this.getEffect();if(!!u){this._activeEffect=u,this.bindOnlyWorldMatrix(e,i);var l=this._options.uniformBuffers,c=!1;if(u&&l&&l.length>0&&this.getScene().getEngine().supportsUniformBuffers)for(var p=0;p<l.length;++p){var d=l[p];switch(d){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(u,"Mesh"),t.transferToEffect(e));break;case"Scene":C.BindSceneUniformBuffer(u,this.getScene().getSceneUniformBuffer()),this.getScene().finalizeSceneUbo(),c=!0;break}}var g=t&&s?this._mustRebind(this.getScene(),u,t.visibility):this.getScene().getCachedMaterial()!==this;if(u&&g){!c&&this._options.uniforms.indexOf("view")!==-1&&u.setMatrix("view",this.getScene().getViewMatrix()),!c&&this._options.uniforms.indexOf("projection")!==-1&&u.setMatrix("projection",this.getScene().getProjectionMatrix()),!c&&this._options.uniforms.indexOf("viewProjection")!==-1&&(u.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._multiview&&u.setMatrix("viewProjectionR",this.getScene()._transformMatrixR)),this.getScene().activeCamera&&this._options.uniforms.indexOf("cameraPosition")!==-1&&u.setVector3("cameraPosition",this.getScene().activeCamera.globalPosition),C.BindBonesParameters(t,u),C.BindClipPlane(u,this.getScene());var m;for(m in this._textures)u.setTexture(m,this._textures[m]);for(m in this._textureArrays)u.setTextureArray(m,this._textureArrays[m]);for(m in this._externalTextures)u.setExternalTexture(m,this._externalTextures[m]);for(m in this._ints)u.setInt(m,this._ints[m]);for(m in this._floats)u.setFloat(m,this._floats[m]);for(m in this._floatsArrays)u.setArray(m,this._floatsArrays[m]);for(m in this._colors3)u.setColor3(m,this._colors3[m]);for(m in this._colors3Arrays)u.setArray3(m,this._colors3Arrays[m]);for(m in this._colors4){var y=this._colors4[m];u.setFloat4(m,y.r,y.g,y.b,y.a)}for(m in this._colors4Arrays)u.setArray4(m,this._colors4Arrays[m]);for(m in this._vectors2)u.setVector2(m,this._vectors2[m]);for(m in this._vectors3)u.setVector3(m,this._vectors3[m]);for(m in this._vectors4)u.setVector4(m,this._vectors4[m]);for(m in this._quaternions)u.setQuaternion(m,this._quaternions[m]);for(m in this._matrices)u.setMatrix(m,this._matrices[m]);for(m in this._matrixArrays)u.setMatrices(m,this._matrixArrays[m]);for(m in this._matrices3x3)u.setMatrix3x3(m,this._matrices3x3[m]);for(m in this._matrices2x2)u.setMatrix2x2(m,this._matrices2x2[m]);for(m in this._vectors2Arrays)u.setArray2(m,this._vectors2Arrays[m]);for(m in this._vectors3Arrays)u.setArray3(m,this._vectors3Arrays[m]);for(m in this._vectors4Arrays)u.setArray4(m,this._vectors4Arrays[m]);for(m in this._quaternionsArrays)u.setArray4(m,this._quaternionsArrays[m]);for(m in this._uniformBuffers){var v=this._uniformBuffers[m].getBuffer();v&&u.bindUniformBuffer(v,m)}for(m in this._textureSamplers)u.setTextureSampler(m,this._textureSamplers[m]);for(m in this._storageBuffers)u.setStorageBuffer(m,this._storageBuffers[m])}if(u&&t&&(g||!this.isFrozen)){var T=t.morphTargetManager;T&&T.numInfluencers>0&&C.BindMorphTargetParameters(t,u);var x=t.bakedVertexAnimationManager;x&&x.isEnabled&&((o=t.bakedVertexAnimationManager)===null||o===void 0||o.bind(u,!!u._wasPreviouslyUsingInstances))}this._afterBind(t,u)}},r.prototype.getActiveTextures=function(){var e=n.prototype.getActiveTextures.call(this);for(var t in this._textures)e.push(this._textures[t]);for(var i in this._textureArrays)for(var a=this._textureArrays[i],o=0;o<a.length;o++)e.push(a[o]);return e},r.prototype.hasTexture=function(e){if(n.prototype.hasTexture.call(this,e))return!0;for(var t in this._textures)if(this._textures[t]===e)return!0;for(var i in this._textureArrays)for(var a=this._textureArrays[i],o=0;o<a.length;o++)if(a[o]===e)return!0;return!1},r.prototype.clone=function(e){var t=this,i=j.Clone(function(){return new r(e,t.getScene(),t._shaderPath,t._options,t._storeEffectOnSubMeshes)},this);i.name=e,i.id=e,typeof i._shaderPath=="object"&&(i._shaderPath=Re({},i._shaderPath)),this._options=Re({},this._options),Object.keys(this._options).forEach(function(o){var s=t._options[o];Array.isArray(s)&&(t._options[o]=s.slice(0))}),this.stencil.copyTo(i.stencil);for(var a in this._textures)i.setTexture(a,this._textures[a]);for(var a in this._textureArrays)i.setTextureArray(a,this._textureArrays[a]);for(var a in this._externalTextures)i.setExternalTexture(a,this._externalTextures[a]);for(var a in this._ints)i.setInt(a,this._ints[a]);for(var a in this._floats)i.setFloat(a,this._floats[a]);for(var a in this._floatsArrays)i.setFloats(a,this._floatsArrays[a]);for(var a in this._colors3)i.setColor3(a,this._colors3[a]);for(var a in this._colors3Arrays)i._colors3Arrays[a]=this._colors3Arrays[a];for(var a in this._colors4)i.setColor4(a,this._colors4[a]);for(var a in this._colors4Arrays)i._colors4Arrays[a]=this._colors4Arrays[a];for(var a in this._vectors2)i.setVector2(a,this._vectors2[a]);for(var a in this._vectors3)i.setVector3(a,this._vectors3[a]);for(var a in this._vectors4)i.setVector4(a,this._vectors4[a]);for(var a in this._quaternions)i.setQuaternion(a,this._quaternions[a]);for(var a in this._quaternionsArrays)i._quaternionsArrays[a]=this._quaternionsArrays[a];for(var a in this._matrices)i.setMatrix(a,this._matrices[a]);for(var a in this._matrixArrays)i._matrixArrays[a]=this._matrixArrays[a].slice();for(var a in this._matrices3x3)i.setMatrix3x3(a,this._matrices3x3[a]);for(var a in this._matrices2x2)i.setMatrix2x2(a,this._matrices2x2[a]);for(var a in this._vectors2Arrays)i.setArray2(a,this._vectors2Arrays[a]);for(var a in this._vectors3Arrays)i.setArray3(a,this._vectors3Arrays[a]);for(var a in this._vectors4Arrays)i.setArray4(a,this._vectors4Arrays[a]);for(var a in this._uniformBuffers)i.setUniformBuffer(a,this._uniformBuffers[a]);for(var a in this._textureSamplers)i.setTextureSampler(a,this._textureSamplers[a]);for(var a in this._storageBuffers)i.setStorageBuffer(a,this._storageBuffers[a]);return i},r.prototype.dispose=function(e,t,i){if(t){var a;for(a in this._textures)this._textures[a].dispose();for(a in this._textureArrays)for(var o=this._textureArrays[a],s=0;s<o.length;s++)o[s].dispose()}this._textures={},n.prototype.dispose.call(this,e,t,i)},r.prototype.serialize=function(){var e=j.Serialize(this);e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes;var t;e.stencil=this.stencil.serialize(),e.textures={};for(t in this._textures)e.textures[t]=this._textures[t].serialize();e.textureArrays={};for(t in this._textureArrays){e.textureArrays[t]=[];for(var i=this._textureArrays[t],a=0;a<i.length;a++)e.textureArrays[t].push(i[a].serialize())}e.ints={};for(t in this._ints)e.ints[t]=this._ints[t];e.floats={};for(t in this._floats)e.floats[t]=this._floats[t];e.FloatArrays={};for(t in this._floatsArrays)e.FloatArrays[t]=this._floatsArrays[t];e.colors3={};for(t in this._colors3)e.colors3[t]=this._colors3[t].asArray();e.colors3Arrays={};for(t in this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];e.colors4={};for(t in this._colors4)e.colors4[t]=this._colors4[t].asArray();e.colors4Arrays={};for(t in this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];e.vectors2={};for(t in this._vectors2)e.vectors2[t]=this._vectors2[t].asArray();e.vectors3={};for(t in this._vectors3)e.vectors3[t]=this._vectors3[t].asArray();e.vectors4={};for(t in this._vectors4)e.vectors4[t]=this._vectors4[t].asArray();e.quaternions={};for(t in this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();e.matrices={};for(t in this._matrices)e.matrices[t]=this._matrices[t].asArray();e.matrixArray={};for(t in this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];e.matrices3x3={};for(t in this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];e.matrices2x2={};for(t in this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];e.vectors2Arrays={};for(t in this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];e.vectors3Arrays={};for(t in this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];e.vectors4Arrays={};for(t in this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];e.quaternionsArrays={};for(t in this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e},r.Parse=function(e,t,i){var a=j.Parse(function(){return new r(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes)},e,t,i),o;e.stencil&&a.stencil.parse(e.stencil,t,i);for(o in e.textures)a.setTexture(o,I.Parse(e.textures[o],t,i));for(o in e.textureArrays){for(var s=e.textureArrays[o],u=new Array,l=0;l<s.length;l++)u.push(I.Parse(s[l],t,i));a.setTextureArray(o,u)}for(o in e.ints)a.setInt(o,e.ints[o]);for(o in e.floats)a.setFloat(o,e.floats[o]);for(o in e.floatsArrays)a.setFloats(o,e.floatsArrays[o]);for(o in e.colors3)a.setColor3(o,G.FromArray(e.colors3[o]));for(o in e.colors3Arrays){var c=e.colors3Arrays[o].reduce(function(p,d,g){return g%3===0?p.push([d]):p[p.length-1].push(d),p},[]).map(function(p){return G.FromArray(p)});a.setColor3Array(o,c)}for(o in e.colors4)a.setColor4(o,ve.FromArray(e.colors4[o]));for(o in e.colors4Arrays){var c=e.colors4Arrays[o].reduce(function(d,g,m){return m%4===0?d.push([g]):d[d.length-1].push(g),d},[]).map(function(d){return ve.FromArray(d)});a.setColor4Array(o,c)}for(o in e.vectors2)a.setVector2(o,Te.FromArray(e.vectors2[o]));for(o in e.vectors3)a.setVector3(o,K.FromArray(e.vectors3[o]));for(o in e.vectors4)a.setVector4(o,Me.FromArray(e.vectors4[o]));for(o in e.quaternions)a.setQuaternion(o,Gr.FromArray(e.quaternions[o]));for(o in e.matrices)a.setMatrix(o,q.FromArray(e.matrices[o]));for(o in e.matrixArray)a._matrixArrays[o]=new Float32Array(e.matrixArray[o]);for(o in e.matrices3x3)a.setMatrix3x3(o,e.matrices3x3[o]);for(o in e.matrices2x2)a.setMatrix2x2(o,e.matrices2x2[o]);for(o in e.vectors2Arrays)a.setArray2(o,e.vectors2Arrays[o]);for(o in e.vectors3Arrays)a.setArray3(o,e.vectors3Arrays[o]);for(o in e.vectors4Arrays)a.setArray4(o,e.vectors4Arrays[o]);for(o in e.quaternionsArrays)a.setArray4(o,e.quaternionsArrays[o]);return a},r.ParseFromFileAsync=function(e,t,i,a){var o=this;return a===void 0&&(a=""),new Promise(function(s,u){var l=new lt;l.addEventListener("readystatechange",function(){if(l.readyState==4)if(l.status==200){var c=JSON.parse(l.responseText),p=o.Parse(c,i||de.LastCreatedScene,a);e&&(p.name=e),s(p)}else u("Unable to load the ShaderMaterial")}),l.open("GET",t),l.send()})},r.ParseFromSnippetAsync=function(e,t,i){var a=this;return i===void 0&&(i=""),new Promise(function(o,s){var u=new lt;u.addEventListener("readystatechange",function(){if(u.readyState==4)if(u.status==200){var l=JSON.parse(JSON.parse(u.responseText).jsonPayload),c=JSON.parse(l.shaderMaterial),p=a.Parse(c,t||de.LastCreatedScene,i);p.snippetId=e,o(p)}else s("Unable to load the snippet "+e)}),u.open("GET",a.SnippetUrl+"/"+e.replace(/#/g,"/")),u.send()})},r.SnippetUrl="https://snippet.babylonjs.com",r.CreateFromSnippetAsync=r.ParseFromSnippetAsync,r}(Je);P("BABYLON.ShaderMaterial",xr);De.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(De.prototype,"sphericalPolynomial",{get:function(){var n=this;if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=dr.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(function(r){n._texture._sphericalPolynomial=r,n._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(n){this._texture&&(this._texture._sphericalPolynomial=n)},enumerable:!0,configurable:!0});var ka=function(){function n(r){this.useMipMaps=!1,this.type=16,this._video=r,this.uniqueId=yi._Counter++}return n.IsExternalTexture=function(r){return r.underlyingResource!==void 0},n.prototype.getClassName=function(){return"ExternalTexture"},Object.defineProperty(n.prototype,"underlyingResource",{get:function(){return this._video},enumerable:!1,configurable:!0}),n.prototype.isReady=function(){return this._video.readyState>=this._video.HAVE_CURRENT_DATA},n.prototype.dispose=function(){},n}(),Ii=function(n){A(r,n);function r(e,t,i,a,o,s,u){o===void 0&&(o=0),s===void 0&&(s=I.BILINEAR_SAMPLINGMODE),u===void 0&&(u=!0);var l=n.call(this,e,t,i,a,!0,o,!1,s,u)||this;if(l.mirrorPlane=new ct(0,1,0,1),l._transformMatrix=q.Zero(),l._mirrorMatrix=q.Zero(),l._adaptiveBlurKernel=0,l._blurKernelX=0,l._blurKernelY=0,l._blurRatio=1,i=l.getScene(),!i)return l;l.ignoreCameraViewport=!0,l._updateGammaSpace(),l._imageProcessingConfigChangeObserver=i.imageProcessingConfiguration.onUpdateParameters.add(function(){l._updateGammaSpace()});var c=i.getEngine();c.supportsUniformBuffers&&(l._sceneUBO=i.createSceneUniformBuffer('Scene for Mirror Texture (name "'.concat(e,'")'))),l.onBeforeBindObservable.add(function(){var d;(d=c._debugPushGroup)===null||d===void 0||d.call(c,"mirror generation for ".concat(e),1)}),l.onAfterUnbindObservable.add(function(){var d;(d=c._debugPopGroup)===null||d===void 0||d.call(c,1)});var p;return l.onBeforeRenderObservable.add(function(){l._sceneUBO&&(l._currentSceneUBO=i.getSceneUniformBuffer(),i.setSceneUniformBuffer(l._sceneUBO),i.getSceneUniformBuffer().unbindEffect()),q.ReflectionToRef(l.mirrorPlane,l._mirrorMatrix),l._mirrorMatrix.multiplyToRef(i.getViewMatrix(),l._transformMatrix),i.setTransformMatrix(l._transformMatrix,i.getProjectionMatrix()),p=i.clipPlane,i.clipPlane=l.mirrorPlane,i.getEngine().cullBackFaces=!1,i._mirroredCameraPosition=K.TransformCoordinates(i.activeCamera.globalPosition,l._mirrorMatrix)}),l.onAfterRenderObservable.add(function(){l._sceneUBO&&i.setSceneUniformBuffer(l._currentSceneUBO),i.updateTransformMatrix(),i.getEngine().cullBackFaces=null,i._mirroredCameraPosition=null,i.clipPlane=p}),l}return Object.defineProperty(r.prototype,"blurRatio",{get:function(){return this._blurRatio},set:function(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"adaptiveBlurKernel",{set:function(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"blurKernel",{set:function(e){this.blurKernelX=e,this.blurKernelY=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"blurKernelX",{get:function(){return this._blurKernelX},set:function(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"blurKernelY",{get:function(){return this._blurKernelY},set:function(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())},enumerable:!1,configurable:!0}),r.prototype._autoComputeBlurKernel=function(){var e=this.getScene().getEngine(),t=this.getRenderWidth()/e.getRenderWidth(),i=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t,this.blurKernelY=this._adaptiveBlurKernel*i},r.prototype._onRatioRescale=function(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()},r.prototype._updateGammaSpace=function(){var e=this.getScene();!e||(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)},r.prototype._preparePostProcesses=function(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){var e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new or("horizontal blur",new Te(1,0),this._blurKernelX,this._blurRatio,null,I.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,this._blurRatio===1&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new or("vertical blur",new Te(0,1),this._blurKernelY,this._blurRatio,null,I.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=this._blurRatio!==1,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)},r.prototype.clone=function(){var e=this.getScene();if(!e)return this;var t=this.getSize(),i=new r(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i},r.prototype.serialize=function(){if(!this.name)return null;var e=n.prototype.serialize.call(this);return e.mirrorPlane=this.mirrorPlane.asArray(),e},r.prototype.dispose=function(){var e;n.prototype.dispose.call(this);var t=this.getScene();t&&t.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),(e=this._sceneUBO)===null||e===void 0||e.dispose()},r}(Ve);I._CreateMirror=function(n,r,e,t){return new Ii(n,r,e,t)};var et=function(n){A(r,n);function r(e,t,i,a,o,s,u,l,c,p,d,g,m,y,v){i===void 0&&(i=null),a===void 0&&(a=!1),o===void 0&&(o=null),s===void 0&&(s=null),u===void 0&&(u=null),l===void 0&&(l=5),c===void 0&&(c=!1),p===void 0&&(p=null),d===void 0&&(d=!1),g===void 0&&(g=.8),m===void 0&&(m=0);var T=this,x;return T=n.call(this,t)||this,T._lodScale=.8,T._lodOffset=0,T.onLoadObservable=new J,T.boundingBoxPosition=K.Zero(),T._rotationY=0,T._files=null,T._forcedExtension=null,T._extensions=null,T.name=e,T.url=e,T._noMipmap=a,T.hasAlpha=!1,T._format=l,T.isCube=!0,T._textureMatrix=q.Identity(),T._createPolynomials=d,T.coordinatesMode=I.CUBIC_MODE,T._extensions=i,T._files=o,T._forcedExtension=p,T._loaderOptions=y,T._useSRGBBuffer=v,T._lodScale=g,T._lodOffset=m,!e&&!o||T.updateURL(e,p,s,c,u,i,(x=T.getScene())===null||x===void 0?void 0:x.useDelayedTextureLoading,o),T}return Object.defineProperty(r.prototype,"boundingBoxSize",{get:function(){return this._boundingBoxSize},set:function(e){if(!(this._boundingBoxSize&&this._boundingBoxSize.equals(e))){this._boundingBoxSize=e;var t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rotationY",{get:function(){return this._rotationY},set:function(e){this._rotationY=e,this.setReflectionTextureMatrix(q.RotationY(this._rotationY))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"noMipmap",{get:function(){return this._noMipmap},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"forcedExtension",{get:function(){return this._forcedExtension},enumerable:!1,configurable:!0}),r.CreateFromImages=function(e,t,i){var a="";return e.forEach(function(o){return a+=o}),new r(a,t,null,i,e)},r.CreateFromPrefilteredData=function(e,t,i,a){i===void 0&&(i=null),a===void 0&&(a=!0);var o=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;var s=new r(e,t,null,!1,null,null,null,void 0,!0,i,a);return t.useDelayedTextureLoading=o,s},r.prototype.getClassName=function(){return"CubeTexture"},r.prototype.updateURL=function(e,t,i,a,o,s,u,l){i===void 0&&(i=null),a===void 0&&(a=!1),o===void 0&&(o=null),s===void 0&&(s=null),u===void 0&&(u=!1),l===void 0&&(l=null),(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,t&&(this._forcedExtension=t);var c=e.lastIndexOf("."),p=t||(c>-1?e.substring(c).toLowerCase():""),d=p.indexOf(".dds")===0,g=p.indexOf(".env")===0;if(g?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=a,a&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),l)this._files=l;else if(!g&&!d&&!s&&(s=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,s){for(var m=0;m<s.length;m++)this._files.push(e+s[m]);this._extensions=s}u?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=o):this._loadTexture(i,o)},r.prototype.delayLoad=function(e){this.delayLoadState===4&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))},r.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix},r.prototype.setReflectionTextureMatrix=function(e){var t=this,i;e.updateFlag!==this._textureMatrix.updateFlag&&(e.isIdentity()!==this._textureMatrix.isIdentity()&&((i=this.getScene())===null||i===void 0||i.markAllMaterialsAsDirty(1,function(a){return a.getActiveTextures().indexOf(t)!==-1})),this._textureMatrix=e)},r.prototype._loadTexture=function(e,t){var i=this,a;e===void 0&&(e=null),t===void 0&&(t=null);var o=this.getScene(),s=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);var u=function(){var c;i.onLoadObservable.notifyObservers(i),s&&(s.dispose(),(c=i.getScene())===null||c===void 0||c.markAllMaterialsAsDirty(1)),e&&e()},l=function(c,p){i._loadingError=!0,i._errorObject={message:c,exception:p},t&&t(c,p),I.OnTextureLoadErrorObservable.notifyObservers(i)};this._texture?this._texture.isReady?ae.SetImmediate(function(){return u()}):this._texture.onLoadedObservable.add(function(){return u()}):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,o,this._lodScale,this._lodOffset,e,l,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,o,this._files,this._noMipmap,e,l,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer),(a=this._texture)===null||a===void 0||a.onLoadedObservable.add(function(){return i.onLoadObservable.notifyObservers(i)}))},r.Parse=function(e,t,i){var a=j.Parse(function(){var l=!1;return e.prefiltered&&(l=e.prefiltered),new r(i+e.name,t,e.extensions,!1,e.files||null,null,null,void 0,l,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(a.boundingBoxPosition=K.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(a.boundingBoxSize=K.FromArray(e.boundingBoxSize)),e.animations)for(var o=0;o<e.animations.length;o++){var s=e.animations[o],u=Qe("BABYLON.Animation");u&&a.animations.push(u.Parse(s))}return a},r.prototype.clone=function(){var e=this,t=0,i=j.Clone(function(){var a=new r(e.url,e.getScene()||e._getEngine(),e._extensions,e._noMipmap,e._files);return t=a.uniqueId,a},this);return i.uniqueId=t,i},h([b()],r.prototype,"url",void 0),h([b("rotationY")],r.prototype,"rotationY",null),h([b("files")],r.prototype,"_files",void 0),h([b("forcedExtension")],r.prototype,"_forcedExtension",void 0),h([b("extensions")],r.prototype,"_extensions",void 0),h([ei("textureMatrix")],r.prototype,"_textureMatrix",void 0),r}(De);I._CubeTextureParser=et.Parse;P("BABYLON.CubeTexture",et);var Fi=function(n){A(r,n);function r(){var e=n.call(this)||this;return e.DIFFUSE=!1,e.DIFFUSEDIRECTUV=0,e.GAMMADIFFUSE=!1,e.DIFFUSEHASALPHA=!1,e.OPACITYFRESNEL=!1,e.REFLECTIONBLUR=!1,e.REFLECTIONFRESNEL=!1,e.REFLECTIONFALLOFF=!1,e.TEXTURELODSUPPORT=!1,e.PREMULTIPLYALPHA=!1,e.USERGBCOLOR=!1,e.USEHIGHLIGHTANDSHADOWCOLORS=!1,e.BACKMAT_SHADOWONLY=!1,e.NOISE=!1,e.REFLECTIONBGR=!1,e.IMAGEPROCESSING=!1,e.VIGNETTE=!1,e.VIGNETTEBLENDMODEMULTIPLY=!1,e.VIGNETTEBLENDMODEOPAQUE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=!1,e.SAMPLER3DBGRMAP=!1,e.IMAGEPROCESSINGPOSTPROCESS=!1,e.SKIPFINALCOLORCLAMP=!1,e.EXPOSURE=!1,e.MULTIVIEW=!1,e.REFLECTION=!1,e.REFLECTIONMAP_3D=!1,e.REFLECTIONMAP_SPHERICAL=!1,e.REFLECTIONMAP_PLANAR=!1,e.REFLECTIONMAP_CUBIC=!1,e.REFLECTIONMAP_PROJECTION=!1,e.REFLECTIONMAP_SKYBOX=!1,e.REFLECTIONMAP_EXPLICIT=!1,e.REFLECTIONMAP_EQUIRECTANGULAR=!1,e.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,e.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,e.INVERTCUBICMAP=!1,e.REFLECTIONMAP_OPPOSITEZ=!1,e.LODINREFLECTIONALPHA=!1,e.GAMMAREFLECTION=!1,e.RGBDREFLECTION=!1,e.EQUIRECTANGULAR_RELFECTION_FOV=!1,e.MAINUV1=!1,e.MAINUV2=!1,e.UV1=!1,e.UV2=!1,e.CLIPPLANE=!1,e.CLIPPLANE2=!1,e.CLIPPLANE3=!1,e.CLIPPLANE4=!1,e.CLIPPLANE5=!1,e.CLIPPLANE6=!1,e.POINTSIZE=!1,e.FOG=!1,e.NORMAL=!1,e.NUM_BONE_INFLUENCERS=0,e.BonesPerMesh=0,e.INSTANCES=!1,e.SHADOWFLOAT=!1,e.LOGARITHMICDEPTH=!1,e.NONUNIFORMSCALING=!1,e.ALPHATEST=!1,e.rebuild(),e}return r}(Ae),Mi=function(n){A(r,n);function r(e,t){var i=n.call(this,e,t)||this;return i.primaryColor=G.White(),i._primaryColorShadowLevel=0,i._primaryColorHighlightLevel=0,i.reflectionTexture=null,i.reflectionBlur=0,i.diffuseTexture=null,i._shadowLights=null,i.shadowLights=null,i.shadowLevel=0,i.sceneCenter=K.Zero(),i.opacityFresnel=!0,i.reflectionFresnel=!1,i.reflectionFalloffDistance=0,i.reflectionAmount=1,i.reflectionReflectance0=.05,i.reflectionReflectance90=.5,i.useRGBColor=!0,i.enableNoise=!1,i._fovMultiplier=1,i.useEquirectangularFOV=!1,i._maxSimultaneousLights=4,i.maxSimultaneousLights=4,i._shadowOnly=!1,i.shadowOnly=!1,i._imageProcessingObserver=null,i.switchToBGR=!1,i._renderTargets=new Yt(16),i._reflectionControls=Me.Zero(),i._white=G.White(),i._primaryShadowColor=G.Black(),i._primaryHighlightColor=G.Black(),i._attachImageProcessingConfiguration(null),i.getRenderTargetTextures=function(){return i._renderTargets.reset(),i._diffuseTexture&&i._diffuseTexture.isRenderTarget&&i._renderTargets.push(i._diffuseTexture),i._reflectionTexture&&i._reflectionTexture.isRenderTarget&&i._renderTargets.push(i._reflectionTexture),i._renderTargets},i}return Object.defineProperty(r.prototype,"_perceptualColor",{get:function(){return this.__perceptualColor},set:function(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"primaryColorShadowLevel",{get:function(){return this._primaryColorShadowLevel},set:function(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"primaryColorHighlightLevel",{get:function(){return this._primaryColorHighlightLevel},set:function(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"reflectionStandardFresnelWeight",{set:function(e){var t=e;t<.5?(t=t*2,this.reflectionReflectance0=r.StandardReflectance0*t,this.reflectionReflectance90=r.StandardReflectance90*t):(t=t*2-1,this.reflectionReflectance0=r.StandardReflectance0+(1-r.StandardReflectance0)*t,this.reflectionReflectance90=r.StandardReflectance90+(1-r.StandardReflectance90)*t)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"fovMultiplier",{get:function(){return this._fovMultiplier},set:function(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))},enumerable:!1,configurable:!0}),r.prototype._attachImageProcessingConfiguration=function(e){var t=this;e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){t._computePrimaryColorFromPerceptualColor(),t._markAllSubMeshesAsImageProcessingDirty()})))},Object.defineProperty(r.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(e){this.imageProcessingConfiguration.colorCurvesEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(e){this.imageProcessingConfiguration.colorGradingEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(e){this._imageProcessingConfiguration.toneMappingEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(e){this._imageProcessingConfiguration.exposure=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(e){this._imageProcessingConfiguration.contrast=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(e){this.imageProcessingConfiguration.colorGradingTexture=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraColorCurves",{get:function(){return this.imageProcessingConfiguration.colorCurves},set:function(e){this.imageProcessingConfiguration.colorCurves=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasRenderTargetTextures",{get:function(){return!!(this._diffuseTexture&&this._diffuseTexture.isRenderTarget||this._reflectionTexture&&this._reflectionTexture.isRenderTarget)},enumerable:!1,configurable:!0}),r.prototype.needAlphaTesting=function(){return!0},r.prototype.needAlphaBlending=function(){return this.alpha<1||this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._shadowOnly},r.prototype.isReadyForSubMesh=function(e,t,i){if(i===void 0&&(i=!1),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new Fi);var a=this.getScene(),o=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;var s=a.getEngine();if(C.PrepareDefinesForLights(a,e,o,!1,this._maxSimultaneousLights),o._needNormals=!0,C.PrepareDefinesForMultiview(a,o),o._areTexturesDirty){if(o._needUVs=!1,a.texturesEnabled){if(a.getEngine().getCaps().textureLOD&&(o.TEXTURELODSUPPORT=!0),this._diffuseTexture&&R.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;C.PrepareDefinesForMergedUV(this._diffuseTexture,o,"DIFFUSE"),o.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,o.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,o.OPACITYFRESNEL=this._opacityFresnel}else o.DIFFUSE=!1,o.DIFFUSEDIRECTUV=0,o.DIFFUSEHASALPHA=!1,o.GAMMADIFFUSE=!1,o.OPACITYFRESNEL=!1;var u=this._reflectionTexture;if(u&&R.ReflectionTextureEnabled){if(!u.isReadyOrNotBlocking())return!1;switch(o.REFLECTION=!0,o.GAMMAREFLECTION=u.gammaSpace,o.RGBDREFLECTION=u.isRGBD,o.REFLECTIONBLUR=this._reflectionBlur>0,o.LODINREFLECTIONALPHA=u.lodLevelInAlpha,o.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,o.REFLECTIONBGR=this.switchToBGR,u.coordinatesMode===I.INVCUBIC_MODE&&(o.INVERTCUBICMAP=!0),o.REFLECTIONMAP_3D=u.isCube,o.REFLECTIONMAP_OPPOSITEZ=o.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!u.invertZ:u.invertZ,u.coordinatesMode){case I.EXPLICIT_MODE:o.REFLECTIONMAP_EXPLICIT=!0;break;case I.PLANAR_MODE:o.REFLECTIONMAP_PLANAR=!0;break;case I.PROJECTION_MODE:o.REFLECTIONMAP_PROJECTION=!0;break;case I.SKYBOX_MODE:o.REFLECTIONMAP_SKYBOX=!0;break;case I.SPHERICAL_MODE:o.REFLECTIONMAP_SPHERICAL=!0;break;case I.EQUIRECTANGULAR_MODE:o.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case I.FIXED_EQUIRECTANGULAR_MODE:o.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case I.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:o.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case I.CUBIC_MODE:case I.INVCUBIC_MODE:default:o.REFLECTIONMAP_CUBIC=!0;break}this.reflectionFresnel?(o.REFLECTIONFRESNEL=!0,o.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(o.REFLECTIONFRESNEL=!1,o.REFLECTIONFALLOFF=!1)}else o.REFLECTION=!1,o.REFLECTIONFRESNEL=!1,o.REFLECTIONFALLOFF=!1,o.REFLECTIONBLUR=!1,o.REFLECTIONMAP_3D=!1,o.REFLECTIONMAP_SPHERICAL=!1,o.REFLECTIONMAP_PLANAR=!1,o.REFLECTIONMAP_CUBIC=!1,o.REFLECTIONMAP_PROJECTION=!1,o.REFLECTIONMAP_SKYBOX=!1,o.REFLECTIONMAP_EXPLICIT=!1,o.REFLECTIONMAP_EQUIRECTANGULAR=!1,o.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,o.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,o.INVERTCUBICMAP=!1,o.REFLECTIONMAP_OPPOSITEZ=!1,o.LODINREFLECTIONALPHA=!1,o.GAMMAREFLECTION=!1,o.RGBDREFLECTION=!1}o.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,o.USERGBCOLOR=this._useRGBColor,o.NOISE=this._enableNoise}if(o._areLightsDirty&&(o.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(this._primaryColorShadowLevel!==0||this._primaryColorHighlightLevel!==0),o.BACKMAT_SHADOWONLY=this._shadowOnly),o._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(o)}if(C.PrepareDefinesForMisc(e,a,!1,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),o),C.PrepareDefinesForFrameBoundValues(a,s,o,i,null,t.getRenderingMesh().hasThinInstances),C.PrepareDefinesForAttributes(e,o,!1,!0,!1)&&e&&!a.getEngine().getCaps().standardDerivatives&&!e.isVerticesDataPresent(L.NormalKind)&&(e.createNormals(!0),$.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name)),o.isDirty){o.markAsProcessed(),a.resetCachedMaterial();var l=new $e;o.FOG&&l.addFallback(0,"FOG"),o.POINTSIZE&&l.addFallback(1,"POINTSIZE"),o.MULTIVIEW&&l.addFallback(0,"MULTIVIEW"),C.HandleFallbacksForShadows(o,l,this._maxSimultaneousLights);var c=[L.PositionKind];o.NORMAL&&c.push(L.NormalKind),o.UV1&&c.push(L.UVKind),o.UV2&&c.push(L.UV2Kind),C.PrepareAttributesForBones(c,e,o,l),C.PrepareAttributesForInstances(c,o);var p=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix"],d=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],g=["Material","Scene"];Ie&&(Ie.PrepareUniforms(p,o),Ie.PrepareSamplers(d,o)),C.PrepareUniformsAndSamplersList({uniformsNames:p,uniformBuffersNames:g,samplers:d,defines:o,maxSimultaneousLights:this._maxSimultaneousLights});var m=o.toString(),y=a.getEngine().createEffect("background",{attributes:c,uniformsNames:p,uniformBuffersNames:g,samplers:d,defines:m,fallbacks:l,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights}},s);t.setEffect(y,o,this._materialContext),this.buildUniformLayout()}return!t.effect||!t.effect.isReady()?!1:(o._renderId=a.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,!0)},r.prototype._computePrimaryColorFromPerceptualColor=function(){!this.__perceptualColor||(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())},r.prototype._computePrimaryColors=function(){this._primaryColorShadowLevel===0&&this._primaryColorHighlightLevel===0||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))},r.prototype.buildUniformLayout=function(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.create()},r.prototype.unbind=function(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),n.prototype.unbind.call(this)},r.prototype.bindOnlyWorldMatrix=function(e){this._activeEffect.setMatrix("world",e)},r.prototype.bindForSubMesh=function(e,t,i){var a=this.getScene(),o=i.materialDefines;if(!!o){var s=i.effect;if(!!s){this._activeEffect=s,this.bindOnlyWorldMatrix(e),C.BindBonesParameters(t,this._activeEffect);var u=this._mustRebind(a,s,t.visibility);if(u){this._uniformBuffer.bindToEffect(s,"Material"),this.bindViewProjection(s);var l=this._reflectionTexture;(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync)&&(a.texturesEnabled&&(this._diffuseTexture&&R.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),C.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,"diffuse")),l&&R.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",l.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",l.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),o.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),a.texturesEnabled&&(this._diffuseTexture&&R.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),l&&R.ReflectionTextureEnabled&&(o.REFLECTIONBLUR&&o.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",l):o.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",l._lodTextureMid||l),this._uniformBuffer.setTexture("reflectionSamplerLow",l._lodTextureLow||l),this._uniformBuffer.setTexture("reflectionSamplerHigh",l._lodTextureHigh||l)):this._uniformBuffer.setTexture("reflectionSampler",l),o.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w)))),C.BindClipPlane(this._activeEffect,a),a.bindEyePosition(s)}else a.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(s,"Material"),this._needToBindSceneUbo=!0);(u||!this.isFrozen)&&(a.lightsEnabled&&C.BindLights(a,t,this._activeEffect,o,this._maxSimultaneousLights),this.bindView(s),C.BindFogParameters(a,t,this._activeEffect,!0),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),this._uniformBuffer.update()}}},r.prototype.hasTexture=function(e){return!!(n.prototype.hasTexture.call(this,e)||this._reflectionTexture===e||this._diffuseTexture===e)},r.prototype.dispose=function(e,t){e===void 0&&(e=!1),t===void 0&&(t=!1),t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),n.prototype.dispose.call(this,e)},r.prototype.clone=function(e){var t=this;return j.Clone(function(){return new r(e,t.getScene())},this)},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.customType="BABYLON.BackgroundMaterial",e},r.prototype.getClassName=function(){return"BackgroundMaterial"},r.Parse=function(e,t,i){return j.Parse(function(){return new r(e.name,t)},e,t,i)},r.StandardReflectance0=.05,r.StandardReflectance90=.5,h([le()],r.prototype,"_primaryColor",void 0),h([S("_markAllSubMeshesAsLightsDirty")],r.prototype,"primaryColor",void 0),h([le()],r.prototype,"__perceptualColor",void 0),h([b()],r.prototype,"_primaryColorShadowLevel",void 0),h([b()],r.prototype,"_primaryColorHighlightLevel",void 0),h([S("_markAllSubMeshesAsLightsDirty")],r.prototype,"primaryColorHighlightLevel",null),h([U()],r.prototype,"_reflectionTexture",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionTexture",void 0),h([b()],r.prototype,"_reflectionBlur",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionBlur",void 0),h([U()],r.prototype,"_diffuseTexture",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"diffuseTexture",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"shadowLights",void 0),h([b()],r.prototype,"_shadowLevel",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"shadowLevel",void 0),h([ti()],r.prototype,"_sceneCenter",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"sceneCenter",void 0),h([b()],r.prototype,"_opacityFresnel",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"opacityFresnel",void 0),h([b()],r.prototype,"_reflectionFresnel",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionFresnel",void 0),h([b()],r.prototype,"_reflectionFalloffDistance",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionFalloffDistance",void 0),h([b()],r.prototype,"_reflectionAmount",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionAmount",void 0),h([b()],r.prototype,"_reflectionReflectance0",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionReflectance0",void 0),h([b()],r.prototype,"_reflectionReflectance90",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionReflectance90",void 0),h([b()],r.prototype,"_useRGBColor",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useRGBColor",void 0),h([b()],r.prototype,"_enableNoise",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"enableNoise",void 0),h([b()],r.prototype,"_maxSimultaneousLights",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"maxSimultaneousLights",void 0),h([b()],r.prototype,"_shadowOnly",void 0),h([S("_markAllSubMeshesAsLightsDirty")],r.prototype,"shadowOnly",void 0),h([_r()],r.prototype,"_imageProcessingConfiguration",void 0),r}(Je);P("BABYLON.BackgroundMaterial",Mi);var Di=function(n){A(r,n);function r(){var e=n!==null&&n.apply(this,arguments)||this;return e.BRDF_V_HEIGHT_CORRELATED=!1,e.MS_BRDF_ENERGY_CONSERVATION=!1,e.SPHERICAL_HARMONICS=!1,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1,e}return r}(Ae),Li=function(n){A(r,n);function r(e,t){t===void 0&&(t=!0);var i=n.call(this,e,"PBRBRDF",90,new Di,t)||this;return i._useEnergyConservation=r.DEFAULT_USE_ENERGY_CONSERVATION,i.useEnergyConservation=r.DEFAULT_USE_ENERGY_CONSERVATION,i._useSmithVisibilityHeightCorrelated=r.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,i.useSmithVisibilityHeightCorrelated=r.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,i._useSphericalHarmonics=r.DEFAULT_USE_SPHERICAL_HARMONICS,i.useSphericalHarmonics=r.DEFAULT_USE_SPHERICAL_HARMONICS,i._useSpecularGlossinessInputEnergyConservation=r.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,i.useSpecularGlossinessInputEnergyConservation=r.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,i._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],i._enable(!0),i}return r.prototype._markAllSubMeshesAsMiscDirty=function(){this._internalMarkAllSubMeshesAsMiscDirty()},r.prototype.prepareDefines=function(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation},r.prototype.getClassName=function(){return"PBRBRDFConfiguration"},r.DEFAULT_USE_ENERGY_CONSERVATION=!0,r.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0,r.DEFAULT_USE_SPHERICAL_HARMONICS=!0,r.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0,h([b(),S("_markAllSubMeshesAsMiscDirty")],r.prototype,"useEnergyConservation",void 0),h([b(),S("_markAllSubMeshesAsMiscDirty")],r.prototype,"useSmithVisibilityHeightCorrelated",void 0),h([b(),S("_markAllSubMeshesAsMiscDirty")],r.prototype,"useSphericalHarmonics",void 0),h([b(),S("_markAllSubMeshesAsMiscDirty")],r.prototype,"useSpecularGlossinessInputEnergyConservation",void 0),r}(we),Bi=function(n){A(r,n);function r(){var e=n!==null&&n.apply(this,arguments)||this;return e.CLEARCOAT=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1,e}return r}(Ae),zt=function(n){A(r,n);function r(e,t){t===void 0&&(t=!0);var i=n.call(this,e,"PBRClearCoat",100,new Bi,t)||this;return i._isEnabled=!1,i.isEnabled=!1,i.intensity=1,i.roughness=0,i._indexOfRefraction=r._DefaultIndexOfRefraction,i.indexOfRefraction=r._DefaultIndexOfRefraction,i._texture=null,i.texture=null,i._useRoughnessFromMainTexture=!0,i.useRoughnessFromMainTexture=!0,i._textureRoughness=null,i.textureRoughness=null,i._remapF0OnInterfaceChange=!0,i.remapF0OnInterfaceChange=!0,i._bumpTexture=null,i.bumpTexture=null,i._isTintEnabled=!1,i.isTintEnabled=!1,i.tintColor=G.White(),i.tintColorAtDistance=1,i.tintThickness=1,i._tintTexture=null,i.tintTexture=null,i._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],i}return r.prototype._markAllSubMeshesAsTexturesDirty=function(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()},r.prototype.isReadyForSubMesh=function(e,t,i){if(!this._isEnabled)return!0;var a=this._material._disableBumpMap;return!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&R.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&R.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()||i.getCaps().standardDerivatives&&this._bumpTexture&&R.ClearCoatBumpTextureEnabled&&!a&&!this._bumpTexture.isReady()||this._isTintEnabled&&this._tintTexture&&R.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking()))},r.prototype.prepareDefinesBeforeAttributes=function(e,t){var i;this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((i=this._textureRoughness)===null||i===void 0?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&R.ClearCoatTextureEnabled?C.PrepareDefinesForMergedUV(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&R.ClearCoatTextureEnabled?C.PrepareDefinesForMergedUV(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&R.ClearCoatBumpTextureEnabled?C.PrepareDefinesForMergedUV(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===r._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&R.ClearCoatTintTextureEnabled?(C.PrepareDefinesForMergedUV(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1)},r.prototype.bindForSubMesh=function(e,t,i,a){var o,s,u,l,c,p,d,g;if(!!this._isEnabled){var m=a.materialDefines,y=this._material.isFrozen,v=this._material._disableBumpMap,T=this._material._invertNormalMapX,x=this._material._invertNormalMapY,E=m.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL;if(!e.useUbo||!y||!e.isSync){E&&R.ClearCoatTextureEnabled?(e.updateFloat4("vClearCoatInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),C.BindTextureMatrix(this._texture,e,"clearCoat")):(this._texture||this._textureRoughness)&&R.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",(s=(o=this._texture)===null||o===void 0?void 0:o.coordinatesIndex)!==null&&s!==void 0?s:0,(l=(u=this._texture)===null||u===void 0?void 0:u.level)!==null&&l!==void 0?l:0,(p=(c=this._textureRoughness)===null||c===void 0?void 0:c.coordinatesIndex)!==null&&p!==void 0?p:0,(g=(d=this._textureRoughness)===null||d===void 0?void 0:d.level)!==null&&g!==void 0?g:0),this._texture&&C.BindTextureMatrix(this._texture,e,"clearCoat"),this._textureRoughness&&!E&&!m.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&C.BindTextureMatrix(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&R.ClearCoatTextureEnabled&&!v&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),C.BindTextureMatrix(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",T?1:-1,x?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",T?-1:1,x?-1:1)),this._tintTexture&&R.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),C.BindTextureMatrix(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);var O=1-this._indexOfRefraction,N=1+this._indexOfRefraction,w=Math.pow(-O/N,2),k=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",w,k,O,N),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&R.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!E&&!m.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&R.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&R.ClearCoatBumpTextureEnabled&&!v&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&R.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}},r.prototype.hasTexture=function(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e},r.prototype.getActiveTextures=function(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)},r.prototype.getAnimatables=function(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)},r.prototype.dispose=function(e){var t,i,a,o;e&&((t=this._texture)===null||t===void 0||t.dispose(),(i=this._textureRoughness)===null||i===void 0||i.dispose(),(a=this._bumpTexture)===null||a===void 0||a.dispose(),(o=this._tintTexture)===null||o===void 0||o.dispose())},r.prototype.getClassName=function(){return"PBRClearCoatConfiguration"},r.prototype.addFallbacks=function(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i},r.prototype.getSamplers=function(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")},r.prototype.getUniforms=function(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}},r._DefaultIndexOfRefraction=1.5,h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"isEnabled",void 0),h([b()],r.prototype,"intensity",void 0),h([b()],r.prototype,"roughness",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"indexOfRefraction",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"texture",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useRoughnessFromMainTexture",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"textureRoughness",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"remapF0OnInterfaceChange",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"bumpTexture",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"isTintEnabled",void 0),h([le()],r.prototype,"tintColor",void 0),h([b()],r.prototype,"tintColorAtDistance",void 0),h([b()],r.prototype,"tintThickness",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"tintTexture",void 0),r}(we),Vi=function(n){A(r,n);function r(){var e=n!==null&&n.apply(this,arguments)||this;return e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1,e}return r}(Ae),Gt=function(n){A(r,n);function r(e,t){t===void 0&&(t=!0);var i=n.call(this,e,"PBRIridescence",110,new Vi,t)||this;return i._isEnabled=!1,i.isEnabled=!1,i.intensity=1,i.minimumThickness=r._DefaultMinimumThickness,i.maximumThickness=r._DefaultMaximumThickness,i.indexOfRefraction=r._DefaultIndexOfRefraction,i._texture=null,i.texture=null,i._thicknessTexture=null,i.thicknessTexture=null,i._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],i}return r.prototype._markAllSubMeshesAsTexturesDirty=function(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()},r.prototype.isReadyForSubMesh=function(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&R.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._thicknessTexture&&R.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())):!0},r.prototype.prepareDefinesBeforeAttributes=function(e,t){var i;this._isEnabled?(e.IRIDESCENCE=!0,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=this._texture!==null&&this._texture._texture===((i=this._thicknessTexture)===null||i===void 0?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._thicknessTexture),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&R.IridescenceTextureEnabled?C.PrepareDefinesForMergedUV(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,!e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&this._thicknessTexture&&R.IridescenceTextureEnabled?C.PrepareDefinesForMergedUV(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1)},r.prototype.bindForSubMesh=function(e,t,i,a){var o,s,u,l,c,p,d,g;if(!!this._isEnabled){var m=a.materialDefines,y=this._material.isFrozen,v=m.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE;(!e.useUbo||!y||!e.isSync)&&(v&&R.IridescenceTextureEnabled?(e.updateFloat4("vIridescenceInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),C.BindTextureMatrix(this._texture,e,"iridescence")):(this._texture||this._thicknessTexture)&&R.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",(s=(o=this._texture)===null||o===void 0?void 0:o.coordinatesIndex)!==null&&s!==void 0?s:0,(l=(u=this._texture)===null||u===void 0?void 0:u.level)!==null&&l!==void 0?l:0,(p=(c=this._thicknessTexture)===null||c===void 0?void 0:c.coordinatesIndex)!==null&&p!==void 0?p:0,(g=(d=this._thicknessTexture)===null||d===void 0?void 0:d.level)!==null&&g!==void 0?g:0),this._texture&&C.BindTextureMatrix(this._texture,e,"iridescence"),this._thicknessTexture&&!v&&!m.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&C.BindTextureMatrix(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&R.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&!v&&!m.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&R.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}},r.prototype.hasTexture=function(e){return this._texture===e||this._thicknessTexture===e},r.prototype.getActiveTextures=function(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)},r.prototype.getAnimatables=function(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)},r.prototype.dispose=function(e){var t,i;e&&((t=this._texture)===null||t===void 0||t.dispose(),(i=this._thicknessTexture)===null||i===void 0||i.dispose())},r.prototype.getClassName=function(){return"PBRIridescenceConfiguration"},r.prototype.addFallbacks=function(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i},r.prototype.getSamplers=function(e){e.push("iridescenceSampler","iridescenceThicknessSampler")},r.prototype.getUniforms=function(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}},r._DefaultMinimumThickness=100,r._DefaultMaximumThickness=400,r._DefaultIndexOfRefraction=1.3,h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"isEnabled",void 0),h([b()],r.prototype,"intensity",void 0),h([b()],r.prototype,"minimumThickness",void 0),h([b()],r.prototype,"maximumThickness",void 0),h([b()],r.prototype,"indexOfRefraction",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"texture",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"thicknessTexture",void 0),r}(we),wi=function(n){A(r,n);function r(){var e=n!==null&&n.apply(this,arguments)||this;return e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.MAINUV1=!1,e}return r}(Ae),ki=function(n){A(r,n);function r(e,t){t===void 0&&(t=!0);var i=n.call(this,e,"PBRAnisotropic",110,new wi,t)||this;return i._isEnabled=!1,i.isEnabled=!1,i.intensity=1,i.direction=new Te(1,0),i._texture=null,i.texture=null,i._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],i}return r.prototype._markAllSubMeshesAsTexturesDirty=function(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()},r.prototype.isReadyForSubMesh=function(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&R.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking()):!0},r.prototype.prepareDefinesBeforeAttributes=function(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(L.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&R.AnisotropicTextureEnabled?C.PrepareDefinesForMergedUV(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1)},r.prototype.bindForSubMesh=function(e,t){if(!!this._isEnabled){var i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&(this._texture&&R.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),C.BindTextureMatrix(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&R.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}},r.prototype.hasTexture=function(e){return this._texture===e},r.prototype.getActiveTextures=function(e){this._texture&&e.push(this._texture)},r.prototype.getAnimatables=function(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)},r.prototype.dispose=function(e){e&&this._texture&&this._texture.dispose()},r.prototype.getClassName=function(){return"PBRAnisotropicConfiguration"},r.prototype.addFallbacks=function(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i},r.prototype.getSamplers=function(e){e.push("anisotropySampler")},r.prototype.getUniforms=function(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}},h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"isEnabled",void 0),h([b()],r.prototype,"intensity",void 0),h([ri()],r.prototype,"direction",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"texture",void 0),r}(we),Ui=function(n){A(r,n);function r(){var e=n!==null&&n.apply(this,arguments)||this;return e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1,e}return r}(Ae),zi=function(n){A(r,n);function r(e,t){t===void 0&&(t=!0);var i=n.call(this,e,"Sheen",120,new Ui,t)||this;return i._isEnabled=!1,i.isEnabled=!1,i._linkSheenWithAlbedo=!1,i.linkSheenWithAlbedo=!1,i.intensity=1,i.color=G.White(),i._texture=null,i.texture=null,i._useRoughnessFromMainTexture=!0,i.useRoughnessFromMainTexture=!0,i._roughness=null,i.roughness=null,i._textureRoughness=null,i.textureRoughness=null,i._albedoScaling=!1,i.albedoScaling=!1,i._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],i}return r.prototype._markAllSubMeshesAsTexturesDirty=function(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()},r.prototype.isReadyForSubMesh=function(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&R.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&R.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())):!0},r.prototype.prepareDefinesBeforeAttributes=function(e,t){var i;this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=this._roughness!==null,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((i=this._textureRoughness)===null||i===void 0?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&R.SheenTextureEnabled?(C.PrepareDefinesForMergedUV(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&R.SheenTextureEnabled?C.PrepareDefinesForMergedUV(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1)},r.prototype.bindForSubMesh=function(e,t,i,a){var o,s,u,l,c,p,d,g;if(!!this._isEnabled){var m=a.materialDefines,y=this._material.isFrozen,v=m.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL;(!e.useUbo||!y||!e.isSync)&&(v&&R.SheenTextureEnabled?(e.updateFloat4("vSheenInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),C.BindTextureMatrix(this._texture,e,"sheen")):(this._texture||this._textureRoughness)&&R.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",(s=(o=this._texture)===null||o===void 0?void 0:o.coordinatesIndex)!==null&&s!==void 0?s:0,(l=(u=this._texture)===null||u===void 0?void 0:u.level)!==null&&l!==void 0?l:0,(p=(c=this._textureRoughness)===null||c===void 0?void 0:c.coordinatesIndex)!==null&&p!==void 0?p:0,(g=(d=this._textureRoughness)===null||d===void 0?void 0:d.level)!==null&&g!==void 0?g:0),this._texture&&C.BindTextureMatrix(this._texture,e,"sheen"),this._textureRoughness&&!v&&!m.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&C.BindTextureMatrix(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),this._roughness!==null&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&R.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!v&&!m.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&R.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}},r.prototype.hasTexture=function(e){return this._texture===e||this._textureRoughness===e},r.prototype.getActiveTextures=function(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)},r.prototype.getAnimatables=function(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)},r.prototype.dispose=function(e){var t,i;e&&((t=this._texture)===null||t===void 0||t.dispose(),(i=this._textureRoughness)===null||i===void 0||i.dispose())},r.prototype.getClassName=function(){return"PBRSheenConfiguration"},r.prototype.addFallbacks=function(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i},r.prototype.getSamplers=function(e){e.push("sheenSampler","sheenRoughnessSampler")},r.prototype.getUniforms=function(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}},h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"isEnabled",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"linkSheenWithAlbedo",void 0),h([b()],r.prototype,"intensity",void 0),h([le()],r.prototype,"color",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"texture",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useRoughnessFromMainTexture",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"roughness",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"textureRoughness",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"albedoScaling",void 0),r}(we),Gi=function(n){A(r,n);function r(){var e=n!==null&&n.apply(this,arguments)||this;return e.SUBSURFACE=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_TRANSLUCENCY=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_SCATTERING=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1,e}return r}(Ae),Hi=function(n){A(r,n);function r(e,t){t===void 0&&(t=!0);var i=n.call(this,e,"PBRSubSurface",130,new Gi,t)||this;return i._isRefractionEnabled=!1,i.isRefractionEnabled=!1,i._isTranslucencyEnabled=!1,i.isTranslucencyEnabled=!1,i._isScatteringEnabled=!1,i.isScatteringEnabled=!1,i._scatteringDiffusionProfileIndex=0,i.refractionIntensity=1,i.translucencyIntensity=1,i.useAlbedoToTintRefraction=!1,i.useAlbedoToTintTranslucency=!1,i._thicknessTexture=null,i.thicknessTexture=null,i._refractionTexture=null,i.refractionTexture=null,i._indexOfRefraction=1.5,i.indexOfRefraction=1.5,i._volumeIndexOfRefraction=-1,i._invertRefractionY=!1,i.invertRefractionY=!1,i._linkRefractionWithTransparency=!1,i.linkRefractionWithTransparency=!1,i.minimumThickness=0,i.maximumThickness=1,i.useThicknessAsDepth=!1,i.tintColor=G.White(),i.tintColorAtDistance=1,i.diffusionDistance=G.White(),i._useMaskFromThicknessTexture=!1,i.useMaskFromThicknessTexture=!1,i._refractionIntensityTexture=null,i.refractionIntensityTexture=null,i._translucencyIntensityTexture=null,i.translucencyIntensityTexture=null,i._useGltfStyleTextures=!1,i.useGltfStyleTextures=!1,i._scene=e.getScene(),i.registerForExtraEvents=!0,i._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],i._internalMarkScenePrePassDirty=e._dirtyCallbacks[32],i}return Object.defineProperty(r.prototype,"scatteringDiffusionProfile",{get:function(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null},set:function(e){!this._scene.enableSubSurfaceForPrePass()||e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"volumeIndexOfRefraction",{get:function(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction},set:function(e){e>=1?this._volumeIndexOfRefraction=e:this._volumeIndexOfRefraction=-1},enumerable:!1,configurable:!0}),r.prototype._markAllSubMeshesAsTexturesDirty=function(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()},r.prototype._markScenePrePassDirty=function(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()},r.prototype.isReadyForSubMesh=function(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&R.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1;var i=this._getRefractionTexture(t);if(i&&R.RefractionTextureEnabled&&!i.isReadyOrNotBlocking())return!1}return!0},r.prototype.prepareDefinesBeforeAttributes=function(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled){e.SUBSURFACE=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1;return}if(e._areTexturesDirty){e.SUBSURFACE=!0,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1;var i=!!this._thicknessTexture&&!!this._refractionIntensityTexture&&this._refractionIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._refractionIntensityTexture._texture===this._thicknessTexture._texture,a=!!this._thicknessTexture&&!!this._translucencyIntensityTexture&&this._translucencyIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._translucencyIntensityTexture._texture===this._thicknessTexture._texture,o=(i||!this._refractionIntensityTexture)&&(a||!this._translucencyIntensityTexture);if(e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&R.ThicknessTextureEnabled&&C.PrepareDefinesForMergedUV(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&R.RefractionIntensityTextureEnabled&&!o&&C.PrepareDefinesForMergedUV(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&R.TranslucencyIntensityTextureEnabled&&!o&&C.PrepareDefinesForMergedUV(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE")),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!==0,e.SS_MASK_FROM_THICKNESS_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture||!!this._translucencyIntensityTexture)&&o,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture)&&o,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._translucencyIntensityTexture)&&o,this._isRefractionEnabled&&t.texturesEnabled){var s=this._getRefractionTexture(t);s&&R.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=s.isCube,e.SS_GAMMAREFRACTION=s.gammaSpace,e.SS_RGBDREFRACTION=s.isRGBD,e.SS_LINEARSPECULARREFRACTION=s.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=s.invertZ,e.SS_LODINREFRACTIONALPHA=s.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=s.isCube&&s.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}},r.prototype.hardBindForSubMesh=function(e,t,i,a){if(!(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)){a.getRenderingMesh().getWorldMatrix().decompose(Ee.Vector3[0]);var o=Math.max(Math.abs(Ee.Vector3[0].x),Math.abs(Ee.Vector3[0].y),Math.abs(Ee.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*o,(this.maximumThickness-this.minimumThickness)*o)}},r.prototype.bindForSubMesh=function(e,t,i,a){if(!(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)){var o=a.materialDefines,s=this._material.isFrozen,u=this._material.realTimeFiltering,l=o.LODBASEDMICROSFURACE,c=this._getRefractionTexture(t);if(!e.useUbo||!s||!e.isSync){if(this._thicknessTexture&&R.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),C.BindTextureMatrix(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&R.RefractionIntensityTextureEnabled&&o.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),C.BindTextureMatrix(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyIntensityTexture&&R.TranslucencyIntensityTextureEnabled&&o.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),C.BindTextureMatrix(this._translucencyIntensityTexture,e,"translucencyIntensity")),c&&R.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",c.getReflectionTextureMatrix());var p=1;c.isCube||c.depth&&(p=c.depth);var d=c.getSize().width,g=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",c.level,1/g,p,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",d,c.lodGenerationScale,c.lodGenerationOffset,1/this.indexOfRefraction),u&&e.updateFloat2("vRefractionFilteringInfo",d,Ze.Log2(d)),c.boundingBoxSize){var m=c;e.updateVector3("vRefractionPosition",m.boundingBoxPosition),e.updateVector3("vRefractionSize",m.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0)}t.texturesEnabled&&(this._thicknessTexture&&R.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&R.RefractionIntensityTextureEnabled&&o.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&R.TranslucencyIntensityTextureEnabled&&o.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),c&&R.RefractionTextureEnabled&&(l?e.setTexture("refractionSampler",c):(e.setTexture("refractionSampler",c._lodTextureMid||c),e.setTexture("refractionSamplerLow",c._lodTextureLow||c),e.setTexture("refractionSamplerHigh",c._lodTextureHigh||c))))}},r.prototype._getRefractionTexture=function(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null},Object.defineProperty(r.prototype,"disableAlphaBlending",{get:function(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency},enumerable:!1,configurable:!0}),r.prototype.fillRenderTargetTextures=function(e){R.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)},r.prototype.hasTexture=function(e){return this._thicknessTexture===e||this._refractionTexture===e},r.prototype.hasRenderTargetTextures=function(){return!!(R.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)},r.prototype.getActiveTextures=function(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture)},r.prototype.getAnimatables=function(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture)},r.prototype.dispose=function(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose())},r.prototype.getClassName=function(){return"PBRSubSurfaceConfiguration"},r.prototype.addFallbacks=function(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i},r.prototype.getSamplers=function(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh")},r.prototype.getUniforms=function(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"}]}},h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"isRefractionEnabled",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"isTranslucencyEnabled",void 0),h([b(),S("_markScenePrePassDirty")],r.prototype,"isScatteringEnabled",void 0),h([b()],r.prototype,"_scatteringDiffusionProfileIndex",void 0),h([b()],r.prototype,"refractionIntensity",void 0),h([b()],r.prototype,"translucencyIntensity",void 0),h([b()],r.prototype,"useAlbedoToTintRefraction",void 0),h([b()],r.prototype,"useAlbedoToTintTranslucency",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"thicknessTexture",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"refractionTexture",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"indexOfRefraction",void 0),h([b()],r.prototype,"_volumeIndexOfRefraction",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"volumeIndexOfRefraction",null),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"invertRefractionY",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"linkRefractionWithTransparency",void 0),h([b()],r.prototype,"minimumThickness",void 0),h([b()],r.prototype,"maximumThickness",void 0),h([b()],r.prototype,"useThicknessAsDepth",void 0),h([le()],r.prototype,"tintColor",void 0),h([b()],r.prototype,"tintColorAtDistance",void 0),h([le()],r.prototype,"diffusionDistance",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useMaskFromThicknessTexture",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"refractionIntensityTexture",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"translucencyIntensityTexture",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useGltfStyleTextures",void 0),r}(we),Ue={effect:null,subMesh:null},fr=function(n){A(r,n);function r(e){var t=n.call(this,e)||this;return t.PBR=!0,t.NUM_SAMPLES="0",t.REALTIME_FILTERING=!1,t.MAINUV1=!1,t.MAINUV2=!1,t.MAINUV3=!1,t.MAINUV4=!1,t.MAINUV5=!1,t.MAINUV6=!1,t.UV1=!1,t.UV2=!1,t.UV3=!1,t.UV4=!1,t.UV5=!1,t.UV6=!1,t.ALBEDO=!1,t.GAMMAALBEDO=!1,t.ALBEDODIRECTUV=0,t.VERTEXCOLOR=!1,t.BAKED_VERTEX_ANIMATION_TEXTURE=!1,t.AMBIENT=!1,t.AMBIENTDIRECTUV=0,t.AMBIENTINGRAYSCALE=!1,t.OPACITY=!1,t.VERTEXALPHA=!1,t.OPACITYDIRECTUV=0,t.OPACITYRGB=!1,t.ALPHATEST=!1,t.DEPTHPREPASS=!1,t.ALPHABLEND=!1,t.ALPHAFROMALBEDO=!1,t.ALPHATESTVALUE="0.5",t.SPECULAROVERALPHA=!1,t.RADIANCEOVERALPHA=!1,t.ALPHAFRESNEL=!1,t.LINEARALPHAFRESNEL=!1,t.PREMULTIPLYALPHA=!1,t.EMISSIVE=!1,t.EMISSIVEDIRECTUV=0,t.GAMMAEMISSIVE=!1,t.REFLECTIVITY=!1,t.REFLECTIVITY_GAMMA=!1,t.REFLECTIVITYDIRECTUV=0,t.SPECULARTERM=!1,t.MICROSURFACEFROMREFLECTIVITYMAP=!1,t.MICROSURFACEAUTOMATIC=!1,t.LODBASEDMICROSFURACE=!1,t.MICROSURFACEMAP=!1,t.MICROSURFACEMAPDIRECTUV=0,t.METALLICWORKFLOW=!1,t.ROUGHNESSSTOREINMETALMAPALPHA=!1,t.ROUGHNESSSTOREINMETALMAPGREEN=!1,t.METALLNESSSTOREINMETALMAPBLUE=!1,t.AOSTOREINMETALMAPRED=!1,t.METALLIC_REFLECTANCE=!1,t.METALLIC_REFLECTANCE_GAMMA=!1,t.METALLIC_REFLECTANCEDIRECTUV=0,t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,t.REFLECTANCE=!1,t.REFLECTANCE_GAMMA=!1,t.REFLECTANCEDIRECTUV=0,t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1,t.NORMAL=!1,t.TANGENT=!1,t.BUMP=!1,t.BUMPDIRECTUV=0,t.OBJECTSPACE_NORMALMAP=!1,t.PARALLAX=!1,t.PARALLAXOCCLUSION=!1,t.NORMALXYSCALE=!0,t.LIGHTMAP=!1,t.LIGHTMAPDIRECTUV=0,t.USELIGHTMAPASSHADOWMAP=!1,t.GAMMALIGHTMAP=!1,t.RGBDLIGHTMAP=!1,t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1,t.RADIANCEOCCLUSION=!1,t.HORIZONOCCLUSION=!1,t.INSTANCES=!1,t.THIN_INSTANCES=!1,t.INSTANCESCOLOR=!1,t.PREPASS=!1,t.PREPASS_IRRADIANCE=!1,t.PREPASS_IRRADIANCE_INDEX=-1,t.PREPASS_ALBEDO_SQRT=!1,t.PREPASS_ALBEDO_SQRT_INDEX=-1,t.PREPASS_DEPTH=!1,t.PREPASS_DEPTH_INDEX=-1,t.PREPASS_NORMAL=!1,t.PREPASS_NORMAL_INDEX=-1,t.PREPASS_POSITION=!1,t.PREPASS_POSITION_INDEX=-1,t.PREPASS_VELOCITY=!1,t.PREPASS_VELOCITY_INDEX=-1,t.PREPASS_REFLECTIVITY=!1,t.PREPASS_REFLECTIVITY_INDEX=-1,t.SCENE_MRT_COUNT=0,t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,t.BONETEXTURE=!1,t.BONES_VELOCITY_ENABLED=!1,t.NONUNIFORMSCALING=!1,t.MORPHTARGETS=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_UV=!1,t.NUM_MORPH_INFLUENCERS=0,t.MORPHTARGETS_TEXTURE=!1,t.IMAGEPROCESSING=!1,t.VIGNETTE=!1,t.VIGNETTEBLENDMODEMULTIPLY=!1,t.VIGNETTEBLENDMODEOPAQUE=!1,t.TONEMAPPING=!1,t.TONEMAPPING_ACES=!1,t.CONTRAST=!1,t.COLORCURVES=!1,t.COLORGRADING=!1,t.COLORGRADING3D=!1,t.SAMPLER3DGREENDEPTH=!1,t.SAMPLER3DBGRMAP=!1,t.IMAGEPROCESSINGPOSTPROCESS=!1,t.SKIPFINALCOLORCLAMP=!1,t.EXPOSURE=!1,t.MULTIVIEW=!1,t.ORDER_INDEPENDENT_TRANSPARENCY=!1,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1,t.TWOSIDEDLIGHTING=!1,t.SHADOWFLOAT=!1,t.CLIPPLANE=!1,t.CLIPPLANE2=!1,t.CLIPPLANE3=!1,t.CLIPPLANE4=!1,t.CLIPPLANE5=!1,t.CLIPPLANE6=!1,t.POINTSIZE=!1,t.FOG=!1,t.LOGARITHMICDEPTH=!1,t.FORCENORMALFORWARD=!1,t.SPECULARAA=!1,t.UNLIT=!1,t.DEBUGMODE=0,t.rebuild(),t}return r.prototype.reset=function(){n.prototype.reset.call(this),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0},r}(Ae),pe=function(n){A(r,n);function r(e,t){var i=n.call(this,e,t)||this;return i._directIntensity=1,i._emissiveIntensity=1,i._environmentIntensity=1,i._specularIntensity=1,i._lightingInfos=new Me(i._directIntensity,i._emissiveIntensity,i._environmentIntensity,i._specularIntensity),i._disableBumpMap=!1,i._albedoTexture=null,i._ambientTexture=null,i._ambientTextureStrength=1,i._ambientTextureImpactOnAnalyticalLights=r.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,i._opacityTexture=null,i._reflectionTexture=null,i._emissiveTexture=null,i._reflectivityTexture=null,i._metallicTexture=null,i._metallic=null,i._roughness=null,i._metallicF0Factor=1,i._metallicReflectanceColor=G.White(),i._useOnlyMetallicFromMetallicReflectanceTexture=!1,i._metallicReflectanceTexture=null,i._reflectanceTexture=null,i._microSurfaceTexture=null,i._bumpTexture=null,i._lightmapTexture=null,i._ambientColor=new G(0,0,0),i._albedoColor=new G(1,1,1),i._reflectivityColor=new G(1,1,1),i._reflectionColor=new G(1,1,1),i._emissiveColor=new G(0,0,0),i._microSurface=.9,i._useLightmapAsShadowmap=!1,i._useHorizonOcclusion=!0,i._useRadianceOcclusion=!0,i._useAlphaFromAlbedoTexture=!1,i._useSpecularOverAlpha=!0,i._useMicroSurfaceFromReflectivityMapAlpha=!1,i._useRoughnessFromMetallicTextureAlpha=!0,i._useRoughnessFromMetallicTextureGreen=!1,i._useMetallnessFromMetallicTextureBlue=!1,i._useAmbientOcclusionFromMetallicTextureRed=!1,i._useAmbientInGrayScale=!1,i._useAutoMicroSurfaceFromReflectivityMap=!1,i._lightFalloff=r.LIGHTFALLOFF_PHYSICAL,i._useRadianceOverAlpha=!0,i._useObjectSpaceNormalMap=!1,i._useParallax=!1,i._useParallaxOcclusion=!1,i._parallaxScaleBias=.05,i._disableLighting=!1,i._maxSimultaneousLights=4,i._invertNormalMapX=!1,i._invertNormalMapY=!1,i._twoSidedLighting=!1,i._alphaCutOff=.4,i._forceAlphaTest=!1,i._useAlphaFresnel=!1,i._useLinearAlphaFresnel=!1,i._environmentBRDFTexture=null,i._forceIrradianceInFragment=!1,i._realTimeFiltering=!1,i._realTimeFilteringQuality=8,i._forceNormalForward=!1,i._enableSpecularAntiAliasing=!1,i._imageProcessingObserver=null,i._renderTargets=new Yt(16),i._globalAmbientColor=new G(0,0,0),i._useLogarithmicDepth=!1,i._unlit=!1,i._debugMode=0,i.debugMode=0,i._debugLimit=-1,i._debugFactor=1,i._cacheHasRenderTargetTextures=!1,i.brdf=new Li(i),i.clearCoat=new zt(i),i.iridescence=new Gt(i),i.anisotropy=new ki(i),i.sheen=new zi(i),i.subSurface=new Hi(i),i.detailMap=new Ar(i),i._attachImageProcessingConfiguration(null),i.getRenderTargetTextures=function(){return i._renderTargets.reset(),R.ReflectionTextureEnabled&&i._reflectionTexture&&i._reflectionTexture.isRenderTarget&&i._renderTargets.push(i._reflectionTexture),i._eventInfo.renderTargets=i._renderTargets,i._callbackPluginEventFillRenderTargetTextures(i._eventInfo),i._renderTargets},i._environmentBRDFTexture=Xt(i.getScene()),i.prePassConfiguration=new Ge,i}return Object.defineProperty(r.prototype,"realTimeFiltering",{get:function(){return this._realTimeFiltering},set:function(e){this._realTimeFiltering=e,this.markAsDirty(1)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"realTimeFilteringQuality",{get:function(){return this._realTimeFilteringQuality},set:function(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"canRenderToMRT",{get:function(){return!0},enumerable:!1,configurable:!0}),r.prototype._attachImageProcessingConfiguration=function(e){var t=this;e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){t._markAllSubMeshesAsImageProcessingDirty()})))},Object.defineProperty(r.prototype,"hasRenderTargetTextures",{get:function(){return R.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isPrePassCapable",{get:function(){return!this.disableDepthWrite},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"PBRBaseMaterial"},Object.defineProperty(r.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"_disableAlphaBlending",{get:function(){var e;return this._transparencyMode===r.PBRMATERIAL_OPAQUE||this._transparencyMode===r.PBRMATERIAL_ALPHATEST||((e=this.subSurface)===null||e===void 0?void 0:e.disableAlphaBlending)},enumerable:!1,configurable:!0}),r.prototype.needAlphaBlending=function(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromAlbedoTexture()},r.prototype.needAlphaTesting=function(){var e;return this._forceAlphaTest?!0:!((e=this.subSurface)===null||e===void 0)&&e.disableAlphaBlending?!1:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===r.PBRMATERIAL_ALPHATEST)},r.prototype._shouldUseAlphaFromAlbedoTexture=function(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==r.PBRMATERIAL_OPAQUE},r.prototype._hasAlphaChannel=function(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha||this._opacityTexture!=null},r.prototype.getAlphaTestTexture=function(){return this._albedoTexture},r.prototype.isReadyForSubMesh=function(e,t,i){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(ue.GetDefineNames,this._eventInfo),t.materialDefines=new fr(this._eventInfo.defineNames));var a=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;var o=this.getScene(),s=o.getEngine();if(a._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,o.texturesEnabled)){if(this._albedoTexture&&R.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking()||this._ambientTexture&&R.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking()||this._opacityTexture&&R.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;var u=this._getReflectionTexture();if(u&&R.ReflectionTextureEnabled&&(!u.isReadyOrNotBlocking()||u.irradianceTexture&&!u.irradianceTexture.isReadyOrNotBlocking())||this._lightmapTexture&&R.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking()||this._emissiveTexture&&R.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(R.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking()||this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking()||this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(s.getCaps().standardDerivatives&&this._bumpTexture&&R.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady()||this._environmentBRDFTexture&&R.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=a,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh||a._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;!s.getCaps().standardDerivatives&&!e.isVerticesDataPresent(L.NormalKind)&&(e.createNormals(!0),$.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));var l=t.effect,c=a._areLightsDisposed,p=this._prepareEffect(e,a,this.onCompiled,this.onError,i,null,t.getRenderingMesh().hasThinInstances);if(p)if(this._onEffectCreatedObservable&&(Ue.effect=p,Ue.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Ue)),this.allowShaderHotSwapping&&l&&!p.isReady()){if(p=l,a.markAsUnprocessed(),c)return a._areLightsDisposed=!0,!1}else o.resetCachedMaterial(),t.setEffect(p,a,this._materialContext);return!t.effect||!t.effect.isReady()?!1:(a._renderId=o.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=!!i,!0)},r.prototype.isMetallicWorkflow=function(){return!!(this._metallic!=null||this._roughness!=null||this._metallicTexture)},r.prototype._prepareEffect=function(e,t,i,a,o,s,u){if(i===void 0&&(i=null),a===void 0&&(a=null),o===void 0&&(o=null),s===void 0&&(s=null),this._prepareDefines(e,t,o,s,u),!t.isDirty)return null;t.markAsProcessed();var l=this.getScene(),c=l.getEngine(),p=new $e,d=0;t.USESPHERICALINVERTEX&&p.addFallback(d++,"USESPHERICALINVERTEX"),t.FOG&&p.addFallback(d,"FOG"),t.SPECULARAA&&p.addFallback(d,"SPECULARAA"),t.POINTSIZE&&p.addFallback(d,"POINTSIZE"),t.LOGARITHMICDEPTH&&p.addFallback(d,"LOGARITHMICDEPTH"),t.PARALLAX&&p.addFallback(d,"PARALLAX"),t.PARALLAXOCCLUSION&&p.addFallback(d++,"PARALLAXOCCLUSION"),t.ENVIRONMENTBRDF&&p.addFallback(d++,"ENVIRONMENTBRDF"),t.TANGENT&&p.addFallback(d++,"TANGENT"),t.BUMP&&p.addFallback(d++,"BUMP"),d=C.HandleFallbacksForShadows(t,p,this._maxSimultaneousLights,d++),t.SPECULARTERM&&p.addFallback(d++,"SPECULARTERM"),t.USESPHERICALFROMREFLECTIONMAP&&p.addFallback(d++,"USESPHERICALFROMREFLECTIONMAP"),t.USEIRRADIANCEMAP&&p.addFallback(d++,"USEIRRADIANCEMAP"),t.LIGHTMAP&&p.addFallback(d++,"LIGHTMAP"),t.NORMAL&&p.addFallback(d++,"NORMAL"),t.AMBIENT&&p.addFallback(d++,"AMBIENT"),t.EMISSIVE&&p.addFallback(d++,"EMISSIVE"),t.VERTEXCOLOR&&p.addFallback(d++,"VERTEXCOLOR"),t.MORPHTARGETS&&p.addFallback(d++,"MORPHTARGETS"),t.MULTIVIEW&&p.addFallback(0,"MULTIVIEW");var g=[L.PositionKind];t.NORMAL&&g.push(L.NormalKind),t.TANGENT&&g.push(L.TangentKind);for(var m=1;m<=6;++m)t["UV"+m]&&g.push("uv".concat(m===1?"":m));t.VERTEXCOLOR&&g.push(L.ColorKind),t.INSTANCESCOLOR&&g.push(L.ColorInstanceKind),C.PrepareAttributesForBones(g,e,t,p),C.PrepareAttributesForInstances(g,t),C.PrepareAttributesForMorphTargets(g,e,t),C.PrepareAttributesForBakedVertexAnimation(g,e,t);var y="pbr",v=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],T=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],x=["Material","Scene","Mesh"];this._eventInfo.fallbacks=p,this._eventInfo.fallbackRank=d,this._eventInfo.defines=t,this._eventInfo.uniforms=v,this._eventInfo.attributes=g,this._eventInfo.samplers=T,this._eventInfo.uniformBuffersNames=x,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._callbackPluginEventGeneric(ue.PrepareEffect,this._eventInfo),Ge.AddUniforms(v),Ge.AddSamplers(T),Ie&&(Ie.PrepareUniforms(v,t),Ie.PrepareSamplers(T,t)),C.PrepareUniformsAndSamplersList({uniformsNames:v,uniformBuffersNames:x,samplers:T,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});var E={};this.customShaderNameResolve&&(y=this.customShaderNameResolve(y,v,x,T,t,g,E));var O=t.toString();return c.createEffect(y,{attributes:g,uniformsNames:v,uniformBuffersNames:x,samplers:T,defines:O,fallbacks:p,onCompiled:i,onError:a,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS},processFinalCode:E.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:t.PREPASS},c)},r.prototype._prepareDefines=function(e,t,i,a,o){var s;i===void 0&&(i=null),a===void 0&&(a=null),o===void 0&&(o=!1);var u=this.getScene(),l=u.getEngine();C.PrepareDefinesForLights(u,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,C.PrepareDefinesForMultiview(u,t);var c=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(C.PrepareDefinesForPrePass(u,t,this.canRenderToMRT&&!c),C.PrepareDefinesForOIT(u,t,c),t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){if(t._needUVs=!1,u.texturesEnabled){t.ALBEDODIRECTUV=0,t.AMBIENTDIRECTUV=0,t.OPACITYDIRECTUV=0,t.EMISSIVEDIRECTUV=0,t.REFLECTIVITYDIRECTUV=0,t.MICROSURFACEMAPDIRECTUV=0,t.METALLIC_REFLECTANCEDIRECTUV=0,t.REFLECTANCEDIRECTUV=0,t.BUMPDIRECTUV=0,t.LIGHTMAPDIRECTUV=0,l.getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&R.DiffuseTextureEnabled?(C.PrepareDefinesForMergedUV(this._albedoTexture,t,"ALBEDO"),t.GAMMAALBEDO=this._albedoTexture.gammaSpace):t.ALBEDO=!1,this._ambientTexture&&R.AmbientTextureEnabled?(C.PrepareDefinesForMergedUV(this._ambientTexture,t,"AMBIENT"),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&R.OpacityTextureEnabled?(C.PrepareDefinesForMergedUV(this._opacityTexture,t,"OPACITY"),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;var p=this._getReflectionTexture();if(p&&R.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=p.gammaSpace,t.RGBDREFLECTION=p.isRGBD,t.LODINREFLECTIONALPHA=p.lodLevelInAlpha,t.LINEARSPECULARREFLECTION=p.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(t.NUM_SAMPLES=""+this.realTimeFilteringQuality,l._features.needTypeSuffixInShaderConstants&&(t.NUM_SAMPLES=t.NUM_SAMPLES+"u"),t.REALTIME_FILTERING=!0):t.REALTIME_FILTERING=!1,p.coordinatesMode===I.INVCUBIC_MODE&&(t.INVERTCUBICMAP=!0),t.REFLECTIONMAP_3D=p.isCube,t.REFLECTIONMAP_OPPOSITEZ=t.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!p.invertZ:p.invertZ,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,p.coordinatesMode){case I.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case I.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case I.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case I.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case I.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case I.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case I.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case I.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case I.CUBIC_MODE:case I.INVCUBIC_MODE:default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!p.boundingBoxSize;break}p.coordinatesMode!==I.SKYBOX_MODE&&(p.irradianceTexture?(t.USEIRRADIANCEMAP=!0,t.USESPHERICALFROMREFLECTIONMAP=!1):p.isCube&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||l.getCaps().maxVaryingVectors<=8?t.USESPHERICALINVERTEX=!1:t.USESPHERICALINVERTEX=!0))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1;if(this._lightmapTexture&&R.LightmapTextureEnabled?(C.PrepareDefinesForMergedUV(this._lightmapTexture,t,"LIGHTMAP"),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,t.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):t.LIGHTMAP=!1,this._emissiveTexture&&R.EmissiveTextureEnabled?(C.PrepareDefinesForMergedUV(this._emissiveTexture,t,"EMISSIVE"),t.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):t.EMISSIVE=!1,R.SpecularTextureEnabled){if(this._metallicTexture?(C.PrepareDefinesForMergedUV(this._metallicTexture,t,"REFLECTIVITY"),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,t.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?(C.PrepareDefinesForMergedUV(this._reflectivityTexture,t,"REFLECTIVITY"),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,t.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):t.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture){var d=this._metallicReflectanceTexture!==null&&this._metallicReflectanceTexture._texture===((s=this._reflectanceTexture)===null||s===void 0?void 0:s._texture)&&this._metallicReflectanceTexture.checkTransformsAreIdentical(this._reflectanceTexture);t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture&&!d,this._metallicReflectanceTexture?(C.PrepareDefinesForMergedUV(this._metallicReflectanceTexture,t,"METALLIC_REFLECTANCE"),t.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):t.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&!d&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(C.PrepareDefinesForMergedUV(this._reflectanceTexture,t,"REFLECTANCE"),t.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):t.REFLECTANCE=!1}else t.METALLIC_REFLECTANCE=!1,t.REFLECTANCE=!1;this._microSurfaceTexture?C.PrepareDefinesForMergedUV(this._microSurfaceTexture,t,"MICROSURFACEMAP"):t.MICROSURFACEMAP=!1}else t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1;l.getCaps().standardDerivatives&&this._bumpTexture&&R.BumpTextureEnabled&&!this._disableBumpMap?(C.PrepareDefinesForMergedUV(this._bumpTexture,t,"BUMP"),this._useParallax&&this._albedoTexture&&R.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(t.BUMP=!1,t.PARALLAX=!1,t.PARALLAXOCCLUSION=!1,t.PARALLAOBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&R.ReflectionTextureEnabled?(t.ENVIRONMENTBRDF=!0,t.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?t.ALPHAFROMALBEDO=!0:t.ALPHAFROMALBEDO=!1}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===r.LIGHTFALLOFF_STANDARD?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===r.LIGHTFALLOFF_GLTF?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!0):(t.USEPHYSICALLIGHTFALLOFF=!0,t.USEGLTFLIGHTFALLOFF=!1),t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?t.TWOSIDEDLIGHTING=!0:t.TWOSIDEDLIGHTING=!1,t.SPECULARAA=l.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(t._areTexturesDirty||t._areMiscDirty)&&(t.ALPHATESTVALUE="".concat(this._alphaCutOff).concat(this._alphaCutOff%1===0?".":""),t.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),t._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&(C.PrepareDefinesForMisc(e,u,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,t),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(L.NormalKind),t.DEBUGMODE=this._debugMode),C.PrepareDefinesForFrameBoundValues(u,l,t,!!i,a,o),this._eventInfo.defines=t,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),C.PrepareDefinesForAttributes(e,t,!0,!0,!0,this._transparencyMode!==r.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)},r.prototype.forceCompilation=function(e,t,i){var a=this,o=Re({clipPlane:!1,useInstances:!1},i);this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(ue.GetDefineNames,this._eventInfo);var s=new fr(this._eventInfo.defineNames),u=this._prepareEffect(e,s,void 0,void 0,o.useInstances,o.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(Ue.effect=u,Ue.subMesh=null,this._onEffectCreatedObservable.notifyObservers(Ue)),u.isReady()?t&&t(this):u.onCompileObservable.add(function(){t&&t(a)})},r.prototype.buildUniformLayout=function(){var e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),n.prototype.buildUniformLayout.call(this)},r.prototype.bindForSubMesh=function(e,t,i){var a,o,s,u,l=this.getScene(),c=i.materialDefines;if(!!c){var p=i.effect;if(!!p){this._activeEffect=p,t.getMeshUniformBuffer().bindToEffect(p,"Mesh"),t.transferToEffect(e);var d=l.getEngine();this._uniformBuffer.bindToEffect(p,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,l,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),c.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));var g=this._mustRebind(l,p,t.visibility);C.BindBonesParameters(t,this._activeEffect,this.prePassConfiguration);var m=null,y=this._uniformBuffer;if(g){if(this.bindViewProjection(p),m=this._getReflectionTexture(),!y.useUbo||!this.isFrozen||!y.isSync){if(l.texturesEnabled){if(this._albedoTexture&&R.DiffuseTextureEnabled&&(y.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),C.BindTextureMatrix(this._albedoTexture,y,"albedo")),this._ambientTexture&&R.AmbientTextureEnabled&&(y.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),C.BindTextureMatrix(this._ambientTexture,y,"ambient")),this._opacityTexture&&R.OpacityTextureEnabled&&(y.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),C.BindTextureMatrix(this._opacityTexture,y,"opacity")),m&&R.ReflectionTextureEnabled){if(y.updateMatrix("reflectionMatrix",m.getReflectionTextureMatrix()),y.updateFloat2("vReflectionInfos",m.level,0),m.boundingBoxSize){var v=m;y.updateVector3("vReflectionPosition",v.boundingBoxPosition),y.updateVector3("vReflectionSize",v.boundingBoxSize)}if(this.realTimeFiltering){var T=m.getSize().width;y.updateFloat2("vReflectionFilteringInfo",T,Ze.Log2(T))}if(!c.USEIRRADIANCEMAP){var x=m.sphericalPolynomial;if(c.USESPHERICALFROMREFLECTIONMAP&&x)if(c.SPHERICAL_HARMONICS){var E=x.preScaledHarmonics;y.updateVector3("vSphericalL00",E.l00),y.updateVector3("vSphericalL1_1",E.l1_1),y.updateVector3("vSphericalL10",E.l10),y.updateVector3("vSphericalL11",E.l11),y.updateVector3("vSphericalL2_2",E.l2_2),y.updateVector3("vSphericalL2_1",E.l2_1),y.updateVector3("vSphericalL20",E.l20),y.updateVector3("vSphericalL21",E.l21),y.updateVector3("vSphericalL22",E.l22)}else y.updateFloat3("vSphericalX",x.x.x,x.x.y,x.x.z),y.updateFloat3("vSphericalY",x.y.x,x.y.y,x.y.z),y.updateFloat3("vSphericalZ",x.z.x,x.z.y,x.z.z),y.updateFloat3("vSphericalXX_ZZ",x.xx.x-x.zz.x,x.xx.y-x.zz.y,x.xx.z-x.zz.z),y.updateFloat3("vSphericalYY_ZZ",x.yy.x-x.zz.x,x.yy.y-x.zz.y,x.yy.z-x.zz.z),y.updateFloat3("vSphericalZZ",x.zz.x,x.zz.y,x.zz.z),y.updateFloat3("vSphericalXY",x.xy.x,x.xy.y,x.xy.z),y.updateFloat3("vSphericalYZ",x.yz.x,x.yz.y,x.yz.z),y.updateFloat3("vSphericalZX",x.zx.x,x.zx.y,x.zx.z)}y.updateFloat3("vReflectionMicrosurfaceInfos",m.getSize().width,m.lodGenerationScale,m.lodGenerationOffset)}this._emissiveTexture&&R.EmissiveTextureEnabled&&(y.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),C.BindTextureMatrix(this._emissiveTexture,y,"emissive")),this._lightmapTexture&&R.LightmapTextureEnabled&&(y.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),C.BindTextureMatrix(this._lightmapTexture,y,"lightmap")),R.SpecularTextureEnabled&&(this._metallicTexture?(y.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),C.BindTextureMatrix(this._metallicTexture,y,"reflectivity")):this._reflectivityTexture&&(y.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),C.BindTextureMatrix(this._reflectivityTexture,y,"reflectivity")),this._metallicReflectanceTexture&&(y.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),C.BindTextureMatrix(this._metallicReflectanceTexture,y,"metallicReflectance")),this._reflectanceTexture&&c.REFLECTANCE&&(y.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),C.BindTextureMatrix(this._reflectanceTexture,y,"reflectance")),this._microSurfaceTexture&&(y.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),C.BindTextureMatrix(this._microSurfaceTexture,y,"microSurfaceSampler"))),this._bumpTexture&&d.getCaps().standardDerivatives&&R.BumpTextureEnabled&&!this._disableBumpMap&&(y.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),C.BindTextureMatrix(this._bumpTexture,y,"bump"),l._mirroredCameraPosition?y.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):y.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&y.updateFloat("pointSize",this.pointSize),c.METALLICWORKFLOW){X.Color3[0].r=this._metallic===void 0||this._metallic===null?1:this._metallic,X.Color3[0].g=this._roughness===void 0||this._roughness===null?1:this._roughness,y.updateColor4("vReflectivityColor",X.Color3[0],1);var O=(o=(a=this.subSurface)===null||a===void 0?void 0:a._indexOfRefraction)!==null&&o!==void 0?o:1.5,N=1,w=Math.pow((O-N)/(O+N),2);this._metallicReflectanceColor.scaleToRef(w*this._metallicF0Factor,X.Color3[0]);var k=this._metallicF0Factor;y.updateColor4("vMetallicReflectanceFactors",X.Color3[0],k)}else y.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);y.updateColor3("vEmissiveColor",R.EmissiveTextureEnabled?this._emissiveColor:G.BlackReadOnly),y.updateColor3("vReflectionColor",this._reflectionColor),!c.SS_REFRACTION&&((s=this.subSurface)===null||s===void 0?void 0:s._linkRefractionWithTransparency)?y.updateColor4("vAlbedoColor",this._albedoColor,1):y.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*l.environmentIntensity,this._lightingInfos.w=this._specularIntensity,y.updateVector4("vLightingIntensity",this._lightingInfos),l.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),y.updateColor3("vAmbientColor",this._globalAmbientColor),y.updateFloat2("vDebugMode",this._debugLimit,this._debugFactor)}l.texturesEnabled&&(this._albedoTexture&&R.DiffuseTextureEnabled&&y.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&R.AmbientTextureEnabled&&y.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&R.OpacityTextureEnabled&&y.setTexture("opacitySampler",this._opacityTexture),m&&R.ReflectionTextureEnabled&&(c.LODBASEDMICROSFURACE?y.setTexture("reflectionSampler",m):(y.setTexture("reflectionSampler",m._lodTextureMid||m),y.setTexture("reflectionSamplerLow",m._lodTextureLow||m),y.setTexture("reflectionSamplerHigh",m._lodTextureHigh||m)),c.USEIRRADIANCEMAP&&y.setTexture("irradianceSampler",m.irradianceTexture)),c.ENVIRONMENTBRDF&&y.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&R.EmissiveTextureEnabled&&y.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&R.LightmapTextureEnabled&&y.setTexture("lightmapSampler",this._lightmapTexture),R.SpecularTextureEnabled&&(this._metallicTexture?y.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&y.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&y.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&c.REFLECTANCE&&y.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&y.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&d.getCaps().standardDerivatives&&R.BumpTextureEnabled&&!this._disableBumpMap&&y.setTexture("bumpSampler",this._bumpTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(p),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),C.BindClipPlane(this._activeEffect,l),this.bindEyePosition(p)}else l.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(g||!this.isFrozen)&&(l.lightsEnabled&&!this._disableLighting&&C.BindLights(l,t,this._activeEffect,c,this._maxSimultaneousLights),(l.fogEnabled&&t.applyFog&&l.fogMode!==Ke.FOGMODE_NONE||m||t.receiveShadows||c.PREPASS)&&this.bindView(p),C.BindFogParameters(l,t,this._activeEffect,!0),c.NUM_MORPH_INFLUENCERS&&C.BindMorphTargetParameters(t,this._activeEffect),c.BAKED_VERTEX_ANIMATION_TEXTURE&&((u=t.bakedVertexAnimationManager)===null||u===void 0||u.bind(p,c.INSTANCES)),this._imageProcessingConfiguration.bind(this._activeEffect),C.BindLogDepth(c,this._activeEffect,l)),this._afterBind(t,this._activeEffect),y.update()}}},r.prototype.getAnimatables=function(){var e=n.prototype.getAnimatables.call(this);return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),e},r.prototype._getReflectionTexture=function(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture},r.prototype.getActiveTextures=function(){var e=n.prototype.getActiveTextures.call(this);return this._albedoTexture&&e.push(this._albedoTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e},r.prototype.hasTexture=function(e){return!!(n.prototype.hasTexture.call(this,e)||this._albedoTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e)},r.prototype.setPrePassRenderer=function(){var e;if(!((e=this.subSurface)===null||e===void 0)&&e.isScatteringEnabled){var t=this.getScene().enableSubSurfaceForPrePass();return t&&(t.enabled=!0),!0}return!1},r.prototype.dispose=function(e,t){var i,a,o,s,u,l,c,p,d,g,m,y;t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),(i=this._albedoTexture)===null||i===void 0||i.dispose(),(a=this._ambientTexture)===null||a===void 0||a.dispose(),(o=this._opacityTexture)===null||o===void 0||o.dispose(),(s=this._reflectionTexture)===null||s===void 0||s.dispose(),(u=this._emissiveTexture)===null||u===void 0||u.dispose(),(l=this._metallicTexture)===null||l===void 0||l.dispose(),(c=this._reflectivityTexture)===null||c===void 0||c.dispose(),(p=this._bumpTexture)===null||p===void 0||p.dispose(),(d=this._lightmapTexture)===null||d===void 0||d.dispose(),(g=this._metallicReflectanceTexture)===null||g===void 0||g.dispose(),(m=this._reflectanceTexture)===null||m===void 0||m.dispose(),(y=this._microSurfaceTexture)===null||y===void 0||y.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),n.prototype.dispose.call(this,e,t)},r.PBRMATERIAL_OPAQUE=xe.MATERIAL_OPAQUE,r.PBRMATERIAL_ALPHATEST=xe.MATERIAL_ALPHATEST,r.PBRMATERIAL_ALPHABLEND=xe.MATERIAL_ALPHABLEND,r.PBRMATERIAL_ALPHATESTANDBLEND=xe.MATERIAL_ALPHATESTANDBLEND,r.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0,r.LIGHTFALLOFF_PHYSICAL=0,r.LIGHTFALLOFF_GLTF=1,r.LIGHTFALLOFF_STANDARD=2,h([_r()],r.prototype,"_imageProcessingConfiguration",void 0),h([S("_markAllSubMeshesAsMiscDirty")],r.prototype,"debugMode",void 0),h([b()],r.prototype,"useLogarithmicDepth",null),r}(Je),ji=function(n){A(r,n);function r(e,t){var i=n.call(this,e,t)||this;return i.directIntensity=1,i.emissiveIntensity=1,i.environmentIntensity=1,i.specularIntensity=1,i.disableBumpMap=!1,i.ambientTextureStrength=1,i.ambientTextureImpactOnAnalyticalLights=r.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,i.metallicF0Factor=1,i.metallicReflectanceColor=G.White(),i.useOnlyMetallicFromMetallicReflectanceTexture=!1,i.ambientColor=new G(0,0,0),i.albedoColor=new G(1,1,1),i.reflectivityColor=new G(1,1,1),i.reflectionColor=new G(1,1,1),i.emissiveColor=new G(0,0,0),i.microSurface=1,i.useLightmapAsShadowmap=!1,i.useAlphaFromAlbedoTexture=!1,i.forceAlphaTest=!1,i.alphaCutOff=.4,i.useSpecularOverAlpha=!0,i.useMicroSurfaceFromReflectivityMapAlpha=!1,i.useRoughnessFromMetallicTextureAlpha=!0,i.useRoughnessFromMetallicTextureGreen=!1,i.useMetallnessFromMetallicTextureBlue=!1,i.useAmbientOcclusionFromMetallicTextureRed=!1,i.useAmbientInGrayScale=!1,i.useAutoMicroSurfaceFromReflectivityMap=!1,i.useRadianceOverAlpha=!0,i.useObjectSpaceNormalMap=!1,i.useParallax=!1,i.useParallaxOcclusion=!1,i.parallaxScaleBias=.05,i.disableLighting=!1,i.forceIrradianceInFragment=!1,i.maxSimultaneousLights=4,i.invertNormalMapX=!1,i.invertNormalMapY=!1,i.twoSidedLighting=!1,i.useAlphaFresnel=!1,i.useLinearAlphaFresnel=!1,i.environmentBRDFTexture=null,i.forceNormalForward=!1,i.enableSpecularAntiAliasing=!1,i.useHorizonOcclusion=!0,i.useRadianceOcclusion=!0,i.unlit=!1,i._environmentBRDFTexture=Xt(i.getScene()),i}return Object.defineProperty(r.prototype,"refractionTexture",{get:function(){return this.subSurface.refractionTexture},set:function(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"indexOfRefraction",{get:function(){return this.subSurface.indexOfRefraction},set:function(e){this.subSurface.indexOfRefraction=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"invertRefractionY",{get:function(){return this.subSurface.invertRefractionY},set:function(e){this.subSurface.invertRefractionY=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"linkRefractionWithTransparency",{get:function(){return this.subSurface.linkRefractionWithTransparency},set:function(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"usePhysicalLightFalloff",{get:function(){return this._lightFalloff===pe.LIGHTFALLOFF_PHYSICAL},set:function(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=pe.LIGHTFALLOFF_PHYSICAL:this._lightFalloff=pe.LIGHTFALLOFF_STANDARD)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"useGLTFLightFalloff",{get:function(){return this._lightFalloff===pe.LIGHTFALLOFF_GLTF},set:function(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=pe.LIGHTFALLOFF_GLTF:this._lightFalloff=pe.LIGHTFALLOFF_STANDARD)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(e){this.imageProcessingConfiguration.colorCurvesEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(e){this.imageProcessingConfiguration.colorGradingEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(e){this._imageProcessingConfiguration.toneMappingEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(e){this._imageProcessingConfiguration.exposure=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(e){this._imageProcessingConfiguration.contrast=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(e){this._imageProcessingConfiguration.colorGradingTexture=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraColorCurves",{get:function(){return this._imageProcessingConfiguration.colorCurves},set:function(e){this._imageProcessingConfiguration.colorCurves=e},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"PBRMaterial"},r.prototype.clone=function(e){var t=this,i=j.Clone(function(){return new r(e,t.getScene())},this);return i.id=e,i.name=e,this.stencil.copyTo(i.stencil),this.clearCoat.copyTo(i.clearCoat),this.anisotropy.copyTo(i.anisotropy),this.brdf.copyTo(i.brdf),this.sheen.copyTo(i.sheen),this.subSurface.copyTo(i.subSurface),i},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.customType="BABYLON.PBRMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e},r.Parse=function(e,t,i){var a=j.Parse(function(){return new r(e.name,t)},e,t,i);return e.stencil&&a.stencil.parse(e.stencil,t,i),e.clearCoat&&a.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&a.anisotropy.parse(e.anisotropy,t,i),e.brdf&&a.brdf.parse(e.brdf,t,i),e.sheen&&a.sheen.parse(e.sheen,t,i),e.subSurface&&a.subSurface.parse(e.subSurface,t,i),e.iridescence&&a.iridescence.parse(e.iridescence,t,i),a},r.PBRMATERIAL_OPAQUE=pe.PBRMATERIAL_OPAQUE,r.PBRMATERIAL_ALPHATEST=pe.PBRMATERIAL_ALPHATEST,r.PBRMATERIAL_ALPHABLEND=pe.PBRMATERIAL_ALPHABLEND,r.PBRMATERIAL_ALPHATESTANDBLEND=pe.PBRMATERIAL_ALPHATESTANDBLEND,r.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=pe.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"directIntensity",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"emissiveIntensity",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"environmentIntensity",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"specularIntensity",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"disableBumpMap",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"albedoTexture",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"ambientTexture",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"ambientTextureStrength",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"ambientTextureImpactOnAnalyticalLights",void 0),h([U(),S("_markAllSubMeshesAsTexturesAndMiscDirty")],r.prototype,"opacityTexture",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionTexture",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"emissiveTexture",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectivityTexture",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"metallicTexture",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"metallic",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"roughness",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"metallicF0Factor",void 0),h([le(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"metallicReflectanceColor",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"metallicReflectanceTexture",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectanceTexture",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"microSurfaceTexture",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"bumpTexture",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty",null)],r.prototype,"lightmapTexture",void 0),h([le("ambient"),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"ambientColor",void 0),h([le("albedo"),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"albedoColor",void 0),h([le("reflectivity"),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectivityColor",void 0),h([le("reflection"),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionColor",void 0),h([le("emissive"),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"emissiveColor",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"microSurface",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useLightmapAsShadowmap",void 0),h([b(),S("_markAllSubMeshesAsTexturesAndMiscDirty")],r.prototype,"useAlphaFromAlbedoTexture",void 0),h([b(),S("_markAllSubMeshesAsTexturesAndMiscDirty")],r.prototype,"forceAlphaTest",void 0),h([b(),S("_markAllSubMeshesAsTexturesAndMiscDirty")],r.prototype,"alphaCutOff",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useSpecularOverAlpha",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useRoughnessFromMetallicTextureGreen",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useMetallnessFromMetallicTextureBlue",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useAmbientInGrayScale",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),h([b()],r.prototype,"usePhysicalLightFalloff",null),h([b()],r.prototype,"useGLTFLightFalloff",null),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useRadianceOverAlpha",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useObjectSpaceNormalMap",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useParallax",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useParallaxOcclusion",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"parallaxScaleBias",void 0),h([b(),S("_markAllSubMeshesAsLightsDirty")],r.prototype,"disableLighting",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"forceIrradianceInFragment",void 0),h([b(),S("_markAllSubMeshesAsLightsDirty")],r.prototype,"maxSimultaneousLights",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"invertNormalMapX",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"invertNormalMapY",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"twoSidedLighting",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useAlphaFresnel",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useLinearAlphaFresnel",void 0),h([S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"environmentBRDFTexture",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"forceNormalForward",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"enableSpecularAntiAliasing",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useHorizonOcclusion",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useRadianceOcclusion",void 0),h([b(),S("_markAllSubMeshesAsMiscDirty")],r.prototype,"unlit",void 0),r}(pe);P("BABYLON.PBRMaterial",ji);var Wi=function(){function n(){this.supportCascades=!0}return n.prototype.canLoad=function(r){return r.endsWith(".dds")},n.prototype.loadCubeData=function(r,e,t,i){var a=e.getEngine(),o,s=!1,u=1e3;if(Array.isArray(r))for(var l=0;l<r.length;l++){var c=r[l];o=ke.GetDDSInfo(c),e.width=o.width,e.height=o.height,s=(o.isRGB||o.isLuminance||o.mipmapCount>1)&&e.generateMipMaps,a._unpackFlipY(o.isCompressed),ke.UploadDDSLevels(a,e,c,o,s,6,-1,l),!o.isFourCC&&o.mipmapCount===1?a.generateMipMapsForCubemap(e):u=o.mipmapCount-1}else{var c=r;o=ke.GetDDSInfo(c),e.width=o.width,e.height=o.height,t&&(o.sphericalPolynomial=new Hr),s=(o.isRGB||o.isLuminance||o.mipmapCount>1)&&e.generateMipMaps,a._unpackFlipY(o.isCompressed),ke.UploadDDSLevels(a,e,c,o,s,6),!o.isFourCC&&o.mipmapCount===1?a.generateMipMapsForCubemap(e,!1):u=o.mipmapCount-1}a._setCubeMapTextureParams(e,s,u),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),i&&i({isDDS:!0,width:e.width,info:o,data:r,texture:e})},n.prototype.loadData=function(r,e,t){var i=ke.GetDDSInfo(r),a=(i.isRGB||i.isLuminance||i.mipmapCount>1)&&e.generateMipMaps&&i.width>>i.mipmapCount-1===1;t(i.width,i.height,a,i.isFourCC,function(){ke.UploadDDSLevels(e.getEngine(),e,r,i,a,1)})},n}();Q._TextureLoaders.push(new Wi);var Yi=function(){function n(){this.supportCascades=!1}return n.prototype.canLoad=function(r){return r.endsWith(".env")},n.prototype.loadCubeData=function(r,e,t,i,a){if(!Array.isArray(r)){var o=ii(r);if(o){e.width=o.width,e.height=o.width;try{ni(e,o),ai(e,r,o).then(function(){e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),i&&i()},function(s){a==null||a("Can not upload environment levels",s)})}catch(s){a==null||a("Can not upload environment file",s)}}else a&&a("Can not parse the environment file",null)}},n.prototype.loadData=function(){throw".env not supported in 2d."},n}();Q._TextureLoaders.push(new Yi);function Xi(n){switch(n){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}var Ki=function(){function n(){this.supportCascades=!1}return n.prototype.canLoad=function(r,e){return r.endsWith(".ktx")||r.endsWith(".ktx2")||e==="image/ktx"||e==="image/ktx2"},n.prototype.loadCubeData=function(r,e,t,i){if(!Array.isArray(r)){e._invertVScale=!e.invertY;var a=e.getEngine(),o=new Ot(r,6),s=o.numberOfMipmapLevels>1&&e.generateMipMaps;a._unpackFlipY(!0),o.uploadLevels(e,e.generateMipMaps),e.width=o.pixelWidth,e.height=o.pixelHeight,a._setCubeMapTextureParams(e,s,o.numberOfMipmapLevels-1),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),i&&i()}},n.prototype.loadData=function(r,e,t,i){if(Ot.IsValid(r)){e._invertVScale=!e.invertY;var a=new Ot(r,1),o=Xi(a.glInternalFormat);o?(e.format=o,e._useSRGBBuffer=e.getEngine()._getUseSRGBBuffer(!0,e.generateMipMaps),e._gammaSpace=!0):e.format=a.glInternalFormat,t(a.pixelWidth,a.pixelHeight,e.generateMipMaps,!0,function(){a.uploadLevels(e,e.generateMipMaps)},a.isInvalid)}else if(ir.IsValid(r)){var s=new ir(e.getEngine());s.uploadAsync(r,e,i).then(function(){t(e.width,e.height,e.generateMipMaps,!0,function(){},!1)},function(u){$.Warn("Failed to load KTX2 texture data: ".concat(u.message)),t(0,0,!1,!1,function(){},!0)})}else $.Error("texture missing KTX identifier"),t(0,0,!1,!1,function(){},!0)},n}();Q._TextureLoaders.unshift(new Ki);function pr(n){for(;n.firstChild;)n.removeChild(n.firstChild);n.srcObject=null,n.src="",n.removeAttribute("src")}var Ua=function(n){A(r,n);function r(e,t,i,a,o,s,u,l){a===void 0&&(a=!1),o===void 0&&(o=!1),s===void 0&&(s=I.TRILINEAR_SAMPLINGMODE),u===void 0&&(u={});var c=n.call(this,null,i,!a,o)||this;c._onUserActionRequestedObservable=null,c._stillImageCaptured=!1,c._displayingPosterTexture=!1,c._frameId=-1,c._currentSrc=null,c._errorFound=!1,c._createInternalTexture=function(){if(c._texture!=null)if(c._displayingPosterTexture)c._texture.dispose(),c._displayingPosterTexture=!1;else return;if(!c._getEngine().needPOTTextures||ae.IsExponentOfTwo(c.video.videoWidth)&&ae.IsExponentOfTwo(c.video.videoHeight)?(c.wrapU=I.WRAP_ADDRESSMODE,c.wrapV=I.WRAP_ADDRESSMODE):(c.wrapU=I.CLAMP_ADDRESSMODE,c.wrapV=I.CLAMP_ADDRESSMODE,c._generateMipMaps=!1),c._texture=c._getEngine().createDynamicTexture(c.video.videoWidth,c.video.videoHeight,c._generateMipMaps,c.samplingMode),!c.video.autoplay&&!c._settings.poster){var d=c.video.onplaying,g=c.video.muted;c.video.muted=!0,c.video.onplaying=function(){c.video.muted=g,c.video.onplaying=d,c._updateInternalTexture(),c._errorFound||c.video.pause(),c.onLoadObservable.hasObservers()&&c.onLoadObservable.notifyObservers(c)},c._handlePlay()}else c._updateInternalTexture(),c.onLoadObservable.hasObservers()&&c.onLoadObservable.notifyObservers(c)},c._reset=function(){c._texture!=null&&(c._displayingPosterTexture||(c._texture.dispose(),c._texture=null))},c._updateInternalTexture=function(){if(c._texture!=null&&!(c.video.readyState<c.video.HAVE_CURRENT_DATA)&&!c._displayingPosterTexture){var d=c.getScene().getFrameId();c._frameId!==d&&(c._frameId=d,c._getEngine().updateVideoTexture(c._texture,c.video,c._invertY))}},c._settings=Re({autoPlay:!0,loop:!0,autoUpdateTexture:!0},u),c._onError=l,c._generateMipMaps=a,c._initialSamplingMode=s,c.autoUpdateTexture=c._settings.autoUpdateTexture,c._currentSrc=t,c.name=e||c._getName(t),c.video=c._getVideo(t),c._settings.poster&&(c.video.poster=c._settings.poster),c._settings.autoPlay!==void 0&&(c.video.autoplay=c._settings.autoPlay),c._settings.loop!==void 0&&(c.video.loop=c._settings.loop),c._settings.muted!==void 0&&(c.video.muted=c._settings.muted),c.video.setAttribute("playsinline",""),c.video.addEventListener("paused",c._updateInternalTexture),c.video.addEventListener("seeked",c._updateInternalTexture),c.video.addEventListener("emptied",c._reset),c._createInternalTextureOnEvent=c._settings.poster&&!c._settings.autoPlay?"play":"canplay",c.video.addEventListener(c._createInternalTextureOnEvent,c._createInternalTexture),c._settings.autoPlay&&c._handlePlay();var p=c.video.readyState>=c.video.HAVE_CURRENT_DATA;return c._settings.poster&&(!c._settings.autoPlay||!p)?(c._texture=c._getEngine().createTexture(c._settings.poster,!1,!c.invertY,i),c._displayingPosterTexture=!0):p&&c._createInternalTexture(),c}return Object.defineProperty(r.prototype,"onUserActionRequestedObservable",{get:function(){return this._onUserActionRequestedObservable||(this._onUserActionRequestedObservable=new J),this._onUserActionRequestedObservable},enumerable:!1,configurable:!0}),r.prototype._processError=function(e){this._errorFound=!0,this._onError?this._onError(e==null?void 0:e.message):$.Error(e==null?void 0:e.message)},r.prototype._handlePlay=function(){var e=this;this._errorFound=!1,this.video.play().catch(function(t){if((t==null?void 0:t.name)==="NotAllowedError"){if(e._onUserActionRequestedObservable&&e._onUserActionRequestedObservable.hasObservers()){e._onUserActionRequestedObservable.notifyObservers(e);return}else if(!e.video.muted){$.Warn("Unable to autoplay a video with sound. Trying again with muted turned true"),e.video.muted=!0,e._errorFound=!1,e.video.play().catch(function(i){e._processError(i)});return}}e._processError(t)})},r.prototype.getClassName=function(){return"VideoTexture"},r.prototype._getName=function(e){return e instanceof HTMLVideoElement?e.currentSrc:typeof e=="object"?e.toString():e},r.prototype._getVideo=function(e){if(e.isNative)return e;if(e instanceof HTMLVideoElement)return ae.SetCorsBehavior(e.currentSrc,e),e;var t=document.createElement("video");return typeof e=="string"?(ae.SetCorsBehavior(e,t),t.src=e):(ae.SetCorsBehavior(e[0],t),e.forEach(function(i){var a=document.createElement("source");a.src=i,t.appendChild(a)})),this.onDisposeObservable.addOnce(function(){pr(t)}),t},r.prototype._rebuild=function(){this.update()},r.prototype.update=function(){!this.autoUpdateTexture||this.updateTexture(!0)},r.prototype.updateTexture=function(e){!e||this.video.paused&&this._stillImageCaptured||(this._stillImageCaptured=!0,this._updateInternalTexture())},r.prototype.updateURL=function(e){this.video.src=e,this._currentSrc=e},r.prototype.clone=function(){return new r(this.name,this._currentSrc,this.getScene(),this._generateMipMaps,this.invertY,this.samplingMode,this._settings)},r.prototype.dispose=function(){n.prototype.dispose.call(this),this._currentSrc=null,this._onUserActionRequestedObservable&&(this._onUserActionRequestedObservable.clear(),this._onUserActionRequestedObservable=null),this.video.removeEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this.video.removeEventListener("paused",this._updateInternalTexture),this.video.removeEventListener("seeked",this._updateInternalTexture),this.video.removeEventListener("emptied",this._reset),this.video.pause()},r.CreateFromStreamAsync=function(e,t,i,a){a===void 0&&(a=!0);var o=e.getEngine().createVideoElement(i);return e.getEngine()._badOS&&(document.body.appendChild(o),o.style.transform="scale(0.0001, 0.0001)",o.style.opacity="0",o.style.position="fixed",o.style.bottom="0px",o.style.right="0px"),o.setAttribute("autoplay",""),o.setAttribute("muted","true"),o.setAttribute("playsinline",""),o.muted=!0,o.isNative||(o.mozSrcObject!==void 0?o.mozSrcObject=t:typeof o.srcObject=="object"?o.srcObject=t:(window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,o.src=window.URL&&window.URL.createObjectURL(t))),new Promise(function(s){var u=function(){var l=new r("video",o,e,!0,a);e.getEngine()._badOS&&l.onDisposeObservable.addOnce(function(){o.remove()}),l.onDisposeObservable.addOnce(function(){pr(o)}),s(l),o.removeEventListener("playing",u)};o.addEventListener("playing",u),o.play()})},r.CreateFromWebCamAsync=function(e,t,i,a){var o=this;i===void 0&&(i=!1),a===void 0&&(a=!0);var s;if(t&&t.deviceId&&(s={exact:t.deviceId}),navigator.mediaDevices)return navigator.mediaDevices.getUserMedia({video:t,audio:i}).then(function(l){return o.CreateFromStreamAsync(e,l,t,a)});var u=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return u&&u({video:{deviceId:s,width:{min:t&&t.minWidth||256,max:t&&t.maxWidth||640},height:{min:t&&t.minHeight||256,max:t&&t.maxHeight||480}},audio:i},function(l){return o.CreateFromStreamAsync(e,l,t,a)},function(l){$.Error(l.name)}),Promise.reject("No support for userMedia on this device")},r.CreateFromWebCam=function(e,t,i,a,o){a===void 0&&(a=!1),o===void 0&&(o=!0),this.CreateFromWebCamAsync(e,i,a,o).then(function(s){t&&t(s)}).catch(function(s){$.Error(s.name)})},r}(I),qi=function(){function n(r,e){var t;e===void 0&&(e=n._DefaultOptions);var i=this;this._engine=r,this._fullscreenViewport=new jr(0,0,1,1),e=Re(Re({},n._DefaultOptions),e),this._vertexBuffers=(t={},t[L.PositionKind]=new L(r,e.positions,L.PositionKind,!1,!1,2),t),this._indexBuffer=r.createIndexBuffer(e.indices),this._onContextRestoredObserver=r.onContextRestoredObservable.add(function(){i._indexBuffer=r.createIndexBuffer(e.indices);for(var a in i._vertexBuffers){var o=i._vertexBuffers[a];o._rebuild()}})}return n.prototype.setViewport=function(r){r===void 0&&(r=this._fullscreenViewport),this._engine.setViewport(r)},n.prototype.bindBuffers=function(r){this._engine.bindBuffers(this._vertexBuffers,this._indexBuffer,r)},n.prototype.applyEffectWrapper=function(r){this._engine.depthCullingState.depthTest=!1,this._engine.stencilState.stencilTest=!1,this._engine.enableEffect(r._drawWrapper),this.bindBuffers(r.effect),r.onApplyObservable.notifyObservers({})},n.prototype.restoreStates=function(){this._engine.depthCullingState.depthTest=!0,this._engine.stencilState.stencilTest=!0},n.prototype.draw=function(){this._engine.drawElementsType(0,0,6)},n.prototype._isRenderTargetTexture=function(r){return r.renderTarget!==void 0},n.prototype.render=function(r,e){if(e===void 0&&(e=null),!!r.effect.isReady()){this.setViewport();var t=e===null?null:this._isRenderTargetTexture(e)?e.renderTarget:e;t&&this._engine.bindFramebuffer(t),this.applyEffectWrapper(r),this.draw(),t&&this._engine.unBindFramebuffer(t),this.restoreStates()}},n.prototype.dispose=function(){var r=this._vertexBuffers[L.PositionKind];r&&(r.dispose(),delete this._vertexBuffers[L.PositionKind]),this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this._engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)},n._DefaultOptions={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]},n}(),Zi=function(){function n(r){var e=this;this.onApplyObservable=new J;var t,i=r.uniformNames||[];r.vertexShader?t={fragmentSource:r.fragmentShader,vertexSource:r.vertexShader,spectorName:r.name||"effectWrapper"}:(i.push("scale"),t={fragmentSource:r.fragmentShader,vertex:"postprocess",spectorName:r.name||"effectWrapper"},this.onApplyObservable.add(function(){e.effect.setFloat2("scale",1,1)}));var a=r.defines?r.defines.join(`
`):"";this._drawWrapper=new qe(r.engine),r.useShaderStore?(t.fragment=t.fragmentSource,t.vertex||(t.vertex=t.vertexSource),delete t.fragmentSource,delete t.vertexSource,this.effect=r.engine.createEffect(t,r.attributeNames||["position"],i,r.samplerNames,a,void 0,r.onCompiled,void 0,void 0,r.shaderLanguage)):(this.effect=new se(t,r.attributeNames||["position"],i,r.samplerNames,r.engine,a,void 0,r.onCompiled,void 0,void 0,void 0,r.shaderLanguage),this._onContextRestoredObserver=r.engine.onContextRestoredObservable.add(function(){e.effect._pipelineContext=null,e.effect._wasPreviouslyReady=!1,e.effect._prepareEffect()}))}return Object.defineProperty(n.prototype,"effect",{get:function(){return this._drawWrapper.effect},set:function(r){this._drawWrapper.effect=r},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.effect.dispose()},n}(),Qi=function(){function n(r,e){e===void 0&&(e={}),this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=4096,this.hdrScale=1,this._engine=r,this.hdrScale=e.hdrScale||this.hdrScale,this.quality=e.quality||this.quality}return n.prototype._createRenderTarget=function(r){var e=0;this._engine.getCaps().textureHalfFloatRender?e=2:this._engine.getCaps().textureFloatRender&&(e=1);var t=this._engine.createRenderTargetCubeTexture(r,{format:5,type:e,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1});return this._engine.updateTextureWrappingMode(t.texture,0,0,0),this._engine.updateTextureSamplingMode(3,t.texture,!0),t},n.prototype._prefilterInternal=function(r){var e=r.getSize().width,t=Ze.ILog2(e)+1,i=this._effectWrapper.effect,a=this._createRenderTarget(e);this._effectRenderer.setViewport();var o=r.getInternalTexture();o&&this._engine.updateTextureSamplingMode(3,o,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper);var s=[[new K(0,0,-1),new K(0,-1,0),new K(1,0,0)],[new K(0,0,1),new K(0,-1,0),new K(-1,0,0)],[new K(1,0,0),new K(0,0,1),new K(0,1,0)],[new K(1,0,0),new K(0,0,-1),new K(0,-1,0)],[new K(1,0,0),new K(0,-1,0),new K(0,0,1)],[new K(-1,0,0),new K(0,-1,0),new K(0,0,-1)]];i.setFloat("hdrScale",this.hdrScale),i.setFloat2("vFilteringInfo",r.getSize().width,t),i.setTexture("inputTexture",r);for(var u=0;u<6;u++){i.setVector3("up",s[u][0]),i.setVector3("right",s[u][1]),i.setVector3("front",s[u][2]);for(var l=0;l<t;l++){this._engine.bindFramebuffer(a,u,void 0,void 0,!0,l),this._effectRenderer.applyEffectWrapper(this._effectWrapper);var c=Math.pow(2,(l-this._lodGenerationOffset)/this._lodGenerationScale)/e;l===0&&(c=0),i.setFloat("alphaG",c),this._effectRenderer.draw()}}return this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseTexture(r._texture),a._swapAndDie(r._texture),r._prefiltered=!0,r},n.prototype._createEffect=function(r,e){var t=[];r.gammaSpace&&t.push("#define GAMMA_INPUT"),t.push("#define NUM_SAMPLES "+this.quality+"u");var i=new Zi({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:t,onCompiled:e});return i},n.prototype.isReady=function(r){return r.isReady()&&this._effectWrapper.effect.isReady()},n.prototype.prefilter=function(r,e){var t=this;return e===void 0&&(e=null),this._engine._features.allowTexturePrefiltering?new Promise(function(i){t._effectRenderer=new qi(t._engine),t._effectWrapper=t._createEffect(r),t._effectWrapper.effect.executeWhenCompiled(function(){t._prefilterInternal(r),t._effectRenderer.dispose(),t._effectWrapper.dispose(),i(),e&&e()})}):($.Warn("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."),Promise.reject("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."))},n}(),Ji=function(n){A(r,n);function r(e,t,i,a,o,s,u,l,c){a===void 0&&(a=!1),o===void 0&&(o=!0),s===void 0&&(s=!1),u===void 0&&(u=!1),l===void 0&&(l=null),c===void 0&&(c=null);var p=this,d;return p=n.call(this,t)||this,p._generateHarmonics=!0,p._onError=null,p._isBlocking=!0,p._rotationY=0,p.boundingBoxPosition=K.Zero(),p.onLoadObservable=new J,e&&(p._coordinatesMode=I.CUBIC_MODE,p.name=e,p.url=e,p.hasAlpha=!1,p.isCube=!0,p._textureMatrix=q.Identity(),p._prefilterOnLoad=u,p._onLoad=function(){p.onLoadObservable.notifyObservers(p),l&&l()},p._onError=c,p.gammaSpace=s,p._noMipmap=a,p._size=i,p._generateHarmonics=o,p._texture=p._getFromCache(e,p._noMipmap,void 0,void 0,void 0,p.isCube),p._texture?p._texture.isReady?ae.SetImmediate(function(){return p._onLoad()}):p._texture.onLoadedObservable.add(p._onLoad):!((d=p.getScene())===null||d===void 0)&&d.useDelayedTextureLoading?p.delayLoadState=4:p._loadTexture()),p}return Object.defineProperty(r.prototype,"isBlocking",{get:function(){return this._isBlocking},set:function(e){this._isBlocking=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rotationY",{get:function(){return this._rotationY},set:function(e){this._rotationY=e,this.setReflectionTextureMatrix(q.RotationY(this._rotationY))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"boundingBoxSize",{get:function(){return this._boundingBoxSize},set:function(e){if(!(this._boundingBoxSize&&this._boundingBoxSize.equals(e))){this._boundingBoxSize=e;var t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"HDRCubeTexture"},r.prototype._loadTexture=function(){var e=this,t=this._getEngine(),i=t.getCaps(),a=0;i.textureFloat&&i.textureFloatLinearFiltering?a=1:i.textureHalfFloat&&i.textureHalfFloatLinearFiltering&&(a=2);var o=function(l){e.lodGenerationOffset=0,e.lodGenerationScale=.8;var c=Bt.GetCubeMapTextureData(l,e._size);if(e._generateHarmonics){var p=dr.ConvertCubeMapToSphericalPolynomial(c);e.sphericalPolynomial=p}for(var d=[],g=null,m=null,y=0;y<6;y++){a===2?m=new Uint16Array(e._size*e._size*3):a===0&&(g=new Uint8Array(e._size*e._size*3));var v=c[r._FacesMapping[y]];if(e.gammaSpace||m||g){for(var T=0;T<e._size*e._size;T++)if(e.gammaSpace&&(v[T*3+0]=Math.pow(v[T*3+0],xt),v[T*3+1]=Math.pow(v[T*3+1],xt),v[T*3+2]=Math.pow(v[T*3+2],xt)),m&&(m[T*3+0]=Pt(v[T*3+0]),m[T*3+1]=Pt(v[T*3+1]),m[T*3+2]=Pt(v[T*3+2])),g){var x=Math.max(v[T*3+0]*255,0),E=Math.max(v[T*3+1]*255,0),O=Math.max(v[T*3+2]*255,0),N=Math.max(Math.max(x,E),O);if(N>255){var w=255/N;x*=w,E*=w,O*=w}g[T*3+0]=x,g[T*3+1]=E,g[T*3+2]=O}}m?d.push(m):g?d.push(g):d.push(v)}return d};if(t._features.allowTexturePrefiltering&&this._prefilterOnLoad){var s=this._onLoad,u=new Qi(t);this._onLoad=function(){u.prefilter(e,s)}}this._texture=t.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,4,a,this._noMipmap,o,null,this._onLoad,this._onError)},r.prototype.clone=function(){var e=new r(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace);return e.level=this.level,e.wrapU=this.wrapU,e.wrapV=this.wrapV,e.coordinatesIndex=this.coordinatesIndex,e.coordinatesMode=this.coordinatesMode,e},r.prototype.delayLoad=function(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this._loadTexture())},r.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix},r.prototype.setReflectionTextureMatrix=function(e){var t=this,i;this._textureMatrix=e,e.updateFlag!==this._textureMatrix.updateFlag&&e.isIdentity()!==this._textureMatrix.isIdentity()&&((i=this.getScene())===null||i===void 0||i.markAllMaterialsAsDirty(1,function(a){return a.getActiveTextures().indexOf(t)!==-1}))},r.prototype.dispose=function(){this.onLoadObservable.clear(),n.prototype.dispose.call(this)},r.Parse=function(e,t,i){var a=null;return e.name&&!e.isRenderTarget&&(a=new r(i+e.name,t,e.size,e.noMipmap,e.generateHarmonics,e.useInGammaSpace),a.name=e.name,a.hasAlpha=e.hasAlpha,a.level=e.level,a.coordinatesMode=e.coordinatesMode,a.isBlocking=e.isBlocking),a&&(e.boundingBoxPosition&&(a.boundingBoxPosition=K.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(a.boundingBoxSize=K.FromArray(e.boundingBoxSize)),e.rotationY&&(a.rotationY=e.rotationY)),a},r.prototype.serialize=function(){if(!this.name)return null;var e={};return e.name=this.name,e.hasAlpha=this.hasAlpha,e.isCube=!0,e.level=this.level,e.size=this._size,e.coordinatesMode=this.coordinatesMode,e.useInGammaSpace=this.gammaSpace,e.generateHarmonics=this._generateHarmonics,e.customType="BABYLON.HDRCubeTexture",e.noMipmap=this._noMipmap,e.isBlocking=this._isBlocking,e.rotationY=this._rotationY,e},r._FacesMapping=["right","left","up","down","front","back"],r}(De);P("BABYLON.HDRCubeTexture",Ji);var za=function(n){A(r,n);function r(e,t,i,a,o,s,u,l,c,p){u===void 0&&(u=!0),l===void 0&&(l=!1),c===void 0&&(c=I.TRILINEAR_SAMPLINGMODE),p===void 0&&(p=0);var d=n.call(this,null,s,!u,l)||this;return d.format=o,d._texture=s.getEngine().createRawTexture2DArray(e,t,i,a,o,u,l,c,null,p),d._depth=a,d.is2DArray=!0,d}return Object.defineProperty(r.prototype,"depth",{get:function(){return this._depth},enumerable:!1,configurable:!0}),r.prototype.update=function(e){!this._texture||this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)},r.CreateRGBATexture=function(e,t,i,a,o,s,u,l,c){return s===void 0&&(s=!0),u===void 0&&(u=!1),l===void 0&&(l=3),c===void 0&&(c=0),new r(e,t,i,a,5,o,s,u,l,c)},r}(I),$i=function(){function n(r){r===void 0&&(r={}),this._isEnabled=!0,this.bias=r.bias===void 0?0:r.bias,this.power=r.power===void 0?1:r.power,this.leftColor=r.leftColor||G.White(),this.rightColor=r.rightColor||G.Black(),r.isEnabled===!1&&(this.isEnabled=!1)}return Object.defineProperty(n.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(r){this._isEnabled!==r&&(this._isEnabled=r,Q.MarkAllMaterialsAsDirty(20))},enumerable:!1,configurable:!0}),n.prototype.clone=function(){var r=new n;return oi.DeepCopy(this,r),r},n.prototype.equals=function(r){return r&&this.bias===r.bias&&this.power===r.power&&this.leftColor.equals(r.leftColor)&&this.rightColor.equals(r.rightColor)&&this.isEnabled===r.isEnabled},n.prototype.serialize=function(){return{isEnabled:this.isEnabled,leftColor:this.leftColor.asArray(),rightColor:this.rightColor.asArray(),bias:this.bias,power:this.power}},n.Parse=function(r){return new n({isEnabled:r.isEnabled,leftColor:G.FromArray(r.leftColor),rightColor:G.FromArray(r.rightColor),bias:r.bias,power:r.power||1})},n}();j._FresnelParametersParser=$i.Parse;(function(n){A(r,n);function r(e,t){var i=n.call(this,e,t,"color",{attributes:["position"],uniforms:["world","viewProjection","color"]})||this;return i.disableColorWrite=!0,i.forceDepthWrite=!0,i.setColor4("color",new ve(0,0,0,1)),i}return r})(xr);var Rr=function(n){A(r,n);function r(e,t){var i=n.call(this,e,t)||this;return i.maxSimultaneousLights=4,i.disableLighting=!1,i.invertNormalMapX=!1,i.invertNormalMapY=!1,i.emissiveColor=new G(0,0,0),i.occlusionStrength=1,i.useLightmapAsShadowmap=!1,i._useAlphaFromAlbedoTexture=!0,i._useAmbientInGrayScale=!0,i}return Object.defineProperty(r.prototype,"doubleSided",{get:function(){return this._twoSidedLighting},set:function(e){this._twoSidedLighting!==e&&(this._twoSidedLighting=e,this.backFaceCulling=!e,this._markAllSubMeshesAsTexturesDirty())},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"PBRBaseSimpleMaterial"},h([b(),S("_markAllSubMeshesAsLightsDirty")],r.prototype,"maxSimultaneousLights",void 0),h([b(),S("_markAllSubMeshesAsLightsDirty")],r.prototype,"disableLighting",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],r.prototype,"environmentTexture",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"invertNormalMapX",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"invertNormalMapY",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],r.prototype,"normalTexture",void 0),h([le("emissive"),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"emissiveColor",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"emissiveTexture",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],r.prototype,"occlusionStrength",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],r.prototype,"occlusionTexture",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],r.prototype,"alphaCutOff",void 0),h([b()],r.prototype,"doubleSided",null),h([U(),S("_markAllSubMeshesAsTexturesDirty",null)],r.prototype,"lightmapTexture",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useLightmapAsShadowmap",void 0),r}(pe),en=function(n){A(r,n);function r(e,t){var i=n.call(this,e,t)||this;return i._useRoughnessFromMetallicTextureAlpha=!1,i._useRoughnessFromMetallicTextureGreen=!0,i._useMetallnessFromMetallicTextureBlue=!0,i.metallic=1,i.roughness=1,i}return r.prototype.getClassName=function(){return"PBRMetallicRoughnessMaterial"},r.prototype.clone=function(e){var t=this,i=j.Clone(function(){return new r(e,t.getScene())},this);return i.id=e,i.name=e,this.clearCoat.copyTo(i.clearCoat),this.anisotropy.copyTo(i.anisotropy),this.brdf.copyTo(i.brdf),this.sheen.copyTo(i.sheen),this.subSurface.copyTo(i.subSurface),i},r.prototype.serialize=function(){var e=j.Serialize(this);return e.customType="BABYLON.PBRMetallicRoughnessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e},r.Parse=function(e,t,i){var a=j.Parse(function(){return new r(e.name,t)},e,t,i);return e.clearCoat&&a.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&a.anisotropy.parse(e.anisotropy,t,i),e.brdf&&a.brdf.parse(e.brdf,t,i),e.sheen&&a.sheen.parse(e.sheen,t,i),e.subSurface&&a.subSurface.parse(e.subSurface,t,i),e.iridescence&&a.iridescence.parse(e.iridescence,t,i),a},h([le(),S("_markAllSubMeshesAsTexturesDirty","_albedoColor")],r.prototype,"baseColor",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],r.prototype,"baseTexture",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"metallic",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty")],r.prototype,"roughness",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],r.prototype,"metallicRoughnessTexture",void 0),r}(Rr);P("BABYLON.PBRMetallicRoughnessMaterial",en);var tn=function(n){A(r,n);function r(e,t){var i=n.call(this,e,t)||this;return i._useMicroSurfaceFromReflectivityMapAlpha=!0,i}return Object.defineProperty(r.prototype,"useMicroSurfaceFromReflectivityMapAlpha",{get:function(){return this._useMicroSurfaceFromReflectivityMapAlpha},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"PBRSpecularGlossinessMaterial"},r.prototype.clone=function(e){var t=this,i=j.Clone(function(){return new r(e,t.getScene())},this);return i.id=e,i.name=e,this.clearCoat.copyTo(i.clearCoat),this.anisotropy.copyTo(i.anisotropy),this.brdf.copyTo(i.brdf),this.sheen.copyTo(i.sheen),this.subSurface.copyTo(i.subSurface),i},r.prototype.serialize=function(){var e=j.Serialize(this);return e.customType="BABYLON.PBRSpecularGlossinessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e},r.Parse=function(e,t,i){var a=j.Parse(function(){return new r(e.name,t)},e,t,i);return e.clearCoat&&a.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&a.anisotropy.parse(e.anisotropy,t,i),e.brdf&&a.brdf.parse(e.brdf,t,i),e.sheen&&a.sheen.parse(e.sheen,t,i),e.subSurface&&a.subSurface.parse(e.subSurface,t,i),e.iridescence&&a.iridescence.parse(e.iridescence,t,i),a},h([le("diffuse"),S("_markAllSubMeshesAsTexturesDirty","_albedoColor")],r.prototype,"diffuseColor",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],r.prototype,"diffuseTexture",void 0),h([le("specular"),S("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],r.prototype,"specularColor",void 0),h([b(),S("_markAllSubMeshesAsTexturesDirty","_microSurface")],r.prototype,"glossiness",void 0),h([U(),S("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],r.prototype,"specularGlossinessTexture",void 0),r}(Rr);P("BABYLON.PBRSpecularGlossinessMaterial",tn);var rn=function(n){A(r,n);function r(e,t,i){i===void 0&&(i=null);var a=n.call(this,t)||this;if(!e)return a;if(a._textureMatrix=q.Identity(),a.name=e,a.url=e,a._onLoad=i,a._texture=a._getFromCache(e,!0),a._texture)a._triggerOnLoad();else{var o=a.getScene();o&&o.useDelayedTextureLoading?a.delayLoadState=4:a._loadTexture()}return a}return r.prototype._triggerOnLoad=function(){this._onLoad&&this._onLoad()},r.prototype.getTextureMatrix=function(){return this._textureMatrix},r.prototype._load3dlTexture=function(){var e=this,t=this._getEngine(),i;t._features.support3DTextures?i=t.createRawTexture3D(null,1,1,1,5,!1,!1,2,null,0):i=t.createRawTexture(null,1,1,5,!1,!1,2,null,0),this._texture=i,this._texture.isReady=!1,this.isCube=!1,this.is3D=t._features.support3DTextures,this.wrapU=0,this.wrapV=0,this.wrapR=0,this.anisotropicFilteringLevel=1;var a=function(s){if(typeof s=="string"){for(var u=null,l=null,c,p=s.split(`
`),d=0,g=0,m=0,y=0,v=0,T=0;T<p.length;T++)if(c=p[T],!!r._NoneEmptyLineRegex.test(c)&&c.indexOf("#")!==0){var x=c.split(" ");if(d===0){d=x.length,u=new Uint8Array(d*d*d*4),l=new Float32Array(d*d*d*4);continue}if(d!=0){var E=Math.max(parseInt(x[0]),0),O=Math.max(parseInt(x[1]),0),N=Math.max(parseInt(x[2]),0);v=Math.max(E,v),v=Math.max(O,v),v=Math.max(N,v);var w=(g+y*d+m*d*d)*4;l&&(l[w+0]=E,l[w+1]=O,l[w+2]=N),m++,m%d==0&&(y++,m=0,y%d==0&&(g++,y=0))}}if(l&&u)for(var T=0;T<l.length;T++)if(T>0&&(T+1)%4===0)u[T]=255;else{var k=l[T];u[T]=k/v*255}i.is3D?(i.updateSize(d,d,d),t.updateRawTexture3D(i,u,5,!1)):(i.updateSize(d*d,d),t.updateRawTexture(i,u,5,!1)),i.isReady=!0,e._triggerOnLoad()}},o=this.getScene();return o?o._loadFile(this.url,a):t._loadFile(this.url,a),this._texture},r.prototype._loadTexture=function(){this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4&&this._load3dlTexture()},r.prototype.clone=function(){var e=new r(this.url,this.getScene()||this._getEngine());return e.level=this.level,e},r.prototype.delayLoad=function(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,!0),this._texture||this._loadTexture())},r.Parse=function(e,t){var i=null;return e.name&&!e.isRenderTarget&&(i=new r(e.name,t),i.name=e.name,i.level=e.level),i},r.prototype.serialize=function(){if(!this.name)return null;var e={};return e.name=this.name,e.level=this.level,e.customType="BABYLON.ColorGradingTexture",e},r._NoneEmptyLineRegex=/\S+/,r}(De);P("BABYLON.ColorGradingTexture",rn);var Ga=function(n){A(r,n);function r(e,t,i,a,o,s,u){a===void 0&&(a=!1),o===void 0&&(o=!0),s===void 0&&(s=null),u===void 0&&(u=null);var l=n.call(this,t)||this;if(l._onLoad=null,l._onError=null,!e)throw new Error("Image url is not set");return l._coordinatesMode=I.CUBIC_MODE,l.name=e,l.url=e,l._size=i,l._noMipmap=a,l.gammaSpace=o,l._onLoad=s,l._onError=u,l.hasAlpha=!1,l.isCube=!0,l._texture=l._getFromCache(e,l._noMipmap,void 0,void 0,void 0,l.isCube),l._texture?s&&(l._texture.isReady?ae.SetImmediate(function(){return s()}):l._texture.onLoadedObservable.add(s)):t.useDelayedTextureLoading?l.delayLoadState=4:l._loadImage(l._loadTexture.bind(l),l._onError),l}return r.prototype._loadImage=function(e,t){var i=this,a=document.createElement("canvas");si(this.url,function(o){i._width=o.width,i._height=o.height,a.width=i._width,a.height=i._height;var s=a.getContext("2d");s.drawImage(o,0,0);var u=s.getImageData(0,0,o.width,o.height);i._buffer=u.data.buffer,a.remove(),e()},function(o,s){t&&t("".concat(i.getClassName()," could not be loaded"),s)},null)},r.prototype._loadTexture=function(){var e=this,t=this.getScene(),i=function(){for(var a=e._getFloat32ArrayFromArrayBuffer(e._buffer),o=ui.ConvertPanoramaToCubemap(a,e._width,e._height,e._size),s=[],u=0;u<6;u++){var l=o[r._FacesMapping[u]];s.push(l)}return s};!t||(this._texture=t.getEngine().createRawCubeTextureFromUrl(this.url,t,this._size,4,t.getEngine().getCaps().textureFloat?1:7,this._noMipmap,i,null,this._onLoad,this._onError))},r.prototype._getFloat32ArrayFromArrayBuffer=function(e){for(var t=new DataView(e),i=new Float32Array(e.byteLength*3/4),a=0,o=0;o<e.byteLength;o++)(o+1)%4!==0&&(i[a++]=t.getUint8(o)/255);return i},r.prototype.getClassName=function(){return"EquiRectangularCubeTexture"},r.prototype.clone=function(){var e=this.getScene();if(!e)return this;var t=new r(this.url,e,this._size,this._noMipmap,this.gammaSpace);return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t},r._FacesMapping=["right","left","up","down","front","back"],r}(De);(function(n){A(r,n);function r(e,t,i){var a=n.call(this,i.scene||i.engine)||this;return a.onLoadObservable=new J,!t||!i.engine&&!i.scene||(i=Re(Re({},r._DefaultOptions),i),a._generateMipMaps=i.generateMipMaps,a._samplingMode=i.samplingMode,a._textureMatrix=q.Identity(),a.name=e,a.element=t,a._isVideo=t instanceof HTMLVideoElement,a.anisotropicFilteringLevel=1,a._createInternalTexture()),a}return r.prototype._createInternalTexture=function(){var e=0,t=0;this._isVideo?(e=this.element.videoWidth,t=this.element.videoHeight):(e=this.element.width,t=this.element.height);var i=this._getEngine();i&&(this._texture=i.createDynamicTexture(e,t,this._generateMipMaps,this._samplingMode)),this.update()},r.prototype.getTextureMatrix=function(){return this._textureMatrix},r.prototype.update=function(e){e===void 0&&(e=null);var t=this._getEngine();if(!(this._texture==null||t==null)){var i=this.isReady();if(this._isVideo){var a=this.element;if(a.readyState<a.HAVE_CURRENT_DATA)return;t.updateVideoTexture(this._texture,a,e===null?!0:e)}else{var o=this.element;t.updateDynamicTexture(this._texture,o,e===null?!0:e,!1)}!i&&this.isReady()&&this.onLoadObservable.notifyObservers(this)}},r.prototype.dispose=function(){this.onLoadObservable.clear(),n.prototype.dispose.call(this)},r._DefaultOptions={generateMipMaps:!1,samplingMode:2,engine:null,scene:null},r})(De);var nn=function(){function n(){this.supportCascades=!1}return n.prototype.canLoad=function(r){return r.endsWith(".tga")},n.prototype.loadCubeData=function(){throw".env not supported in Cube."},n.prototype.loadData=function(r,e,t){var i=new Uint8Array(r.buffer,r.byteOffset,r.byteLength),a=li(i);t(a.width,a.height,e.generateMipMaps,!1,function(){ci(e,i)})},n}();Q._TextureLoaders.push(new nn);var an=function(){function n(){this.supportCascades=!1}return n.prototype.canLoad=function(r){return r.endsWith(".hdr")},n.prototype.loadCubeData=function(){throw".env not supported in Cube."},n.prototype.loadData=function(r,e,t){for(var i=new Uint8Array(r.buffer,r.byteOffset,r.byteLength),a=Bt.RGBE_ReadHeader(i),o=Bt.RGBE_ReadPixels(i,a),s=a.width*a.height,u=new Float32Array(s*4),l=0;l<s;l+=1)u[l*4]=o[l*3],u[l*4+1]=o[l*3+1],u[l*4+2]=o[l*3+2],u[l*4+3]=1;t(a.width,a.height,e.generateMipMaps,!1,function(){var c=e.getEngine();e.type=1,e.format=5,e._gammaSpace=!1,c._uploadDataToTextureDirectly(e,u)})},n}();Q._TextureLoaders.push(new an);var on=function(){function n(){this.supportCascades=!1}return n.prototype.canLoad=function(r){return r.endsWith(".basis")},n.prototype.loadCubeData=function(r,e,t,i,a){if(!Array.isArray(r)){var o=e.getEngine().getCaps(),s={supportedCompressionFormats:{etc1:!!o.etc1,s3tc:!!o.s3tc,pvrtc:!!o.pvrtc,etc2:!!o.etc2,astc:!!o.astc,bc7:!!o.bptc}};nr(r,s).then(function(u){var l=u.fileInfo.images[0].levels.length>1&&e.generateMipMaps;ar(e,u),e.getEngine()._setCubeMapTextureParams(e,l),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),i&&i()}).catch(function(u){var l="Failed to transcode Basis file, transcoding may not be supported on this device";ae.Warn(l),e.isReady=!0,a&&a(u)})}},n.prototype.loadData=function(r,e,t){var i=e.getEngine().getCaps(),a={supportedCompressionFormats:{etc1:!!i.etc1,s3tc:!!i.s3tc,pvrtc:!!i.pvrtc,etc2:!!i.etc2,astc:!!i.astc,bc7:!!i.bptc}};nr(r,a).then(function(o){var s=o.fileInfo.images[0].levels[0],u=o.fileInfo.images[0].levels.length>1&&e.generateMipMaps;t(s.width,s.height,u,o.format!==-1,function(){ar(e,o)})}).catch(function(o){ae.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),ae.Warn("Failed to transcode Basis file: ".concat(o)),t(0,0,!1,!1,function(){},!0)})},n}();Q._TextureLoaders.push(new on);var sn=function(n){A(r,n);function r(e,t,i,a,o,s){var u=this,l=o&&o.generateMipMaps?o.generateMipMaps:!1,c=o&&o.generateDepthTexture?o.generateDepthTexture:!1,p=o&&o.depthTextureFormat?o.depthTextureFormat:15,d=!o||o.doNotChangeAspectRatio===void 0?!0:o.doNotChangeAspectRatio,g=o&&o.drawOnlyOnFirstAttachmentByDefault?o.drawOnlyOnFirstAttachmentByDefault:!1;if(u=n.call(this,e,t,a,l,d,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0)||this,!u.isSupported)return u.dispose(),u;var m=[],y=[],v=[];u._initTypes(i,m,y,v,o);var T=!o||o.generateDepthBuffer===void 0?!0:o.generateDepthBuffer,x=!o||o.generateStencilBuffer===void 0?!1:o.generateStencilBuffer;return u._size=t,u._multiRenderTargetOptions={samplingModes:y,generateMipMaps:l,generateDepthBuffer:T,generateStencilBuffer:x,generateDepthTexture:c,depthTextureFormat:p,types:m,textureCount:i,useSRGBBuffers:v},u._count=i,u._drawOnlyOnFirstAttachmentByDefault=g,i>0&&(u._createInternalTextures(),u._createTextures(s)),u}return Object.defineProperty(r.prototype,"isSupported",{get:function(){var e,t;return(t=(e=this._engine)===null||e===void 0?void 0:e.getCaps().drawBuffersExtension)!==null&&t!==void 0?t:!1},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"textures",{get:function(){return this._textures},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"count",{get:function(){return this._count},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"depthTexture",{get:function(){return this._textures[this._textures.length-1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"wrapU",{set:function(e){if(this._textures)for(var t=0;t<this._textures.length;t++)this._textures[t].wrapU=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"wrapV",{set:function(e){if(this._textures)for(var t=0;t<this._textures.length;t++)this._textures[t].wrapV=e},enumerable:!1,configurable:!0}),r.prototype._initTypes=function(e,t,i,a,o){for(var s=0;s<e;s++)o&&o.types&&o.types[s]!==void 0?t.push(o.types[s]):t.push(o&&o.defaultType?o.defaultType:0),o&&o.samplingModes&&o.samplingModes[s]!==void 0?i.push(o.samplingModes[s]):i.push(I.BILINEAR_SAMPLINGMODE),o&&o.useSRGBBuffers&&o.useSRGBBuffers[s]!==void 0?a.push(o.useSRGBBuffers[s]):a.push(!1)},r.prototype._rebuild=function(e,t){if(e===void 0&&(e=!1),!(this._count<1)){this.releaseInternalTextures(),this._createInternalTextures(),e&&(this._releaseTextures(),this._createTextures(t));for(var i=this._renderTarget.textures,a=0;a<i.length;a++){var o=this._textures[a];o._texture=i[a]}this.samples!==1&&this._renderTarget.setSamples(this.samples,!this._drawOnlyOnFirstAttachmentByDefault,!0)}},r.prototype._createInternalTextures=function(){this._renderTarget=this._getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions,!this._drawOnlyOnFirstAttachmentByDefault),this._texture=this._renderTarget.texture},r.prototype._releaseTextures=function(){if(this._textures)for(var e=0;e<this._textures.length;e++)this._textures[e]._texture=null,this._textures[e].dispose()},r.prototype._createTextures=function(e){var t=this._renderTarget.textures;this._textures=[];for(var i=0;i<t.length;i++){var a=new I(null,this.getScene());e!=null&&e[i]&&(a.name=e[i]),a._texture=t[i],this._textures.push(a)}},r.prototype.setInternalTexture=function(e,t,i){i===void 0&&(i=!0),this.renderTarget&&(t===0&&(this._texture=e),this.renderTarget.setTexture(e,t,i),this.textures[t]||(this.textures[t]=new I(null,this.getScene())),this.textures[t]._texture=e,this._count=this.renderTarget.textures?this.renderTarget.textures.length:0,this._multiRenderTargetOptions.types&&(this._multiRenderTargetOptions.types[t]=e.type),this._multiRenderTargetOptions.samplingModes&&(this._multiRenderTargetOptions.samplingModes[t]=e.samplingMode),this._multiRenderTargetOptions.useSRGBBuffers&&(this._multiRenderTargetOptions.useSRGBBuffers[t]=e._useSRGBBuffer))},Object.defineProperty(r.prototype,"samples",{get:function(){return this._samples},set:function(e){this._renderTarget?this._samples=this._renderTarget.setSamples(e):this._samples=e},enumerable:!1,configurable:!0}),r.prototype.resize=function(e){this._size=e,this._rebuild()},r.prototype.updateCount=function(e,t,i){this._multiRenderTargetOptions.textureCount=e,this._count=e;var a=[],o=[],s=[];this._initTypes(e,a,o,s,t),this._multiRenderTargetOptions.types=a,this._multiRenderTargetOptions.samplingModes=o,this._multiRenderTargetOptions.useSRGBBuffers=s,this._rebuild(!0,i)},r.prototype._unbindFrameBuffer=function(e,t){var i=this;this._renderTarget&&e.unBindMultiColorAttachmentFramebuffer(this._renderTarget,this.isCube,function(){i.onAfterRenderObservable.notifyObservers(t)})},r.prototype.dispose=function(e){e===void 0&&(e=!1),this._releaseTextures(),e?this._texture=null:this.releaseInternalTextures(),n.prototype.dispose.call(this)},r.prototype.releaseInternalTextures=function(){var e,t,i=(e=this._renderTarget)===null||e===void 0?void 0:e.textures;if(!!i){for(var a=i.length-1;a>=0;a--)this._textures[a]._texture=null;(t=this._renderTarget)===null||t===void 0||t.dispose(),this._renderTarget=null}},r}(Ve);(function(n){A(r,n);function r(e,t,i,a,o,s){var u=n.call(this,e,i,null,a,o,s)||this;return u._animate=!0,u._time=0,u._texturePath=t,u._loadJson(t),u.refreshRate=1,u}return r.prototype._loadJson=function(e){var t=this,i=function(){try{t.setFragment(t._texturePath)}catch{$.Log("No json or ShaderStore or DOM element found for CustomProceduralTexture")}},a=e+"/config.json",o=new lt;o.open("GET",a),o.addEventListener("load",function(){if(o.status===200||o.responseText&&o.responseText.length>0)try{t._config=JSON.parse(o.response),t.updateShaderUniforms(),t.updateTextures(),t.setFragment(t._texturePath+"/custom"),t._animate=t._config.animate,t.refreshRate=t._config.refreshrate}catch{i()}else i()},!1),o.addEventListener("error",function(){i()},!1);try{o.send()}catch{$.Error("CustomProceduralTexture: Error on XHR send request.")}},r.prototype.isReady=function(){if(!n.prototype.isReady.call(this))return!1;for(var e in this._textures){var t=this._textures[e];if(!t.isReady())return!1}return!0},r.prototype.render=function(e){var t=this.getScene();this._animate&&t&&(this._time+=t.getAnimationRatio()*.03,this.updateShaderUniforms()),n.prototype.render.call(this,e)},r.prototype.updateTextures=function(){for(var e=0;e<this._config.sampler2Ds.length;e++)this.setTexture(this._config.sampler2Ds[e].sample2Dname,new I(this._texturePath+"/"+this._config.sampler2Ds[e].textureRelativeUrl,this.getScene()))},r.prototype.updateShaderUniforms=function(){if(this._config)for(var e=0;e<this._config.uniforms.length;e++){var t=this._config.uniforms[e];switch(t.type){case"float":this.setFloat(t.name,t.value);break;case"color3":this.setColor3(t.name,new G(t.r,t.g,t.b));break;case"color4":this.setColor4(t.name,new ve(t.r,t.g,t.b,t.a));break;case"vector2":this.setVector2(t.name,new Te(t.x,t.y));break;case"vector3":this.setVector3(t.name,new K(t.x,t.y,t.z));break}}this.setFloat("time",this._time)},Object.defineProperty(r.prototype,"animate",{get:function(){return this._animate},set:function(e){this._animate=e},enumerable:!1,configurable:!0}),r})(ft);var un=function(n){A(r,n);function r(e,t,i,a,o){t===void 0&&(t=256),i===void 0&&(i=de.LastCreatedScene);var s=n.call(this,e,t,"noise",i,a,o)||this;return s.time=0,s.brightness=.2,s.octaves=3,s.persistence=.8,s.animationSpeedFactor=1,s.autoClear=!1,s._updateShaderUniforms(),s}return r.prototype._updateShaderUniforms=function(){var e=this.getScene();!e||(this.time+=e.getAnimationRatio()*this.animationSpeedFactor*.01,this.setFloat("brightness",this.brightness),this.setFloat("persistence",this.persistence),this.setFloat("timeScale",this.time))},r.prototype._getDefines=function(){return"#define OCTAVES "+(this.octaves|0)},r.prototype.render=function(e){this._updateShaderUniforms(),n.prototype.render.call(this,e)},r.prototype.serialize=function(){var e={};return e.customType="BABYLON.NoiseProceduralTexture",e.brightness=this.brightness,e.octaves=this.octaves,e.persistence=this.persistence,e.animationSpeedFactor=this.animationSpeedFactor,e.size=this.getSize().width,e.generateMipMaps=this._generateMipMaps,e.time=this.time,e},r.prototype.clone=function(){var e=this.getSize(),t=new r(this.name,e.width,this.getScene(),this._fallbackTexture?this._fallbackTexture:void 0,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t.brightness=this.brightness,t.octaves=this.octaves,t.persistence=this.persistence,t.animationSpeedFactor=this.animationSpeedFactor,t.time=this.time,t},r.Parse=function(e,t){var i,a=new r(e.name,e.size,t,void 0,e.generateMipMaps);return a.brightness=e.brightness,a.octaves=e.octaves,a.persistence=e.persistence,a.animationSpeedFactor=e.animationSpeedFactor,a.time=(i=e.time)!==null&&i!==void 0?i:0,a},r}(ft);P("BABYLON.NoiseProceduralTexture",un);var Ha=function(n){A(r,n);function r(e,t,i,a,o,s,u,l,c){a===void 0&&(a=5),o===void 0&&(o=0),s===void 0&&(s=!1),u===void 0&&(u=!1),l===void 0&&(l=3),c===void 0&&(c=null);var p=n.call(this,"",e)||this;return p._texture=e.getEngine().createRawCubeTexture(t,i,a,o,s,u,l,c),p}return r.prototype.update=function(e,t,i,a,o){o===void 0&&(o=null),this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,i,a,o)},r.prototype.updateRGBDAsync=function(e,t,i,a){return t===void 0&&(t=null),i===void 0&&(i=.8),a===void 0&&(a=0),fi(this._texture,e,t,i,a).then(function(){})},r.prototype.clone=function(){var e=this;return j.Clone(function(){var t=e.getScene(),i=e._texture,a=new r(t,i._bufferViewArray,i.width,i.format,i.type,i.generateMipMaps,i.invertY,i.samplingMode,i._compression);return i.source===ge.CubeRawRGBD&&a.updateRGBDAsync(i._bufferViewArrayArray,i._sphericalPolynomial,i._lodGenerationScale,i._lodGenerationOffset),a},this)},r}(et);(function(n){A(r,n);function r(e,t,i,a,o,s,u,l,c,p){u===void 0&&(u=!0),l===void 0&&(l=!1),c===void 0&&(c=I.TRILINEAR_SAMPLINGMODE),p===void 0&&(p=0);var d=n.call(this,null,s,!u,l)||this;return d.format=o,d._texture=s.getEngine().createRawTexture3D(e,t,i,a,o,u,l,c,null,p),d.is3D=!0,d}return r.prototype.update=function(e){!this._texture||this._getEngine().updateRawTexture3D(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)},r})(I);(function(n){A(r,n);function r(e,t,i,a){var o=n.call(this,e,t,i,a,!0)||this;return o.refractionPlane=new ct(0,1,0,1),o.depth=2,o.onBeforeRenderObservable.add(function(){o.getScene().clipPlane=o.refractionPlane}),o.onAfterRenderObservable.add(function(){o.getScene().clipPlane=null}),o}return r.prototype.clone=function(){var e=this.getScene();if(!e)return this;var t=this.getSize(),i=new r(this.name,t.width,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.refractionPlane=this.refractionPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i.depth=this.depth,i},r.prototype.serialize=function(){if(!this.name)return null;var e=n.prototype.serialize.call(this);return e.mirrorPlane=this.refractionPlane.asArray(),e.depth=this.depth,e},r})(Ve);(function(n){A(r,n);function r(e,t,i){var a=n.call(this,null)||this;return a._renderTarget=null,a._engine=e,a._renderTargetOptions=i,a.resize(t),a}return Object.defineProperty(r.prototype,"renderTarget",{get:function(){return this._renderTarget},enumerable:!1,configurable:!0}),r.prototype.resize=function(e){var t;(t=this._renderTarget)===null||t===void 0||t.dispose(),this._renderTarget=null,this._texture=null,this._size=e,this._engine&&(this._renderTarget=this._engine.createRenderTargetTexture(this._size,this._renderTargetOptions)),this._texture=this.renderTarget.texture},r.prototype.getInternalTexture=function(){return this._texture},r.prototype.getClassName=function(){return"ThinRenderTargetTexture"},r.prototype.dispose=function(e){var t;e===void 0&&(e=!1),(t=this._renderTarget)===null||t===void 0||t.dispose(!0),this._renderTarget=null,e||this.dispose()},r})(mr);var ce=function(n){A(r,n);function r(e,t,i,a,o,s){var u=n.call(this,e,t,i)||this;return u._blockType=a,u._blockName=o,u._nameForCheking=s,u._nameForCheking||(u._nameForCheking=e),u.needDualDirectionValidation=!0,u}return r.prototype.checkCompatibilityState=function(e){return e instanceof r&&e.name===this._nameForCheking?ye.Compatible:ye.TypeIncompatible},r.prototype.createCustomInputBlock=function(){return[new this._blockType(this._blockName),this.name]},r}(wt),ln=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Vertex)||this;return t.registerInput("matricesIndices",f.Vector4),t.registerInput("matricesWeights",f.Vector4),t.registerInput("matricesIndicesExtra",f.Vector4,!0),t.registerInput("matricesWeightsExtra",f.Vector4,!0),t.registerInput("world",f.Matrix),t.registerOutput("output",f.Matrix),t}return r.prototype.initialize=function(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh")},r.prototype.getClassName=function(){return"BonesBlock"},Object.defineProperty(r.prototype,"matricesIndices",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"matricesWeights",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"matricesIndicesExtra",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"matricesWeightsExtra",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"world",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype.autoConfigure=function(e){if(!this.matricesIndices.isConnected){var t=e.getInputBlockByPredicate(function(o){return o.isAttribute&&o.name==="matricesIndices"});t||(t=new B("matricesIndices"),t.setAsAttribute("matricesIndices")),t.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){var i=e.getInputBlockByPredicate(function(o){return o.isAttribute&&o.name==="matricesWeights"});i||(i=new B("matricesWeights"),i.setAsAttribute("matricesWeights")),i.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){var a=e.getInputBlockByPredicate(function(o){return o.systemValue===V.World});a||(a=new B("world"),a.setAsSystemValue(V.World)),a.output.connectTo(this.world)}},r.prototype.provideFallbacks=function(e,t){e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&t.addCPUSkinningFallback(0,e)},r.prototype.bind=function(e,t,i){C.BindBonesParameters(i,e)},r.prototype.prepareDefines=function(e,t,i){!i._areAttributesDirty||C.PrepareDefinesForBones(e,i)},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");var t="//".concat(this.name);e._emitFunctionFromInclude("bonesDeclaration",t,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});var i=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",t,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:i}]});var a=this._outputs[0],o=this.world;return e.compilationString+=`#if NUM_BONE_INFLUENCERS>0\r
`,e.compilationString+=this._declareOutput(a,e)+" = ".concat(o.associatedVariableName," * ").concat(i,`;\r
`),e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(a,e)+" = ".concat(o.associatedVariableName,`;\r
`),e.compilationString+=`#endif\r
`,this},r}(F);P("BABYLON.BonesBlock",ln);var cn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Vertex)||this;return t.registerInput("world0",f.Vector4),t.registerInput("world1",f.Vector4),t.registerInput("world2",f.Vector4),t.registerInput("world3",f.Vector4),t.registerInput("world",f.Matrix,!0),t.registerOutput("output",f.Matrix),t.registerOutput("instanceID",f.Float),t}return r.prototype.getClassName=function(){return"InstancesBlock"},Object.defineProperty(r.prototype,"world0",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"world1",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"world2",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"world3",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"world",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"instanceID",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),r.prototype.autoConfigure=function(e){if(!this.world0.connectedPoint){var t=e.getInputBlockByPredicate(function(u){return u.isAttribute&&u.name==="world0"});t||(t=new B("world0"),t.setAsAttribute("world0")),t.output.connectTo(this.world0)}if(!this.world1.connectedPoint){var i=e.getInputBlockByPredicate(function(u){return u.isAttribute&&u.name==="world1"});i||(i=new B("world1"),i.setAsAttribute("world1")),i.output.connectTo(this.world1)}if(!this.world2.connectedPoint){var a=e.getInputBlockByPredicate(function(u){return u.isAttribute&&u.name==="world2"});a||(a=new B("world2"),a.setAsAttribute("world2")),a.output.connectTo(this.world2)}if(!this.world3.connectedPoint){var o=e.getInputBlockByPredicate(function(u){return u.isAttribute&&u.name==="world3"});o||(o=new B("world3"),o.setAsAttribute("world3")),o.output.connectTo(this.world3)}if(!this.world.connectedPoint){var s=e.getInputBlockByPredicate(function(u){return u.isAttribute&&u.name==="world"});s||(s=new B("world"),s.setAsSystemValue(V.World)),s.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"},r.prototype.prepareDefines=function(e,t,i,a,o){a===void 0&&(a=!1);var s=!1;i.INSTANCES!==a&&(i.setValue("INSTANCES",a),s=!0),o&&i.THIN_INSTANCES!==!!(o!=null&&o.getRenderingMesh().hasThinInstances)&&(i.setValue("THIN_INSTANCES",!!(o!=null&&o.getRenderingMesh().hasThinInstances)),s=!0),s&&i.markAsUnprocessed()},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);var i=this._outputs[0],a=this._outputs[1],o=this.world0,s=this.world1,u=this.world2,l=this.world3;return e.compilationString+=`#ifdef INSTANCES\r
`,e.compilationString+=this._declareOutput(i,e)+" = mat4(".concat(o.associatedVariableName,", ").concat(s.associatedVariableName,", ").concat(u.associatedVariableName,", ").concat(l.associatedVariableName,`);\r
`),e.compilationString+=`#ifdef THIN_INSTANCES\r
`,e.compilationString+="".concat(i.associatedVariableName," = ").concat(this.world.associatedVariableName," * ").concat(i.associatedVariableName,`;\r
`),e.compilationString+=`#endif\r
`,t._caps.canUseGLInstanceID?e.compilationString+=this._declareOutput(a,e)+` = float(gl_InstanceID);\r
`:e.compilationString+=this._declareOutput(a,e)+` = 0.0;\r
`,e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(i,e)+" = ".concat(this.world.associatedVariableName,`;\r
`),e.compilationString+=this._declareOutput(a,e)+` = 0.0;\r
`,e.compilationString+=`#endif\r
`,this},r}(F);P("BABYLON.InstancesBlock",cn);var fn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Vertex)||this;return t.registerInput("position",f.Vector3),t.registerInput("normal",f.Vector3),t.registerInput("tangent",f.Vector4),t.tangent.acceptedConnectionPointTypes.push(f.Vector3),t.registerInput("uv",f.Vector2),t.registerOutput("positionOutput",f.Vector3),t.registerOutput("normalOutput",f.Vector3),t.registerOutput("tangentOutput",f.Vector4),t.registerOutput("uvOutput",f.Vector2),t}return r.prototype.getClassName=function(){return"MorphTargetsBlock"},Object.defineProperty(r.prototype,"position",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"normal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"tangent",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"uv",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"positionOutput",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"normalOutput",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"tangentOutput",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"uvOutput",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),r.prototype.initialize=function(e){e._excludeVariableName("morphTargetInfluences")},r.prototype.autoConfigure=function(e){if(!this.position.isConnected){var t=e.getInputBlockByPredicate(function(s){return s.isAttribute&&s.name==="position"});t||(t=new B("position"),t.setAsAttribute()),t.output.connectTo(this.position)}if(!this.normal.isConnected){var i=e.getInputBlockByPredicate(function(s){return s.isAttribute&&s.name==="normal"});i||(i=new B("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){var a=e.getInputBlockByPredicate(function(s){return s.isAttribute&&s.name==="tangent"});a||(a=new B("tangent"),a.setAsAttribute("tangent")),a.output.connectTo(this.tangent)}if(!this.uv.isConnected){var o=e.getInputBlockByPredicate(function(s){return s.isAttribute&&s.name==="uv"});o||(o=new B("uv"),o.setAsAttribute("uv")),o.output.connectTo(this.uv)}},r.prototype.prepareDefines=function(e,t,i){if(e.morphTargetManager){var a=e.morphTargetManager;(a==null?void 0:a.isUsingTextureForTargets)&&a.numInfluencers!==i.NUM_MORPH_INFLUENCERS&&i.markAsAttributesDirty()}!i._areAttributesDirty||C.PrepareDefinesForMorphTargets(e,i)},r.prototype.bind=function(e,t,i){i&&i.morphTargetManager&&i.morphTargetManager.numInfluencers>0&&(C.BindMorphTargetParameters(i,e),i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(e))},r.prototype.replaceRepeatableContent=function(e,t,i,a){var o=this.position,s=this.normal,u=this.tangent,l=this.uv,c=this.positionOutput,p=this.normalOutput,d=this.tangentOutput,g=this.uvOutput,m=e,y=a.NUM_MORPH_INFLUENCERS,v=i.morphTargetManager,T=v&&v.supportsNormals&&a.NORMAL,x=v&&v.supportsTangents&&a.TANGENT,E=v&&v.supportsUVs&&a.UV1,O="";(v==null?void 0:v.isUsingTextureForTargets)&&y>0&&(O+=`float vertexID;\r
`);for(var N=0;N<y;N++)O+=`#ifdef MORPHTARGETS\r
`,v!=null&&v.isUsingTextureForTargets?(O+=`vertexID = float(gl_VertexID) * morphTargetTextureInfo.x;\r
`,O+="".concat(c.associatedVariableName," += (readVector3FromRawSampler(").concat(N,", vertexID) - ").concat(o.associatedVariableName,") * morphTargetInfluences[").concat(N,`];\r
`),O+=`vertexID += 1.0;\r
`):O+="".concat(c.associatedVariableName," += (position").concat(N," - ").concat(o.associatedVariableName,") * morphTargetInfluences[").concat(N,`];\r
`),T&&(O+=`#ifdef MORPHTARGETS_NORMAL\r
`,v!=null&&v.isUsingTextureForTargets?(O+="".concat(p.associatedVariableName," += (readVector3FromRawSampler(").concat(N,", vertexID) - ").concat(s.associatedVariableName,") * morphTargetInfluences[").concat(N,`];\r
`),O+=`vertexID += 1.0;\r
`):O+="".concat(p.associatedVariableName," += (normal").concat(N," - ").concat(s.associatedVariableName,") * morphTargetInfluences[").concat(N,`];\r
`),O+=`#endif\r
`),E&&(O+=`#ifdef MORPHTARGETS_UV\r
`,v!=null&&v.isUsingTextureForTargets?(O+="".concat(g.associatedVariableName," += (readVector3FromRawSampler(").concat(N,", vertexID).xy - ").concat(l.associatedVariableName,") * morphTargetInfluences[").concat(N,`];\r
`),O+=`vertexID += 1.0;\r
`):O+="".concat(g.associatedVariableName,".xy += (uv_").concat(N," - ").concat(l.associatedVariableName,".xy) * morphTargetInfluences[").concat(N,`];\r
`),O+=`#endif\r
`),x&&(O+=`#ifdef MORPHTARGETS_TANGENT\r
`,v!=null&&v.isUsingTextureForTargets?O+="".concat(d.associatedVariableName,".xyz += (readVector3FromRawSampler(").concat(N,", vertexID) - ").concat(u.associatedVariableName,".xyz) * morphTargetInfluences[").concat(N,`];\r
`):O+="".concat(d.associatedVariableName,".xyz += (tangent").concat(N," - ").concat(u.associatedVariableName,".xyz) * morphTargetInfluences[").concat(N,`];\r
`),u.type===f.Vector4?O+="".concat(d.associatedVariableName,".w = ").concat(u.associatedVariableName,`.w;\r
`):O+="".concat(d.associatedVariableName,`.w = 1.;\r
`),O+=`#endif\r
`),O+=`#endif\r
`;if(m.compilationString=m.compilationString.replace(this._repeatableContentAnchor,O),y>0)for(var N=0;N<y;N++)m.attributes.push(L.PositionKind+N),T&&m.attributes.push(L.NormalKind+N),x&&m.attributes.push(L.TangentKind+N),E&&m.attributes.push(L.UVKind+"_"+N)},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.repeatableContentBlocks.push(this);var t=this.position,i=this.normal,a=this.tangent,o=this.uv,s=this.positionOutput,u=this.normalOutput,l=this.tangentOutput,c=this.uvOutput,p="//".concat(this.name);return e.uniforms.push("morphTargetInfluences"),e.uniforms.push("morphTargetTextureInfo"),e.uniforms.push("morphTargetTextureIndices"),e.samplers.push("morphTargets"),e._emitFunctionFromInclude("morphTargetsVertexGlobalDeclaration",p),e._emitFunctionFromInclude("morphTargetsVertexDeclaration",p,{repeatKey:"maxSimultaneousMorphTargets"}),e.compilationString+="".concat(this._declareOutput(s,e)," = ").concat(t.associatedVariableName,`;\r
`),e.compilationString+=`#ifdef NORMAL\r
`,e.compilationString+="".concat(this._declareOutput(u,e)," = ").concat(i.associatedVariableName,`;\r
`),e.compilationString+=`#else\r
`,e.compilationString+="".concat(this._declareOutput(u,e),` = vec3(0., 0., 0.);\r
`),e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef TANGENT\r
`,e.compilationString+="".concat(this._declareOutput(l,e)," = ").concat(a.associatedVariableName,`;\r
`),e.compilationString+=`#else\r
`,e.compilationString+="".concat(this._declareOutput(l,e),` = vec4(0., 0., 0., 0.);\r
`),e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef UV1\r
`,e.compilationString+="".concat(this._declareOutput(c,e)," = ").concat(o.associatedVariableName,`;\r
`),e.compilationString+=`#else\r
`,e.compilationString+="".concat(this._declareOutput(c,e),` = vec2(0., 0.);\r
`),e.compilationString+=`#endif\r
`,this._repeatableContentAnchor=e._repeatableContentAnchor,e.compilationString+=this._repeatableContentAnchor,this},r}(F);P("BABYLON.MorphTargetsBlock",fn);var pn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Vertex)||this;return t.registerInput("worldPosition",f.Vector4,!1,_.Vertex),t.registerOutput("direction",f.Vector3),t.registerOutput("color",f.Color3),t.registerOutput("intensity",f.Float),t.registerOutput("shadowBias",f.Float),t.registerOutput("shadowNormalBias",f.Float),t.registerOutput("shadowDepthScale",f.Float),t.registerOutput("shadowDepthRange",f.Vector2),t}return r.prototype.getClassName=function(){return"LightInformationBlock"},Object.defineProperty(r.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"direction",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"color",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"intensity",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"shadowBias",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"shadowNormalBias",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"shadowDepthScale",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"shadowDepthRange",{get:function(){return this._outputs[6]},enumerable:!1,configurable:!0}),r.prototype.bind=function(e,t,i){if(!!i){this.light&&this.light.isDisposed()&&(this.light=null);var a=this.light,o=t.getScene();if(!a&&o.lights.length&&(a=this.light=o.lights[0],this._forcePrepareDefines=!0),!a||!a.isEnabled){e.setFloat3(this._lightDataUniformName,0,0,0),e.setFloat4(this._lightColorUniformName,0,0,0,0);return}a.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,a.diffuse,a.intensity);var s=a.getShadowGenerator();if((this.shadowBias.hasEndpoints||this.shadowNormalBias.hasEndpoints||this.shadowDepthScale.hasEndpoints)&&(s?e.setFloat3(this._lightShadowUniformName,s.bias,s.normalBias,s.depthScale):e.setFloat3(this._lightShadowUniformName,0,0,0)),this.shadowDepthRange)if(s&&o.activeCamera){var u=a;e.setFloat2(this._lightShadowExtraUniformName,u.getDepthMinZ(o.activeCamera),u.getDepthMinZ(o.activeCamera)+u.getDepthMaxZ(o.activeCamera))}else e.setFloat2(this._lightShadowExtraUniformName,0,0)}},r.prototype.prepareDefines=function(e,t,i){if(!(!i._areLightsDirty&&!this._forcePrepareDefines)){this._forcePrepareDefines=!1;var a=this.light;i.setValue(this._lightTypeDefineName,!!(a&&a instanceof hi),!0)}},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);var t=this.direction,i=this.color,a=this.intensity,o=this.shadowBias,s=this.shadowNormalBias,u=this.shadowDepthScale,l=this.shadowDepthRange;return this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightShadowUniformName=e._getFreeVariableName("shadowData"),this._lightShadowExtraUniformName=e._getFreeVariableName("shadowExtraData"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE"),e._emitUniformFromString(this._lightDataUniformName,"vec3"),e._emitUniformFromString(this._lightColorUniformName,"vec4"),e.compilationString+="#ifdef ".concat(this._lightTypeDefineName,`\r
`),e.compilationString+=this._declareOutput(t,e)+" = normalize(".concat(this.worldPosition.associatedVariableName,".xyz - ").concat(this._lightDataUniformName,`);\r
`),e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(t,e)+" = ".concat(this._lightDataUniformName,`;\r
`),e.compilationString+=`#endif\r
`,e.compilationString+=this._declareOutput(i,e)+" = ".concat(this._lightColorUniformName,`.rgb;\r
`),e.compilationString+=this._declareOutput(a,e)+" = ".concat(this._lightColorUniformName,`.a;\r
`),(o.hasEndpoints||s.hasEndpoints||u.hasEndpoints)&&(e._emitUniformFromString(this._lightShadowUniformName,"vec3"),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+" = ".concat(this._lightShadowUniformName,`.x;\r
`)),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+" = ".concat(this._lightShadowUniformName,`.y;\r
`)),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+" = ".concat(this._lightShadowUniformName,`.z;\r
`))),l.hasEndpoints&&(e._emitUniformFromString(this._lightShadowExtraUniformName,"vec2"),e.compilationString+=this._declareOutput(l,e)+" = ".concat(this._lightShadowUniformName,`;\r
`)),this},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return this.light&&(e.lightId=this.light.id),e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))},r}(F);P("BABYLON.LightInformationBlock",pn);var hn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t.convertInputToLinearSpace=!0,t.registerInput("color",f.Color4),t.registerOutput("output",f.Color4),t._inputs[0].acceptedConnectionPointTypes.push(f.Color3),t}return r.prototype.getClassName=function(){return"ImageProcessingBlock"},Object.defineProperty(r.prototype,"color",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype.initialize=function(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings")},r.prototype.isReady=function(e,t,i){return!(i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())},r.prototype.prepareDefines=function(e,t,i){i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i)},r.prototype.bind=function(e,t,i){!i||!t.imageProcessingConfiguration||t.imageProcessingConfiguration.bind(e)},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings");var t=this.color,i=this._outputs[0],a="//".concat(this.name);return e._emitFunctionFromInclude("helperFunctions",a),e._emitFunctionFromInclude("imageProcessingDeclaration",a),e._emitFunctionFromInclude("imageProcessingFunctions",a),t.connectedPoint.type===f.Color4||t.connectedPoint.type===f.Vector4?e.compilationString+="".concat(this._declareOutput(i,e)," = ").concat(t.associatedVariableName,`;\r
`):e.compilationString+="".concat(this._declareOutput(i,e)," = vec4(").concat(t.associatedVariableName,`, 1.0);\r
`),e.compilationString+=`#ifdef IMAGEPROCESSINGPOSTPROCESS\r
`,this.convertInputToLinearSpace&&(e.compilationString+="".concat(i.associatedVariableName,".rgb = toLinearSpace(").concat(t.associatedVariableName,`.rgb);\r
`)),e.compilationString+=`#else\r
`,e.compilationString+=`#ifdef IMAGEPROCESSING\r
`,this.convertInputToLinearSpace&&(e.compilationString+="".concat(i.associatedVariableName,".rgb = toLinearSpace(").concat(t.associatedVariableName,`.rgb);\r
`)),e.compilationString+="".concat(i.associatedVariableName," = applyImageProcessing(").concat(i.associatedVariableName,`);\r
`),e.compilationString+=`#endif\r
`,e.compilationString+=`#endif\r
`,this},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,".convertInputToLinearSpace = ").concat(this.convertInputToLinearSpace,`;\r
`),e},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.convertInputToLinearSpace=this.convertInputToLinearSpace,e},r.prototype._deserialize=function(e,t,i){var a;n.prototype._deserialize.call(this,e,t,i),this.convertInputToLinearSpace=(a=e.convertInputToLinearSpace)!==null&&a!==void 0?a:!0},h([H("Convert input to linear space",z.Boolean,"ADVANCED")],r.prototype,"convertInputToLinearSpace",void 0),r}(F);P("BABYLON.ImageProcessingBlock",hn);var pt=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment,!0)||this;return t.registerInput("normal",f.Vector4,!1),t.normal.acceptedConnectionPointTypes.push(f.Vector3),t.registerInput("tangent",f.Vector4,!1),t.registerInput("world",f.Matrix,!1),t.registerOutput("TBN",f.Object,_.Fragment,new ce("TBN",t,ee.Output,r,"TBNBlock")),t.registerOutput("row0",f.Vector3,_.Fragment),t.registerOutput("row1",f.Vector3,_.Fragment),t.registerOutput("row2",f.Vector3,_.Fragment),t}return r.prototype.getClassName=function(){return"TBNBlock"},r.prototype.initialize=function(e){e._excludeVariableName("tbnNormal"),e._excludeVariableName("tbnTangent"),e._excludeVariableName("tbnBitangent"),e._excludeVariableName("TBN")},Object.defineProperty(r.prototype,"normal",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"tangent",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"world",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"TBN",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"row0",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"row1",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"row2",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"target",{get:function(){return _.Fragment},set:function(e){},enumerable:!1,configurable:!0}),r.prototype.autoConfigure=function(e){if(!this.world.isConnected){var t=e.getInputBlockByPredicate(function(o){return o.isSystemValue&&o.systemValue===V.World});t||(t=new B("world"),t.setAsSystemValue(V.World)),t.output.connectTo(this.world)}if(!this.normal.isConnected){var i=e.getInputBlockByPredicate(function(o){return o.isAttribute&&o.name==="normal"});i||(i=new B("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){var a=e.getInputBlockByPredicate(function(o){return o.isAttribute&&o.name==="tangent"&&o.type===f.Vector4});a||(a=new B("tangent"),a.setAsAttribute("tangent")),a.output.connectTo(this.tangent)}},r.prototype.prepareDefines=function(e,t,i){var a,o,s,u,l=this.normal,c=this.tangent,p=l.isConnected;((a=l.connectInputBlock)===null||a===void 0?void 0:a.isAttribute)&&!e.isVerticesDataPresent((o=l.connectInputBlock)===null||o===void 0?void 0:o.name)&&(p=!1);var d=c.isConnected;((s=c.connectInputBlock)===null||s===void 0?void 0:s.isAttribute)&&!e.isVerticesDataPresent((u=c.connectInputBlock)===null||u===void 0?void 0:u.name)&&(d=!1);var g=p&&d;i.setValue("TBNBLOCK",g,!0)},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this.normal,i=this.tangent,a=this.world,o=this.TBN,s=this.row0,u=this.row1,l=this.row2;return e.target===_.Fragment&&(e.compilationString+=`
                // `.concat(this.name,`
                vec3 tbnNormal = normalize(`).concat(t.associatedVariableName,`).xyz;
                vec3 tbnTangent = normalize(`).concat(i.associatedVariableName,`.xyz);
                vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * `).concat(i.associatedVariableName,`.w;
                mat3 `).concat(o.associatedVariableName," = mat3(").concat(a.associatedVariableName,`) * mat3(tbnTangent, tbnBitangent, tbnNormal);
            `),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+" = vec3(".concat(o.associatedVariableName,"[0][0], ").concat(o.associatedVariableName,"[0][1], ").concat(o.associatedVariableName,`[0][2]);\r
`)),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+" = vec3(".concat(o.associatedVariableName,"[1[0], ").concat(o.associatedVariableName,"[1][1], ").concat(o.associatedVariableName,`[1][2]);\r
`)),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+" = vec3(".concat(o.associatedVariableName,"[2][0], ").concat(o.associatedVariableName,"[2][1], ").concat(o.associatedVariableName,`[2][2]);\r
`)),e.sharedData.blocksWithDefines.push(this)),this},r}(F);P("BABYLON.TBNBlock",pt);var dn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t._tangentSpaceParameterName="",t.invertX=!1,t.invertY=!1,t.useParallaxOcclusion=!1,t._isUnique=!0,t.registerInput("worldPosition",f.Vector4,!1),t.registerInput("worldNormal",f.Vector4,!1),t.registerInput("worldTangent",f.Vector4,!0),t.registerInput("uv",f.Vector2,!1),t.registerInput("normalMapColor",f.Color3,!1),t.registerInput("strength",f.Float,!1),t.registerInput("viewDirection",f.Vector3,!0),t.registerInput("parallaxScale",f.Float,!0),t.registerInput("parallaxHeight",f.Float,!0),t.registerInput("TBN",f.Object,!0,_.VertexAndFragment,new ce("TBN",t,ee.Input,pt,"TBNBlock")),t.registerOutput("output",f.Vector4),t.registerOutput("uvOffset",f.Vector2),t}return r.prototype.getClassName=function(){return"PerturbNormalBlock"},Object.defineProperty(r.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"worldNormal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"worldTangent",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"uv",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"normalMapColor",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"strength",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"viewDirection",{get:function(){return this._inputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"parallaxScale",{get:function(){return this._inputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"parallaxHeight",{get:function(){return this._inputs[8]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"TBN",{get:function(){return this._inputs[9]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"uvOffset",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),r.prototype.prepareDefines=function(e,t,i){var a=this.normalMapColor.connectedPoint._ownerBlock.samplerName,o=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&a||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected);i.setValue("BUMP",!0),i.setValue("PARALLAX",o,!0),i.setValue("PARALLAXOCCLUSION",this.useParallaxOcclusion,!0)},r.prototype.bind=function(e,t){t.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1)},r.prototype.autoConfigure=function(e){if(!this.uv.isConnected){var t=e.getInputBlockByPredicate(function(a){return a.isAttribute&&a.name==="uv"});t||(t=new B("uv"),t.setAsAttribute()),t.output.connectTo(this.uv)}if(!this.strength.isConnected){var i=new B("strength");i.value=1,i.output.connectTo(this.strength)}},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t="//".concat(this.name),i=this.uv,a=this.worldPosition,o=this.worldNormal,s=this.worldTangent;e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,"vec2");var u=this.normalMapColor.connectedPoint._ownerBlock.samplerName,l=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&u||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected),c=this.parallaxScale.isConnectedToInputBlock?this.parallaxScale.connectInputBlock.isConstant?e._emitFloat(this.parallaxScale.connectInputBlock.value):this.parallaxScale.associatedVariableName:"0.05",p=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?`\r
#if !defined(NORMALXYSCALE)\r
1.0/\r
#endif\r
`.concat(e._emitFloat(this.strength.connectInputBlock.value)):`\r
#if !defined(NORMALXYSCALE)\r
1.0/\r
#endif\r
`.concat(this.strength.associatedVariableName);e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");var d={search:/defined\(TANGENT\)/g,replace:s.isConnected?"defined(TANGENT)":"defined(IGNORE)"},g={search:/varying mat3 vTBN/g,replace:""},m=this.TBN;m.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            mat3 vTBN = `.concat(m.associatedVariableName,`;
            #endif
            `):s.isConnected&&(e.compilationString+="vec3 tbnNormal = normalize(".concat(o.associatedVariableName,`.xyz);\r
`),e.compilationString+="vec3 tbnTangent = normalize(".concat(s.associatedVariableName,`.xyz);\r
`),e.compilationString+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent);\r
`,e.compilationString+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",t,{replaceStrings:[d,g]}),e._emitFunctionFromInclude("bumpFragmentFunctions",t,{replaceStrings:[{search:/#include<samplerFragmentDeclaration>\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\)/g,replace:""},{search:/uniform sampler2D bumpSampler;/g,replace:""},{search:/vec2 parallaxOcclusion\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\)/g,replace:`#define inline\r
vec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)`},{search:/vec2 parallaxOffset\(vec3 viewDir,float heightScale\)/g,replace:"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)"},{search:/texture2D\(bumpSampler,vBumpUV\)\.w/g,replace:"height_"}]});var y=!l||!u?this.normalMapColor.associatedVariableName:"texture2D(".concat(u,", ").concat(i.associatedVariableName," + uvOffset).xyz");return e.compilationString+=this._declareOutput(this.output,e)+` = vec4(0.);\r
`,e.compilationString+=e._emitCodeFromInclude("bumpFragment",t,{replaceStrings:[{search:/perturbNormal\(TBN,texture2D\(bumpSampler,vBumpUV\+uvOffset\).xyz,vBumpInfos.y\)/g,replace:"perturbNormal(TBN, ".concat(y,", vBumpInfos.y)")},{search:/parallaxOcclusion\(invTBN\*-viewDirectionW,invTBN\*normalW,vBumpUV,vBumpInfos.z\)/g,replace:"parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ".concat(l&&this.useParallaxOcclusion?u:"bumpSampler",")")},{search:/parallaxOffset\(invTBN\*viewDirectionW,vBumpInfos\.z\)/g,replace:"parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ".concat(l?this.parallaxHeight.associatedVariableName:"0.",")")},{search:/vTangentSpaceParams/g,replace:this._tangentSpaceParameterName},{search:/vBumpInfos.y/g,replace:p},{search:/vBumpInfos.z/g,replace:c},{search:/vBumpUV/g,replace:i.associatedVariableName},{search:/vPositionW/g,replace:a.associatedVariableName+".xyz"},{search:/normalW=/g,replace:this.output.associatedVariableName+".xyz = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:"mat3(normalMatrix) * "+this.output.associatedVariableName+".xyz"},{search:/normalW/g,replace:o.associatedVariableName+".xyz"},{search:/viewDirectionW/g,replace:l?this.viewDirection.associatedVariableName:"vec3(0.)"},d]}),this},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this)+"".concat(this._codeVariableName,".invertX = ").concat(this.invertX,`;\r
`);return e+="".concat(this._codeVariableName,".invertY = ").concat(this.invertY,`;\r
`),e+="".concat(this._codeVariableName,".useParallaxOcclusion = ").concat(this.useParallaxOcclusion,`;\r
`),e},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.invertX=this.invertX,e.invertY=this.invertY,e.useParallaxOcclusion=this.useParallaxOcclusion,e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),this.invertX=e.invertX,this.invertY=e.invertY,this.useParallaxOcclusion=!!e.useParallaxOcclusion},h([H("Invert X axis",z.Boolean,"PROPERTIES",{notifiers:{update:!1}})],r.prototype,"invertX",void 0),h([H("Invert Y axis",z.Boolean,"PROPERTIES",{notifiers:{update:!1}})],r.prototype,"invertY",void 0),h([H("Use parallax occlusion",z.Boolean)],r.prototype,"useParallaxOcclusion",void 0),r}(F);P("BABYLON.PerturbNormalBlock",dn);var _n=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment,!0)||this;return t.registerInput("value",f.Float,!0),t.registerInput("cutoff",f.Float,!0),t}return r.prototype.getClassName=function(){return"DiscardBlock"},Object.defineProperty(r.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cutoff",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.sharedData.hints.needAlphaTesting=!0,!(!this.cutoff.isConnected||!this.value.isConnected))return e.compilationString+="if (".concat(this.value.associatedVariableName," < ").concat(this.cutoff.associatedVariableName,`) discard;\r
`),this},r}(F);P("BABYLON.DiscardBlock",_n);var mn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t.registerOutput("output",f.Float,_.Fragment),t}return r.prototype.getClassName=function(){return"FrontFacingBlock"},Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target===_.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = gl_FrontFacing ? 1.0 : 0.0;\r
`,this},r}(F);P("BABYLON.FrontFacingBlock",mn);var gn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t.registerInput("input",f.AutoDetect,!1),t.registerOutput("dx",f.BasedOnInput),t.registerOutput("dy",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._outputs[1]._typeConnectionSource=t._inputs[0],t}return r.prototype.getClassName=function(){return"DerivativeBlock"},Object.defineProperty(r.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"dx",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"dy",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this._outputs[1];return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),t.hasEndpoints&&(e.compilationString+=this._declareOutput(t,e)+" = dFdx(".concat(this.input.associatedVariableName,`);\r
`)),i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+" = dFdy(".concat(this.input.associatedVariableName,`);\r
`)),this},r}(F);P("BABYLON.DerivativeBlock",gn);var vn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t.registerOutput("xy",f.Vector2,_.Fragment),t.registerOutput("xyz",f.Vector3,_.Fragment),t.registerOutput("xyzw",f.Vector4,_.Fragment),t.registerOutput("x",f.Float,_.Fragment),t.registerOutput("y",f.Float,_.Fragment),t.registerOutput("z",f.Float,_.Fragment),t.registerOutput("w",f.Float,_.Fragment),t}return r.prototype.getClassName=function(){return"FragCoordBlock"},Object.defineProperty(r.prototype,"xy",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"xyz",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"xyzw",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"x",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"z",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[6]},enumerable:!1,configurable:!0}),r.prototype.writeOutputs=function(e){for(var t="",i=0,a=this._outputs;i<a.length;i++){var o=a[i];o.hasEndpoints&&(t+="".concat(this._declareOutput(o,e)," = gl_FragCoord.").concat(o.name,`;\r
`))}return t},r.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target===_.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return e.compilationString+=this.writeOutputs(e),this},r}(F);P("BABYLON.FragCoordBlock",vn);var bn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t.registerOutput("xy",f.Vector2,_.Fragment),t.registerOutput("x",f.Float,_.Fragment),t.registerOutput("y",f.Float,_.Fragment),t}return r.prototype.getClassName=function(){return"ScreenSizeBlock"},Object.defineProperty(r.prototype,"xy",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"x",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),r.prototype.bind=function(e){var t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())},r.prototype.writeOutputs=function(e,t){for(var i="",a=0,o=this._outputs;a<o.length;a++){var s=o[a];s.hasEndpoints&&(i+="".concat(this._declareOutput(s,e)," = ").concat(t,".").concat(s.name,`;\r
`))}return i},r.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),this._scene=e.sharedData.scene,e.target===_.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";return e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,"vec2"),e.compilationString+=this.writeOutputs(e,this._varName),this},r}(F);P("BABYLON.ScreenSizeBlock",bn);var yn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t.registerInput("vector",f.Vector3),t.registerInput("worldViewProjection",f.Matrix),t.registerOutput("output",f.Vector2),t.registerOutput("x",f.Float),t.registerOutput("y",f.Float),t.inputs[0].acceptedConnectionPointTypes.push(f.Vector4),t}return r.prototype.getClassName=function(){return"ScreenSpaceBlock"},Object.defineProperty(r.prototype,"vector",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"worldViewProjection",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"x",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),r.prototype.autoConfigure=function(e){if(!this.worldViewProjection.isConnected){var t=e.getInputBlockByPredicate(function(i){return i.systemValue===V.WorldViewProjection});t||(t=new B("worldViewProjection"),t.setAsSystemValue(V.WorldViewProjection)),t.output.connectTo(this.worldViewProjection)}},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this.vector,i=this.worldViewProjection;if(!!t.connectedPoint){var a=i.associatedVariableName,o=e._getFreeVariableName("screenSpaceTemp");switch(t.connectedPoint.type){case f.Vector3:e.compilationString+="vec4 ".concat(o," = ").concat(a," * vec4(").concat(t.associatedVariableName,`, 1.0);\r
`);break;case f.Vector4:e.compilationString+="vec4 ".concat(o," = ").concat(a," * ").concat(t.associatedVariableName,`;\r
`);break}return e.compilationString+="".concat(o,".xy /= ").concat(o,".w;"),e.compilationString+="".concat(o,".xy = ").concat(o,".xy * 0.5 + vec2(0.5, 0.5);"),this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+" = ".concat(o,`.xy;\r
`)),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+" = ".concat(o,`.x;\r
`)),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+" = ".concat(o,`.y;\r
`)),this}},r}(F);P("BABYLON.ScreenSpaceBlock",yn);var Tn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t.registerInput("input",f.Vector2),t.registerInput("strength",f.Float),t.registerInput("center",f.Vector2),t.registerInput("offset",f.Vector2),t.registerOutput("output",f.Vector2),t.registerOutput("x",f.Float),t.registerOutput("y",f.Float),t}return r.prototype.getClassName=function(){return"TwirlBlock"},Object.defineProperty(r.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"strength",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"center",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"offset",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"x",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),r.prototype.autoConfigure=function(){if(!this.center.isConnected){var e=new B("center");e.value=new Te(.5,.5),e.output.connectTo(this.center)}if(!this.strength.isConnected){var t=new B("strength");t.value=1,t.output.connectTo(this.strength)}if(!this.offset.isConnected){var i=new B("offset");i.value=new Te(0,0),i.output.connectTo(this.offset)}},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=e._getFreeVariableName("delta"),i=e._getFreeVariableName("angle"),a=e._getFreeVariableName("x"),o=e._getFreeVariableName("y"),s=e._getFreeVariableName("result");return e.compilationString+=`
            vec2 `.concat(t," = ").concat(this.input.associatedVariableName," - ").concat(this.center.associatedVariableName,`;
            float `).concat(i," = ").concat(this.strength.associatedVariableName," * length(").concat(t,`);
            float `).concat(a," = cos(").concat(i,") * ").concat(t,".x - sin(").concat(i,") * ").concat(t,`.y;
            float `).concat(o," = sin(").concat(i,") * ").concat(t,".x + cos(").concat(i,") * ").concat(t,`.y;
            vec2 `).concat(s," = vec2(").concat(a," + ").concat(this.center.associatedVariableName,".x + ").concat(this.offset.associatedVariableName,".x, ").concat(o," + ").concat(this.center.associatedVariableName,".y + ").concat(this.offset.associatedVariableName,`.y);
        `),this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+" = ".concat(s,`;\r
`)),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+" = ".concat(s,`.x;\r
`)),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+" = ".concat(s,`.y;\r
`)),this},r}(F);P("BABYLON.TwirlBlock",Tn);var Sn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t.registerInput("input",f.Float),t.registerInput("position",f.Vector3),t.registerInput("normal",f.Vector3),t.registerInput("tangent",f.Vector3),t.registerOutput("output",f.Vector3),t._inputs[3].acceptedConnectionPointTypes.push(f.Vector4),t}return r.prototype.getClassName=function(){return"HeightToNormalBlock"},Object.defineProperty(r.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"position",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"normal",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"tangent",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=`
        vec3 heightToNormal(in float height, in vec3 position, in vec3 tangent, in vec3 normal) {
            vec3 biTangent = cross(tangent, normal);
            mat3 TBN = mat3(tangent, biTangent, normal);
            vec3 worlddX = dFdx(position * 100.0);
            vec3 worlddY = dFdy(position * 100.0);
            vec3 crossX = cross(normal, worlddX);
            vec3 crossY = cross(normal, worlddY);
            float d = abs(dot(crossY, worlddX));
            vec3 inToNormal = vec3(((((height + dFdx(height)) - height) * crossY) + (((height + dFdy(height)) - height) * crossX)) * sign(d));
            inToNormal.y *= -1.0;
            vec3 result = normalize((d * normal) - inToNormal);
            return TBN * result;
        }`;return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitFunction("heightToNormal",i,"// heightToNormal"),e.compilationString+=this._declareOutput(t,e)+" = heightToNormal(".concat(this.input.associatedVariableName,", ").concat(this.position.associatedVariableName,", ").concat(this.tangent.associatedVariableName,".xyz, ").concat(this.normal.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.HeightToNormalBlock",Sn);var En=function(n){A(r,n);function r(e){var t=n.call(this,e,_.VertexAndFragment,!1)||this;return t.registerInput("worldPosition",f.Vector4,!1,_.Vertex),t.registerInput("view",f.Matrix,!1,_.Vertex),t.registerInput("input",f.Color3,!1,_.Fragment),t.registerInput("fogColor",f.Color3,!1,_.Fragment),t.registerOutput("output",f.Color3,_.Fragment),t.input.acceptedConnectionPointTypes.push(f.Color4),t.fogColor.acceptedConnectionPointTypes.push(f.Color4),t}return r.prototype.getClassName=function(){return"FogBlock"},Object.defineProperty(r.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"view",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"input",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"fogColor",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype.autoConfigure=function(e){if(!this.view.isConnected){var t=e.getInputBlockByPredicate(function(a){return a.systemValue===V.View});t||(t=new B("view"),t.setAsSystemValue(V.View)),t.output.connectTo(this.view)}if(!this.fogColor.isConnected){var i=e.getInputBlockByPredicate(function(a){return a.systemValue===V.FogColor});i||(i=new B("fogColor",void 0,f.Color3),i.setAsSystemValue(V.FogColor)),i.output.connectTo(this.fogColor)}},r.prototype.prepareDefines=function(e,t,i){var a=e.getScene();i.setValue("FOG",t.fogEnabled&&C.GetFogState(e,a))},r.prototype.bind=function(e,t,i){if(!!i){var a=i.getScene();e.setFloat4(this._fogParameters,a.fogMode,a.fogStart,a.fogEnd,a.fogDensity)}},r.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target===_.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e._emitFunctionFromInclude("fogFragmentDeclaration","//".concat(this.name),{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}]});var t=e._getFreeVariableName("fog"),i=this.input,a=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");var o=this._outputs[0];e._emitUniformFromString(this._fogParameters,"vec4"),e.compilationString+=`#ifdef FOG\r
`,e.compilationString+="float ".concat(t," = CalcFogFactor(").concat(this._fogDistanceName,", ").concat(this._fogParameters,`);\r
`),e.compilationString+=this._declareOutput(o,e)+" = ".concat(t," * ").concat(i.associatedVariableName,".rgb + (1.0 - ").concat(t,") * ").concat(a.associatedVariableName,`.rgb;\r
`),e.compilationString+=`#else\r
`.concat(this._declareOutput(o,e)," =  ").concat(i.associatedVariableName,`.rgb;\r
`),e.compilationString+=`#endif\r
`}else{var s=this.worldPosition,u=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,"vec3"),e.compilationString+="".concat(this._fogDistanceName," = (").concat(u.associatedVariableName," * ").concat(s.associatedVariableName,`).xyz;\r
`)}return this},r}(F);P("BABYLON.FogBlock",En);var An=function(n){A(r,n);function r(e){var t=n.call(this,e,_.VertexAndFragment)||this;return t._isUnique=!0,t.registerInput("worldPosition",f.Vector4,!1,_.Vertex),t.registerInput("worldNormal",f.Vector4,!1,_.Fragment),t.registerInput("cameraPosition",f.Vector3,!1,_.Fragment),t.registerInput("glossiness",f.Float,!0,_.Fragment),t.registerInput("glossPower",f.Float,!0,_.Fragment),t.registerInput("diffuseColor",f.Color3,!0,_.Fragment),t.registerInput("specularColor",f.Color3,!0,_.Fragment),t.registerInput("view",f.Matrix,!0),t.registerOutput("diffuseOutput",f.Color3,_.Fragment),t.registerOutput("specularOutput",f.Color3,_.Fragment),t.registerOutput("shadow",f.Float,_.Fragment),t}return r.prototype.getClassName=function(){return"LightBlock"},Object.defineProperty(r.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"worldNormal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraPosition",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"glossiness",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"glossPower",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"diffuseColor",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"specularColor",{get:function(){return this._inputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"view",{get:function(){return this._inputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"diffuseOutput",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"specularOutput",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"shadow",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),r.prototype.autoConfigure=function(e){if(!this.cameraPosition.isConnected){var t=e.getInputBlockByPredicate(function(i){return i.systemValue===V.CameraPosition});t||(t=new B("cameraPosition"),t.setAsSystemValue(V.CameraPosition)),t.output.connectTo(this.cameraPosition)}},r.prototype.prepareDefines=function(e,t,i){if(!!i._areLightsDirty){var a=e.getScene();if(!this.light)C.PrepareDefinesForLights(a,e,i,!0,t.maxSimultaneousLights);else{var o={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};C.PrepareDefinesForLight(a,e,this.light,this._lightId,i,!0,o),o.needRebuild&&i.rebuild()}}},r.prototype.updateUniformsAndSamples=function(e,t,i,a){for(var o=0;o<t.maxSimultaneousLights&&i["LIGHT"+o];o++){var s=e.uniforms.indexOf("vLightData"+o)>=0;C.PrepareUniformsAndSamplersForLight(o,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+o],a,s)}},r.prototype.bind=function(e,t,i){if(!!i){var a=i.getScene();this.light?C.BindLight(this.light,this._lightId,a,e,!0):C.BindLights(a,i,e,!0,t.maxSimultaneousLights)}},r.prototype._injectVertexCode=function(e){var t=this.worldPosition,i="//".concat(this.name);this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));var a="v_"+t.associatedVariableName;e._emitVaryingFromString(a,"vec4")&&(e.compilationString+="".concat(a," = ").concat(t.associatedVariableName,`;\r
`)),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+="vec4 worldPos = ".concat(t.associatedVariableName,`;\r
`),this.view.isConnected&&(e.compilationString+="mat4 view = ".concat(this.view.associatedVariableName,`;\r
`)),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights"}))},r.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),e.target!==_.Fragment){this._injectVertexCode(e);return}e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);var t="//".concat(this.name),i=this.worldPosition;e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("lightsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:"v_"+i.associatedVariableName+".xyz"}]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:"v_"+i.associatedVariableName+".xyz"}]}),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{repeatKey:"maxSimultaneousLights"}),this._lightId===0&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+="vec3 viewDirectionW = normalize(".concat(this.cameraPosition.associatedVariableName," - ").concat("v_"+i.associatedVariableName,`.xyz);\r
`)),e.compilationString+=`lightingInfo info;\r
`,e.compilationString+=`float shadow = 1.;\r
`,e.compilationString+="float glossiness = ".concat(this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0"," * ").concat(this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0",`;\r
`),e.compilationString+=`vec3 diffuseBase = vec3(0., 0., 0.);\r
`,e.compilationString+=`vec3 specularBase = vec3(0., 0., 0.);\r
`,e.compilationString+="vec3 normalW = ".concat(this.worldNormal.associatedVariableName,`.xyz;\r
`)),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",t,{repeatKey:"maxSimultaneousLights"});var a=this.diffuseOutput,o=this.specularOutput;return e.compilationString+=this._declareOutput(a,e)+" = diffuseBase".concat(this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:"",`;\r
`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+" = specularBase".concat(this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:"",`;\r
`)),this.shadow.hasEndpoints&&(e.compilationString+=this._declareOutput(this.shadow,e)+` = shadow;\r
`),this},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return this.light&&(e.lightId=this.light.id),e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))},r}(F);P("BABYLON.LightBlock",An);var Or=function(n){A(r,n);function r(e){var t=n.call(this,e,_.VertexAndFragment)||this;return t.registerOutput("source",f.Object,_.VertexAndFragment,new ce("source",t,ee.Output,r,"ImageSourceBlock")),t}return Object.defineProperty(r.prototype,"texture",{get:function(){return this._texture},set:function(e){var t=this,i;if(this._texture!==e){var a=(i=e==null?void 0:e.getScene())!==null&&i!==void 0?i:de.LastCreatedScene;!e&&a&&a.markAllMaterialsAsDirty(1,function(o){return o.hasTexture(t._texture)}),this._texture=e,e&&a&&a.markAllMaterialsAsDirty(1,function(o){return o.hasTexture(e)})}},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"samplerName",{get:function(){return this._samplerName},enumerable:!1,configurable:!0}),r.prototype.bind=function(e){!this.texture||e.setTexture(this._samplerName,this.texture)},r.prototype.isReady=function(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())},r.prototype.getClassName=function(){return"ImageSourceBlock"},Object.defineProperty(r.prototype,"source",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){return n.prototype._buildBlock.call(this,e),e.target===_.Vertex&&(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this)),e._emit2DSampler(this._samplerName),this},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return this.texture&&(e+="".concat(this._codeVariableName,'.texture = new BABYLON.Texture("').concat(this.texture.name,'", null, ').concat(this.texture.noMipmap,", ").concat(this.texture.invertY,", ").concat(this.texture.samplingMode,`);\r
`),e+="".concat(this._codeVariableName,".texture.wrapU = ").concat(this.texture.wrapU,`;\r
`),e+="".concat(this._codeVariableName,".texture.wrapV = ").concat(this.texture.wrapV,`;\r
`),e+="".concat(this._codeVariableName,".texture.uAng = ").concat(this.texture.uAng,`;\r
`),e+="".concat(this._codeVariableName,".texture.vAng = ").concat(this.texture.vAng,`;\r
`),e+="".concat(this._codeVariableName,".texture.wAng = ").concat(this.texture.wAng,`;\r
`),e+="".concat(this._codeVariableName,".texture.uOffset = ").concat(this.texture.uOffset,`;\r
`),e+="".concat(this._codeVariableName,".texture.vOffset = ").concat(this.texture.vOffset,`;\r
`),e+="".concat(this._codeVariableName,".texture.uScale = ").concat(this.texture.uScale,`;\r
`),e+="".concat(this._codeVariableName,".texture.vScale = ").concat(this.texture.vScale,`;\r
`),e+="".concat(this._codeVariableName,".texture.coordinatesMode = ").concat(this.texture.coordinatesMode,`;\r
`)),e},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return this.texture&&!this.texture.isRenderTarget&&this.texture.getClassName()!=="VideoTexture"&&(e.texture=this.texture.serialize()),e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),e.texture&&!Kt.IgnoreTexturesAtLoadTime&&e.texture.url!==void 0&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=I.Parse(e.texture,t,i))},r}(F);P("BABYLON.ImageSourceBlock",Or);var Cn=function(n){A(r,n);function r(e,t){t===void 0&&(t=!1);var i=n.call(this,e,t?_.Fragment:_.VertexAndFragment)||this;return i._convertToGammaSpace=!1,i._convertToLinearSpace=!1,i.disableLevelMultiplication=!1,i._fragmentOnly=t,i.registerInput("uv",f.Vector2,!1,_.VertexAndFragment),i.registerInput("source",f.Object,!0,_.VertexAndFragment,new ce("source",i,ee.Input,Or,"ImageSourceBlock")),i.registerOutput("rgba",f.Color4,_.Neutral),i.registerOutput("rgb",f.Color3,_.Neutral),i.registerOutput("r",f.Float,_.Neutral),i.registerOutput("g",f.Float,_.Neutral),i.registerOutput("b",f.Float,_.Neutral),i.registerOutput("a",f.Float,_.Neutral),i.registerOutput("level",f.Float,_.Neutral),i._inputs[0].acceptedConnectionPointTypes.push(f.Vector3),i._inputs[0].acceptedConnectionPointTypes.push(f.Vector4),i._inputs[0]._prioritizeVertex=!t,i}return Object.defineProperty(r.prototype,"texture",{get:function(){var e;return this.source.isConnected?((e=this.source.connectedPoint)===null||e===void 0?void 0:e.ownerBlock).texture:this._texture},set:function(e){var t=this,i;if(this._texture!==e){var a=(i=e==null?void 0:e.getScene())!==null&&i!==void 0?i:de.LastCreatedScene;!e&&a&&a.markAllMaterialsAsDirty(1,function(o){return o.hasTexture(t._texture)}),this._texture=e,e&&a&&a.markAllMaterialsAsDirty(1,function(o){return o.hasTexture(e)})}},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"samplerName",{get:function(){return this._imageSource?this._imageSource.samplerName:this._samplerName},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasImageSource",{get:function(){return!!this._imageSource},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"convertToGammaSpace",{get:function(){return this._convertToGammaSpace},set:function(e){var t=this,i;if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){var a=(i=this.texture.getScene())!==null&&i!==void 0?i:de.LastCreatedScene;a==null||a.markAllMaterialsAsDirty(1,function(o){return o.hasTexture(t.texture)})}},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"convertToLinearSpace",{get:function(){return this._convertToLinearSpace},set:function(e){var t=this,i;if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){var a=(i=this.texture.getScene())!==null&&i!==void 0?i:de.LastCreatedScene;a==null||a.markAllMaterialsAsDirty(1,function(o){return o.hasTexture(t.texture)})}},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"TextureBlock"},Object.defineProperty(r.prototype,"uv",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"source",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rgba",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rgb",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"r",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"g",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"b",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"a",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"level",{get:function(){return this._outputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"target",{get:function(){if(this._fragmentOnly)return _.Fragment;if(!this.uv.isConnected||this.uv.sourceBlock.isInput)return _.VertexAndFragment;for(var e=this.uv.connectedPoint;e;){if(e.target===_.Fragment)return _.Fragment;if(e.target===_.Vertex)return _.VertexAndFragment;if(e.target===_.Neutral||e.target===_.VertexAndFragment){var t=e.ownerBlock;if(t.target===_.Fragment)return _.Fragment;e=null;for(var i=0,a=t.inputs;i<a.length;i++){var o=a[i];if(o.connectedPoint){e=o.connectedPoint;break}}}}return _.VertexAndFragment},set:function(e){},enumerable:!1,configurable:!0}),r.prototype.autoConfigure=function(e){if(!this.uv.isConnected)if(e.mode===me.PostProcess){var t=e.getBlockByPredicate(function(a){return a.name==="uv"});t&&t.connectTo(this)}else{var i=e.mode===me.Particle?"particle_uv":"uv",t=e.getInputBlockByPredicate(function(o){return o.isAttribute&&o.name===i});t||(t=new B("uv"),t.setAsAttribute(i)),t.output.connectTo(this.uv)}},r.prototype.initializeDefines=function(e,t,i){!i._areTexturesDirty||this._mainUVDefineName!==void 0&&i.setValue(this._mainUVDefineName,!1,!0)},r.prototype.prepareDefines=function(e,t,i){if(!!i._areTexturesDirty){if(!this.texture||!this.texture.getTextureMatrix){this._isMixed&&(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0));return}var a=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,o=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,a,!0),i.setValue(this._gammaDefineName,o,!0),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)):(i.setValue(this._defineName,!0),i[this._mainUVDefineName]==null&&i.setValue(this._mainUVDefineName,!1,!0)))}},r.prototype.isReady=function(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())},r.prototype.bind=function(e){!this.texture||(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),this._imageSource||e.setTexture(this._samplerName,this.texture))},Object.defineProperty(r.prototype,"_isMixed",{get:function(){return this.target!==_.Fragment},enumerable:!1,configurable:!0}),r.prototype._injectVertexCode=function(e){var t=this.uv;if(this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+t.associatedVariableName.toUpperCase(),this._mainUVName="vMain"+t.associatedVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,e._emitVaryingFromString(this._transformedUVName,"vec2",this._defineName),e._emitVaryingFromString(this._mainUVName,"vec2",this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,"mat4",this._defineName),e.compilationString+="#ifdef ".concat(this._defineName,`\r
`),e.compilationString+="".concat(this._transformedUVName," = vec2(").concat(this._textureTransformName," * vec4(").concat(t.associatedVariableName,`.xy, 1.0, 0.0));\r
`),e.compilationString+="#elif defined(".concat(this._mainUVDefineName,`)\r
`),e.compilationString+="".concat(this._mainUVName," = ").concat(t.associatedVariableName,`.xy;\r
`),e.compilationString+=`#endif\r
`,!!this._outputs.some(function(s){return s.isConnectedInVertexShader})){this._writeTextureRead(e,!0);for(var i=0,a=this._outputs;i<a.length;i++){var o=a[i];o.hasEndpoints&&o.name!=="level"&&this._writeOutput(e,o,o.name,!0)}}},r.prototype._generateTextureLookup=function(e){var t=this.samplerName;e.compilationString+="#ifdef ".concat(this._defineName,`\r
`),e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(t,", ").concat(this._transformedUVName,`);\r
`),e.compilationString+="#elif defined(".concat(this._mainUVDefineName,`)\r
`),e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(t,", ").concat(this._mainUVName?this._mainUVName:this.uv.associatedVariableName,`);\r
`),e.compilationString+=`#endif\r
`},r.prototype._writeTextureRead=function(e,t){t===void 0&&(t=!1);var i=this.uv;if(t){if(e.target===_.Fragment)return;this._generateTextureLookup(e);return}if(this.uv.ownerBlock.target===_.Fragment){e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(this.samplerName,", ").concat(i.associatedVariableName,`);\r
`);return}this._generateTextureLookup(e)},r.prototype._generateConversionCode=function(e,t,i){i!=="a"&&((!this.texture||!this.texture.gammaSpace)&&(e.compilationString+="#ifdef ".concat(this._linearDefineName,`
                    `).concat(t.associatedVariableName," = toGammaSpace(").concat(t.associatedVariableName,`);
                    #endif
                `)),e.compilationString+="#ifdef ".concat(this._gammaDefineName,`
                `).concat(t.associatedVariableName," = toLinearSpace(").concat(t.associatedVariableName,`);
                #endif
            `))},r.prototype._writeOutput=function(e,t,i,a){if(a===void 0&&(a=!1),a){if(e.target===_.Fragment)return;e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`),this._generateConversionCode(e,t,i);return}if(this.uv.ownerBlock.target===_.Fragment){e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`),this._generateConversionCode(e,t,i);return}var o="";this.disableLevelMultiplication||(o=" * ".concat(this._textureInfoName)),e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i).concat(o,`;\r
`),this._generateConversionCode(e,t,i)},r.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,(e.target===_.Vertex||this._fragmentOnly||e.target===_.Fragment&&this._tempTextureRead===void 0)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),(!this._isMixed&&e.target===_.Fragment||this._isMixed&&e.target===_.Vertex)&&(this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)),e.target!==_.Fragment){this._injectVertexCode(e);return}if(!!this._outputs.some(function(s){return s.isConnectedInFragmentShader})){this._isMixed&&!this._imageSource&&e._emit2DSampler(this._samplerName);var t="//".concat(this.name);e._emitFunctionFromInclude("helperFunctions",t),this._isMixed&&e._emitUniformFromString(this._textureInfoName,"float"),this._writeTextureRead(e);for(var i=0,a=this._outputs;i<a.length;i++){var o=a[i];o.hasEndpoints&&o.name!=="level"&&this._writeOutput(e,o,o.name)}return this}},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,".convertToGammaSpace = ").concat(this.convertToGammaSpace,`;\r
`),e+="".concat(this._codeVariableName,".convertToLinearSpace = ").concat(this.convertToLinearSpace,`;\r
`),e+="".concat(this._codeVariableName,".disableLevelMultiplication = ").concat(this.disableLevelMultiplication,`;\r
`),this.texture&&(e+="".concat(this._codeVariableName,'.texture = new BABYLON.Texture("').concat(this.texture.name,'", null, ').concat(this.texture.noMipmap,", ").concat(this.texture.invertY,", ").concat(this.texture.samplingMode,`);\r
`),e+="".concat(this._codeVariableName,".texture.wrapU = ").concat(this.texture.wrapU,`;\r
`),e+="".concat(this._codeVariableName,".texture.wrapV = ").concat(this.texture.wrapV,`;\r
`),e+="".concat(this._codeVariableName,".texture.uAng = ").concat(this.texture.uAng,`;\r
`),e+="".concat(this._codeVariableName,".texture.vAng = ").concat(this.texture.vAng,`;\r
`),e+="".concat(this._codeVariableName,".texture.wAng = ").concat(this.texture.wAng,`;\r
`),e+="".concat(this._codeVariableName,".texture.uOffset = ").concat(this.texture.uOffset,`;\r
`),e+="".concat(this._codeVariableName,".texture.vOffset = ").concat(this.texture.vOffset,`;\r
`),e+="".concat(this._codeVariableName,".texture.uScale = ").concat(this.texture.uScale,`;\r
`),e+="".concat(this._codeVariableName,".texture.vScale = ").concat(this.texture.vScale,`;\r
`),e+="".concat(this._codeVariableName,".texture.coordinatesMode = ").concat(this.texture.coordinatesMode,`;\r
`)),e},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,e.disableLevelMultiplication=this.disableLevelMultiplication,!this.hasImageSource&&this.texture&&!this.texture.isRenderTarget&&this.texture.getClassName()!=="VideoTexture"&&(e.texture=this.texture.serialize()),e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!Kt.IgnoreTexturesAtLoadTime&&e.texture.url!==void 0&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=I.Parse(e.texture,t,i))},r}(F);P("BABYLON.TextureBlock",Cn);var qt=function(n){A(r,n);function r(e){return n.call(this,e,_.VertexAndFragment)||this}return Object.defineProperty(r.prototype,"texture",{get:function(){return this._texture},set:function(e){var t=this,i;if(this._texture!==e){var a=(i=e==null?void 0:e.getScene())!==null&&i!==void 0?i:de.LastCreatedScene;!e&&a&&a.markAllMaterialsAsDirty(1,function(o){return o.hasTexture(t._texture)}),this._texture=e,e&&a&&a.markAllMaterialsAsDirty(1,function(o){return o.hasTexture(e)})}},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"ReflectionTextureBaseBlock"},r.prototype._getTexture=function(){return this.texture},r.prototype.autoConfigure=function(e){if(!this.position.isConnected){var t=e.getInputBlockByPredicate(function(o){return o.isAttribute&&o.name==="position"});t||(t=new B("position"),t.setAsAttribute()),t.output.connectTo(this.position)}if(!this.world.isConnected){var i=e.getInputBlockByPredicate(function(o){return o.systemValue===V.World});i||(i=new B("world"),i.setAsSystemValue(V.World)),i.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){var a=e.getInputBlockByPredicate(function(o){return o.systemValue===V.View});a||(a=new B("view"),a.setAsSystemValue(V.View)),a.output.connectTo(this.view)}},r.prototype.prepareDefines=function(e,t,i){if(!!i._areTexturesDirty){var a=this._getTexture();!a||!a.getTextureMatrix||(i.setValue(this._define3DName,a.isCube,!0),i.setValue(this._defineLocalCubicName,!!a.boundingBoxSize,!0),i.setValue(this._defineExplicitName,a.coordinatesMode===0,!0),i.setValue(this._defineSkyboxName,a.coordinatesMode===5,!0),i.setValue(this._defineCubicName,a.coordinatesMode===3||a.coordinatesMode===6,!0),i.setValue("INVERTCUBICMAP",a.coordinatesMode===6,!0),i.setValue(this._defineSphericalName,a.coordinatesMode===1,!0),i.setValue(this._definePlanarName,a.coordinatesMode===2,!0),i.setValue(this._defineProjectionName,a.coordinatesMode===4,!0),i.setValue(this._defineEquirectangularName,a.coordinatesMode===7,!0),i.setValue(this._defineEquirectangularFixedName,a.coordinatesMode===8,!0),i.setValue(this._defineMirroredEquirectangularFixedName,a.coordinatesMode===9,!0))}},r.prototype.isReady=function(){var e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())},r.prototype.bind=function(e,t,i){var a=this._getTexture();if(!(!i||!a)&&(e.setMatrix(this._reflectionMatrixName,a.getReflectionTextureMatrix()),a.isCube?e.setTexture(this._cubeSamplerName,a):e.setTexture(this._2DSamplerName,a),a.boundingBoxSize)){var o=a;e.setVector3(this._reflectionPositionName,o.boundingBoxPosition),e.setVector3(this._reflectionSizeName,o.boundingBoxSize)}},r.prototype.handleVertexSide=function(e){this._define3DName=e._getFreeDefineName("REFLECTIONMAP_3D"),this._defineCubicName=e._getFreeDefineName("REFLECTIONMAP_CUBIC"),this._defineSphericalName=e._getFreeDefineName("REFLECTIONMAP_SPHERICAL"),this._definePlanarName=e._getFreeDefineName("REFLECTIONMAP_PLANAR"),this._defineProjectionName=e._getFreeDefineName("REFLECTIONMAP_PROJECTION"),this._defineExplicitName=e._getFreeDefineName("REFLECTIONMAP_EXPLICIT"),this._defineEquirectangularName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR"),this._defineLocalCubicName=e._getFreeDefineName("USE_LOCAL_REFLECTIONMAP_CUBIC"),this._defineMirroredEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this._defineEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this._defineSkyboxName=e._getFreeDefineName("REFLECTIONMAP_SKYBOX"),this._defineOppositeZ=e._getFreeDefineName("REFLECTIONMAP_OPPOSITEZ"),this._reflectionMatrixName=e._getFreeVariableName("reflectionMatrix"),e._emitUniformFromString(this._reflectionMatrixName,"mat4");var t="",i="v_"+this.worldPosition.associatedVariableName;return e._emitVaryingFromString(i,"vec4")&&(t+="".concat(i," = ").concat(this.worldPosition.associatedVariableName,`;\r
`)),this._positionUVWName=e._getFreeVariableName("positionUVW"),this._directionWName=e._getFreeVariableName("directionW"),e._emitVaryingFromString(this._positionUVWName,"vec3",this._defineSkyboxName)&&(t+="#ifdef ".concat(this._defineSkyboxName,`\r
`),t+="".concat(this._positionUVWName," = ").concat(this.position.associatedVariableName,`.xyz;\r
`),t+=`#endif\r
`),e._emitVaryingFromString(this._directionWName,"vec3","defined(".concat(this._defineEquirectangularFixedName,") || defined(").concat(this._defineMirroredEquirectangularFixedName,")"))&&(t+="#if defined(".concat(this._defineEquirectangularFixedName,") || defined(").concat(this._defineMirroredEquirectangularFixedName,`)\r
`),t+="".concat(this._directionWName," = normalize(vec3(").concat(this.world.associatedVariableName," * vec4(").concat(this.position.associatedVariableName,`.xyz, 0.0)));\r
`),t+=`#endif\r
`),t},r.prototype.handleFragmentSideInits=function(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),e._samplerDeclaration+="#ifdef ".concat(this._define3DName,`\r
`),e._samplerDeclaration+="uniform samplerCube ".concat(this._cubeSamplerName,`;\r
`),e._samplerDeclaration+=`#else\r
`,e._samplerDeclaration+="uniform sampler2D ".concat(this._2DSamplerName,`;\r
`),e._samplerDeclaration+=`#endif\r
`,e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);var t="//".concat(this.name);e._emitFunction("ReciprocalPI","#define RECIPROCAL_PI2 0.15915494",""),e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("reflectionFunction",t,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"}]}),this._reflectionColorName=e._getFreeVariableName("reflectionColor"),this._reflectionVectorName=e._getFreeVariableName("reflectionUVW"),this._reflectionCoordsName=e._getFreeVariableName("reflectionCoords"),this._reflectionPositionName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionPositionName,"vec3"),this._reflectionSizeName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionSizeName,"vec3")},r.prototype.handleFragmentSideCodeReflectionCoords=function(e,t,i,a){i===void 0&&(i=!1),a===void 0&&(a=!1),t||(t="v_".concat(this.worldPosition.associatedVariableName));var o=this._reflectionMatrixName,s="normalize(".concat(this._directionWName,")"),u="".concat(this._positionUVWName),l="".concat(this.cameraPosition.associatedVariableName),c="".concat(this.view.associatedVariableName);e+=".xyz";var p=`
            #ifdef `.concat(this._defineMirroredEquirectangularFixedName,`
                vec3 `).concat(this._reflectionVectorName," = computeMirroredFixedEquirectangularCoords(").concat(t,", ").concat(e,", ").concat(s,`);
            #endif

            #ifdef `).concat(this._defineEquirectangularFixedName,`
                vec3 `).concat(this._reflectionVectorName," = computeFixedEquirectangularCoords(").concat(t,", ").concat(e,", ").concat(s,`);
            #endif

            #ifdef `).concat(this._defineEquirectangularName,`
                vec3 `).concat(this._reflectionVectorName," = computeEquirectangularCoords(").concat(t,", ").concat(e,", ").concat(l,".xyz, ").concat(o,`);
            #endif

            #ifdef `).concat(this._defineSphericalName,`
                vec3 `).concat(this._reflectionVectorName," = computeSphericalCoords(").concat(t,", ").concat(e,", ").concat(c,", ").concat(o,`);
            #endif

            #ifdef `).concat(this._definePlanarName,`
                vec3 `).concat(this._reflectionVectorName," = computePlanarCoords(").concat(t,", ").concat(e,", ").concat(l,".xyz, ").concat(o,`);
            #endif

            #ifdef `).concat(this._defineCubicName,`
                #ifdef `).concat(this._defineLocalCubicName,`
                    vec3 `).concat(this._reflectionVectorName," = computeCubicLocalCoords(").concat(t,", ").concat(e,", ").concat(l,".xyz, ").concat(o,", ").concat(this._reflectionSizeName,", ").concat(this._reflectionPositionName,`);
                #else
                vec3 `).concat(this._reflectionVectorName," = computeCubicCoords(").concat(t,", ").concat(e,", ").concat(l,".xyz, ").concat(o,`);
                #endif
            #endif

            #ifdef `).concat(this._defineProjectionName,`
                vec3 `).concat(this._reflectionVectorName," = computeProjectionCoords(").concat(t,", ").concat(c,", ").concat(o,`);
            #endif

            #ifdef `).concat(this._defineSkyboxName,`
                vec3 `).concat(this._reflectionVectorName," = computeSkyBoxCoords(").concat(u,", ").concat(o,`);
            #endif

            #ifdef `).concat(this._defineExplicitName,`
                vec3 `).concat(this._reflectionVectorName,` = vec3(0, 0, 0);
            #endif\r
`);return a||(p+="#ifdef ".concat(this._defineOppositeZ,`
                `).concat(this._reflectionVectorName,`.z *= -1.0;
            #endif\r
`)),i||(p+=`
                #ifdef `.concat(this._define3DName,`
                    vec3 `).concat(this._reflectionCoordsName," = ").concat(this._reflectionVectorName,`;
                #else
                    vec2 `).concat(this._reflectionCoordsName," = ").concat(this._reflectionVectorName,`.xy;
                    #ifdef `).concat(this._defineProjectionName,`
                        `).concat(this._reflectionCoordsName," /= ").concat(this._reflectionVectorName,`.z;
                    #endif
                    `).concat(this._reflectionCoordsName,".y = 1.0 - ").concat(this._reflectionCoordsName,`.y;
                #endif\r
`)),p},r.prototype.handleFragmentSideCodeReflectionColor=function(e,t){t===void 0&&(t=".rgb");var i="vec"+(t.length===0?"4":t.length-1),a="".concat(i," ").concat(this._reflectionColorName,`;
            #ifdef `).concat(this._define3DName,`\r
`);return e?a+="".concat(this._reflectionColorName," = textureCubeLodEXT(").concat(this._cubeSamplerName,", ").concat(this._reflectionVectorName,", ").concat(e,")").concat(t,`;\r
`):a+="".concat(this._reflectionColorName," = textureCube(").concat(this._cubeSamplerName,", ").concat(this._reflectionVectorName,")").concat(t,`;\r
`),a+=`
            #else\r
`,e?a+="".concat(this._reflectionColorName," = texture2DLodEXT(").concat(this._2DSamplerName,", ").concat(this._reflectionCoordsName,", ").concat(e,")").concat(t,`;\r
`):a+="".concat(this._reflectionColorName," = texture2D(").concat(this._2DSamplerName,", ").concat(this._reflectionCoordsName,")").concat(t,`;\r
`),a+=`#endif\r
`,a},r.prototype.writeOutputs=function(e,t){var i="";if(e.target===_.Fragment)for(var a=0,o=this._outputs;a<o.length;a++){var s=o[a];s.hasEndpoints&&(i+="".concat(this._declareOutput(s,e)," = ").concat(t,".").concat(s.name,`;\r
`))}return i},r.prototype._buildBlock=function(e){return n.prototype._buildBlock.call(this,e),this},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);if(!this.texture)return e;if(this.texture.isCube){var t=this.texture.forcedExtension;e+="".concat(this._codeVariableName,'.texture = new BABYLON.CubeTexture("').concat(this.texture.name,'", undefined, undefined, ').concat(this.texture.noMipmap,", null, undefined, undefined, undefined, ").concat(this.texture._prefiltered,", ").concat(t?'"'+t+'"':"null",`);\r
`)}else e+="".concat(this._codeVariableName,'.texture = new BABYLON.Texture("').concat(this.texture.name,`", null);\r
`);return e+="".concat(this._codeVariableName,".texture.coordinatesMode = ").concat(this.texture.coordinatesMode,`;\r
`),e},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,e.texture.isCube?this.texture=et.Parse(e.texture,t,i):this.texture=I.Parse(e.texture,t,i))},r}(F);P("BABYLON.ReflectionTextureBaseBlock",qt);var xn=function(n){A(r,n);function r(e){var t=n.call(this,e)||this;return t.registerInput("position",f.Vector3,!1,_.Vertex),t.registerInput("worldPosition",f.Vector4,!1,_.Vertex),t.registerInput("worldNormal",f.Vector4,!1,_.Fragment),t.registerInput("world",f.Matrix,!1,_.Vertex),t.registerInput("cameraPosition",f.Vector3,!1,_.Fragment),t.registerInput("view",f.Matrix,!1,_.Fragment),t.registerOutput("rgb",f.Color3,_.Fragment),t.registerOutput("rgba",f.Color4,_.Fragment),t.registerOutput("r",f.Float,_.Fragment),t.registerOutput("g",f.Float,_.Fragment),t.registerOutput("b",f.Float,_.Fragment),t.registerOutput("a",f.Float,_.Fragment),t._inputs[0].acceptedConnectionPointTypes.push(f.Vector4),t}return r.prototype.getClassName=function(){return"ReflectionTextureBlock"},Object.defineProperty(r.prototype,"position",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"worldPosition",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"worldNormal",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"world",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraPosition",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"view",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rgb",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rgba",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"r",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"g",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"b",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"a",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),r.prototype.autoConfigure=function(e){if(n.prototype.autoConfigure.call(this,e),!this.cameraPosition.isConnected){var t=e.getInputBlockByPredicate(function(i){return i.systemValue===V.CameraPosition});t||(t=new B("cameraPosition"),t.setAsSystemValue(V.CameraPosition)),t.output.connectTo(this.cameraPosition)}},r.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),!this.texture)return e.compilationString+=this.writeOutputs(e,"vec3(0.)"),this;if(e.target!==_.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.handleFragmentSideInits(e);var t=e._getFreeVariableName("normalWUnit");return e.compilationString+="vec4 ".concat(t," = normalize(").concat(this.worldNormal.associatedVariableName,`);\r
`),e.compilationString+=this.handleFragmentSideCodeReflectionCoords(t),e.compilationString+=this.handleFragmentSideCodeReflectionColor(void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this},r}(qt);P("BABYLON.ReflectionTextureBlock",xn);var Rn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.VertexAndFragment)||this;return t._samplerName="textureSampler",t.useNonLinearDepth=!1,t.force32itsFloat=!1,t._isUnique=!0,t.registerInput("uv",f.Vector2,!1,_.VertexAndFragment),t.registerOutput("depth",f.Float,_.Neutral),t._inputs[0].acceptedConnectionPointTypes.push(f.Vector3),t._inputs[0].acceptedConnectionPointTypes.push(f.Vector4),t._inputs[0]._prioritizeVertex=!1,t}return r.prototype.getClassName=function(){return"SceneDepthBlock"},Object.defineProperty(r.prototype,"uv",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"depth",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype.initialize=function(e){e._excludeVariableName("textureSampler")},Object.defineProperty(r.prototype,"target",{get:function(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?_.VertexAndFragment:_.Fragment},enumerable:!1,configurable:!0}),r.prototype._getTexture=function(e){var t=e.enableDepthRenderer(void 0,this.useNonLinearDepth,this.force32itsFloat);return t.getDepthMap()},r.prototype.bind=function(e,t){var i=this._getTexture(t.getScene());e.setTexture(this._samplerName,i)},r.prototype._injectVertexCode=function(e){var t=this.uv;if(t.connectedPoint.ownerBlock.isInput){var i=t.connectedPoint.ownerBlock;i.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec"+(t.type===f.Vector3?"3":t.type===f.Vector4?"4":"2"))}if(this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+="".concat(this._mainUVName," = ").concat(t.associatedVariableName,`.xy;\r
`),!!this._outputs.some(function(u){return u.isConnectedInVertexShader})){this._writeTextureRead(e,!0);for(var a=0,o=this._outputs;a<o.length;a++){var s=o[a];s.hasEndpoints&&this._writeOutput(e,s,"r",!0)}}},r.prototype._writeTextureRead=function(e,t){t===void 0&&(t=!1);var i=this.uv;if(t){if(e.target===_.Fragment)return;e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(this._samplerName,", ").concat(i.associatedVariableName,`.xy);\r
`);return}if(this.uv.ownerBlock.target===_.Fragment){e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(this._samplerName,", ").concat(i.associatedVariableName,`.xy);\r
`);return}e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(this._samplerName,", ").concat(this._mainUVName,`);\r
`)},r.prototype._writeOutput=function(e,t,i,a){if(a===void 0&&(a=!1),a){if(e.target===_.Fragment)return;e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`);return}if(this.uv.ownerBlock.target===_.Fragment){e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`);return}e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`)},r.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.bindableBlocks.indexOf(this)<0&&e.sharedData.bindableBlocks.push(this),e.target!==_.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(!!this._outputs.some(function(o){return o.isConnectedInFragmentShader})){e._emit2DSampler(this._samplerName),this._writeTextureRead(e);for(var t=0,i=this._outputs;t<i.length;t++){var a=i[t];a.hasEndpoints&&this._writeOutput(e,a,"r")}return this}},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.useNonLinearDepth=this.useNonLinearDepth,e.force32itsFloat=this.force32itsFloat,e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),this.useNonLinearDepth=e.useNonLinearDepth,this.force32itsFloat=e.force32itsFloat},h([H("Use non linear depth",z.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:function(e){return e.disableDepthRenderer()}}})],r.prototype,"useNonLinearDepth",void 0),h([H("Force 32 bits float",z.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:function(e){return e.disableDepthRenderer()}}})],r.prototype,"force32itsFloat",void 0),r}(F);P("BABYLON.SceneDepthBlock",Rn);var On=function(n){A(r,n);function r(e){var t=n.call(this,e,_.VertexAndFragment,!0)||this;return t.registerInput("worldPosition",f.Vector4,!1),t}return r.prototype.getClassName=function(){return"ClipPlanesBlock"},r.prototype.initialize=function(e){e._excludeVariableName("vClipPlane"),e._excludeVariableName("fClipDistance"),e._excludeVariableName("vClipPlane2"),e._excludeVariableName("fClipDistance2"),e._excludeVariableName("vClipPlane3"),e._excludeVariableName("fClipDistance3"),e._excludeVariableName("vClipPlane4"),e._excludeVariableName("fClipDistance4"),e._excludeVariableName("vClipPlane5"),e._excludeVariableName("fClipDistance5"),e._excludeVariableName("vClipPlane6"),e._excludeVariableName("fClipDistance6")},Object.defineProperty(r.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"target",{get:function(){return _.VertexAndFragment},set:function(e){},enumerable:!1,configurable:!0}),r.prototype.prepareDefines=function(e,t,i){var a=e.getScene(),o=a.clipPlane!==void 0&&a.clipPlane!==null,s=a.clipPlane2!==void 0&&a.clipPlane2!==null,u=a.clipPlane3!==void 0&&a.clipPlane3!==null,l=a.clipPlane4!==void 0&&a.clipPlane4!==null,c=a.clipPlane5!==void 0&&a.clipPlane5!==null,p=a.clipPlane6!==void 0&&a.clipPlane6!==null;i.setValue("CLIPPLANE",o,!0),i.setValue("CLIPPLANE2",s,!0),i.setValue("CLIPPLANE3",u,!0),i.setValue("CLIPPLANE4",l,!0),i.setValue("CLIPPLANE5",c,!0),i.setValue("CLIPPLANE6",p,!0)},r.prototype.bind=function(e,t,i){if(!!i){var a=i.getScene();C.BindClipPlane(e,a)}},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t="//".concat(this.name);if(e.target!==_.Fragment){var i=this.worldPosition;e._emitFunctionFromInclude("clipPlaneVertexDeclaration",t,{replaceStrings:[{search:/uniform vec4 vClipPlane\d*;/g,replace:""}]}),e.compilationString+=e._emitCodeFromInclude("clipPlaneVertex",t,{replaceStrings:[{search:/worldPos/g,replace:i.associatedVariableName}]}),e._emitUniformFromString("vClipPlane","vec4"),e._emitUniformFromString("vClipPlane2","vec4"),e._emitUniformFromString("vClipPlane3","vec4"),e._emitUniformFromString("vClipPlane4","vec4"),e._emitUniformFromString("vClipPlane5","vec4"),e._emitUniformFromString("vClipPlane6","vec4");return}return e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e.compilationString+=e._emitCodeFromInclude("clipPlaneFragment",t),this},r}(F);P("BABYLON.ClipPlanesBlock",On);var Pn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("left",f.AutoDetect),t.registerInput("right",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t}return r.prototype.getClassName=function(){return"AddBlock"},Object.defineProperty(r.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.left.associatedVariableName," + ").concat(this.right.associatedVariableName,`;\r
`),this},r}(F);P("BABYLON.AddBlock",Pn);var Nn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("input",f.AutoDetect),t.registerInput("factor",f.Float),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t}return r.prototype.getClassName=function(){return"ScaleBlock"},Object.defineProperty(r.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"factor",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.input.associatedVariableName," * ").concat(this.factor.associatedVariableName,`;\r
`),this},r}(F);P("BABYLON.ScaleBlock",Nn);var In=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.minimum=0,t.maximum=1,t.registerInput("value",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t}return r.prototype.getClassName=function(){return"ClampBlock"},Object.defineProperty(r.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = clamp(".concat(this.value.associatedVariableName,", ").concat(this._writeFloat(this.minimum),", ").concat(this._writeFloat(this.maximum),`);\r
`),this},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this)+"".concat(this._codeVariableName,".minimum = ").concat(this.minimum,`;\r
`);return e+="".concat(this._codeVariableName,".maximum = ").concat(this.maximum,`;\r
`),e},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.minimum=this.minimum,e.maximum=this.maximum,e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),this.minimum=e.minimum,this.maximum=e.maximum},h([H("Minimum",z.Float)],r.prototype,"minimum",void 0),h([H("Maximum",z.Float)],r.prototype,"maximum",void 0),r}(F);P("BABYLON.ClampBlock",In);var Fn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("left",f.AutoDetect),t.registerInput("right",f.AutoDetect),t.registerOutput("output",f.Vector3),t._linkConnectionTypes(0,1),t._inputs[0].excludedConnectionPointTypes.push(f.Float),t._inputs[0].excludedConnectionPointTypes.push(f.Matrix),t._inputs[0].excludedConnectionPointTypes.push(f.Vector2),t._inputs[1].excludedConnectionPointTypes.push(f.Float),t._inputs[1].excludedConnectionPointTypes.push(f.Matrix),t._inputs[1].excludedConnectionPointTypes.push(f.Vector2),t}return r.prototype.getClassName=function(){return"CrossBlock"},Object.defineProperty(r.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = cross(".concat(this.left.associatedVariableName,".xyz, ").concat(this.right.associatedVariableName,`.xyz);\r
`),this},r}(F);P("BABYLON.CrossBlock",Fn);var Mn=function(n){A(r,n);function r(e){return n.call(this,e)||this}return Object.defineProperty(r.prototype,"options",{get:function(){return this._options},set:function(e){this._deserializeOptions(e)},enumerable:!1,configurable:!0}),r.prototype.getClassName=function(){return"CustomBlock"},r.prototype._buildBlock=function(e){var t=this;n.prototype._buildBlock.call(this,e);var i=this._code,a=this._options.functionName;this._inputs.forEach(function(s){var u=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),l=e._getGLType(s.type);i=i.replace(u,l),a=a.replace(u,l)}),this._outputs.forEach(function(s){var u=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),l=e._getGLType(s.type);i=i.replace(u,l),a=a.replace(u,l)}),e._emitFunction(a,i,""),this._outputs.forEach(function(s){e.compilationString+=t._declareOutput(s,e)+`;\r
`}),e.compilationString+=a+"(";var o=!1;return this._inputs.forEach(function(s,u){u>0&&(e.compilationString+=", "),e.compilationString+=s.associatedVariableName,o=!0}),this._outputs.forEach(function(s,u){(u>0||o)&&(e.compilationString+=", "),e.compilationString+=s.associatedVariableName}),e.compilationString+=`);\r
`,this},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,".options = ").concat(JSON.stringify(this._options),`;\r
`),e},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.options=this._options,e},r.prototype._deserialize=function(e,t,i){this._deserializeOptions(e.options),n.prototype._deserialize.call(this,e,t,i)},r.prototype._deserializeOptions=function(e){var t=this,i,a,o;this._options=e,this._code=e.code.join(`\r
`)+`\r
`,this.name=this.name||e.name,this.target=_[e.target],(i=e.inParameters)===null||i===void 0||i.forEach(function(s,u){var l=f[s.type];t.registerInput(s.name,l),Object.defineProperty(t,s.name,{get:function(){return this._inputs[u]},enumerable:!0,configurable:!0})}),(a=e.outParameters)===null||a===void 0||a.forEach(function(s,u){t.registerOutput(s.name,f[s.type]),Object.defineProperty(t,s.name,{get:function(){return this._outputs[u]},enumerable:!0,configurable:!0}),s.type==="BasedOnInput"&&(t._outputs[u]._typeConnectionSource=t._findInputByName(s.typeFromInput)[0])}),(o=e.inLinkedConnectionTypes)===null||o===void 0||o.forEach(function(s){t._linkConnectionTypes(t._findInputByName(s.input1)[1],t._findInputByName(s.input2)[1])})},r.prototype._findInputByName=function(e){if(!e)return null;for(var t=0;t<this._inputs.length;t++)if(this._inputs[t].name===e)return[this._inputs[t],t];return null},r}(F);P("BABYLON.CustomBlock",Mn);var Dn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("left",f.AutoDetect),t.registerInput("right",f.AutoDetect),t.registerOutput("output",f.Float),t._linkConnectionTypes(0,1),t._inputs[0].excludedConnectionPointTypes.push(f.Float),t._inputs[0].excludedConnectionPointTypes.push(f.Matrix),t._inputs[1].excludedConnectionPointTypes.push(f.Float),t._inputs[1].excludedConnectionPointTypes.push(f.Matrix),t}return r.prototype.getClassName=function(){return"DotBlock"},Object.defineProperty(r.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = dot(".concat(this.left.associatedVariableName,", ").concat(this.right.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.DotBlock",Dn);var Ln=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("input",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._inputs[0].excludedConnectionPointTypes.push(f.Float),t._inputs[0].excludedConnectionPointTypes.push(f.Matrix),t}return r.prototype.getClassName=function(){return"NormalizeBlock"},Object.defineProperty(r.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this._inputs[0];return e.compilationString+=this._declareOutput(t,e)+" = normalize(".concat(i.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.NormalizeBlock",Ln);var Bn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.rSwizzle="r",t.gSwizzle="g",t.bSwizzle="b",t.aSwizzle="a",t.registerInput("rgb ",f.Color3,!0),t.registerInput("r",f.Float,!0),t.registerInput("g",f.Float,!0),t.registerInput("b",f.Float,!0),t.registerInput("a",f.Float,!0),t.registerOutput("rgba",f.Color4),t.registerOutput("rgb",f.Color3),t}return r.prototype.getClassName=function(){return"ColorMergerBlock"},Object.defineProperty(r.prototype,"rgbIn",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"r",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"g",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"b",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"a",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rgba",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rgbOut",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rgb",{get:function(){return this.rgbOut},enumerable:!1,configurable:!0}),r.prototype._inputRename=function(e){return e==="rgb "?"rgbIn":e},r.prototype._buildSwizzle=function(e){var t=this.rSwizzle+this.gSwizzle+this.bSwizzle+this.aSwizzle;return"."+t.substr(0,e)},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this.r,i=this.g,a=this.b,o=this.a,s=this.rgbIn,u=this._outputs[0],l=this._outputs[1];return s.isConnected?(u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+" = vec4(".concat(s.associatedVariableName,", ").concat(o.isConnected?this._writeVariable(o):"0.0",")").concat(this._buildSwizzle(4),`;\r
`)),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+" = ".concat(s.associatedVariableName).concat(this._buildSwizzle(3),`;\r
`))):(u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+" = vec4(".concat(t.isConnected?this._writeVariable(t):"0.0",", ").concat(i.isConnected?this._writeVariable(i):"0.0",", ").concat(a.isConnected?this._writeVariable(a):"0.0",", ").concat(o.isConnected?this._writeVariable(o):"0.0",")").concat(this._buildSwizzle(4),`;\r
`)),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+" = vec3(".concat(t.isConnected?this._writeVariable(t):"0.0",", ").concat(i.isConnected?this._writeVariable(i):"0.0",", ").concat(a.isConnected?this._writeVariable(a):"0.0",")").concat(this._buildSwizzle(3),`;\r
`))),this},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.rSwizzle=this.rSwizzle,e.gSwizzle=this.gSwizzle,e.bSwizzle=this.bSwizzle,e.aSwizzle=this.aSwizzle,e},r.prototype._deserialize=function(e,t,i){var a,o,s,u;n.prototype._deserialize.call(this,e,t,i),this.rSwizzle=(a=e.rSwizzle)!==null&&a!==void 0?a:"r",this.gSwizzle=(o=e.gSwizzle)!==null&&o!==void 0?o:"g",this.bSwizzle=(s=e.bSwizzle)!==null&&s!==void 0?s:"b",this.aSwizzle=(u=e.aSwizzle)!==null&&u!==void 0?u:"a"},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,'.rSwizzle = "').concat(this.rSwizzle,`";\r
`),e+="".concat(this._codeVariableName,'.gSwizzle = "').concat(this.gSwizzle,`";\r
`),e+="".concat(this._codeVariableName,'.bSwizzle = "').concat(this.bSwizzle,`";\r
`),e+="".concat(this._codeVariableName,'.aSwizzle = "').concat(this.aSwizzle,`";\r
`),e},r}(F);P("BABYLON.ColorMergerBlock",Bn);var Vn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("xyzw",f.Vector4,!0),t.registerInput("xyz ",f.Vector3,!0),t.registerInput("xy ",f.Vector2,!0),t.registerOutput("xyz",f.Vector3),t.registerOutput("xy",f.Vector2),t.registerOutput("zw",f.Vector2),t.registerOutput("x",f.Float),t.registerOutput("y",f.Float),t.registerOutput("z",f.Float),t.registerOutput("w",f.Float),t.inputsAreExclusive=!0,t}return r.prototype.getClassName=function(){return"VectorSplitterBlock"},Object.defineProperty(r.prototype,"xyzw",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"xyzIn",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"xyIn",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"xyzOut",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"xyOut",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"zw",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"x",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"z",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"w",{get:function(){return this._outputs[6]},enumerable:!1,configurable:!0}),r.prototype._inputRename=function(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}},r.prototype._outputRename=function(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,i=this._outputs[0],a=this._outputs[1],o=this._outputs[2],s=this._outputs[3],u=this._outputs[4],l=this._outputs[5],c=this._outputs[6];return i.hasEndpoints&&(t===this.xyIn?e.compilationString+=this._declareOutput(i,e)+" = vec3(".concat(t.associatedVariableName,`, 0.0);\r
`):e.compilationString+=this._declareOutput(i,e)+" = ".concat(t.associatedVariableName,`.xyz;\r
`)),o.hasEndpoints&&this.xyzw.isConnected&&(e.compilationString+=this._declareOutput(o,e)+" = ".concat(this.xyzw.associatedVariableName,`.zw;\r
`)),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+" = ".concat(t.associatedVariableName,`.xy;\r
`)),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+" = ".concat(t.associatedVariableName,`.x;\r
`)),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+" = ".concat(t.associatedVariableName,`.y;\r
`)),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+" = ".concat(t.associatedVariableName,`.z;\r
`)),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+" = ".concat(t.associatedVariableName,`.w;\r
`)),this},r}(F);P("BABYLON.VectorSplitterBlock",Vn);var wn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("left",f.AutoDetect),t.registerInput("right",f.AutoDetect),t.registerInput("gradient",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t._linkConnectionTypes(1,2,!0),t._inputs[2].acceptedConnectionPointTypes.push(f.Float),t}return r.prototype.getClassName=function(){return"LerpBlock"},Object.defineProperty(r.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"gradient",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = mix(".concat(this.left.associatedVariableName," , ").concat(this.right.associatedVariableName,", ").concat(this.gradient.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.LerpBlock",wn);var kn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("left",f.AutoDetect),t.registerInput("right",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t}return r.prototype.getClassName=function(){return"DivideBlock"},Object.defineProperty(r.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.left.associatedVariableName," / ").concat(this.right.associatedVariableName,`;\r
`),this},r}(F);P("BABYLON.DivideBlock",kn);var Un=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("left",f.AutoDetect),t.registerInput("right",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t}return r.prototype.getClassName=function(){return"SubtractBlock"},Object.defineProperty(r.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.left.associatedVariableName," - ").concat(this.right.associatedVariableName,`;\r
`),this},r}(F);P("BABYLON.SubtractBlock",Un);var zn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("value",f.Float),t.registerInput("edge",f.Float),t.registerOutput("output",f.Float),t}return r.prototype.getClassName=function(){return"StepBlock"},Object.defineProperty(r.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"edge",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = step(".concat(this.edge.associatedVariableName,", ").concat(this.value.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.StepBlock",zn);var Pr=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("input",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._outputs[0].excludedConnectionPointTypes.push(f.Matrix),t}return r.prototype.getClassName=function(){return"OneMinusBlock"},Object.defineProperty(r.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = 1. - ".concat(this.input.associatedVariableName,`;\r
`),this},r}(F);P("BABYLON.OneMinusBlock",Pr);P("BABYLON.OppositeBlock",Pr);var Nr=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("worldPosition",f.Vector4),t.registerInput("cameraPosition",f.Vector3),t.registerOutput("output",f.Vector3),t}return r.prototype.getClassName=function(){return"ViewDirectionBlock"},Object.defineProperty(r.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraPosition",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype.autoConfigure=function(e){if(!this.cameraPosition.isConnected){var t=e.getInputBlockByPredicate(function(i){return i.systemValue===V.CameraPosition});t||(t=new B("cameraPosition"),t.setAsSystemValue(V.CameraPosition)),t.output.connectTo(this.cameraPosition)}},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = normalize(".concat(this.cameraPosition.associatedVariableName," - ").concat(this.worldPosition.associatedVariableName,`.xyz);\r
`),this},r}(F);P("BABYLON.ViewDirectionBlock",Nr);var Gn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("worldNormal",f.Vector4),t.registerInput("viewDirection",f.Vector3),t.registerInput("bias",f.Float),t.registerInput("power",f.Float),t.registerOutput("fresnel",f.Float),t}return r.prototype.getClassName=function(){return"FresnelBlock"},Object.defineProperty(r.prototype,"worldNormal",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"viewDirection",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"bias",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"power",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"fresnel",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype.autoConfigure=function(e){if(!this.viewDirection.isConnected){var t=new Nr("View direction");t.output.connectTo(this.viewDirection),t.autoConfigure(e)}if(!this.bias.isConnected){var i=new B("bias");i.value=0,i.output.connectTo(this.bias)}if(!this.power.isConnected){var a=new B("power");a.value=1,a.output.connectTo(this.power)}},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t="//".concat(this.name);return e._emitFunctionFromInclude("fresnelFunction",t,{removeIfDef:!0}),e.compilationString+=this._declareOutput(this.fresnel,e)+" = computeFresnelTerm(".concat(this.viewDirection.associatedVariableName,".xyz, ").concat(this.worldNormal.associatedVariableName,".xyz, ").concat(this.bias.associatedVariableName,", ").concat(this.power.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.FresnelBlock",Gn);var Hn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("left",f.AutoDetect),t.registerInput("right",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t}return r.prototype.getClassName=function(){return"MaxBlock"},Object.defineProperty(r.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = max(".concat(this.left.associatedVariableName,", ").concat(this.right.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.MaxBlock",Hn);var jn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("left",f.AutoDetect),t.registerInput("right",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t}return r.prototype.getClassName=function(){return"MinBlock"},Object.defineProperty(r.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = min(".concat(this.left.associatedVariableName,", ").concat(this.right.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.MinBlock",jn);var Wn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("left",f.AutoDetect),t.registerInput("right",f.AutoDetect),t.registerOutput("output",f.Float),t._linkConnectionTypes(0,1),t._inputs[0].excludedConnectionPointTypes.push(f.Float),t._inputs[0].excludedConnectionPointTypes.push(f.Matrix),t._inputs[1].excludedConnectionPointTypes.push(f.Float),t._inputs[1].excludedConnectionPointTypes.push(f.Matrix),t}return r.prototype.getClassName=function(){return"DistanceBlock"},Object.defineProperty(r.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = length(".concat(this.left.associatedVariableName," - ").concat(this.right.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.DistanceBlock",Wn);var Yn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("value",f.AutoDetect),t.registerOutput("output",f.Float),t._inputs[0].excludedConnectionPointTypes.push(f.Float),t._inputs[0].excludedConnectionPointTypes.push(f.Matrix),t}return r.prototype.getClassName=function(){return"LengthBlock"},Object.defineProperty(r.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = length(".concat(this.value.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.LengthBlock",Yn);var Xn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("value",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t}return r.prototype.getClassName=function(){return"NegateBlock"},Object.defineProperty(r.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = -1.0 * ".concat(this.value.associatedVariableName,`;\r
`),this},r}(F);P("BABYLON.NegateBlock",Xn);var Kn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("value",f.AutoDetect),t.registerInput("power",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t}return r.prototype.getClassName=function(){return"PowBlock"},Object.defineProperty(r.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"power",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = pow(".concat(this.value.associatedVariableName,", ").concat(this.power.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.PowBlock",Kn);var qn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("seed",f.Vector2),t.registerOutput("output",f.Float),t._inputs[0].acceptedConnectionPointTypes.push(f.Vector3),t._inputs[0].acceptedConnectionPointTypes.push(f.Vector4),t._inputs[0].acceptedConnectionPointTypes.push(f.Color3),t._inputs[0].acceptedConnectionPointTypes.push(f.Color4),t}return r.prototype.getClassName=function(){return"RandomNumberBlock"},Object.defineProperty(r.prototype,"seed",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0],i="//".concat(this.name);return e._emitFunctionFromInclude("helperFunctions",i),e.compilationString+=this._declareOutput(t,e)+" = getRand(".concat(this.seed.associatedVariableName,`.xy);\r
`),this},r}(F);P("BABYLON.RandomNumberBlock",qn);var Zn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("x",f.Float),t.registerInput("y",f.Float),t.registerOutput("output",f.Float),t}return r.prototype.getClassName=function(){return"ArcTan2Block"},Object.defineProperty(r.prototype,"x",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = atan(".concat(this.x.associatedVariableName,", ").concat(this.y.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.ArcTan2Block",Zn);var Qn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("value",f.AutoDetect),t.registerInput("edge0",f.Float),t.registerInput("edge1",f.Float),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t}return r.prototype.getClassName=function(){return"SmoothStepBlock"},Object.defineProperty(r.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"edge0",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"edge1",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = smoothstep(".concat(this.edge0.associatedVariableName,", ").concat(this.edge1.associatedVariableName,", ").concat(this.value.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.SmoothStepBlock",Qn);var Jn=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("input",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._outputs[0].excludedConnectionPointTypes.push(f.Matrix),t}return r.prototype.getClassName=function(){return"ReciprocalBlock"},Object.defineProperty(r.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = 1. / ".concat(this.input.associatedVariableName,`;\r
`),this},r}(F);P("BABYLON.ReciprocalBlock",Jn);var $n=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("value",f.AutoDetect),t.registerInput("reference",f.AutoDetect),t.registerInput("distance",f.Float),t.registerInput("replacement",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t._linkConnectionTypes(0,3),t._inputs[0].excludedConnectionPointTypes.push(f.Float),t._inputs[0].excludedConnectionPointTypes.push(f.Matrix),t._inputs[1].excludedConnectionPointTypes.push(f.Float),t._inputs[1].excludedConnectionPointTypes.push(f.Matrix),t._inputs[3].excludedConnectionPointTypes.push(f.Float),t._inputs[3].excludedConnectionPointTypes.push(f.Matrix),t}return r.prototype.getClassName=function(){return"ReplaceColorBlock"},Object.defineProperty(r.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"reference",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"distance",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"replacement",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+`;\r
`,e.compilationString+="if (length(".concat(this.value.associatedVariableName," - ").concat(this.reference.associatedVariableName,") < ").concat(this.distance.associatedVariableName,`) {\r
`),e.compilationString+="".concat(t.associatedVariableName," = ").concat(this.replacement.associatedVariableName,`;\r
`),e.compilationString+=`} else {\r
`,e.compilationString+="".concat(t.associatedVariableName," = ").concat(this.value.associatedVariableName,`;\r
`),e.compilationString+=`}\r
`,this},r}(F);P("BABYLON.ReplaceColorBlock",$n);var ea=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("value",f.AutoDetect),t.registerInput("steps",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t._inputs[0].excludedConnectionPointTypes.push(f.Matrix),t._inputs[1].excludedConnectionPointTypes.push(f.Matrix),t}return r.prototype.getClassName=function(){return"PosterizeBlock"},Object.defineProperty(r.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"steps",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = floor(".concat(this.value.associatedVariableName," / (1.0 / ").concat(this.steps.associatedVariableName,")) * (1.0 / ").concat(this.steps.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.PosterizeBlock",ea);var ze;(function(n){n[n.SawTooth=0]="SawTooth",n[n.Square=1]="Square",n[n.Triangle=2]="Triangle"})(ze||(ze={}));var ta=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.kind=ze.SawTooth,t.registerInput("input",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._inputs[0].excludedConnectionPointTypes.push(f.Matrix),t}return r.prototype.getClassName=function(){return"WaveBlock"},Object.defineProperty(r.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];switch(this.kind){case ze.SawTooth:{e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.input.associatedVariableName," - floor(0.5 + ").concat(this.input.associatedVariableName,`);\r
`);break}case ze.Square:{e.compilationString+=this._declareOutput(t,e)+" = 1.0 - 2.0 * round(fract(".concat(this.input.associatedVariableName,`));\r
`);break}case ze.Triangle:{e.compilationString+=this._declareOutput(t,e)+" = 2.0 * abs(2.0 * (".concat(this.input.associatedVariableName," - floor(0.5 + ").concat(this.input.associatedVariableName,`))) - 1.0;\r
`);break}}return this},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.kind=this.kind,e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),this.kind=e.kind},r}(F);P("BABYLON.WaveBlock",ta);var Lt=function(){function n(r,e){this.step=r,this.color=e}return Object.defineProperty(n.prototype,"step",{get:function(){return this._step},set:function(r){this._step=r},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"color",{get:function(){return this._color},set:function(r){this._color=r},enumerable:!1,configurable:!0}),n}(),ra=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.colorSteps=[new Lt(0,G.Black()),new Lt(1,G.White())],t.onValueChangedObservable=new J,t.registerInput("gradient",f.Float),t.registerOutput("output",f.Color3),t._inputs[0].acceptedConnectionPointTypes.push(f.Vector2),t._inputs[0].acceptedConnectionPointTypes.push(f.Vector3),t._inputs[0].acceptedConnectionPointTypes.push(f.Vector4),t._inputs[0].acceptedConnectionPointTypes.push(f.Color3),t._inputs[0].acceptedConnectionPointTypes.push(f.Color4),t}return r.prototype.colorStepsUpdated=function(){this.onValueChangedObservable.notifyObservers(this)},r.prototype.getClassName=function(){return"GradientBlock"},Object.defineProperty(r.prototype,"gradient",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._writeColorConstant=function(e){var t=this.colorSteps[e];return"vec3(".concat(t.color.r,", ").concat(t.color.g,", ").concat(t.color.b,")")},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];if(!this.colorSteps.length||!this.gradient.connectedPoint){e.compilationString+=this._declareOutput(t,e)+` = vec3(0., 0., 0.);\r
`;return}var i=e._getFreeVariableName("gradientTempColor"),a=e._getFreeVariableName("gradientTempPosition");e.compilationString+="vec3 ".concat(i," = ").concat(this._writeColorConstant(0),`;\r
`),e.compilationString+="float ".concat(a,`;\r
`);var o=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==f.Float&&(o+=".x");for(var s=1;s<this.colorSteps.length;s++){var u=this.colorSteps[s],l=this.colorSteps[s-1];e.compilationString+="".concat(a," = clamp((").concat(o," - ").concat(e._emitFloat(l.step),") / (").concat(e._emitFloat(u.step)," -  ").concat(e._emitFloat(l.step),"), 0.0, 1.0) * step(").concat(e._emitFloat(s),", ").concat(e._emitFloat(this.colorSteps.length-1),`);\r
`),e.compilationString+="".concat(i," = mix(").concat(i,", ").concat(this._writeColorConstant(s),", ").concat(a,`);\r
`)}return e.compilationString+=this._declareOutput(t,e)+" = ".concat(i,`;\r
`),this},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);e.colorSteps=[];for(var t=0,i=this.colorSteps;t<i.length;t++){var a=i[t];e.colorSteps.push({step:a.step,color:{r:a.color.r,g:a.color.g,b:a.color.b}})}return e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),this.colorSteps.length=0;for(var a=0,o=e.colorSteps;a<o.length;a++){var s=o[a];this.colorSteps.push(new Lt(s.step,new G(s.color.r,s.color.g,s.color.b)))}},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);e+="".concat(this._codeVariableName,`.colorSteps = [];\r
`);for(var t=0,i=this.colorSteps;t<i.length;t++){var a=i[t];e+="".concat(this._codeVariableName,".colorSteps.push(new BABYLON.GradientBlockColorStep(").concat(a.step,", new BABYLON.Color3(").concat(a.color.r,", ").concat(a.color.g,", ").concat(a.color.b,`)));\r
`)}return e},r}(F);P("BABYLON.GradientBlock",ra);var ia=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("left",f.AutoDetect),t.registerInput("right",f.AutoDetect),t.registerInput("gradient",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t._linkConnectionTypes(1,2,!0),t._inputs[2].acceptedConnectionPointTypes.push(f.Float),t}return r.prototype.getClassName=function(){return"NLerpBlock"},Object.defineProperty(r.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"gradient",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = normalize(mix(".concat(this.left.associatedVariableName," , ").concat(this.right.associatedVariableName,", ").concat(this.gradient.associatedVariableName,`));\r
`),this},r}(F);P("BABYLON.NLerpBlock",ia);var na=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.manhattanDistance=!1,t.registerInput("seed",f.Vector3),t.registerInput("jitter",f.Float),t.registerOutput("output",f.Vector2),t.registerOutput("x",f.Float),t.registerOutput("y",f.Float),t}return r.prototype.getClassName=function(){return"WorleyNoise3DBlock"},Object.defineProperty(r.prototype,"seed",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"jitter",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"x",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),!!this.seed.isConnected&&!(!this.output.hasEndpoints&&!this.x.hasEndpoints&&!this.y.hasEndpoints)){var t=`vec3 permute(vec3 x){\r
`;t+=`    return mod((34.0 * x + 1.0) * x, 289.0);\r
`,t+=`}\r
\r
`,t+=`vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\r
`,t+=`    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\r
`,t+=`}\r
\r
`,t+=`vec2 worley(vec3 P, float jitter, bool manhattanDistance){\r
`,t+=`    float K = 0.142857142857; // 1/7\r
`,t+=`    float Ko = 0.428571428571; // 1/2-K/2\r
`,t+=`    float  K2 = 0.020408163265306; // 1/(7*7)\r
`,t+=`    float Kz = 0.166666666667; // 1/6\r
`,t+=`    float Kzo = 0.416666666667; // 1/2-1/6*2\r
`,t+=`\r
`,t+=`    vec3 Pi = mod(floor(P), 289.0);\r
`,t+=`    vec3 Pf = fract(P) - 0.5;\r
`,t+=`\r
`,t+=`    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\r
`,t+=`    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\r
`,t+=`    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\r
`,t+=`\r
`,t+=`    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\r
`,t+=`    vec3 p1 = permute(p + Pi.y - 1.0);\r
`,t+=`    vec3 p2 = permute(p + Pi.y);\r
`,t+=`    vec3 p3 = permute(p + Pi.y + 1.0);\r
`,t+=`\r
`,t+=`    vec3 p11 = permute(p1 + Pi.z - 1.0);\r
`,t+=`    vec3 p12 = permute(p1 + Pi.z);\r
`,t+=`    vec3 p13 = permute(p1 + Pi.z + 1.0);\r
`,t+=`\r
`,t+=`    vec3 p21 = permute(p2 + Pi.z - 1.0);\r
`,t+=`    vec3 p22 = permute(p2 + Pi.z);\r
`,t+=`    vec3 p23 = permute(p2 + Pi.z + 1.0);\r
`,t+=`\r
`,t+=`    vec3 p31 = permute(p3 + Pi.z - 1.0);\r
`,t+=`    vec3 p32 = permute(p3 + Pi.z);\r
`,t+=`    vec3 p33 = permute(p3 + Pi.z + 1.0);\r
`,t+=`\r
`,t+=`    vec3 ox11 = fract(p11*K) - Ko;\r
`,t+=`    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\r
`,t+=`\r
`,t+=`    vec3 ox12 = fract(p12*K) - Ko;\r
`,t+=`    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox13 = fract(p13*K) - Ko;\r
`,t+=`    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox21 = fract(p21*K) - Ko;\r
`,t+=`    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox22 = fract(p22*K) - Ko;\r
`,t+=`    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox23 = fract(p23*K) - Ko;\r
`,t+=`    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox31 = fract(p31*K) - Ko;\r
`,t+=`    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox32 = fract(p32*K) - Ko;\r
`,t+=`    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox33 = fract(p33*K) - Ko;\r
`,t+=`    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 dx11 = Pfx + jitter*ox11;\r
`,t+=`    vec3 dy11 = Pfy.x + jitter*oy11;\r
`,t+=`    vec3 dz11 = Pfz.x + jitter*oz11;\r
`,t+=`\r
`,t+=`    vec3 dx12 = Pfx + jitter*ox12;\r
`,t+=`    vec3 dy12 = Pfy.x + jitter*oy12;\r
`,t+=`    vec3 dz12 = Pfz.y + jitter*oz12;\r
`,t+=`\r
`,t+=`    vec3 dx13 = Pfx + jitter*ox13;\r
`,t+=`    vec3 dy13 = Pfy.x + jitter*oy13;\r
`,t+=`    vec3 dz13 = Pfz.z + jitter*oz13;\r
`,t+=`\r
`,t+=`    vec3 dx21 = Pfx + jitter*ox21;\r
`,t+=`    vec3 dy21 = Pfy.y + jitter*oy21;\r
`,t+=`    vec3 dz21 = Pfz.x + jitter*oz21;\r
`,t+=`\r
`,t+=`    vec3 dx22 = Pfx + jitter*ox22;\r
`,t+=`    vec3 dy22 = Pfy.y + jitter*oy22;\r
`,t+=`    vec3 dz22 = Pfz.y + jitter*oz22;\r
`,t+=`\r
`,t+=`    vec3 dx23 = Pfx + jitter*ox23;\r
`,t+=`    vec3 dy23 = Pfy.y + jitter*oy23;\r
`,t+=`    vec3 dz23 = Pfz.z + jitter*oz23;\r
`,t+=`\r
`,t+=`    vec3 dx31 = Pfx + jitter*ox31;\r
`,t+=`    vec3 dy31 = Pfy.z + jitter*oy31;\r
`,t+=`    vec3 dz31 = Pfz.x + jitter*oz31;\r
`,t+=`\r
`,t+=`    vec3 dx32 = Pfx + jitter*ox32;\r
`,t+=`    vec3 dy32 = Pfy.z + jitter*oy32;\r
`,t+=`    vec3 dz32 = Pfz.y + jitter*oz32;\r
`,t+=`\r
`,t+=`    vec3 dx33 = Pfx + jitter*ox33;\r
`,t+=`    vec3 dy33 = Pfy.z + jitter*oy33;\r
`,t+=`    vec3 dz33 = Pfz.z + jitter*oz33;\r
`,t+=`\r
`,t+=`    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\r
`,t+=`    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\r
`,t+=`    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\r
`,t+=`    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\r
`,t+=`    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\r
`,t+=`    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\r
`,t+=`    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\r
`,t+=`    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\r
`,t+=`    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\r
`,t+=`\r
`,t+=`    vec3 d1a = min(d11, d12);\r
`,t+=`    d12 = max(d11, d12);\r
`,t+=`    d11 = min(d1a, d13); // Smallest now not in d12 or d13\r
`,t+=`    d13 = max(d1a, d13);\r
`,t+=`    d12 = min(d12, d13); // 2nd smallest now not in d13\r
`,t+=`    vec3 d2a = min(d21, d22);\r
`,t+=`    d22 = max(d21, d22);\r
`,t+=`    d21 = min(d2a, d23); // Smallest now not in d22 or d23\r
`,t+=`    d23 = max(d2a, d23);\r
`,t+=`    d22 = min(d22, d23); // 2nd smallest now not in d23\r
`,t+=`    vec3 d3a = min(d31, d32);\r
`,t+=`    d32 = max(d31, d32);\r
`,t+=`    d31 = min(d3a, d33); // Smallest now not in d32 or d33\r
`,t+=`    d33 = max(d3a, d33);\r
`,t+=`    d32 = min(d32, d33); // 2nd smallest now not in d33\r
`,t+=`    vec3 da = min(d11, d21);\r
`,t+=`    d21 = max(d11, d21);\r
`,t+=`    d11 = min(da, d31); // Smallest now in d11\r
`,t+=`    d31 = max(da, d31); // 2nd smallest now not in d31\r
`,t+=`    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\r
`,t+=`    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\r
`,t+=`    d12 = min(d12, d21); // 2nd smallest now not in d21\r
`,t+=`    d12 = min(d12, d22); // nor in d22\r
`,t+=`    d12 = min(d12, d31); // nor in d31\r
`,t+=`    d12 = min(d12, d32); // nor in d32\r
`,t+=`    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\r
`,t+=`    d11.y = min(d11.y,d12.z); // Only two more to go\r
`,t+=`    d11.y = min(d11.y,d11.z); // Done! (Phew!)\r
`,t+=`    return sqrt(d11.xy); // F1, F2\r
`,t+=`}\r
\r
`,e._emitFunction("worley3D",t,"// Worley3D");var i=e._getFreeVariableName("worleyTemp");return e.compilationString+="vec2 ".concat(i," = worley(").concat(this.seed.associatedVariableName,", ").concat(this.jitter.associatedVariableName,", ").concat(this.manhattanDistance,`);\r
`),this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+" = ".concat(i,`;\r
`)),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+" = ".concat(i,`.x;\r
`)),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+" = ".concat(i,`.y;\r
`)),this}},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this)+"".concat(this._codeVariableName,".manhattanDistance = ").concat(this.manhattanDistance,`;\r
`);return e},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.manhattanDistance=this.manhattanDistance,e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),this.manhattanDistance=e.manhattanDistance},h([H("Use Manhattan Distance",z.Boolean,"PROPERTIES",{notifiers:{update:!1}})],r.prototype,"manhattanDistance",void 0),r}(F);P("BABYLON.WorleyNoise3DBlock",na);var aa=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("seed",f.Vector3),t.registerOutput("output",f.Float),t}return r.prototype.getClassName=function(){return"SimplexPerlin3DBlock"},Object.defineProperty(r.prototype,"seed",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),!!this.seed.isConnected&&!!this._outputs[0].hasEndpoints){var t=`const float SKEWFACTOR = 1.0/3.0;\r
`;return t+=`const float UNSKEWFACTOR = 1.0/6.0;\r
`,t+=`const float SIMPLEX_CORNER_POS = 0.5;\r
`,t+=`const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\r
`,t+=`float SimplexPerlin3D( vec3 P ){\r
`,t+=`    P.x = P == vec3(0., 0., 0.) ? 0.00001 : P.x;\r
`,t+=`    P *= SIMPLEX_TETRAHADRON_HEIGHT;\r
`,t+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",t+=`    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\r
`,t+=`    vec3 g = step(x0.yzx, x0.xyz);\r
`,t+=`    vec3 l = 1.0 - g;\r
`,t+=`    vec3 Pi_1 = min( g.xyz, l.zxy );\r
`,t+=`    vec3 Pi_2 = max( g.xyz, l.zxy );\r
`,t+=`    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\r
`,t+=`    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\r
`,t+=`    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\r
`,t+=`    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\r
`,t+=`    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\r
`,t+=`    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\r
`,t+=`    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\r
`,t+=`    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\r
`,t+=`    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\r
`,t+=`    Pt *= Pt;\r
`,t+=`    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\r
`,t+=`    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\r
`,t+=`    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\r
`,t+=`    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\r
`,t+=`    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\r
`,t+=`    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\r
`,t+=`    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\r
`,t+=`    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\r
`,t+=`    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\r
`,t+=`    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\r
`,t+=`    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\r
`,t+=`    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\r
`,t+=`    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\r
`,t+=`    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\r
`,t+=`    kernel_weights = max(0.5 - kernel_weights, 0.0);\r
`,t+=`    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\r
`,t+=`    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\r
`,t+=`}\r
`,e._emitFunction("SimplexPerlin3D",t,"// SimplexPerlin3D"),e.compilationString+=this._declareOutput(this._outputs[0],e)+" = SimplexPerlin3D(".concat(this.seed.associatedVariableName,`);\r
`),this}},r}(F);P("BABYLON.SimplexPerlin3DBlock",aa);var oa=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("normalMap0",f.Vector3),t.registerInput("normalMap1",f.Vector3),t.registerOutput("output",f.Vector3),t._inputs[0].acceptedConnectionPointTypes.push(f.Color3),t._inputs[0].acceptedConnectionPointTypes.push(f.Color4),t._inputs[0].acceptedConnectionPointTypes.push(f.Vector4),t._inputs[1].acceptedConnectionPointTypes.push(f.Color3),t._inputs[1].acceptedConnectionPointTypes.push(f.Color4),t._inputs[1].acceptedConnectionPointTypes.push(f.Vector4),t}return r.prototype.getClassName=function(){return"NormalBlendBlock"},Object.defineProperty(r.prototype,"normalMap0",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"normalMap1",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this._inputs[0],a=this._inputs[1],o=e._getFreeVariableName("stepR"),s=e._getFreeVariableName("stepG");return e.compilationString+="float ".concat(o," = step(0.5, ").concat(i.associatedVariableName,`.r);\r
`),e.compilationString+="float ".concat(s," = step(0.5, ").concat(i.associatedVariableName,`.g);\r
`),e.compilationString+=this._declareOutput(t,e)+`;\r
`,e.compilationString+="".concat(t.associatedVariableName,".r = (1.0 - ").concat(o,") * ").concat(i.associatedVariableName,".r * ").concat(a.associatedVariableName,".r * 2.0 + ").concat(o," * (1.0 - (1.0 - ").concat(i.associatedVariableName,".r) * (1.0 - ").concat(a.associatedVariableName,`.r) * 2.0);\r
`),e.compilationString+="".concat(t.associatedVariableName,".g = (1.0 - ").concat(s,") * ").concat(i.associatedVariableName,".g * ").concat(a.associatedVariableName,".g * 2.0 + ").concat(s," * (1.0 - (1.0 - ").concat(i.associatedVariableName,".g) * (1.0 - ").concat(a.associatedVariableName,`.g) * 2.0);\r
`),e.compilationString+="".concat(t.associatedVariableName,".b = ").concat(i.associatedVariableName,".b * ").concat(a.associatedVariableName,`.b;\r
`),this},r}(F);P("BABYLON.NormalBlendBlock",oa);var sa=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("input",f.Vector2),t.registerInput("angle",f.Float),t.registerOutput("output",f.Vector2),t}return r.prototype.getClassName=function(){return"Rotate2dBlock"},Object.defineProperty(r.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"angle",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype.autoConfigure=function(){if(!this.angle.isConnected){var e=new B("angle");e.value=0,e.output.connectTo(this.angle)}},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this.angle,a=this.input;return e.compilationString+=this._declareOutput(t,e)+" = vec2(cos(".concat(i.associatedVariableName,") * ").concat(a.associatedVariableName,".x - sin(").concat(i.associatedVariableName,") * ").concat(a.associatedVariableName,".y, sin(").concat(i.associatedVariableName,") * ").concat(a.associatedVariableName,".x + cos(").concat(i.associatedVariableName,") * ").concat(a.associatedVariableName,`.y);\r
`),this},r}(F);P("BABYLON.Rotate2dBlock",sa);var ua=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("incident",f.Vector3),t.registerInput("normal",f.Vector3),t.registerOutput("output",f.Vector3),t._inputs[0].acceptedConnectionPointTypes.push(f.Vector4),t._inputs[0].acceptedConnectionPointTypes.push(f.Color3),t._inputs[0].acceptedConnectionPointTypes.push(f.Color4),t._inputs[1].acceptedConnectionPointTypes.push(f.Vector4),t._inputs[1].acceptedConnectionPointTypes.push(f.Color3),t._inputs[1].acceptedConnectionPointTypes.push(f.Color4),t}return r.prototype.getClassName=function(){return"ReflectBlock"},Object.defineProperty(r.prototype,"incident",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"normal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = reflect(".concat(this.incident.associatedVariableName,".xyz, ").concat(this.normal.associatedVariableName,`.xyz);\r
`),this},r}(F);P("BABYLON.ReflectBlock",ua);var la=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("incident",f.Vector3),t.registerInput("normal",f.Vector3),t.registerInput("ior",f.Float),t.registerOutput("output",f.Vector3),t._inputs[0].acceptedConnectionPointTypes.push(f.Vector4),t._inputs[0].acceptedConnectionPointTypes.push(f.Color3),t._inputs[0].acceptedConnectionPointTypes.push(f.Color4),t._inputs[1].acceptedConnectionPointTypes.push(f.Vector4),t._inputs[1].acceptedConnectionPointTypes.push(f.Color3),t._inputs[1].acceptedConnectionPointTypes.push(f.Color4),t}return r.prototype.getClassName=function(){return"RefractBlock"},Object.defineProperty(r.prototype,"incident",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"normal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"ior",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = refract(".concat(this.incident.associatedVariableName,".xyz, ").concat(this.normal.associatedVariableName,".xyz, ").concat(this.ior.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.RefractBlock",la);var ca=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("color",f.Color3),t.registerInput("level",f.Float),t.registerOutput("output",f.Color3),t}return r.prototype.getClassName=function(){return"DesaturateBlock"},Object.defineProperty(r.prototype,"color",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"level",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this.color,a=i.associatedVariableName,o=e._getFreeVariableName("colorMin"),s=e._getFreeVariableName("colorMax"),u=e._getFreeVariableName("colorMerge");return e.compilationString+="float ".concat(o," = min(min(").concat(a,".x, ").concat(a,".y), ").concat(a,`.z);\r
`),e.compilationString+="float ".concat(s," = max(max(").concat(a,".x, ").concat(a,".y), ").concat(a,`.z);\r
`),e.compilationString+="float ".concat(u," = 0.5 * (").concat(o," + ").concat(s,`);\r
`),e.compilationString+=this._declareOutput(t,e)+" = mix(".concat(a,", vec3(").concat(u,", ").concat(u,", ").concat(u,"), ").concat(this.level.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.DesaturateBlock",ca);var Ir=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t.albedoScaling=!1,t.linkSheenWithAlbedo=!1,t._isUnique=!0,t.registerInput("intensity",f.Float,!0,_.Fragment),t.registerInput("color",f.Color3,!0,_.Fragment),t.registerInput("roughness",f.Float,!0,_.Fragment),t.registerOutput("sheen",f.Object,_.Fragment,new ce("sheen",t,ee.Output,r,"SheenBlock")),t}return r.prototype.initialize=function(e){e._excludeVariableName("sheenOut"),e._excludeVariableName("sheenMapData"),e._excludeVariableName("vSheenColor"),e._excludeVariableName("vSheenRoughness")},r.prototype.getClassName=function(){return"SheenBlock"},Object.defineProperty(r.prototype,"intensity",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"color",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"roughness",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"sheen",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype.prepareDefines=function(e,t,i){n.prototype.prepareDefines.call(this,e,t,i),i.setValue("SHEEN",!0),i.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),i.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),i.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)},r.prototype.getCode=function(e){var t="",i=this.color.isConnected?this.color.associatedVariableName:"vec3(1.)",a=this.intensity.isConnected?this.intensity.associatedVariableName:"1.",o=this.roughness.isConnected?this.roughness.associatedVariableName:"0.",s="vec4(0.)";return t=`#ifdef SHEEN
            sheenOutParams sheenOut;

            vec4 vSheenColor = vec4(`.concat(i,", ").concat(a,`);

            sheenBlock(
                vSheenColor,
            #ifdef SHEEN_ROUGHNESS
                `).concat(o,`,
            #endif
                roughness,
            #ifdef SHEEN_TEXTURE
                `).concat(s,`,
                1.0,
            #endif
                reflectance,
            #ifdef SHEEN_LINKWITHALBEDO
                baseColor,
                surfaceAlbedo,
            #endif
            #ifdef ENVIRONMENTBRDF
                NdotV,
                environmentBrdf,
            #endif
            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
                AARoughnessFactors,
                `).concat(e==null?void 0:e._vReflectionMicrosurfaceInfosName,`,
                `).concat(e==null?void 0:e._vReflectionInfosName,`,
                `).concat(e==null?void 0:e.reflectionColor,`,
                vLightingIntensity,
                #ifdef `).concat(e==null?void 0:e._define3DName,`
                    `).concat(e==null?void 0:e._cubeSamplerName,`,
                #else
                    `).concat(e==null?void 0:e._2DSamplerName,`,
                #endif
                reflectionOut.reflectionCoords,
                NdotVUnclamped,
                #ifndef LODBASEDMICROSFURACE
                    #ifdef `).concat(e==null?void 0:e._define3DName,`
                        `).concat(e==null?void 0:e._cubeSamplerName,`,
                        `).concat(e==null?void 0:e._cubeSamplerName,`,
                    #else
                        `).concat(e==null?void 0:e._2DSamplerName,`,
                        `).concat(e==null?void 0:e._2DSamplerName,`,
                    #endif
                #endif
                #if !defined(`).concat(e==null?void 0:e._defineSkyboxName,`) && defined(RADIANCEOCCLUSION)
                    seo,
                #endif
                #if !defined(`).concat(e==null?void 0:e._defineSkyboxName,") && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(").concat(e==null?void 0:e._define3DName,`)
                    eho,
                #endif
            #endif
                sheenOut
            );

            #ifdef SHEEN_LINKWITHALBEDO
                surfaceAlbedo = sheenOut.surfaceAlbedo;
            #endif
        #endif\r
`),t},r.prototype._buildBlock=function(e){return e.target===_.Fragment&&e.sharedData.blocksWithDefines.push(this),this},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,".albedoScaling = ").concat(this.albedoScaling,`;\r
`),e+="".concat(this._codeVariableName,".linkSheenWithAlbedo = ").concat(this.linkSheenWithAlbedo,`;\r
`),e},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.albedoScaling=this.albedoScaling,e.linkSheenWithAlbedo=this.linkSheenWithAlbedo,e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),this.albedoScaling=e.albedoScaling,this.linkSheenWithAlbedo=e.linkSheenWithAlbedo},h([H("Albedo scaling",z.Boolean,"PROPERTIES",{notifiers:{update:!0}})],r.prototype,"albedoScaling",void 0),h([H("Link sheen with albedo",z.Boolean,"PROPERTIES",{notifiers:{update:!0}})],r.prototype,"linkSheenWithAlbedo",void 0),r}(F);P("BABYLON.SheenBlock",Ir);var Fr=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t._isUnique=!0,t.registerInput("intensity",f.Float,!0,_.Fragment),t.registerInput("direction",f.Vector2,!0,_.Fragment),t.registerInput("uv",f.Vector2,!0),t.registerInput("worldTangent",f.Vector4,!0),t.registerInput("TBN",f.Object,!0,_.VertexAndFragment,new ce("TBN",t,ee.Input,pt,"TBNBlock")),t.registerOutput("anisotropy",f.Object,_.Fragment,new ce("anisotropy",t,ee.Output,r,"AnisotropyBlock")),t}return r.prototype.initialize=function(e){e._excludeVariableName("anisotropicOut"),e._excludeVariableName("TBN")},r.prototype.getClassName=function(){return"AnisotropyBlock"},Object.defineProperty(r.prototype,"intensity",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"direction",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"uv",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"worldTangent",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"TBN",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"anisotropy",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._generateTBNSpace=function(e){var t="",i="//".concat(this.name),a=this.uv,o=this.worldPositionConnectionPoint,s=this.worldNormalConnectionPoint,u=this.worldTangent;a.isConnected||console.error("You must connect the 'uv' input of the Anisotropy block!"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");var l={search:/defined\(TANGENT\)/g,replace:u.isConnected?"defined(TANGENT)":"defined(IGNORE)"},c=this.TBN;return c.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            mat3 vTBN = `.concat(c.associatedVariableName,`;
            #endif
            `):u.isConnected&&(t+="vec3 tbnNormal = normalize(".concat(s.associatedVariableName,`.xyz);\r
`),t+="vec3 tbnTangent = normalize(".concat(u.associatedVariableName,`.xyz);\r
`),t+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent);\r
`,t+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),t+=`
            #if defined(`.concat(u.isConnected?"TANGENT":"IGNORE",`) && defined(NORMAL)
                mat3 TBN = vTBN;
            #else
                mat3 TBN = cotangent_frame(`).concat(s.associatedVariableName+".xyz",", ").concat("v_"+o.associatedVariableName+".xyz",", ").concat(a.isConnected?a.associatedVariableName:"vec2(0.)",`, vec2(1., 1.));
            #endif\r
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",i,{replaceStrings:[l]}),t},r.prototype.getCode=function(e,t){t===void 0&&(t=!1);var i="";t&&(i+=this._generateTBNSpace(e));var a=this.intensity.isConnected?this.intensity.associatedVariableName:"1.0",o=this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)";return i+=`anisotropicOutParams anisotropicOut;
            anisotropicBlock(
                vec3(`.concat(o,", ").concat(a,`),
            #ifdef ANISOTROPIC_TEXTURE
                vec3(0.),
            #endif
                TBN,
                normalW,
                viewDirectionW,
                anisotropicOut
            );\r
`),i},r.prototype.prepareDefines=function(e,t,i){n.prototype.prepareDefines.call(this,e,t,i),i.setValue("ANISOTROPIC",!0),i.setValue("ANISOTROPIC_TEXTURE",!1,!0)},r.prototype._buildBlock=function(e){return e.target===_.Fragment&&e.sharedData.blocksWithDefines.push(this),this},r}(F);P("BABYLON.AnisotropyBlock",Fr);var Mr=function(n){A(r,n);function r(e){var t=n.call(this,e)||this;return t.useSphericalHarmonics=!0,t.forceIrradianceInFragment=!1,t._isUnique=!0,t.registerInput("position",f.Vector3,!1,_.Vertex),t.registerInput("world",f.Matrix,!1,_.Vertex),t.registerInput("color",f.Color3,!0,_.Fragment),t.registerOutput("reflection",f.Object,_.Fragment,new ce("reflection",t,ee.Output,r,"ReflectionBlock")),t}return r.prototype.getClassName=function(){return"ReflectionBlock"},Object.defineProperty(r.prototype,"position",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"worldPosition",{get:function(){return this.worldPositionConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"worldNormal",{get:function(){return this.worldNormalConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"world",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraPosition",{get:function(){return this.cameraPositionConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"view",{get:function(){return this.viewConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"color",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"reflection",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasTexture",{get:function(){return!!this._getTexture()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"reflectionColor",{get:function(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"},enumerable:!1,configurable:!0}),r.prototype._getTexture=function(){return this.texture?this.texture:this._scene.environmentTexture},r.prototype.prepareDefines=function(e,t,i){n.prototype.prepareDefines.call(this,e,t,i);var a=this._getTexture(),o=a&&a.getTextureMatrix;i.setValue("REFLECTION",o,!0),o&&(i.setValue(this._defineLODReflectionAlpha,a.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularReflection,a.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!a.invertZ:a.invertZ,!0),i.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),i.setValue("GAMMAREFLECTION",a.gammaSpace,!0),i.setValue("RGBDREFLECTION",a.isRGBD,!0),a&&a.coordinatesMode!==I.SKYBOX_MODE&&a.isCube&&(i.setValue("USESPHERICALFROMREFLECTIONMAP",!0),i.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this._scene.getEngine().getCaps().maxVaryingVectors<=8?i.setValue("USESPHERICALINVERTEX",!1):i.setValue("USESPHERICALINVERTEX",!0)))},r.prototype.bind=function(e,t,i,a){n.prototype.bind.call(this,e,t,i);var o=this._getTexture();if(!(!o||!a)){o.isCube?e.setTexture(this._cubeSamplerName,o):e.setTexture(this._2DSamplerName,o);var s=o.getSize().width;e.setFloat3(this._vReflectionMicrosurfaceInfosName,s,o.lodGenerationScale,o.lodGenerationOffset),e.setFloat2(this._vReflectionFilteringInfoName,s,Ze.Log2(s));var u=a.materialDefines,l=o.sphericalPolynomial;if(u.USESPHERICALFROMREFLECTIONMAP&&l)if(u.SPHERICAL_HARMONICS){var c=l.preScaledHarmonics;e.setVector3("vSphericalL00",c.l00),e.setVector3("vSphericalL1_1",c.l1_1),e.setVector3("vSphericalL10",c.l10),e.setVector3("vSphericalL11",c.l11),e.setVector3("vSphericalL2_2",c.l2_2),e.setVector3("vSphericalL2_1",c.l2_1),e.setVector3("vSphericalL20",c.l20),e.setVector3("vSphericalL21",c.l21),e.setVector3("vSphericalL22",c.l22)}else e.setFloat3("vSphericalX",l.x.x,l.x.y,l.x.z),e.setFloat3("vSphericalY",l.y.x,l.y.y,l.y.z),e.setFloat3("vSphericalZ",l.z.x,l.z.y,l.z.z),e.setFloat3("vSphericalXX_ZZ",l.xx.x-l.zz.x,l.xx.y-l.zz.y,l.xx.z-l.zz.z),e.setFloat3("vSphericalYY_ZZ",l.yy.x-l.zz.x,l.yy.y-l.zz.y,l.yy.z-l.zz.z),e.setFloat3("vSphericalZZ",l.zz.x,l.zz.y,l.zz.z),e.setFloat3("vSphericalXY",l.xy.x,l.xy.y,l.xy.z),e.setFloat3("vSphericalYZ",l.yz.x,l.yz.y,l.yz.z),e.setFloat3("vSphericalZX",l.zx.x,l.zx.y,l.zx.z)}},r.prototype.handleVertexSide=function(e){var t=n.prototype.handleVertexSide.call(this,e);e._emitFunctionFromInclude("harmonicsFunctions","//".concat(this.name),{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});var i=e._getFreeVariableName("reflectionVector");return this._vEnvironmentIrradianceName=e._getFreeVariableName("vEnvironmentIrradiance"),e._emitVaryingFromString(this._vEnvironmentIrradianceName,"vec3","defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),e._emitUniformFromString("vSphericalL00","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL1_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL10","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL11","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_2","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL20","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL21","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL22","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalX","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXX_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYY_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZX","vec3","SPHERICAL_HARMONICS",!0),t+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
                vec3 `.concat(i," = vec3(").concat(this._reflectionMatrixName," * vec4(normalize(").concat(this.worldNormal.associatedVariableName,`).xyz, 0)).xyz;
                #ifdef `).concat(this._defineOppositeZ,`
                    `).concat(i,`.z *= -1.0;
                #endif
                `).concat(this._vEnvironmentIrradianceName," = computeEnvironmentIrradiance(").concat(i,`);
            #endif\r
`),t},r.prototype.getCode=function(e,t){var i="";this.handleFragmentSideInits(e),e._emitFunctionFromInclude("harmonicsFunctions","//".concat(this.name),{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),e._emitFunction("sampleReflection",`
            #ifdef `.concat(this._define3DName,`
                #define sampleReflection(s, c) textureCube(s, c)
            #else
                #define sampleReflection(s, c) texture2D(s, c)
            #endif\r
`),"//".concat(this.name)),e._emitFunction("sampleReflectionLod",`
            #ifdef `.concat(this._define3DName,`
                #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)
            #else
                #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)
            #endif\r
`),"//".concat(this.name));var a=`
            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {
                `.concat(this.handleFragmentSideCodeReflectionCoords("worldNormal","worldPos",!0,!0),`
                return `).concat(this._reflectionVectorName,`;
            }\r
`);return e._emitFunction("computeReflectionCoordsPBR",a,"//".concat(this.name)),this._vReflectionMicrosurfaceInfosName=e._getFreeVariableName("vReflectionMicrosurfaceInfos"),e._emitUniformFromString(this._vReflectionMicrosurfaceInfosName,"vec3"),this._vReflectionInfosName=e._getFreeVariableName("vReflectionInfos"),this._vReflectionFilteringInfoName=e._getFreeVariableName("vReflectionFilteringInfo"),e._emitUniformFromString(this._vReflectionFilteringInfoName,"vec2"),i+=`#ifdef REFLECTION
            vec2 `.concat(this._vReflectionInfosName,` = vec2(1., 0.);

            reflectionOutParams reflectionOut;

            reflectionBlock(
                `).concat("v_"+this.worldPosition.associatedVariableName+".xyz",`,
                `).concat(t,`,
                alphaG,
                `).concat(this._vReflectionMicrosurfaceInfosName,`,
                `).concat(this._vReflectionInfosName,`,
                `).concat(this.reflectionColor,`,
            #ifdef ANISOTROPIC
                anisotropicOut,
            #endif
            #if defined(`).concat(this._defineLODReflectionAlpha,") && !defined(").concat(this._defineSkyboxName,`)
                NdotVUnclamped,
            #endif
            #ifdef `).concat(this._defineLinearSpecularReflection,`
                roughness,
            #endif
            #ifdef `).concat(this._define3DName,`
                `).concat(this._cubeSamplerName,`,
            #else
                `).concat(this._2DSamplerName,`,
            #endif
            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)
                `).concat(this._vEnvironmentIrradianceName,`,
            #endif
            #ifdef USESPHERICALFROMREFLECTIONMAP
                #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                    `).concat(this._reflectionMatrixName,`,
                #endif
            #endif
            #ifdef USEIRRADIANCEMAP
                irradianceSampler, // ** not handled **
            #endif
            #ifndef LODBASEDMICROSFURACE
                #ifdef `).concat(this._define3DName,`
                    `).concat(this._cubeSamplerName,`,
                    `).concat(this._cubeSamplerName,`,
                #else
                    `).concat(this._2DSamplerName,`,
                    `).concat(this._2DSamplerName,`,
                #endif
            #endif
            #ifdef REALTIME_FILTERING
                `).concat(this._vReflectionFilteringInfoName,`,
            #endif
                reflectionOut
            );
        #endif\r
`),i},r.prototype._buildBlock=function(e){return this._scene=e.sharedData.scene,e.target!==_.Fragment&&(this._defineLODReflectionAlpha=e._getFreeDefineName("LODINREFLECTIONALPHA"),this._defineLinearSpecularReflection=e._getFreeDefineName("LINEARSPECULARREFLECTION")),this},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return this.texture&&(e+="".concat(this._codeVariableName,".texture.gammaSpace = ").concat(this.texture.gammaSpace,`;\r
`)),e+="".concat(this._codeVariableName,".useSphericalHarmonics = ").concat(this.useSphericalHarmonics,`;\r
`),e+="".concat(this._codeVariableName,".forceIrradianceInFragment = ").concat(this.forceIrradianceInFragment,`;\r
`),e},r.prototype.serialize=function(){var e,t,i=n.prototype.serialize.call(this);return i.useSphericalHarmonics=this.useSphericalHarmonics,i.forceIrradianceInFragment=this.forceIrradianceInFragment,i.gammaSpace=(t=(e=this.texture)===null||e===void 0?void 0:e.gammaSpace)!==null&&t!==void 0?t:!0,i},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),this.useSphericalHarmonics=e.useSphericalHarmonics,this.forceIrradianceInFragment=e.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=e.gammaSpace)},h([H("Spherical Harmonics",z.Boolean,"ADVANCED",{notifiers:{update:!0}})],r.prototype,"useSphericalHarmonics",void 0),h([H("Force irradiance in fragment",z.Boolean,"ADVANCED",{notifiers:{update:!0}})],r.prototype,"forceIrradianceInFragment",void 0),r}(qt);P("BABYLON.ReflectionBlock",Mr);var Ht=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t.remapF0OnInterfaceChange=!0,t._isUnique=!0,t.registerInput("intensity",f.Float,!1,_.Fragment),t.registerInput("roughness",f.Float,!0,_.Fragment),t.registerInput("indexOfRefraction",f.Float,!0,_.Fragment),t.registerInput("normalMapColor",f.Color3,!0,_.Fragment),t.registerInput("uv",f.Vector2,!0,_.Fragment),t.registerInput("tintColor",f.Color3,!0,_.Fragment),t.registerInput("tintAtDistance",f.Float,!0,_.Fragment),t.registerInput("tintThickness",f.Float,!0,_.Fragment),t.registerInput("worldTangent",f.Vector4,!0),t.registerInput("worldNormal",f.Vector4,!0),t.worldNormal.acceptedConnectionPointTypes.push(f.Vector3),t.registerInput("TBN",f.Object,!0,_.VertexAndFragment,new ce("TBN",t,ee.Input,pt,"TBNBlock")),t.registerOutput("clearcoat",f.Object,_.Fragment,new ce("clearcoat",t,ee.Output,r,"ClearCoatBlock")),t}return r.prototype.initialize=function(e){e._excludeVariableName("clearcoatOut"),e._excludeVariableName("vClearCoatParams"),e._excludeVariableName("vClearCoatTintParams"),e._excludeVariableName("vClearCoatRefractionParams"),e._excludeVariableName("vClearCoatTangentSpaceParams"),e._excludeVariableName("vGeometricNormaClearCoatW")},r.prototype.getClassName=function(){return"ClearCoatBlock"},Object.defineProperty(r.prototype,"intensity",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"roughness",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"indexOfRefraction",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"normalMapColor",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"uv",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"tintColor",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"tintAtDistance",{get:function(){return this._inputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"tintThickness",{get:function(){return this._inputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"worldTangent",{get:function(){return this._inputs[8]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"worldNormal",{get:function(){return this._inputs[9]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"TBN",{get:function(){return this._inputs[10]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"clearcoat",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype.autoConfigure=function(){if(!this.intensity.isConnected){var e=new B("ClearCoat intensity",_.Fragment,f.Float);e.value=1,e.output.connectTo(this.intensity)}},r.prototype.prepareDefines=function(e,t,i){n.prototype.prepareDefines.call(this,e,t,i),i.setValue("CLEARCOAT",!0),i.setValue("CLEARCOAT_TEXTURE",!1,!0),i.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),i.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),i.setValue("CLEARCOAT_DEFAULTIOR",this.indexOfRefraction.isConnected?this.indexOfRefraction.connectInputBlock.value===zt._DefaultIndexOfRefraction:!0,!0),i.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)},r.prototype.bind=function(e,t,i){var a,o;n.prototype.bind.call(this,e,t,i);var s=(o=(a=this.indexOfRefraction.connectInputBlock)===null||a===void 0?void 0:a.value)!==null&&o!==void 0?o:zt._DefaultIndexOfRefraction,u=1-s,l=1+s,c=Math.pow(-u/l,2),p=1/s;e.setFloat4("vClearCoatRefractionParams",c,p,u,l);var d=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,g=d!=null&&d.perturbedNormal.isConnected?d.perturbedNormal.connectedPoint.ownerBlock:null;this._scene._mirroredCameraPosition?e.setFloat2("vClearCoatTangentSpaceParams",g!=null&&g.invertX?1:-1,g!=null&&g.invertY?1:-1):e.setFloat2("vClearCoatTangentSpaceParams",g!=null&&g.invertX?-1:1,g!=null&&g.invertY?-1:1)},r.prototype._generateTBNSpace=function(e,t,i){var a="",o="//".concat(this.name),s=this.worldTangent;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");var u={search:/defined\(TANGENT\)/g,replace:s.isConnected?"defined(TANGENT)":"defined(IGNORE)"},l=this.TBN;return l.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            mat3 vTBN = `.concat(l.associatedVariableName,`;
            #endif
            `):s.isConnected&&(a+="vec3 tbnNormal = normalize(".concat(i,`.xyz);\r
`),a+="vec3 tbnTangent = normalize(".concat(s.associatedVariableName,`.xyz);\r
`),a+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent);\r
`,a+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",o,{replaceStrings:[u]}),a},r.GetCode=function(e,t,i,a,o,s,u){var l="",c=t!=null&&t.intensity.isConnected?t.intensity.associatedVariableName:"1.",p=t!=null&&t.roughness.isConnected?t.roughness.associatedVariableName:"0.",d=t!=null&&t.normalMapColor.isConnected?t.normalMapColor.associatedVariableName:"vec3(0.)",g=t!=null&&t.uv.isConnected?t.uv.associatedVariableName:"vec2(0.)",m=t!=null&&t.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",y=t!=null&&t.tintThickness.isConnected?t.tintThickness.associatedVariableName:"1.",v=t!=null&&t.tintAtDistance.isConnected?t.tintAtDistance.associatedVariableName:"1.",T="vec4(0.)";if(t){e._emitUniformFromString("vClearCoatRefractionParams","vec4"),e._emitUniformFromString("vClearCoatTangentSpaceParams","vec2");var x=t.worldNormal;l+="vec3 vGeometricNormaClearCoatW = ".concat(x.isConnected?"normalize("+x.associatedVariableName+".xyz)":"geometricNormalW",`;\r
`)}else l+=`vec3 vGeometricNormaClearCoatW = geometricNormalW;\r
`;return o&&t&&(l+=t._generateTBNSpace(e,a,u),s=t.worldTangent.isConnected),l+=`clearcoatOutParams clearcoatOut;

        #ifdef CLEARCOAT
            vec2 vClearCoatParams = vec2(`.concat(c,", ").concat(p,`);
            vec4 vClearCoatTintParams = vec4(`).concat(m,", ").concat(y,`);

            clearcoatBlock(
                `).concat(a,`.xyz,
                vGeometricNormaClearCoatW,
                viewDirectionW,
                vClearCoatParams,
                specularEnvironmentR0,
            #ifdef CLEARCOAT_TEXTURE
                vec2(0.),
            #endif
            #ifdef CLEARCOAT_TINT
                vClearCoatTintParams,
                `).concat(v,`,
                vClearCoatRefractionParams,
                #ifdef CLEARCOAT_TINT_TEXTURE
                    `).concat(T,`,
                #endif
            #endif
            #ifdef CLEARCOAT_BUMP
                vec2(0., 1.),
                vec4(`).concat(d,`, 0.),
                `).concat(g,`,
                #if defined(`).concat(s?"TANGENT":"IGNORE",`) && defined(NORMAL)
                    vTBN,
                #else
                    vClearCoatTangentSpaceParams,
                #endif
                #ifdef OBJECTSPACE_NORMALMAP
                    normalMatrix,
                #endif
            #endif
            #if defined(FORCENORMALFORWARD) && defined(NORMAL)
                faceNormal,
            #endif
            #ifdef REFLECTION
                `).concat(i==null?void 0:i._vReflectionMicrosurfaceInfosName,`,
                `).concat(i==null?void 0:i._vReflectionInfosName,`,
                `).concat(i==null?void 0:i.reflectionColor,`,
                vLightingIntensity,
                #ifdef `).concat(i==null?void 0:i._define3DName,`
                    `).concat(i==null?void 0:i._cubeSamplerName,`,
                #else
                    `).concat(i==null?void 0:i._2DSamplerName,`,
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef `).concat(i==null?void 0:i._define3DName,`
                        `).concat(i==null?void 0:i._cubeSamplerName,`,
                        `).concat(i==null?void 0:i._cubeSamplerName,`,
                    #else
                        `).concat(i==null?void 0:i._2DSamplerName,`,
                        `).concat(i==null?void 0:i._2DSamplerName,`,
                    #endif
                #endif
            #endif
            #if defined(ENVIRONMENTBRDF) && !defined(`).concat(i==null?void 0:i._defineSkyboxName,`)
                #ifdef RADIANCEOCCLUSION
                    ambientMonochrome,
                #endif
            #endif
            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
                (gl_FrontFacing ? 1. : -1.),
            #endif
                clearcoatOut
            );
        #else
            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;
        #endif\r
`),l},r.prototype._buildBlock=function(e){return this._scene=e.sharedData.scene,e.target===_.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,".remapF0OnInterfaceChange = ").concat(this.remapF0OnInterfaceChange,`;\r
`),e},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,e},r.prototype._deserialize=function(e,t,i){var a;n.prototype._deserialize.call(this,e,t,i),this.remapF0OnInterfaceChange=(a=e.remapF0OnInterfaceChange)!==null&&a!==void 0?a:!0},h([H("Remap F0 on interface change",z.Boolean,"ADVANCED")],r.prototype,"remapF0OnInterfaceChange",void 0),r}(F);P("BABYLON.ClearCoatBlock",Ht);var jt=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t._isUnique=!0,t.registerInput("intensity",f.Float,!0,_.Fragment),t.registerInput("indexOfRefraction",f.Float,!0,_.Fragment),t.registerInput("thickness",f.Float,!0,_.Fragment),t.registerOutput("iridescence",f.Object,_.Fragment,new ce("iridescence",t,ee.Output,r,"IridescenceBlock")),t}return r.prototype.initialize=function(e){e._excludeVariableName("iridescenceOut"),e._excludeVariableName("vIridescenceParams")},r.prototype.getClassName=function(){return"IridescenceBlock"},Object.defineProperty(r.prototype,"intensity",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"indexOfRefraction",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"thickness",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"iridescence",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype.autoConfigure=function(){if(!this.intensity.isConnected){var e=new B("Iridescence intensity",_.Fragment,f.Float);e.value=1,e.output.connectTo(this.intensity);var t=new B("Iridescence ior",_.Fragment,f.Float);t.value=1.3,t.output.connectTo(this.indexOfRefraction);var i=new B("Iridescence thickness",_.Fragment,f.Float);i.value=400,i.output.connectTo(this.thickness)}},r.prototype.prepareDefines=function(e,t,i){n.prototype.prepareDefines.call(this,e,t,i),i.setValue("IRIDESCENCE",!0,!0),i.setValue("IRIDESCENCE_TEXTURE",!1,!0),i.setValue("IRIDESCENCE_THICKNESS_TEXTURE",!1,!0)},r.GetCode=function(e){var t="",i=e!=null&&e.intensity.isConnected?e.intensity.associatedVariableName:"1.",a=e!=null&&e.indexOfRefraction.isConnected?e.indexOfRefraction.associatedVariableName:Gt._DefaultIndexOfRefraction,o=e!=null&&e.thickness.isConnected?e.thickness.associatedVariableName:Gt._DefaultMaximumThickness;return t+=`iridescenceOutParams iridescenceOut;

        #ifdef IRIDESCENCE
            iridescenceBlock(
                vec4(`.concat(i,", ").concat(a,", 1., ").concat(o,`),
                NdotV,
                specularEnvironmentR0,
                #ifdef CLEARCOAT
                    NdotVUnclamped,
                #endif
                iridescenceOut
            );

            float iridescenceIntensity = iridescenceOut.iridescenceIntensity;
            specularEnvironmentR0 = iridescenceOut.specularEnvironmentR0;
        #endif\r
`),t},r.prototype._buildBlock=function(e){return e.target===_.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i)},r}(F);P("BABYLON.IridescenceBlock",jt);var Dr=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t.linkRefractionWithTransparency=!1,t.invertRefractionY=!1,t.useThicknessAsDepth=!1,t._isUnique=!0,t.registerInput("intensity",f.Float,!1,_.Fragment),t.registerInput("tintAtDistance",f.Float,!0,_.Fragment),t.registerInput("volumeIndexOfRefraction",f.Float,!0,_.Fragment),t.registerOutput("refraction",f.Object,_.Fragment,new ce("refraction",t,ee.Output,r,"RefractionBlock")),t}return r.prototype.initialize=function(e){e._excludeVariableName("vRefractionPosition"),e._excludeVariableName("vRefractionSize")},r.prototype.getClassName=function(){return"RefractionBlock"},Object.defineProperty(r.prototype,"intensity",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"tintAtDistance",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"volumeIndexOfRefraction",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"view",{get:function(){return this.viewConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"refraction",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasTexture",{get:function(){return!!this._getTexture()},enumerable:!1,configurable:!0}),r.prototype._getTexture=function(){return this.texture?this.texture:this._scene.environmentTexture},r.prototype.autoConfigure=function(e){if(!this.intensity.isConnected){var t=new B("Refraction intensity",_.Fragment,f.Float);t.value=1,t.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){var i=e.getInputBlockByPredicate(function(a){return a.systemValue===V.View});i||(i=new B("view"),i.setAsSystemValue(V.View)),i.output.connectTo(this.view)}},r.prototype.prepareDefines=function(e,t,i){n.prototype.prepareDefines.call(this,e,t,i);var a=this._getTexture(),o=a&&a.getTextureMatrix;i.setValue("SS_REFRACTION",o,!0),o&&(i.setValue(this._define3DName,a.isCube,!0),i.setValue(this._defineLODRefractionAlpha,a.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularRefraction,a.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!a.invertZ:a.invertZ,!0),i.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),i.setValue("SS_GAMMAREFRACTION",a.gammaSpace,!0),i.setValue("SS_RGBDREFRACTION",a.isRGBD,!0),i.setValue("SS_USE_LOCAL_REFRACTIONMAP_CUBIC",!!a.boundingBoxSize,!0),i.setValue("SS_USE_THICKNESS_AS_DEPTH",this.useThicknessAsDepth,!0))},r.prototype.isReady=function(){var e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())},r.prototype.bind=function(e,t,i){var a,o,s,u;n.prototype.bind.call(this,e,t,i);var l=this._getTexture();if(!!l){l.isCube?e.setTexture(this._cubeSamplerName,l):e.setTexture(this._2DSamplerName,l),e.setMatrix(this._refractionMatrixName,l.getReflectionTextureMatrix());var c=1;l.isCube||l.depth&&(c=l.depth);var p=(u=(o=(a=this.volumeIndexOfRefraction.connectInputBlock)===null||a===void 0?void 0:a.value)!==null&&o!==void 0?o:(s=this.indexOfRefractionConnectionPoint.connectInputBlock)===null||s===void 0?void 0:s.value)!==null&&u!==void 0?u:1.5;e.setFloat4(this._vRefractionInfosName,l.level,1/p,c,this.invertRefractionY?-1:1),e.setFloat4(this._vRefractionMicrosurfaceInfosName,l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset,1/p);var d=l.getSize().width;if(e.setFloat2(this._vRefractionFilteringInfoName,d,Ze.Log2(d)),l.boundingBoxSize){var g=l;e.setVector3("vRefractionPosition",g.boundingBoxPosition),e.setVector3("vRefractionSize",g.boundingBoxSize)}}},r.prototype.getCode=function(e){var t="";return e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),this._define3DName=e._getFreeDefineName("SS_REFRACTIONMAP_3D"),e._samplerDeclaration+="#ifdef ".concat(this._define3DName,`\r
`),e._samplerDeclaration+="uniform samplerCube ".concat(this._cubeSamplerName,`;\r
`),e._samplerDeclaration+=`#else\r
`,e._samplerDeclaration+="uniform sampler2D ".concat(this._2DSamplerName,`;\r
`),e._samplerDeclaration+=`#endif\r
`,e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._defineLODRefractionAlpha=e._getFreeDefineName("SS_LODINREFRACTIONALPHA"),this._defineLinearSpecularRefraction=e._getFreeDefineName("SS_LINEARSPECULARREFRACTION"),this._defineOppositeZ=e._getFreeDefineName("SS_REFRACTIONMAP_OPPOSITEZ"),this._refractionMatrixName=e._getFreeVariableName("refractionMatrix"),e._emitUniformFromString(this._refractionMatrixName,"mat4"),e._emitFunction("sampleRefraction",`
            #ifdef `.concat(this._define3DName,`
                #define sampleRefraction(s, c) textureCube(s, c)
            #else
                #define sampleRefraction(s, c) texture2D(s, c)
            #endif\r
`),"//".concat(this.name)),e._emitFunction("sampleRefractionLod",`
            #ifdef `.concat(this._define3DName,`
                #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)
            #else
                #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)
            #endif\r
`),"//".concat(this.name)),this._vRefractionMicrosurfaceInfosName=e._getFreeVariableName("vRefractionMicrosurfaceInfos"),e._emitUniformFromString(this._vRefractionMicrosurfaceInfosName,"vec4"),this._vRefractionInfosName=e._getFreeVariableName("vRefractionInfos"),e._emitUniformFromString(this._vRefractionInfosName,"vec4"),this._vRefractionFilteringInfoName=e._getFreeVariableName("vRefractionFilteringInfo"),e._emitUniformFromString(this._vRefractionFilteringInfoName,"vec2"),e._emitUniformFromString("vRefractionPosition","vec3"),e._emitUniformFromString("vRefractionSize","vec3"),t},r.prototype._buildBlock=function(e){return this._scene=e.sharedData.scene,this},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return this.texture&&(this.texture.isCube?e="".concat(this._codeVariableName,'.texture = new BABYLON.CubeTexture("').concat(this.texture.name,`");\r
`):e="".concat(this._codeVariableName,'.texture = new BABYLON.Texture("').concat(this.texture.name,`");\r
`),e+="".concat(this._codeVariableName,".texture.coordinatesMode = ").concat(this.texture.coordinatesMode,`;\r
`)),e+="".concat(this._codeVariableName,".linkRefractionWithTransparency = ").concat(this.linkRefractionWithTransparency,`;\r
`),e+="".concat(this._codeVariableName,".invertRefractionY = ").concat(this.invertRefractionY,`;\r
`),e+="".concat(this._codeVariableName,".useThicknessAsDepth = ").concat(this.useThicknessAsDepth,`;\r
`),e},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.linkRefractionWithTransparency=this.linkRefractionWithTransparency,e.invertRefractionY=this.invertRefractionY,e.useThicknessAsDepth=this.useThicknessAsDepth,e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,e.texture.isCube?this.texture=et.Parse(e.texture,t,i):this.texture=I.Parse(e.texture,t,i)),this.linkRefractionWithTransparency=e.linkRefractionWithTransparency,this.invertRefractionY=e.invertRefractionY,this.useThicknessAsDepth=!!e.useThicknessAsDepth},h([H("Link refraction to transparency",z.Boolean,"ADVANCED",{notifiers:{update:!0}})],r.prototype,"linkRefractionWithTransparency",void 0),h([H("Invert refraction Y",z.Boolean,"ADVANCED",{notifiers:{update:!0}})],r.prototype,"invertRefractionY",void 0),h([H("Use thickness as depth",z.Boolean,"ADVANCED",{notifiers:{update:!0}})],r.prototype,"useThicknessAsDepth",void 0),r}(F);P("BABYLON.RefractionBlock",Dr);var Wt=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Fragment)||this;return t._isUnique=!0,t.registerInput("thickness",f.Float,!1,_.Fragment),t.registerInput("tintColor",f.Color3,!0,_.Fragment),t.registerInput("translucencyIntensity",f.Float,!0,_.Fragment),t.registerInput("translucencyDiffusionDist",f.Color3,!0,_.Fragment),t.registerInput("refraction",f.Object,!0,_.Fragment,new ce("refraction",t,ee.Input,Dr,"RefractionBlock")),t.registerOutput("subsurface",f.Object,_.Fragment,new ce("subsurface",t,ee.Output,r,"SubSurfaceBlock")),t}return r.prototype.initialize=function(e){e._excludeVariableName("subSurfaceOut"),e._excludeVariableName("vThicknessParam"),e._excludeVariableName("vTintColor"),e._excludeVariableName("vSubSurfaceIntensity")},r.prototype.getClassName=function(){return"SubSurfaceBlock"},Object.defineProperty(r.prototype,"thickness",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"tintColor",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"translucencyIntensity",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"translucencyDiffusionDist",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"refraction",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"subsurface",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype.autoConfigure=function(){if(!this.thickness.isConnected){var e=new B("SubSurface thickness",_.Fragment,f.Float);e.value=0,e.output.connectTo(this.thickness)}},r.prototype.prepareDefines=function(e,t,i){n.prototype.prepareDefines.call(this,e,t,i);var a=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;i.setValue("SUBSURFACE",a||this.refraction.isConnected,!0),i.setValue("SS_TRANSLUCENCY",a,!0),i.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),i.setValue("SS_REFRACTIONINTENSITY_TEXTURE",!1,!0),i.setValue("SS_TRANSLUCENCYINTENSITY_TEXTURE",!1,!0),i.setValue("SS_MASK_FROM_THICKNESS_TEXTURE",!1,!0),i.setValue("SS_USE_GLTF_TEXTURES",!1,!0)},r.GetCode=function(e,t,i,a){var o,s,u,l,c,p,d,g,m,y,v,T,x,E,O,N,w="",k=t!=null&&t.thickness.isConnected?t.thickness.associatedVariableName:"0.",W=t!=null&&t.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",Z=t!=null&&t.translucencyIntensity.isConnected?t==null?void 0:t.translucencyIntensity.associatedVariableName:"1.",ie=t!=null&&t.translucencyDiffusionDist.isConnected?t==null?void 0:t.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",D=t!=null&&t.refraction.isConnected?(o=t==null?void 0:t.refraction.connectedPoint)===null||o===void 0?void 0:o.ownerBlock:null,ne=D!=null&&D.tintAtDistance.isConnected?D.tintAtDistance.associatedVariableName:"1.",he=D!=null&&D.intensity.isConnected?D.intensity.associatedVariableName:"1.",oe=D!=null&&D.view.isConnected?D.view.associatedVariableName:"";return w+=(s=D==null?void 0:D.getCode(e))!==null&&s!==void 0?s:"",w+=`subSurfaceOutParams subSurfaceOut;

        #ifdef SUBSURFACE
            vec2 vThicknessParam = vec2(0., `.concat(k,`);
            vec4 vTintColor = vec4(`).concat(W,", ").concat(ne,`);
            vec3 vSubSurfaceIntensity = vec3(`).concat(he,", ").concat(Z,`, 0.);

            subSurfaceBlock(
                vSubSurfaceIntensity,
                vThicknessParam,
                vTintColor,
                normalW,
                specularEnvironmentReflectance,
            #ifdef SS_THICKNESSANDMASK_TEXTURE
                vec4(0.),
            #endif
            #ifdef REFLECTION
                #ifdef SS_TRANSLUCENCY
                    `).concat(i==null?void 0:i._reflectionMatrixName,`,
                    #ifdef USESPHERICALFROMREFLECTIONMAP
                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                            reflectionOut.irradianceVector,
                        #endif
                        #if defined(REALTIME_FILTERING)
                            `).concat(i==null?void 0:i._cubeSamplerName,`,
                            `).concat(i==null?void 0:i._vReflectionFilteringInfoName,`,
                        #endif
                        #endif
                    #ifdef USEIRRADIANCEMAP
                        irradianceSampler,
                    #endif
                #endif
            #endif
            #if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
                surfaceAlbedo,
            #endif
            #ifdef SS_REFRACTION
                `).concat(a,`.xyz,
                viewDirectionW,
                `).concat(oe,`,
                `).concat((u=D==null?void 0:D._vRefractionInfosName)!==null&&u!==void 0?u:"",`,
                `).concat((l=D==null?void 0:D._refractionMatrixName)!==null&&l!==void 0?l:"",`,
                `).concat((c=D==null?void 0:D._vRefractionMicrosurfaceInfosName)!==null&&c!==void 0?c:"",`,
                vLightingIntensity,
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    alpha,
                #endif
                #ifdef `).concat((p=D==null?void 0:D._defineLODRefractionAlpha)!==null&&p!==void 0?p:"IGNORE",`
                    NdotVUnclamped,
                #endif
                #ifdef `).concat((d=D==null?void 0:D._defineLinearSpecularRefraction)!==null&&d!==void 0?d:"IGNORE",`
                    roughness,
                #endif
                alphaG,
                #ifdef `).concat((g=D==null?void 0:D._define3DName)!==null&&g!==void 0?g:"IGNORE",`
                    `).concat((m=D==null?void 0:D._cubeSamplerName)!==null&&m!==void 0?m:"",`,
                #else
                    `).concat((y=D==null?void 0:D._2DSamplerName)!==null&&y!==void 0?y:"",`,
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef `).concat((v=D==null?void 0:D._define3DName)!==null&&v!==void 0?v:"IGNORE",`
                        `).concat((T=D==null?void 0:D._cubeSamplerName)!==null&&T!==void 0?T:"",`,
                        `).concat((x=D==null?void 0:D._cubeSamplerName)!==null&&x!==void 0?x:"",`,
                    #else
                        `).concat((E=D==null?void 0:D._2DSamplerName)!==null&&E!==void 0?E:"",`,
                        `).concat((O=D==null?void 0:D._2DSamplerName)!==null&&O!==void 0?O:"",`,
                    #endif
                #endif
                #ifdef ANISOTROPIC
                    anisotropicOut,
                #endif
                #ifdef REALTIME_FILTERING
                    `).concat((N=D==null?void 0:D._vRefractionFilteringInfoName)!==null&&N!==void 0?N:"",`,
                #endif
                #ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
                    vRefractionPosition,
                    vRefractionSize,
                #endif
            #endif
            #ifdef SS_TRANSLUCENCY
                `).concat(ie,`,
            #endif
                subSurfaceOut
            );

            #ifdef SS_REFRACTION
                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    alpha = subSurfaceOut.alpha;
                #endif
            #endif
        #else
            subSurfaceOut.specularEnvironmentReflectance = specularEnvironmentReflectance;
        #endif\r
`),w},r.prototype._buildBlock=function(e){return e.target===_.Fragment&&e.sharedData.blocksWithDefines.push(this),this},r}(F);P("BABYLON.SubSurfaceBlock",Wt);var fa={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["shadow",""],alpha:["alpha",""]},pa=function(n){A(r,n);function r(e){var t=n.call(this,e,_.VertexAndFragment)||this;return t._environmentBRDFTexture=null,t._metallicReflectanceColor=G.White(),t._metallicF0Factor=1,t.directIntensity=1,t.environmentIntensity=1,t.specularIntensity=1,t.lightFalloff=0,t.useAlphaTest=!1,t.alphaTestCutoff=.5,t.useAlphaBlending=!1,t.useRadianceOverAlpha=!0,t.useSpecularOverAlpha=!0,t.enableSpecularAntiAliasing=!1,t.realTimeFiltering=!1,t.realTimeFilteringQuality=8,t.useEnergyConservation=!0,t.useRadianceOcclusion=!0,t.useHorizonOcclusion=!0,t.unlit=!1,t.forceNormalForward=!1,t.debugMode=0,t.debugLimit=0,t.debugFactor=1,t._isUnique=!0,t.registerInput("worldPosition",f.Vector4,!1,_.Vertex),t.registerInput("worldNormal",f.Vector4,!1,_.Fragment),t.registerInput("view",f.Matrix,!1),t.registerInput("cameraPosition",f.Vector3,!1,_.Fragment),t.registerInput("perturbedNormal",f.Vector4,!0,_.Fragment),t.registerInput("baseColor",f.Color3,!0,_.Fragment),t.registerInput("metallic",f.Float,!1,_.Fragment),t.registerInput("roughness",f.Float,!1,_.Fragment),t.registerInput("ambientOcc",f.Float,!0,_.Fragment),t.registerInput("opacity",f.Float,!0,_.Fragment),t.registerInput("indexOfRefraction",f.Float,!0,_.Fragment),t.registerInput("ambientColor",f.Color3,!0,_.Fragment),t.registerInput("reflection",f.Object,!0,_.Fragment,new ce("reflection",t,ee.Input,Mr,"ReflectionBlock")),t.registerInput("clearcoat",f.Object,!0,_.Fragment,new ce("clearcoat",t,ee.Input,Ht,"ClearCoatBlock")),t.registerInput("sheen",f.Object,!0,_.Fragment,new ce("sheen",t,ee.Input,Ir,"SheenBlock")),t.registerInput("subsurface",f.Object,!0,_.Fragment,new ce("subsurface",t,ee.Input,Wt,"SubSurfaceBlock")),t.registerInput("anisotropy",f.Object,!0,_.Fragment,new ce("anisotropy",t,ee.Input,Fr,"AnisotropyBlock")),t.registerInput("iridescence",f.Object,!0,_.Fragment,new ce("iridescence",t,ee.Input,jt,"IridescenceBlock")),t.registerOutput("ambientClr",f.Color3,_.Fragment),t.registerOutput("diffuseDir",f.Color3,_.Fragment),t.registerOutput("specularDir",f.Color3,_.Fragment),t.registerOutput("clearcoatDir",f.Color3,_.Fragment),t.registerOutput("sheenDir",f.Color3,_.Fragment),t.registerOutput("diffuseInd",f.Color3,_.Fragment),t.registerOutput("specularInd",f.Color3,_.Fragment),t.registerOutput("clearcoatInd",f.Color3,_.Fragment),t.registerOutput("sheenInd",f.Color3,_.Fragment),t.registerOutput("refraction",f.Color3,_.Fragment),t.registerOutput("lighting",f.Color3,_.Fragment),t.registerOutput("shadow",f.Float,_.Fragment),t.registerOutput("alpha",f.Float,_.Fragment),t}return r.prototype.initialize=function(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode")},r.prototype.getClassName=function(){return"PBRMetallicRoughnessBlock"},Object.defineProperty(r.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"worldNormal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"view",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cameraPosition",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"perturbedNormal",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"baseColor",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"metallic",{get:function(){return this._inputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"roughness",{get:function(){return this._inputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"ambientOcc",{get:function(){return this._inputs[8]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"opacity",{get:function(){return this._inputs[9]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"indexOfRefraction",{get:function(){return this._inputs[10]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"ambientColor",{get:function(){return this._inputs[11]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"reflection",{get:function(){return this._inputs[12]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"clearcoat",{get:function(){return this._inputs[13]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"sheen",{get:function(){return this._inputs[14]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"subsurface",{get:function(){return this._inputs[15]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"anisotropy",{get:function(){return this._inputs[16]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"iridescence",{get:function(){return this._inputs[17]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"ambientClr",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"diffuseDir",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"specularDir",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"clearcoatDir",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"sheenDir",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"diffuseInd",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"specularInd",{get:function(){return this._outputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"clearcoatInd",{get:function(){return this._outputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"sheenInd",{get:function(){return this._outputs[8]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"refraction",{get:function(){return this._outputs[9]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"lighting",{get:function(){return this._outputs[10]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"shadow",{get:function(){return this._outputs[11]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"alpha",{get:function(){return this._outputs[12]},enumerable:!1,configurable:!0}),r.prototype.autoConfigure=function(e){if(!this.cameraPosition.isConnected){var t=e.getInputBlockByPredicate(function(a){return a.systemValue===V.CameraPosition});t||(t=new B("cameraPosition"),t.setAsSystemValue(V.CameraPosition)),t.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){var i=e.getInputBlockByPredicate(function(a){return a.systemValue===V.View});i||(i=new B("view"),i.setAsSystemValue(V.View)),i.output.connectTo(this.view)}},r.prototype.prepareDefines=function(e,t,i){i.setValue("PBR",!0),i.setValue("METALLICWORKFLOW",!0),i.setValue("DEBUGMODE",this.debugMode,!0),i.setValue("NORMALXYSCALE",!0),i.setValue("BUMP",this.perturbedNormal.isConnected,!0),i.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),i.setValue("ALBEDO",!1,!0),i.setValue("OPACITY",this.opacity.isConnected,!0),i.setValue("AMBIENT",!0,!0),i.setValue("AMBIENTINGRAYSCALE",!1,!0),i.setValue("REFLECTIVITY",!1,!0),i.setValue("AOSTOREINMETALMAPRED",!1,!0),i.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===pe.LIGHTFALLOFF_STANDARD?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===pe.LIGHTFALLOFF_GLTF?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!0)):(i.setValue("USEPHYSICALLIGHTFALLOFF",!0),i.setValue("USEGLTFLIGHTFALLOFF",!1));var a=this.alphaTestCutoff.toString();i.setValue("ALPHABLEND",this.useAlphaBlending,!0),i.setValue("ALPHAFROMALBEDO",!1,!0),i.setValue("ALPHATEST",this.useAlphaTest,!0),i.setValue("ALPHATESTVALUE",a.indexOf(".")<0?a+".":a,!0),i.setValue("OPACITYRGB",!1,!0),i.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),i.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),i.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),i.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);var o=e.getScene(),s=o.getEngine();if(s._features.needTypeSuffixInShaderConstants?i.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):i.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),i.setValue("BRDF_V_HEIGHT_CORRELATED",!0),i.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),i.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),i.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),i.setValue("UNLIT",this.unlit,!0),i.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&R.ReflectionTextureEnabled?(i.setValue("ENVIRONMENTBRDF",!0),i.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(i.setValue("ENVIRONMENTBRDF",!1),i.setValue("ENVIRONMENTBRDF_RGBD",!1)),i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i),!!i._areLightsDirty)if(!this.light)C.PrepareDefinesForLights(o,e,i,!0,t.maxSimultaneousLights),i._needNormals=!0,C.PrepareDefinesForMultiview(o,i);else{var u={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};C.PrepareDefinesForLight(o,e,this.light,this._lightId,i,!0,u),u.needRebuild&&i.rebuild()}},r.prototype.updateUniformsAndSamples=function(e,t,i,a){for(var o=0;o<t.maxSimultaneousLights&&i["LIGHT"+o];o++){var s=e.uniforms.indexOf("vLightData"+o)>=0;C.PrepareUniformsAndSamplersForLight(o,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+o],a,s)}},r.prototype.isReady=function(e,t,i){return!(this._environmentBRDFTexture&&!this._environmentBRDFTexture.isReady()||i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())},r.prototype.bind=function(e,t,i){var a,o;if(!!i){var s=i.getScene();this.light?C.BindLight(this.light,this._lightId,s,e,!0):C.BindLights(s,i,e,!0,t.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);var u=this._scene.ambientColor;u&&e.setColor3("ambientFromScene",u);var l=s.useRightHandedSystem===(s._mirroredCameraPosition!=null);e.setFloat(this._invertNormalName,l?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);var c=1,p=(o=(a=this.indexOfRefraction.connectInputBlock)===null||a===void 0?void 0:a.value)!==null&&o!==void 0?o:1.5,d=Math.pow((p-c)/(p+c),2);this._metallicReflectanceColor.scaleToRef(d*this._metallicF0Factor,X.Color3[0]);var g=this._metallicF0Factor;e.setColor4(this._vMetallicReflectanceFactorsName,X.Color3[0],g),t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}},r.prototype._injectVertexCode=function(e){var t,i,a=this.worldPosition,o="//".concat(this.name);this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",o,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",o,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));var s="v_"+a.associatedVariableName;e._emitVaryingFromString(s,"vec4")&&(e.compilationString+="".concat(s," = ").concat(a.associatedVariableName,`;\r
`));var u=this.reflection.isConnected?(t=this.reflection.connectedPoint)===null||t===void 0?void 0:t.ownerBlock:null;u&&(u.viewConnectionPoint=this.view),e.compilationString+=(i=u==null?void 0:u.handleVertexSide(e))!==null&&i!==void 0?i:"",e._emitUniformFromString("vDebugMode","vec2","defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene","vec3"),e._emitVaryingFromString("vClipSpacePosition","vec4","defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+=`#if DEBUGMODE > 0\r
`,e._injectAtEnd+=`vClipSpacePosition = gl_Position;\r
`,e._injectAtEnd+=`#endif\r
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",o,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:a.associatedVariableName}]}):(e.compilationString+="vec4 worldPos = ".concat(a.associatedVariableName,`;\r
`),this.view.isConnected&&(e.compilationString+="mat4 view = ".concat(this.view.associatedVariableName,`;\r
`)),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",o,{repeatKey:"maxSimultaneousLights"}))},r.prototype._getAlbedoOpacityCode=function(){var e=`albedoOpacityOutParams albedoOpacityOut;\r
`,t=this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)",i=this.opacity.isConnected?this.opacity.associatedVariableName:"1.";return e+=`albedoOpacityBlock(
                vec4(`.concat(t,`, 1.),
            #ifdef ALBEDO
                vec4(1.),
                vec2(1., 1.),
            #endif
            #ifdef OPACITY
                vec4(`).concat(i,`),
                vec2(1., 1.),
            #endif
                albedoOpacityOut
            );

            vec3 surfaceAlbedo = albedoOpacityOut.surfaceAlbedo;
            float alpha = albedoOpacityOut.alpha;\r
`),e},r.prototype._getAmbientOcclusionCode=function(){var e=`ambientOcclusionOutParams aoOut;\r
`,t=this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1.";return e+=`ambientOcclusionBlock(
            #ifdef AMBIENT
                vec3(`.concat(t,`),
                vec4(0., 1.0, 1.0, 0.),
            #endif
                aoOut
            );\r
`),e},r.prototype._getReflectivityCode=function(e){var t=`reflectivityOutParams reflectivityOut;\r
`,i="1.";return this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,"vec4"),t+=`vec3 baseColor = surfaceAlbedo;

            reflectivityBlock(
                vec4(`.concat(this.metallic.associatedVariableName,", ").concat(this.roughness.associatedVariableName,`, 0., 0.),
            #ifdef METALLICWORKFLOW
                surfaceAlbedo,
                `).concat(this._vMetallicReflectanceFactorsName,`,
            #endif
            #ifdef REFLECTIVITY
                vec3(0., 0., `).concat(i,`),
                vec4(1.),
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)
                aoOut.ambientOcclusionColor,
            #endif
            #ifdef MICROSURFACEMAP
                microSurfaceTexel, <== not handled!
            #endif
                reflectivityOut
            );

            float microSurface = reflectivityOut.microSurface;
            float roughness = reflectivityOut.roughness;

            #ifdef METALLICWORKFLOW
                surfaceAlbedo = reflectivityOut.surfaceAlbedo;
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;
            #endif\r
`),t},r.prototype._buildBlock=function(e){var t,i,a,o,s,u,l,c,p,d,g,m,y,v,T,x,E,O,N,w,k,W,Z,ie,D,ne,he,oe,Se,Ce,Oe,te,Pe,ht,dt,_t,mt,gt,vt,bt,yt;n.prototype._buildBlock.call(this,e),this._scene=e.sharedData.scene,this._environmentBRDFTexture||(this._environmentBRDFTexture=Xt(this._scene));var M=this.reflection.isConnected?(t=this.reflection.connectedPoint)===null||t===void 0?void 0:t.ownerBlock:null;if(M&&(M.worldPositionConnectionPoint=this.worldPosition,M.cameraPositionConnectionPoint=this.cameraPosition,M.worldNormalConnectionPoint=this.worldNormal),e.target!==_.Fragment)return this._injectVertexCode(e),this;e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this);var Y="//".concat(this.name),Fe="v_"+this.worldPosition.associatedVariableName,Zt=this.perturbedNormal;this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",Y,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",Y,{repeatKey:"maxSimultaneousLights"}),e._emitFunctionFromInclude("helperFunctions",Y),e._emitFunctionFromInclude("importanceSampling",Y),e._emitFunctionFromInclude("pbrHelperFunctions",Y),e._emitFunctionFromInclude("imageProcessingDeclaration",Y),e._emitFunctionFromInclude("imageProcessingFunctions",Y),e._emitFunctionFromInclude("shadowsFragmentFunctions",Y,{replaceStrings:[{search:/vPositionW/g,replace:Fe+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",Y,{replaceStrings:[{search:/vPositionW/g,replace:Fe+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",Y),e._emitFunctionFromInclude("pbrBRDFFunctions",Y,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(i=M==null?void 0:M._defineSkyboxName)!==null&&i!==void 0?i:"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",Y),e._emitFunctionFromInclude("pbrDirectLightingFunctions",Y,{replaceStrings:[{search:/vPositionW/g,replace:Fe+".xyz"}]}),e._emitFunctionFromInclude("pbrIBLFunctions",Y),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",Y),e._emitFunctionFromInclude("pbrBlockReflectivity",Y),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",Y),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",Y),e._emitFunctionFromInclude("pbrBlockAnisotropic",Y),e._emitUniformFromString("vLightingIntensity","vec4"),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+="vec4 ".concat(this._vNormalWName," = normalize(").concat(this.worldNormal.associatedVariableName,`);\r
`),e._registerTempVariable("viewDirectionW")&&(e.compilationString+="vec3 viewDirectionW = normalize(".concat(this.cameraPosition.associatedVariableName," - ").concat(Fe,`.xyz);\r
`)),e.compilationString+="vec3 geometricNormalW = ".concat(this._vNormalWName,`.xyz;\r
`),e.compilationString+="vec3 normalW = ".concat(Zt.isConnected?"normalize("+Zt.associatedVariableName+".xyz)":"geometricNormalW",`;\r
`),this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,"float"),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",Y,{replaceStrings:[{search:/vPositionW/g,replace:Fe+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(),e.compilationString+=e._emitCodeFromInclude("depthPrePass",Y),e.compilationString+=this._getAmbientOcclusionCode(),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",Y),e.compilationString+=`#ifdef UNLIT
                vec3 diffuseBase = vec3(1., 1., 1.);
            #else\r
`,e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",Y,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(a=M==null?void 0:M._defineSkyboxName)!==null&&a!==void 0?a:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:(o=M==null?void 0:M._define3DName)!==null&&o!==void 0?o:"REFLECTIONMAP_3D"}]});var He=this.anisotropy.isConnected?(s=this.anisotropy.connectedPoint)===null||s===void 0?void 0:s.ownerBlock:null;He&&(He.worldPositionConnectionPoint=this.worldPosition,He.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=He.getCode(e,!this.perturbedNormal.isConnected)),M&&M.hasTexture&&(e.compilationString+=M.getCode(e,He?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",Y,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:(u=M==null?void 0:M._define3DName)!==null&&u!==void 0?u:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(l=M==null?void 0:M._defineOppositeZ)!==null&&l!==void 0?l:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(c=M==null?void 0:M._defineProjectionName)!==null&&c!==void 0?c:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(p=M==null?void 0:M._defineSkyboxName)!==null&&p!==void 0?p:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(d=M==null?void 0:M._defineLODReflectionAlpha)!==null&&d!==void 0?d:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(g=M==null?void 0:M._defineLinearSpecularReflection)!==null&&g!==void 0?g:"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:(m=M==null?void 0:M._vReflectionFilteringInfoName)!==null&&m!==void 0?m:"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",Y,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:this._vMetallicReflectanceFactorsName}]});var Qt=this.sheen.isConnected?(y=this.sheen.connectedPoint)===null||y===void 0?void 0:y.ownerBlock:null;Qt&&(e.compilationString+=Qt.getCode(M)),e._emitFunctionFromInclude("pbrBlockSheen",Y,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:(v=M==null?void 0:M._define3DName)!==null&&v!==void 0?v:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(T=M==null?void 0:M._defineSkyboxName)!==null&&T!==void 0?T:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(x=M==null?void 0:M._defineLODReflectionAlpha)!==null&&x!==void 0?x:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(E=M==null?void 0:M._defineLinearSpecularReflection)!==null&&E!==void 0?E:"LINEARSPECULARREFLECTION"}]});var Lr=this.iridescence.isConnected?(O=this.iridescence.connectedPoint)===null||O===void 0?void 0:O.ownerBlock:null;e.compilationString+=jt.GetCode(Lr),e._emitFunctionFromInclude("pbrBlockIridescence",Y,{replaceStrings:[]});var tt=this.clearcoat.isConnected?(N=this.clearcoat.connectedPoint)===null||N===void 0?void 0:N.ownerBlock:null,Jt=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,Br=this.perturbedNormal.isConnected&&((k=((w=this.perturbedNormal.connectedPoint)===null||w===void 0?void 0:w.ownerBlock).worldTangent)===null||k===void 0?void 0:k.isConnected),Vr=this.anisotropy.isConnected&&((W=this.anisotropy.connectedPoint)===null||W===void 0?void 0:W.ownerBlock).worldTangent.isConnected,Tt=Br||!this.perturbedNormal.isConnected&&Vr;e.compilationString+=Ht.GetCode(e,tt,M,Fe,Jt,Tt,this.worldNormal.associatedVariableName),Jt&&(Tt=(Z=tt==null?void 0:tt.worldTangent.isConnected)!==null&&Z!==void 0?Z:!1),e._emitFunctionFromInclude("pbrBlockClearcoat",Y,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:(ie=M==null?void 0:M._define3DName)!==null&&ie!==void 0?ie:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(D=M==null?void 0:M._defineOppositeZ)!==null&&D!==void 0?D:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(ne=M==null?void 0:M._defineProjectionName)!==null&&ne!==void 0?ne:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(he=M==null?void 0:M._defineSkyboxName)!==null&&he!==void 0?he:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(oe=M==null?void 0:M._defineLODReflectionAlpha)!==null&&oe!==void 0?oe:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(Se=M==null?void 0:M._defineLinearSpecularReflection)!==null&&Se!==void 0?Se:"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:Tt?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",Y,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(Ce=M==null?void 0:M._defineSkyboxName)!==null&&Ce!==void 0?Ce:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:(Oe=M==null?void 0:M._define3DName)!==null&&Oe!==void 0?Oe:"REFLECTIONMAP_3D"}]});var wr=this.subsurface.isConnected?(te=this.subsurface.connectedPoint)===null||te===void 0?void 0:te.ownerBlock:null,_e=this.subsurface.isConnected?(ht=((Pe=this.subsurface.connectedPoint)===null||Pe===void 0?void 0:Pe.ownerBlock).refraction.connectedPoint)===null||ht===void 0?void 0:ht.ownerBlock:null;_e&&(_e.viewConnectionPoint=this.view,_e.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=Wt.GetCode(e,wr,M,Fe),e._emitFunctionFromInclude("pbrBlockSubSurface",Y,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:(dt=M==null?void 0:M._define3DName)!==null&&dt!==void 0?dt:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(_t=M==null?void 0:M._defineOppositeZ)!==null&&_t!==void 0?_t:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(mt=M==null?void 0:M._defineProjectionName)!==null&&mt!==void 0?mt:"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:(gt=_e==null?void 0:_e._define3DName)!==null&&gt!==void 0?gt:"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:(vt=_e==null?void 0:_e._defineLODRefractionAlpha)!==null&&vt!==void 0?vt:"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:(bt=_e==null?void 0:_e._defineLinearSpecularRefraction)!==null&&bt!==void 0?bt:"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:(yt=_e==null?void 0:_e._defineOppositeZ)!==null&&yt!==void 0?yt:"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",Y),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",Y,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",Y,{repeatKey:"maxSimultaneousLights"}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",Y),e.compilationString+=`#endif\r
`;var kr=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:"vec3(0., 0., 0.)",St=pe.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();St.indexOf(".")===-1&&(St+="."),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",Y,{replaceStrings:[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:/vAmbientColor/g,replace:kr+" * ambientFromScene"},{search:/vAmbientInfos\.w/g,replace:St}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",Y,{replaceStrings:[{search:/finalEmissive/g,replace:"vec3(0.)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",Y,{replaceStrings:[{search:/visibility/g,replace:"1."}]}),e.compilationString+=e._emitCodeFromInclude("pbrDebug",Y,{replaceStrings:[{search:/vNormalW/g,replace:this._vNormalWName},{search:/vPositionW/g,replace:Fe},{search:/albedoTexture\.rgb;/g,replace:`vec3(1.);\r
gl_FragColor.rgb = toGammaSpace(gl_FragColor.rgb);\r
`}]});for(var Et=0,$t=this._outputs;Et<$t.length;Et++){var je=$t[Et];if(je.hasEndpoints){var At=fa[je.name];if(At){var Ur=At[0],Ct=At[1];Ct&&(e.compilationString+="#if ".concat(Ct,`\r
`)),e.compilationString+="".concat(this._declareOutput(je,e)," = ").concat(Ur,`;\r
`),Ct&&(e.compilationString+=`#else\r
`,e.compilationString+="".concat(this._declareOutput(je,e),` = vec3(0.);\r
`),e.compilationString+=`#endif\r
`)}else console.error("There's no remapping for the ".concat(je.name," end point! No code generated"))}}return this},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,".lightFalloff = ").concat(this.lightFalloff,`;\r
`),e+="".concat(this._codeVariableName,".useAlphaTest = ").concat(this.useAlphaTest,`;\r
`),e+="".concat(this._codeVariableName,".alphaTestCutoff = ").concat(this.alphaTestCutoff,`;\r
`),e+="".concat(this._codeVariableName,".useAlphaBlending = ").concat(this.useAlphaBlending,`;\r
`),e+="".concat(this._codeVariableName,".useRadianceOverAlpha = ").concat(this.useRadianceOverAlpha,`;\r
`),e+="".concat(this._codeVariableName,".useSpecularOverAlpha = ").concat(this.useSpecularOverAlpha,`;\r
`),e+="".concat(this._codeVariableName,".enableSpecularAntiAliasing = ").concat(this.enableSpecularAntiAliasing,`;\r
`),e+="".concat(this._codeVariableName,".realTimeFiltering = ").concat(this.realTimeFiltering,`;\r
`),e+="".concat(this._codeVariableName,".realTimeFilteringQuality = ").concat(this.realTimeFilteringQuality,`;\r
`),e+="".concat(this._codeVariableName,".useEnergyConservation = ").concat(this.useEnergyConservation,`;\r
`),e+="".concat(this._codeVariableName,".useRadianceOcclusion = ").concat(this.useRadianceOcclusion,`;\r
`),e+="".concat(this._codeVariableName,".useHorizonOcclusion = ").concat(this.useHorizonOcclusion,`;\r
`),e+="".concat(this._codeVariableName,".unlit = ").concat(this.unlit,`;\r
`),e+="".concat(this._codeVariableName,".forceNormalForward = ").concat(this.forceNormalForward,`;\r
`),e+="".concat(this._codeVariableName,".debugMode = ").concat(this.debugMode,`;\r
`),e+="".concat(this._codeVariableName,".debugLimit = ").concat(this.debugLimit,`;\r
`),e+="".concat(this._codeVariableName,".debugFactor = ").concat(this.debugFactor,`;\r
`),e},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e},r.prototype._deserialize=function(e,t,i){var a,o;n.prototype._deserialize.call(this,e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.lightFalloff=(a=e.lightFalloff)!==null&&a!==void 0?a:0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=(o=e.realTimeFilteringQuality)!==null&&o!==void 0?o:8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor},h([H("Direct lights",z.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],r.prototype,"directIntensity",void 0),h([H("Environment lights",z.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],r.prototype,"environmentIntensity",void 0),h([H("Specular highlights",z.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],r.prototype,"specularIntensity",void 0),h([H("Light falloff",z.List,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:pe.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:pe.LIGHTFALLOFF_GLTF},{label:"Standard",value:pe.LIGHTFALLOFF_STANDARD}]})],r.prototype,"lightFalloff",void 0),h([H("Alpha Testing",z.Boolean,"OPACITY")],r.prototype,"useAlphaTest",void 0),h([H("Alpha CutOff",z.Float,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],r.prototype,"alphaTestCutoff",void 0),h([H("Alpha blending",z.Boolean,"OPACITY")],r.prototype,"useAlphaBlending",void 0),h([H("Radiance over alpha",z.Boolean,"RENDERING",{notifiers:{update:!0}})],r.prototype,"useRadianceOverAlpha",void 0),h([H("Specular over alpha",z.Boolean,"RENDERING",{notifiers:{update:!0}})],r.prototype,"useSpecularOverAlpha",void 0),h([H("Specular anti-aliasing",z.Boolean,"RENDERING",{notifiers:{update:!0}})],r.prototype,"enableSpecularAntiAliasing",void 0),h([H("Realtime filtering",z.Boolean,"RENDERING",{notifiers:{update:!0}})],r.prototype,"realTimeFiltering",void 0),h([H("Realtime filtering quality",z.List,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],r.prototype,"realTimeFilteringQuality",void 0),h([H("Energy Conservation",z.Boolean,"ADVANCED",{notifiers:{update:!0}})],r.prototype,"useEnergyConservation",void 0),h([H("Radiance occlusion",z.Boolean,"ADVANCED",{notifiers:{update:!0}})],r.prototype,"useRadianceOcclusion",void 0),h([H("Horizon occlusion",z.Boolean,"ADVANCED",{notifiers:{update:!0}})],r.prototype,"useHorizonOcclusion",void 0),h([H("Unlit",z.Boolean,"ADVANCED",{notifiers:{update:!0}})],r.prototype,"unlit",void 0),h([H("Force normal forward",z.Boolean,"ADVANCED",{notifiers:{update:!0}})],r.prototype,"forceNormalForward",void 0),h([H("Debug mode",z.List,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87}]})],r.prototype,"debugMode",void 0),h([H("Split position",z.Float,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],r.prototype,"debugLimit",void 0),h([H("Output factor",z.Float,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],r.prototype,"debugFactor",void 0),r}(F);P("BABYLON.PBRMetallicRoughnessBlock",pa);var ha=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("left",f.AutoDetect),t.registerInput("right",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t}return r.prototype.getClassName=function(){return"ModBlock"},Object.defineProperty(r.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = mod(".concat(this.left.associatedVariableName,", ").concat(this.right.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.ModBlock",ha);var da=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("row0",f.Vector4),t.registerInput("row1",f.Vector4),t.registerInput("row2",f.Vector4),t.registerInput("row3",f.Vector4),t.registerOutput("output",f.Matrix),t}return r.prototype.getClassName=function(){return"MatrixBuilder"},Object.defineProperty(r.prototype,"row0",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"row1",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"row2",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"row3",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype.autoConfigure=function(){if(!this.row0.isConnected){var e=new B("row0");e.value=new Me(1,0,0,0),e.output.connectTo(this.row0)}if(!this.row1.isConnected){var t=new B("row1");t.value=new Me(0,1,0,0),t.output.connectTo(this.row1)}if(!this.row2.isConnected){var i=new B("row2");i.value=new Me(0,0,1,0),i.output.connectTo(this.row2)}if(!this.row3.isConnected){var a=new B("row3");a.value=new Me(0,0,0,1),a.output.connectTo(this.row3)}},r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this.row0,a=this.row1,o=this.row2,s=this.row3;return e.compilationString+=this._declareOutput(t,e)+" = mat4(".concat(i.associatedVariableName,", ").concat(a.associatedVariableName,", ").concat(o.associatedVariableName,", ").concat(s.associatedVariableName,`);\r
`),this},r}(F);P("BABYLON.MatrixBuilder",da);var be;(function(n){n[n.Equal=0]="Equal",n[n.NotEqual=1]="NotEqual",n[n.LessThan=2]="LessThan",n[n.GreaterThan=3]="GreaterThan",n[n.LessOrEqual=4]="LessOrEqual",n[n.GreaterOrEqual=5]="GreaterOrEqual",n[n.Xor=6]="Xor",n[n.Or=7]="Or",n[n.And=8]="And"})(be||(be={}));var _a=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.condition=be.LessThan,t.registerInput("a",f.Float),t.registerInput("b",f.Float),t.registerInput("true",f.AutoDetect,!0),t.registerInput("false",f.AutoDetect,!0),t.registerOutput("output",f.BasedOnInput),t._linkConnectionTypes(2,3),t._outputs[0]._typeConnectionSource=t._inputs[2],t._outputs[0]._defaultConnectionPointType=f.Float,t}return r.prototype.getClassName=function(){return"ConditionalBlock"},Object.defineProperty(r.prototype,"a",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"b",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"true",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"false",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this.true.isConnected?this.true.associatedVariableName:"1.0",a=this.false.isConnected?this.false.associatedVariableName:"0.0";switch(this.condition){case be.Equal:{e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.a.associatedVariableName," == ").concat(this.b.associatedVariableName," ? ").concat(i," : ").concat(a,`;\r
`);break}case be.NotEqual:{e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.a.associatedVariableName," != ").concat(this.b.associatedVariableName," ? ").concat(i," : ").concat(a,`;\r
`);break}case be.LessThan:{e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.a.associatedVariableName," < ").concat(this.b.associatedVariableName," ? ").concat(i," : ").concat(a,`;\r
`);break}case be.LessOrEqual:{e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.a.associatedVariableName," <= ").concat(this.b.associatedVariableName," ? ").concat(i," : ").concat(a,`;\r
`);break}case be.GreaterThan:{e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.a.associatedVariableName," > ").concat(this.b.associatedVariableName," ? ").concat(i," : ").concat(a,`;\r
`);break}case be.GreaterOrEqual:{e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.a.associatedVariableName," >= ").concat(this.b.associatedVariableName," ? ").concat(i," : ").concat(a,`;\r
`);break}case be.Xor:{e.compilationString+=this._declareOutput(t,e)+" = (mod(".concat(this.a.associatedVariableName," + ").concat(this.b.associatedVariableName,", 2.0) > 0.0) ? ").concat(i," : ").concat(a,`;\r
`);break}case be.Or:{e.compilationString+=this._declareOutput(t,e)+" = (min(".concat(this.a.associatedVariableName," + ").concat(this.b.associatedVariableName,", 1.0) > 0.0) ? ").concat(i," : ").concat(a,`;\r
`);break}case be.And:{e.compilationString+=this._declareOutput(t,e)+" = (".concat(this.a.associatedVariableName," * ").concat(this.b.associatedVariableName," > 0.0)  ? ").concat(i," : ").concat(a,`;\r
`);break}}return this},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.condition=this.condition,e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),this.condition=e.condition},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this)+"".concat(this._codeVariableName,".condition = BABYLON.ConditionalBlockConditions.").concat(be[this.condition],`;\r
`);return e},r}(F);P("BABYLON.ConditionalBlock",_a);var ma=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.octaves=6,t.registerInput("seed",f.AutoDetect),t.registerInput("chaos",f.AutoDetect,!0),t.registerInput("offsetX",f.Float,!0),t.registerInput("offsetY",f.Float,!0),t.registerInput("offsetZ",f.Float,!0),t.registerOutput("output",f.Float),t._inputs[0].acceptedConnectionPointTypes.push(f.Vector2),t._inputs[0].acceptedConnectionPointTypes.push(f.Vector3),t._linkConnectionTypes(0,1),t}return r.prototype.getClassName=function(){return"CloudBlock"},Object.defineProperty(r.prototype,"seed",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"chaos",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"offsetX",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"offsetY",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"offsetZ",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){var t,i;if(n.prototype._buildBlock.call(this,e),!!this.seed.isConnected&&!!this._outputs[0].hasEndpoints){var a=`

        float cloudRandom(in float p) { p = fract(p * 0.011); p *= p + 7.5; p *= p + p; return fract(p); }

        // Based on Morgan McGuire @morgan3d
        // https://www.shadertoy.com/view/4dS3Wd
        float cloudNoise(in vec2 x, in vec2 chaos) {
            vec2 step = chaos * vec2(75., 120.) + vec2(75., 120.);

            vec2 i = floor(x);
            vec2 f = fract(x);

            float n = dot(i, step);

            vec2 u = f * f * (3.0 - 2.0 * f);
            return mix(
                    mix(cloudRandom(n + dot(step, vec2(0, 0))), cloudRandom(n + dot(step, vec2(1, 0))), u.x),
                    mix(cloudRandom(n + dot(step, vec2(0, 1))), cloudRandom(n + dot(step, vec2(1, 1))), u.x),
                    u.y
                );
        }

        float cloudNoise(in vec3 x, in vec3 chaos) {
            vec3 step = chaos * vec3(60., 120., 75.) + vec3(60., 120., 75.);

            vec3 i = floor(x);
            vec3 f = fract(x);

            float n = dot(i, step);

            vec3 u = f * f * (3.0 - 2.0 * f);
            return mix(mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 0))), cloudRandom(n + dot(step, vec3(1, 0, 0))), u.x),
                           mix( cloudRandom(n + dot(step, vec3(0, 1, 0))), cloudRandom(n + dot(step, vec3(1, 1, 0))), u.x), u.y),
                       mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 1))), cloudRandom(n + dot(step, vec3(1, 0, 1))), u.x),
                           mix( cloudRandom(n + dot(step, vec3(0, 1, 1))), cloudRandom(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);
        }`,o=`
        float fbm(in vec2 st, in vec2 chaos) {
            // Initial values
            float value = 0.0;
            float amplitude = .5;
            float frequency = 0.;

            // Loop of octaves
            for (int i = 0; i < OCTAVES; i++) {
                value += amplitude * cloudNoise(st, chaos);
                st *= 2.0;
                amplitude *= 0.5;
            }
            return value;
        }

        float fbm(in vec3 x, in vec3 chaos) {
            // Initial values
            float value = 0.0;
            float amplitude = 0.5;
            for (int i = 0; i < OCTAVES; ++i) {
                value += amplitude * cloudNoise(x, chaos);
                x = x * 2.0;
                amplitude *= 0.5;
            }
            return value;
        }`,s="fbm".concat(this.octaves);e._emitFunction("CloudBlockCode",a,"// CloudBlockCode"),e._emitFunction("CloudBlockCodeFBM"+this.octaves,o.replace(/fbm/gi,s).replace(/OCTAVES/gi,(this.octaves|0).toString()),"// CloudBlockCode FBM");var u=e._getFreeVariableName("st"),l=((t=this.seed.connectedPoint)===null||t===void 0?void 0:t.type)===f.Vector2?"vec2":"vec3";e.compilationString+="".concat(l," ").concat(u," = ").concat(this.seed.associatedVariableName,`;\r
`),this.offsetX.isConnected&&(e.compilationString+="".concat(u,".x += 0.1 * ").concat(this.offsetX.associatedVariableName,`;\r
`)),this.offsetY.isConnected&&(e.compilationString+="".concat(u,".y += 0.1 * ").concat(this.offsetY.associatedVariableName,`;\r
`)),this.offsetZ.isConnected&&l==="vec3"&&(e.compilationString+="".concat(u,".z += 0.1 * ").concat(this.offsetZ.associatedVariableName,`;\r
`));var c="";return this.chaos.isConnected?c=this.chaos.associatedVariableName:c=((i=this.seed.connectedPoint)===null||i===void 0?void 0:i.type)===f.Vector2?"vec2(0., 0.)":"vec3(0., 0., 0.)",e.compilationString+=this._declareOutput(this._outputs[0],e)+" = ".concat(s,"(").concat(u,", ").concat(c,`);\r
`),this}},r.prototype._dumpPropertiesCode=function(){var e=n.prototype._dumpPropertiesCode.call(this)+"".concat(this._codeVariableName,".octaves = ").concat(this.octaves,`;\r
`);return e},r.prototype.serialize=function(){var e=n.prototype.serialize.call(this);return e.octaves=this.octaves,e},r.prototype._deserialize=function(e,t,i){n.prototype._deserialize.call(this,e,t,i),this.octaves=e.octaves},h([H("Octaves",z.Int)],r.prototype,"octaves",void 0),r}(F);P("BABYLON.CloudBlock",ma);var ga=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("seed",f.Vector2),t.registerInput("offset",f.Float),t.registerInput("density",f.Float),t.registerOutput("output",f.Float),t.registerOutput("cells",f.Float),t}return r.prototype.getClassName=function(){return"VoronoiNoiseBlock"},Object.defineProperty(r.prototype,"seed",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"offset",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"density",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cells",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){if(n.prototype._buildBlock.call(this,e),!!this.seed.isConnected){var t=`vec2 voronoiRandom(vec2 seed, float offset){
            mat2 m = mat2(15.27, 47.63, 99.41, 89.98);
            vec2 uv = fract(sin(m * seed) * 46839.32);
            return vec2(sin(uv.y * offset) * 0.5 + 0.5, cos(uv.x * offset) * 0.5 + 0.5);
        }
        `;e._emitFunction("voronoiRandom",t,"// Voronoi random generator"),t=`void voronoi(vec2 seed, float offset, float density, out float outValue, out float cells){
            vec2 g = floor(seed * density);
            vec2 f = fract(seed * density);
            float t = 8.0;
            vec3 res = vec3(8.0, 0.0, 0.0);

            for(int y=-1; y<=1; y++)
            {
                for(int x=-1; x<=1; x++)
                {
                    vec2 lattice = vec2(x,y);
                    vec2 randomOffset = voronoiRandom(lattice + g, offset);
                    float d = distance(lattice + randomOffset, f);
                    if(d < res.x)
                    {
                        res = vec3(d, randomOffset.x, randomOffset.y);
                        outValue = res.x;
                        cells = res.y;
                    }
                }
            }
        }
        `,e._emitFunction("voronoi",t,"// Voronoi");var i=e._getFreeVariableName("tempOutput"),a=e._getFreeVariableName("tempCells");return e.compilationString+="float ".concat(i,` = 0.0;\r
`),e.compilationString+="float ".concat(a,` = 0.0;\r
`),e.compilationString+="voronoi(".concat(this.seed.associatedVariableName,", ").concat(this.offset.associatedVariableName,", ").concat(this.density.associatedVariableName,", ").concat(i,", ").concat(a,`);\r
`),this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+" = ".concat(i,`;\r
`)),this.cells.hasEndpoints&&(e.compilationString+=this._declareOutput(this.cells,e)+" = ".concat(a,`;\r
`)),this}},r}(F);P("BABYLON.VoronoiNoiseBlock",ga);var va=function(n){A(r,n);function r(e){var t=n.call(this,e,_.Neutral)||this;return t.registerInput("input",f.AutoDetect),t.registerOutput("output",f.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t}return r.prototype.getClassName=function(){return"ElbowBlock"},Object.defineProperty(r.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"target",{get:function(){var e=this._inputs[0];if(e.isConnected){var t=e.connectedPoint.ownerBlock;if(t.target!==_.VertexAndFragment)return t.target;if(e.connectedPoint.target!==_.VertexAndFragment)return e.connectedPoint.target}return this._target},set:function(e){(this._target&e)===0&&(this._target=e)},enumerable:!1,configurable:!0}),r.prototype._buildBlock=function(e){n.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this._inputs[0];return e.compilationString+=this._declareOutput(t,e)+" = ".concat(i.associatedVariableName,`;\r
`),this},r}(F);P("BABYLON.ElbowBlock",va);var ba=function(){function n(){this.mm=new Map}return n.prototype.get=function(r,e){var t=this.mm.get(r);if(t!==void 0)return t.get(e)},n.prototype.set=function(r,e,t){var i=this.mm.get(r);i===void 0&&this.mm.set(r,i=new Map),i.set(e,t)},n}();(function(){function n(r,e,t){var i=this;this._baseMaterial=r,this._scene=e!=null?e:de.LastCreatedScene,this._options=t,this._subMeshToEffect=new Map,this._subMeshToDepthWrapper=new ba,this._meshes=new Map,this._onEffectCreatedObserver=this._baseMaterial.onEffectCreatedObservable.add(function(a){var o,s=(o=a.subMesh)===null||o===void 0?void 0:o.getMesh();s&&!i._meshes.has(s)&&i._meshes.set(s,s.onDisposeObservable.add(function(u){for(var l=i._subMeshToEffect.keys(),c=l.next();c.done!==!0;c=l.next()){var p=c.value;(p==null?void 0:p.getMesh())===u&&(i._subMeshToEffect.delete(p),i._subMeshToDepthWrapper.mm.delete(p))}})),i._subMeshToEffect.set(a.subMesh,[a.effect,i._scene.getEngine().currentRenderPassId]),i._subMeshToDepthWrapper.mm.delete(a.subMesh)})}return Object.defineProperty(n.prototype,"standalone",{get:function(){var r,e;return(e=(r=this._options)===null||r===void 0?void 0:r.standalone)!==null&&e!==void 0?e:!1},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"baseMaterial",{get:function(){return this._baseMaterial},enumerable:!1,configurable:!0}),n.prototype.getEffect=function(r,e,t){var i,a=(i=this._subMeshToDepthWrapper.mm.get(r))===null||i===void 0?void 0:i.get(e);if(!a)return null;var o=a.drawWrapper[t];return o||(o=a.drawWrapper[t]=new qe(this._scene.getEngine()),o.setEffect(a.mainDrawWrapper.effect,a.mainDrawWrapper.defines)),o},n.prototype.isReadyForSubMesh=function(r,e,t,i,a){var o,s;return this.standalone&&!this._baseMaterial.isReadyForSubMesh(r.getMesh(),r,i)?!1:(s=(o=this._makeEffect(r,e,t,a))===null||o===void 0?void 0:o.isReady())!==null&&s!==void 0?s:!1},n.prototype.dispose=function(){this._baseMaterial.onEffectCreatedObservable.remove(this._onEffectCreatedObserver),this._onEffectCreatedObserver=null;for(var r=this._meshes.entries(),e=r.next();e.done!==!0;e=r.next()){var t=e.value,i=t[0],a=t[1];i.onDisposeObservable.remove(a)}},n.prototype._makeEffect=function(r,e,t,i){var a,o,s,u=this._scene.getEngine(),l=this._subMeshToEffect.get(r);if(!l)return null;var c=l[0],p=l[1],d=this._subMeshToDepthWrapper.get(r,t);if(!d){var g=new qe(u);g.defines=(o=(a=r._getDrawWrapper(p))===null||a===void 0?void 0:a.defines)!==null&&o!==void 0?o:null,d={drawWrapper:[],mainDrawWrapper:g,depthDefines:"",token:hr()},d.drawWrapper[i]=g,this._subMeshToDepthWrapper.set(r,t,d)}var m=e.join(`
`);if(d.mainDrawWrapper.effect&&m===d.depthDefines)return d.mainDrawWrapper.effect;d.depthDefines=m;var y=c.rawVertexSourceCode,v=c.rawFragmentSourceCode,T=this._options&&this._options.remappedVariables?"#include<shadowMapVertexNormalBias>(".concat(this._options.remappedVariables.join(","),")"):se.IncludesShadersStore.shadowMapVertexNormalBias,x=this._options&&this._options.remappedVariables?"#include<shadowMapVertexMetric>(".concat(this._options.remappedVariables.join(","),")"):se.IncludesShadersStore.shadowMapVertexMetric,E=this._options&&this._options.remappedVariables?"#include<shadowMapFragmentSoftTransparentShadow>(".concat(this._options.remappedVariables.join(","),")"):se.IncludesShadersStore.shadowMapFragmentSoftTransparentShadow,O=se.IncludesShadersStore.shadowMapFragment;y=y.replace(/void\s+?main/g,se.IncludesShadersStore.shadowMapVertexExtraDeclaration+`\r
void main`),y=y.replace(/#define SHADOWDEPTH_NORMALBIAS|#define CUSTOM_VERTEX_UPDATE_WORLDPOS/g,T),y.indexOf("#define SHADOWDEPTH_METRIC")!==-1?y=y.replace(/#define SHADOWDEPTH_METRIC/g,x):y=y.replace(/}\s*$/g,x+`\r
}`),y=y.replace(/#define SHADER_NAME.*?\n|out vec4 glFragColor;\n/g,"");var N=v.indexOf("#define SHADOWDEPTH_SOFTTRANSPARENTSHADOW")>=0||v.indexOf("#define CUSTOM_FRAGMENT_BEFORE_FOG")>=0,w=v.indexOf("#define SHADOWDEPTH_FRAGMENT")!==-1,k="";N?v=v.replace(/#define SHADOWDEPTH_SOFTTRANSPARENTSHADOW|#define CUSTOM_FRAGMENT_BEFORE_FOG/g,E):k=E+`\r
`,v=v.replace(/void\s+?main/g,se.IncludesShadersStore.shadowMapFragmentExtraDeclaration+`\r
void main`),w?v=v.replace(/#define SHADOWDEPTH_FRAGMENT/g,O):k+=O+`\r
`,k&&(v=v.replace(/}\s*$/g,k+"}")),v=v.replace(/#define SHADER_NAME.*?\n|out vec4 glFragColor;\n/g,"");var W=c.getUniformNames().slice();W.push("biasAndScaleSM","depthValuesSM","lightDataSM","softTransparentShadowSM"),d.mainDrawWrapper.effect=u.createEffect({vertexSource:y,fragmentSource:v,vertexToken:d.token,fragmentToken:d.token},{attributes:c.getAttributesNames(),uniformsNames:W,uniformBuffersNames:c.getUniformBuffersNames(),samplers:c.getSamplers(),defines:m+`
`+c.defines.replace("#define SHADOWS","").replace(/#define SHADOW\d/g,""),indexParameters:c.getIndexParameters()},u);for(var Z=0;Z<d.drawWrapper.length;++Z)Z!==i&&((s=d.drawWrapper[Z])===null||s===void 0||s.setEffect(d.mainDrawWrapper.effect,d.mainDrawWrapper.defines));return d.mainDrawWrapper.effect},n})();var ja=function(){function n(r){this._isUbo(r)?(this.setMatrix3x3=r.updateMatrix3x3.bind(r),this.setMatrix2x2=r.updateMatrix2x2.bind(r),this.setFloat=r.updateFloat.bind(r),this.setFloat2=r.updateFloat2.bind(r),this.setFloat3=r.updateFloat3.bind(r),this.setFloat4=r.updateFloat4.bind(r),this.setFloatArray=r.updateFloatArray.bind(r),this.setArray=r.updateArray.bind(r),this.setIntArray=r.updateIntArray.bind(r),this.setMatrix=r.updateMatrix.bind(r),this.setMatrices=r.updateMatrices.bind(r),this.setVector3=r.updateVector3.bind(r),this.setVector4=r.updateVector4.bind(r),this.setColor3=r.updateColor3.bind(r),this.setColor4=r.updateColor4.bind(r),this.setDirectColor4=r.updateDirectColor4.bind(r),this.setInt=r.updateInt.bind(r),this.setInt2=r.updateInt2.bind(r),this.setInt3=r.updateInt3.bind(r),this.setInt4=r.updateInt4.bind(r)):(this.setMatrix3x3=r.setMatrix3x3.bind(r),this.setMatrix2x2=r.setMatrix2x2.bind(r),this.setFloat=r.setFloat.bind(r),this.setFloat2=r.setFloat2.bind(r),this.setFloat3=r.setFloat3.bind(r),this.setFloat4=r.setFloat4.bind(r),this.setFloatArray=r.setFloatArray.bind(r),this.setArray=r.setArray.bind(r),this.setIntArray=r.setIntArray.bind(r),this.setMatrix=r.setMatrix.bind(r),this.setMatrices=r.setMatrices.bind(r),this.setVector3=r.setVector3.bind(r),this.setVector4=r.setVector4.bind(r),this.setColor3=r.setColor3.bind(r),this.setColor4=r.setColor4.bind(r),this.setDirectColor4=r.setDirectColor4.bind(r),this.setInt=r.setInt.bind(r),this.setInt2=r.setInt2.bind(r),this.setInt3=r.setInt3.bind(r),this.setInt4=r.setInt4.bind(r))}return n.prototype._isUbo=function(r){return r.addUniform!==void 0},n}(),Wa=function(n){A(r,n);function r(e,t,i,a,o,s){var u=n.call(this,e,i,a,o,s)||this;return u._beforeCompositionPostProcesses=[],u._internalTextureDirty=!1,u.enabled=!1,u.renderTargetTexture=null,u.renderTargetTexture=t,u}return r.prototype._createCompositionEffect=function(){this.imageProcessingPostProcess=new gi("prePassComposition",1,null,void 0,this._engine),this.imageProcessingPostProcess._updateParameters()},r.prototype._checkSize=function(){var e=this._engine.getRenderWidth(!0),t=this._engine.getRenderHeight(!0),i=this.getRenderWidth(),a=this.getRenderHeight();(i!==e||a!==t)&&(this.resize({width:e,height:t}),this._internalTextureDirty=!0)},r.prototype.updateCount=function(e,t,i){n.prototype.updateCount.call(this,e,t,i),this._internalTextureDirty=!0},r.prototype._resetPostProcessChain=function(){this._beforeCompositionPostProcesses.length=0},r.prototype.dispose=function(){var e=this._scene;if(n.prototype.dispose.call(this),e&&e.prePassRenderer){var t=e.prePassRenderer.renderTargets.indexOf(this);t!==-1&&e.prePassRenderer.renderTargets.splice(t,1)}this.imageProcessingPostProcess&&this.imageProcessingPostProcess.dispose(),this.renderTargetTexture&&(this.renderTargetTexture._prePassRenderTarget=null),this._outputPostProcess&&(this._outputPostProcess.autoClear=!0,this._outputPostProcess.restoreDefaultInputTexture())},r}(sn);export{B as A,De as B,et as C,wa as D,se as E,kt as F,V as G,Ji as H,Ie as I,Pn as J,Nn as K,An as L,xe as M,Kt as N,Pr as O,ji as P,Be as Q,Ba as R,Cr as S,bi as T,Ti as U,Ua as V,Xe as W,ot as X,Le as a,I as b,xr as c,qe as d,ge as e,yi as f,Va as g,ka as h,Mi as i,Ii as j,Ve as k,C as l,$e as m,Ai as n,Ga as o,za as p,La as q,ja as r,Si as s,R as t,sn as u,mr as v,Zi as w,qi as x,Wa as y,Ha as z};
