import{_ as b,j as s}from"./precisionDate.1704d4c6.js";import{g as D,s as h}from"./decorators.5af14a95.js";import{Vector3 as n,Matrix as f}from"./math.vector.560c6bc4.js";import{N as Z}from"./node.3cceef8b.js";import{L as v}from"./light.bd35649f.js";import{A as L}from"./math.axis.43721c0c.js";var P=function(a){b(t,a);function t(){var o=a!==null&&a.apply(this,arguments)||this;return o._needProjectionMatrixCompute=!0,o}return t.prototype._setPosition=function(o){this._position=o},Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(o){this._setPosition(o)},enumerable:!1,configurable:!0}),t.prototype._setDirection=function(o){this._direction=o},Object.defineProperty(t.prototype,"direction",{get:function(){return this._direction},set:function(o){this._setDirection(o)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shadowMinZ",{get:function(){return this._shadowMinZ},set:function(o){this._shadowMinZ=o,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shadowMaxZ",{get:function(){return this._shadowMaxZ},set:function(o){this._shadowMaxZ=o,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),t.prototype.computeTransformedInformation=function(){return this.parent&&this.parent.getWorldMatrix?(this.transformedPosition||(this.transformedPosition=n.Zero()),n.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=n.Zero()),n.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0):!1},t.prototype.getDepthScale=function(){return 50},t.prototype.getShadowDirection=function(o){return this.transformedDirection?this.transformedDirection:this.direction},t.prototype.getAbsolutePosition=function(){return this.transformedPosition?this.transformedPosition:this.position},t.prototype.setDirectionToTarget=function(o){return this.direction=n.Normalize(o.subtract(this.position)),this.direction},t.prototype.getRotation=function(){this.direction.normalize();var o=n.Cross(this.direction,L.Y),e=n.Cross(o,this.direction);return n.RotationFromAxis(o,e,this.direction)},t.prototype.needCube=function(){return!1},t.prototype.needProjectionMatrixCompute=function(){return this._needProjectionMatrixCompute},t.prototype.forceProjectionMatrixCompute=function(){this._needProjectionMatrixCompute=!0},t.prototype._initCache=function(){a.prototype._initCache.call(this),this._cache.position=n.Zero()},t.prototype._isSynchronized=function(){return!!this._cache.position.equals(this.position)},t.prototype.computeWorldMatrix=function(o){return!o&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=f.Identity()),f.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)},t.prototype.getDepthMinZ=function(o){return this.shadowMinZ!==void 0?this.shadowMinZ:o.minZ},t.prototype.getDepthMaxZ=function(o){return this.shadowMaxZ!==void 0?this.shadowMaxZ:o.maxZ},t.prototype.setShadowProjectionMatrix=function(o,e,u){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(e,u,o):this._setDefaultShadowProjectionMatrix(o,e,u),this},t.prototype._syncParentEnabledState=function(){a.prototype._syncParentEnabledState.call(this),(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition=null,this.transformedDirection=null)},s([D()],t.prototype,"position",null),s([D()],t.prototype,"direction",null),s([h()],t.prototype,"shadowMinZ",null),s([h()],t.prototype,"shadowMaxZ",null),t}(v);Z.AddNodeConstructor("Light_Type_1",function(a,t){return function(){return new T(a,n.Zero(),t)}});var T=function(a){b(t,a);function t(o,e,u){var i=a.call(this,o,u)||this;return i._shadowFrustumSize=0,i._shadowOrthoScale=.1,i.autoUpdateExtends=!0,i.autoCalcShadowZBounds=!1,i._orthoLeft=Number.MAX_VALUE,i._orthoRight=Number.MIN_VALUE,i._orthoTop=Number.MIN_VALUE,i._orthoBottom=Number.MAX_VALUE,i.position=e.scale(-1),i.direction=e,i}return Object.defineProperty(t.prototype,"shadowFrustumSize",{get:function(){return this._shadowFrustumSize},set:function(o){this._shadowFrustumSize=o,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shadowOrthoScale",{get:function(){return this._shadowOrthoScale},set:function(o){this._shadowOrthoScale=o,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"orthoLeft",{get:function(){return this._orthoLeft},set:function(o){this._orthoLeft=o},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"orthoRight",{get:function(){return this._orthoRight},set:function(o){this._orthoRight=o},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"orthoTop",{get:function(){return this._orthoTop},set:function(o){this._orthoTop=o},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"orthoBottom",{get:function(){return this._orthoBottom},set:function(o){this._orthoBottom=o},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"DirectionalLight"},t.prototype.getTypeID=function(){return v.LIGHTTYPEID_DIRECTIONALLIGHT},t.prototype._setDefaultShadowProjectionMatrix=function(o,e,u){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(o):this._setDefaultAutoExtendShadowProjectionMatrix(o,e,u)},t.prototype._setDefaultFixedFrustumShadowProjectionMatrix=function(o){var e=this.getScene().activeCamera;!e||f.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ,this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ,o,this.getScene().getEngine().isNDCHalfZRange)},t.prototype._setDefaultAutoExtendShadowProjectionMatrix=function(o,e,u){var i=this.getScene().activeCamera;if(!!i){if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){var r=n.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE;for(var c=Number.MAX_VALUE,d=Number.MIN_VALUE,p=0;p<u.length;p++){var m=u[p];if(!!m)for(var S=m.getBoundingInfo(),_=S.boundingBox,l=0;l<_.vectorsWorld.length;l++)n.TransformCoordinatesToRef(_.vectorsWorld[l],e,r),r.x<this._orthoLeft&&(this._orthoLeft=r.x),r.y<this._orthoBottom&&(this._orthoBottom=r.y),r.x>this._orthoRight&&(this._orthoRight=r.x),r.y>this._orthoTop&&(this._orthoTop=r.y),this.autoCalcShadowZBounds&&(r.z<c&&(c=r.z),r.z>d&&(d=r.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=c,this._shadowMaxZ=d)}var g=this._orthoRight-this._orthoLeft,y=this._orthoTop-this._orthoBottom,M=this.shadowMinZ!==void 0?this.shadowMinZ:i.minZ,x=this.shadowMaxZ!==void 0?this.shadowMaxZ:i.maxZ,w=this.getScene().getEngine().useReverseDepthBuffer;f.OrthoOffCenterLHToRef(this._orthoLeft-g*this.shadowOrthoScale,this._orthoRight+g*this.shadowOrthoScale,this._orthoBottom-y*this.shadowOrthoScale,this._orthoTop+y*this.shadowOrthoScale,w?x:M,w?M:x,o,this.getScene().getEngine().isNDCHalfZRange)}},t.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},t.prototype.transferToEffect=function(o,e){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,e),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,e),this)},t.prototype.transferToNodeMaterialEffect=function(o,e){return this.computeTransformedInformation()?(o.setFloat3(e,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(o.setFloat3(e,this.direction.x,this.direction.y,this.direction.z),this)},t.prototype.getDepthMinZ=function(o){var e=this._scene.getEngine();return!e.useReverseDepthBuffer&&e.isNDCHalfZRange?0:1},t.prototype.getDepthMaxZ=function(o){var e=this._scene.getEngine();return e.useReverseDepthBuffer&&e.isNDCHalfZRange?0:1},t.prototype.prepareLightSpecificDefines=function(o,e){o["DIRLIGHT"+e]=!0},s([h()],t.prototype,"shadowFrustumSize",null),s([h()],t.prototype,"shadowOrthoScale",null),s([h()],t.prototype,"autoUpdateExtends",void 0),s([h()],t.prototype,"autoCalcShadowZBounds",void 0),s([h("orthoLeft")],t.prototype,"_orthoLeft",void 0),s([h("orthoRight")],t.prototype,"_orthoRight",void 0),s([h("orthoTop")],t.prototype,"_orthoTop",void 0),s([h("orthoBottom")],t.prototype,"_orthoBottom",void 0),t}(P);export{T as D};
