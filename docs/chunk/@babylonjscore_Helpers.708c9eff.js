import{b as p,_ as m}from"./tslibtslib.b6e59fa7.js";import{O as b,L as C}from"./@babylonjscore_Misc.5aaba58d.js";import{c as S,d as B,V as I}from"./@babylonjscore_Cameras.05e2a1ea.js";import{b as O,P as L,C as D,a as _,A as w}from"./@babylonjscore_Maths.4b8bfdd1.js";import{M as g,C as R,h as P,T as G,d as T}from"./@babylonjscore_Meshes.9ddea1c8.js";import{B as x,C as k,i as M,b as h,j as z,P as j,S as F,V as N}from"./@babylonjscore_Materials.d4538583.js";import{S as l}from"./@babylonjscore_scene.c0faa314.js";import{H as A}from"./@babylonjscore_Lights.894f8849.js";import{c as U}from"./@babylonjscore_XR.06738b8c.js";import{P as Y}from"./@babylonjscore_Events.25582a49.js";var E=function(){function r(e,t){var s=this;this._errorHandler=function(o,n){s.onErrorObservable.notifyObservers({message:o,exception:n})},this._options=p(p({},r._GetDefaultOptions()),e),this._scene=t,this.onErrorObservable=new b,this._setupBackground(),this._setupImageProcessing()}return r._GetDefaultOptions=function(){return{createGround:!0,groundSize:15,groundTexture:this._GroundTextureCDNUrl,groundColor:new D(.2,.2,.3).toLinearSpace().scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:this._SkyboxTextureCDNUrl,skyboxColor:new D(.2,.2,.3).toLinearSpace().scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:_.Zero(),setupImageProcessing:!0,environmentTexture:this._EnvironmentTextureCDNUrl,cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}},Object.defineProperty(r.prototype,"rootMesh",{get:function(){return this._rootMesh},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"skybox",{get:function(){return this._skybox},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"skyboxTexture",{get:function(){return this._skyboxTexture},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"skyboxMaterial",{get:function(){return this._skyboxMaterial},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"ground",{get:function(){return this._ground},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"groundTexture",{get:function(){return this._groundTexture},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"groundMirror",{get:function(){return this._groundMirror},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"groundMirrorRenderList",{get:function(){return this._groundMirror?this._groundMirror.renderList:null},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"groundMaterial",{get:function(){return this._groundMaterial},enumerable:!1,configurable:!0}),r.prototype.updateOptions=function(e){var t=p(p({},this._options),e);this._ground&&!t.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!t.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=t.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!t.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!t.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=t.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!t.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=t.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=t,this._setupBackground(),this._setupImageProcessing()},r.prototype.setMainColor=function(e){this.groundMaterial&&(this.groundMaterial.primaryColor=e),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=e),this.groundMirror&&(this.groundMirror.clearColor=new O(e.r,e.g,e.b,1))},r.prototype._setupImageProcessing=function(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())},r.prototype._setupEnvironmentTexture=function(){if(!this._scene.environmentTexture){if(this._options.environmentTexture instanceof x){this._scene.environmentTexture=this._options.environmentTexture;return}var e=k.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=e}},r.prototype._setupBackground=function(){this._rootMesh||(this._rootMesh=new g("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;var e=this._getSceneSize();this._options.createGround&&(this._setupGround(e),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(e),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(e),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=e.rootPosition.x,this._rootMesh.position.z=e.rootPosition.z,this._rootMesh.position.y=e.rootPosition.y},r.prototype._getSceneSize=function(){var e=this,t=this._options.groundSize,s=this._options.skyboxSize,o=this._options.rootPosition;if(!this._scene.meshes||this._scene.meshes.length===1)return{groundSize:t,skyboxSize:s,rootPosition:o};var n=this._scene.getWorldExtends(function(u){return u!==e._ground&&u!==e._rootMesh&&u!==e._skybox}),a=n.max.subtract(n.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof S&&this._scene.activeCamera.upperRadiusLimit&&(t=this._scene.activeCamera.upperRadiusLimit*2,s=t);var i=a.length();i>t&&(t=i*2,s=t),t*=1.1,s*=1.5,o=n.min.add(a.scale(.5)),o.y=n.min.y-this._options.groundYBias}return{groundSize:t,skyboxSize:s,rootPosition:o}},r.prototype._setupGround=function(e){var t=this;(!this._ground||this._ground.isDisposed())&&(this._ground=R("BackgroundPlane",{size:e.groundSize},this._scene),this._ground.rotation.x=Math.PI/2,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add(function(){t._ground=null})),this._ground.receiveShadows=this._options.enableGroundShadow},r.prototype._setupGroundMaterial=function(){this._groundMaterial||(this._groundMaterial=new M("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)},r.prototype._setupGroundDiffuseTexture=function(){if(!!this._groundMaterial&&!this._groundTexture){if(this._options.groundTexture instanceof x){this._groundMaterial.diffuseTexture=this._options.groundTexture;return}this._groundTexture=new h(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture}},r.prototype._setupGroundMirrorTexture=function(e){var t=h.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new z("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,h.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new L(0,-1,0,e.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=t,this._groundMirror.wrapV=t,this._groundMirror.renderList))for(var s=0;s<this._scene.meshes.length;s++){var o=this._scene.meshes[s];o!==this._ground&&o!==this._skybox&&o!==this._rootMesh&&this._groundMirror.renderList.push(o)}var n=this._options.groundColor.toGammaSpace();this._groundMirror.clearColor=new O(n.r,n.g,n.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel},r.prototype._setupMirrorInGroundMaterial=function(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)},r.prototype._setupSkybox=function(e){var t=this;(!this._skybox||this._skybox.isDisposed())&&(this._skybox=P("BackgroundSkybox",{size:e.skyboxSize,sideOrientation:g.BACKSIDE},this._scene),this._skybox.onDisposeObservable.add(function(){t._skybox=null})),this._skybox.parent=this._rootMesh},r.prototype._setupSkyboxMaterial=function(){!this._skybox||(this._skyboxMaterial||(this._skyboxMaterial=new M("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)},r.prototype._setupSkyboxReflectionTexture=function(){if(!!this._skyboxMaterial&&!this._skyboxTexture){if(this._options.skyboxTexture instanceof x){this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture;return}this._skyboxTexture=new k(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=h.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture}},r.prototype.dispose=function(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)},r._GroundTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundGround.png",r._SkyboxTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundSkybox.dds",r._EnvironmentTextureCDNUrl="https://assets.babylonjs.com/environments/environmentSpecular.env",r}(),f=function(r){m(e,r);function e(t,s,o,n,a){a===void 0&&(a=null);var i=r.call(this,t,n)||this;i.onError=a,i._halfDome=!1,i._crossEye=!1,i._useDirectMapping=!1,i._textureMode=e.MODE_MONOSCOPIC,i._onBeforeCameraRenderObserver=null,i.onLoadErrorObservable=new b,i.onLoadObservable=new b,n=i.getScene(),t=t||"textureDome",o.resolution=Math.abs(o.resolution)|0||32,o.clickToPlay=Boolean(o.clickToPlay),o.autoPlay=o.autoPlay===void 0?!0:Boolean(o.autoPlay),o.loop=o.loop===void 0?!0:Boolean(o.loop),o.size=Math.abs(o.size)||(n.activeCamera?n.activeCamera.maxZ*.48:1e3),o.useDirectMapping===void 0?i._useDirectMapping=!0:i._useDirectMapping=o.useDirectMapping,o.faceForward===void 0&&(o.faceForward=!0),i._setReady(!1),o.mesh?i._mesh=o.mesh:i._mesh=T(t+"_mesh",{segments:o.resolution,diameter:o.size,updatable:!1,sideOrientation:g.BACKSIDE},n);var u=i._material=new M(t+"_material",n);u.useEquirectangularFOV=!0,u.fovMultiplier=1,u.opacityFresnel=!1;var d=i._initTexture(s,n,o);if(i.texture=d,i._mesh.material=u,i._mesh.parent=i,i._halfDomeMask=T("",{slice:.5,diameter:o.size*.98,segments:o.resolution*2,sideOrientation:g.BACKSIDE},n),i._halfDomeMask.rotate(w.X,-Math.PI/2),i._halfDomeMask.parent=i._mesh,i._halfDome=!!o.halfDomeMode,i._halfDomeMask.setEnabled(i._halfDome),i._crossEye=!!o.crossEyeMode,i._texture.anisotropicFilteringLevel=1,i._texture.onLoadObservable.addOnce(function(){i._setReady(!0)}),o.faceForward&&n.activeCamera){var c=n.activeCamera,y=_.Forward(),v=_.TransformNormal(y,c.getViewMatrix());v.normalize(),i.rotation.y=Math.acos(_.Dot(y,v))}return i._changeTextureMode(i._textureMode),i}return Object.defineProperty(e.prototype,"texture",{get:function(){return this._texture},set:function(t){this._texture!==t&&(this._texture=t,this._useDirectMapping?(this._texture.wrapU=h.CLAMP_ADDRESSMODE,this._texture.wrapV=h.CLAMP_ADDRESSMODE,this._material.diffuseTexture=this._texture):(this._texture.coordinatesMode=h.FIXED_EQUIRECTANGULAR_MIRRORED_MODE,this._texture.wrapV=h.CLAMP_ADDRESSMODE,this._material.reflectionTexture=this._texture),this._changeTextureMode(this._textureMode))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mesh",{get:function(){return this._mesh},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"fovMultiplier",{get:function(){return this._material.fovMultiplier},set:function(t){this._material.fovMultiplier=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"textureMode",{get:function(){return this._textureMode},set:function(t){this._textureMode!==t&&this._changeTextureMode(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"halfDome",{get:function(){return this._halfDome},set:function(t){this._halfDome=t,this._halfDomeMask.setEnabled(t),this._changeTextureMode(this._textureMode)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"crossEye",{get:function(){return this._crossEye},set:function(t){this._crossEye=t,this._changeTextureMode(this._textureMode)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"material",{get:function(){return this._material},enumerable:!1,configurable:!0}),e.prototype._changeTextureMode=function(t){var s=this;switch(this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._textureMode=t,this._texture.uScale=1,this._texture.vScale=1,this._texture.uOffset=0,this._texture.vOffset=0,this._texture.vAng=0,t){case e.MODE_MONOSCOPIC:this._halfDome&&(this._texture.uScale=2,this._texture.uOffset=-1);break;case e.MODE_SIDEBYSIDE:{this._texture.uScale=this._halfDome?.99999:.5;var o=this._halfDome?0:.5,n=this._halfDome?-.5:0;this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(function(a){var i=a.isRightCamera;s._crossEye&&(i=!i),i?s._texture.uOffset=o:s._texture.uOffset=n});break}case e.MODE_TOPBOTTOM:this._texture.vScale=this._halfDome?.99999:.5,this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(function(a){var i=a.isRightCamera;s._crossEye&&(i=!i),s._texture.vOffset=i?.5:0});break}},e.prototype.dispose=function(t,s){s===void 0&&(s=!1),this._texture.dispose(),this._mesh.dispose(),this._material.dispose(),this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this.onLoadErrorObservable.clear(),this.onLoadObservable.clear(),r.prototype.dispose.call(this,t,s)},e.MODE_MONOSCOPIC=0,e.MODE_TOPBOTTOM=1,e.MODE_SIDEBYSIDE=2,e}(G);(function(r){m(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return Object.defineProperty(e.prototype,"photoTexture",{get:function(){return this.texture},set:function(t){this.texture=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"imageMode",{get:function(){return this.textureMode},set:function(t){this.textureMode=t},enumerable:!1,configurable:!0}),e.prototype._initTexture=function(t,s,o){var n=this;return new h(t,s,!o.generateMipMaps,!this._useDirectMapping,void 0,function(){n.onLoadObservable.notifyObservers()},function(a,i){n.onLoadErrorObservable.notifyObservers(a||"Unknown error occured"),n.onError&&n.onError(a,i)})},e.MODE_MONOSCOPIC=f.MODE_MONOSCOPIC,e.MODE_TOPBOTTOM=f.MODE_TOPBOTTOM,e.MODE_SIDEBYSIDE=f.MODE_SIDEBYSIDE,e})(f);l.prototype.createDefaultLight=function(r){if(r===void 0&&(r=!1),r&&this.lights)for(var e=0;e<this.lights.length;e++)this.lights[e].dispose();this.lights.length===0&&new A("default light",_.Up(),this)};l.prototype.createDefaultCamera=function(r,e,t){if(r===void 0&&(r=!1),e===void 0&&(e=!1),t===void 0&&(t=!1),e&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){var s=this.getWorldExtends(function(c){return c.isVisible&&c.isEnabled()}),o=s.max.subtract(s.min),n=s.min.add(o.scale(.5)),a=void 0,i=o.length()*1.5;if(isFinite(i)||(i=1,n.copyFromFloats(0,0,0)),r){var u=new S("default camera",-(Math.PI/2),Math.PI/2,i,n,this);u.lowerRadiusLimit=i*.01,u.wheelPrecision=100/i,a=u}else{var d=new B("default camera",new _(n.x,n.y,-i),this);d.setTarget(n),a=d}a.minZ=i*.01,a.maxZ=i*1e3,a.speed=i*.2,this.activeCamera=a,t&&a.attachControl()}};l.prototype.createDefaultCameraOrLight=function(r,e,t){r===void 0&&(r=!1),e===void 0&&(e=!1),t===void 0&&(t=!1),this.createDefaultLight(e),this.createDefaultCamera(r,e,t)};l.prototype.createDefaultSkybox=function(r,e,t,s,o){if(e===void 0&&(e=!1),t===void 0&&(t=1e3),s===void 0&&(s=0),o===void 0&&(o=!0),!r)return C.Warn("Can not create default skybox without environment texture."),null;o&&r&&(this.environmentTexture=r);var n=P("hdrSkyBox",{size:t},this);if(e){var a=new j("skyBox",this);a.backFaceCulling=!1,a.reflectionTexture=r.clone(),a.reflectionTexture&&(a.reflectionTexture.coordinatesMode=h.SKYBOX_MODE),a.microSurface=1-s,a.disableLighting=!0,a.twoSidedLighting=!0,n.material=a}else{var i=new F("skyBox",this);i.backFaceCulling=!1,i.reflectionTexture=r.clone(),i.reflectionTexture&&(i.reflectionTexture.coordinatesMode=h.SKYBOX_MODE),i.disableLighting=!0,n.material=i}return n.isPickable=!1,n.infiniteDistance=!0,n.ignoreCameraMaxZ=!0,n};l.prototype.createDefaultEnvironment=function(r){return E?new E(r,this):null};l.prototype.createDefaultVRExperience=function(r){return r===void 0&&(r={}),new I(this,r)};l.prototype.createDefaultXRExperienceAsync=function(r){return r===void 0&&(r={}),U.CreateAsync(this,r).then(function(e){return e})};(function(r){m(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return Object.defineProperty(e.prototype,"videoTexture",{get:function(){return this._texture},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"videoMode",{get:function(){return this.textureMode},set:function(t){this.textureMode=t},enumerable:!1,configurable:!0}),e.prototype._initTexture=function(t,s,o){var n=this,a={loop:o.loop,autoPlay:o.autoPlay,autoUpdateTexture:!0,poster:o.poster},i=new N((this.name||"videoDome")+"_texture",t,s,o.generateMipMaps,this._useDirectMapping,h.TRILINEAR_SAMPLINGMODE,a);return o.clickToPlay&&(this._pointerObserver=s.onPointerObservable.add(function(u){u.type!==Y.POINTERUP&&n._texture.video.play()})),this._textureObserver=i.onLoadObservable.add(function(){n.onLoadObservable.notifyObservers()}),i},e.prototype.dispose=function(t,s){s===void 0&&(s=!1),this._texture.onLoadObservable.remove(this._textureObserver),this._scene.onPointerObservable.remove(this._pointerObserver),r.prototype.dispose.call(this,t,s)},e.MODE_MONOSCOPIC=f.MODE_MONOSCOPIC,e.MODE_TOPBOTTOM=f.MODE_TOPBOTTOM,e.MODE_SIDEBYSIDE=f.MODE_SIDEBYSIDE,e})(f);
