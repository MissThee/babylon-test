import{W as v,L as u,ad as _,a as y}from"./@babylonjscore_Misc.5aaba58d.js";import{a as E}from"./@babylonjscore_Engines.77a493e8.js";E.OfflineProviderFactory=function(f,t,e){return e===void 0&&(e=!1),new m(f,t,e)};var m=function(){function f(t,e,n){n===void 0&&(n=!1),this._idbFactory=typeof indexedDB!="undefined"?indexedDB:void 0,this._currentSceneUrl=f._ReturnFullUrlLocation(t),this._db=null,this._enableSceneOffline=!1,this._enableTexturesOffline=!1,this._manifestVersionFound=0,this._mustUpdateRessources=!1,this._hasReachedQuota=!1,f.IDBStorageEnabled?n?(this._enableSceneOffline=!0,this._enableTexturesOffline=!0,this._manifestVersionFound=1,y.SetImmediate(function(){e(!0)})):this._checkManifestFile(e):e(!0)}return Object.defineProperty(f.prototype,"enableSceneOffline",{get:function(){return this._enableSceneOffline},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"enableTexturesOffline",{get:function(){return this._enableTexturesOffline},enumerable:!1,configurable:!0}),f.prototype._checkManifestFile=function(t){var e=this,n=function(){e._enableSceneOffline=!1,e._enableTexturesOffline=!1,t(!1)},r=function(){try{if(typeof URL=="function"&&e._currentSceneUrl.indexOf("http")===0){var a=new URL(e._currentSceneUrl);return a.pathname+=".manifest",a.toString()}}catch{}return"".concat(e._currentSceneUrl,".manifest")},s=!1,i=r(),o=new v;navigator.onLine&&(s=!0,i=i+(i.match(/\?/)==null?"?":"&")+Date.now()),o.open("GET",i),o.addEventListener("load",function(){if(o.status===200||f._ValidateXHRData(o,1))try{var a=JSON.parse(o.response);e._enableSceneOffline=a.enableSceneOffline,e._enableTexturesOffline=a.enableTexturesOffline&&f._IsUASupportingBlobStorage,a.version&&!isNaN(parseInt(a.version))&&(e._manifestVersionFound=a.version),t(!0)}catch{n()}else n()},!1),o.addEventListener("error",function(){if(s){s=!1;var a=r();o.open("GET",a),o.send()}else n()},!1);try{o.send()}catch{u.Error("Error on XHR send request."),t(!1)}},f.prototype.open=function(t,e){var n=this,r=function(){n._isSupported=!1,e&&e()};if(!this._idbFactory||!(this._enableSceneOffline||this._enableTexturesOffline))this._isSupported=!1,e&&e();else if(this._db)t&&t();else{this._hasReachedQuota=!1,this._isSupported=!0;var s=this._idbFactory.open("babylonjs",1);s.onerror=function(){r()},s.onblocked=function(){u.Error("IDB request blocked. Please reload the page."),r()},s.onsuccess=function(){n._db=s.result,t()},s.onupgradeneeded=function(i){if(n._db=i.target.result,n._db)try{n._db.createObjectStore("scenes",{keyPath:"sceneUrl"}),n._db.createObjectStore("versions",{keyPath:"sceneUrl"}),n._db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(o){u.Error("Error while creating object stores. Exception: "+o.message),r()}}}},f.prototype.loadImage=function(t,e){var n=this,r=f._ReturnFullUrlLocation(t),s=function(){!n._hasReachedQuota&&n._db!==null?n._saveImageIntoDBAsync(r,e):e.src=t};this._mustUpdateRessources?s():this._loadImageFromDBAsync(r,e,s)},f.prototype._loadImageFromDBAsync=function(t,e,n){if(this._isSupported&&this._db!==null){var r,s=this._db.transaction(["textures"]);s.onabort=function(){e.src=t},s.oncomplete=function(){var o;r&&typeof URL=="function"?(o=URL.createObjectURL(r.data),e.onerror=function(){u.Error("Error loading image from blob URL: "+o+" switching back to web url: "+t),e.src=t},e.src=o):n()};var i=s.objectStore("textures").get(t);i.onsuccess=function(o){r=o.target.result},i.onerror=function(){u.Error("Error loading texture "+t+" from DB."),e.src=t}}else u.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),e.src=t},f.prototype._saveImageIntoDBAsync=function(t,e){var n=this,r;if(this._isSupported){var s=function(){var o;if(r&&typeof URL=="function")try{o=URL.createObjectURL(r)}catch{o=URL.createObjectURL(r)}o&&(e.src=o)};if(f._IsUASupportingBlobStorage){var i=new v;i.open("GET",t),i.responseType="blob",i.addEventListener("load",function(){if(i.status===200&&n._db){r=i.response;var o=n._db.transaction(["textures"],"readwrite");o.onabort=function(d){try{var p=d.srcElement||d.target,l=p.error;l&&l.name==="QuotaExceededError"&&(n._hasReachedQuota=!0)}catch{}s()},o.oncomplete=function(){s()};var a={textureUrl:t,data:r};try{var c=o.objectStore("textures").put(a);c.onsuccess=function(){},c.onerror=function(){s()}}catch(d){d.code===25&&(f._IsUASupportingBlobStorage=!1,n._enableTexturesOffline=!1),e.src=t}}else e.src=t},!1),i.addEventListener("error",function(){u.Error("Error in XHR request in BABYLON.Database."),e.src=t},!1),i.send()}else e.src=t}else u.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),e.src=t},f.prototype._checkVersionFromDB=function(t,e){var n=this,r=function(){n._saveVersionIntoDBAsync(t,e)};this._loadVersionFromDBAsync(t,e,r)},f.prototype._loadVersionFromDBAsync=function(t,e,n){var r=this;if(this._isSupported&&this._db){var s;try{var i=this._db.transaction(["versions"]);i.oncomplete=function(){s?r._manifestVersionFound!==s.data?(r._mustUpdateRessources=!0,n()):e(s.data):(r._mustUpdateRessources=!0,n())},i.onabort=function(){e(-1)};var o=i.objectStore("versions").get(t);o.onsuccess=function(a){s=a.target.result},o.onerror=function(){u.Error("Error loading version for scene "+t+" from DB."),e(-1)}}catch(a){u.Error("Error while accessing 'versions' object store (READ OP). Exception: "+a.message),e(-1)}}else u.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),e(-1)},f.prototype._saveVersionIntoDBAsync=function(t,e){var n=this;if(this._isSupported&&!this._hasReachedQuota&&this._db)try{var r=this._db.transaction(["versions"],"readwrite");r.onabort=function(o){try{var a=o.srcElement.error;a&&a.name==="QuotaExceededError"&&(n._hasReachedQuota=!0)}catch{}e(-1)},r.oncomplete=function(){e(n._manifestVersionFound)};var s={sceneUrl:t,data:this._manifestVersionFound},i=r.objectStore("versions").put(s);i.onsuccess=function(){},i.onerror=function(){u.Error("Error in DB add version request in BABYLON.Database.")}}catch(o){u.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+o.message),e(-1)}else e(-1)},f.prototype.loadFile=function(t,e,n,r,s){var i=this,o=f._ReturnFullUrlLocation(t),a=function(){i._saveFileAsync(o,e,n,s,r)};this._checkVersionFromDB(o,function(c){c!==-1?i._mustUpdateRessources?i._saveFileAsync(o,e,n,s,r):i._loadFileAsync(o,e,a):r&&r()})},f.prototype._loadFileAsync=function(t,e,n){if(this._isSupported&&this._db){var r=void 0;t.indexOf(".babylon")!==-1?r="scenes":r="textures";var s,i=this._db.transaction([r]);i.oncomplete=function(){s?e(s.data):n()},i.onabort=function(){n()};var o=i.objectStore(r).get(t);o.onsuccess=function(a){s=a.target.result},o.onerror=function(){u.Error("Error loading file "+t+" from DB."),n()}}else u.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),e()},f.prototype._saveFileAsync=function(t,e,n,r,s){var i=this;if(this._isSupported){var o;t.indexOf(".babylon")!==-1?o="scenes":o="textures";var a=new v,c;a.open("GET",t+(t.match(/\?/)==null?"?":"&")+Date.now()),r&&(a.responseType="arraybuffer"),n&&(a.onprogress=n),a.addEventListener("load",function(){if(a.status===200||a.status<400&&f._ValidateXHRData(a,r?6:1))if(c=r?a.response:a.responseText,!i._hasReachedQuota&&i._db){var d=i._db.transaction([o],"readwrite");d.onabort=function(h){try{var b=h.srcElement.error;b&&b.name==="QuotaExceededError"&&(i._hasReachedQuota=!0)}catch{}e(c)},d.oncomplete=function(){e(c)};var p=void 0;o==="scenes"?p={sceneUrl:t,data:c,version:i._manifestVersionFound}:p={textureUrl:t,data:c};try{var l=d.objectStore(o).put(p);l.onsuccess=function(){},l.onerror=function(){u.Error("Error in DB add file request in BABYLON.Database.")}}catch{e(c)}}else e(c);else a.status>=400&&s?s(a):e()},!1),a.addEventListener("error",function(){u.Error("error on XHR request."),s&&s()},!1),a.send()}else u.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),s&&s()},f._ValidateXHRData=function(t,e){e===void 0&&(e=7);try{if(e&1){if(t.responseText&&t.responseText.length>0)return!0;if(e===1)return!1}if(e&2){var n=_(t.response);if(n.width&&n.height&&n.width>0&&n.height>0)return!0;if(e===2)return!1}if(e&4){var r=new Uint8Array(t.response,0,3);return r[0]===68&&r[1]===68&&r[2]===83}}catch{}return!1},f._IsUASupportingBlobStorage=!0,f.IDBStorageEnabled=!1,f._ParseURL=function(t){var e=document.createElement("a");e.href=t;var n=t.substring(0,t.lastIndexOf("#")),r=t.substring(n.lastIndexOf("/")+1,t.length),s=t.substring(0,t.indexOf(r,0));return s},f._ReturnFullUrlLocation=function(t){return t.indexOf("http:/")===-1&&t.indexOf("https:/")===-1&&typeof window!="undefined"?f._ParseURL(window.location.href)+t:t},f}();
