import{S as D}from"./@babylonjscore_scene.fc9d9dc0.js";import{V as _}from"./@babylonjscore_Buffers.f937a5fd.js";import{A as pe,m as We,L as Ie,I as Ge,M as xe}from"./@babylonjscore_Meshes.307935b5.js";import{a as U,C as ee,b as Q,M as $,T as S}from"./@babylonjscore_Maths.f3ef132c.js";import{f as V,j as ke,O as de,_ as _e,L as ye}from"./@babylonjscore_Misc.d81f49ec.js";import{S as P}from"./@babylonjscore_sceneComponent.4b70ec43.js";import{b as H,k as Ve,l as W,t as Se,u as Z,M as G,U as Ce,c as Pe,d as ce,v as le,w as ve,x as Ke,y as He}from"./@babylonjscore_Materials.00e32dae.js";import"./@babylonjscore_Shaders.73b25e8e.js";import{C as De}from"./@babylonjscore_Cameras.db49b33d.js";import{_ as qe}from"./tslibtslib.b6e59fa7.js";import{d as je}from"./@babylonjscore_PostProcesses.4413212a.js";import{A as Xe}from"./@babylonjscore_abstractScene.d5c48c49.js";import{a as Te,P as w}from"./@babylonjscore_Events.8e5561d2.js";import{P as ze}from"./@babylonjscore_Collisions.6bd46217.js";import{E as Me}from"./@babylonjscore_Engines.7287f97a.js";import{H as Ye}from"./@babylonjscore_Lights.ab2a2b54.js";var Qe=function(){function r(e,t,i,s,n){i===void 0&&(i=null),s===void 0&&(s=null),n===void 0&&(n=null),this.index=e,this._opaqueSubMeshes=new V(256),this._transparentSubMeshes=new V(256),this._alphaTestSubMeshes=new V(256),this._depthOnlySubMeshes=new V(256),this._particleSystems=new V(256),this._spriteManagers=new V(256),this._empty=!0,this._edgesRenderers=new ke(16),this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=s,this.transparentSortCompareFn=n}return Object.defineProperty(r.prototype,"opaqueSortCompareFn",{set:function(e){e?this._opaqueSortCompareFn=e:this._opaqueSortCompareFn=r.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"alphaTestSortCompareFn",{set:function(e){e?this._alphaTestSortCompareFn=e:this._alphaTestSortCompareFn=r.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"transparentSortCompareFn",{set:function(e){e?this._transparentSortCompareFn=e:this._transparentSortCompareFn=r.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted},enumerable:!1,configurable:!0}),r.prototype.render=function(e,t,i,s){if(e){e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}var n=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(n.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),n.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);var a=n.getStencilBuffer();if(n.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(s),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(n.setStencilBuffer(a),this._scene.useOrderIndependentTransparency){var f=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);f.length&&this._renderTransparent(f)}else this._renderTransparent(this._transparentSubMeshes);n.setAlphaMode(0)}if(n.setStencilBuffer(!1),this._edgesRenderers.length){for(var l=0;l<this._edgesRenderers.length;l++)this._edgesRenderers.data[l].render();n.setAlphaMode(0)}n.setStencilBuffer(a)},r.prototype._renderOpaqueSorted=function(e){return r._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)},r.prototype._renderAlphaTestSorted=function(e){return r._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)},r.prototype._renderTransparentSorted=function(e){return r._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)},r._RenderSorted=function(e,t,i,s){var n=0,a,f=i?i.globalPosition:r._ZeroVector;if(s)for(;n<e.length;n++)a=e.data[n],a._alphaIndex=a.getMesh().alphaIndex,a._distanceToCamera=U.Distance(a.getBoundingInfo().boundingSphere.centerWorld,f);var l=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&l.sort(t);var o=l[0].getMesh().getScene();for(n=0;n<l.length;n++)if(a=l[n],!(o._activeMeshesFrozenButKeepClipping&&!a.isInFrustum(o._frustumPlanes))){if(s){var u=a.getMaterial();if(u&&u.needDepthPrePass){var d=u.getScene().getEngine();d.setColorWrite(!1),d.setAlphaMode(0),a.render(!1),d.setColorWrite(!0)}}a.render(s)}},r.defaultTransparentSortCompare=function(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:r.backToFrontSortCompare(e,t)},r.backToFrontSortCompare=function(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0},r.frontToBackSortCompare=function(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0},r.PainterSortCompare=function(e,t){var i=e.getMesh(),s=t.getMesh();return i.material&&s.material?i.material.uniqueId-s.material.uniqueId:i.uniqueId-s.uniqueId},r.prototype.prepare=function(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this._spriteManagers.reset(),this._edgesRenderers.reset(),this._empty=!0},r.prototype.dispose=function(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()},r.prototype.dispatch=function(e,t,i){t===void 0&&(t=e.getMesh()),i===void 0&&(i=e.getMaterial()),i!=null&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTesting()?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)},r.prototype.dispatchSprites=function(e){this._spriteManagers.push(e),this._empty=!1},r.prototype.dispatchParticles=function(e){this._particleSystems.push(e),this._empty=!1},r.prototype._renderParticles=function(e){if(this._particleSystems.length!==0){var t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(var i=0;i<this._particleSystems.length;i++){var s=this._particleSystems.data[i];if((t&&t.layerMask&s.layerMask)!==0){var n=s.emitter;(!n.position||!e||e.indexOf(n)!==-1)&&this._scene._activeParticles.addCount(s.render(),!1)}}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}},r.prototype._renderSprites=function(){if(!(!this._scene.spritesEnabled||this._spriteManagers.length===0)){var e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(var t=0;t<this._spriteManagers.length;t++){var i=this._spriteManagers.data[t];(e&&e.layerMask&i.layerMask)!==0&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}},r._ZeroVector=U.Zero(),r}(),Ze=function(){function r(){}return r}(),St=function(){function r(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new Ze,this._scene=e;for(var t=r.MIN_RENDERINGGROUPS;t<r.MAX_RENDERINGGROUPS;t++)this._autoClearDepthStencil[t]={autoClear:!0,depth:!0,stencil:!0}}return r.prototype._clearDepthStencilBuffer=function(e,t){e===void 0&&(e=!0),t===void 0&&(t=!0),!this._depthStencilBufferAlreadyCleaned&&(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)},r.prototype.render=function(e,t,i,s){var n=this._renderingGroupInfo;if(n.scene=this._scene,n.camera=this._scene.activeCamera,this._scene.spriteManagers&&s)for(var a=0;a<this._scene.spriteManagers.length;a++){var f=this._scene.spriteManagers[a];this.dispatchSprites(f)}for(var a=r.MIN_RENDERINGGROUPS;a<r.MAX_RENDERINGGROUPS;a++){this._depthStencilBufferAlreadyCleaned=a===r.MIN_RENDERINGGROUPS;var l=this._renderingGroups[a];if(!(!l||l._empty)){var o=Math.pow(2,a);if(n.renderingGroupId=a,this._scene.onBeforeRenderingGroupObservable.notifyObservers(n,o),r.AUTOCLEAR){var u=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(a):this._autoClearDepthStencil[a];u&&u.autoClear&&this._clearDepthStencilBuffer(u.depth,u.stencil)}for(var d=0,c=this._scene._beforeRenderingGroupDrawStage;d<c.length;d++){var h=c[d];h.action(a)}l.render(e,s,i,t);for(var p=0,m=this._scene._afterRenderingGroupDrawStage;p<m.length;p++){var h=m[p];h.action(a)}this._scene.onAfterRenderingGroupObservable.notifyObservers(n,o)}}},r.prototype.reset=function(){for(var e=r.MIN_RENDERINGGROUPS;e<r.MAX_RENDERINGGROUPS;e++){var t=this._renderingGroups[e];t&&t.prepare()}},r.prototype.dispose=function(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null},r.prototype.freeRenderingGroups=function(){for(var e=r.MIN_RENDERINGGROUPS;e<r.MAX_RENDERINGGROUPS;e++){var t=this._renderingGroups[e];t&&t.dispose()}},r.prototype._prepareRenderingGroup=function(e){this._renderingGroups[e]===void 0&&(this._renderingGroups[e]=new Qe(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))},r.prototype.dispatchSprites=function(e){var t=e.renderingGroupId||0;this._prepareRenderingGroup(t),this._renderingGroups[t].dispatchSprites(e)},r.prototype.dispatchParticles=function(e){var t=e.renderingGroupId||0;this._prepareRenderingGroup(t),this._renderingGroups[t].dispatchParticles(e)},r.prototype.dispatch=function(e,t,i){t===void 0&&(t=e.getMesh());var s=t.renderingGroupId||0;this._prepareRenderingGroup(s),this._renderingGroups[s].dispatch(e,t,i)},r.prototype.setRenderingOrder=function(e,t,i,s){if(t===void 0&&(t=null),i===void 0&&(i=null),s===void 0&&(s=null),this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=s,this._renderingGroups[e]){var n=this._renderingGroups[e];n.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],n.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],n.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}},r.prototype.setRenderingAutoClearDepthStencil=function(e,t,i,s){i===void 0&&(i=!0),s===void 0&&(s=!0),this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:s}},r.prototype.getAutoClearDepthStencilSetup=function(e){return this._autoClearDepthStencil[e]},r.MAX_RENDERINGGROUPS=4,r.MIN_RENDERINGGROUPS=0,r.AUTOCLEAR=!0,r}(),Ct=function(){function r(e,t){t===void 0&&(t=!0);var i=this;this.originalScene=e,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new de,this.utilityLayerScene=new D(e.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=e.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),t&&(this._originalPointerObserver=e.onPrePointerObservable.add(function(s){if(!!i.utilityLayerScene.activeCamera&&!!i.pickingEnabled&&!(!i.processAllEvents&&s.type!==w.POINTERMOVE&&s.type!==w.POINTERUP&&s.type!==w.POINTERDOWN&&s.type!==w.POINTERDOUBLETAP)){i.utilityLayerScene.pointerX=e.pointerX,i.utilityLayerScene.pointerY=e.pointerY;var n=s.event;if(e.isPointerCaptured(n.pointerId)){i._pointerCaptures[n.pointerId]=!1;return}var a=function(u){var d=null;if(s.nearInteractionPickingInfo)s.nearInteractionPickingInfo.pickedMesh.getScene()==u?d=s.nearInteractionPickingInfo:d=new ze;else{var c=null;i._renderCamera&&(c=u._activeCamera,u._activeCamera=i._renderCamera,s.ray=null),d=s.ray?u.pickWithRay(s.ray):u.pick(e.pointerX,e.pointerY),c&&(u._activeCamera=c)}return d},f=a(i.utilityLayerScene);if(!s.ray&&f&&(s.ray=f.ray),i.utilityLayerScene.onPrePointerObservable.notifyObservers(s),i.onlyCheckPointerDownEvents&&s.type!=w.POINTERDOWN){s.skipOnPointerObservable||i.utilityLayerScene.onPointerObservable.notifyObservers(new Te(s.type,s.event,f),s.type),s.type===w.POINTERUP&&i._pointerCaptures[n.pointerId]&&(i._pointerCaptures[n.pointerId]=!1);return}if(i.utilityLayerScene.autoClearDepthAndStencil||i.pickUtilitySceneFirst)f&&f.hit&&(s.skipOnPointerObservable||i.utilityLayerScene.onPointerObservable.notifyObservers(new Te(s.type,s.event,f),s.type),s.skipOnPointerObservable=!0);else{var l=a(e),o=s.event;l&&f&&(f.distance===0&&l.pickedMesh?i.mainSceneTrackerPredicate&&i.mainSceneTrackerPredicate(l.pickedMesh)?(i._notifyObservers(s,l,o),s.skipOnPointerObservable=!0):s.type===w.POINTERDOWN?i._pointerCaptures[o.pointerId]=!0:(s.type===w.POINTERMOVE||s.type===w.POINTERUP)&&(i._lastPointerEvents[o.pointerId]&&(i.onPointerOutObservable.notifyObservers(o.pointerId),delete i._lastPointerEvents[o.pointerId]),i._notifyObservers(s,l,o)):!i._pointerCaptures[o.pointerId]&&(f.distance<l.distance||l.distance===0)?(i._notifyObservers(s,f,o),s.skipOnPointerObservable||(s.skipOnPointerObservable=f.distance>0)):!i._pointerCaptures[o.pointerId]&&f.distance>l.distance&&(i.mainSceneTrackerPredicate&&i.mainSceneTrackerPredicate(l.pickedMesh)?(i._notifyObservers(s,l,o),s.skipOnPointerObservable=!0):(s.type===w.POINTERMOVE||s.type===w.POINTERUP)&&(i._lastPointerEvents[o.pointerId]&&(i.onPointerOutObservable.notifyObservers(o.pointerId),delete i._lastPointerEvents[o.pointerId]),i._notifyObservers(s,f,o))),s.type===w.POINTERUP&&i._pointerCaptures[o.pointerId]&&(i._pointerCaptures[o.pointerId]=!1))}}}),this._originalPointerObserver&&e.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add(function(s){i.shouldRender&&s==i.getRenderCamera()&&i.render()}),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add(function(){i.dispose()}),this._updateCamera()}return r.prototype.getRenderCamera=function(e){if(this._renderCamera)return this._renderCamera;var t=void 0;return this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?t=this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:t=this.originalScene.activeCamera,e&&t&&t.isRigCamera?t.rigParent:t},r.prototype.setRenderCamera=function(e){this._renderCamera=e},r.prototype._getSharedGizmoLight=function(){return this._sharedGizmoLight||(this._sharedGizmoLight=new Ye("shared gizmo light",new U(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=ee.Gray()),this._sharedGizmoLight},Object.defineProperty(r,"DefaultUtilityLayer",{get:function(){return r._DefaultUtilityLayer==null?r._CreateDefaultUtilityLayerFromScene(Me.LastCreatedScene):r._DefaultUtilityLayer},enumerable:!1,configurable:!0}),r._CreateDefaultUtilityLayerFromScene=function(e){return r._DefaultUtilityLayer=new r(e),r._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce(function(){r._DefaultUtilityLayer=null}),r._DefaultUtilityLayer},Object.defineProperty(r,"DefaultKeepDepthUtilityLayer",{get:function(){return r._DefaultKeepDepthUtilityLayer==null&&(r._DefaultKeepDepthUtilityLayer=new r(Me.LastCreatedScene),r._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,r._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce(function(){r._DefaultKeepDepthUtilityLayer=null})),r._DefaultKeepDepthUtilityLayer},enumerable:!1,configurable:!0}),r.prototype._notifyObservers=function(e,t,i){e.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new Te(e.type,e.event,t),e.type),this._lastPointerEvents[i.pointerId]=!0)},r.prototype.render=function(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){var e=this.utilityLayerScene.activeCamera.getScene(),t=this.utilityLayerScene.activeCamera;t._scene=this.utilityLayerScene,t.leftCamera&&(t.leftCamera._scene=this.utilityLayerScene),t.rightCamera&&(t.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),t._scene=e,t.leftCamera&&(t.leftCamera._scene=e),t.rightCamera&&(t.rightCamera._scene=e)}},r.prototype.dispose=function(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()},r.prototype._updateCamera=function(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()},r._DefaultUtilityLayer=null,r._DefaultKeepDepthUtilityLayer=null,r}(),Oe=function(){function r(e,t,i,s,n){t===void 0&&(t=1),i===void 0&&(i=null),s===void 0&&(s=!1),n===void 0&&(n=H.TRILINEAR_SAMPLINGMODE);var a=this;this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this._scene=e,this._storeNonLinearDepth=s,this.isPacked=t===0,this.isPacked?this._clearColor=new Q(1,1,1,1):this._clearColor=new Q(1,0,0,1),r._SceneComponentInitialization(this._scene);var f=e.getEngine();this._camera=i,n!==H.NEAREST_SAMPLINGMODE&&(t===1&&!f._caps.textureFloatLinearFiltering&&(n=H.NEAREST_SAMPLINGMODE),t===2&&!f._caps.textureHalfFloatLinearFiltering&&(n=H.NEAREST_SAMPLINGMODE));var l=this.isPacked||!f._features.supportExtendedTextureFormats?5:6;this._depthMap=new Ve("DepthRenderer",{width:f.getRenderWidth(),height:f.getRenderHeight()},this._scene,!1,!0,t,!1,n,void 0,void 0,void 0,l),this._depthMap.wrapU=H.CLAMP_ADDRESSMODE,this._depthMap.wrapV=H.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(function(u){u.clear(a._clearColor,!0,!0,!0)}),this._depthMap.onBeforeBindObservable.add(function(){var u;(u=f._debugPushGroup)===null||u===void 0||u.call(f,"depth renderer",1)}),this._depthMap.onAfterUnbindObservable.add(function(){var u;(u=f._debugPopGroup)===null||u===void 0||u.call(f,1)}),this._depthMap.customIsReadyFunction=function(u,d){if(!u.isReady(!1))return!1;if(d===0&&u.subMeshes)for(var c=0;c<u.subMeshes.length;++c){var h=u.subMeshes[c],p=h.getRenderingMesh(),m=p._getInstancesRenderList(h._id,!!h.getReplacementMesh()),R=f.getCaps().instancedArrays&&(m.visibleInstances[h._id]!==null&&m.visibleInstances[h._id]!==void 0||p.hasThinInstances);if(!a.isReady(h,R))return!1}return!0};var o=function(u){var d,c,h=u.getRenderingMesh(),p=u.getEffectiveMesh(),m=a._scene,R=m.getEngine(),v=u.getMaterial();if(p._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!(!v||p.infiniteDistance||v.disableDepthWrite||u.verticesCount===0||u._renderId===m.getRenderId())){var T=p._getWorldMatrixDeterminant()<0,g=(d=h.overrideMaterialSideOrientation)!==null&&d!==void 0?d:v.sideOrientation;T&&(g=g===0?1:0);var B=g===0;R.setState(v.backFaceCulling,0,!1,B,v.cullBackFaces);var O=h._getInstancesRenderList(u._id,!!u.getReplacementMesh());if(!O.mustReturn){var C=R.getCaps().instancedArrays&&(O.visibleInstances[u._id]!==null&&O.visibleInstances[u._id]!==void 0||h.hasThinInstances),x=a._camera||m.activeCamera;if(a.isReady(u,C)&&x){u._renderId=m.getRenderId();var A=(c=p._internalAbstractMeshDataInfo._materialForRenderPass)===null||c===void 0?void 0:c[R.currentRenderPassId],M=u._getDrawWrapper();!M&&A&&(M=A._getDrawWrapper());var q=x.mode===De.ORTHOGRAPHIC_CAMERA;if(!M)return;var y=M.effect;R.enableEffect(M),C||h._bind(u,y,v.fillMode),A?A.bindForSubMesh(p.getWorldMatrix(),p,u):(y.setMatrix("viewProjection",m.getTransformMatrix()),y.setMatrix("world",p.getWorldMatrix()));var F=void 0,K=void 0;if(q?(F=!R.useReverseDepthBuffer&&R.isNDCHalfZRange?0:1,K=R.useReverseDepthBuffer&&R.isNDCHalfZRange?0:1):(F=R.useReverseDepthBuffer&&R.isNDCHalfZRange?x.minZ:R.isNDCHalfZRange?0:x.minZ,K=R.useReverseDepthBuffer&&R.isNDCHalfZRange?0:x.maxZ),y.setFloat2("depthValues",F,F+K),!A){if(v&&v.needAlphaTesting()){var N=v.getAlphaTestTexture();N&&(y.setTexture("diffuseSampler",N),y.setMatrix("diffuseMatrix",N.getTextureMatrix()))}if(h.useBones&&h.computeBonesUsingShaders&&h.skeleton){var I=h.skeleton;if(I.isUsingTextureForMatrices){var j=I.getTransformMatrixTexture(h);if(!j)return;y.setTexture("boneSampler",j),y.setFloat("boneTextureWidth",4*(I.bones.length+1))}else y.setMatrices("mBones",I.getTransformMatrices(h))}W.BindClipPlane(y,m),W.BindMorphTargetParameters(h,y),h.morphTargetManager&&h.morphTargetManager.isUsingTextureForTargets&&h.morphTargetManager._bind(y)}h._processRendering(p,u,y,v.fillMode,O,C,function(L,b){return y.setMatrix("world",b)})}}}};this._depthMap.customRenderFunction=function(u,d,c,h){var p;if(h.length)for(p=0;p<h.length;p++)o(h.data[p]);for(p=0;p<u.length;p++)o(u.data[p]);for(p=0;p<d.length;p++)o(d.data[p]);if(a.forceDepthWriteTransparentMeshes)for(p=0;p<c.length;p++)o(c.data[p]);else for(p=0;p<c.length;p++)c.data[p].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}return r.prototype.setMaterialForRendering=function(e,t){this._depthMap.setMaterialForRendering(e,t)},r.prototype.isReady=function(e,t){var i,s=this._scene.getEngine(),n=e.getMesh(),a=n.getScene(),f=(i=n._internalAbstractMeshDataInfo._materialForRenderPass)===null||i===void 0?void 0:i[s.currentRenderPassId];if(f)return f.isReadyForSubMesh(n,e,t);var l=e.getMaterial();if(!l||l.disableDepthWrite)return!1;var o=[],u=[_.PositionKind];if(l&&l.needAlphaTesting()&&l.getAlphaTestTexture()&&(o.push("#define ALPHATEST"),n.isVerticesDataPresent(_.UVKind)&&(u.push(_.UVKind),o.push("#define UV1")),n.isVerticesDataPresent(_.UV2Kind)&&(u.push(_.UV2Kind),o.push("#define UV2"))),n.useBones&&n.computeBonesUsingShaders){u.push(_.MatricesIndicesKind),u.push(_.MatricesWeightsKind),n.numBoneInfluencers>4&&(u.push(_.MatricesIndicesExtraKind),u.push(_.MatricesWeightsExtraKind)),o.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),o.push("#define BonesPerMesh "+(n.skeleton?n.skeleton.bones.length+1:0));var d=e.getRenderingMesh().skeleton;d!=null&&d.isUsingTextureForMatrices&&o.push("#define BONETEXTURE")}else o.push("#define NUM_BONE_INFLUENCERS 0");var c=n.morphTargetManager,h=0;c&&c.numInfluencers>0&&(h=c.numInfluencers,o.push("#define MORPHTARGETS"),o.push("#define NUM_MORPH_INFLUENCERS "+h),c.isUsingTextureForTargets&&o.push("#define MORPHTARGETS_TEXTURE"),W.PrepareAttributesForMorphTargetsInfluencers(u,n,h)),t&&(o.push("#define INSTANCES"),W.PushAttributesForInstances(u),e.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES")),this._storeNonLinearDepth&&o.push("#define NONLINEARDEPTH"),this.isPacked&&o.push("#define PACKED"),a.clipPlane&&o.push("#define CLIPPLANE"),a.clipPlane2&&o.push("#define CLIPPLANE2"),a.clipPlane3&&o.push("#define CLIPPLANE3"),a.clipPlane4&&o.push("#define CLIPPLANE4"),a.clipPlane5&&o.push("#define CLIPPLANE5"),a.clipPlane6&&o.push("#define CLIPPLANE6");var p=e._getDrawWrapper(void 0,!0),m=p.defines,R=o.join(`
`);return m!==R&&p.setEffect(s.createEffect("depth",u,["world","mBones","boneTextureWidth","viewProjection","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6"],["diffuseSampler","morphTargets","boneSampler"],R,void 0,void 0,void 0,{maxSimultaneousMorphTargets:h}),R),p.effect.isReady()},r.prototype.getDepthMap=function(){return this._depthMap},r.prototype.dispose=function(){var e=[];for(var t in this._scene._depthRenderer){var i=this._scene._depthRenderer[t];i===this&&e.push(t)}if(e.length>0){this._depthMap.dispose();for(var s=0,n=e;s<n.length;s++){var t=n[s];delete this._scene._depthRenderer[t]}}},r._SceneComponentInitialization=function(e){throw _e("DepthRendererSceneComponent")},r}(),Y=function(){function r(e,t){t===void 0&&(t=1),this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this._resizeObserver=null,this._enablePosition=!1,this._enableVelocity=!1,this._enableReflectivity=!1,this._positionIndex=-1,this._velocityIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._linkedWithPrePass=!1,this._scene=e,this._ratio=t,this._useUbo=e.getEngine().supportsUniformBuffers,r._SceneComponentInitialization(this._scene),this._createRenderTargets()}return r.prototype._linkPrePassRenderer=function(e){this._linkedWithPrePass=!0,this._prePassRenderer=e,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add(function(){}))},r.prototype._unlinkPrePassRenderer=function(){this._linkedWithPrePass=!1,this._createRenderTargets()},r.prototype._resetLayout=function(){this._enablePosition=!1,this._enableReflectivity=!1,this._enableVelocity=!1,this._attachments=[]},r.prototype._forceTextureType=function(e,t){e===r.POSITION_TEXTURE_TYPE?(this._positionIndex=t,this._enablePosition=!0):e===r.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=t,this._enableVelocity=!0):e===r.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=t,this._enableReflectivity=!0):e===r.DEPTH_TEXTURE_TYPE?this._depthIndex=t:e===r.NORMAL_TEXTURE_TYPE&&(this._normalIndex=t)},r.prototype._setAttachments=function(e){this._attachments=e},r.prototype._linkInternalTexture=function(e){this._multiRenderTarget.setInternalTexture(e,0,!1)},Object.defineProperty(r.prototype,"renderList",{get:function(){return this._multiRenderTarget.renderList},set:function(e){this._multiRenderTarget.renderList=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isSupported",{get:function(){return this._multiRenderTarget.isSupported},enumerable:!1,configurable:!0}),r.prototype.getTextureIndex=function(e){switch(e){case r.POSITION_TEXTURE_TYPE:return this._positionIndex;case r.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case r.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;default:return-1}},Object.defineProperty(r.prototype,"enablePosition",{get:function(){return this._enablePosition},set:function(e){this._enablePosition=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"enableVelocity",{get:function(){return this._enableVelocity},set:function(e){this._enableVelocity=e,e||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets()),this._scene.needsPreviousWorldMatrices=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"enableReflectivity",{get:function(){return this._enableReflectivity},set:function(e){this._enableReflectivity=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"ratio",{get:function(){return this._ratio},enumerable:!1,configurable:!0}),r.prototype.isReady=function(e,t){var i=e.getMaterial();if(i&&i.disableDepthWrite)return!1;var s=[],n=[_.PositionKind,_.NormalKind],a=e.getMesh();if(i){var f=!1;if(i.needAlphaTesting()&&i.getAlphaTestTexture()&&(s.push("#define ALPHATEST"),s.push("#define ALPHATEST_UV".concat(i.getAlphaTestTexture().coordinatesIndex+1)),f=!0),i.bumpTexture&&Se.BumpTextureEnabled&&(s.push("#define BUMP"),s.push("#define BUMP_UV".concat(i.bumpTexture.coordinatesIndex+1)),f=!0),this._enableReflectivity){var l=!1;i.getClassName()==="PBRMetallicRoughnessMaterial"?(i.metallicRoughnessTexture!==null&&(s.push("#define ORMTEXTURE"),s.push("#define REFLECTIVITY_UV".concat(i.metallicRoughnessTexture.coordinatesIndex+1)),s.push("#define METALLICWORKFLOW"),f=!0,l=!0),i.metallic!==null&&(s.push("#define METALLIC"),s.push("#define METALLICWORKFLOW"),l=!0),i.roughness!==null&&(s.push("#define ROUGHNESS"),s.push("#define METALLICWORKFLOW"),l=!0),l&&(i.baseTexture!==null&&(s.push("#define ALBEDOTEXTURE"),s.push("#define ALBEDO_UV".concat(i.baseTexture.coordinatesIndex+1)),i.baseTexture.gammaSpace&&s.push("#define GAMMAALBEDO"),f=!0),i.baseColor!==null&&s.push("#define ALBEDOCOLOR"))):i.getClassName()==="PBRSpecularGlossinessMaterial"?(i.specularGlossinessTexture!==null?(s.push("#define SPECULARGLOSSINESSTEXTURE"),s.push("#define REFLECTIVITY_UV".concat(i.specularGlossinessTexture.coordinatesIndex+1)),f=!0,i.specularGlossinessTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE")):i.specularColor!==null&&s.push("#define REFLECTIVITYCOLOR"),i.glossiness!==null&&s.push("#define GLOSSINESSS")):i.getClassName()==="PBRMaterial"?(i.metallicTexture!==null&&(s.push("#define ORMTEXTURE"),s.push("#define REFLECTIVITY_UV".concat(i.metallicTexture.coordinatesIndex+1)),s.push("#define METALLICWORKFLOW"),f=!0,l=!0),i.metallic!==null&&(s.push("#define METALLIC"),s.push("#define METALLICWORKFLOW"),l=!0),i.roughness!==null&&(s.push("#define ROUGHNESS"),s.push("#define METALLICWORKFLOW"),l=!0),l?(i.albedoTexture!==null&&(s.push("#define ALBEDOTEXTURE"),s.push("#define ALBEDO_UV".concat(i.albedoTexture.coordinatesIndex+1)),i.albedoTexture.gammaSpace&&s.push("#define GAMMAALBEDO"),f=!0),i.albedoColor!==null&&s.push("#define ALBEDOCOLOR")):(i.reflectivityTexture!==null?(s.push("#define SPECULARGLOSSINESSTEXTURE"),s.push("#define REFLECTIVITY_UV".concat(i.reflectivityTexture.coordinatesIndex+1)),i.reflectivityTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE"),f=!0):i.reflectivityColor!==null&&s.push("#define REFLECTIVITYCOLOR"),i.microSurface!==null&&s.push("#define GLOSSINESSS"))):i.getClassName()==="StandardMaterial"&&(i.specularTexture!==null&&(s.push("#define REFLECTIVITYTEXTURE"),s.push("#define REFLECTIVITY_UV".concat(i.specularTexture.coordinatesIndex+1)),i.specularTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE"),f=!0),i.specularColor!==null&&s.push("#define REFLECTIVITYCOLOR"))}f&&(s.push("#define NEED_UV"),a.isVerticesDataPresent(_.UVKind)&&(n.push(_.UVKind),s.push("#define UV1")),a.isVerticesDataPresent(_.UV2Kind)&&(n.push(_.UV2Kind),s.push("#define UV2")))}this._linkedWithPrePass&&(s.push("#define PREPASS"),this._depthIndex!==-1&&(s.push("#define DEPTH_INDEX "+this._depthIndex),s.push("#define PREPASS_DEPTH")),this._normalIndex!==-1&&(s.push("#define NORMAL_INDEX "+this._normalIndex),s.push("#define PREPASS_NORMAL"))),this._enablePosition&&(s.push("#define POSITION"),s.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(s.push("#define VELOCITY"),s.push("#define VELOCITY_INDEX "+this._velocityIndex),this.excludedSkinnedMeshesFromVelocity.indexOf(a)===-1&&s.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(s.push("#define REFLECTIVITY"),s.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),a.useBones&&a.computeBonesUsingShaders?(n.push(_.MatricesIndicesKind),n.push(_.MatricesWeightsKind),a.numBoneInfluencers>4&&(n.push(_.MatricesIndicesExtraKind),n.push(_.MatricesWeightsExtraKind)),s.push("#define NUM_BONE_INFLUENCERS "+a.numBoneInfluencers),s.push("#define BonesPerMesh "+(a.skeleton?a.skeleton.bones.length+1:0))):s.push("#define NUM_BONE_INFLUENCERS 0");var o=a.morphTargetManager,u=0;o&&o.numInfluencers>0&&(u=o.numInfluencers,s.push("#define MORPHTARGETS"),s.push("#define NUM_MORPH_INFLUENCERS "+u),o.isUsingTextureForTargets&&s.push("#define MORPHTARGETS_TEXTURE"),W.PrepareAttributesForMorphTargetsInfluencers(n,a,u)),t&&(s.push("#define INSTANCES"),W.PushAttributesForInstances(n,this._enableVelocity),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES")),this._linkedWithPrePass?s.push("#define RENDER_TARGET_COUNT "+this._attachments.length):s.push("#define RENDER_TARGET_COUNT "+this._multiRenderTarget.textures.length);var d=this._scene.getEngine(),c=e._getDrawWrapper(void 0,!0),h=c.defines,p=s.join(`
`);return h!==p&&c.setEffect(d.createEffect("geometry",{attributes:n,uniformsNames:["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","albedoMatrix","reflectivityColor","albedoColor","metallic","glossiness","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"],samplers:["diffuseSampler","bumpSampler","reflectivitySampler","albedoSampler","morphTargets"],defines:p,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:u}},d),p),c.effect.isReady()},r.prototype.getGBuffer=function(){return this._multiRenderTarget},Object.defineProperty(r.prototype,"samples",{get:function(){return this._multiRenderTarget.samples},set:function(e){this._multiRenderTarget.samples=e},enumerable:!1,configurable:!0}),r.prototype.dispose=function(){if(this._resizeObserver){var e=this._scene.getEngine();e.onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null}this.getGBuffer().dispose()},r.prototype._assignRenderTargetIndices=function(){var e=[],t=2;return e.push("gBuffer_Depth","gBuffer_Normal"),this._enablePosition&&(this._positionIndex=t,t++,e.push("gBuffer_Position")),this._enableVelocity&&(this._velocityIndex=t,t++,e.push("gBuffer_Velocity")),this._enableReflectivity&&(this._reflectivityIndex=t,t++,e.push("gBuffer_Reflectivity")),[t,e]},r.prototype._createRenderTargets=function(){var e=this,t=this._scene.getEngine(),i=this._assignRenderTargetIndices(),s=i[0],n=i[1],a=0;if(t._caps.textureFloat&&t._caps.textureFloatLinearFiltering?a=1:t._caps.textureHalfFloat&&t._caps.textureHalfFloatLinearFiltering&&(a=2),this._multiRenderTarget=new Z("gBuffer",{width:t.getRenderWidth()*this._ratio,height:t.getRenderHeight()*this._ratio},s,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,defaultType:a},n.concat("gBuffer_DepthBuffer")),!!this.isSupported){this._multiRenderTarget.wrapU=H.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=H.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null,this._multiRenderTarget.onClearObservable.add(function(l){l.clear(new Q(0,0,0,0),!0,!0,!0)}),this._resizeObserver=t.onResizeObservable.add(function(){e._multiRenderTarget&&e._multiRenderTarget.resize({width:t.getRenderWidth()*e._ratio,height:t.getRenderHeight()*e._ratio})});var f=function(l){var o=l.getRenderingMesh(),u=l.getEffectiveMesh(),d=e._scene,c=d.getEngine(),h=l.getMaterial();if(!!h){if(u._internalAbstractMeshDataInfo._isActiveIntermediate=!1,e._enableVelocity&&!e._previousTransformationMatrices[u.uniqueId]&&(e._previousTransformationMatrices[u.uniqueId]={world:$.Identity(),viewProjection:d.getTransformMatrix()},o.skeleton)){var p=o.skeleton.getTransformMatrices(o);e._previousBonesTransformationMatrices[o.uniqueId]=e._copyBonesTransformationMatrices(p,new Float32Array(p.length))}var m=o._getInstancesRenderList(l._id,!!l.getReplacementMesh());if(!m.mustReturn){var R=c.getCaps().instancedArrays&&(m.visibleInstances[l._id]!==null||o.hasThinInstances),v=u.getWorldMatrix();if(e.isReady(l,R)){var T=l._getDrawWrapper();if(!T)return;var g=T.effect;if(c.enableEffect(T),R||o._bind(l,g,h.fillMode),e._useUbo?(W.BindSceneUniformBuffer(g,e._scene.getSceneUniformBuffer()),e._scene.finalizeSceneUbo()):(g.setMatrix("viewProjection",d.getTransformMatrix()),g.setMatrix("view",d.getViewMatrix())),h){var B=void 0,O=o._instanceDataStorage;if(!O.isFrozen&&(h.backFaceCulling||o.overrideMaterialSideOrientation!==null)){var C=u._getWorldMatrixDeterminant();B=o.overrideMaterialSideOrientation,B===null&&(B=h.sideOrientation),C<0&&(B=B===G.ClockWiseSideOrientation?G.CounterClockWiseSideOrientation:G.ClockWiseSideOrientation)}else B=O.sideOrientation;if(h._preBind(T,B),h.needAlphaTesting()){var x=h.getAlphaTestTexture();x&&(g.setTexture("diffuseSampler",x),g.setMatrix("diffuseMatrix",x.getTextureMatrix()))}h.bumpTexture&&d.getEngine().getCaps().standardDerivatives&&Se.BumpTextureEnabled&&(g.setFloat3("vBumpInfos",h.bumpTexture.coordinatesIndex,1/h.bumpTexture.level,h.parallaxScaleBias),g.setMatrix("bumpMatrix",h.bumpTexture.getTextureMatrix()),g.setTexture("bumpSampler",h.bumpTexture),g.setFloat2("vTangentSpaceParams",h.invertNormalMapX?-1:1,h.invertNormalMapY?-1:1)),e._enableReflectivity&&(h.getClassName()==="PBRMetallicRoughnessMaterial"?(h.metallicRoughnessTexture!==null&&(g.setTexture("reflectivitySampler",h.metallicRoughnessTexture),g.setMatrix("reflectivityMatrix",h.metallicRoughnessTexture.getTextureMatrix())),h.metallic!==null&&g.setFloat("metallic",h.metallic),h.roughness!==null&&g.setFloat("glossiness",1-h.roughness),h.baseTexture!==null&&(g.setTexture("albedoSampler",h.baseTexture),g.setMatrix("albedoMatrix",h.baseTexture.getTextureMatrix())),h.baseColor!==null&&g.setColor3("albedoColor",h.baseColor)):h.getClassName()==="PBRSpecularGlossinessMaterial"?(h.specularGlossinessTexture!==null?(g.setTexture("reflectivitySampler",h.specularGlossinessTexture),g.setMatrix("reflectivityMatrix",h.specularGlossinessTexture.getTextureMatrix())):h.specularColor!==null&&g.setColor3("reflectivityColor",h.specularColor),h.glossiness!==null&&g.setFloat("glossiness",h.glossiness)):h.getClassName()==="PBRMaterial"?(h.metallicTexture!==null&&(g.setTexture("reflectivitySampler",h.metallicTexture),g.setMatrix("reflectivityMatrix",h.metallicTexture.getTextureMatrix())),h.metallic!==null&&g.setFloat("metallic",h.metallic),h.roughness!==null&&g.setFloat("glossiness",1-h.roughness),h.roughness!==null||h.metallic!==null||h.metallicTexture!==null?(h.albedoTexture!==null&&(g.setTexture("albedoSampler",h.albedoTexture),g.setMatrix("albedoMatrix",h.albedoTexture.getTextureMatrix())),h.albedoColor!==null&&g.setColor3("albedoColor",h.albedoColor)):(h.reflectivityTexture!==null?(g.setTexture("reflectivitySampler",h.reflectivityTexture),g.setMatrix("reflectivityMatrix",h.reflectivityTexture.getTextureMatrix())):h.reflectivityColor!==null&&g.setColor3("reflectivityColor",h.reflectivityColor),h.microSurface!==null&&g.setFloat("glossiness",h.microSurface))):h.getClassName()==="StandardMaterial"&&(h.specularTexture!==null&&(g.setTexture("reflectivitySampler",h.specularTexture),g.setMatrix("reflectivityMatrix",h.specularTexture.getTextureMatrix())),h.specularColor!==null&&g.setColor3("reflectivityColor",h.specularColor)))}o.useBones&&o.computeBonesUsingShaders&&o.skeleton&&(g.setMatrices("mBones",o.skeleton.getTransformMatrices(o)),e._enableVelocity&&g.setMatrices("mPreviousBones",e._previousBonesTransformationMatrices[o.uniqueId])),W.BindMorphTargetParameters(o,g),o.morphTargetManager&&o.morphTargetManager.isUsingTextureForTargets&&o.morphTargetManager._bind(g),e._enableVelocity&&(g.setMatrix("previousWorld",e._previousTransformationMatrices[u.uniqueId].world),g.setMatrix("previousViewProjection",e._previousTransformationMatrices[u.uniqueId].viewProjection)),R&&o.hasThinInstances&&g.setMatrix("world",v),o._processRendering(u,l,g,h.fillMode,m,R,function(A,M){A||g.setMatrix("world",M)})}e._enableVelocity&&(e._previousTransformationMatrices[u.uniqueId].world=v.clone(),e._previousTransformationMatrices[u.uniqueId].viewProjection=e._scene.getTransformMatrix().clone(),o.skeleton&&e._copyBonesTransformationMatrices(o.skeleton.getTransformMatrices(o),e._previousBonesTransformationMatrices[u.uniqueId]))}}};this._multiRenderTarget.customIsReadyFunction=function(l,o){if(!l.isReady(!1))return!1;if(o===0&&l.subMeshes)for(var u=0;u<l.subMeshes.length;++u){var d=l.subMeshes[u],c=d.getMaterial(),h=d.getRenderingMesh();if(!!c){var p=h._getInstancesRenderList(d._id,!!d.getReplacementMesh()),m=t.getCaps().instancedArrays&&(p.visibleInstances[d._id]!==null||h.hasThinInstances);if(!e.isReady(d,m))return!1}}return!0},this._multiRenderTarget.customRenderFunction=function(l,o,u,d){var c;if(e._linkedWithPrePass){if(!e._prePassRenderer.enabled)return;e._scene.getEngine().bindAttachments(e._attachments)}if(d.length){for(t.setColorWrite(!1),c=0;c<d.length;c++)f(d.data[c]);t.setColorWrite(!0)}for(c=0;c<l.length;c++)f(l.data[c]);for(t.setDepthWrite(!1),c=0;c<o.length;c++)f(o.data[c]);if(e.renderTransparentMeshes)for(c=0;c<u.length;c++)f(u.data[c]);t.setDepthWrite(!0)}}},r.prototype._copyBonesTransformationMatrices=function(e,t){for(var i=0;i<e.length;i++)t[i]=e[i];return t},r.DEPTH_TEXTURE_TYPE=0,r.NORMAL_TEXTURE_TYPE=1,r.POSITION_TEXTURE_TYPE=2,r.VELOCITY_TEXTURE_TYPE=3,r.REFLECTIVITY_TEXTURE_TYPE=4,r._SceneComponentInitialization=function(e){throw _e("GeometryBufferRendererSceneComponent")},r}(),Mt=function(){function r(){this.enabled=!1,this.name="motionBlur",this.texturesRequired=[2]}return r}();Object.defineProperty(D.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(r){r&&r.isSupported&&(this._geometryBufferRenderer=r)},enumerable:!0,configurable:!0});D.prototype.enableGeometryBufferRenderer=function(r){return r===void 0&&(r=1),this._geometryBufferRenderer?this._geometryBufferRenderer:(this._geometryBufferRenderer=new Y(this,r),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null),this._geometryBufferRenderer)};D.prototype.disableGeometryBufferRenderer=function(){!this._geometryBufferRenderer||(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};var Je=function(){function r(e){this.name=P.NAME_GEOMETRYBUFFERRENDERER,this.scene=e}return r.prototype.register=function(){this.scene._gatherRenderTargetsStage.registerStep(P.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)},r.prototype.rebuild=function(){},r.prototype.dispose=function(){},r.prototype._gatherRenderTargets=function(e){this.scene._geometryBufferRenderer&&e.push(this.scene._geometryBufferRenderer.getGBuffer())},r}();Y._SceneComponentInitialization=function(r){var e=r._getComponent(P.NAME_GEOMETRYBUFFERRENDERER);e||(e=new Je(r),r._addComponent(e))};var It=function(){function r(){this.enabled=!1,this.name="ssao2",this.texturesRequired=[6,5]}return r}(),xt=function(){function r(){this.enabled=!1,this.name="screenSpaceReflections",this.texturesRequired=[6,3,1]}return r}();Object.defineProperty(D.prototype,"forceShowBoundingBoxes",{get:function(){return this._forceShowBoundingBoxes||!1},set:function(r){this._forceShowBoundingBoxes=r,r&&this.getBoundingBoxRenderer()},enumerable:!0,configurable:!0});D.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer||(this._boundingBoxRenderer=new $e(this)),this._boundingBoxRenderer};Object.defineProperty(pe.prototype,"showBoundingBox",{get:function(){return this._showBoundingBox||!1},set:function(r){this._showBoundingBox=r,r&&this.getScene().getBoundingBoxRenderer()},enumerable:!0,configurable:!0});var $e=function(){function r(e){this.name=P.NAME_BOUNDINGBOXRENDERER,this.frontColor=new ee(1,1,1),this.backColor=new ee(.1,.1,.1),this.showBackLines=!0,this.onBeforeBoxRenderingObservable=new de,this.onAfterBoxRenderingObservable=new de,this.onResourcesReadyObservable=new de,this.enabled=!0,this.renderList=new V(32),this._vertexBuffers={},this._fillIndexBuffer=null,this._fillIndexData=null,this.scene=e,e._addComponent(this),this._uniformBufferFront=new Ce(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererFront",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferFront),this._uniformBufferBack=new Ce(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererBack",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferBack)}return r.prototype._buildUniformLayout=function(e){e.addUniform("color",4),e.addUniform("world",16),e.addUniform("viewProjection",16),e.addUniform("viewProjectionR",16),e.create()},r.prototype.register=function(){this.scene._beforeEvaluateActiveMeshStage.registerStep(P.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER,this,this.reset),this.scene._preActiveMeshStage.registerStep(P.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER,this,this._preActiveMesh),this.scene._evaluateSubMeshStage.registerStep(P.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER,this,this._evaluateSubMesh),this.scene._afterRenderingGroupDrawStage.registerStep(P.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER,this,this.render)},r.prototype._evaluateSubMesh=function(e,t){if(e.showSubMeshesBoundingBox){var i=t.getBoundingInfo();i!=null&&(i.boundingBox._tag=e.renderingGroupId,this.renderList.push(i.boundingBox))}},r.prototype._preActiveMesh=function(e){if(e.showBoundingBox||this.scene.forceShowBoundingBoxes){var t=e.getBoundingInfo();t.boundingBox._tag=e.renderingGroupId,this.renderList.push(t.boundingBox)}},r.prototype._prepareResources=function(){if(!this._colorShader){this._colorShader=new Pe("colorShader",this.scene,"boundingBoxRenderer",{attributes:[_.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!1),this._colorShader.reservedDataStore={hidden:!0},this._colorShaderForOcclusionQuery=new Pe("colorShaderOccQuery",this.scene,"boundingBoxRenderer",{attributes:[_.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!0),this._colorShaderForOcclusionQuery.reservedDataStore={hidden:!0};var e=this.scene.getEngine(),t=We({size:1});this._vertexBuffers[_.PositionKind]=new _(e,t.positions,_.PositionKind,!1),this._createIndexBuffer(),this._fillIndexData=t.indices,this.onResourcesReadyObservable.notifyObservers(this)}},r.prototype._createIndexBuffer=function(){var e=this.scene.getEngine();this._indexBuffer=e.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])},r.prototype.rebuild=function(){var e=this._vertexBuffers[_.PositionKind];e&&e._rebuild(),this._createIndexBuffer()},r.prototype.reset=function(){this.renderList.reset()},r.prototype.render=function(e){var t,i;if(!(this.renderList.length===0||!this.enabled)&&(this._prepareResources(),!!this._colorShader.isReady())){var s=this.scene.getEngine();s.setDepthWrite(!1);for(var n=this.frontColor.toColor4(),a=this.backColor.toColor4(),f=this.scene.getTransformMatrix(),l=0;l<this.renderList.length;l++){var o=this.renderList.data[l];if(o._tag===e){this._createWrappersForBoundingBox(o),this.onBeforeBoxRenderingObservable.notifyObservers(o);var u=o.minimum,d=o.maximum,c=d.subtract(u),h=u.add(c.scale(.5)),p=$.Scaling(c.x,c.y,c.z).multiply($.Translation(h.x,h.y,h.z)).multiply(o.getWorldMatrix()),m=s.useReverseDepthBuffer;if(this.showBackLines){var R=(t=o._drawWrapperBack)!==null&&t!==void 0?t:this._colorShader._getDrawWrapper();this._colorShader._preBind(R),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),m?s.setDepthFunctionToLessOrEqual():s.setDepthFunctionToGreaterOrEqual(),this._uniformBufferBack.bindToEffect(R.effect,"BoundingBoxRenderer"),this._uniformBufferBack.updateDirectColor4("color",a),this._uniformBufferBack.updateMatrix("world",p),this._uniformBufferBack.updateMatrix("viewProjection",f),this._uniformBufferBack.update(),s.drawElementsType(G.LineListDrawMode,0,24)}var v=(i=o._drawWrapperFront)!==null&&i!==void 0?i:this._colorShader._getDrawWrapper();this._colorShader._preBind(v),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),m?s.setDepthFunctionToGreater():s.setDepthFunctionToLess(),this._uniformBufferFront.bindToEffect(v.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateDirectColor4("color",n),this._uniformBufferFront.updateMatrix("world",p),this._uniformBufferFront.updateMatrix("viewProjection",f),this._uniformBufferFront.update(),s.drawElementsType(G.LineListDrawMode,0,24),this.onAfterBoxRenderingObservable.notifyObservers(o)}}this._colorShader.unbind(),s.setDepthFunctionToLessOrEqual(),s.setDepthWrite(!0)}},r.prototype._createWrappersForBoundingBox=function(e){if(!e._drawWrapperFront){var t=this.scene.getEngine();e._drawWrapperFront=new ce(t),e._drawWrapperBack=new ce(t),e._drawWrapperFront.setEffect(this._colorShader.getEffect()),e._drawWrapperBack.setEffect(this._colorShader.getEffect())}},r.prototype.renderOcclusionBoundingBox=function(e){var t=this.scene.getEngine();this._renderPassIdForOcclusionQuery===void 0&&(this._renderPassIdForOcclusionQuery=t.createRenderPassId("Render pass for occlusion query"));var i=t.currentRenderPassId;t.currentRenderPassId=this._renderPassIdForOcclusionQuery,this._prepareResources();var s=e.subMeshes[0];if(!this._colorShaderForOcclusionQuery.isReady(e,void 0,s)||!e.hasBoundingInfo){t.currentRenderPassId=i;return}this._fillIndexBuffer||(this._fillIndexBuffer=t.createIndexBuffer(this._fillIndexData));var n=t.useReverseDepthBuffer;t.setDepthWrite(!1),t.setColorWrite(!1);var a=e.getBoundingInfo().boundingBox,f=a.minimum,l=a.maximum,o=l.subtract(f),u=f.add(o.scale(.5)),d=$.Scaling(o.x,o.y,o.z).multiply($.Translation(u.x,u.y,u.z)).multiply(a.getWorldMatrix()),c=s._drawWrapper;this._colorShaderForOcclusionQuery._preBind(c),t.bindBuffers(this._vertexBuffers,this._fillIndexBuffer,c.effect),n?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this._uniformBufferFront.bindToEffect(c.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateMatrix("world",d),this._uniformBufferFront.updateMatrix("viewProjection",this.scene.getTransformMatrix()),this._uniformBufferFront.update(),t.drawElementsType(G.TriangleFillMode,0,36),this._colorShaderForOcclusionQuery.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0),t.setColorWrite(!0),t.currentRenderPassId=i},r.prototype.dispose=function(){if(this._renderPassIdForOcclusionQuery!==void 0&&(this.scene.getEngine().releaseRenderPassId(this._renderPassIdForOcclusionQuery),this._renderPassIdForOcclusionQuery=void 0),!!this._colorShader){this.onBeforeBoxRenderingObservable.clear(),this.onAfterBoxRenderingObservable.clear(),this.onResourcesReadyObservable.clear(),this.renderList.dispose(),this._colorShader.dispose(),this._colorShaderForOcclusionQuery.dispose(),this._uniformBufferFront.dispose(),this._uniformBufferBack.dispose();var e=this._vertexBuffers[_.PositionKind];e&&(e.dispose(),this._vertexBuffers[_.PositionKind]=null),this.scene.getEngine()._releaseBuffer(this._indexBuffer),this._fillIndexBuffer&&(this.scene.getEngine()._releaseBuffer(this._fillIndexBuffer),this._fillIndexBuffer=null)}},r}();D.prototype.enableDepthRenderer=function(r,e,t){if(e===void 0&&(e=!1),t===void 0&&(t=!1),r=r||this.activeCamera,!r)throw"No camera available to enable depth renderer";if(this._depthRenderer||(this._depthRenderer={}),!this._depthRenderer[r.id]){var i=!!this.getEngine().getCaps().textureFloatRender,s=0;this.getEngine().getCaps().textureHalfFloatRender&&(!t||!i)?s=2:i?s=1:s=0,this._depthRenderer[r.id]=new Oe(this,s,r,e)}return this._depthRenderer[r.id]};D.prototype.disableDepthRenderer=function(r){r=r||this.activeCamera,!(!r||!this._depthRenderer||!this._depthRenderer[r.id])&&this._depthRenderer[r.id].dispose()};var et=function(){function r(e){this.name=P.NAME_DEPTHRENDERER,this.scene=e}return r.prototype.register=function(){this.scene._gatherRenderTargetsStage.registerStep(P.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this._gatherRenderTargets),this.scene._gatherActiveCameraRenderTargetsStage.registerStep(P.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this._gatherActiveCameraRenderTargets)},r.prototype.rebuild=function(){},r.prototype.dispose=function(){for(var e in this.scene._depthRenderer)this.scene._depthRenderer[e].dispose()},r.prototype._gatherRenderTargets=function(e){if(this.scene._depthRenderer)for(var t in this.scene._depthRenderer){var i=this.scene._depthRenderer[t];i.enabled&&!i.useOnlyInActiveCamera&&e.push(i.getDepthMap())}},r.prototype._gatherActiveCameraRenderTargets=function(e){if(this.scene._depthRenderer)for(var t in this.scene._depthRenderer){var i=this.scene._depthRenderer[t];i.enabled&&i.useOnlyInActiveCamera&&this.scene.activeCamera.id===t&&e.push(i.getDepthMap())}},r}();Oe._SceneComponentInitialization=function(r){var e=r._getComponent(P.NAME_DEPTHRENDERER);e||(e=new et(r),r._addComponent(e))};var tt=function(){function r(){this.enabled=!0,this.name="depthPeeling",this.texturesRequired=[4]}return r}(),rt=function(){function r(e,t){if(t===void 0&&(t=5),this._thinTextures=[],this._currentPingPongState=0,this._layoutCacheFormat=[[!0],[!0,!0],[!0,!0,!0]],this._layoutCache=[],this._candidateSubMeshes=new V(10),this._excludedSubMeshes=new V(10),this._colorCache=[new Q(r._DEPTH_CLEAR_VALUE,r._DEPTH_CLEAR_VALUE,0,0),new Q(-r._MIN_DEPTH,r._MAX_DEPTH,0,0),new Q(0,0,0,0)],this._scene=e,this._engine=e.getEngine(),this._passCount=t,!e.enablePrePassRenderer()){ye.Warn("Depth peeling for order independant transparency could not enable PrePass, aborting.");return}for(var i=0;i<this._layoutCacheFormat.length;++i)this._layoutCache[i]=this._engine.buildTextureLayout(this._layoutCacheFormat[i]);this._renderPassIds=[],this.useRenderPasses=!1,this._prePassEffectConfiguration=new tt,this._createTextures(),this._createEffects()}return Object.defineProperty(r.prototype,"passCount",{get:function(){return this._passCount},set:function(e){this._passCount!==e&&(this._passCount=e,this._createRenderPassIds())},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"useRenderPasses",{get:function(){return this._useRenderPasses},set:function(e){this._useRenderPasses!==e&&(this._useRenderPasses=e,this._createRenderPassIds())},enumerable:!1,configurable:!0}),r.prototype._createRenderPassIds=function(){if(this._releaseRenderPassIds(),this._useRenderPasses)for(var e=0;e<this._passCount+1;++e)this._renderPassIds[e]||(this._renderPassIds[e]=this._engine.createRenderPassId("DepthPeelingRenderer - pass #".concat(e)))},r.prototype._releaseRenderPassIds=function(){for(var e=0;e<this._renderPassIds.length;++e)this._engine.releaseRenderPassId(this._renderPassIds[e]);this._renderPassIds=[]},r.prototype._createTextures=function(){var e={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()};this._depthMrts=[new Z("depthPeelingDepth0",e,1,this._scene),new Z("depthPeelingDepth1",e,1,this._scene)],this._colorMrts=[new Z("depthPeelingColor0",e,1,this._scene,{generateDepthBuffer:!1}),new Z("depthPeelingColor1",e,1,this._scene,{generateDepthBuffer:!1})],this._blendBackMrt=new Z("depthPeelingBack",e,1,this._scene,{generateDepthBuffer:!1});for(var t=[{format:7,samplingMode:1,type:this._engine.getCaps().textureFloatLinearFiltering?1:2},{format:5,samplingMode:1,type:2}],i=0;i<2;i++){var s=this._engine._createInternalTexture(e,t[0],!1),n=this._engine._createInternalTexture(e,t[1],!1),a=this._engine._createInternalTexture(e,t[1],!1);this._depthMrts[i].setInternalTexture(s,0),this._depthMrts[i].setInternalTexture(n,1),this._depthMrts[i].setInternalTexture(a,2),this._colorMrts[i].setInternalTexture(n,0),this._colorMrts[i].setInternalTexture(a,1),this._thinTextures.push(new le(s),new le(n),new le(a))}},r.prototype._disposeTextures=function(){for(var e=0;e<this._thinTextures.length;e++)e!==6&&this._thinTextures[e].dispose();for(var e=0;e<2;e++)this._depthMrts[e].dispose(!0),this._colorMrts[e].dispose(!0),this._blendBackMrt.dispose(!0);this._thinTextures=[],this._colorMrts=[],this._depthMrts=[]},r.prototype._updateTextures=function(){return(this._depthMrts[0].getSize().width!==this._engine.getRenderWidth()||this._depthMrts[0].getSize().height!==this._engine.getRenderHeight())&&(this._disposeTextures(),this._createTextures()),this._updateTextureReferences()},r.prototype._updateTextureReferences=function(){var e,t=this._scene.prePassRenderer;if(!t)return!1;var i=t.getIndex(4),s=!((e=t.defaultRT.textures)===null||e===void 0)&&e.length?t.defaultRT.textures[i].getInternalTexture():null;return s?(this._blendBackTexture!==s&&(this._blendBackTexture=s,this._blendBackMrt.setInternalTexture(this._blendBackTexture,0),this._thinTextures[6]&&this._thinTextures[6].dispose(),this._thinTextures[6]=new le(this._blendBackTexture),t.defaultRT.renderTarget._shareDepth(this._depthMrts[0].renderTarget)),!0):!1},r.prototype._createEffects=function(){this._blendBackEffectWrapper=new ve({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[]}),this._blendBackEffectWrapperPingPong=new ve({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[]}),this._finalEffectWrapper=new ve({fragmentShader:"oitFinal",useShaderStore:!0,engine:this._engine,samplerNames:["uFrontColor","uBackColor"],uniformNames:[]}),this._effectRenderer=new Ke(this._engine)},r.prototype.setPrePassRenderer=function(e){e.addEffectConfiguration(this._prePassEffectConfiguration)},r.prototype.bind=function(e){e.setTexture("oitDepthSampler",this._thinTextures[this._currentPingPongState*3]),e.setTexture("oitFrontColorSampler",this._thinTextures[this._currentPingPongState*3+1])},r.prototype._renderSubMeshes=function(e){var t;this._useRenderPasses&&(t={});for(var i=0;i<e.length;i++){var s=e.data[i].getMaterial(),n=!0,a=!1,f=e.data[i],l=void 0,o=!1;if(this._useRenderPasses&&(l=f._getDrawWrapper(),o=!l),s&&(n=s.allowShaderHotSwapping,a=s.backFaceCulling,s.allowShaderHotSwapping=!1,s.backFaceCulling=!1),f.render(!1),o&&(l=f._getDrawWrapper(),l.materialContext)){var u=t[l.materialContext.uniqueId];u||(u=t[l.materialContext.uniqueId]=this._engine.createMaterialContext()),f._getDrawWrapper().materialContext=u}s&&(s.allowShaderHotSwapping=n,s.backFaceCulling=a)}},r.prototype._finalCompose=function(e){this._engine.restoreDefaultFramebuffer(),this._engine.setAlphaMode(0),this._engine.applyStates(),this._engine.enableEffect(this._finalEffectWrapper._drawWrapper),this._finalEffectWrapper.effect.setTexture("uFrontColor",this._thinTextures[e*3+1]),this._finalEffectWrapper.effect.setTexture("uBackColor",this._thinTextures[6]),this._effectRenderer.render(this._finalEffectWrapper)},r.prototype.render=function(e){if(this._candidateSubMeshes.length=0,this._excludedSubMeshes.length=0,!this._blendBackEffectWrapper.effect.isReady()||!this._blendBackEffectWrapperPingPong.effect.isReady()||!this._finalEffectWrapper.effect.isReady()||!this._updateTextures())return this._excludedSubMeshes;for(var t=0;t<e.length;t++){var i=e.data[t].getMaterial();i&&(i.fillMode===G.TriangleFanDrawMode||i.fillMode===G.TriangleFillMode||i.fillMode===G.TriangleStripDrawMode)?this._candidateSubMeshes.push(e.data[t]):this._excludedSubMeshes.push(e.data[t])}if(!this._candidateSubMeshes.length)return this._finalCompose(1),this._excludedSubMeshes;var s=this._engine.currentRenderPassId;this._scene.prePassRenderer._enabled=!1,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[0]),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.bindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[1],!0,!1,!1),this._engine.bindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthMask=!1,this._engine.depthCullingState.depthTest=!0,this._engine.applyStates(),this._currentPingPongState=1,this._renderSubMeshes(this._candidateSubMeshes),this._scene.resetCachedMaterial();for(var n=0,a=0,t=0;t<this._passCount;t++){n=t%2,a=1-n,this._currentPingPongState=n,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[t+1]),this._engine.bindFramebuffer(this._depthMrts[a].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.bindFramebuffer(this._colorMrts[a].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.bindFramebuffer(this._depthMrts[a].renderTarget),this._engine.bindAttachments(this._layoutCache[2]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthTest=!1,this._engine.applyStates(),this._renderSubMeshes(this._candidateSubMeshes),this._scene.resetCachedMaterial(),this._engine.bindFramebuffer(this._blendBackMrt.renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaEquation(0),this._engine.setAlphaMode(17),this._engine.applyStates();var f=a===0||!this._useRenderPasses?this._blendBackEffectWrapper:this._blendBackEffectWrapperPingPong;this._engine.enableEffect(f._drawWrapper),f.effect.setTexture("uBackColor",this._thinTextures[a*3+2]),this._effectRenderer.render(f)}return this._engine.currentRenderPassId=s,this._finalCompose(a),this._scene.prePassRenderer._enabled=!0,this._engine.depthCullingState.depthMask=!0,this._engine.depthCullingState.depthTest=!0,this._excludedSubMeshes},r.prototype.dispose=function(){this._disposeTextures(),this._blendBackEffectWrapper.dispose(),this._finalEffectWrapper.dispose(),this._effectRenderer.dispose(),this._releaseRenderPassIds()},r._DEPTH_CLEAR_VALUE=-99999,r._MIN_DEPTH=0,r._MAX_DEPTH=1,r}();Object.defineProperty(D.prototype,"depthPeelingRenderer",{get:function(){if(!this._depthPeelingRenderer){var r=this._getComponent(P.NAME_DEPTHPEELINGRENDERER);r||(r=new it(this),this._addComponent(r))}return this._depthPeelingRenderer},set:function(r){this._depthPeelingRenderer=r},enumerable:!0,configurable:!0});Object.defineProperty(D.prototype,"useOrderIndependentTransparency",{get:function(){return this._useOrderIndependentTransparency},set:function(r){var e;this._useOrderIndependentTransparency!==r&&(this._useOrderIndependentTransparency=r,this.markAllMaterialsAsDirty(63),(e=this.prePassRenderer)===null||e===void 0||e.markAsDirty())},enumerable:!0,configurable:!0});var it=function(){function r(e){this.name=P.NAME_DEPTHPEELINGRENDERER,this.scene=e,e.depthPeelingRenderer=new rt(e)}return r.prototype.register=function(){},r.prototype.rebuild=function(){},r.prototype.dispose=function(){var e;(e=this.scene.depthPeelingRenderer)===null||e===void 0||e.dispose(),this.scene.depthPeelingRenderer=null},r}();pe.prototype.disableEdgesRendering=function(){return this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this};pe.prototype.enableEdgesRendering=function(r,e,t){return r===void 0&&(r=.95),e===void 0&&(e=!1),this.disableEdgesRendering(),this._edgesRenderer=new Be(this,r,e,!0,t),this};Object.defineProperty(pe.prototype,"edgesRenderer",{get:function(){return this._edgesRenderer},enumerable:!0,configurable:!0});Ie.prototype.enableEdgesRendering=function(r,e){return r===void 0&&(r=.95),e===void 0&&(e=!1),this.disableEdgesRendering(),this._edgesRenderer=new nt(this,r,e),this};Ge.prototype.enableEdgesRendering=function(r,e){return r===void 0&&(r=.95),e===void 0&&(e=!1),Ie.prototype.enableEdgesRendering.apply(this,arguments),this};var st=function(){function r(){this.edges=new Array,this.edgesConnectedCount=0}return r}(),Be=function(){function r(e,t,i,s,n){t===void 0&&(t=.95),i===void 0&&(i=!1),s===void 0&&(s=!0);var a=this,f;this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this._linesPositions=new Array,this._linesNormals=new Array,this._linesIndices=new Array,this._buffers={},this._buffersForInstances={},this._checkVerticesInsteadOfIndices=!1,this.isEnabled=!0,this.customInstances=new V(32),this._source=e,this._checkVerticesInsteadOfIndices=i,this._options=n!=null?n:null,this._epsilon=t,this._source.getScene().getEngine().isWebGPU&&(this._drawWrapper=new ce(e.getEngine())),this._prepareRessources(),s&&(!((f=n==null?void 0:n.useAlternateEdgeFinder)!==null&&f!==void 0)||f?this._generateEdgesLinesAlternate():this._generateEdgesLines()),this._meshRebuildObserver=this._source.onRebuildObservable.add(function(){a._rebuild()}),this._meshDisposeObserver=this._source.onDisposeObservable.add(function(){a.dispose()})}return Object.defineProperty(r.prototype,"linesPositions",{get:function(){return this._linesPositions},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"linesNormals",{get:function(){return this._linesNormals},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"linesIndices",{get:function(){return this._linesIndices},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"lineShader",{get:function(){return this._lineShader},set:function(e){this._lineShader=e},enumerable:!1,configurable:!0}),r._GetShader=function(e){if(!e._edgeRenderLineShader){var t=new Pe("lineShader",e,"line",{attributes:["position","normal"],uniforms:["world","viewProjection","color","width","aspectRatio"]},!1);t.disableDepthWrite=!0,t.backFaceCulling=!1,t.checkReadyOnEveryCall=e.getEngine().isWebGPU,e._edgeRenderLineShader=t}return e._edgeRenderLineShader},r.prototype._prepareRessources=function(){this._lineShader||(this._lineShader=r._GetShader(this._source.getScene()))},r.prototype._rebuild=function(){var e=this._buffers[_.PositionKind];e&&e._rebuild(),e=this._buffers[_.NormalKind],e&&e._rebuild();var t=this._source.getScene(),i=t.getEngine();this._ib=i.createIndexBuffer(this._linesIndices)},r.prototype.dispose=function(){var e;this._source.onRebuildObservable.remove(this._meshRebuildObserver),this._source.onDisposeObservable.remove(this._meshDisposeObserver);var t=this._buffers[_.PositionKind];t&&(t.dispose(),this._buffers[_.PositionKind]=null),t=this._buffers[_.NormalKind],t&&(t.dispose(),this._buffers[_.NormalKind]=null),this._ib&&this._source.getScene().getEngine()._releaseBuffer(this._ib),this._lineShader.dispose(),(e=this._drawWrapper)===null||e===void 0||e.dispose()},r.prototype._processEdgeForAdjacencies=function(e,t,i,s,n){return e===i&&t===s||e===s&&t===i?0:e===s&&t===n||e===n&&t===s?1:e===n&&t===i||e===i&&t===n?2:-1},r.prototype._processEdgeForAdjacenciesWithVertices=function(e,t,i,s,n){var a=1e-10;return e.equalsWithEpsilon(i,a)&&t.equalsWithEpsilon(s,a)||e.equalsWithEpsilon(s,a)&&t.equalsWithEpsilon(i,a)?0:e.equalsWithEpsilon(s,a)&&t.equalsWithEpsilon(n,a)||e.equalsWithEpsilon(n,a)&&t.equalsWithEpsilon(s,a)?1:e.equalsWithEpsilon(n,a)&&t.equalsWithEpsilon(i,a)||e.equalsWithEpsilon(i,a)&&t.equalsWithEpsilon(n,a)?2:-1},r.prototype._checkEdge=function(e,t,i,s,n){var a;if(t===void 0)a=!0;else{var f=U.Dot(i[e],i[t]);a=f<this._epsilon}a&&this.createLine(s,n,this._linesPositions.length/3)},r.prototype.createLine=function(e,t,i){this._linesPositions.push(e.x,e.y,e.z,e.x,e.y,e.z,t.x,t.y,t.z,t.x,t.y,t.z),this._linesNormals.push(t.x,t.y,t.z,-1,t.x,t.y,t.z,1,e.x,e.y,e.z,-1,e.x,e.y,e.z,1),this._linesIndices.push(i,i+1,i+2,i,i+2,i+3)},r.prototype._tessellateTriangle=function(e,t,i,s){var n=function(y,F,K){K>=0&&F.push(K);for(var N=0;N<y.length;++N)F.push(y[N][0])},a=0;e[1].length>=e[0].length&&e[1].length>=e[2].length?a=1:e[2].length>=e[0].length&&e[2].length>=e[1].length&&(a=2);for(var f=0;f<3;++f)f===a?e[f].sort(function(y,F){return y[1]<F[1]?-1:y[1]>F[1]?1:0}):e[f].sort(function(y,F){return y[1]>F[1]?-1:y[1]<F[1]?1:0});var l=[],o=[];n(e[a],l,-1);for(var u=l.length,d=a+2;d>=a+1;--d)n(e[d%3],o,d!==a+2?s[i[t+(d+1)%3]]:-1);var c=o.length,h=0,p=0;i.push(s[i[t+a]],l[0],o[0]),i.push(s[i[t+(a+1)%3]],o[c-1],l[u-1]);for(var m=u<=c,R=m?u:c,v=m?c:u,T=m?u-1:c-1,g=m?0:1,B=u+c-2,O=m?h:p,C=m?p:h,x=m?l:o,A=m?o:l,M=0;B-- >0;){g?i.push(x[O],A[C]):i.push(A[C],x[O]),M+=R;var q=void 0;M>=v&&O<T?(q=x[++O],M-=v):q=A[++C],i.push(q)}i[t+0]=i[i.length-3],i[t+1]=i[i.length-2],i[t+2]=i[i.length-1],i.length=i.length-3},r.prototype._generateEdgesLinesAlternate=function(){var e,t,i,s,n,a,f,l,o,u,d=this._source.getVerticesData(_.PositionKind),c=this._source.getIndices();if(!(!c||!d)){Array.isArray(c)||(c=Array.from(c));var h=(t=(e=this._options)===null||e===void 0?void 0:e.useFastVertexMerger)!==null&&t!==void 0?t:!0,p=h?Math.round(-Math.log((s=(i=this._options)===null||i===void 0?void 0:i.epsilonVertexMerge)!==null&&s!==void 0?s:1e-6)/Math.log(10)):(a=(n=this._options)===null||n===void 0?void 0:n.epsilonVertexMerge)!==null&&a!==void 0?a:1e-6,m=[],R=[];if(h)for(var v={},T=0;T<d.length;T+=3){var g=d[T+0],B=d[T+1],O=d[T+2],C=g.toFixed(p)+"|"+B.toFixed(p)+"|"+O.toFixed(p);if(v[C]!==void 0)m.push(v[C]);else{var x=T/3;v[C]=x,m.push(x),R.push(x)}}else for(var T=0;T<d.length;T+=3){for(var g=d[T+0],B=d[T+1],O=d[T+2],A=!1,M=0;M<T&&!A;M+=3){var q=d[M+0],y=d[M+1],F=d[M+2];if(Math.abs(g-q)<p&&Math.abs(B-y)<p&&Math.abs(O-F)<p){m.push(M/3),A=!0;break}}A||(m.push(T/3),R.push(T/3))}if(!((f=this._options)===null||f===void 0)&&f.applyTessellation){for(var K=(o=(l=this._options)===null||l===void 0?void 0:l.epsilonVertexAligned)!==null&&o!==void 0?o:1e-6,N=[],I=0;I<c.length;I+=3)for(var j=void 0,L=0;L<3;++L){var b=m[c[I+L]],E=m[c[I+(L+1)%3]],X=m[c[I+(L+2)%3]];if(b!==E)for(var te=d[b*3+0],re=d[b*3+1],ie=d[b*3+2],se=d[E*3+0],ne=d[E*3+1],ae=d[E*3+2],Le=Math.sqrt((se-te)*(se-te)+(ne-re)*(ne-re)+(ae-ie)*(ae-ie)),ge=0;ge<R.length-1;ge++){var z=R[ge];if(!(z===b||z===E||z===X)){var oe=d[z*3+0],ue=d[z*3+1],he=d[z*3+2],be=Math.sqrt((oe-te)*(oe-te)+(ue-re)*(ue-re)+(he-ie)*(he-ie)),Ne=Math.sqrt((oe-se)*(oe-se)+(ue-ne)*(ue-ne)+(he-ae)*(he-ae));Math.abs(be+Ne-Le)<K&&(j||(j={index:I,edgesPoints:[[],[],[]]},N.push(j)),j.edgesPoints[L].push([z,be]))}}}for(var me=0;me<N.length;++me){var Ee=N[me];this._tessellateTriangle(Ee.edgesPoints,Ee.index,c,m)}N=null}for(var fe={},I=0;I<c.length;I+=3)for(var J=void 0,L=0;L<3;++L){var b=m[c[I+L]],E=m[c[I+(L+1)%3]],X=m[c[I+(L+2)%3]];if(!(b===E||(b===X||E===X)&&((u=this._options)===null||u===void 0?void 0:u.removeDegeneratedTriangles))){if(S.Vector3[0].copyFromFloats(d[b*3+0],d[b*3+1],d[b*3+2]),S.Vector3[1].copyFromFloats(d[E*3+0],d[E*3+1],d[E*3+2]),S.Vector3[2].copyFromFloats(d[X*3+0],d[X*3+1],d[X*3+2]),J||(S.Vector3[1].subtractToRef(S.Vector3[0],S.Vector3[3]),S.Vector3[2].subtractToRef(S.Vector3[1],S.Vector3[4]),J=U.Cross(S.Vector3[3],S.Vector3[4]),J.normalize()),b>E){var we=b;b=E,E=we}var C=b+"_"+E,k=fe[C];if(k){if(!k.done){var Ue=U.Dot(J,k.normal);Ue<this._epsilon&&this.createLine(S.Vector3[0],S.Vector3[1],this._linesPositions.length/3),k.done=!0}}else fe[C]={normal:J,done:!1,index:I,i:L}}}for(var C in fe){var k=fe[C];if(!k.done){var b=m[c[k.index+k.i]],E=m[c[k.index+(k.i+1)%3]];S.Vector3[0].copyFromFloats(d[b*3+0],d[b*3+1],d[b*3+2]),S.Vector3[1].copyFromFloats(d[E*3+0],d[E*3+1],d[E*3+2]),this.createLine(S.Vector3[0],S.Vector3[1],this._linesPositions.length/3)}}var Re=this._source.getScene().getEngine();this._buffers[_.PositionKind]=new _(Re,this._linesPositions,_.PositionKind,!1),this._buffers[_.NormalKind]=new _(Re,this._linesNormals,_.NormalKind,!1,!1,4),this._buffersForInstances[_.PositionKind]=this._buffers[_.PositionKind],this._buffersForInstances[_.NormalKind]=this._buffers[_.NormalKind],this._ib=Re.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}},r.prototype._generateEdgesLines=function(){var e=this._source.getVerticesData(_.PositionKind),t=this._source.getIndices();if(!(!t||!e)){var i=new Array,s=new Array,n,a;for(n=0;n<t.length;n+=3){a=new st;var f=t[n],l=t[n+1],o=t[n+2];a.p0=new U(e[f*3],e[f*3+1],e[f*3+2]),a.p1=new U(e[l*3],e[l*3+1],e[l*3+2]),a.p2=new U(e[o*3],e[o*3+1],e[o*3+2]);var u=U.Cross(a.p1.subtract(a.p0),a.p2.subtract(a.p1));u.normalize(),s.push(u),i.push(a)}for(n=0;n<i.length;n++){a=i[n];for(var d=n+1;d<i.length;d++){var c=i[d];if(a.edgesConnectedCount===3)break;if(c.edgesConnectedCount!==3)for(var h=t[d*3],p=t[d*3+1],m=t[d*3+2],R=0;R<3;R++){var v=0;if(a.edges[R]===void 0){switch(R){case 0:this._checkVerticesInsteadOfIndices?v=this._processEdgeForAdjacenciesWithVertices(a.p0,a.p1,c.p0,c.p1,c.p2):v=this._processEdgeForAdjacencies(t[n*3],t[n*3+1],h,p,m);break;case 1:this._checkVerticesInsteadOfIndices?v=this._processEdgeForAdjacenciesWithVertices(a.p1,a.p2,c.p0,c.p1,c.p2):v=this._processEdgeForAdjacencies(t[n*3+1],t[n*3+2],h,p,m);break;case 2:this._checkVerticesInsteadOfIndices?v=this._processEdgeForAdjacenciesWithVertices(a.p2,a.p0,c.p0,c.p1,c.p2):v=this._processEdgeForAdjacencies(t[n*3+2],t[n*3],h,p,m);break}if(v!==-1&&(a.edges[R]=d,c.edges[v]=n,a.edgesConnectedCount++,c.edgesConnectedCount++,a.edgesConnectedCount===3))break}}}}for(n=0;n<i.length;n++){var T=i[n];this._checkEdge(n,T.edges[0],s,T.p0,T.p1),this._checkEdge(n,T.edges[1],s,T.p1,T.p2),this._checkEdge(n,T.edges[2],s,T.p2,T.p0)}var g=this._source.getScene().getEngine();this._buffers[_.PositionKind]=new _(g,this._linesPositions,_.PositionKind,!1),this._buffers[_.NormalKind]=new _(g,this._linesNormals,_.NormalKind,!1,!1,4),this._buffersForInstances[_.PositionKind]=this._buffers[_.PositionKind],this._buffersForInstances[_.NormalKind]=this._buffers[_.NormalKind],this._ib=g.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}},r.prototype.isReady=function(){return this._lineShader.isReady(this._source,this._source.hasInstances&&this.customInstances.length>0||this._source.hasThinInstances)},r.prototype.render=function(){var e=this._source.getScene(),t=this._lineShader._getDrawWrapper();if(this._drawWrapper&&this._lineShader._setDrawWrapper(this._drawWrapper),!this.isReady()||!e.activeCamera){this._lineShader._setDrawWrapper(t);return}var i=this._source.hasInstances&&this.customInstances.length>0,s=i||this._source.hasThinInstances,n=0;if(s)if(this._buffersForInstances.world0=this._source.getVertexBuffer("world0"),this._buffersForInstances.world1=this._source.getVertexBuffer("world1"),this._buffersForInstances.world2=this._source.getVertexBuffer("world2"),this._buffersForInstances.world3=this._source.getVertexBuffer("world3"),i){var a=this._source._instanceDataStorage;if(n=this.customInstances.length,!a.instancesData){this._source.getScene()._activeMeshesFrozen||this.customInstances.reset();return}if(!a.isFrozen){for(var f=0,l=0;l<n;++l)this.customInstances.data[l].copyToArray(a.instancesData,f),f+=16;a.instancesBuffer.updateDirectly(a.instancesData,0,n)}}else n=this._source.thinInstanceCount;var o=e.getEngine();this._lineShader._preBind(),this._source.edgesColor.a!==1?o.setAlphaMode(2):o.setAlphaMode(0),o.bindBuffers(s?this._buffersForInstances:this._buffers,this._ib,this._lineShader.getEffect()),e.resetCachedMaterial(),this._lineShader.setColor4("color",this._source.edgesColor),e.activeCamera.mode===De.ORTHOGRAPHIC_CAMERA?this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic):this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective),this._lineShader.setFloat("aspectRatio",o.getAspectRatio(e.activeCamera)),this._lineShader.bind(this._source.getWorldMatrix()),o.drawElementsType(G.TriangleFillMode,0,this._indicesCount,n),this._lineShader.unbind(),s&&o.unbindInstanceAttributes(),this._source.getScene()._activeMeshesFrozen||this.customInstances.reset(),this._lineShader._setDrawWrapper(t)},r}(),nt=function(r){qe(e,r);function e(t,i,s){i===void 0&&(i=.95),s===void 0&&(s=!1);var n=r.call(this,t,i,s,!1)||this;return n._generateEdgesLines(),n}return e.prototype._generateEdgesLines=function(){var t=this._source.getVerticesData(_.PositionKind),i=this._source.getIndices();if(!(!i||!t)){for(var s=S.Vector3[0],n=S.Vector3[1],a=i.length-1,f=0,l=0;f<a;f+=2,l+=4)U.FromArrayToRef(t,3*i[f],s),U.FromArrayToRef(t,3*i[f+1],n),this.createLine(s,n,l);var o=this._source.getScene().getEngine();this._buffers[_.PositionKind]=new _(o,this._linesPositions,_.PositionKind,!1),this._buffers[_.NormalKind]=new _(o,this._linesNormals,_.NormalKind,!1,!1,4),this._ib=o.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}},e}(Be),Ae=function(){function r(e){this.excludedSkinnedMesh=[],this.excludedMaterials=[],this.mrtCount=0,this._mrtFormats=[],this._mrtLayout=[],this._mrtNames=[],this._textureIndices=[],this._isDirty=!0,this._effectConfigurations=[],this.doNotUseGeometryRendererFallback=!0,this.renderTargets=[],this._clearColor=new Q(0,0,0,0),this._enabled=!1,this._needsCompositionForThisPass=!1,this.disableGammaTransform=!1,this._scene=e,this._engine=e.getEngine(),r._SceneComponentInitialization(this._scene),this.defaultRT=this._createRenderTarget("sceneprePassRT",null),this._currentTarget=this.defaultRT}return r.prototype.getIndex=function(e){return this._textureIndices[e]},Object.defineProperty(r.prototype,"samples",{get:function(){return this.defaultRT.samples},set:function(e){this.defaultRT.samples=e},enumerable:!1,configurable:!0}),r.prototype.getRenderTarget=function(){return this._currentTarget},r.prototype._setRenderTarget=function(e){e?this._currentTarget=e:this._currentTarget=this.defaultRT,this._engine.currentRenderPassId=this._currentTarget.renderPassId},Object.defineProperty(r.prototype,"currentRTisSceneRT",{get:function(){return this._currentTarget===this.defaultRT},enumerable:!1,configurable:!0}),r.prototype._refreshGeometryBufferRendererLink=function(){if(this.doNotUseGeometryRendererFallback)this._geometryBuffer&&this._geometryBuffer._unlinkPrePassRenderer(),this._geometryBuffer=null,this._scene.disableGeometryBufferRenderer();else{if(this._geometryBuffer=this._scene.enableGeometryBufferRenderer(),!this._geometryBuffer){this.doNotUseGeometryRendererFallback=!0;return}this._geometryBuffer._linkPrePassRenderer(this)}},Object.defineProperty(r.prototype,"enabled",{get:function(){return this._enabled},enumerable:!1,configurable:!0}),r.prototype._createRenderTarget=function(e,t){var i=new He(e,t,{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},0,this._scene,{generateMipMaps:!1,generateStencilBuffer:this._engine.isStencilEnable,defaultType:0,types:[],drawOnlyOnFirstAttachmentByDefault:!0});return this.renderTargets.push(i),i},Object.defineProperty(r.prototype,"isSupported",{get:function(){return this._scene.getEngine().getCaps().drawBuffersExtension},enumerable:!1,configurable:!0}),r.prototype.bindAttachmentsForEffect=function(e,t){var i=t.getMaterial(),s=i&&i.isPrePassCapable,n=i&&this.excludedMaterials.indexOf(i)!==-1;this.enabled&&this._currentTarget.enabled&&(e._multiTarget&&s&&!n?this._engine.bindAttachments(this._multiRenderAttachments):(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment(),this._geometryBuffer&&this.currentRTisSceneRT&&!n&&this._geometryBuffer.renderList.push(t.getRenderingMesh())))},r.prototype._reinitializeAttachments=function(){for(var e=[],t=[!1],i=[!0],s=0;s<this.mrtCount;s++)e.push(!0),s>0&&(t.push(!0),i.push(!1));this._multiRenderAttachments=this._engine.buildTextureLayout(e),this._clearAttachments=this._engine.buildTextureLayout(t),this._defaultAttachments=this._engine.buildTextureLayout(i)},r.prototype._resetLayout=function(){for(var e=0;e<r._TextureFormats.length;e++)this._textureIndices[r._TextureFormats[e].type]=-1;this._textureIndices[4]=0,this._mrtLayout=[4],this._mrtFormats=[r._TextureFormats[4].format],this._mrtNames=[r._TextureFormats[4].name],this.mrtCount=1},r.prototype._updateGeometryBufferLayout=function(){if(this._refreshGeometryBufferRendererLink(),this._geometryBuffer){this._geometryBuffer._resetLayout();for(var e=[],t=0;t<this._mrtLayout.length;t++)e.push(!1);this._geometryBuffer._linkInternalTexture(this.defaultRT.getInternalTexture());for(var i=[{prePassConstant:5,geometryBufferConstant:Y.DEPTH_TEXTURE_TYPE},{prePassConstant:6,geometryBufferConstant:Y.NORMAL_TEXTURE_TYPE},{prePassConstant:1,geometryBufferConstant:Y.POSITION_TEXTURE_TYPE},{prePassConstant:3,geometryBufferConstant:Y.REFLECTIVITY_TEXTURE_TYPE},{prePassConstant:2,geometryBufferConstant:Y.VELOCITY_TEXTURE_TYPE}],t=0;t<i.length;t++){var s=this._mrtLayout.indexOf(i[t].prePassConstant);s!==-1&&(this._geometryBuffer._forceTextureType(i[t].geometryBufferConstant,s),e[s]=!0)}this._geometryBuffer._setAttachments(this._engine.buildTextureLayout(e))}},r.prototype.restoreAttachments=function(){this.enabled&&this._currentTarget.enabled&&this._defaultAttachments&&(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment())},r.prototype._beforeDraw=function(e,t,i){this._isDirty&&this._update(),!(!this._enabled||!this._currentTarget.enabled)&&(this._geometryBuffer&&(this._geometryBuffer.renderList=[]),this._setupOutputForThisPass(this._currentTarget,e))},r.prototype._prepareFrame=function(e,t,i){e.renderTargetTexture?e.renderTargetTexture._prepareFrame(this._scene,t,i,e.renderTargetTexture.useCameraPostProcesses):this._postProcessesSourceForThisPass.length?this._scene.postProcessManager._prepareFrame():this._engine.restoreDefaultFramebuffer()},r.prototype._renderPostProcesses=function(e,t){var i,s=this._postProcessesSourceForThisPass[0],n=s?s.inputTexture:e.renderTargetTexture?e.renderTargetTexture.renderTarget:null,a=this._currentTarget._beforeCompositionPostProcesses;this._needsCompositionForThisPass&&(a=a.concat([this._currentTarget.imageProcessingPostProcess])),a.length&&(this._scene.postProcessManager._prepareFrame((i=this._currentTarget.renderTarget)===null||i===void 0?void 0:i.texture,a),this._scene.postProcessManager.directRender(a,n,!1,t))},r.prototype._afterDraw=function(e,t){this._enabled&&this._currentTarget.enabled&&(this._prepareFrame(this._currentTarget,e,t),this._renderPostProcesses(this._currentTarget,e))},r.prototype._clear=function(){this._enabled&&this._currentTarget.enabled&&(this._bindFrameBuffer(this._currentTarget),this._engine.bindAttachments(this._clearAttachments),this._engine.clear(this._clearColor,!0,!1,!1),this._engine.bindAttachments(this._defaultAttachments))},r.prototype._bindFrameBuffer=function(e){if(this._enabled&&this._currentTarget.enabled){this._currentTarget._checkSize();var t=this._currentTarget.renderTarget;t&&this._engine.bindFramebuffer(t)}},r.prototype._setEnabled=function(e){this._enabled=e},r.prototype._setRenderTargetEnabled=function(e,t){e.enabled=t,t||this._unlinkInternalTexture(e)},r.prototype.addEffectConfiguration=function(e){for(var t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].name===e.name)return this._effectConfigurations[t];return this._effectConfigurations.push(e),e},r.prototype._enable=function(){for(var e=this.mrtCount,t=0;t<this._effectConfigurations.length;t++)this._effectConfigurations[t].enabled&&this._enableTextures(this._effectConfigurations[t].texturesRequired);for(var t=0;t<this.renderTargets.length;t++){(this.mrtCount!==e||this.renderTargets[t].count!==this.mrtCount)&&this.renderTargets[t].updateCount(this.mrtCount,{types:this._mrtFormats},this._mrtNames.concat("prePass_DepthBuffer")),this.renderTargets[t]._resetPostProcessChain();for(var i=0;i<this._effectConfigurations.length;i++)this._effectConfigurations[i].enabled&&(!this._effectConfigurations[i].postProcess&&this._effectConfigurations[i].createPostProcess&&this._effectConfigurations[i].createPostProcess(),this._effectConfigurations[i].postProcess&&this.renderTargets[t]._beforeCompositionPostProcesses.push(this._effectConfigurations[i].postProcess))}this._reinitializeAttachments(),this._setEnabled(!0),this._updateGeometryBufferLayout()},r.prototype._disable=function(){this._setEnabled(!1);for(var e=0;e<this.renderTargets.length;e++)this._setRenderTargetEnabled(this.renderTargets[e],!1);this._resetLayout();for(var e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled=!1},r.prototype._getPostProcessesSource=function(e,t){if(t)return t._postProcesses;if(e.renderTargetTexture)if(e.renderTargetTexture.useCameraPostProcesses){var i=e.renderTargetTexture.activeCamera?e.renderTargetTexture.activeCamera:this._scene.activeCamera;return i?i._postProcesses:[]}else return e.renderTargetTexture.postProcesses?e.renderTargetTexture.postProcesses:[];else return this._scene.activeCamera?this._scene.activeCamera._postProcesses:[]},r.prototype._setupOutputForThisPass=function(e,t){var i=t&&this._scene.activeCameras&&!!this._scene.activeCameras.length&&this._scene.activeCameras.indexOf(t)!==0;this._postProcessesSourceForThisPass=this._getPostProcessesSource(e,t),this._postProcessesSourceForThisPass=this._postProcessesSourceForThisPass.filter(function(l){return l!=null}),this._scene.autoClear=!0;var s=this._hasImageProcessing(this._postProcessesSourceForThisPass);this._needsCompositionForThisPass=!s&&!this.disableGammaTransform&&this._needsImageProcessing()&&!i;var n=this._getFirstPostProcess(this._postProcessesSourceForThisPass),a=e._beforeCompositionPostProcesses&&e._beforeCompositionPostProcesses[0],f=null;this._scene.imageProcessingConfiguration.applyByPostProcess=this._needsCompositionForThisPass||s,this._needsCompositionForThisPass&&!e.imageProcessingPostProcess&&e._createCompositionEffect(),a?f=a:this._needsCompositionForThisPass?f=e.imageProcessingPostProcess:n&&(f=n),this._bindFrameBuffer(e),this._linkInternalTexture(e,f)},r.prototype._linkInternalTexture=function(e,t){t&&(t.autoClear=!1,t.inputTexture=e.renderTarget),e._outputPostProcess!==t&&(e._outputPostProcess&&this._unlinkInternalTexture(e),e._outputPostProcess=t),e._internalTextureDirty&&(this._updateGeometryBufferLayout(),e._internalTextureDirty=!1)},r.prototype._unlinkInternalTexture=function(e){e._outputPostProcess&&(e._outputPostProcess.autoClear=!0,e._outputPostProcess.restoreDefaultInputTexture(),e._outputPostProcess=null)},r.prototype._needsImageProcessing=function(){for(var e=0;e<this._effectConfigurations.length;e++)if(this._effectConfigurations[e].enabled&&this._effectConfigurations[e].needsImageProcessing)return!0;return!1},r.prototype._hasImageProcessing=function(e){var t,i=!1;if(e){for(var s=0;s<e.length;s++)if(((t=e[s])===null||t===void 0?void 0:t.getClassName())==="ImageProcessingPostProcess"){i=!0;break}}return i},r.prototype._getFirstPostProcess=function(e){for(var t=0;t<e.length;t++)if(e[t]!==null)return e[t];return null},r.prototype.markAsDirty=function(){this._isDirty=!0},r.prototype._enableTextures=function(e){this._scene.needsPreviousWorldMatrices=!1;for(var t=0;t<e.length;t++){var i=e[t];this._textureIndices[i]===-1&&(this._textureIndices[i]=this._mrtLayout.length,this._mrtLayout.push(i),this._mrtFormats.push(r._TextureFormats[i].format),this._mrtNames.push(r._TextureFormats[i].name),this.mrtCount++),i===2&&(this._scene.needsPreviousWorldMatrices=!0)}},r.prototype._update=function(){this._disable();var e=!1;this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._scene._depthPeelingRenderer&&this._scene.useOrderIndependentTransparency&&(this._scene._depthPeelingRenderer.setPrePassRenderer(this),e=!0);for(var t=0;t<this._scene.materials.length;t++)this._scene.materials[t].setPrePassRenderer(this)&&(e=!0);e&&this._setRenderTargetEnabled(this.defaultRT,!0);for(var i,t=0;t<this.renderTargets.length;t++){if(this.renderTargets[t].renderTargetTexture)i=this._getPostProcessesSource(this.renderTargets[t]);else{var s=this._scene.activeCamera;if(!s)continue;i=s._postProcesses}if(!!i&&(i=i.filter(function(f){return f!=null}),i)){for(var n=0;n<i.length;n++)i[n].setPrePassRenderer(this)&&(this._setRenderTargetEnabled(this.renderTargets[t],!0),e=!0);this._hasImageProcessing(i)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!0)}}this._markAllMaterialsAsPrePassDirty(),this._isDirty=!1,e&&this._enable()},r.prototype._markAllMaterialsAsPrePassDirty=function(){for(var e=this._scene.materials,t=0;t<e.length;t++)e[t].markAsDirty(G.PrePassDirtyFlag)},r.prototype.dispose=function(){for(var e=this.renderTargets.length-1;e>=0;e--)this.renderTargets[e].dispose();for(var e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].dispose&&this._effectConfigurations[e].dispose()},r._SceneComponentInitialization=function(e){throw _e("PrePassRendererSceneComponent")},r._TextureFormats=[{type:0,format:2,name:"prePass_Irradiance"},{type:1,format:2,name:"prePass_Position"},{type:2,format:0,name:"prePass_Velocity"},{type:3,format:0,name:"prePass_Reflectivity"},{type:4,format:2,name:"prePass_Color"},{type:5,format:2,name:"prePass_Depth"},{type:6,format:2,name:"prePass_Normal"},{type:7,format:0,name:"prePass_Albedo"}],r}();Object.defineProperty(D.prototype,"prePassRenderer",{get:function(){return this._prePassRenderer},set:function(r){r&&r.isSupported&&(this._prePassRenderer=r)},enumerable:!0,configurable:!0});D.prototype.enablePrePassRenderer=function(){return this._prePassRenderer?this._prePassRenderer:(this._prePassRenderer=new Ae(this),this._prePassRenderer.isSupported||(this._prePassRenderer=null,ye.Error(`PrePassRenderer needs WebGL 2 support.
Maybe you tried to use the following features that need the PrePassRenderer :
 + Subsurface Scattering`)),this._prePassRenderer)};D.prototype.disablePrePassRenderer=function(){!this._prePassRenderer||(this._prePassRenderer.dispose(),this._prePassRenderer=null)};var at=function(){function r(e){this.name=P.NAME_PREPASSRENDERER,this.scene=e}return r.prototype.register=function(){this.scene._beforeCameraDrawStage.registerStep(P.STEP_BEFORECAMERADRAW_PREPASS,this,this._beforeCameraDraw),this.scene._afterCameraDrawStage.registerStep(P.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterCameraDraw),this.scene._beforeRenderTargetDrawStage.registerStep(P.STEP_BEFORERENDERTARGETDRAW_PREPASS,this,this._beforeRenderTargetDraw),this.scene._afterRenderTargetDrawStage.registerStep(P.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterRenderTargetDraw),this.scene._beforeClearStage.registerStep(P.STEP_BEFORECLEAR_PREPASS,this,this._beforeClearStage),this.scene._beforeRenderTargetClearStage.registerStep(P.STEP_BEFORERENDERTARGETCLEAR_PREPASS,this,this._beforeRenderTargetClearStage),this.scene._beforeRenderingMeshStage.registerStep(P.STEP_BEFORERENDERINGMESH_PREPASS,this,this._beforeRenderingMeshStage),this.scene._afterRenderingMeshStage.registerStep(P.STEP_AFTERRENDERINGMESH_PREPASS,this,this._afterRenderingMeshStage)},r.prototype._beforeRenderTargetDraw=function(e,t,i){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._beforeDraw(void 0,t,i))},r.prototype._afterRenderTargetDraw=function(e,t,i){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw(t,i)},r.prototype._beforeRenderTargetClearStage=function(e){this.scene.prePassRenderer&&(e._prePassRenderTarget||(e._prePassRenderTarget=this.scene.prePassRenderer._createRenderTarget(e.name+"_prePassRTT",e)),this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._clear())},r.prototype._beforeCameraDraw=function(e){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._beforeDraw(e))},r.prototype._afterCameraDraw=function(){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw()},r.prototype._beforeClearStage=function(){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._clear())},r.prototype._beforeRenderingMeshStage=function(e,t,i,s){if(!!s){var n=e.getScene();n.prePassRenderer&&n.prePassRenderer.bindAttachmentsForEffect(s,t)}},r.prototype._afterRenderingMeshStage=function(e){var t=e.getScene();t.prePassRenderer&&t.prePassRenderer.restoreAttachments()},r.prototype.rebuild=function(){this.scene.disablePrePassRenderer(),this.scene.enablePrePassRenderer()},r.prototype.dispose=function(){this.scene.disablePrePassRenderer()},r}();Ae._SceneComponentInitialization=function(r){var e=r._getComponent(P.NAME_PREPASSRENDERER);e||(e=new at(r),r._addComponent(e))};var Fe=function(){function r(e){this._ssDiffusionS=[],this._ssFilterRadii=[],this._ssDiffusionD=[],this.enabled=!1,this.needsImageProcessing=!0,this.name=P.NAME_SUBSURFACE,this.ssDiffusionProfileColors=[],this.metersPerUnit=1,this.texturesRequired=[5,7,4,0],this.addDiffusionProfile(new ee(1,1,1)),this._scene=e,r._SceneComponentInitialization(this._scene)}return Object.defineProperty(r.prototype,"ssDiffusionS",{get:function(){return this._ssDiffusionS},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"ssDiffusionD",{get:function(){return this._ssDiffusionD},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"ssFilterRadii",{get:function(){return this._ssFilterRadii},enumerable:!1,configurable:!0}),r.prototype.addDiffusionProfile=function(e){if(this.ssDiffusionD.length>=5)return ye.Error("You already reached the maximum number of diffusion profiles."),0;for(var t=0;t<this._ssDiffusionS.length/3;t++)if(this._ssDiffusionS[t*3]===e.r&&this._ssDiffusionS[t*3+1]===e.g&&this._ssDiffusionS[t*3+2]===e.b)return t;return this._ssDiffusionS.push(e.r,e.b,e.g),this._ssDiffusionD.push(Math.max(Math.max(e.r,e.b),e.g)),this._ssFilterRadii.push(this.getDiffusionProfileParameters(e)),this.ssDiffusionProfileColors.push(e),this._ssDiffusionD.length-1},r.prototype.createPostProcess=function(){return this.postProcess=new je("subSurfaceScattering",this._scene,1,null,void 0,this._scene.getEngine()),this.postProcess.autoClear=!1,this.postProcess},r.prototype.clearAllDiffusionProfiles=function(){this._ssDiffusionD=[],this._ssDiffusionS=[],this._ssFilterRadii=[],this.ssDiffusionProfileColors=[]},r.prototype.dispose=function(){this.clearAllDiffusionProfiles(),this.postProcess&&this.postProcess.dispose()},r.prototype.getDiffusionProfileParameters=function(e){var t=.997,i=Math.max(e.r,e.g,e.b);return this._sampleBurleyDiffusionProfile(t,i)},r.prototype._sampleBurleyDiffusionProfile=function(e,t){e=1-e;var i=1+4*e*(2*e+Math.sqrt(1+4*e*e)),s=Math.pow(i,-1/3),n=i*s*s,a=1+n+s,f=3*Math.log(a/(4*e));return f*t},r._SceneComponentInitialization=function(e){throw _e("SubSurfaceSceneComponent")},r}();Xe.AddParser(P.NAME_SUBSURFACE,function(r,e){if(r.ssDiffusionProfileColors!==void 0&&r.ssDiffusionProfileColors!==null&&(e.enableSubSurfaceForPrePass(),e.subSurfaceConfiguration))for(var t=0,i=r.ssDiffusionProfileColors.length;t<i;t++){var s=r.ssDiffusionProfileColors[t];e.subSurfaceConfiguration.addDiffusionProfile(new ee(s.r,s.g,s.b))}});Object.defineProperty(D.prototype,"subSurfaceConfiguration",{get:function(){return this._subSurfaceConfiguration},set:function(r){r&&this.enablePrePassRenderer()&&(this._subSurfaceConfiguration=r)},enumerable:!0,configurable:!0});D.prototype.enableSubSurfaceForPrePass=function(){if(this._subSurfaceConfiguration)return this._subSurfaceConfiguration;var r=this.enablePrePassRenderer();return r?(this._subSurfaceConfiguration=new Fe(this),r.addEffectConfiguration(this._subSurfaceConfiguration),this._subSurfaceConfiguration):null};D.prototype.disableSubSurfaceForPrePass=function(){!this._subSurfaceConfiguration||(this._subSurfaceConfiguration.dispose(),this._subSurfaceConfiguration=null)};var ot=function(){function r(e){this.name=P.NAME_PREPASSRENDERER,this.scene=e}return r.prototype.register=function(){},r.prototype.serialize=function(e){if(!!this.scene.subSurfaceConfiguration){var t=this.scene.subSurfaceConfiguration.ssDiffusionProfileColors;e.ssDiffusionProfileColors=[];for(var i=0;i<t.length;i++)e.ssDiffusionProfileColors.push({r:t[i].r,g:t[i].g,b:t[i].b})}},r.prototype.addFromContainer=function(){},r.prototype.removeFromContainer=function(){!this.scene.prePassRenderer||this.scene.subSurfaceConfiguration&&this.scene.subSurfaceConfiguration.clearAllDiffusionProfiles()},r.prototype.rebuild=function(){},r.prototype.dispose=function(){},r}();Fe._SceneComponentInitialization=function(r){var e=r._getComponent(P.NAME_SUBSURFACE);e||(e=new ot(r),r._addComponent(e))};D.prototype.getOutlineRenderer=function(){return this._outlineRenderer||(this._outlineRenderer=new ut(this)),this._outlineRenderer};Object.defineProperty(xe.prototype,"renderOutline",{get:function(){return this._renderOutline},set:function(r){r&&this.getScene().getOutlineRenderer(),this._renderOutline=r},enumerable:!0,configurable:!0});Object.defineProperty(xe.prototype,"renderOverlay",{get:function(){return this._renderOverlay},set:function(r){r&&this.getScene().getOutlineRenderer(),this._renderOverlay=r},enumerable:!0,configurable:!0});var ut=function(){function r(e){this.name=P.NAME_OUTLINERENDERER,this.zOffset=1,this.zOffsetUnits=4,this.scene=e,this._engine=e.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=[];for(var t=0;t<4;++t)this._passIdForDrawWrapper[t]=this._engine.createRenderPassId("Outline Renderer (".concat(t,")"))}return r.prototype.register=function(){this.scene._beforeRenderingMeshStage.registerStep(P.STEP_BEFORERENDERINGMESH_OUTLINE,this,this._beforeRenderingMesh),this.scene._afterRenderingMeshStage.registerStep(P.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)},r.prototype.rebuild=function(){},r.prototype.dispose=function(){for(var e=0;e<this._passIdForDrawWrapper.length;++e)this._engine.releaseRenderPassId(this._passIdForDrawWrapper[e])},r.prototype.render=function(e,t,i,s){i===void 0&&(i=!1),s=s!=null?s:this._passIdForDrawWrapper[0];var n=this.scene,a=n.getEngine(),f=a.getCaps().instancedArrays&&(t.visibleInstances[e._id]!==null&&t.visibleInstances[e._id]!==void 0||e.getRenderingMesh().hasThinInstances);if(!!this.isReady(e,f,s)){var l=e.getMesh(),o=l._internalAbstractMeshDataInfo._actAsRegularMesh?l:null,u=e.getRenderingMesh(),d=o||u,c=e.getMaterial();if(!(!c||!n.activeCamera)){var h=e._getDrawWrapper(s),p=ce.GetEffect(h);if(a.enableEffect(h),c.useLogarithmicDepth&&p.setFloat("logarithmicDepthConstant",2/(Math.log(n.activeCamera.maxZ+1)/Math.LN2)),p.setFloat("offset",i?0:u.outlineWidth),p.setColor4("color",i?u.overlayColor:u.outlineColor,i?u.overlayAlpha:c.alpha),p.setMatrix("viewProjection",n.getTransformMatrix()),p.setMatrix("world",d.getWorldMatrix()),u.useBones&&u.computeBonesUsingShaders&&u.skeleton&&p.setMatrices("mBones",u.skeleton.getTransformMatrices(u)),u.morphTargetManager&&u.morphTargetManager.isUsingTextureForTargets&&u.morphTargetManager._bind(p),W.BindMorphTargetParameters(u,p),f||u._bind(e,p,c.fillMode),c&&c.needAlphaTesting()){var m=c.getAlphaTestTexture();m&&(p.setTexture("diffuseSampler",m),p.setMatrix("diffuseMatrix",m.getTextureMatrix()))}W.BindClipPlane(p,n),a.setZOffset(-this.zOffset),a.setZOffsetUnits(-this.zOffsetUnits),u._processRendering(d,e,p,c.fillMode,t,f,function(R,v){p.setMatrix("world",v)}),a.setZOffset(0),a.setZOffsetUnits(0)}}},r.prototype.isReady=function(e,t,i){i=i!=null?i:this._passIdForDrawWrapper[0];var s=[],n=[_.PositionKind,_.NormalKind],a=e.getMesh(),f=e.getMaterial(),l=a.getScene();f&&(f.needAlphaTesting()&&(s.push("#define ALPHATEST"),a.isVerticesDataPresent(_.UVKind)&&(n.push(_.UVKind),s.push("#define UV1")),a.isVerticesDataPresent(_.UV2Kind)&&(n.push(_.UV2Kind),s.push("#define UV2"))),f.useLogarithmicDepth&&s.push("#define LOGARITHMICDEPTH")),a.useBones&&a.computeBonesUsingShaders?(n.push(_.MatricesIndicesKind),n.push(_.MatricesWeightsKind),a.numBoneInfluencers>4&&(n.push(_.MatricesIndicesExtraKind),n.push(_.MatricesWeightsExtraKind)),s.push("#define NUM_BONE_INFLUENCERS "+a.numBoneInfluencers),s.push("#define BonesPerMesh "+(a.skeleton?a.skeleton.bones.length+1:0))):s.push("#define NUM_BONE_INFLUENCERS 0");var o=a.morphTargetManager,u=0;o&&o.numInfluencers>0&&(u=o.numInfluencers,s.push("#define MORPHTARGETS"),s.push("#define NUM_MORPH_INFLUENCERS "+u),o.isUsingTextureForTargets&&s.push("#define MORPHTARGETS_TEXTURE"),W.PrepareAttributesForMorphTargetsInfluencers(n,a,u)),t&&(s.push("#define INSTANCES"),W.PushAttributesForInstances(n),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES")),l.clipPlane&&s.push("#define CLIPPLANE"),l.clipPlane2&&s.push("#define CLIPPLANE2"),l.clipPlane3&&s.push("#define CLIPPLANE3"),l.clipPlane4&&s.push("#define CLIPPLANE4"),l.clipPlane5&&s.push("#define CLIPPLANE5"),l.clipPlane6&&s.push("#define CLIPPLANE6");var d=e._getDrawWrapper(i,!0),c=d.defines,h=s.join(`
`);return c!==h&&d.setEffect(this.scene.getEngine().createEffect("outline",n,["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6"],["diffuseSampler","morphTargets"],h,void 0,void 0,void 0,{maxSimultaneousMorphTargets:u}),h),d.effect.isReady()},r.prototype._beforeRenderingMesh=function(e,t,i){if(this._savedDepthWrite=this._engine.getDepthWrite(),e.renderOutline){var s=t.getMaterial();s&&s.needAlphaBlendingForMesh(e)&&(this._engine.cacheStencilState(),this._engine.setDepthWrite(!1),this._engine.setColorWrite(!1),this._engine.setStencilBuffer(!0),this._engine.setStencilOperationPass(7681),this._engine.setStencilFunction(519),this._engine.setStencilMask(r._StencilReference),this._engine.setStencilFunctionReference(r._StencilReference),this._engine.stencilStateComposer.useStencilGlobalOnly=!0,this.render(t,i,!0,this._passIdForDrawWrapper[1]),this._engine.setColorWrite(!0),this._engine.setStencilFunction(517)),this._engine.setDepthWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[0]),this._engine.setDepthWrite(this._savedDepthWrite),s&&s.needAlphaBlendingForMesh(e)&&(this._engine.stencilStateComposer.useStencilGlobalOnly=!1,this._engine.restoreStencilState())}},r.prototype._afterRenderingMesh=function(e,t,i){if(e.renderOverlay){var s=this._engine.getAlphaMode(),n=this._engine.alphaState.alphaBlend;this._engine.setAlphaMode(2),this.render(t,i,!0,this._passIdForDrawWrapper[3]),this._engine.setAlphaMode(s),this._engine.setDepthWrite(this._savedDepthWrite),this._engine.alphaState.alphaBlend=n}e.renderOutline&&this._savedDepthWrite&&(this._engine.setDepthWrite(!0),this._engine.setColorWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[2]),this._engine.setColorWrite(!0))},r._StencilReference=4,r}();export{Oe as D,Y as G,Mt as M,St as R,It as S,Ct as U,xt as a};
