import{D as _e,R as Ft,_ as Jt,G as Ce,O as Xe,aq as fe,S as $t,ar as wt,as as ei,at as Vt,L as Et}from"./@babylonjscore_Misc.d81f49ec.js";import{a as c,S as b,T as O,V as Te,b as H,c as Se,h as Lt,M as Ge,C as Me,Q as St,A as ti}from"./@babylonjscore_Maths.f3ef132c.js";import{q as ii,E as ri,r as zt,U as ni,d as Ue,R as tt,I as ft,s as si,l as ai,S as Tt,n as At,B as oi}from"./@babylonjscore_Materials.00e32dae.js";import{T as gt,E as We,a as hi}from"./@babylonjscore_Engines.7287f97a.js";import{_ as lt,b as yt}from"./tslibtslib.b6e59fa7.js";import{V as z,S as ui,B as it}from"./@babylonjscore_Buffers.f937a5fd.js";import"./@babylonjscore_Shaders.73b25e8e.js";import{a as fi}from"./@babylonjscore_Compute.71e01459.js";import"./@babylonjscore_ShadersWGSL.440a023d.js";import{d as li,M as dt,A as di,k as ci,V as ht,S as pi}from"./@babylonjscore_Meshes.307935b5.js";import{A as xt}from"./@babylonjscore_abstractScene.d5c48c49.js";import{S as bt}from"./@babylonjscore_sceneComponent.4b70ec43.js";import{a as _i,B as Ot,R as mi}from"./@babylonjscore_Culling.457ad209.js";var rt=function(){function o(){this.direction1=new c(0,1,0),this.direction2=new c(0,1,0),this.minEmitBox=new c(-.5,-.5,-.5),this.maxEmitBox=new c(.5,.5,.5)}return o.prototype.startDirectionFunction=function(t,e,i,r){var a=b.RandomRange(this.direction1.x,this.direction2.x),n=b.RandomRange(this.direction1.y,this.direction2.y),h=b.RandomRange(this.direction1.z,this.direction2.z);if(r){e.x=a,e.y=n,e.z=h;return}c.TransformNormalFromFloatsToRef(a,n,h,t,e)},o.prototype.startPositionFunction=function(t,e,i,r){var a=b.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),n=b.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),h=b.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);if(r){e.x=a,e.y=n,e.z=h;return}c.TransformCoordinatesFromFloatsToRef(a,n,h,t,e)},o.prototype.clone=function(){var t=new o;return _e.DeepCopy(this,t),t},o.prototype.applyToShader=function(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2),t.setVector3("minEmitBox",this.minEmitBox),t.setVector3("maxEmitBox",this.maxEmitBox)},o.prototype.buildUniformLayout=function(t){t.addUniform("direction1",3),t.addUniform("direction2",3),t.addUniform("minEmitBox",3),t.addUniform("maxEmitBox",3)},o.prototype.getEffectDefines=function(){return"#define BOXEMITTER"},o.prototype.getClassName=function(){return"BoxParticleEmitter"},o.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t.minEmitBox=this.minEmitBox.asArray(),t.maxEmitBox=this.maxEmitBox.asArray(),t},o.prototype.parse=function(t){c.FromArrayToRef(t.direction1,0,this.direction1),c.FromArrayToRef(t.direction2,0,this.direction2),c.FromArrayToRef(t.minEmitBox,0,this.minEmitBox),c.FromArrayToRef(t.maxEmitBox,0,this.maxEmitBox)},o}(),Nt=function(){function o(t,e,i){t===void 0&&(t=1),e===void 0&&(e=Math.PI),i===void 0&&(i=0),this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=e,this.radius=t}return Object.defineProperty(o.prototype,"radius",{get:function(){return this._radius},set:function(t){this._radius=t,this._buildHeight()},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"angle",{get:function(){return this._angle},set:function(t){this._angle=t,this._buildHeight()},enumerable:!1,configurable:!0}),o.prototype._buildHeight=function(){this._angle!==0?this._height=this._radius/Math.tan(this._angle/2):this._height=1},o.prototype.startDirectionFunction=function(t,e,i,r){r?O.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(t.getTranslation(),O.Vector3[0]).normalize();var a=b.RandomRange(0,this.directionRandomizer),n=b.RandomRange(0,this.directionRandomizer),h=b.RandomRange(0,this.directionRandomizer);e.x=O.Vector3[0].x+a,e.y=O.Vector3[0].y+n,e.z=O.Vector3[0].z+h,e.normalize()},o.prototype.startPositionFunction=function(t,e,i,r){var a=b.RandomRange(0,Math.PI*2),n;this.emitFromSpawnPointOnly?n=1e-4:(n=b.RandomRange(0,this.heightRange),n=1-n*n);var h=this._radius-b.RandomRange(0,this._radius*this.radiusRange);h=h*n;var s=h*Math.sin(a),u=h*Math.cos(a),f=n*this._height;if(r){e.x=s,e.y=f,e.z=u;return}c.TransformCoordinatesFromFloatsToRef(s,f,u,t,e)},o.prototype.clone=function(){var t=new o(this._radius,this._angle,this.directionRandomizer);return _e.DeepCopy(this,t),t},o.prototype.applyToShader=function(t){t.setFloat2("radius",this._radius,this.radiusRange),t.setFloat("coneAngle",this._angle),t.setFloat2("height",this._height,this.heightRange),t.setFloat("directionRandomizer",this.directionRandomizer)},o.prototype.buildUniformLayout=function(t){t.addUniform("radius",2),t.addUniform("coneAngle",1),t.addUniform("height",2),t.addUniform("directionRandomizer",1)},o.prototype.getEffectDefines=function(){var t="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(t+=`
#define CONEEMITTERSPAWNPOINT`),t},o.prototype.getClassName=function(){return"ConeParticleEmitter"},o.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this._radius,t.angle=this._angle,t.directionRandomizer=this.directionRandomizer,t.radiusRange=this.radiusRange,t.heightRange=this.heightRange,t.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,t},o.prototype.parse=function(t){this.radius=t.radius,this.angle=t.angle,this.directionRandomizer=t.directionRandomizer,this.radiusRange=t.radiusRange!==void 0?t.radiusRange:1,this.heightRange=t.radiusRange!==void 0?t.heightRange:1,this.emitFromSpawnPointOnly=t.emitFromSpawnPointOnly!==void 0?t.emitFromSpawnPointOnly:!1},o}(),Ct=function(){function o(t,e,i,r){t===void 0&&(t=1),e===void 0&&(e=1),i===void 0&&(i=1),r===void 0&&(r=0),this.radius=t,this.height=e,this.radiusRange=i,this.directionRandomizer=r,this._tempVector=c.Zero()}return o.prototype.startDirectionFunction=function(t,e,i,r,a){i.position.subtractToRef(t.getTranslation(),this._tempVector),this._tempVector.normalize(),c.TransformNormalToRef(this._tempVector,a,this._tempVector);var n=b.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2),h=Math.atan2(this._tempVector.x,this._tempVector.z);if(h+=b.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=n,this._tempVector.x=Math.sin(h),this._tempVector.z=Math.cos(h),this._tempVector.normalize(),r){e.copyFrom(this._tempVector);return}c.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,t,e)},o.prototype.startPositionFunction=function(t,e,i,r){var a=b.RandomRange(-this.height/2,this.height/2),n=b.RandomRange(0,2*Math.PI),h=b.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),s=Math.sqrt(h)*this.radius,u=s*Math.cos(n),f=s*Math.sin(n);if(r){e.copyFromFloats(u,a,f);return}c.TransformCoordinatesFromFloatsToRef(u,a,f,t,e)},o.prototype.clone=function(){var t=new o(this.radius,this.directionRandomizer);return _e.DeepCopy(this,t),t},o.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("height",this.height),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)},o.prototype.buildUniformLayout=function(t){t.addUniform("radius",1),t.addUniform("height",1),t.addUniform("radiusRange",1),t.addUniform("directionRandomizer",1)},o.prototype.getEffectDefines=function(){return"#define CYLINDEREMITTER"},o.prototype.getClassName=function(){return"CylinderParticleEmitter"},o.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this.radius,t.height=this.height,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t},o.prototype.parse=function(t){this.radius=t.radius,this.height=t.height,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer},o}(),Mt=function(o){lt(t,o);function t(e,i,r,a,n){e===void 0&&(e=1),i===void 0&&(i=1),r===void 0&&(r=1),a===void 0&&(a=new c(0,1,0)),n===void 0&&(n=new c(0,1,0));var h=o.call(this,e,i,r)||this;return h.direction1=a,h.direction2=n,h}return t.prototype.startDirectionFunction=function(e,i){var r=b.RandomRange(this.direction1.x,this.direction2.x),a=b.RandomRange(this.direction1.y,this.direction2.y),n=b.RandomRange(this.direction1.z,this.direction2.z);c.TransformNormalFromFloatsToRef(r,a,n,e,i)},t.prototype.clone=function(){var e=new t(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return _e.DeepCopy(this,e),e},t.prototype.applyToShader=function(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)},t.prototype.buildUniformLayout=function(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)},t.prototype.getEffectDefines=function(){return`#define CYLINDEREMITTER
#define DIRECTEDCYLINDEREMITTER`},t.prototype.getClassName=function(){return"CylinderDirectedParticleEmitter"},t.prototype.serialize=function(){var e=o.prototype.serialize.call(this);return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e},t.prototype.parse=function(e){o.prototype.parse.call(this,e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)},t}(Ct),Ut=function(){function o(t,e,i){t===void 0&&(t=1),e===void 0&&(e=1),i===void 0&&(i=0),this.radius=t,this.radiusRange=e,this.directionRandomizer=i}return o.prototype.startDirectionFunction=function(t,e,i,r){var a=i.position.subtract(t.getTranslation()).normalize(),n=b.RandomRange(0,this.directionRandomizer),h=b.RandomRange(0,this.directionRandomizer),s=b.RandomRange(0,this.directionRandomizer);if(a.x+=n,a.y+=h,a.z+=s,a.normalize(),r){e.copyFrom(a);return}c.TransformNormalFromFloatsToRef(a.x,a.y,a.z,t,e)},o.prototype.startPositionFunction=function(t,e,i,r){var a=this.radius-b.RandomRange(0,this.radius*this.radiusRange),n=b.RandomRange(0,1),h=b.RandomRange(0,2*Math.PI),s=Math.acos(2*n-1),u=a*Math.cos(h)*Math.sin(s),f=a*Math.cos(s),l=a*Math.sin(h)*Math.sin(s);if(r){e.copyFromFloats(u,Math.abs(f),l);return}c.TransformCoordinatesFromFloatsToRef(u,Math.abs(f),l,t,e)},o.prototype.clone=function(){var t=new o(this.radius,this.directionRandomizer);return _e.DeepCopy(this,t),t},o.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)},o.prototype.buildUniformLayout=function(t){t.addUniform("radius",1),t.addUniform("radiusRange",1),t.addUniform("directionRandomizer",1)},o.prototype.getEffectDefines=function(){return"#define HEMISPHERICEMITTER"},o.prototype.getClassName=function(){return"HemisphericParticleEmitter"},o.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this.radius,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t},o.prototype.parse=function(t){this.radius=t.radius,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer},o}(),Wt=function(){function o(){this.direction1=new c(0,1,0),this.direction2=new c(0,1,0)}return o.prototype.startDirectionFunction=function(t,e,i,r){var a=b.RandomRange(this.direction1.x,this.direction2.x),n=b.RandomRange(this.direction1.y,this.direction2.y),h=b.RandomRange(this.direction1.z,this.direction2.z);if(r){e.copyFromFloats(a,n,h);return}c.TransformNormalFromFloatsToRef(a,n,h,t,e)},o.prototype.startPositionFunction=function(t,e,i,r){if(r){e.copyFromFloats(0,0,0);return}c.TransformCoordinatesFromFloatsToRef(0,0,0,t,e)},o.prototype.clone=function(){var t=new o;return _e.DeepCopy(this,t),t},o.prototype.applyToShader=function(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)},o.prototype.buildUniformLayout=function(t){t.addUniform("direction1",3),t.addUniform("direction2",3)},o.prototype.getEffectDefines=function(){return"#define POINTEMITTER"},o.prototype.getClassName=function(){return"PointParticleEmitter"},o.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t},o.prototype.parse=function(t){c.FromArrayToRef(t.direction1,0,this.direction1),c.FromArrayToRef(t.direction2,0,this.direction2)},o}(),Gt=function(){function o(t,e,i){t===void 0&&(t=1),e===void 0&&(e=1),i===void 0&&(i=0),this.radius=t,this.radiusRange=e,this.directionRandomizer=i}return o.prototype.startDirectionFunction=function(t,e,i,r){var a=i.position.subtract(t.getTranslation()).normalize(),n=b.RandomRange(0,this.directionRandomizer),h=b.RandomRange(0,this.directionRandomizer),s=b.RandomRange(0,this.directionRandomizer);if(a.x+=n,a.y+=h,a.z+=s,a.normalize(),r){e.copyFrom(a);return}c.TransformNormalFromFloatsToRef(a.x,a.y,a.z,t,e)},o.prototype.startPositionFunction=function(t,e,i,r){var a=this.radius-b.RandomRange(0,this.radius*this.radiusRange),n=b.RandomRange(0,1),h=b.RandomRange(0,2*Math.PI),s=Math.acos(2*n-1),u=a*Math.cos(h)*Math.sin(s),f=a*Math.cos(s),l=a*Math.sin(h)*Math.sin(s);if(r){e.copyFromFloats(u,f,l);return}c.TransformCoordinatesFromFloatsToRef(u,f,l,t,e)},o.prototype.clone=function(){var t=new o(this.radius,this.directionRandomizer);return _e.DeepCopy(this,t),t},o.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)},o.prototype.buildUniformLayout=function(t){t.addUniform("radius",1),t.addUniform("radiusRange",1),t.addUniform("directionRandomizer",1)},o.prototype.getEffectDefines=function(){return"#define SPHEREEMITTER"},o.prototype.getClassName=function(){return"SphereParticleEmitter"},o.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this.radius,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t},o.prototype.parse=function(t){this.radius=t.radius,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer},o}(),kt=function(o){lt(t,o);function t(e,i,r){e===void 0&&(e=1),i===void 0&&(i=new c(0,1,0)),r===void 0&&(r=new c(0,1,0));var a=o.call(this,e)||this;return a.direction1=i,a.direction2=r,a}return t.prototype.startDirectionFunction=function(e,i){var r=b.RandomRange(this.direction1.x,this.direction2.x),a=b.RandomRange(this.direction1.y,this.direction2.y),n=b.RandomRange(this.direction1.z,this.direction2.z);c.TransformNormalFromFloatsToRef(r,a,n,e,i)},t.prototype.clone=function(){var e=new t(this.radius,this.direction1,this.direction2);return _e.DeepCopy(this,e),e},t.prototype.applyToShader=function(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)},t.prototype.buildUniformLayout=function(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)},t.prototype.getEffectDefines=function(){return`#define SPHEREEMITTER
#define DIRECTEDSPHEREEMITTER`},t.prototype.getClassName=function(){return"SphereDirectedParticleEmitter"},t.prototype.serialize=function(){var e=o.prototype.serialize.call(this);return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e},t.prototype.parse=function(e){o.prototype.parse.call(this,e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)},t}(Gt),nt=function(){function o(){this.particlePositionGenerator=function(){},this.particleDestinationGenerator=function(){}}return o.prototype.startDirectionFunction=function(t,e,i,r){var a=O.Vector3[0];if(this.particleDestinationGenerator){this.particleDestinationGenerator(-1,i,a);var n=O.Vector3[1];a.subtractToRef(i.position,n),n.scaleToRef(1/i.lifeTime,a)}else a.set(0,0,0);if(r){e.copyFrom(a);return}c.TransformNormalToRef(a,t,e)},o.prototype.startPositionFunction=function(t,e,i,r){var a=O.Vector3[0];if(this.particlePositionGenerator?this.particlePositionGenerator(-1,i,a):a.set(0,0,0),r){e.copyFrom(a);return}c.TransformCoordinatesToRef(a,t,e)},o.prototype.clone=function(){var t=new o;return _e.DeepCopy(this,t),t},o.prototype.applyToShader=function(t){},o.prototype.buildUniformLayout=function(t){},o.prototype.getEffectDefines=function(){return"#define CUSTOMEMITTER"},o.prototype.getClassName=function(){return"CustomParticleEmitter"},o.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t},o.prototype.parse=function(t){},o}(),vi=function(){function o(t){t===void 0&&(t=null),this._indices=null,this._positions=null,this._normals=null,this._storedNormal=c.Zero(),this._mesh=null,this.direction1=new c(0,1,0),this.direction2=new c(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=t}return Object.defineProperty(o.prototype,"mesh",{get:function(){return this._mesh},set:function(t){this._mesh!==t&&(this._mesh=t,t?(this._indices=t.getIndices(),this._positions=t.getVerticesData(z.PositionKind),this._normals=t.getVerticesData(z.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))},enumerable:!1,configurable:!0}),o.prototype.startDirectionFunction=function(t,e,i,r){if(this.useMeshNormalsForDirection&&this._normals){c.TransformNormalToRef(this._storedNormal,t,e);return}var a=b.RandomRange(this.direction1.x,this.direction2.x),n=b.RandomRange(this.direction1.y,this.direction2.y),h=b.RandomRange(this.direction1.z,this.direction2.z);if(r){e.copyFromFloats(a,n,h);return}c.TransformNormalFromFloatsToRef(a,n,h,t,e)},o.prototype.startPositionFunction=function(t,e,i,r){if(!(!this._indices||!this._positions)){var a=3*Math.random()*(this._indices.length/3)|0,n=Math.random(),h=Math.random()*(1-n),s=1-n-h,u=this._indices[a],f=this._indices[a+1],l=this._indices[a+2],p=O.Vector3[0],_=O.Vector3[1],v=O.Vector3[2],m=O.Vector3[3];c.FromArrayToRef(this._positions,u*3,p),c.FromArrayToRef(this._positions,f*3,_),c.FromArrayToRef(this._positions,l*3,v),m.x=n*p.x+h*_.x+s*v.x,m.y=n*p.y+h*_.y+s*v.y,m.z=n*p.z+h*_.z+s*v.z,r?e.copyFromFloats(m.x,m.y,m.z):c.TransformCoordinatesFromFloatsToRef(m.x,m.y,m.z,t,e),this.useMeshNormalsForDirection&&this._normals&&(c.FromArrayToRef(this._normals,u*3,p),c.FromArrayToRef(this._normals,f*3,_),c.FromArrayToRef(this._normals,l*3,v),this._storedNormal.x=n*p.x+h*_.x+s*v.x,this._storedNormal.y=n*p.y+h*_.y+s*v.y,this._storedNormal.z=n*p.z+h*_.z+s*v.z)}},o.prototype.clone=function(){var t=new o(this.mesh);return _e.DeepCopy(this,t),t},o.prototype.applyToShader=function(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)},o.prototype.buildUniformLayout=function(t){t.addUniform("direction1",3),t.addUniform("direction2",3)},o.prototype.getEffectDefines=function(){return""},o.prototype.getClassName=function(){return"MeshParticleEmitter"},o.prototype.serialize=function(){var t,e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.meshId=(t=this.mesh)===null||t===void 0?void 0:t.id,e.useMeshNormalsForDirection=this.useMeshNormalsForDirection,e},o.prototype.parse=function(t,e){c.FromArrayToRef(t.direction1,0,this.direction1),c.FromArrayToRef(t.direction2,0,this.direction2),t.meshId&&e&&(this.mesh=e.getLastMeshById(t.meshId)),this.useMeshNormalsForDirection=t.useMeshNormalsForDirection},o}(),Yt=function(){function o(t){this.animations=[],this.renderingGroupId=0,this.emitter=c.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this._rootUrl="",this.noiseStrength=new c(10,10,10),this.onAnimationEnd=null,this.blendMode=o.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new Te(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new c(0,0,0),this.gravity=c.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new H(1,1,1,1),this.color2=new H(1,1,1,1),this.colorDead=new H(0,0,0,1),this.textureMask=new H(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new ii,this.id=t,this.name=t}return Object.defineProperty(o.prototype,"noiseTexture",{get:function(){return this._noiseTexture},set:function(t){this._noiseTexture!==t&&(this._noiseTexture=t,this._reset())},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"isAnimationSheetEnabled",{get:function(){return this._isAnimationSheetEnabled},set:function(t){this._isAnimationSheetEnabled!=t&&(this._isAnimationSheetEnabled=t,this._reset())},enumerable:!1,configurable:!0}),o.prototype.getScene=function(){return this._scene},o.prototype._hasTargetStopDurationDependantGradient=function(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0},o.prototype.getDragGradients=function(){return this._dragGradients},o.prototype.getLimitVelocityGradients=function(){return this._limitVelocityGradients},o.prototype.getColorGradients=function(){return this._colorGradients},o.prototype.getSizeGradients=function(){return this._sizeGradients},o.prototype.getColorRemapGradients=function(){return this._colorRemapGradients},o.prototype.getAlphaRemapGradients=function(){return this._alphaRemapGradients},o.prototype.getLifeTimeGradients=function(){return this._lifeTimeGradients},o.prototype.getAngularSpeedGradients=function(){return this._angularSpeedGradients},o.prototype.getVelocityGradients=function(){return this._velocityGradients},o.prototype.getStartSizeGradients=function(){return this._startSizeGradients},o.prototype.getEmitRateGradients=function(){return this._emitRateGradients},Object.defineProperty(o.prototype,"direction1",{get:function(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:c.Zero()},set:function(t){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=t)},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"direction2",{get:function(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:c.Zero()},set:function(t){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=t)},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"minEmitBox",{get:function(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:c.Zero()},set:function(t){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=t)},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"maxEmitBox",{get:function(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:c.Zero()},set:function(t){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=t)},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"billboardMode",{get:function(){return this._billboardMode},set:function(t){this._billboardMode!==t&&(this._billboardMode=t,this._reset())},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"isBillboardBased",{get:function(){return this._isBillboardBased},set:function(t){this._isBillboardBased!==t&&(this._isBillboardBased=t,this._reset())},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(t){this._attachImageProcessingConfiguration(t)},enumerable:!1,configurable:!0}),o.prototype._attachImageProcessingConfiguration=function(t){t!==this._imageProcessingConfiguration&&(!t&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=t)},o.prototype._reset=function(){},o.prototype._removeGradientAndTexture=function(t,e,i){if(!e)return this;for(var r=0,a=0,n=e;a<n.length;a++){var h=n[a];if(h.gradient===t){e.splice(r,1);break}r++}return i&&i.dispose(),this},o.prototype.createPointEmitter=function(t,e){var i=new Wt;return i.direction1=t,i.direction2=e,this.particleEmitterType=i,i},o.prototype.createHemisphericEmitter=function(t,e){t===void 0&&(t=1),e===void 0&&(e=1);var i=new Ut(t,e);return this.particleEmitterType=i,i},o.prototype.createSphereEmitter=function(t,e){t===void 0&&(t=1),e===void 0&&(e=1);var i=new Gt(t,e);return this.particleEmitterType=i,i},o.prototype.createDirectedSphereEmitter=function(t,e,i){t===void 0&&(t=1),e===void 0&&(e=new c(0,1,0)),i===void 0&&(i=new c(0,1,0));var r=new kt(t,e,i);return this.particleEmitterType=r,r},o.prototype.createCylinderEmitter=function(t,e,i,r){t===void 0&&(t=1),e===void 0&&(e=1),i===void 0&&(i=1),r===void 0&&(r=0);var a=new Ct(t,e,i,r);return this.particleEmitterType=a,a},o.prototype.createDirectedCylinderEmitter=function(t,e,i,r,a){t===void 0&&(t=1),e===void 0&&(e=1),i===void 0&&(i=1),r===void 0&&(r=new c(0,1,0)),a===void 0&&(a=new c(0,1,0));var n=new Mt(t,e,i,r,a);return this.particleEmitterType=n,n},o.prototype.createConeEmitter=function(t,e){t===void 0&&(t=1),e===void 0&&(e=Math.PI/4);var i=new Nt(t,e);return this.particleEmitterType=i,i},o.prototype.createBoxEmitter=function(t,e,i,r){var a=new rt;return this.particleEmitterType=a,this.direction1=t,this.direction2=e,this.minEmitBox=i,this.maxEmitBox=r,a},o.BLENDMODE_ONEONE=0,o.BLENDMODE_STANDARD=1,o.BLENDMODE_ADD=2,o.BLENDMODE_MULTIPLY=3,o.BLENDMODE_MULTIPLYADD=4,o}(),gi=function(){function o(t,e){this._renderVAO=[],this._updateVAO=[],this.alignDataInBuffer=!1,this._parent=t,this._engine=e,this._updateEffectOptions={attributes:["position","initialPosition","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]}}return o.prototype.isUpdateBufferCreated=function(){return!!this._updateEffect},o.prototype.isUpdateBufferReady=function(){var t,e;return(e=(t=this._updateEffect)===null||t===void 0?void 0:t.isReady())!==null&&e!==void 0?e:!1},o.prototype.createUpdateBuffer=function(t){return this._updateEffectOptions.transformFeedbackVaryings=["outPosition"],this._updateEffectOptions.transformFeedbackVaryings.push("outAge"),this._updateEffectOptions.transformFeedbackVaryings.push("outSize"),this._updateEffectOptions.transformFeedbackVaryings.push("outLife"),this._updateEffectOptions.transformFeedbackVaryings.push("outSeed"),this._updateEffectOptions.transformFeedbackVaryings.push("outDirection"),this._parent.particleEmitterType instanceof nt&&this._updateEffectOptions.transformFeedbackVaryings.push("outInitialPosition"),this._parent._colorGradientsTexture||this._updateEffectOptions.transformFeedbackVaryings.push("outColor"),this._parent._isBillboardBased||this._updateEffectOptions.transformFeedbackVaryings.push("outInitialDirection"),this._parent.noiseTexture&&(this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates1"),this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates2")),this._updateEffectOptions.transformFeedbackVaryings.push("outAngle"),this._parent.isAnimationSheetEnabled&&(this._updateEffectOptions.transformFeedbackVaryings.push("outCellIndex"),this._parent.spriteRandomStartCell&&this._updateEffectOptions.transformFeedbackVaryings.push("outCellStartOffset")),this._updateEffectOptions.defines=t,this._updateEffect=new ri("gpuUpdateParticles",this._updateEffectOptions,this._engine),new zt(this._updateEffect)},o.prototype.createVertexBuffers=function(t,e){this._updateVAO.push(this._createUpdateVAO(t)),this._renderVAO.push(this._engine.recordVertexArrayObject(e,null,this._parent._getWrapper(this._parent.blendMode).effect)),this._engine.bindArrayBuffer(null)},o.prototype.createParticleBuffer=function(t){return t},o.prototype.bindDrawBuffers=function(t){this._engine.bindVertexArrayObject(this._renderVAO[t],null)},o.prototype.preUpdateParticleBuffer=function(){var t=this._engine;if(this._engine.enableEffect(this._updateEffect),!t.setState)throw new Error("GPU particles cannot work without a full Engine. ThinEngine is not supported")},o.prototype.updateParticleBuffer=function(t,e,i){this._updateEffect.setTexture("randomSampler",this._parent._randomTexture),this._updateEffect.setTexture("randomSampler2",this._parent._randomTexture2),this._parent._sizeGradientsTexture&&this._updateEffect.setTexture("sizeGradientSampler",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateEffect.setTexture("angularSpeedGradientSampler",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateEffect.setTexture("velocityGradientSampler",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateEffect.setTexture("limitVelocityGradientSampler",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateEffect.setTexture("dragGradientSampler",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateEffect.setTexture("noiseSampler",this._parent.noiseTexture),this._engine.bindVertexArrayObject(this._updateVAO[t],null);var r=this._engine;r.bindTransformFeedbackBuffer(e.getBuffer()),r.setRasterizerState(!1),r.beginTransformFeedback(!0),r.drawArraysType(3,0,i),r.endTransformFeedback(),r.setRasterizerState(!0),r.bindTransformFeedbackBuffer(null)},o.prototype.releaseBuffers=function(){},o.prototype.releaseVertexBuffers=function(){for(var t=0;t<this._updateVAO.length;t++)this._engine.releaseVertexArrayObject(this._updateVAO[t]);this._updateVAO.length=0;for(var t=0;t<this._renderVAO.length;t++)this._engine.releaseVertexArrayObject(this._renderVAO[t]);this._renderVAO.length=0},o.prototype._createUpdateVAO=function(t){var e={};e.position=t.createVertexBuffer("position",0,3);var i=3;e.age=t.createVertexBuffer("age",i,1),i+=1,e.size=t.createVertexBuffer("size",i,3),i+=3,e.life=t.createVertexBuffer("life",i,1),i+=1,e.seed=t.createVertexBuffer("seed",i,4),i+=4,e.direction=t.createVertexBuffer("direction",i,3),i+=3,this._parent.particleEmitterType instanceof nt&&(e.initialPosition=t.createVertexBuffer("initialPosition",i,3),i+=3),this._parent._colorGradientsTexture||(e.color=t.createVertexBuffer("color",i,4),i+=4),this._parent._isBillboardBased||(e.initialDirection=t.createVertexBuffer("initialDirection",i,3),i+=3),this._parent.noiseTexture&&(e.noiseCoordinates1=t.createVertexBuffer("noiseCoordinates1",i,3),i+=3,e.noiseCoordinates2=t.createVertexBuffer("noiseCoordinates2",i,3),i+=3),this._parent._angularSpeedGradientsTexture?(e.angle=t.createVertexBuffer("angle",i,1),i+=1):(e.angle=t.createVertexBuffer("angle",i,2),i+=2),this._parent._isAnimationSheetEnabled&&(e.cellIndex=t.createVertexBuffer("cellIndex",i,1),i+=1,this._parent.spriteRandomStartCell&&(e.cellStartOffset=t.createVertexBuffer("cellStartOffset",i,1),i+=1));var r=this._engine.recordVertexArrayObject(e,null,this._updateEffect);return this._engine.bindArrayBuffer(null),r},o}();Ft("BABYLON.WebGL2ParticleSystem",gi);var yi=function(){function o(t,e){this._bufferComputeShader=[],this._renderVertexBuffers=[],this.alignDataInBuffer=!0,this._parent=t,this._engine=e}return o.prototype.isUpdateBufferCreated=function(){return!!this._updateComputeShader},o.prototype.isUpdateBufferReady=function(){var t,e;return(e=(t=this._updateComputeShader)===null||t===void 0?void 0:t.isReady())!==null&&e!==void 0?e:!1},o.prototype.createUpdateBuffer=function(t){var e,i={params:{group:0,binding:0},particlesIn:{group:0,binding:1},particlesOut:{group:0,binding:2},randomTexture:{group:0,binding:3},randomTexture2:{group:0,binding:4}};return this._parent._sizeGradientsTexture&&(i.sizeGradientTexture={group:1,binding:1}),this._parent._angularSpeedGradientsTexture&&(i.angularSpeedGradientTexture={group:1,binding:3}),this._parent._velocityGradientsTexture&&(i.velocityGradientTexture={group:1,binding:5}),this._parent._limitVelocityGradientsTexture&&(i.limitVelocityGradientTexture={group:1,binding:7}),this._parent._dragGradientsTexture&&(i.dragGradientTexture={group:1,binding:9}),this._parent.noiseTexture&&(i.noiseTexture={group:1,binding:11}),this._updateComputeShader=new fi("updateParticles",this._engine,"gpuUpdateParticles",{bindingsMapping:i,defines:t.split(`
`)}),(e=this._simParamsComputeShader)===null||e===void 0||e.dispose(),this._simParamsComputeShader=new ni(this._engine),this._simParamsComputeShader.addUniform("currentCount",1),this._simParamsComputeShader.addUniform("timeDelta",1),this._simParamsComputeShader.addUniform("stopFactor",1),this._simParamsComputeShader.addUniform("randomTextureSize",1),this._simParamsComputeShader.addUniform("lifeTime",2),this._simParamsComputeShader.addUniform("emitPower",2),this._parent._colorGradientsTexture||(this._simParamsComputeShader.addUniform("color1",4),this._simParamsComputeShader.addUniform("color2",4)),this._simParamsComputeShader.addUniform("sizeRange",2),this._simParamsComputeShader.addUniform("scaleRange",4),this._simParamsComputeShader.addUniform("angleRange",4),this._simParamsComputeShader.addUniform("gravity",3),this._parent._limitVelocityGradientsTexture&&this._simParamsComputeShader.addUniform("limitVelocityDamping",1),this._parent.isAnimationSheetEnabled&&this._simParamsComputeShader.addUniform("cellInfos",4),this._parent.noiseTexture&&this._simParamsComputeShader.addUniform("noiseStrength",3),this._parent.isLocal||this._simParamsComputeShader.addUniform("emitterWM",16),this._parent.particleEmitterType&&this._parent.particleEmitterType.buildUniformLayout(this._simParamsComputeShader),this._updateComputeShader.setUniformBuffer("params",this._simParamsComputeShader),new zt(this._simParamsComputeShader)},o.prototype.createVertexBuffers=function(t,e){this._renderVertexBuffers.push(e)},o.prototype.createParticleBuffer=function(t){var e=new ui(this._engine,t.length*4,11);return e.update(t),this._bufferComputeShader.push(e),e.getBuffer()},o.prototype.bindDrawBuffers=function(t,e){this._engine.bindBuffers(this._renderVertexBuffers[t],null,e)},o.prototype.preUpdateParticleBuffer=function(){},o.prototype.updateParticleBuffer=function(t,e,i){this._simParamsComputeShader.update(),this._updateComputeShader.setTexture("randomTexture",this._parent._randomTexture,!1),this._updateComputeShader.setTexture("randomTexture2",this._parent._randomTexture2,!1),this._parent._sizeGradientsTexture&&this._updateComputeShader.setTexture("sizeGradientTexture",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateComputeShader.setTexture("angularSpeedGradientTexture",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateComputeShader.setTexture("velocityGradientTexture",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateComputeShader.setTexture("limitVelocityGradientTexture",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateComputeShader.setTexture("dragGradientTexture",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateComputeShader.setTexture("noiseTexture",this._parent.noiseTexture),this._updateComputeShader.setStorageBuffer("particlesIn",this._bufferComputeShader[t]),this._updateComputeShader.setStorageBuffer("particlesOut",this._bufferComputeShader[t^1]),this._updateComputeShader.dispatch(Math.ceil(i/64))},o.prototype.releaseBuffers=function(){for(var t,e=0;e<this._bufferComputeShader.length;++e)this._bufferComputeShader[e].dispose();this._bufferComputeShader.length=0,(t=this._simParamsComputeShader)===null||t===void 0||t.dispose(),this._simParamsComputeShader=null,this._updateComputeShader=null},o.prototype.releaseVertexBuffers=function(){this._renderVertexBuffers.length=0},o}();Ft("BABYLON.ComputeShaderParticleSystem",yi);var xi=function(){function o(t){this.particleSystem=t,this.position=c.Zero(),this.direction=c.Zero(),this.color=new H(0,0,0,0),this.colorStep=new H(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new Te(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new H(0,0,0,0),this._currentColor2=new H(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=o._Count++,this.particleSystem.isAnimationSheetEnabled&&this._updateCellInfoFromSystem()}return o.prototype._updateCellInfoFromSystem=function(){this.cellIndex=this.particleSystem.startSpriteCellID},o.prototype.updateCellIndex=function(){var t=this.age,e=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(this._randomCellOffset===void 0&&(this._randomCellOffset=Math.random()*this.lifeTime),e===0?(e=1,t=this._randomCellOffset):t+=this._randomCellOffset);var i=this._initialEndSpriteCellID-this._initialStartSpriteCellID,r;this._initialSpriteCellLoop?r=b.Clamp(t*e%this.lifeTime/this.lifeTime):r=b.Clamp(t*e/this.lifeTime),this.cellIndex=this._initialStartSpriteCellID+r*i|0},o.prototype._inheritParticleInfoToSubEmitter=function(t){if(t.particleSystem.emitter.position){var e=t.particleSystem.emitter;if(e.position.copyFrom(this.position),t.inheritDirection){var i=O.Vector3[0];this.direction.normalizeToRef(i),e.setDirection(i,0,Math.PI/2)}}else{var r=t.particleSystem.emitter;r.copyFrom(this.position)}this.direction.scaleToRef(t.inheritedVelocityAmount/2,O.Vector3[0]),t.particleSystem._inheritedVelocityOffset.copyFrom(O.Vector3[0])},o.prototype._inheritParticleInfoToSubEmitters=function(){var t=this;this._attachedSubEmitters&&this._attachedSubEmitters.length>0&&this._attachedSubEmitters.forEach(function(e){t._inheritParticleInfoToSubEmitter(e)})},o.prototype._reset=function(){this.age=0,this.id=o._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0},o.prototype.copyTo=function(t){t.position.copyFrom(this.position),this._initialDirection?t._initialDirection?t._initialDirection.copyFrom(this._initialDirection):t._initialDirection=this._initialDirection.clone():t._initialDirection=null,t.direction.copyFrom(this.direction),this._localPosition&&(t._localPosition?t._localPosition.copyFrom(this._localPosition):t._localPosition=this._localPosition.clone()),t.color.copyFrom(this.color),t.colorStep.copyFrom(this.colorStep),t.lifeTime=this.lifeTime,t.age=this.age,t._randomCellOffset=this._randomCellOffset,t.size=this.size,t.scale.copyFrom(this.scale),t.angle=this.angle,t.angularSpeed=this.angularSpeed,t.particleSystem=this.particleSystem,t.cellIndex=this.cellIndex,t.id=this.id,t._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(t._currentColorGradient=this._currentColorGradient,t._currentColor1.copyFrom(this._currentColor1),t._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(t._currentSizeGradient=this._currentSizeGradient,t._currentSize1=this._currentSize1,t._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(t._currentAngularSpeedGradient=this._currentAngularSpeedGradient,t._currentAngularSpeed1=this._currentAngularSpeed1,t._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(t._currentVelocityGradient=this._currentVelocityGradient,t._currentVelocity1=this._currentVelocity1,t._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(t._currentLimitVelocityGradient=this._currentLimitVelocityGradient,t._currentLimitVelocity1=this._currentLimitVelocity1,t._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(t._currentDragGradient=this._currentDragGradient,t._currentDrag1=this._currentDrag1,t._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(t._initialStartSpriteCellID=this._initialStartSpriteCellID,t._initialEndSpriteCellID=this._initialEndSpriteCellID,t._initialSpriteCellLoop=this._initialSpriteCellLoop),this.particleSystem.useRampGradients&&(t.remapData&&this.remapData?t.remapData.copyFrom(this.remapData):t.remapData=new Se(0,0,0,0)),this._randomNoiseCoordinates1&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),t._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(t._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),t._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))},o._Count=0,o}(),st;(function(o){o[o.ATTACHED=0]="ATTACHED",o[o.END=1]="END"})(st||(st={}));var ut=function(){function o(t){if(this.particleSystem=t,this.type=st.END,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!t.emitter||!t.emitter.dispose){var e=Ce("BABYLON.AbstractMesh");t.emitter=new e("SubemitterSystemEmitter",t.getScene()),t._disposeEmitterOnDispose=!0}}return o.prototype.clone=function(){var t=this.particleSystem.emitter;if(!t)t=new c;else if(t instanceof c)t=t.clone();else if(t.getClassName().indexOf("Mesh")!==-1){var e=Ce("BABYLON.Mesh");t=new e("",t.getScene()),t.isVisible=!1}var i=new o(this.particleSystem.clone(this.particleSystem.name,t));return i.particleSystem.name+="Clone",i.type=this.type,i.inheritDirection=this.inheritDirection,i.inheritedVelocityAmount=this.inheritedVelocityAmount,i.particleSystem._disposeEmitterOnDispose=!0,i.particleSystem.disposeOnStop=!0,i},o.prototype.serialize=function(t){t===void 0&&(t=!1);var e={};return e.type=this.type,e.inheritDirection=this.inheritDirection,e.inheritedVelocityAmount=this.inheritedVelocityAmount,e.particleSystem=this.particleSystem.serialize(t),e},o._ParseParticleSystem=function(t,e,i,r){throw Jt("ParseParticle")},o.Parse=function(t,e,i){var r=t.particleSystem,a=new o(o._ParseParticleSystem(r,e,i,!0));return a.type=t.type,a.inheritDirection=t.inheritDirection,a.inheritedVelocityAmount=t.inheritedVelocityAmount,a.particleSystem._isSubEmitter=!0,a},o.prototype.dispose=function(){this.particleSystem.dispose()},o}(),$=function(o){lt(t,o);function t(e,i,r,a,n,h){a===void 0&&(a=null),n===void 0&&(n=!1),h===void 0&&(h=.01);var s=o.call(this,e)||this;s._emitterInverseWorldMatrix=Ge.Identity(),s._inheritedVelocityOffset=new c,s.onDisposeObservable=new Xe,s.onStoppedObservable=new Xe,s._particles=new Array,s._stockParticles=new Array,s._newPartsExcess=0,s._vertexBuffers={},s._scaledColorStep=new H(0,0,0,0),s._colorDiff=new H(0,0,0,0),s._scaledDirection=c.Zero(),s._scaledGravity=c.Zero(),s._currentRenderId=-1,s._useInstancing=!1,s._started=!1,s._stopped=!1,s._actualFrame=0,s._currentEmitRate1=0,s._currentEmitRate2=0,s._currentStartSize1=0,s._currentStartSize2=0,s._rawTextureWidth=256,s._useRampGradients=!1,s._disposeEmitterOnDispose=!1,s.isLocal=!1,s._onBeforeDrawParticlesObservable=null,s.recycleParticle=function(f){var l=s._particles.pop();l!==f&&l.copyTo(f),s._stockParticles.push(l)},s._createParticle=function(){var f;if(s._stockParticles.length!==0?(f=s._stockParticles.pop(),f._reset()):f=new xi(s),s._subEmitters&&s._subEmitters.length>0){var l=s._subEmitters[Math.floor(Math.random()*s._subEmitters.length)];f._attachedSubEmitters=[],l.forEach(function(p){if(p.type===st.ATTACHED){var _=p.clone();f._attachedSubEmitters.push(_),_.particleSystem.start()}})}return f},s._emitFromParticle=function(f){if(!(!s._subEmitters||s._subEmitters.length===0)){var l=Math.floor(Math.random()*s._subEmitters.length);s._subEmitters[l].forEach(function(p){if(p.type===st.END){var _=p.clone();f._inheritParticleInfoToSubEmitter(_),_.particleSystem._rootParticleSystem=s,s.activeSubSystems.push(_.particleSystem),_.particleSystem.start()}})}},s._capacity=i,s._epsilon=h,s._isAnimationSheetEnabled=n,!r||r.getClassName()==="Scene"?(s._scene=r||We.LastCreatedScene,s._engine=s._scene.getEngine(),s.uniqueId=s._scene.getUniqueId(),s._scene.particleSystems.push(s)):(s._engine=r,s.defaultProjectionMatrix=Ge.PerspectiveFovLH(.8,1,.1,100,s._engine.isNDCHalfZRange)),s._engine.getCaps().vertexArrayObject&&(s._vertexArrayObject=null),s._attachImageProcessingConfiguration(null),s._customWrappers={0:new Ue(s._engine)},s._customWrappers[0].effect=a,s._drawWrappers=[],s._useInstancing=s._engine.getCaps().instancedArrays,s._createIndexBuffer(),s._createVertexBuffers(),s.particleEmitterType=new rt;var u=null;return s.updateFunction=function(f){var l,p=null;s.noiseTexture&&(p=s.noiseTexture.getSize(),(l=s.noiseTexture.getContent())===null||l===void 0||l.then(function(x){u=x}));for(var _=function(x){var d=f[x],T=s._scaledUpdateSpeed,B=d.age;if(d.age+=T,d.age>d.lifeTime){var w=d.age-B,C=d.lifeTime-B;T=C*T/w,d.age=d.lifeTime}var P=d.age/d.lifeTime;s._colorGradients&&s._colorGradients.length>0?fe.GetCurrentGradient(P,s._colorGradients,function(E,F,S){E!==d._currentColorGradient&&(d._currentColor1.copyFrom(d._currentColor2),F.getColorToRef(d._currentColor2),d._currentColorGradient=E),H.LerpToRef(d._currentColor1,d._currentColor2,S,d.color)}):(d.colorStep.scaleToRef(T,s._scaledColorStep),d.color.addInPlace(s._scaledColorStep),d.color.a<0&&(d.color.a=0)),s._angularSpeedGradients&&s._angularSpeedGradients.length>0&&fe.GetCurrentGradient(P,s._angularSpeedGradients,function(E,F,S){E!==d._currentAngularSpeedGradient&&(d._currentAngularSpeed1=d._currentAngularSpeed2,d._currentAngularSpeed2=F.getFactor(),d._currentAngularSpeedGradient=E),d.angularSpeed=b.Lerp(d._currentAngularSpeed1,d._currentAngularSpeed2,S)}),d.angle+=d.angularSpeed*T;var V=T;if(s._velocityGradients&&s._velocityGradients.length>0&&fe.GetCurrentGradient(P,s._velocityGradients,function(E,F,S){E!==d._currentVelocityGradient&&(d._currentVelocity1=d._currentVelocity2,d._currentVelocity2=F.getFactor(),d._currentVelocityGradient=E),V*=b.Lerp(d._currentVelocity1,d._currentVelocity2,S)}),d.direction.scaleToRef(V,s._scaledDirection),s._limitVelocityGradients&&s._limitVelocityGradients.length>0&&fe.GetCurrentGradient(P,s._limitVelocityGradients,function(E,F,S){E!==d._currentLimitVelocityGradient&&(d._currentLimitVelocity1=d._currentLimitVelocity2,d._currentLimitVelocity2=F.getFactor(),d._currentLimitVelocityGradient=E);var y=b.Lerp(d._currentLimitVelocity1,d._currentLimitVelocity2,S),G=d.direction.length();G>y&&d.direction.scaleInPlace(s.limitVelocityDamping)}),s._dragGradients&&s._dragGradients.length>0&&fe.GetCurrentGradient(P,s._dragGradients,function(E,F,S){E!==d._currentDragGradient&&(d._currentDrag1=d._currentDrag2,d._currentDrag2=F.getFactor(),d._currentDragGradient=E);var y=b.Lerp(d._currentDrag1,d._currentDrag2,S);s._scaledDirection.scaleInPlace(1-y)}),s.isLocal&&d._localPosition?(d._localPosition.addInPlace(s._scaledDirection),c.TransformCoordinatesToRef(d._localPosition,s._emitterWorldMatrix,d.position)):d.position.addInPlace(s._scaledDirection),u&&p&&d._randomNoiseCoordinates1){var N=s._fetchR(d._randomNoiseCoordinates1.x,d._randomNoiseCoordinates1.y,p.width,p.height,u),K=s._fetchR(d._randomNoiseCoordinates1.z,d._randomNoiseCoordinates2.x,p.width,p.height,u),M=s._fetchR(d._randomNoiseCoordinates2.y,d._randomNoiseCoordinates2.z,p.width,p.height,u),g=O.Vector3[0],I=O.Vector3[1];g.copyFromFloats((2*N-1)*s.noiseStrength.x,(2*K-1)*s.noiseStrength.y,(2*M-1)*s.noiseStrength.z),g.scaleToRef(T,I),d.direction.addInPlace(I)}if(s.gravity.scaleToRef(T,s._scaledGravity),d.direction.addInPlace(s._scaledGravity),s._sizeGradients&&s._sizeGradients.length>0&&fe.GetCurrentGradient(P,s._sizeGradients,function(E,F,S){E!==d._currentSizeGradient&&(d._currentSize1=d._currentSize2,d._currentSize2=F.getFactor(),d._currentSizeGradient=E),d.size=b.Lerp(d._currentSize1,d._currentSize2,S)}),s._useRampGradients&&(s._colorRemapGradients&&s._colorRemapGradients.length>0&&fe.GetCurrentGradient(P,s._colorRemapGradients,function(E,F,S){var y=b.Lerp(E.factor1,F.factor1,S),G=b.Lerp(E.factor2,F.factor2,S);d.remapData.x=y,d.remapData.y=G-y}),s._alphaRemapGradients&&s._alphaRemapGradients.length>0&&fe.GetCurrentGradient(P,s._alphaRemapGradients,function(E,F,S){var y=b.Lerp(E.factor1,F.factor1,S),G=b.Lerp(E.factor2,F.factor2,S);d.remapData.z=y,d.remapData.w=G-y})),s._isAnimationSheetEnabled&&d.updateCellIndex(),d._inheritParticleInfoToSubEmitters(),d.age>=d.lifeTime)return s._emitFromParticle(d),d._attachedSubEmitters&&(d._attachedSubEmitters.forEach(function(E){E.particleSystem.disposeOnStop=!0,E.particleSystem.stop()}),d._attachedSubEmitters=null),s.recycleParticle(d),x--,v=x,"continue";v=x},v,m=0;m<f.length;m++)_(m),m=v},s}return Object.defineProperty(t.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"useRampGradients",{get:function(){return this._useRampGradients},set:function(e){this._useRampGradients!==e&&(this._useRampGradients=e,this._resetEffect())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"particles",{get:function(){return this._particles},enumerable:!1,configurable:!0}),t.prototype.getActiveCount=function(){return this._particles.length},t.prototype.getClassName=function(){return"ParticleSystem"},t.prototype.isStopping=function(){return this._stopped&&this.isAlive()},t.prototype.getCustomEffect=function(e){var i,r;return e===void 0&&(e=0),(r=(i=this._customWrappers[e])===null||i===void 0?void 0:i.effect)!==null&&r!==void 0?r:this._customWrappers[0].effect},t.prototype._getCustomDrawWrapper=function(e){var i;return e===void 0&&(e=0),(i=this._customWrappers[e])!==null&&i!==void 0?i:this._customWrappers[0]},t.prototype.setCustomEffect=function(e,i){i===void 0&&(i=0),this._customWrappers[i]=new Ue(this._engine),this._customWrappers[i].effect=e,this._customWrappers[i].drawContext&&(this._customWrappers[i].drawContext.useInstancing=this._useInstancing)},Object.defineProperty(t.prototype,"onBeforeDrawParticlesObservable",{get:function(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new Xe),this._onBeforeDrawParticlesObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vertexShaderName",{get:function(){return"particles"},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vertexBuffers",{get:function(){return this._vertexBuffers},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"indexBuffer",{get:function(){return this._indexBuffer},enumerable:!1,configurable:!0}),t.prototype._addFactorGradient=function(e,i,r,a){var n=new wt(i,r,a);e.push(n),e.sort(function(h,s){return h.gradient<s.gradient?-1:h.gradient>s.gradient?1:0})},t.prototype._removeFactorGradient=function(e,i){if(!!e)for(var r=0,a=0,n=e;a<n.length;a++){var h=n[a];if(h.gradient===i){e.splice(r,1);break}r++}},t.prototype.addLifeTimeGradient=function(e,i,r){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,e,i,r),this},t.prototype.removeLifeTimeGradient=function(e){return this._removeFactorGradient(this._lifeTimeGradients,e),this},t.prototype.addSizeGradient=function(e,i,r){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,i,r),this},t.prototype.removeSizeGradient=function(e){return this._removeFactorGradient(this._sizeGradients,e),this},t.prototype.addColorRemapGradient=function(e,i,r){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,e,i,r),this},t.prototype.removeColorRemapGradient=function(e){return this._removeFactorGradient(this._colorRemapGradients,e),this},t.prototype.addAlphaRemapGradient=function(e,i,r){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,e,i,r),this},t.prototype.removeAlphaRemapGradient=function(e){return this._removeFactorGradient(this._alphaRemapGradients,e),this},t.prototype.addAngularSpeedGradient=function(e,i,r){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,i,r),this},t.prototype.removeAngularSpeedGradient=function(e){return this._removeFactorGradient(this._angularSpeedGradients,e),this},t.prototype.addVelocityGradient=function(e,i,r){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,i,r),this},t.prototype.removeVelocityGradient=function(e){return this._removeFactorGradient(this._velocityGradients,e),this},t.prototype.addLimitVelocityGradient=function(e,i,r){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,i,r),this},t.prototype.removeLimitVelocityGradient=function(e){return this._removeFactorGradient(this._limitVelocityGradients,e),this},t.prototype.addDragGradient=function(e,i,r){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,i,r),this},t.prototype.removeDragGradient=function(e){return this._removeFactorGradient(this._dragGradients,e),this},t.prototype.addEmitRateGradient=function(e,i,r){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,e,i,r),this},t.prototype.removeEmitRateGradient=function(e){return this._removeFactorGradient(this._emitRateGradients,e),this},t.prototype.addStartSizeGradient=function(e,i,r){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,e,i,r),this},t.prototype.removeStartSizeGradient=function(e){return this._removeFactorGradient(this._startSizeGradients,e),this},t.prototype._createRampGradientTexture=function(){if(!(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)){for(var e=new Uint8Array(this._rawTextureWidth*4),i=Lt.Color3[0],r=function(h){var s=h/a._rawTextureWidth;fe.GetCurrentGradient(s,a._rampGradients,function(u,f,l){Me.LerpToRef(u.color,f.color,l,i),e[h*4]=i.r*255,e[h*4+1]=i.g*255,e[h*4+2]=i.b*255,e[h*4+3]=255})},a=this,n=0;n<this._rawTextureWidth;n++)r(n);this._rampGradientsTexture=tt.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1)}},t.prototype.getRampGradients=function(){return this._rampGradients},t.prototype.forceRefreshGradients=function(){this._syncRampGradientTexture()},t.prototype._syncRampGradientTexture=function(){!this._rampGradients||(this._rampGradients.sort(function(e,i){return e.gradient<i.gradient?-1:e.gradient>i.gradient?1:0}),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())},t.prototype.addRampGradient=function(e,i){this._rampGradients||(this._rampGradients=[]);var r=new ei(e,i);return this._rampGradients.push(r),this._syncRampGradientTexture(),this},t.prototype.removeRampGradient=function(e){return this._removeGradientAndTexture(e,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this},t.prototype.addColorGradient=function(e,i,r){this._colorGradients||(this._colorGradients=[]);var a=new Vt(e,i,r);return this._colorGradients.push(a),this._colorGradients.sort(function(n,h){return n.gradient<h.gradient?-1:n.gradient>h.gradient?1:0}),this},t.prototype.removeColorGradient=function(e){if(!this._colorGradients)return this;for(var i=0,r=0,a=this._colorGradients;r<a.length;r++){var n=a[r];if(n.gradient===e){this._colorGradients.splice(i,1);break}i++}return this},t.prototype.resetDrawCache=function(){for(var e=0,i=this._drawWrappers;e<i.length;e++){var r=i[e];if(r)for(var a=0,n=r;a<n.length;a++){var h=n[a];h==null||h.dispose()}}this._drawWrappers=[]},t.prototype._fetchR=function(e,i,r,a,n){e=Math.abs(e)*.5+.5,i=Math.abs(i)*.5+.5;var h=e*r%r|0,s=i*a%a|0,u=(h+s*r)*4;return n[u]/255},t.prototype._reset=function(){this._resetEffect()},t.prototype._resetEffect=function(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()},t.prototype._createVertexBuffers=function(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),(!this._isBillboardBased||this.billboardMode===t.BILLBOARDMODE_STRETCHED)&&(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);var e=this._engine,i=this._vertexBufferSize*(this._useInstancing?1:4);this._vertexData=new Float32Array(this._capacity*i),this._vertexBuffer=new it(e,this._vertexData,!0,i);var r=0,a=this._vertexBuffer.createVertexBuffer(z.PositionKind,r,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[z.PositionKind]=a,r+=3;var n=this._vertexBuffer.createVertexBuffer(z.ColorKind,r,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[z.ColorKind]=n,r+=4;var h=this._vertexBuffer.createVertexBuffer("angle",r,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=h,r+=1;var s=this._vertexBuffer.createVertexBuffer("size",r,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=s,r+=2,this._isAnimationSheetEnabled){var u=this._vertexBuffer.createVertexBuffer("cellIndex",r,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=u,r+=1}if(!this._isBillboardBased||this.billboardMode===t.BILLBOARDMODE_STRETCHED){var f=this._vertexBuffer.createVertexBuffer("direction",r,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=f,r+=3}if(this._useRampGradients){var l=this._vertexBuffer.createVertexBuffer("remapData",r,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=l,r+=4}var p;if(this._useInstancing){var _=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new it(e,_,!1,2),p=this._spriteBuffer.createVertexBuffer("offset",0,2)}else p=this._vertexBuffer.createVertexBuffer("offset",r,2,this._vertexBufferSize,this._useInstancing),r+=2;this._vertexBuffers.offset=p,this.resetDrawCache()},t.prototype._createIndexBuffer=function(){if(!this._useInstancing){for(var e=[],i=0,r=0;r<this._capacity;r++)e.push(i),e.push(i+1),e.push(i+2),e.push(i),e.push(i+2),e.push(i+3),i+=4;this._indexBuffer=this._engine.createIndexBuffer(e)}},t.prototype.getCapacity=function(){return this._capacity},t.prototype.isAlive=function(){return this._alive},t.prototype.isStarted=function(){return this._started},t.prototype._prepareSubEmitterInternalArray=function(){var e=this;this._subEmitters=new Array,this.subEmitters&&this.subEmitters.forEach(function(i){i instanceof t?e._subEmitters.push([new ut(i)]):i instanceof ut?e._subEmitters.push([i]):i instanceof Array&&e._subEmitters.push(i)})},t.prototype.start=function(e){var i=this,r;if(e===void 0&&(e=this.startDelay),!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(function(){i.start(0)},e);return}if(this._prepareSubEmitterInternalArray(),this._started=!0,this._stopped=!1,this._actualFrame=0,this._subEmitters&&this._subEmitters.length!=0&&(this.activeSubSystems=new Array),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){((r=this.emitter)===null||r===void 0?void 0:r.getClassName().indexOf("Mesh"))!==-1&&this.emitter.computeWorldMatrix(!0);var a=this.noiseTexture;if(a&&a.onGeneratedObservable)a.onGeneratedObservable.addOnce(function(){setTimeout(function(){for(var h=0;h<i.preWarmCycles;h++)i.animate(!0),a.render()})});else for(var n=0;n<this.preWarmCycles;n++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)},t.prototype.stop=function(e){e===void 0&&(e=!0),!this._stopped&&(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,e&&this._stopSubEmitters())},t.prototype.reset=function(){this._stockParticles.length=0,this._particles.length=0},t.prototype._appendParticleVertex=function(e,i,r,a){var n=e*this._vertexBufferSize;if(this._vertexData[n++]=i.position.x+this.worldOffset.x,this._vertexData[n++]=i.position.y+this.worldOffset.y,this._vertexData[n++]=i.position.z+this.worldOffset.z,this._vertexData[n++]=i.color.r,this._vertexData[n++]=i.color.g,this._vertexData[n++]=i.color.b,this._vertexData[n++]=i.color.a,this._vertexData[n++]=i.angle,this._vertexData[n++]=i.scale.x*i.size,this._vertexData[n++]=i.scale.y*i.size,this._isAnimationSheetEnabled&&(this._vertexData[n++]=i.cellIndex),this._isBillboardBased)this.billboardMode===t.BILLBOARDMODE_STRETCHED&&(this._vertexData[n++]=i.direction.x,this._vertexData[n++]=i.direction.y,this._vertexData[n++]=i.direction.z);else if(i._initialDirection){var h=i._initialDirection;this.isLocal&&(c.TransformNormalToRef(h,this._emitterWorldMatrix,O.Vector3[0]),h=O.Vector3[0]),h.x===0&&h.z===0&&(h.x=.001),this._vertexData[n++]=h.x,this._vertexData[n++]=h.y,this._vertexData[n++]=h.z}else{var s=i.direction;this.isLocal&&(c.TransformNormalToRef(s,this._emitterWorldMatrix,O.Vector3[0]),s=O.Vector3[0]),s.x===0&&s.z===0&&(s.x=.001),this._vertexData[n++]=s.x,this._vertexData[n++]=s.y,this._vertexData[n++]=s.z}this._useRampGradients&&i.remapData&&(this._vertexData[n++]=i.remapData.x,this._vertexData[n++]=i.remapData.y,this._vertexData[n++]=i.remapData.z,this._vertexData[n++]=i.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(r===0?r=this._epsilon:r===1&&(r=1-this._epsilon),a===0?a=this._epsilon:a===1&&(a=1-this._epsilon)),this._vertexData[n++]=r,this._vertexData[n++]=a)},t.prototype._stopSubEmitters=function(){!this.activeSubSystems||(this.activeSubSystems.forEach(function(e){e.stop(!0)}),this.activeSubSystems=new Array)},t.prototype._removeFromRoot=function(){if(!!this._rootParticleSystem){var e=this._rootParticleSystem.activeSubSystems.indexOf(this);e!==-1&&this._rootParticleSystem.activeSubSystems.splice(e,1),this._rootParticleSystem=null}},t.prototype._update=function(e){var i=this;if(this._alive=this._particles.length>0,this.emitter.position){var r=this.emitter;this._emitterWorldMatrix=r.getWorldMatrix()}else{var a=this.emitter;this._emitterWorldMatrix=Ge.Translation(a.x,a.y,a.z)}this._emitterWorldMatrix.invertToRef(this._emitterInverseWorldMatrix),this.updateFunction(this._particles);for(var n,h=function(l){if(s._particles.length===s._capacity)return"break";if(n=s._createParticle(),s._particles.push(n),s.targetStopDuration&&s._lifeTimeGradients&&s._lifeTimeGradients.length>0){var p=b.Clamp(s._actualFrame/s.targetStopDuration);fe.GetCurrentGradient(p,s._lifeTimeGradients,function(x,d){var T=x,B=d,w=T.getFactor(),C=B.getFactor(),P=(p-T.gradient)/(B.gradient-T.gradient);n.lifeTime=b.Lerp(w,C,P)})}else n.lifeTime=b.RandomRange(s.minLifeTime,s.maxLifeTime);var _=b.RandomRange(s.minEmitPower,s.maxEmitPower);if(s.startPositionFunction?s.startPositionFunction(s._emitterWorldMatrix,n.position,n,s.isLocal):s.particleEmitterType.startPositionFunction(s._emitterWorldMatrix,n.position,n,s.isLocal),s.isLocal&&(n._localPosition?n._localPosition.copyFrom(n.position):n._localPosition=n.position.clone(),c.TransformCoordinatesToRef(n._localPosition,s._emitterWorldMatrix,n.position)),s.startDirectionFunction?s.startDirectionFunction(s._emitterWorldMatrix,n.direction,n,s.isLocal):s.particleEmitterType.startDirectionFunction(s._emitterWorldMatrix,n.direction,n,s.isLocal,s._emitterInverseWorldMatrix),_===0?n._initialDirection?n._initialDirection.copyFrom(n.direction):n._initialDirection=n.direction.clone():n._initialDirection=null,n.direction.scaleInPlace(_),!s._sizeGradients||s._sizeGradients.length===0?n.size=b.RandomRange(s.minSize,s.maxSize):(n._currentSizeGradient=s._sizeGradients[0],n._currentSize1=n._currentSizeGradient.getFactor(),n.size=n._currentSize1,s._sizeGradients.length>1?n._currentSize2=s._sizeGradients[1].getFactor():n._currentSize2=n._currentSize1),n.scale.copyFromFloats(b.RandomRange(s.minScaleX,s.maxScaleX),b.RandomRange(s.minScaleY,s.maxScaleY)),s._startSizeGradients&&s._startSizeGradients[0]&&s.targetStopDuration){var v=s._actualFrame/s.targetStopDuration;fe.GetCurrentGradient(v,s._startSizeGradients,function(x,d,T){x!==i._currentStartSizeGradient&&(i._currentStartSize1=i._currentStartSize2,i._currentStartSize2=d.getFactor(),i._currentStartSizeGradient=x);var B=b.Lerp(i._currentStartSize1,i._currentStartSize2,T);n.scale.scaleInPlace(B)})}if(!s._angularSpeedGradients||s._angularSpeedGradients.length===0?n.angularSpeed=b.RandomRange(s.minAngularSpeed,s.maxAngularSpeed):(n._currentAngularSpeedGradient=s._angularSpeedGradients[0],n.angularSpeed=n._currentAngularSpeedGradient.getFactor(),n._currentAngularSpeed1=n.angularSpeed,s._angularSpeedGradients.length>1?n._currentAngularSpeed2=s._angularSpeedGradients[1].getFactor():n._currentAngularSpeed2=n._currentAngularSpeed1),n.angle=b.RandomRange(s.minInitialRotation,s.maxInitialRotation),s._velocityGradients&&s._velocityGradients.length>0&&(n._currentVelocityGradient=s._velocityGradients[0],n._currentVelocity1=n._currentVelocityGradient.getFactor(),s._velocityGradients.length>1?n._currentVelocity2=s._velocityGradients[1].getFactor():n._currentVelocity2=n._currentVelocity1),s._limitVelocityGradients&&s._limitVelocityGradients.length>0&&(n._currentLimitVelocityGradient=s._limitVelocityGradients[0],n._currentLimitVelocity1=n._currentLimitVelocityGradient.getFactor(),s._limitVelocityGradients.length>1?n._currentLimitVelocity2=s._limitVelocityGradients[1].getFactor():n._currentLimitVelocity2=n._currentLimitVelocity1),s._dragGradients&&s._dragGradients.length>0&&(n._currentDragGradient=s._dragGradients[0],n._currentDrag1=n._currentDragGradient.getFactor(),s._dragGradients.length>1?n._currentDrag2=s._dragGradients[1].getFactor():n._currentDrag2=n._currentDrag1),!s._colorGradients||s._colorGradients.length===0){var m=b.RandomRange(0,1);H.LerpToRef(s.color1,s.color2,m,n.color),s.colorDead.subtractToRef(n.color,s._colorDiff),s._colorDiff.scaleToRef(1/n.lifeTime,n.colorStep)}else n._currentColorGradient=s._colorGradients[0],n._currentColorGradient.getColorToRef(n.color),n._currentColor1.copyFrom(n.color),s._colorGradients.length>1?s._colorGradients[1].getColorToRef(n._currentColor2):n._currentColor2.copyFrom(n.color);s._isAnimationSheetEnabled&&(n._initialStartSpriteCellID=s.startSpriteCellID,n._initialEndSpriteCellID=s.endSpriteCellID,n._initialSpriteCellLoop=s.spriteCellLoop),n.direction.addInPlace(s._inheritedVelocityOffset),s._useRampGradients&&(n.remapData=new Se(0,1,0,1)),s.noiseTexture&&(n._randomNoiseCoordinates1?(n._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),n._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(n._randomNoiseCoordinates1=new c(Math.random(),Math.random(),Math.random()),n._randomNoiseCoordinates2=new c(Math.random(),Math.random(),Math.random()))),n._inheritParticleInfoToSubEmitters()},s=this,u=0;u<e;u++){var f=h();if(f==="break")break}},t._GetAttributeNamesOrOptions=function(e,i,r){e===void 0&&(e=!1),i===void 0&&(i=!1),r===void 0&&(r=!1);var a=[z.PositionKind,z.ColorKind,"angle","offset","size"];return e&&a.push("cellIndex"),i||a.push("direction"),r&&a.push("remapData"),a},t._GetEffectCreationOptions=function(e){e===void 0&&(e=!1);var i=["invView","view","projection","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","textureMask","translationPivot","eyePosition"];return e&&i.push("particlesInfos"),i},t.prototype.fillDefines=function(e,i){if(this._scene&&(this._scene.clipPlane&&e.push("#define CLIPPLANE"),this._scene.clipPlane2&&e.push("#define CLIPPLANE2"),this._scene.clipPlane3&&e.push("#define CLIPPLANE3"),this._scene.clipPlane4&&e.push("#define CLIPPLANE4"),this._scene.clipPlane5&&e.push("#define CLIPPLANE5"),this._scene.clipPlane6&&e.push("#define CLIPPLANE6")),this._isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),i===t.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&e.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case t.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case t.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case t.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL");break}this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(this._imageProcessingConfigurationDefines.toString()))},t.prototype.fillUniformsAttributesAndSamplerNames=function(e,i,r){i.push.apply(i,t._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&this.billboardMode!==t.BILLBOARDMODE_STRETCHED,this._useRampGradients)),e.push.apply(e,t._GetEffectCreationOptions(this._isAnimationSheetEnabled)),r.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&(ft.PrepareUniforms(e,this._imageProcessingConfigurationDefines),ft.PrepareSamplers(r,this._imageProcessingConfigurationDefines))},t.prototype._getWrapper=function(e){var i=this._getCustomDrawWrapper(e);if(i!=null&&i.effect)return i;var r=[];this.fillDefines(r,e);var a=this._engine._features.supportRenderPasses?this._engine.currentRenderPassId:0,n=this._drawWrappers[a];n||(n=this._drawWrappers[a]=[]);var h=n[e];h||(h=new Ue(this._engine),h.drawContext&&(h.drawContext.useInstancing=this._useInstancing),n[e]=h);var s=r.join(`
`);if(h.defines!==s){var u=[],f=[],l=[];this.fillUniformsAttributesAndSamplerNames(f,u,l),h.setEffect(this._engine.createEffect("particles",u,f,l,s),s)}return h},t.prototype.animate=function(e){var i=this,r;if(e===void 0&&(e=!1),!!this._started){if(!e&&this._scene){if(!this.isReady()||this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}this._scaledUpdateSpeed=this.updateSpeed*(e?this.preWarmStepOffset:((r=this._scene)===null||r===void 0?void 0:r.getAnimationRatio())||1);var a;if(this.manualEmitCount>-1)a=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{var n=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){var h=this._actualFrame/this.targetStopDuration;fe.GetCurrentGradient(h,this._emitRateGradients,function(l,p,_){l!==i._currentEmitRateGradient&&(i._currentEmitRate1=i._currentEmitRate2,i._currentEmitRate2=p.getFactor(),i._currentEmitRateGradient=l),n=b.Lerp(i._currentEmitRate1,i._currentEmitRate2,_)})}a=n*this._scaledUpdateSpeed>>0,this._newPartsExcess+=n*this._scaledUpdateSpeed-a}if(this._newPartsExcess>1&&(a+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?a=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(a),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!e){for(var s=0,u=0;u<this._particles.length;u++){var f=this._particles[u];this._appendParticleVertices(s,f),s+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.updateDirectly(this._vertexData,0,this._particles.length)}this.manualEmitCount===0&&this.disposeOnStop&&this.stop()}},t.prototype._appendParticleVertices=function(e,i){this._appendParticleVertex(e++,i,0,0),this._useInstancing||(this._appendParticleVertex(e++,i,1,0),this._appendParticleVertex(e++,i,1,1),this._appendParticleVertex(e++,i,0,1))},t.prototype.rebuild=function(){var e,i;this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._createIndexBuffer(),(e=this._spriteBuffer)===null||e===void 0||e._rebuild(),(i=this._vertexBuffer)===null||i===void 0||i._rebuild();for(var r in this._vertexBuffers)this._vertexBuffers[r]._rebuild();this.resetDrawCache()},t.prototype.isReady=function(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==t.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(t.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(t.BLENDMODE_ADD).effect.isReady())return!1;return!0},t.prototype._render=function(e){var i,r,a=this._getWrapper(e),n=a.effect,h=this._engine;h.enableEffect(a);var s=(i=this.defaultViewMatrix)!==null&&i!==void 0?i:this._scene.getViewMatrix();if(n.setTexture("diffuseSampler",this.particleTexture),n.setMatrix("view",s),n.setMatrix("projection",(r=this.defaultProjectionMatrix)!==null&&r!==void 0?r:this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){var u=this.particleTexture.getBaseSize();n.setFloat3("particlesInfos",this.spriteCellWidth/u.width,this.spriteCellHeight/u.height,this.spriteCellWidth/u.width)}if(n.setVector2("translationPivot",this.translationPivot),n.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){var f=this._scene.activeCamera;n.setVector3("eyePosition",f.globalPosition)}this._rampGradientsTexture&&((!this._rampGradients||!this._rampGradients.length)&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),n.setTexture("rampSampler",this._rampGradientsTexture));var l=n.defines;switch(this._scene&&(this._scene.clipPlane||this._scene.clipPlane2||this._scene.clipPlane3||this._scene.clipPlane4||this._scene.clipPlane5||this._scene.clipPlane6)&&si.BindClipPlane(n,this._scene),l.indexOf("#define BILLBOARDMODE_ALL")>=0&&(s.invertToRef(O.Matrix[0]),n.setMatrix("invView",O.Matrix[0])),this._vertexArrayObject!==void 0?(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,n)),this._engine.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):h.bindBuffers(this._vertexBuffers,this._indexBuffer,n),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(n),e){case t.BLENDMODE_ADD:h.setAlphaMode(1);break;case t.BLENDMODE_ONEONE:h.setAlphaMode(6);break;case t.BLENDMODE_STANDARD:h.setAlphaMode(2);break;case t.BLENDMODE_MULTIPLY:h.setAlphaMode(4);break}return this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(n),this._useInstancing?h.drawArraysType(7,0,4,this._particles.length):h.drawElementsType(0,0,this._particles.length*6),this._particles.length},t.prototype.render=function(){if(!this.isReady()||!this._particles.length)return 0;var e=this._engine;e.setState&&(e.setState(!1),this.forceDepthWrite&&e.setDepthWrite(!0));var i=0;return this.blendMode===t.BLENDMODE_MULTIPLYADD?i=this._render(t.BLENDMODE_MULTIPLY)+this._render(t.BLENDMODE_ADD):i=this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),i},t.prototype.dispose=function(e){if(e===void 0&&(e=!0),this.resetDrawCache(),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._removeFromRoot(),this.subEmitters&&!this._subEmitters&&this._prepareSubEmitterInternalArray(),this._subEmitters&&this._subEmitters.length){for(var i=0;i<this._subEmitters.length;i++)for(var r=0,a=this._subEmitters[i];r<a.length;r++){var n=a[r];n.dispose()}this._subEmitters=[],this.subEmitters=[]}if(this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){var i=this._scene.particleSystems.indexOf(this);i>-1&&this._scene.particleSystems.splice(i,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.reset()},t.prototype.clone=function(e,i){var r=yt({},this._customWrappers),a=null,n=this._engine;if(n.createEffectForParticles&&this.customShader!=null){a=this.customShader;var h=a.shaderOptions.defines.length>0?a.shaderOptions.defines.join(`
`):"",s=n.createEffectForParticles(a.shaderPath.fragmentElement,a.shaderOptions.uniforms,a.shaderOptions.samplers,h);r[0]?r[0].effect=s:this.setCustomEffect(s,0)}var u=this.serialize(),f=t.Parse(u,this._scene||this._engine,this._rootUrl);return f.name=e,f.customShader=a,f._customWrappers=r,i===void 0&&(i=this.emitter),this.noiseTexture&&(f.noiseTexture=this.noiseTexture.clone()),f.emitter=i,this.preventAutoStart||f.start(),f},t.prototype.serialize=function(e){e===void 0&&(e=!1);var i={};if(t._Serialize(i,this,e),i.textureMask=this.textureMask.asArray(),i.customShader=this.customShader,i.preventAutoStart=this.preventAutoStart,this.subEmitters){i.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(var r=0,a=this._subEmitters;r<a.length;r++){for(var n=a[r],h=[],s=0,u=n;s<u.length;s++){var f=u[s];h.push(f.serialize(e))}i.subEmitters.push(h)}}return i},t._Serialize=function(e,i,r){if(e.name=i.name,e.id=i.id,e.capacity=i.getCapacity(),e.disposeOnStop=i.disposeOnStop,e.manualEmitCount=i.manualEmitCount,i.emitter.position){var a=i.emitter;e.emitterId=a.id}else{var n=i.emitter;e.emitter=n.asArray()}i.particleEmitterType&&(e.particleEmitterType=i.particleEmitterType.serialize()),i.particleTexture&&(r?e.texture=i.particleTexture.serialize():(e.textureName=i.particleTexture.name,e.invertY=!!i.particleTexture._invertY)),e.isLocal=i.isLocal,$t.AppendSerializedAnimations(i,e),e.beginAnimationOnStart=i.beginAnimationOnStart,e.beginAnimationFrom=i.beginAnimationFrom,e.beginAnimationTo=i.beginAnimationTo,e.beginAnimationLoop=i.beginAnimationLoop,e.startDelay=i.startDelay,e.renderingGroupId=i.renderingGroupId,e.isBillboardBased=i.isBillboardBased,e.billboardMode=i.billboardMode,e.minAngularSpeed=i.minAngularSpeed,e.maxAngularSpeed=i.maxAngularSpeed,e.minSize=i.minSize,e.maxSize=i.maxSize,e.minScaleX=i.minScaleX,e.maxScaleX=i.maxScaleX,e.minScaleY=i.minScaleY,e.maxScaleY=i.maxScaleY,e.minEmitPower=i.minEmitPower,e.maxEmitPower=i.maxEmitPower,e.minLifeTime=i.minLifeTime,e.maxLifeTime=i.maxLifeTime,e.emitRate=i.emitRate,e.gravity=i.gravity.asArray(),e.noiseStrength=i.noiseStrength.asArray(),e.color1=i.color1.asArray(),e.color2=i.color2.asArray(),e.colorDead=i.colorDead.asArray(),e.updateSpeed=i.updateSpeed,e.targetStopDuration=i.targetStopDuration,e.blendMode=i.blendMode,e.preWarmCycles=i.preWarmCycles,e.preWarmStepOffset=i.preWarmStepOffset,e.minInitialRotation=i.minInitialRotation,e.maxInitialRotation=i.maxInitialRotation,e.startSpriteCellID=i.startSpriteCellID,e.spriteCellLoop=i.spriteCellLoop,e.endSpriteCellID=i.endSpriteCellID,e.spriteCellChangeSpeed=i.spriteCellChangeSpeed,e.spriteCellWidth=i.spriteCellWidth,e.spriteCellHeight=i.spriteCellHeight,e.spriteRandomStartCell=i.spriteRandomStartCell,e.isAnimationSheetEnabled=i.isAnimationSheetEnabled;var h=i.getColorGradients();if(h){e.colorGradients=[];for(var s=0,u=h;s<u.length;s++){var f=u[s],l={gradient:f.gradient,color1:f.color1.asArray()};f.color2?l.color2=f.color2.asArray():l.color2=f.color1.asArray(),e.colorGradients.push(l)}}var p=i.getRampGradients();if(p){e.rampGradients=[];for(var _=0,v=p;_<v.length;_++){var m=v[_],l={gradient:m.gradient,color:m.color.asArray()};e.rampGradients.push(l)}e.useRampGradients=i.useRampGradients}var x=i.getColorRemapGradients();if(x){e.colorRemapGradients=[];for(var d=0,T=x;d<T.length;d++){var B=T[d],l={gradient:B.gradient,factor1:B.factor1};B.factor2!==void 0?l.factor2=B.factor2:l.factor2=B.factor1,e.colorRemapGradients.push(l)}}var w=i.getAlphaRemapGradients();if(w){e.alphaRemapGradients=[];for(var C=0,P=w;C<P.length;C++){var V=P[C],l={gradient:V.gradient,factor1:V.factor1};V.factor2!==void 0?l.factor2=V.factor2:l.factor2=V.factor1,e.alphaRemapGradients.push(l)}}var N=i.getSizeGradients();if(N){e.sizeGradients=[];for(var K=0,M=N;K<M.length;K++){var g=M[K],l={gradient:g.gradient,factor1:g.factor1};g.factor2!==void 0?l.factor2=g.factor2:l.factor2=g.factor1,e.sizeGradients.push(l)}}var I=i.getAngularSpeedGradients();if(I){e.angularSpeedGradients=[];for(var E=0,F=I;E<F.length;E++){var S=F[E],l={gradient:S.gradient,factor1:S.factor1};S.factor2!==void 0?l.factor2=S.factor2:l.factor2=S.factor1,e.angularSpeedGradients.push(l)}}var y=i.getVelocityGradients();if(y){e.velocityGradients=[];for(var G=0,X=y;G<X.length;G++){var k=X[G],l={gradient:k.gradient,factor1:k.factor1};k.factor2!==void 0?l.factor2=k.factor2:l.factor2=k.factor1,e.velocityGradients.push(l)}}var Y=i.getDragGradients();if(Y){e.dragGradients=[];for(var A=0,j=Y;A<j.length;A++){var J=j[A],l={gradient:J.gradient,factor1:J.factor1};J.factor2!==void 0?l.factor2=J.factor2:l.factor2=J.factor1,e.dragGradients.push(l)}}var D=i.getEmitRateGradients();if(D){e.emitRateGradients=[];for(var Z=0,oe=D;Z<oe.length;Z++){var Q=oe[Z],l={gradient:Q.gradient,factor1:Q.factor1};Q.factor2!==void 0?l.factor2=Q.factor2:l.factor2=Q.factor1,e.emitRateGradients.push(l)}}var q=i.getStartSizeGradients();if(q){e.startSizeGradients=[];for(var ie=0,ee=q;ie<ee.length;ie++){var re=ee[ie],l={gradient:re.gradient,factor1:re.factor1};re.factor2!==void 0?l.factor2=re.factor2:l.factor2=re.factor1,e.startSizeGradients.push(l)}}var le=i.getLifeTimeGradients();if(le){e.lifeTimeGradients=[];for(var R=0,ce=le;R<ce.length;R++){var U=ce[R],l={gradient:U.gradient,factor1:U.factor1};U.factor2!==void 0?l.factor2=U.factor2:l.factor2=U.factor1,e.lifeTimeGradients.push(l)}}var se=i.getLimitVelocityGradients();if(se){e.limitVelocityGradients=[];for(var ne=0,L=se;ne<L.length;ne++){var ue=L[ne],l={gradient:ue.gradient,factor1:ue.factor1};ue.factor2!==void 0?l.factor2=ue.factor2:l.factor2=ue.factor1,e.limitVelocityGradients.push(l)}e.limitVelocityDamping=i.limitVelocityDamping}i.noiseTexture&&(e.noiseTexture=i.noiseTexture.serialize())},t._Parse=function(e,i,r,a){var n,h,s,u;r instanceof gt?u=null:u=r;var f=Ce("BABYLON.Texture");if(f&&u&&(e.texture?i.particleTexture=f.Parse(e.texture,u,a):e.textureName&&(i.particleTexture=new f(a+e.textureName,u,!1,e.invertY!==void 0?e.invertY:!0),i.particleTexture.name=e.textureName)),!e.emitterId&&e.emitterId!==0&&e.emitter===void 0?i.emitter=c.Zero():e.emitterId&&u?i.emitter=u.getLastMeshById(e.emitterId):i.emitter=c.FromArray(e.emitter),i.isLocal=!!e.isLocal,e.renderingGroupId!==void 0&&(i.renderingGroupId=e.renderingGroupId),e.isBillboardBased!==void 0&&(i.isBillboardBased=e.isBillboardBased),e.billboardMode!==void 0&&(i.billboardMode=e.billboardMode),e.animations){for(var l=0;l<e.animations.length;l++){var p=e.animations[l],_=Ce("BABYLON.Animation");_&&i.animations.push(_.Parse(p))}i.beginAnimationOnStart=e.beginAnimationOnStart,i.beginAnimationFrom=e.beginAnimationFrom,i.beginAnimationTo=e.beginAnimationTo,i.beginAnimationLoop=e.beginAnimationLoop}if(e.autoAnimate&&u&&u.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),i.startDelay=e.startDelay|0,i.minAngularSpeed=e.minAngularSpeed,i.maxAngularSpeed=e.maxAngularSpeed,i.minSize=e.minSize,i.maxSize=e.maxSize,e.minScaleX&&(i.minScaleX=e.minScaleX,i.maxScaleX=e.maxScaleX,i.minScaleY=e.minScaleY,i.maxScaleY=e.maxScaleY),e.preWarmCycles!==void 0&&(i.preWarmCycles=e.preWarmCycles,i.preWarmStepOffset=e.preWarmStepOffset),e.minInitialRotation!==void 0&&(i.minInitialRotation=e.minInitialRotation,i.maxInitialRotation=e.maxInitialRotation),i.minLifeTime=e.minLifeTime,i.maxLifeTime=e.maxLifeTime,i.minEmitPower=e.minEmitPower,i.maxEmitPower=e.maxEmitPower,i.emitRate=e.emitRate,i.gravity=c.FromArray(e.gravity),e.noiseStrength&&(i.noiseStrength=c.FromArray(e.noiseStrength)),i.color1=H.FromArray(e.color1),i.color2=H.FromArray(e.color2),i.colorDead=H.FromArray(e.colorDead),i.updateSpeed=e.updateSpeed,i.targetStopDuration=e.targetStopDuration,i.blendMode=e.blendMode,e.colorGradients)for(var v=0,m=e.colorGradients;v<m.length;v++){var x=m[v];i.addColorGradient(x.gradient,H.FromArray(x.color1),x.color2?H.FromArray(x.color2):void 0)}if(e.rampGradients){for(var d=0,T=e.rampGradients;d<T.length;d++){var B=T[d];i.addRampGradient(B.gradient,Me.FromArray(B.color))}i.useRampGradients=e.useRampGradients}if(e.colorRemapGradients)for(var w=0,C=e.colorRemapGradients;w<C.length;w++){var P=C[w];i.addColorRemapGradient(P.gradient,P.factor1!==void 0?P.factor1:P.factor,P.factor2)}if(e.alphaRemapGradients)for(var V=0,N=e.alphaRemapGradients;V<N.length;V++){var K=N[V];i.addAlphaRemapGradient(K.gradient,K.factor1!==void 0?K.factor1:K.factor,K.factor2)}if(e.sizeGradients)for(var M=0,g=e.sizeGradients;M<g.length;M++){var I=g[M];i.addSizeGradient(I.gradient,I.factor1!==void 0?I.factor1:I.factor,I.factor2)}if(e.angularSpeedGradients)for(var E=0,F=e.angularSpeedGradients;E<F.length;E++){var S=F[E];i.addAngularSpeedGradient(S.gradient,S.factor1!==void 0?S.factor1:S.factor,S.factor2)}if(e.velocityGradients)for(var y=0,G=e.velocityGradients;y<G.length;y++){var X=G[y];i.addVelocityGradient(X.gradient,X.factor1!==void 0?X.factor1:X.factor,X.factor2)}if(e.dragGradients)for(var k=0,Y=e.dragGradients;k<Y.length;k++){var A=Y[k];i.addDragGradient(A.gradient,A.factor1!==void 0?A.factor1:A.factor,A.factor2)}if(e.emitRateGradients)for(var j=0,J=e.emitRateGradients;j<J.length;j++){var D=J[j];i.addEmitRateGradient(D.gradient,D.factor1!==void 0?D.factor1:D.factor,D.factor2)}if(e.startSizeGradients)for(var Z=0,oe=e.startSizeGradients;Z<oe.length;Z++){var Q=oe[Z];i.addStartSizeGradient(Q.gradient,Q.factor1!==void 0?Q.factor1:Q.factor,Q.factor2)}if(e.lifeTimeGradients)for(var q=0,ie=e.lifeTimeGradients;q<ie.length;q++){var ee=ie[q];i.addLifeTimeGradient(ee.gradient,ee.factor1!==void 0?ee.factor1:ee.factor,ee.factor2)}if(e.limitVelocityGradients){for(var re=0,le=e.limitVelocityGradients;re<le.length;re++){var R=le[re];i.addLimitVelocityGradient(R.gradient,R.factor1!==void 0?R.factor1:R.factor,R.factor2)}i.limitVelocityDamping=e.limitVelocityDamping}if(e.noiseTexture&&u){var ce=Ce("BABYLON.ProceduralTexture");i.noiseTexture=ce.Parse(e.noiseTexture,u,a)}var U;if(e.particleEmitterType){switch(e.particleEmitterType.type){case"SphereParticleEmitter":U=new Gt;break;case"SphereDirectedParticleEmitter":U=new kt;break;case"ConeEmitter":case"ConeParticleEmitter":U=new Nt;break;case"CylinderParticleEmitter":U=new Ct;break;case"CylinderDirectedParticleEmitter":U=new Mt;break;case"HemisphericParticleEmitter":U=new Ut;break;case"PointParticleEmitter":U=new Wt;break;case"MeshParticleEmitter":U=new vi;break;case"BoxEmitter":case"BoxParticleEmitter":default:U=new rt;break}U.parse(e.particleEmitterType,u)}else U=new rt,U.parse(e,u);i.particleEmitterType=U,i.startSpriteCellID=e.startSpriteCellID,i.endSpriteCellID=e.endSpriteCellID,i.spriteCellLoop=(n=e.spriteCellLoop)!==null&&n!==void 0?n:!0,i.spriteCellWidth=e.spriteCellWidth,i.spriteCellHeight=e.spriteCellHeight,i.spriteCellChangeSpeed=e.spriteCellChangeSpeed,i.spriteRandomStartCell=e.spriteRandomStartCell,i.disposeOnStop=(h=e.disposeOnStop)!==null&&h!==void 0?h:!1,i.manualEmitCount=(s=e.manualEmitCount)!==null&&s!==void 0?s:-1},t.Parse=function(e,i,r,a,n){a===void 0&&(a=!1);var h=e.name,s=null,u=null,f,l;if(i instanceof gt?f=i:(l=i,f=l.getEngine()),e.customShader&&f.createEffectForParticles){u=e.customShader;var p=u.shaderOptions.defines.length>0?u.shaderOptions.defines.join(`
`):"";s=f.createEffectForParticles(u.shaderPath.fragmentElement,u.shaderOptions.uniforms,u.shaderOptions.samplers,p)}var _=new t(h,n||e.capacity,i,s,e.isAnimationSheetEnabled);if(_.customShader=u,_._rootUrl=r,e.id&&(_.id=e.id),e.subEmitters){_.subEmitters=[];for(var v=0,m=e.subEmitters;v<m.length;v++){for(var x=m[v],d=[],T=0,B=x;T<B.length;T++){var w=B[T];d.push(ut.Parse(w,i,r))}_.subEmitters.push(d)}}return t._Parse(e,_,i,r),e.textureMask&&(_.textureMask=H.FromArray(e.textureMask)),e.preventAutoStart&&(_.preventAutoStart=e.preventAutoStart),!a&&!_.preventAutoStart&&_.start(),_},t.BILLBOARDMODE_Y=2,t.BILLBOARDMODE_ALL=7,t.BILLBOARDMODE_STRETCHED=8,t}(Yt);ut._ParseParticleSystem=$.Parse;var Zt=function(o){lt(t,o);function t(e,i,r,a,n){a===void 0&&(a=null),n===void 0&&(n=!1);var h=o.call(this,e)||this;if(h.layerMask=268435455,h._accumulatedCount=0,h._targetIndex=0,h._currentRenderId=-1,h._currentRenderingCameraUniqueId=-1,h._started=!1,h._stopped=!1,h._timeDelta=0,h._actualFrame=0,h._rawTextureWidth=256,h.onDisposeObservable=new Xe,h.onStoppedObservable=new Xe,h.forceDepthWrite=!1,h._preWarmDone=!1,h.isLocal=!1,h._onBeforeDrawParticlesObservable=null,!r||r.getClassName()==="Scene"?(h._scene=r||We.LastCreatedScene,h._engine=h._scene.getEngine(),h.uniqueId=h._scene.getUniqueId(),h._scene.particleSystems.push(h)):(h._engine=r,h.defaultProjectionMatrix=Ge.PerspectiveFovLH(.8,1,.1,100,h._engine.isNDCHalfZRange)),h._engine.getCaps().supportComputeShaders){if(!Ce("BABYLON.ComputeShaderParticleSystem"))throw new Error("The ComputeShaderParticleSystem class is not available! Make sure you have imported it.");h._platform=new(Ce("BABYLON.ComputeShaderParticleSystem"))(h,h._engine)}else{if(!Ce("BABYLON.WebGL2ParticleSystem"))throw new Error("The WebGL2ParticleSystem class is not available! Make sure you have imported it.");h._platform=new(Ce("BABYLON.WebGL2ParticleSystem"))(h,h._engine)}h._customWrappers={0:new Ue(h._engine)},h._customWrappers[0].effect=a,h._drawWrappers={0:new Ue(h._engine)},h._drawWrappers[0].drawContext&&(h._drawWrappers[0].drawContext.useInstancing=!0),h._attachImageProcessingConfiguration(null),i=i!=null?i:{},i.randomTextureSize||delete i.randomTextureSize;var s=yt({capacity:5e4,randomTextureSize:h._engine.getCaps().maxTextureSize},i),u=i;isFinite(u)&&(s.capacity=u),h._capacity=s.capacity,h._activeCount=s.capacity,h._currentActiveCount=0,h._isAnimationSheetEnabled=n,h.particleEmitterType=new rt;for(var f=Math.min(h._engine.getCaps().maxTextureSize,s.randomTextureSize),l=[],p=0;p<f;++p)l.push(Math.random()),l.push(Math.random()),l.push(Math.random()),l.push(Math.random());h._randomTexture=new tt(new Float32Array(l),f,1,5,r,!1,!1,1,1),h._randomTexture.name="GPUParticleSystem_random1",h._randomTexture.wrapU=1,h._randomTexture.wrapV=1,l=[];for(var p=0;p<f;++p)l.push(Math.random()),l.push(Math.random()),l.push(Math.random()),l.push(Math.random());return h._randomTexture2=new tt(new Float32Array(l),f,1,5,r,!1,!1,1,1),h._randomTexture2.name="GPUParticleSystem_random2",h._randomTexture2.wrapU=1,h._randomTexture2.wrapV=1,h._randomTextureSize=f,h}return Object.defineProperty(t,"IsSupported",{get:function(){if(!We.LastCreatedEngine)return!1;var e=We.LastCreatedEngine.getCaps();return e.supportTransformFeedbacks||e.supportComputeShaders},enumerable:!1,configurable:!0}),t.prototype.getCapacity=function(){return this._capacity},Object.defineProperty(t.prototype,"activeParticleCount",{get:function(){return this._activeCount},set:function(e){this._activeCount=Math.min(e,this._capacity)},enumerable:!1,configurable:!0}),t.prototype.isReady=function(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==$.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper($.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper($.BLENDMODE_ADD).effect.isReady())return!1;return this._platform.isUpdateBufferCreated()?this._platform.isUpdateBufferReady():(this._recreateUpdateEffect(),!1)},t.prototype.isStarted=function(){return this._started},t.prototype.isStopped=function(){return this._stopped},t.prototype.isStopping=function(){return!1},t.prototype.getActiveCount=function(){return this._currentActiveCount},t.prototype.start=function(e){var i=this;if(e===void 0&&(e=this.startDelay),!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(function(){i.start(0)},e);return}this._started=!0,this._stopped=!1,this._preWarmDone=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)},t.prototype.stop=function(){this._stopped||(this._stopped=!0)},t.prototype.reset=function(){this._releaseBuffers(),this._platform.releaseVertexBuffers(),this._currentActiveCount=0,this._targetIndex=0},t.prototype.getClassName=function(){return"GPUParticleSystem"},t.prototype.getCustomEffect=function(e){var i,r;return e===void 0&&(e=0),(r=(i=this._customWrappers[e])===null||i===void 0?void 0:i.effect)!==null&&r!==void 0?r:this._customWrappers[0].effect},t.prototype._getCustomDrawWrapper=function(e){var i;return e===void 0&&(e=0),(i=this._customWrappers[e])!==null&&i!==void 0?i:this._customWrappers[0]},t.prototype.setCustomEffect=function(e,i){i===void 0&&(i=0),this._customWrappers[i]=new Ue(this._engine),this._customWrappers[i].effect=e},Object.defineProperty(t.prototype,"onBeforeDrawParticlesObservable",{get:function(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new Xe),this._onBeforeDrawParticlesObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vertexShaderName",{get:function(){return"gpuRenderParticles"},enumerable:!1,configurable:!0}),t.prototype._removeGradientAndTexture=function(e,i,r){return o.prototype._removeGradientAndTexture.call(this,e,i,r),this._releaseBuffers(),this},t.prototype.addColorGradient=function(e,i){this._colorGradients||(this._colorGradients=[]);var r=new Vt(e,i);return this._colorGradients.push(r),this._refreshColorGradient(!0),this._releaseBuffers(),this},t.prototype._refreshColorGradient=function(e){e===void 0&&(e=!1),this._colorGradients&&(e&&this._colorGradients.sort(function(i,r){return i.gradient<r.gradient?-1:i.gradient>r.gradient?1:0}),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null))},t.prototype.forceRefreshGradients=function(){this._refreshColorGradient(),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture"),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture"),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture"),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture"),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture"),this.reset()},t.prototype.removeColorGradient=function(e){return this._removeGradientAndTexture(e,this._colorGradients,this._colorGradientsTexture),this._colorGradientsTexture=null,this},t.prototype.resetDrawCache=function(){var e;for(var i in this._drawWrappers){var r=this._drawWrappers[i];(e=r.drawContext)===null||e===void 0||e.reset()}},t.prototype._addFactorGradient=function(e,i,r){var a=new wt(i,r);e.push(a),this._releaseBuffers()},t.prototype.addSizeGradient=function(e,i){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,i),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture",!0),this._releaseBuffers(),this},t.prototype.removeSizeGradient=function(e){return this._removeGradientAndTexture(e,this._sizeGradients,this._sizeGradientsTexture),this._sizeGradientsTexture=null,this},t.prototype._refreshFactorGradient=function(e,i,r){if(r===void 0&&(r=!1),!!e){r&&e.sort(function(n,h){return n.gradient<h.gradient?-1:n.gradient>h.gradient?1:0});var a=this;a[i]&&(a[i].dispose(),a[i]=null)}},t.prototype.addAngularSpeedGradient=function(e,i){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,i),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture",!0),this._releaseBuffers(),this},t.prototype.removeAngularSpeedGradient=function(e){return this._removeGradientAndTexture(e,this._angularSpeedGradients,this._angularSpeedGradientsTexture),this._angularSpeedGradientsTexture=null,this},t.prototype.addVelocityGradient=function(e,i){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,i),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture",!0),this._releaseBuffers(),this},t.prototype.removeVelocityGradient=function(e){return this._removeGradientAndTexture(e,this._velocityGradients,this._velocityGradientsTexture),this._velocityGradientsTexture=null,this},t.prototype.addLimitVelocityGradient=function(e,i){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,i),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture",!0),this._releaseBuffers(),this},t.prototype.removeLimitVelocityGradient=function(e){return this._removeGradientAndTexture(e,this._limitVelocityGradients,this._limitVelocityGradientsTexture),this._limitVelocityGradientsTexture=null,this},t.prototype.addDragGradient=function(e,i){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,i),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture",!0),this._releaseBuffers(),this},t.prototype.removeDragGradient=function(e){return this._removeGradientAndTexture(e,this._dragGradients,this._dragGradientsTexture),this._dragGradientsTexture=null,this},t.prototype.addEmitRateGradient=function(){return this},t.prototype.removeEmitRateGradient=function(){return this},t.prototype.addStartSizeGradient=function(){return this},t.prototype.removeStartSizeGradient=function(){return this},t.prototype.addColorRemapGradient=function(){return this},t.prototype.removeColorRemapGradient=function(){return this},t.prototype.addAlphaRemapGradient=function(){return this},t.prototype.removeAlphaRemapGradient=function(){return this},t.prototype.addRampGradient=function(){return this},t.prototype.removeRampGradient=function(){return this},t.prototype.getRampGradients=function(){return null},Object.defineProperty(t.prototype,"useRampGradients",{get:function(){return!1},set:function(e){},enumerable:!1,configurable:!0}),t.prototype.addLifeTimeGradient=function(){return this},t.prototype.removeLifeTimeGradient=function(){return this},t.prototype._reset=function(){this._releaseBuffers()},t.prototype._createVertexBuffers=function(e,i,r){var a={};a.position=i.createVertexBuffer("position",0,3,this._attributesStrideSize,!0);var n=3;a.age=i.createVertexBuffer("age",n,1,this._attributesStrideSize,!0),n+=1,a.size=i.createVertexBuffer("size",n,3,this._attributesStrideSize,!0),n+=3,a.life=i.createVertexBuffer("life",n,1,this._attributesStrideSize,!0),n+=1,n+=4,this.billboardMode===$.BILLBOARDMODE_STRETCHED&&(a.direction=i.createVertexBuffer("direction",n,3,this._attributesStrideSize,!0)),n+=3,this._platform.alignDataInBuffer&&(n+=1),this.particleEmitterType instanceof nt&&(n+=3,this._platform.alignDataInBuffer&&(n+=1)),this._colorGradientsTexture||(a.color=i.createVertexBuffer("color",n,4,this._attributesStrideSize,!0),n+=4),this._isBillboardBased||(a.initialDirection=i.createVertexBuffer("initialDirection",n,3,this._attributesStrideSize,!0),n+=3,this._platform.alignDataInBuffer&&(n+=1)),this.noiseTexture&&(a.noiseCoordinates1=i.createVertexBuffer("noiseCoordinates1",n,3,this._attributesStrideSize,!0),n+=3,this._platform.alignDataInBuffer&&(n+=1),a.noiseCoordinates2=i.createVertexBuffer("noiseCoordinates2",n,3,this._attributesStrideSize,!0),n+=3,this._platform.alignDataInBuffer&&(n+=1)),a.angle=i.createVertexBuffer("angle",n,1,this._attributesStrideSize,!0),this._angularSpeedGradientsTexture?n++:n+=2,this._isAnimationSheetEnabled&&(a.cellIndex=i.createVertexBuffer("cellIndex",n,1,this._attributesStrideSize,!0),n+=1,this.spriteRandomStartCell&&(a.cellStartOffset=i.createVertexBuffer("cellStartOffset",n,1,this._attributesStrideSize,!0),n+=1)),a.offset=r.createVertexBuffer("offset",0,2),a.uv=r.createVertexBuffer("uv",2,2),this._platform.createVertexBuffers(e,a),this.resetDrawCache()},t.prototype._initialize=function(e){if(e===void 0&&(e=!1),!(this._buffer0&&!e)){var i=this._engine,r=new Array;this._attributesStrideSize=21,this._targetIndex=0,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1),this.particleEmitterType instanceof nt&&(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this.isBillboardBased||(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this._colorGradientsTexture&&(this._attributesStrideSize-=4),this._angularSpeedGradientsTexture&&(this._attributesStrideSize-=1),this._isAnimationSheetEnabled&&(this._attributesStrideSize+=1,this.spriteRandomStartCell&&(this._attributesStrideSize+=1)),this.noiseTexture&&(this._attributesStrideSize+=6,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=2)),this._platform.alignDataInBuffer&&(this._attributesStrideSize+=3-(this._attributesStrideSize+3&3));for(var a=this.particleEmitterType instanceof nt,n=O.Vector3[0],h=0,s=0;s<this._capacity;s++)if(r.push(0),r.push(0),r.push(0),r.push(0),r.push(0),r.push(0),r.push(0),r.push(0),r.push(Math.random()),r.push(Math.random()),r.push(Math.random()),r.push(Math.random()),a?(this.particleEmitterType.particleDestinationGenerator(s,null,n),r.push(n.x),r.push(n.y),r.push(n.z)):(r.push(0),r.push(0),r.push(0)),this._platform.alignDataInBuffer&&r.push(0),h+=16,a&&(this.particleEmitterType.particlePositionGenerator(s,null,n),r.push(n.x),r.push(n.y),r.push(n.z),this._platform.alignDataInBuffer&&r.push(0),h+=4),this._colorGradientsTexture||(r.push(0),r.push(0),r.push(0),r.push(0),h+=4),this.isBillboardBased||(r.push(0),r.push(0),r.push(0),this._platform.alignDataInBuffer&&r.push(0),h+=4),this.noiseTexture&&(r.push(Math.random()),r.push(Math.random()),r.push(Math.random()),this._platform.alignDataInBuffer&&r.push(0),r.push(Math.random()),r.push(Math.random()),r.push(Math.random()),this._platform.alignDataInBuffer&&r.push(0),h+=8),r.push(0),h+=1,this._angularSpeedGradientsTexture||(r.push(0),h+=1),this._isAnimationSheetEnabled&&(r.push(0),h+=1,this.spriteRandomStartCell&&(r.push(0),h+=1)),this._platform.alignDataInBuffer){var u=3-(h+3&3);for(h+=u;u-- >0;)r.push(0)}var f=new Float32Array([.5,.5,1,1,-.5,.5,0,1,.5,-.5,1,0,-.5,-.5,0,0]),l=this._platform.createParticleBuffer(r),p=this._platform.createParticleBuffer(r);this._buffer0=new it(i,l,!1,this._attributesStrideSize),this._buffer1=new it(i,p,!1,this._attributesStrideSize),this._spriteBuffer=new it(i,f,!1,4),this._createVertexBuffers(this._buffer0,this._buffer1,this._spriteBuffer),this._createVertexBuffers(this._buffer1,this._buffer0,this._spriteBuffer),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}},t.prototype._recreateUpdateEffect=function(){var e=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";this._isBillboardBased&&(e+=`
#define BILLBOARD`),this._colorGradientsTexture&&(e+=`
#define COLORGRADIENTS`),this._sizeGradientsTexture&&(e+=`
#define SIZEGRADIENTS`),this._angularSpeedGradientsTexture&&(e+=`
#define ANGULARSPEEDGRADIENTS`),this._velocityGradientsTexture&&(e+=`
#define VELOCITYGRADIENTS`),this._limitVelocityGradientsTexture&&(e+=`
#define LIMITVELOCITYGRADIENTS`),this._dragGradientsTexture&&(e+=`
#define DRAGGRADIENTS`),this.isAnimationSheetEnabled&&(e+=`
#define ANIMATESHEET`,this.spriteRandomStartCell&&(e+=`
#define ANIMATESHEETRANDOMSTART`)),this.noiseTexture&&(e+=`
#define NOISE`),this.isLocal&&(e+=`
#define LOCAL`),!(this._platform.isUpdateBufferCreated()&&this._cachedUpdateDefines===e)&&(this._cachedUpdateDefines=e,this._updateBuffer=this._platform.createUpdateBuffer(e))},t.prototype._getWrapper=function(e){var i=this._getCustomDrawWrapper(e);if(i!=null&&i.effect)return i;var r=[];this.fillDefines(r,e);var a=this._drawWrappers[e];a||(a=new Ue(this._engine),a.drawContext&&(a.drawContext.useInstancing=!0),this._drawWrappers[e]=a);var n=r.join(`
`);if(a.defines!==n){var h=[],s=[],u=[];this.fillUniformsAttributesAndSamplerNames(s,h,u),a.setEffect(this._engine.createEffect("gpuRenderParticles",h,s,u,n),n)}return a},t._GetAttributeNamesOrOptions=function(e,i,r,a){e===void 0&&(e=!1),i===void 0&&(i=!1),r===void 0&&(r=!1),a===void 0&&(a=!1);var n=[z.PositionKind,"age","life","size","angle"];return e||n.push(z.ColorKind),i&&n.push("cellIndex"),r||n.push("initialDirection"),a||n.push("direction"),n.push("offset",z.UVKind),n},t._GetEffectCreationOptions=function(e){e===void 0&&(e=!1);var i=["emitterWM","worldOffset","view","projection","colorDead","invView","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","translationPivot","eyePosition"];return e&&i.push("sheetInfos"),i},t.prototype.fillDefines=function(e,i){if(i===void 0&&(i=0),this._scene&&(this._scene.clipPlane&&e.push("#define CLIPPLANE"),this._scene.clipPlane2&&e.push("#define CLIPPLANE2"),this._scene.clipPlane3&&e.push("#define CLIPPLANE3"),this._scene.clipPlane4&&e.push("#define CLIPPLANE4"),this._scene.clipPlane5&&e.push("#define CLIPPLANE5"),this._scene.clipPlane6&&e.push("#define CLIPPLANE6")),i===$.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this.isLocal&&e.push("#define LOCAL"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case $.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case $.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case $.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL");break}this._colorGradientsTexture&&e.push("#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(""+this._imageProcessingConfigurationDefines.toString()))},t.prototype.fillUniformsAttributesAndSamplerNames=function(e,i,r){i.push.apply(i,t._GetAttributeNamesOrOptions(!!this._colorGradientsTexture,this._isAnimationSheetEnabled,this._isBillboardBased,this._isBillboardBased&&this.billboardMode===$.BILLBOARDMODE_STRETCHED)),e.push.apply(e,t._GetEffectCreationOptions(this._isAnimationSheetEnabled)),r.push("diffuseSampler","colorGradientSampler"),this._imageProcessingConfiguration&&(ft.PrepareUniforms(e,this._imageProcessingConfigurationDefines),ft.PrepareSamplers(r,this._imageProcessingConfigurationDefines))},t.prototype.animate=function(e){var i;e===void 0&&(e=!1),this._timeDelta=this.updateSpeed*(e?this.preWarmStepOffset:((i=this._scene)===null||i===void 0?void 0:i.getAnimationRatio())||1),this._actualFrame+=this._timeDelta,this._stopped||this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()},t.prototype._createFactorGradientTexture=function(e,i){var r=this[i];if(!(!e||!e.length||r)){for(var a=new Float32Array(this._rawTextureWidth),n=function(u){var f=u/h._rawTextureWidth;fe.GetCurrentGradient(f,e,function(l,p,_){a[u]=b.Lerp(l.factor1,p.factor1,_)})},h=this,s=0;s<this._rawTextureWidth;s++)n(s);this[i]=tt.CreateRTexture(a,this._rawTextureWidth,1,this._scene||this._engine,!1,!1,1)}},t.prototype._createSizeGradientTexture=function(){this._createFactorGradientTexture(this._sizeGradients,"_sizeGradientsTexture")},t.prototype._createAngularSpeedGradientTexture=function(){this._createFactorGradientTexture(this._angularSpeedGradients,"_angularSpeedGradientsTexture")},t.prototype._createVelocityGradientTexture=function(){this._createFactorGradientTexture(this._velocityGradients,"_velocityGradientsTexture")},t.prototype._createLimitVelocityGradientTexture=function(){this._createFactorGradientTexture(this._limitVelocityGradients,"_limitVelocityGradientsTexture")},t.prototype._createDragGradientTexture=function(){this._createFactorGradientTexture(this._dragGradients,"_dragGradientsTexture")},t.prototype._createColorGradientTexture=function(){if(!(!this._colorGradients||!this._colorGradients.length||this._colorGradientsTexture)){for(var e=new Uint8Array(this._rawTextureWidth*4),i=Lt.Color4[0],r=function(h){var s=h/a._rawTextureWidth;fe.GetCurrentGradient(s,a._colorGradients,function(u,f,l){H.LerpToRef(u.color1,f.color1,l,i),e[h*4]=i.r*255,e[h*4+1]=i.g*255,e[h*4+2]=i.b*255,e[h*4+3]=i.a*255})},a=this,n=0;n<this._rawTextureWidth;n++)r(n);this._colorGradientsTexture=tt.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1)}},t.prototype._render=function(e,i){var r,a,n=this._getWrapper(e),h=n.effect;this._engine.enableEffect(n);var s=((r=this._scene)===null||r===void 0?void 0:r.getViewMatrix())||Ge.IdentityReadOnly;if(h.setMatrix("view",s),h.setMatrix("projection",(a=this.defaultProjectionMatrix)!==null&&a!==void 0?a:this._scene.getProjectionMatrix()),h.setTexture("diffuseSampler",this.particleTexture),h.setVector2("translationPivot",this.translationPivot),h.setVector3("worldOffset",this.worldOffset),this.isLocal&&h.setMatrix("emitterWM",i),this._colorGradientsTexture?h.setTexture("colorGradientSampler",this._colorGradientsTexture):h.setDirectColor4("colorDead",this.colorDead),this._isAnimationSheetEnabled&&this.particleTexture){var u=this.particleTexture.getBaseSize();h.setFloat3("sheetInfos",this.spriteCellWidth/u.width,this.spriteCellHeight/u.height,u.width/this.spriteCellWidth)}if(this._isBillboardBased&&this._scene){var f=this._scene.activeCamera;h.setVector3("eyePosition",f.globalPosition)}var l=h.defines;if(this._scene&&(this._scene.clipPlane||this._scene.clipPlane2||this._scene.clipPlane3||this._scene.clipPlane4||this._scene.clipPlane5||this._scene.clipPlane6)&&ai.BindClipPlane(h,this._scene),l.indexOf("#define BILLBOARDMODE_ALL")>=0){var p=s.clone();p.invert(),h.setMatrix("invView",p)}switch(this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(h),e){case $.BLENDMODE_ADD:this._engine.setAlphaMode(1);break;case $.BLENDMODE_ONEONE:this._engine.setAlphaMode(6);break;case $.BLENDMODE_STANDARD:this._engine.setAlphaMode(2);break;case $.BLENDMODE_MULTIPLY:this._engine.setAlphaMode(4);break}return this._platform.bindDrawBuffers(this._targetIndex,h),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(h),this._engine.drawArraysType(7,0,4,this._currentActiveCount),this._engine.setAlphaMode(0),this._currentActiveCount},t.prototype.render=function(e,i){if(e===void 0&&(e=!1),i===void 0&&(i=!1),!this._started||(this._createColorGradientTexture(),this._createSizeGradientTexture(),this._createAngularSpeedGradientTexture(),this._createVelocityGradientTexture(),this._createLimitVelocityGradientTexture(),this._createDragGradientTexture(),this._recreateUpdateEffect(),!this.isReady()))return 0;if(!e&&this._scene){if(!this._preWarmDone&&this.preWarmCycles){for(var r=0;r<this.preWarmCycles;r++)this.animate(!0),this.render(!0,!0);this._preWarmDone=!0}if(this._currentRenderId===this._scene.getFrameId()&&(!this._scene.activeCamera||this._scene.activeCamera&&this._currentRenderingCameraUniqueId===this._scene.activeCamera.uniqueId))return 0;this._currentRenderId=this._scene.getFrameId(),this._scene.activeCamera&&(this._currentRenderingCameraUniqueId=this._scene.activeCamera.uniqueId)}if(this._initialize(),this._accumulatedCount+=this.emitRate*this._timeDelta,this._accumulatedCount>1){var a=this._accumulatedCount|0;this._accumulatedCount-=a,this._currentActiveCount=Math.min(this._activeCount,this._currentActiveCount+a)}if(!this._currentActiveCount)return 0;var n;if(this.emitter.position){var h=this.emitter;n=h.getWorldMatrix()}else{var s=this.emitter;n=Ge.Translation(s.x,s.y,s.z)}var u=this._engine;this._platform.preUpdateParticleBuffer(),this._updateBuffer.setFloat("currentCount",this._currentActiveCount),this._updateBuffer.setFloat("timeDelta",this._timeDelta),this._updateBuffer.setFloat("stopFactor",this._stopped?0:1),this._updateBuffer.setInt("randomTextureSize",this._randomTextureSize),this._updateBuffer.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this._updateBuffer.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this._colorGradientsTexture||(this._updateBuffer.setDirectColor4("color1",this.color1),this._updateBuffer.setDirectColor4("color2",this.color2)),this._updateBuffer.setFloat2("sizeRange",this.minSize,this.maxSize),this._updateBuffer.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this._updateBuffer.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this._updateBuffer.setVector3("gravity",this.gravity),this._limitVelocityGradientsTexture&&this._updateBuffer.setFloat("limitVelocityDamping",this.limitVelocityDamping),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateBuffer),this._isAnimationSheetEnabled&&this._updateBuffer.setFloat4("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed,this.spriteCellLoop?1:0),this.noiseTexture&&this._updateBuffer.setVector3("noiseStrength",this.noiseStrength),this.isLocal||this._updateBuffer.setMatrix("emitterWM",n),this._platform.updateParticleBuffer(this._targetIndex,this._targetBuffer,this._currentActiveCount);var f=0;!e&&!i&&(u.setState(!1),this.forceDepthWrite&&u.setDepthWrite(!0),this.blendMode===$.BLENDMODE_MULTIPLYADD?f=this._render($.BLENDMODE_MULTIPLY,n)+this._render($.BLENDMODE_ADD,n):f=this._render(this.blendMode,n),this._engine.setAlphaMode(0)),this._targetIndex++,this._targetIndex===2&&(this._targetIndex=0);var l=this._sourceBuffer;return this._sourceBuffer=this._targetBuffer,this._targetBuffer=l,f},t.prototype.rebuild=function(){this._initialize(!0)},t.prototype._releaseBuffers=function(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._platform.releaseBuffers()},t.prototype.dispose=function(e){e===void 0&&(e=!0);for(var i in this._drawWrappers){var r=this._drawWrappers[i];r.dispose()}if(this._drawWrappers={},this._scene){var a=this._scene.particleSystems.indexOf(this);a>-1&&this._scene.particleSystems.splice(a,1)}this._releaseBuffers(),this._platform.releaseVertexBuffers(),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),this._randomTexture2&&(this._randomTexture2.dispose(),this._randomTexture2=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onStoppedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},t.prototype.clone=function(e,i){var r=yt({},this._customWrappers),a=null,n=this._engine;if(n.createEffectForParticles&&this.customShader!=null){a=this.customShader;var h=a.shaderOptions.defines.length>0?a.shaderOptions.defines.join(`
`):"";r[0]=n.createEffectForParticles(a.shaderPath.fragmentElement,a.shaderOptions.uniforms,a.shaderOptions.samplers,h,void 0,void 0,void 0,this)}var s=this.serialize(),u=t.Parse(s,this._scene||this._engine,this._rootUrl);return u.name=e,u.customShader=a,u._customWrappers=r,i===void 0&&(i=this.emitter),this.noiseTexture&&(u.noiseTexture=this.noiseTexture.clone()),u.emitter=i,u},t.prototype.serialize=function(e){e===void 0&&(e=!1);var i={};return $._Serialize(i,this,e),i.activeParticleCount=this.activeParticleCount,i.randomTextureSize=this._randomTextureSize,i.customShader=this.customShader,i},t.Parse=function(e,i,r,a,n){a===void 0&&(a=!1);var h=e.name,s,u;i instanceof gt?s=i:(u=i,s=u.getEngine());var f=new t(h,{capacity:n||e.capacity,randomTextureSize:e.randomTextureSize},i,null,e.isAnimationSheetEnabled);if(f._rootUrl=r,e.customShader&&s.createEffectForParticles){var l=e.customShader,p=l.shaderOptions.defines.length>0?l.shaderOptions.defines.join(`
`):"",_=s.createEffectForParticles(l.shaderPath.fragmentElement,l.shaderOptions.uniforms,l.shaderOptions.samplers,p,void 0,void 0,void 0,f);f.setCustomEffect(_,0),f.customShader=l}return e.id&&(f.id=e.id),e.activeParticleCount&&(f.activeParticleCount=e.activeParticleCount),$._Parse(e,f,i,r),e.preventAutoStart&&(f.preventAutoStart=e.preventAutoStart),!a&&!f.preventAutoStart&&f.start(),f},t}(Yt);(function(){function o(){this._emitterNodeIsOwned=!0,this.systems=new Array}return Object.defineProperty(o.prototype,"emitterNode",{get:function(){return this._emitterNode},set:function(t){this._emitterNodeIsOwned&&this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!1);for(var e=0,i=this.systems;e<i.length;e++){var r=i[e];r.emitter=t}this._emitterNode=t},enumerable:!1,configurable:!0}),o.prototype.setEmitterAsSphere=function(t,e,i){this._emitterNodeIsOwned&&this._emitterNode&&this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!0,this._emitterCreationOptions={kind:"Sphere",options:t,renderingGroupId:e};var r=li("emitterSphere",{diameter:t.diameter,segments:t.segments},i);r.renderingGroupId=e;var a=new Tt("emitterSphereMaterial",i);a.emissiveColor=t.color,r.material=a;for(var n=0,h=this.systems;n<h.length;n++){var s=h[n];s.emitter=r}this._emitterNode=r},o.prototype.start=function(t){for(var e=0,i=this.systems;e<i.length;e++){var r=i[e];t&&(r.emitter=t),r.start()}},o.prototype.dispose=function(){for(var t=0,e=this.systems;t<e.length;t++){var i=e[t];i.dispose()}this.systems.length=0,this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNode=null)},o.prototype.serialize=function(t){t===void 0&&(t=!1);var e={};e.systems=[];for(var i=0,r=this.systems;i<r.length;i++){var a=r[i];e.systems.push(a.serialize(t))}return this._emitterNode&&(e.emitter=this._emitterCreationOptions),e},o.Parse=function(t,e,i,r){i===void 0&&(i=!1);var a=new o,n=this.BaseAssetsUrl+"/textures/";e=e||We.LastCreatedScene;for(var h=0,s=t.systems;h<s.length;h++){var u=s[h];a.systems.push(i?Zt.Parse(u,e,n,!0,r):$.Parse(u,e,n,!0,r))}if(t.emitter){var f=t.emitter.options;switch(t.emitter.kind){case"Sphere":a.setEmitterAsSphere({diameter:f.diameter,segments:f.segments,color:Me.FromArray(f.color)},t.emitter.renderingGroupId,e);break}}return a},o.BaseAssetsUrl="https://assets.babylonjs.com/particles",o})();xt.AddParser(bt.NAME_PARTICLESYSTEM,function(o,t,e,i){var r=xt.GetIndividualParser(bt.NAME_PARTICLESYSTEM);if(!!r&&o.particleSystems!==void 0&&o.particleSystems!==null)for(var a=0,n=o.particleSystems.length;a<n;a++){var h=o.particleSystems[a];e.particleSystems.push(r(h,t,i))}});xt.AddIndividualParser(bt.NAME_PARTICLESYSTEM,function(o,t,e){if(o.activeParticleCount){var i=Zt.Parse(o,t,e);return i}else{var i=$.Parse(o,t,e);return i}});hi.prototype.createEffectForParticles=function(o,t,e,i,r,a,n,h){var s;t===void 0&&(t=[]),e===void 0&&(e=[]),i===void 0&&(i="");var u=[],f=[],l=[];return h?h.fillUniformsAttributesAndSamplerNames(f,u,l):(u=$._GetAttributeNamesOrOptions(),f=$._GetEffectCreationOptions()),i.indexOf(" BILLBOARD")===-1&&(i+=`
#define BILLBOARD
`),e.indexOf("diffuseSampler")===-1&&e.push("diffuseSampler"),this.createEffect({vertex:(s=h==null?void 0:h.vertexShaderName)!==null&&s!==void 0?s:"particles",fragmentElement:o},u,f.concat(t),l.concat(e),i,r,a,n)};dt.prototype.getEmittedParticleSystems=function(){for(var o=new Array,t=0;t<this.getScene().particleSystems.length;t++){var e=this.getScene().particleSystems[t];e.emitter===this&&o.push(e)}return o};dt.prototype.getHierarchyEmittedParticleSystems=function(){var o=new Array,t=this.getDescendants();t.push(this);for(var e=0;e<this.getScene().particleSystems.length;e++){var i=this.getScene().particleSystems[e],r=i.emitter;r.position&&t.indexOf(r)!==-1&&o.push(i)}return o};var It=function(){function o(t,e,i,r,a,n,h,s,u,f){u===void 0&&(u=null),f===void 0&&(f=null),this.idx=0,this.id=0,this.color=new H(1,1,1,1),this.position=c.Zero(),this.rotation=c.Zero(),this.scaling=c.One(),this.uvs=new Se(0,0,1,1),this.velocity=c.Zero(),this.pivot=c.Zero(),this.translateFromPivot=!1,this.alive=!0,this.isVisible=!0,this._pos=0,this._ind=0,this.shapeId=0,this.idxInShape=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this.materialIndex=null,this.props=null,this.cullingStrategy=di.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this._globalPosition=c.Zero(),this.idx=t,this.id=e,this._pos=i,this._ind=r,this._model=a,this.shapeId=n,this.idxInShape=h,this._sps=s,u&&(this._modelBoundingInfo=u,this._boundingInfo=new Ot(u.minimum,u.maximum)),f!==null&&(this.materialIndex=f)}return o.prototype.getBoundingInfo=function(){return this._boundingInfo},Object.defineProperty(o.prototype,"hasBoundingInfo",{get:function(){return this._boundingInfo!==null},enumerable:!1,configurable:!0}),o.prototype.copyToRef=function(t){return t.position.copyFrom(this.position),t.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(t.rotationQuaternion?t.rotationQuaternion.copyFrom(this.rotationQuaternion):t.rotationQuaternion=this.rotationQuaternion.clone()),t.scaling.copyFrom(this.scaling),this.color&&(t.color?t.color.copyFrom(this.color):t.color=this.color.clone()),t.uvs.copyFrom(this.uvs),t.velocity.copyFrom(this.velocity),t.pivot.copyFrom(this.pivot),t.translateFromPivot=this.translateFromPivot,t.alive=this.alive,t.isVisible=this.isVisible,t.parentId=this.parentId,t.cullingStrategy=this.cullingStrategy,this.materialIndex!==null&&(t.materialIndex=this.materialIndex),this},Object.defineProperty(o.prototype,"scale",{get:function(){return this.scaling},set:function(t){this.scaling=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"quaternion",{get:function(){return this.rotationQuaternion},set:function(t){this.rotationQuaternion=t},enumerable:!1,configurable:!0}),o.prototype.intersectsMesh=function(t){return!this._boundingInfo||!t.hasBoundingInfo?!1:this._sps._bSphereOnly?_i.Intersects(this._boundingInfo.boundingSphere,t.getBoundingInfo().boundingSphere):this._boundingInfo.intersects(t.getBoundingInfo(),!1)},o.prototype.isInFrustum=function(t){return this._boundingInfo!==null&&this._boundingInfo.isInFrustum(t,this.cullingStrategy)},o.prototype.getRotationMatrix=function(t){var e;if(this.rotationQuaternion)e=this.rotationQuaternion;else{e=O.Quaternion[0];var i=this.rotation;St.RotationYawPitchRollToRef(i.y,i.x,i.z,e)}e.toRotationMatrix(t)},o}(),Rt=function(){function o(t,e,i,r,a,n,h,s,u){this._indicesLength=0,this.shapeId=t,this._shape=e,this._indices=i,this._indicesLength=i.length,this._shapeUV=n,this._shapeColors=a,this._normals=r,this._positionFunction=h,this._vertexFunction=s,this._material=u}return Object.defineProperty(o.prototype,"shapeID",{get:function(){return this.shapeId},set:function(t){this.shapeId=t},enumerable:!1,configurable:!0}),o}(),bi=function(){function o(t,e,i,r){this.idx=0,this.ind=0,this.indicesLength=0,this.sqDistance=0,this.materialIndex=0,this.idx=t,this.ind=e,this.indicesLength=i,this.materialIndex=r}return o}(),Si=function(){function o(){this.position=c.Zero(),this.color=new H(1,1,1,1),this.uv=Te.Zero()}return Object.defineProperty(o.prototype,"x",{get:function(){return this.position.x},set:function(t){this.position.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"y",{get:function(){return this.position.y},set:function(t){this.position.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"z",{get:function(){return this.position.z},set:function(t){this.position.z=t},enumerable:!1,configurable:!0}),o}();(function(){function o(t,e,i){this.particles=new Array,this.nbParticles=0,this.billboard=!1,this.recomputeNormals=!1,this.counter=0,this.vars={},this._bSphereOnly=!1,this._bSphereRadiusFactor=1,this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._index=0,this._updatable=!0,this._pickable=!1,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._depthSort=!1,this._expandable=!1,this._shapeCounter=0,this._copy=new It(0,0,0,0,null,0,0,this),this._color=new H(0,0,0,0),this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeParticleVertex=!1,this._computeBoundingBox=!1,this._depthSortParticles=!0,this._mustUnrotateFixedNormals=!1,this._particlesIntersect=!1,this._needs32Bits=!1,this._isNotBuilt=!0,this._lastParticleId=0,this._idxOfId=[],this._multimaterialEnabled=!1,this._useModelMaterial=!1,this._depthSortFunction=function(r,a){return a.sqDistance-r.sqDistance},this._materialSortFunction=function(r,a){return r.materialIndex-a.materialIndex},this._autoUpdateSubMeshes=!1,this.name=t,this._scene=e||We.LastCreatedScene,this._camera=e.activeCamera,this._pickable=i?i.isPickable:!1,this._depthSort=i?i.enableDepthSort:!1,this._multimaterialEnabled=i?i.enableMultiMaterial:!1,this._useModelMaterial=i?i.useModelMaterial:!1,this._multimaterialEnabled=this._useModelMaterial?!0:this._multimaterialEnabled,this._expandable=i?i.expandable:!1,this._particlesIntersect=i?i.particleIntersection:!1,this._bSphereOnly=i?i.boundingSphereOnly:!1,this._bSphereRadiusFactor=i&&i.bSphereRadiusFactor?i.bSphereRadiusFactor:1,this._computeBoundingBox=i!=null&&i.computeBoundingBox?i.computeBoundingBox:!1,i&&i.updatable!==void 0?this._updatable=i.updatable:this._updatable=!0,this._pickable&&(this.pickedBySubMesh=[[]],this.pickedParticles=this.pickedBySubMesh[0]),(this._depthSort||this._multimaterialEnabled)&&(this.depthSortedParticles=[]),this._multimaterialEnabled&&(this._multimaterial=new At(this.name+"MultiMaterial",this._scene),this._materials=[],this._materialIndexesById={}),this._tmpVertex=new Si}return o.prototype.buildMesh=function(){if(!this._isNotBuilt&&this.mesh)return this.mesh;if(this.nbParticles===0&&!this.mesh){var t=ci("",{radius:1,tessellation:3},this._scene);this.addShape(t,1),t.dispose()}if(this._indices32=this._needs32Bits?new Uint32Array(this._indices):new Uint16Array(this._indices),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors),!this.mesh){var e=new dt(this.name,this._scene);this.mesh=e}!this._updatable&&this._multimaterialEnabled&&this._sortParticlesByMaterial(),this.recomputeNormals&&ht.ComputeNormals(this._positions32,this._indices32,this._normals),this._normals32=new Float32Array(this._normals),this._fixedNormal32=new Float32Array(this._normals),this._mustUnrotateFixedNormals&&this._unrotateFixedNormals();var i=new ht;if(i.indices=this._depthSort?this._indices:this._indices32,i.set(this._positions32,z.PositionKind),i.set(this._normals32,z.NormalKind),this._uvs32.length>0&&i.set(this._uvs32,z.UVKind),this._colors32.length>0&&i.set(this._colors32,z.ColorKind),i.applyToMesh(this.mesh,this._updatable),this.mesh.isPickable=this._pickable,this._pickable)for(var r=0,a=0;a<this.nbParticles;a++)for(var n=this.particles[a],h=n._model._indicesLength,s=0;s<h;s++){var u=s%3;if(u==0){var f={idx:n.idx,faceId:r};this.pickedParticles[r]=f,r++}}return this._multimaterialEnabled&&this.setMultiMaterial(this._materials),this._expandable||(!this._depthSort&&!this._multimaterialEnabled&&(this._indices=null),this._positions=null,this._normals=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0)),this._isNotBuilt=!1,this.recomputeNormals=!1,this.mesh},o.prototype.digest=function(t,e){var i=e&&e.facetNb||1,r=e&&e.number||0,a=e&&e.delta||0,n=t.getVerticesData(z.PositionKind),h=t.getIndices(),s=t.getVerticesData(z.UVKind),u=t.getVerticesData(z.ColorKind),f=t.getVerticesData(z.NormalKind),l=e&&e.storage?e.storage:null,p=0,_=h.length/3;r?(r=r>_?_:r,i=Math.round(_/r),a=0):i=i>_?_:i;for(var v=[],m=[],x=[],d=[],T=[],B=c.Zero(),w=i;p<_;){i=w+Math.floor((1+a)*Math.random()),p>_-i&&(i=_-p),v.length=0,m.length=0,x.length=0,d.length=0,T.length=0;for(var C=0,P=p*3;P<(p+i)*3;P++){x.push(C);var V=h[P],N=V*3;if(v.push(n[N],n[N+1],n[N+2]),m.push(f[N],f[N+1],f[N+2]),s){var K=V*2;d.push(s[K],s[K+1])}if(u){var M=V*4;T.push(u[M],u[M+1],u[M+2],u[M+3])}C++}var g=this.nbParticles,I=this._posToShape(v),E=this._uvsToShapeUV(d),F=x.slice(),S=T.slice(),y=m.slice();B.copyFromFloats(0,0,0);var G=void 0;for(G=0;G<I.length;G++)B.addInPlace(I[G]);B.scaleInPlace(1/I.length);var X=new c(1/0,1/0,1/0),k=new c(-1/0,-1/0,-1/0);for(G=0;G<I.length;G++)I[G].subtractInPlace(B),X.minimizeInPlaceFromFloats(I[G].x,I[G].y,I[G].z),k.maximizeInPlaceFromFloats(I[G].x,I[G].y,I[G].z);var Y=void 0;this._particlesIntersect&&(Y=new Ot(X,k));var A=null;this._useModelMaterial&&(A=t.material?t.material:this._setDefaultMaterial());var j=new Rt(this._shapeCounter,I,F,y,S,E,null,null,A),J=this._positions.length,D=this._indices.length;this._meshBuilder(this._index,D,I,this._positions,F,this._indices,d,this._uvs,S,this._colors,y,this._normals,g,0,null,j),this._addParticle(g,this._lastParticleId,J,D,j,this._shapeCounter,0,Y,l),this.particles[this.nbParticles].position.addInPlace(B),l||(this._index+=I.length,g++,this.nbParticles++,this._lastParticleId++),this._shapeCounter++,p+=i}return this._isNotBuilt=!0,this},o.prototype._unrotateFixedNormals=function(){for(var t=0,e=0,i=O.Vector3[0],r=O.Quaternion[0],a=O.Matrix[0],n=0;n<this.particles.length;n++){var h=this.particles[n],s=h._model._shape;if(h.rotationQuaternion)h.rotationQuaternion.conjugateToRef(r);else{var u=h.rotation;St.RotationYawPitchRollToRef(u.y,u.x,u.z,r),r.conjugateInPlace()}r.toRotationMatrix(a);for(var f=0;f<s.length;f++)e=t+f*3,c.TransformNormalFromFloatsToRef(this._normals32[e],this._normals32[e+1],this._normals32[e+2],a,i),i.toArray(this._fixedNormal32,e);t=e+3}},o.prototype._resetCopy=function(){var t=this._copy;t.position.setAll(0),t.rotation.setAll(0),t.rotationQuaternion=null,t.scaling.setAll(1),t.uvs.copyFromFloats(0,0,1,1),t.color=null,t.translateFromPivot=!1,t.shapeId=0,t.materialIndex=null},o.prototype._meshBuilder=function(t,e,i,r,a,n,h,s,u,f,l,p,_,v,m,x){var d,T=0,B=0,w=0;this._resetCopy();var C=this._copy,P=!!(m&&m.storage);if(C.idx=_,C.idxInShape=v,C.shapeId=x.shapeId,this._useModelMaterial){var V=x._material.uniqueId,N=this._materialIndexesById;Object.prototype.hasOwnProperty.call(N,V)||(N[V]=this._materials.length,this._materials.push(x._material));var K=N[V];C.materialIndex=K}if(m&&m.positionFunction&&(m.positionFunction(C,_,v),this._mustUnrotateFixedNormals=!0),P)return C;var M=O.Matrix[0],g=this._tmpVertex,I=g.position,E=g.color,F=g.uv,S=O.Vector3[1],y=O.Vector3[2],G=O.Vector3[3];Ge.IdentityToRef(M),C.getRotationMatrix(M),C.pivot.multiplyToRef(C.scaling,G),C.translateFromPivot?y.setAll(0):y.copyFrom(G);var X=m&&m.vertexFunction;for(d=0;d<i.length;d++){if(I.copyFrom(i[d]),C.color&&E.copyFrom(C.color),h&&F.copyFromFloats(h[T],h[T+1]),X&&m.vertexFunction(C,g,d),I.multiplyInPlace(C.scaling).subtractInPlace(G),c.TransformCoordinatesToRef(I,M,S),S.addInPlace(y).addInPlace(C.position),r.push(S.x,S.y,S.z),h){var k=C.uvs;s.push((k.z-k.x)*F.x+k.x,(k.w-k.y)*F.y+k.y),T+=2}if(C.color)this._color.copyFrom(E);else{var Y=this._color;u&&u[B]!==void 0?(Y.r=u[B],Y.g=u[B+1],Y.b=u[B+2],Y.a=u[B+3]):(Y.r=1,Y.g=1,Y.b=1,Y.a=1)}f.push(this._color.r,this._color.g,this._color.b,this._color.a),B+=4,!this.recomputeNormals&&l&&(c.TransformNormalFromFloatsToRef(l[w],l[w+1],l[w+2],M,I),p.push(I.x,I.y,I.z),w+=3)}for(d=0;d<a.length;d++){var A=t+a[d];n.push(A),A>65535&&(this._needs32Bits=!0)}if(this._depthSort||this._multimaterialEnabled){var j=C.materialIndex!==null?C.materialIndex:0;this.depthSortedParticles.push(new bi(_,e,a.length,j))}return C},o.prototype._posToShape=function(t){for(var e=[],i=0;i<t.length;i+=3)e.push(c.FromArray(t,i));return e},o.prototype._uvsToShapeUV=function(t){var e=[];if(t)for(var i=0;i<t.length;i++)e.push(t[i]);return e},o.prototype._addParticle=function(t,e,i,r,a,n,h,s,u){s===void 0&&(s=null),u===void 0&&(u=null);var f=new It(t,e,i,r,a,n,h,this,s),l=u||this.particles;return l.push(f),f},o.prototype.addShape=function(t,e,i){var r=t.getVerticesData(z.PositionKind),a=t.getIndices(),n=t.getVerticesData(z.UVKind),h=t.getVerticesData(z.ColorKind),s=t.getVerticesData(z.NormalKind);this.recomputeNormals=!s;var u=Array.from(a),f=Array.from(s),l=h?Array.from(h):[],p=i&&i.storage?i.storage:null,_=null;this._particlesIntersect&&(_=t.getBoundingInfo());var v=this._posToShape(r),m=this._uvsToShapeUV(n),x=i?i.positionFunction:null,d=i?i.vertexFunction:null,T=null;this._useModelMaterial&&(T=t.material?t.material:this._setDefaultMaterial());for(var B=new Rt(this._shapeCounter,v,u,f,l,m,x,d,T),w=0;w<e;w++)this._insertNewParticle(this.nbParticles,w,B,v,a,n,h,s,_,p,i);return this._shapeCounter++,this._isNotBuilt=!0,this._shapeCounter-1},o.prototype._rebuildParticle=function(t,e){e===void 0&&(e=!1),this._resetCopy();var i=this._copy;t._model._positionFunction&&t._model._positionFunction(i,t.idx,t.idxInShape);var r=O.Matrix[0],a=O.Vector3[0],n=O.Vector3[1],h=O.Vector3[2],s=O.Vector3[3];i.getRotationMatrix(r),t.pivot.multiplyToRef(t.scaling,s),i.translateFromPivot?h.copyFromFloats(0,0,0):h.copyFrom(s);for(var u=t._model._shape,f=0;f<u.length;f++)a.copyFrom(u[f]),t._model._vertexFunction&&t._model._vertexFunction(i,a,f),a.multiplyInPlace(i.scaling).subtractInPlace(s),c.TransformCoordinatesToRef(a,r,n),n.addInPlace(h).addInPlace(i.position).toArray(this._positions32,t._pos+f*3);e&&(t.position.setAll(0),t.rotation.setAll(0),t.rotationQuaternion=null,t.scaling.setAll(1),t.uvs.setAll(0),t.pivot.setAll(0),t.translateFromPivot=!1,t.parentId=null)},o.prototype.rebuildMesh=function(t){t===void 0&&(t=!1);for(var e=0;e<this.particles.length;e++)this._rebuildParticle(this.particles[e],t);return this.mesh.updateVerticesData(z.PositionKind,this._positions32,!1,!1),this},o.prototype.removeParticles=function(t,e){var i=e-t+1;if(!this._expandable||i<=0||i>=this.nbParticles||!this._updatable)return[];var r=this.particles,a=this.nbParticles;if(e<a-1)for(var n=e+1,h=r[n]._pos-r[t]._pos,s=r[n]._ind-r[t]._ind,u=n;u<a;u++){var f=r[u];f._pos-=h,f._ind-=s}var l=r.splice(t,i);this._positions.length=0,this._indices.length=0,this._colors.length=0,this._uvs.length=0,this._normals.length=0,this._index=0,this._idxOfId.length=0,(this._depthSort||this._multimaterialEnabled)&&(this.depthSortedParticles=[]);for(var p=0,_=r.length,v=0;v<_;v++){var m=r[v],x=m._model,d=x._shape,T=x._indices,B=x._normals,w=x._shapeColors,C=x._shapeUV;m.idx=v,this._idxOfId[m.id]=v,this._meshBuilder(this._index,p,d,this._positions,T,this._indices,C,this._uvs,w,this._colors,B,this._normals,m.idx,m.idxInShape,null,x),this._index+=d.length,p+=T.length}return this.nbParticles-=i,this._isNotBuilt=!0,l},o.prototype.insertParticlesFromArray=function(t){if(!this._expandable)return this;for(var e=0,i=t[0].shapeId,r=t.length,a=0;a<r;a++){var n=t[a],h=n._model,s=h._shape,u=h._indices,f=h._shapeUV,l=h._shapeColors,p=h._normals,_=!p;this.recomputeNormals=_||this.recomputeNormals;var v=n.getBoundingInfo(),m=this._insertNewParticle(this.nbParticles,e,h,s,u,f,l,p,v,null,null);n.copyToRef(m),e++,i!=n.shapeId&&(i=n.shapeId,e=0)}return this._isNotBuilt=!0,this},o.prototype._insertNewParticle=function(t,e,i,r,a,n,h,s,u,f,l){var p=this._positions.length,_=this._indices.length,v=this._meshBuilder(this._index,_,r,this._positions,a,this._indices,n,this._uvs,h,this._colors,s,this._normals,t,e,l,i),m=null;return this._updatable&&(m=this._addParticle(this.nbParticles,this._lastParticleId,p,_,i,this._shapeCounter,e,u,f),m.position.copyFrom(v.position),m.rotation.copyFrom(v.rotation),v.rotationQuaternion&&(m.rotationQuaternion?m.rotationQuaternion.copyFrom(v.rotationQuaternion):m.rotationQuaternion=v.rotationQuaternion.clone()),v.color&&(m.color?m.color.copyFrom(v.color):m.color=v.color.clone()),m.scaling.copyFrom(v.scaling),m.uvs.copyFrom(v.uvs),v.materialIndex!==null&&(m.materialIndex=v.materialIndex),this.expandable&&(this._idxOfId[m.id]=m.idx)),f||(this._index+=r.length,this.nbParticles++,this._lastParticleId++),m},o.prototype.setParticles=function(t,e,i){if(t===void 0&&(t=0),e===void 0&&(e=this.nbParticles-1),i===void 0&&(i=!0),!this._updatable||this._isNotBuilt)return this;this.beforeUpdateParticles(t,e,i);var r=O.Matrix[0],a=O.Matrix[1],n=this.mesh,h=this._colors32,s=this._positions32,u=this._normals32,f=this._uvs32,l=this._indices32,p=this._indices,_=this._fixedNormal32,v=O.Vector3,m=v[5].copyFromFloats(1,0,0),x=v[6].copyFromFloats(0,1,0),d=v[7].copyFromFloats(0,0,1),T=v[8].setAll(Number.MAX_VALUE),B=v[9].setAll(-Number.MAX_VALUE),w=v[10].setAll(0),C=this._tmpVertex,P=C.position,V=C.color,N=C.uv;if((this.billboard||this._depthSort)&&(this.mesh.computeWorldMatrix(!0),this.mesh._worldMatrix.invertToRef(a)),this.billboard){var K=v[0];this._camera.getDirectionToRef(ti.Z,K),c.TransformNormalToRef(K,a,d),d.normalize();var M=this._camera.getViewMatrix(!0);c.TransformNormalFromFloatsToRef(M.m[1],M.m[5],M.m[9],a,x),c.CrossToRef(x,d,m),x.normalize(),m.normalize()}this._depthSort&&c.TransformCoordinatesToRef(this._camera.globalPosition,a,w),Ge.IdentityToRef(r);var g=0,I=0,E=0,F=0,S=0,y=0,G=0;if(this.mesh.isFacetDataEnabled&&(this._computeBoundingBox=!0),e=e>=this.nbParticles?this.nbParticles-1:e,this._computeBoundingBox&&(t!=0||e!=this.nbParticles-1)){var X=this.mesh.getBoundingInfo();X&&(T.copyFrom(X.minimum),B.copyFrom(X.maximum))}I=this.particles[t]._pos;var k=I/3|0;F=k*4,y=k*2;for(var Y=t;Y<=e;Y++){var A=this.particles[Y];this.updateParticle(A);var j=A._model._shape,J=A._model._shapeUV,D=A._rotationMatrix,Z=A.position,oe=A.rotation,Q=A.scaling,q=A._globalPosition;if(this._depthSort&&this._depthSortParticles){var ie=this.depthSortedParticles[Y];ie.idx=A.idx,ie.ind=A._ind,ie.indicesLength=A._model._indicesLength,ie.sqDistance=c.DistanceSquared(A.position,w)}if(!A.alive||A._stillInvisible&&!A.isVisible){G=j.length,I+=G*3,F+=G*4,y+=G*2;continue}if(A.isVisible){A._stillInvisible=!1;var ee=v[12];A.pivot.multiplyToRef(Q,ee),this.billboard&&(oe.x=0,oe.y=0),(this._computeParticleRotation||this.billboard)&&A.getRotationMatrix(r);var re=A.parentId!==null;if(re){var le=this.getParticleById(A.parentId);if(le){var R=le._rotationMatrix,ce=le._globalPosition,U=Z.x*R[1]+Z.y*R[4]+Z.z*R[7],se=Z.x*R[0]+Z.y*R[3]+Z.z*R[6],ne=Z.x*R[2]+Z.y*R[5]+Z.z*R[8];if(q.x=ce.x+se,q.y=ce.y+U,q.z=ce.z+ne,this._computeParticleRotation||this.billboard){var L=r.m;D[0]=L[0]*R[0]+L[1]*R[3]+L[2]*R[6],D[1]=L[0]*R[1]+L[1]*R[4]+L[2]*R[7],D[2]=L[0]*R[2]+L[1]*R[5]+L[2]*R[8],D[3]=L[4]*R[0]+L[5]*R[3]+L[6]*R[6],D[4]=L[4]*R[1]+L[5]*R[4]+L[6]*R[7],D[5]=L[4]*R[2]+L[5]*R[5]+L[6]*R[8],D[6]=L[8]*R[0]+L[9]*R[3]+L[10]*R[6],D[7]=L[8]*R[1]+L[9]*R[4]+L[10]*R[7],D[8]=L[8]*R[2]+L[9]*R[5]+L[10]*R[8]}}else A.parentId=null}else if(q.x=Z.x,q.y=Z.y,q.z=Z.z,this._computeParticleRotation||this.billboard){var L=r.m;D[0]=L[0],D[1]=L[1],D[2]=L[2],D[3]=L[4],D[4]=L[5],D[5]=L[6],D[6]=L[8],D[7]=L[9],D[8]=L[10]}var ue=v[11];for(A.translateFromPivot?ue.setAll(0):ue.copyFrom(ee),G=0;G<j.length;G++){g=I+G*3,E=F+G*4,S=y+G*2;var Qe=2*G,at=Qe+1;P.copyFrom(j[G]),this._computeParticleColor&&A.color&&V.copyFrom(A.color),this._computeParticleTexture&&N.copyFromFloats(J[Qe],J[at]),this._computeParticleVertex&&this.updateParticleVertex(A,C,G);var me=P.x*Q.x-ee.x,Ie=P.y*Q.y-ee.y,ke=P.z*Q.z-ee.z,se=me*D[0]+Ie*D[3]+ke*D[6],U=me*D[1]+Ie*D[4]+ke*D[7],ne=me*D[2]+Ie*D[5]+ke*D[8];se+=ue.x,U+=ue.y,ne+=ue.z;var qe=s[g]=q.x+m.x*se+x.x*U+d.x*ne,je=s[g+1]=q.y+m.y*se+x.y*U+d.y*ne,pe=s[g+2]=q.z+m.z*se+x.z*U+d.z*ne;if(this._computeBoundingBox&&(T.minimizeInPlaceFromFloats(qe,je,pe),B.maximizeInPlaceFromFloats(qe,je,pe)),!this._computeParticleVertex){var De=_[g],ve=_[g+1],Pe=_[g+2],W=De*D[0]+ve*D[3]+Pe*D[6],Re=De*D[1]+ve*D[4]+Pe*D[7],Fe=De*D[2]+ve*D[5]+Pe*D[8];u[g]=m.x*W+x.x*Re+d.x*Fe,u[g+1]=m.y*W+x.y*Re+d.y*Fe,u[g+2]=m.z*W+x.z*Re+d.z*Fe}if(this._computeParticleColor&&A.color){var we=this._colors32;we[E]=V.r,we[E+1]=V.g,we[E+2]=V.b,we[E+3]=V.a}if(this._computeParticleTexture){var te=A.uvs;f[S]=N.x*(te.z-te.x)+te.x,f[S+1]=N.y*(te.w-te.y)+te.y}}}else for(A._stillInvisible=!0,G=0;G<j.length;G++){if(g=I+G*3,E=F+G*4,S=y+G*2,s[g]=s[g+1]=s[g+2]=0,u[g]=u[g+1]=u[g+2]=0,this._computeParticleColor&&A.color){var Ve=A.color;h[E]=Ve.r,h[E+1]=Ve.g,h[E+2]=Ve.b,h[E+3]=Ve.a}if(this._computeParticleTexture){var te=A.uvs;f[S]=J[G*2]*(te.z-te.x)+te.x,f[S+1]=J[G*2+1]*(te.w-te.y)+te.y}}if(this._particlesIntersect){var Je=A.getBoundingInfo(),ot=Je.boundingBox,Ye=Je.boundingSphere,Le=A._modelBoundingInfo;if(!this._bSphereOnly){var Be=Le.boundingBox.vectors,de=v[1],ze=v[2];de.setAll(Number.MAX_VALUE),ze.setAll(-Number.MAX_VALUE);for(var Ee=0;Ee<8;Ee++){var Ze=Be[Ee].x*Q.x,He=Be[Ee].y*Q.y,Ke=Be[Ee].z*Q.z,se=Ze*D[0]+He*D[3]+Ke*D[6],U=Ze*D[1]+He*D[4]+Ke*D[7],ne=Ze*D[2]+He*D[5]+Ke*D[8],ge=Z.x+m.x*se+x.x*U+d.x*ne,ye=Z.y+m.y*se+x.y*U+d.y*ne,Oe=Z.z+m.z*se+x.z*U+d.z*ne;de.minimizeInPlaceFromFloats(ge,ye,Oe),ze.maximizeInPlaceFromFloats(ge,ye,Oe)}ot.reConstruct(de,ze,n._worldMatrix)}var $e=Le.minimum.multiplyToRef(Q,v[1]),Ne=Le.maximum.multiplyToRef(Q,v[2]),xe=Ne.addToRef($e,v[3]).scaleInPlace(.5).addInPlace(q),he=Ne.subtractToRef($e,v[4]).scaleInPlace(.5*this._bSphereRadiusFactor),et=xe.subtractToRef(he,v[1]),Ht=xe.addToRef(he,v[2]);Ye.reConstruct(et,Ht,n._worldMatrix)}I=g+3,F=E+4,y=S+2}if(i){if(this._computeParticleColor){var Ae=n.getVertexBuffer(z.ColorKind);Ae&&!n.isPickable?Ae.updateDirectly(h,0):n.updateVerticesData(z.ColorKind,h,!1,!1)}if(this._computeParticleTexture){var Ae=n.getVertexBuffer(z.UVKind);Ae&&!n.isPickable?Ae.updateDirectly(f,0):n.updateVerticesData(z.UVKind,f,!1,!1)}var Dt=n.getVertexBuffer(z.PositionKind);if(Dt&&!n.isPickable?Dt.updateDirectly(s,0):n.updateVerticesData(z.PositionKind,s,!1,!1),!n.areNormalsFrozen||n.isFacetDataEnabled){if(this._computeParticleVertex||n.isFacetDataEnabled){var Kt=n.isFacetDataEnabled?n.getFacetDataParameters():null;ht.ComputeNormals(s,l,u,Kt);for(var be=0;be<u.length;be++)_[be]=u[be]}if(!n.areNormalsFrozen){var Ae=n.getVertexBuffer(z.NormalKind);Ae&&!n.isPickable?Ae.updateDirectly(u,0):n.updateVerticesData(z.NormalKind,u,!1,!1)}}if(this._depthSort&&this._depthSortParticles){var ct=this.depthSortedParticles;ct.sort(this._depthSortFunction);for(var Xt=ct.length,Pt=0,pt=0,_t=0;_t<Xt;_t++)for(var mt=ct[_t],Qt=mt.indicesLength,qt=mt.ind,be=0;be<Qt;be++)if(l[Pt]=p[qt+be],Pt++,this._pickable){var jt=be%3;if(jt==0){var Bt=this.pickedParticles[pt];Bt.idx=mt.idx,Bt.faceId=pt,pt++}}n.updateIndices(l)}}return this._computeBoundingBox&&(n.hasBoundingInfo?n.getBoundingInfo().reConstruct(T,B,n._worldMatrix):n.buildBoundingInfo(T,B,n._worldMatrix)),this._autoUpdateSubMeshes&&this.computeSubMeshes(),this.afterUpdateParticles(t,e,i),this},o.prototype.dispose=function(){this.mesh.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._normals32=null,this._fixedNormal32=null,this._uvs32=null,this._colors32=null,this.pickedParticles=null,this.pickedBySubMesh=null,this._materials=null,this._materialIndexes=null,this._indicesByMaterial=null,this._idxOfId=null},o.prototype.pickedParticle=function(t){if(t.hit){var e=t.subMeshId,i=t.faceId-this.mesh.subMeshes[e].indexStart/3,r=this.pickedBySubMesh;if(r[e]&&r[e][i])return r[e][i]}return null},o.prototype.getParticleById=function(t){var e=this.particles[t];if(e&&e.id==t)return e;var i=this.particles,r=this._idxOfId[t];if(r!==void 0)return i[r];for(var a=0,n=this.nbParticles;a<n;){var h=i[a];if(h.id==t)return h;a++}return null},o.prototype.getParticlesByShapeId=function(t){var e=[];return this.getParticlesByShapeIdToRef(t,e),e},o.prototype.getParticlesByShapeIdToRef=function(t,e){e.length=0;for(var i=0;i<this.nbParticles;i++){var r=this.particles[i];r.shapeId==t&&e.push(r)}return this},o.prototype.computeSubMeshes=function(){if(!this.mesh||!this._multimaterialEnabled)return this;var t=this.depthSortedParticles;if(this.particles.length>0)for(var e=0;e<this.particles.length;e++){var i=this.particles[e];i.materialIndex||(i.materialIndex=0);var r=t[e];r.materialIndex=i.materialIndex,r.ind=i._ind,r.indicesLength=i._model._indicesLength,r.idx=i.idx}this._sortParticlesByMaterial();var a=this._indicesByMaterial,n=this._materialIndexes,h=this.mesh;h.subMeshes=[];for(var s=h.getTotalVertices(),u=0;u<n.length;u++){var f=a[u],l=a[u+1]-f,p=n[u];new pi(p,0,s,f,l,h)}return this},o.prototype._sortParticlesByMaterial=function(){var t=[0];this._indicesByMaterial=t;var e=[];this._materialIndexes=e;var i=this.depthSortedParticles;i.sort(this._materialSortFunction);var r=i.length,a=this._indices32,n=this._indices,h=0,s=0,u=0,f=i[0].materialIndex;e.push(f),this._pickable&&(this.pickedBySubMesh=[[]],this.pickedParticles=this.pickedBySubMesh[0]);for(var l=0;l<r;l++){var p=i[l],_=p.indicesLength,v=p.ind;p.materialIndex!==f&&(f=p.materialIndex,t.push(u),e.push(f),this._pickable&&(h++,this.pickedBySubMesh[h]=[],s=0));for(var m=0,x=0;x<_;x++){if(a[u]=n[v+x],this._pickable){var d=x%3;if(d==0){var T=this.pickedBySubMesh[h][s];T?(T.idx=p.idx,T.faceId=m):this.pickedBySubMesh[h][s]={idx:p.idx,faceId:m},s++,m++}}u++}}return t.push(a.length),this._updatable&&this.mesh.updateIndices(a),this},o.prototype._setMaterialIndexesById=function(){this._materialIndexesById={};for(var t=0;t<this._materials.length;t++){var e=this._materials[t].uniqueId;this._materialIndexesById[e]=t}},o.prototype._filterUniqueMaterialId=function(t){var e=t.filter(function(i,r,a){return a.indexOf(i)===r});return e},o.prototype._setDefaultMaterial=function(){return this._defaultMaterial||(this._defaultMaterial=new Tt(this.name+"DefaultMaterial",this._scene)),this._defaultMaterial},o.prototype.refreshVisibleSize=function(){return this._isVisibilityBoxLocked||this.mesh.refreshBoundingInfo(),this},o.prototype.setVisibilityBox=function(t){var e=t/2;this.mesh.buildBoundingInfo(new c(-e,-e,-e),new c(e,e,e))},Object.defineProperty(o.prototype,"isAlwaysVisible",{get:function(){return this._alwaysVisible},set:function(t){this._alwaysVisible=t,this.mesh.alwaysSelectAsActiveMesh=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"isVisibilityBoxLocked",{get:function(){return this._isVisibilityBoxLocked},set:function(t){this._isVisibilityBoxLocked=t;var e=this.mesh.getBoundingInfo();e.isLocked=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"computeParticleRotation",{get:function(){return this._computeParticleRotation},set:function(t){this._computeParticleRotation=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"computeParticleColor",{get:function(){return this._computeParticleColor},set:function(t){this._computeParticleColor=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"computeParticleTexture",{get:function(){return this._computeParticleTexture},set:function(t){this._computeParticleTexture=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"computeParticleVertex",{get:function(){return this._computeParticleVertex},set:function(t){this._computeParticleVertex=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"computeBoundingBox",{get:function(){return this._computeBoundingBox},set:function(t){this._computeBoundingBox=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"depthSortParticles",{get:function(){return this._depthSortParticles},set:function(t){this._depthSortParticles=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"expandable",{get:function(){return this._expandable},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"multimaterialEnabled",{get:function(){return this._multimaterialEnabled},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"useModelMaterial",{get:function(){return this._useModelMaterial},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"materials",{get:function(){return this._materials},enumerable:!1,configurable:!0}),o.prototype.setMultiMaterial=function(t){this._materials=this._filterUniqueMaterialId(t),this._setMaterialIndexesById(),this._multimaterial&&this._multimaterial.dispose(),this._multimaterial=new At(this.name+"MultiMaterial",this._scene);for(var e=0;e<this._materials.length;e++)this._multimaterial.subMaterials.push(this._materials[e]);this.computeSubMeshes(),this.mesh.material=this._multimaterial},Object.defineProperty(o.prototype,"multimaterial",{get:function(){return this._multimaterial},set:function(t){this._multimaterial=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"autoUpdateSubMeshes",{get:function(){return this._autoUpdateSubMeshes},set:function(t){this._autoUpdateSubMeshes=t},enumerable:!1,configurable:!0}),o.prototype.initParticles=function(){},o.prototype.recycleParticle=function(t){return t},o.prototype.updateParticle=function(t){return t},o.prototype.updateParticleVertex=function(t,e,i){return this},o.prototype.beforeUpdateParticles=function(t,e,i){},o.prototype.afterUpdateParticles=function(t,e,i){},o})();var Ti=function(){function o(t,e,i,r,a){this.idx=0,this.color=new H(1,1,1,1),this.position=c.Zero(),this.rotation=c.Zero(),this.uv=new Te(0,0),this.velocity=c.Zero(),this.pivot=c.Zero(),this.translateFromPivot=!1,this._pos=0,this._ind=0,this.groupId=0,this.idxInGroup=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this._globalPosition=c.Zero(),this.idx=t,this._group=e,this.groupId=i,this.idxInGroup=r,this._pcs=a}return Object.defineProperty(o.prototype,"size",{get:function(){return this.size},set:function(t){this.size=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"quaternion",{get:function(){return this.rotationQuaternion},set:function(t){this.rotationQuaternion=t},enumerable:!1,configurable:!0}),o.prototype.intersectsMesh=function(t,e){if(!t.hasBoundingInfo)return!1;if(e=e||!1,e)return t.getBoundingInfo().boundingSphere.intersectsPoint(this.position.add(this._pcs.mesh.position));var i=0,r=0,a=0,n=0,h=0,s=0;i=t.getBoundingInfo().boundingBox.maximumWorld.x,r=t.getBoundingInfo().boundingBox.minimumWorld.x,a=t.getBoundingInfo().boundingBox.maximumWorld.y,n=t.getBoundingInfo().boundingBox.minimumWorld.y,h=t.getBoundingInfo().boundingBox.maximumWorld.z,s=t.getBoundingInfo().boundingBox.minimumWorld.z;var u=this.position.x+this._pcs.mesh.position.x,f=this.position.y+this._pcs.mesh.position.y,l=this.position.z+this._pcs.mesh.position.z;return r<=u&&u<=i&&n<=f&&f<=a&&s<=l&&l<=h},o.prototype.getRotationMatrix=function(t){var e;if(this.rotationQuaternion)e=this.rotationQuaternion;else{e=O.Quaternion[0];var i=this.rotation;St.RotationYawPitchRollToRef(i.y,i.x,i.z,e)}e.toRotationMatrix(t)},o}(),vt=function(){function o(t,e){this.groupId=t,this._positionFunction=e}return Object.defineProperty(o.prototype,"groupID",{get:function(){return this.groupId},set:function(t){this.groupId=t},enumerable:!1,configurable:!0}),o}(),ae;(function(o){o[o.Color=2]="Color",o[o.UV=1]="UV",o[o.Random=0]="Random",o[o.Stated=3]="Stated"})(ae||(ae={}));(function(){function o(t,e,i,r){this.particles=new Array,this.nbParticles=0,this.counter=0,this.vars={},this._promises=[],this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._updatable=!0,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._groups=new Array,this._groupCounter=0,this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeBoundingBox=!1,this._isReady=!1,this.name=t,this._size=e,this._scene=i||We.LastCreatedScene,r&&r.updatable!==void 0?this._updatable=r.updatable:this._updatable=!0}return Object.defineProperty(o.prototype,"positions",{get:function(){return this._positions32},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"colors",{get:function(){return this._colors32},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"uvs",{get:function(){return this._uvs32},enumerable:!1,configurable:!0}),o.prototype.buildMeshAsync=function(t){var e=this;return Promise.all(this._promises).then(function(){return e._isReady=!0,e._buildMesh(t)})},o.prototype._buildMesh=function(t){this.nbParticles===0&&this.addPoints(1),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors);var e=new ht;e.set(this._positions32,z.PositionKind),this._uvs32.length>0&&e.set(this._uvs32,z.UVKind);var i=0;this._colors32.length>0&&(i=1,e.set(this._colors32,z.ColorKind));var r=new dt(this.name,this._scene);e.applyToMesh(r,this._updatable),this.mesh=r,this._positions=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0);var a=t;return a||(a=new Tt("point cloud material",this._scene),a.emissiveColor=new Me(i,i,i),a.disableLighting=!0,a.pointsCloud=!0,a.pointSize=this._size),r.material=a,new Promise(function(n){return n(r)})},o.prototype._addParticle=function(t,e,i,r){var a=new Ti(t,e,i,r,this);return this.particles.push(a),a},o.prototype._randomUnitVector=function(t){t.position=new c(Math.random(),Math.random(),Math.random()),t.color=new H(1,1,1,1)},o.prototype._getColorIndicesForCoord=function(t,e,i,r){var a=t._groupImageData,n=i*(r*4)+e*4,h=[n,n+1,n+2,n+3],s=h[0],u=h[1],f=h[2],l=h[3],p=a[s],_=a[u],v=a[f],m=a[l];return new H(p/255,_/255,v/255,m)},o.prototype._setPointsColorOrUV=function(t,e,i,r,a,n,h){i&&t.updateFacetData();var s=t.getBoundingInfo(),u=2*s.boundingSphere.radius,f=t.getVerticesData(z.PositionKind),l=t.getIndices(),p=t.getVerticesData(z.UVKind),_=t.getVerticesData(z.ColorKind),v=c.Zero();t.computeWorldMatrix();var m=t.getWorldMatrix();if(!m.isIdentity()){f=f.slice(0);for(var x=0;x<f.length/3;x++)c.TransformCoordinatesFromFloatsToRef(f[3*x],f[3*x+1],f[3*x+2],m,v),f[3*x]=v.x,f[3*x+1]=v.y,f[3*x+2]=v.z}var d=0,T=0,B=0,w=0,C=0,P=0,V=0,N=0,K=0,M=0,g=0,I=0,E=0,F=c.Zero(),S=c.Zero(),y=c.Zero(),G=c.Zero(),X=c.Zero(),k=0,Y=0,A=0,j=0,J=0,D=0,Z=Te.Zero(),oe=Te.Zero(),Q=Te.Zero(),q=Te.Zero(),ie=Te.Zero(),ee=0,re=0,le=0,R=0,ce=0,U=0,se=0,ne=0,L=0,ue=0,Qe=0,at=0,me=Se.Zero(),Ie=Se.Zero(),ke=Se.Zero(),qe=Se.Zero(),je=Se.Zero(),pe=0,De=0;h=h||0;for(var ve,Pe,W=new Se(0,0,0,0),Re=c.Zero(),Fe=c.Zero(),we=c.Zero(),te=0,Ve=c.Zero(),Je=0,ot=0,Ye=new mi(c.Zero(),new c(1,0,0)),Le,Be=c.Zero(),de=0;de<l.length/3;de++){T=l[3*de],B=l[3*de+1],w=l[3*de+2],C=f[3*T],P=f[3*T+1],V=f[3*T+2],N=f[3*B],K=f[3*B+1],M=f[3*B+2],g=f[3*w],I=f[3*w+1],E=f[3*w+2],F.set(C,P,V),S.set(N,K,M),y.set(g,I,E),S.subtractToRef(F,G),y.subtractToRef(S,X),p&&(k=p[2*T],Y=p[2*T+1],A=p[2*B],j=p[2*B+1],J=p[2*w],D=p[2*w+1],Z.set(k,Y),oe.set(A,j),Q.set(J,D),oe.subtractToRef(Z,q),Q.subtractToRef(oe,ie)),_&&r&&(ee=_[4*T],re=_[4*T+1],le=_[4*T+2],R=_[4*T+3],ce=_[4*B],U=_[4*B+1],se=_[4*B+2],ne=_[4*B+3],L=_[4*w],ue=_[4*w+1],Qe=_[4*w+2],at=_[4*w+3],me.set(ee,re,le,R),Ie.set(ce,U,se,ne),ke.set(L,ue,Qe,at),Ie.subtractToRef(me,qe),ke.subtractToRef(Ie,je));for(var ze=void 0,Ee=void 0,Ze=void 0,He=void 0,Ke=void 0,ge=void 0,ye=void 0,Oe=void 0,$e=new Me(0,0,0),Ne=new Me(0,0,0),xe=void 0,he=void 0,et=0;et<e._groupDensity[de];et++)d=this.particles.length,this._addParticle(d,e,this._groupCounter,de+et),he=this.particles[d],pe=b.RandomRange(0,1),De=b.RandomRange(0,1),ve=F.add(G.scale(pe)).add(X.scale(pe*De)),i&&(Re=t.getFacetNormal(de).normalize().scale(-1),Fe=G.clone().normalize(),we=c.Cross(Re,Fe),te=b.RandomRange(0,2*Math.PI),Ve=Fe.scale(Math.cos(te)).add(we.scale(Math.sin(te))),te=b.RandomRange(.1,Math.PI/2),Be=Ve.scale(Math.cos(te)).add(Re.scale(Math.sin(te))),Ye.origin=ve.add(Be.scale(1e-5)),Ye.direction=Be,Ye.length=u,Le=Ye.intersectsMesh(t),Le.hit&&(ot=Le.pickedPoint.subtract(ve).length(),Je=b.RandomRange(0,1)*ot,ve.addInPlace(Be.scale(Je)))),he.position=ve.clone(),this._positions.push(he.position.x,he.position.y,he.position.z),r!==void 0?p&&(Pe=Z.add(q.scale(pe)).add(ie.scale(pe*De)),r?a&&e._groupImageData!==null?(ze=e._groupImgWidth,Ee=e._groupImgHeight,xe=this._getColorIndicesForCoord(e,Math.round(Pe.x*ze),Math.round(Pe.y*Ee),ze),he.color=xe,this._colors.push(xe.r,xe.g,xe.b,xe.a)):_?(W=me.add(qe.scale(pe)).add(je.scale(pe*De)),he.color=new H(W.x,W.y,W.z,W.w),this._colors.push(W.x,W.y,W.z,W.w)):(W=me.set(Math.random(),Math.random(),Math.random(),1),he.color=new H(W.x,W.y,W.z,W.w),this._colors.push(W.x,W.y,W.z,W.w)):(he.uv=Pe.clone(),this._uvs.push(he.uv.x,he.uv.y))):(n?($e.set(n.r,n.g,n.b),Ze=b.RandomRange(-h,h),He=b.RandomRange(-h,h),Oe=$e.toHSV(),Ke=Oe.r,ge=Oe.g+Ze,ye=Oe.b+He,ge<0&&(ge=0),ge>1&&(ge=1),ye<0&&(ye=0),ye>1&&(ye=1),Me.HSVtoRGBToRef(Ke,ge,ye,Ne),W.set(Ne.r,Ne.g,Ne.b,1)):W=me.set(Math.random(),Math.random(),Math.random(),1),he.color=new H(W.x,W.y,W.z,W.w),this._colors.push(W.x,W.y,W.z,W.w))}},o.prototype._colorFromTexture=function(t,e,i){var r=this;if(t.material===null){Et.Warn(t.name+"has no material."),e._groupImageData=null,this._setPointsColorOrUV(t,e,i,!0,!1);return}var a=t.material,n=a.getActiveTextures();if(n.length===0){Et.Warn(t.name+"has no usable texture."),e._groupImageData=null,this._setPointsColorOrUV(t,e,i,!0,!1);return}var h=t.clone();h.setEnabled(!1),this._promises.push(new Promise(function(s){oi.WhenAllReady(n,function(){var u=e._textureNb;u<0&&(u=0),u>n.length-1&&(u=n.length-1);var f=function(){e._groupImgWidth=n[u].getSize().width,e._groupImgHeight=n[u].getSize().height,r._setPointsColorOrUV(h,e,i,!0,!0),h.dispose(),s()};e._groupImageData=null;var l=n[u].readPixels();l?l.then(function(p){e._groupImageData=p,f()}):f()})}))},o.prototype._calculateDensity=function(t,e,i){for(var r=new Array,a,n,h,s,u,f,l,p,_,v,m,x,d=c.Zero(),T=c.Zero(),B=c.Zero(),w=c.Zero(),C=c.Zero(),P=c.Zero(),V,N,K,M,g,I=new Array,E=0,F=i.length/3,S=0;S<F;S++)a=i[3*S],n=i[3*S+1],h=i[3*S+2],s=e[3*a],u=e[3*a+1],f=e[3*a+2],l=e[3*n],p=e[3*n+1],_=e[3*n+2],v=e[3*h],m=e[3*h+1],x=e[3*h+2],d.set(s,u,f),T.set(l,p,_),B.set(v,m,x),T.subtractToRef(d,w),B.subtractToRef(T,C),B.subtractToRef(d,P),V=w.length(),N=C.length(),K=P.length(),M=(V+N+K)/2,g=Math.sqrt(M*(M-V)*(M-N)*(M-K)),E+=g,I[S]=g;for(var y=0,S=0;S<F;S++)r[S]=Math.floor(t*I[S]/E),y+=r[S];var G=t-y,X=Math.floor(G/F),k=G%F;X>0&&(r=r.map(function(Y){return Y+X}));for(var S=0;S<k;S++)r[S]+=1;return r},o.prototype.addPoints=function(t,e){e===void 0&&(e=this._randomUnitVector);for(var i=new vt(this._groupCounter,e),r,a=this.nbParticles,n=0;n<t;n++)r=this._addParticle(a,i,this._groupCounter,n),i&&i._positionFunction&&i._positionFunction(r,a,n),this._positions.push(r.position.x,r.position.y,r.position.z),r.color&&this._colors.push(r.color.r,r.color.g,r.color.b,r.color.a),r.uv&&this._uvs.push(r.uv.x,r.uv.y),a++;return this.nbParticles+=t,this._groupCounter++,this._groupCounter},o.prototype.addSurfacePoints=function(t,e,i,r,a){var n=i||ae.Random;(isNaN(n)||n<0||n>3)&&(n=ae.Random);var h=t.getVerticesData(z.PositionKind),s=t.getIndices();this._groups.push(this._groupCounter);var u=new vt(this._groupCounter,null);switch(u._groupDensity=this._calculateDensity(e,h,s),n===ae.Color?u._textureNb=r||0:r=r||new H(1,1,1,1),n){case ae.Color:this._colorFromTexture(t,u,!1);break;case ae.UV:this._setPointsColorOrUV(t,u,!1,!1,!1);break;case ae.Random:this._setPointsColorOrUV(t,u,!1);break;case ae.Stated:this._setPointsColorOrUV(t,u,!1,void 0,void 0,r,a);break}return this.nbParticles+=e,this._groupCounter++,this._groupCounter-1},o.prototype.addVolumePoints=function(t,e,i,r,a){var n=i||ae.Random;(isNaN(n)||n<0||n>3)&&(n=ae.Random);var h=t.getVerticesData(z.PositionKind),s=t.getIndices();this._groups.push(this._groupCounter);var u=new vt(this._groupCounter,null);switch(u._groupDensity=this._calculateDensity(e,h,s),n===ae.Color?u._textureNb=r||0:r=r||new H(1,1,1,1),n){case ae.Color:this._colorFromTexture(t,u,!0);break;case ae.UV:this._setPointsColorOrUV(t,u,!0,!1,!1);break;case ae.Random:this._setPointsColorOrUV(t,u,!0);break;case ae.Stated:this._setPointsColorOrUV(t,u,!0,void 0,void 0,r,a);break}return this.nbParticles+=e,this._groupCounter++,this._groupCounter-1},o.prototype.setParticles=function(t,e,i){if(t===void 0&&(t=0),e===void 0&&(e=this.nbParticles-1),i===void 0&&(i=!0),!this._updatable||!this._isReady)return this;this.beforeUpdateParticles(t,e,i);var r=O.Matrix[0],a=this.mesh,n=this._colors32,h=this._positions32,s=this._uvs32,u=O.Vector3,f=u[5].copyFromFloats(1,0,0),l=u[6].copyFromFloats(0,1,0),p=u[7].copyFromFloats(0,0,1),_=u[8].setAll(Number.MAX_VALUE),v=u[9].setAll(-Number.MAX_VALUE);Ge.IdentityToRef(r);var m=0;if(this.mesh.isFacetDataEnabled&&(this._computeBoundingBox=!0),e=e>=this.nbParticles?this.nbParticles-1:e,this._computeBoundingBox&&(t!=0||e!=this.nbParticles-1)){var x=this.mesh.getBoundingInfo();x&&(_.copyFrom(x.minimum),v.copyFrom(x.maximum))}m=0;for(var d=0,T=0,B=0,w=t;w<=e;w++){var C=this.particles[w];m=C.idx,d=3*m,T=4*m,B=2*m,this.updateParticle(C);var P=C._rotationMatrix,V=C.position,N=C._globalPosition;this._computeParticleRotation&&C.getRotationMatrix(r);var K=C.parentId!==null;if(K){var M=this.particles[C.parentId],g=M._rotationMatrix,I=M._globalPosition,E=V.x*g[1]+V.y*g[4]+V.z*g[7],F=V.x*g[0]+V.y*g[3]+V.z*g[6],S=V.x*g[2]+V.y*g[5]+V.z*g[8];if(N.x=I.x+F,N.y=I.y+E,N.z=I.z+S,this._computeParticleRotation){var y=r.m;P[0]=y[0]*g[0]+y[1]*g[3]+y[2]*g[6],P[1]=y[0]*g[1]+y[1]*g[4]+y[2]*g[7],P[2]=y[0]*g[2]+y[1]*g[5]+y[2]*g[8],P[3]=y[4]*g[0]+y[5]*g[3]+y[6]*g[6],P[4]=y[4]*g[1]+y[5]*g[4]+y[6]*g[7],P[5]=y[4]*g[2]+y[5]*g[5]+y[6]*g[8],P[6]=y[8]*g[0]+y[9]*g[3]+y[10]*g[6],P[7]=y[8]*g[1]+y[9]*g[4]+y[10]*g[7],P[8]=y[8]*g[2]+y[9]*g[5]+y[10]*g[8]}}else if(N.x=0,N.y=0,N.z=0,this._computeParticleRotation){var y=r.m;P[0]=y[0],P[1]=y[1],P[2]=y[2],P[3]=y[4],P[4]=y[5],P[5]=y[6],P[6]=y[8],P[7]=y[9],P[8]=y[10]}var G=u[11];C.translateFromPivot?G.setAll(0):G.copyFrom(C.pivot);var X=u[0];X.copyFrom(C.position);var k=X.x-C.pivot.x,Y=X.y-C.pivot.y,A=X.z-C.pivot.z,j=k*P[0]+Y*P[3]+A*P[6],J=k*P[1]+Y*P[4]+A*P[7],D=k*P[2]+Y*P[5]+A*P[8];j+=G.x,J+=G.y,D+=G.z;var Z=h[d]=N.x+f.x*j+l.x*J+p.x*D,oe=h[d+1]=N.y+f.y*j+l.y*J+p.y*D,Q=h[d+2]=N.z+f.z*j+l.z*J+p.z*D;if(this._computeBoundingBox&&(_.minimizeInPlaceFromFloats(Z,oe,Q),v.maximizeInPlaceFromFloats(Z,oe,Q)),this._computeParticleColor&&C.color){var q=C.color,ie=this._colors32;ie[T]=q.r,ie[T+1]=q.g,ie[T+2]=q.b,ie[T+3]=q.a}if(this._computeParticleTexture&&C.uv){var ee=C.uv,re=this._uvs32;re[B]=ee.x,re[B+1]=ee.y}}return i&&(this._computeParticleColor&&a.updateVerticesData(z.ColorKind,n,!1,!1),this._computeParticleTexture&&a.updateVerticesData(z.UVKind,s,!1,!1),a.updateVerticesData(z.PositionKind,h,!1,!1)),this._computeBoundingBox&&(a.hasBoundingInfo?a.getBoundingInfo().reConstruct(_,v,a._worldMatrix):a.buildBoundingInfo(_,v,a._worldMatrix)),this.afterUpdateParticles(t,e,i),this},o.prototype.dispose=function(){this.mesh.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._uvs32=null,this._colors32=null},o.prototype.refreshVisibleSize=function(){return this._isVisibilityBoxLocked||this.mesh.refreshBoundingInfo(),this},o.prototype.setVisibilityBox=function(t){var e=t/2;this.mesh.buildBoundingInfo(new c(-e,-e,-e),new c(e,e,e))},Object.defineProperty(o.prototype,"isAlwaysVisible",{get:function(){return this._alwaysVisible},set:function(t){this._alwaysVisible=t,this.mesh.alwaysSelectAsActiveMesh=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"computeParticleRotation",{set:function(t){this._computeParticleRotation=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"computeParticleColor",{get:function(){return this._computeParticleColor},set:function(t){this._computeParticleColor=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"computeParticleTexture",{get:function(){return this._computeParticleTexture},set:function(t){this._computeParticleTexture=t},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"computeBoundingBox",{get:function(){return this._computeBoundingBox},set:function(t){this._computeBoundingBox=t},enumerable:!1,configurable:!0}),o.prototype.initParticles=function(){},o.prototype.recycleParticle=function(t){return t},o.prototype.updateParticle=function(t){return t},o.prototype.beforeUpdateParticles=function(t,e,i){},o.prototype.afterUpdateParticles=function(t,e,i){},o})();export{Yt as B,Zt as G,$ as P};
