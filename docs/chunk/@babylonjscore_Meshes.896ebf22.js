import{T as z,a as O,c as be,b as De,k as cr,l as dt,M as X,Q as ce,e as Te,E as xe,C as we,A as vt,V as le,m as He,n as dr,o as ot,p as oe,d as ut,_ as ne}from"./@babylonjscore_Maths.42afce42.js";import{D as gt,V as _,B as ke}from"./@babylonjscore_Buffers.c351261b.js";import{L as ue,aj as _t,v as vr,w as gr,_ as se,ai as We,ak as _r,T as de,a as ye,S as Ue,d as Ge,al as pr,b as Re,O as me,R as pt,am as Ae,G as ft,an as mr,D as mt,ao as yr,ap as br}from"./@babylonjscore_Misc.329df4d9.js";import{_ as _e,d as Xe,a as ge}from"./tslibtslib.b6e59fa7.js";import{E as Qe,a as Dr}from"./@babylonjscore_Engines.a7c830c0.js";import{N as je}from"./@babylonjscore_node.43bedde8.js";import{I as ht,P as Ir,_ as Mr}from"./@babylonjscore_Collisions.8a0e928d.js";import{B as Pe}from"./@babylonjscore_Culling.f738e368.js";import{d as xr,U as Ar,M as ve,n as lt,c as Sr}from"./@babylonjscore_Materials.49fd589a.js";import{a as yt}from"./@babylonjscore_Loading.1653106a.js";import{C as j}from"./@babylonjscore_Compat.1e5a884f.js";import{S as ze}from"./@babylonjscore_sceneComponent.5f0854c6.js";import"./@babylonjscore_Shaders.eb9cec10.js";import{S as bt}from"./@babylonjscore_scene.b072ee35.js";var fi=function(n){_e(t,n);function t(e){var r=n.call(this)||this;return r._buffer=e,r}return Object.defineProperty(t.prototype,"underlyingResource",{get:function(){return this._buffer},enumerable:!1,configurable:!0}),t}(gt),Q=function(){function n(){this._applyTo=_r(this._applyToCoroutine.bind(this))}return n.prototype.set=function(t,e){switch(t.length||ue.Warn("Setting vertex data kind '".concat(e,"' with an empty array")),e){case _.PositionKind:this.positions=t;break;case _.NormalKind:this.normals=t;break;case _.TangentKind:this.tangents=t;break;case _.UVKind:this.uvs=t;break;case _.UV2Kind:this.uvs2=t;break;case _.UV3Kind:this.uvs3=t;break;case _.UV4Kind:this.uvs4=t;break;case _.UV5Kind:this.uvs5=t;break;case _.UV6Kind:this.uvs6=t;break;case _.ColorKind:this.colors=t;break;case _.MatricesIndicesKind:this.matricesIndices=t;break;case _.MatricesWeightsKind:this.matricesWeights=t;break;case _.MatricesIndicesExtraKind:this.matricesIndicesExtra=t;break;case _.MatricesWeightsExtraKind:this.matricesWeightsExtra=t;break}},n.prototype.applyToMesh=function(t,e){return this._applyTo(t,e,!1),this},n.prototype.applyToGeometry=function(t,e){return this._applyTo(t,e,!1),this},n.prototype.updateMesh=function(t){return this._update(t),this},n.prototype.updateGeometry=function(t){return this._update(t),this},n.prototype._applyToCoroutine=function(t,e,r){return e===void 0&&(e=!1),Xe(this,function(i){switch(i.label){case 0:return this.positions?(t.setVerticesData(_.PositionKind,this.positions,e),r?[4]:[3,2]):[3,2];case 1:i.sent(),i.label=2;case 2:return this.normals?(t.setVerticesData(_.NormalKind,this.normals,e),r?[4]:[3,4]):[3,4];case 3:i.sent(),i.label=4;case 4:return this.tangents?(t.setVerticesData(_.TangentKind,this.tangents,e),r?[4]:[3,6]):[3,6];case 5:i.sent(),i.label=6;case 6:return this.uvs?(t.setVerticesData(_.UVKind,this.uvs,e),r?[4]:[3,8]):[3,8];case 7:i.sent(),i.label=8;case 8:return this.uvs2?(t.setVerticesData(_.UV2Kind,this.uvs2,e),r?[4]:[3,10]):[3,10];case 9:i.sent(),i.label=10;case 10:return this.uvs3?(t.setVerticesData(_.UV3Kind,this.uvs3,e),r?[4]:[3,12]):[3,12];case 11:i.sent(),i.label=12;case 12:return this.uvs4?(t.setVerticesData(_.UV4Kind,this.uvs4,e),r?[4]:[3,14]):[3,14];case 13:i.sent(),i.label=14;case 14:return this.uvs5?(t.setVerticesData(_.UV5Kind,this.uvs5,e),r?[4]:[3,16]):[3,16];case 15:i.sent(),i.label=16;case 16:return this.uvs6?(t.setVerticesData(_.UV6Kind,this.uvs6,e),r?[4]:[3,18]):[3,18];case 17:i.sent(),i.label=18;case 18:return this.colors?(t.setVerticesData(_.ColorKind,this.colors,e),r?[4]:[3,20]):[3,20];case 19:i.sent(),i.label=20;case 20:return this.matricesIndices?(t.setVerticesData(_.MatricesIndicesKind,this.matricesIndices,e),r?[4]:[3,22]):[3,22];case 21:i.sent(),i.label=22;case 22:return this.matricesWeights?(t.setVerticesData(_.MatricesWeightsKind,this.matricesWeights,e),r?[4]:[3,24]):[3,24];case 23:i.sent(),i.label=24;case 24:return this.matricesIndicesExtra?(t.setVerticesData(_.MatricesIndicesExtraKind,this.matricesIndicesExtra,e),r?[4]:[3,26]):[3,26];case 25:i.sent(),i.label=26;case 26:return this.matricesWeightsExtra?(t.setVerticesData(_.MatricesWeightsExtraKind,this.matricesWeightsExtra,e),r?[4]:[3,28]):[3,28];case 27:i.sent(),i.label=28;case 28:return this.indices?(t.setIndices(this.indices,null,e),r?[4]:[3,30]):[3,31];case 29:i.sent(),i.label=30;case 30:return[3,32];case 31:t.setIndices([],null),i.label=32;case 32:return[2,this]}})},n.prototype._update=function(t,e,r){return this.positions&&t.updateVerticesData(_.PositionKind,this.positions,e,r),this.normals&&t.updateVerticesData(_.NormalKind,this.normals,e,r),this.tangents&&t.updateVerticesData(_.TangentKind,this.tangents,e,r),this.uvs&&t.updateVerticesData(_.UVKind,this.uvs,e,r),this.uvs2&&t.updateVerticesData(_.UV2Kind,this.uvs2,e,r),this.uvs3&&t.updateVerticesData(_.UV3Kind,this.uvs3,e,r),this.uvs4&&t.updateVerticesData(_.UV4Kind,this.uvs4,e,r),this.uvs5&&t.updateVerticesData(_.UV5Kind,this.uvs5,e,r),this.uvs6&&t.updateVerticesData(_.UV6Kind,this.uvs6,e,r),this.colors&&t.updateVerticesData(_.ColorKind,this.colors,e,r),this.matricesIndices&&t.updateVerticesData(_.MatricesIndicesKind,this.matricesIndices,e,r),this.matricesWeights&&t.updateVerticesData(_.MatricesWeightsKind,this.matricesWeights,e,r),this.matricesIndicesExtra&&t.updateVerticesData(_.MatricesIndicesExtraKind,this.matricesIndicesExtra,e,r),this.matricesWeightsExtra&&t.updateVerticesData(_.MatricesWeightsExtraKind,this.matricesWeightsExtra,e,r),this.indices&&t.setIndices(this.indices,null),this},n._TransformVector3Coordinates=function(t,e,r,i){r===void 0&&(r=0),i===void 0&&(i=t.length);for(var a=z.Vector3[0],o=z.Vector3[1],s=r;s<r+i;s+=3)O.FromArrayToRef(t,s,a),O.TransformCoordinatesToRef(a,e,o),t[s]=o.x,t[s+1]=o.y,t[s+2]=o.z},n._TransformVector3Normals=function(t,e,r,i){r===void 0&&(r=0),i===void 0&&(i=t.length);for(var a=z.Vector3[0],o=z.Vector3[1],s=r;s<r+i;s+=3)O.FromArrayToRef(t,s,a),O.TransformNormalToRef(a,e,o),t[s]=o.x,t[s+1]=o.y,t[s+2]=o.z},n._TransformVector4Normals=function(t,e,r,i){r===void 0&&(r=0),i===void 0&&(i=t.length);for(var a=z.Vector4[0],o=z.Vector4[1],s=r;s<r+i;s+=4)be.FromArrayToRef(t,s,a),be.TransformNormalToRef(a,e,o),t[s]=o.x,t[s+1]=o.y,t[s+2]=o.z,t[s+3]=o.w},n._FlipFaces=function(t,e,r){e===void 0&&(e=0),r===void 0&&(r=t.length);for(var i=e;i<e+r;i+=3){var a=t[i+1];t[i+1]=t[i+2],t[i+2]=a}},n.prototype.transform=function(t){var e=t.determinant()<0;return this.positions&&n._TransformVector3Coordinates(this.positions,t),this.normals&&n._TransformVector3Normals(this.normals,t),this.tangents&&n._TransformVector4Normals(this.tangents,t),e&&this.indices&&n._FlipFaces(this.indices),this},n.prototype.merge=function(t,e,r){e===void 0&&(e=!1),r===void 0&&(r=!1);var i=Array.isArray(t)?t.map(function(a){return[a,void 0]}):[[t,void 0]];return _t(this._mergeCoroutine(void 0,i,e,!1,r))},n.prototype._mergeCoroutine=function(t,e,r,i,a){var o,s,u,M,f,l,c,h,d,v,g,p,m,M,A,y,b=this,x,I,D,T;return r===void 0&&(r=!1),Xe(this,function(C){switch(C.label){case 0:for(this._validate(),o=e.map(function(B){return B[0]}),s=0,u=o;s<u.length;s++)if(M=u[s],M._validate(),!this.normals!=!M.normals||!this.tangents!=!M.tangents||!this.uvs!=!M.uvs||!this.uvs2!=!M.uvs2||!this.uvs3!=!M.uvs3||!this.uvs4!=!M.uvs4||!this.uvs5!=!M.uvs5||!this.uvs6!=!M.uvs6||!this.colors!=!M.colors||!this.matricesIndices!=!M.matricesIndices||!this.matricesWeights!=!M.matricesWeights||!this.matricesIndicesExtra!=!M.matricesIndicesExtra||!this.matricesWeightsExtra!=!M.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes");if(f=o.reduce(function(B,V){var U,R;return B+((R=(U=V.indices)===null||U===void 0?void 0:U.length)!==null&&R!==void 0?R:0)},(I=(x=this.indices)===null||x===void 0?void 0:x.length)!==null&&I!==void 0?I:0),l=a||o.some(function(B){return B.indices===b.indices}),c=l?(D=this.indices)===null||D===void 0?void 0:D.slice():this.indices,!(f>0))return[3,4];h=(T=c==null?void 0:c.length)!==null&&T!==void 0?T:0,c||(c=new Array(f)),c.length!==f&&(Array.isArray(c)?c.length=f:(d=r||c instanceof Uint32Array?new Uint32Array(f):new Uint16Array(f),d.set(c),c=d),t&&t.determinant()<0&&n._FlipFaces(c,0,h)),v=this.positions?this.positions.length/3:0,g=0,p=e,C.label=1;case 1:if(!(g<p.length))return[3,4];if(m=p[g],M=m[0],A=m[1],!M.indices)return[3,3];for(y=0;y<M.indices.length;y++)c[h+y]=M.indices[y]+v;return A&&A.determinant()<0&&n._FlipFaces(c,h,M.indices.length),v+=M.positions.length/3,h+=M.indices.length,i?[4]:[3,3];case 2:C.sent(),C.label=3;case 3:return g++,[3,1];case 4:return this.indices=c,this.positions=n._MergeElement(_.PositionKind,this.positions,t,e.map(function(B){return[B[0].positions,B[1]]})),i?[4]:[3,6];case 5:C.sent(),C.label=6;case 6:return this.normals=n._MergeElement(_.NormalKind,this.normals,t,e.map(function(B){return[B[0].normals,B[1]]})),i?[4]:[3,8];case 7:C.sent(),C.label=8;case 8:return this.tangents=n._MergeElement(_.TangentKind,this.tangents,t,e.map(function(B){return[B[0].tangents,B[1]]})),i?[4]:[3,10];case 9:C.sent(),C.label=10;case 10:return this.uvs=n._MergeElement(_.UVKind,this.uvs,t,e.map(function(B){return[B[0].uvs,B[1]]})),i?[4]:[3,12];case 11:C.sent(),C.label=12;case 12:return this.uvs2=n._MergeElement(_.UV2Kind,this.uvs2,t,e.map(function(B){return[B[0].uvs2,B[1]]})),i?[4]:[3,14];case 13:C.sent(),C.label=14;case 14:return this.uvs3=n._MergeElement(_.UV3Kind,this.uvs3,t,e.map(function(B){return[B[0].uvs3,B[1]]})),i?[4]:[3,16];case 15:C.sent(),C.label=16;case 16:return this.uvs4=n._MergeElement(_.UV4Kind,this.uvs4,t,e.map(function(B){return[B[0].uvs4,B[1]]})),i?[4]:[3,18];case 17:C.sent(),C.label=18;case 18:return this.uvs5=n._MergeElement(_.UV5Kind,this.uvs5,t,e.map(function(B){return[B[0].uvs5,B[1]]})),i?[4]:[3,20];case 19:C.sent(),C.label=20;case 20:return this.uvs6=n._MergeElement(_.UV6Kind,this.uvs6,t,e.map(function(B){return[B[0].uvs6,B[1]]})),i?[4]:[3,22];case 21:C.sent(),C.label=22;case 22:return this.colors=n._MergeElement(_.ColorKind,this.colors,t,e.map(function(B){return[B[0].colors,B[1]]})),i?[4]:[3,24];case 23:C.sent(),C.label=24;case 24:return this.matricesIndices=n._MergeElement(_.MatricesIndicesKind,this.matricesIndices,t,e.map(function(B){return[B[0].matricesIndices,B[1]]})),i?[4]:[3,26];case 25:C.sent(),C.label=26;case 26:return this.matricesWeights=n._MergeElement(_.MatricesWeightsKind,this.matricesWeights,t,e.map(function(B){return[B[0].matricesWeights,B[1]]})),i?[4]:[3,28];case 27:C.sent(),C.label=28;case 28:return this.matricesIndicesExtra=n._MergeElement(_.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,e.map(function(B){return[B[0].matricesIndicesExtra,B[1]]})),i?[4]:[3,30];case 29:C.sent(),C.label=30;case 30:return this.matricesWeightsExtra=n._MergeElement(_.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,e.map(function(B){return[B[0].matricesWeightsExtra,B[1]]})),[2,this]}})},n._MergeElement=function(t,e,r,i){var a=i.filter(function(b){return b[0]!==null&&b[0]!==void 0});if(!e&&a.length==0)return e;if(!e)return this._MergeElement(t,a[0][0],a[0][1],a.slice(1));var o=a.reduce(function(b,x){return b+x[0].length},e.length),s=t===_.PositionKind?n._TransformVector3Coordinates:t===_.NormalKind?n._TransformVector3Normals:t===_.TangentKind?n._TransformVector4Normals:function(){};if(e instanceof Float32Array){var u=new Float32Array(o);u.set(e),r&&s(u,r,0,e.length);for(var f=e.length,l=0,c=a;l<c.length;l++){var h=c[l],d=h[0],v=h[1];u.set(d,f),v&&s(u,v,f,d.length),f+=d.length}return u}else{for(var g=new Array(o),p=0;p<e.length;p++)g[p]=e[p];r&&s(g,r,0,e.length);for(var f=e.length,m=0,M=a;m<M.length;m++){for(var A=M[m],d=A[0],y=A[1],p=0;p<d.length;p++)g[f+p]=d[p];y&&s(g,y,f,d.length),f+=d.length}return g}},n.prototype._validate=function(){if(!this.positions)throw new vr("Positions are required",gr.MeshInvalidPositionsError);var t=function(i,a){var o=_.DeduceStride(i);if(a.length%o!==0)throw new Error("The "+i+"s array count must be a multiple of "+o);return a.length/o},e=t(_.PositionKind,this.positions),r=function(i,a){var o=t(i,a);if(o!==e)throw new Error("The "+i+"s element count ("+o+") does not match the positions count ("+e+")")};this.normals&&r(_.NormalKind,this.normals),this.tangents&&r(_.TangentKind,this.tangents),this.uvs&&r(_.UVKind,this.uvs),this.uvs2&&r(_.UV2Kind,this.uvs2),this.uvs3&&r(_.UV3Kind,this.uvs3),this.uvs4&&r(_.UV4Kind,this.uvs4),this.uvs5&&r(_.UV5Kind,this.uvs5),this.uvs6&&r(_.UV6Kind,this.uvs6),this.colors&&r(_.ColorKind,this.colors),this.matricesIndices&&r(_.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&r(_.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&r(_.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&r(_.MatricesWeightsExtraKind,this.matricesWeightsExtra)},n.prototype.serialize=function(){var t={};return this.positions&&(t.positions=this.positions),this.normals&&(t.normals=this.normals),this.tangents&&(t.tangents=this.tangents),this.uvs&&(t.uvs=this.uvs),this.uvs2&&(t.uvs2=this.uvs2),this.uvs3&&(t.uvs3=this.uvs3),this.uvs4&&(t.uvs4=this.uvs4),this.uvs5&&(t.uvs5=this.uvs5),this.uvs6&&(t.uvs6=this.uvs6),this.colors&&(t.colors=this.colors),this.matricesIndices&&(t.matricesIndices=this.matricesIndices,t.matricesIndices._isExpanded=!0),this.matricesWeights&&(t.matricesWeights=this.matricesWeights),this.matricesIndicesExtra&&(t.matricesIndicesExtra=this.matricesIndicesExtra,t.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(t.matricesWeightsExtra=this.matricesWeightsExtra),t.indices=this.indices,t},n.ExtractFromMesh=function(t,e,r){return n._ExtractFrom(t,e,r)},n.ExtractFromGeometry=function(t,e,r){return n._ExtractFrom(t,e,r)},n._ExtractFrom=function(t,e,r){var i=new n;return t.isVerticesDataPresent(_.PositionKind)&&(i.positions=t.getVerticesData(_.PositionKind,e,r)),t.isVerticesDataPresent(_.NormalKind)&&(i.normals=t.getVerticesData(_.NormalKind,e,r)),t.isVerticesDataPresent(_.TangentKind)&&(i.tangents=t.getVerticesData(_.TangentKind,e,r)),t.isVerticesDataPresent(_.UVKind)&&(i.uvs=t.getVerticesData(_.UVKind,e,r)),t.isVerticesDataPresent(_.UV2Kind)&&(i.uvs2=t.getVerticesData(_.UV2Kind,e,r)),t.isVerticesDataPresent(_.UV3Kind)&&(i.uvs3=t.getVerticesData(_.UV3Kind,e,r)),t.isVerticesDataPresent(_.UV4Kind)&&(i.uvs4=t.getVerticesData(_.UV4Kind,e,r)),t.isVerticesDataPresent(_.UV5Kind)&&(i.uvs5=t.getVerticesData(_.UV5Kind,e,r)),t.isVerticesDataPresent(_.UV6Kind)&&(i.uvs6=t.getVerticesData(_.UV6Kind,e,r)),t.isVerticesDataPresent(_.ColorKind)&&(i.colors=t.getVerticesData(_.ColorKind,e,r)),t.isVerticesDataPresent(_.MatricesIndicesKind)&&(i.matricesIndices=t.getVerticesData(_.MatricesIndicesKind,e,r)),t.isVerticesDataPresent(_.MatricesWeightsKind)&&(i.matricesWeights=t.getVerticesData(_.MatricesWeightsKind,e,r)),t.isVerticesDataPresent(_.MatricesIndicesExtraKind)&&(i.matricesIndicesExtra=t.getVerticesData(_.MatricesIndicesExtraKind,e,r)),t.isVerticesDataPresent(_.MatricesWeightsExtraKind)&&(i.matricesWeightsExtra=t.getVerticesData(_.MatricesWeightsExtraKind,e,r)),i.indices=t.getIndices(e,r),i},n.CreateRibbon=function(t){throw se("ribbonBuilder")},n.CreateBox=function(t){throw se("boxBuilder")},n.CreateTiledBox=function(t){throw se("tiledBoxBuilder")},n.CreateTiledPlane=function(t){throw se("tiledPlaneBuilder")},n.CreateSphere=function(t){throw se("sphereBuilder")},n.CreateCylinder=function(t){throw se("cylinderBuilder")},n.CreateTorus=function(t){throw se("torusBuilder")},n.CreateLineSystem=function(t){throw se("linesBuilder")},n.CreateDashedLines=function(t){throw se("linesBuilder")},n.CreateGround=function(t){throw se("groundBuilder")},n.CreateTiledGround=function(t){throw se("groundBuilder")},n.CreateGroundFromHeightMap=function(t){throw se("groundBuilder")},n.CreatePlane=function(t){throw se("planeBuilder")},n.CreateDisc=function(t){throw se("discBuilder")},n.CreatePolygon=function(t,e,r,i,a,o,s){throw se("polygonBuilder")},n.CreateIcoSphere=function(t){throw se("icoSphereBuilder")},n.CreatePolyhedron=function(t){throw se("polyhedronBuilder")},n.CreateCapsule=function(t){throw t===void 0&&(t={orientation:O.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}),se("capsuleBuilder")},n.CreateTorusKnot=function(t){throw se("torusKnotBuilder")},n.ComputeNormals=function(t,e,r,i){var a=0,o=0,s=0,u=0,f=0,l=0,c=0,h=0,d=0,v=0,g=0,p=0,m=0,M=0,A=0,y=0,b=0,x=0,I=0,D=0,T=!1,C=!1,B=!1,V=!1,U=1,R=0,F=null;i&&(T=!!i.facetNormals,C=!!i.facetPositions,B=!!i.facetPartitioning,U=i.useRightHandedSystem===!0?-1:1,R=i.ratio||0,V=!!i.depthSort,F=i.distanceTo,V&&F===void 0&&(F=O.Zero()));var W=0,K=0,E=0,w=0;for(B&&i&&i.bbSize&&(W=i.subDiv.X*R/i.bbSize.x,K=i.subDiv.Y*R/i.bbSize.y,E=i.subDiv.Z*R/i.bbSize.z,w=i.subDiv.max*i.subDiv.max,i.facetPartitioning.length=0),a=0;a<t.length;a++)r[a]=0;var L=e.length/3|0;for(a=0;a<L;a++){if(p=e[a*3]*3,m=p+1,M=p+2,A=e[a*3+1]*3,y=A+1,b=A+2,x=e[a*3+2]*3,I=x+1,D=x+2,o=t[p]-t[A],s=t[m]-t[y],u=t[M]-t[b],f=t[x]-t[A],l=t[I]-t[y],c=t[D]-t[b],h=U*(s*c-u*l),d=U*(u*f-o*c),v=U*(o*l-s*f),g=Math.sqrt(h*h+d*d+v*v),g=g===0?1:g,h/=g,d/=g,v/=g,T&&i&&(i.facetNormals[a].x=h,i.facetNormals[a].y=d,i.facetNormals[a].z=v),C&&i&&(i.facetPositions[a].x=(t[p]+t[A]+t[x])/3,i.facetPositions[a].y=(t[m]+t[y]+t[I])/3,i.facetPositions[a].z=(t[M]+t[b]+t[D])/3),B&&i){var P=Math.floor((i.facetPositions[a].x-i.bInfo.minimum.x*R)*W),Y=Math.floor((i.facetPositions[a].y-i.bInfo.minimum.y*R)*K),G=Math.floor((i.facetPositions[a].z-i.bInfo.minimum.z*R)*E),H=Math.floor((t[p]-i.bInfo.minimum.x*R)*W),Z=Math.floor((t[m]-i.bInfo.minimum.y*R)*K),q=Math.floor((t[M]-i.bInfo.minimum.z*R)*E),N=Math.floor((t[A]-i.bInfo.minimum.x*R)*W),k=Math.floor((t[y]-i.bInfo.minimum.y*R)*K),ie=Math.floor((t[b]-i.bInfo.minimum.z*R)*E),J=Math.floor((t[x]-i.bInfo.minimum.x*R)*W),ee=Math.floor((t[I]-i.bInfo.minimum.y*R)*K),$=Math.floor((t[D]-i.bInfo.minimum.z*R)*E),ae=H+i.subDiv.max*Z+w*q,te=N+i.subDiv.max*k+w*ie,re=J+i.subDiv.max*ee+w*$,fe=P+i.subDiv.max*Y+w*G;i.facetPartitioning[fe]=i.facetPartitioning[fe]?i.facetPartitioning[fe]:new Array,i.facetPartitioning[ae]=i.facetPartitioning[ae]?i.facetPartitioning[ae]:new Array,i.facetPartitioning[te]=i.facetPartitioning[te]?i.facetPartitioning[te]:new Array,i.facetPartitioning[re]=i.facetPartitioning[re]?i.facetPartitioning[re]:new Array,i.facetPartitioning[ae].push(a),te!=ae&&i.facetPartitioning[te].push(a),re==te||re==ae||i.facetPartitioning[re].push(a),fe==ae||fe==te||fe==re||i.facetPartitioning[fe].push(a)}if(V&&i&&i.facetPositions){var he=i.depthSortedFacets[a];he.ind=a*3,he.sqDistance=O.DistanceSquared(i.facetPositions[a],F)}r[p]+=h,r[m]+=d,r[M]+=v,r[A]+=h,r[y]+=d,r[b]+=v,r[x]+=h,r[I]+=d,r[D]+=v}for(a=0;a<r.length/3;a++)h=r[a*3],d=r[a*3+1],v=r[a*3+2],g=Math.sqrt(h*h+d*d+v*v),g=g===0?1:g,h/=g,d/=g,v/=g,r[a*3]=h,r[a*3+1]=d,r[a*3+2]=v},n._ComputeSides=function(t,e,r,i,a,o,s){var u=r.length,f=i.length,l,c;switch(t=t||n.DEFAULTSIDE,t){case n.FRONTSIDE:break;case n.BACKSIDE:for(l=0;l<u;l+=3){var h=r[l];r[l]=r[l+2],r[l+2]=h}for(c=0;c<f;c++)i[c]=-i[c];break;case n.DOUBLESIDE:{for(var d=e.length,v=d/3,g=0;g<d;g++)e[d+g]=e[g];for(l=0;l<u;l+=3)r[l+u]=r[l+2]+v,r[l+1+u]=r[l+1]+v,r[l+2+u]=r[l]+v;for(c=0;c<f;c++)i[f+c]=-i[c];var p=a.length,m=0;for(m=0;m<p;m++)a[m+p]=a[m];for(o=o||new be(0,0,1,1),s=s||new be(0,0,1,1),m=0,l=0;l<p/2;l++)a[m]=o.x+(o.z-o.x)*a[m],a[m+1]=o.y+(o.w-o.y)*a[m+1],a[m+p]=s.x+(s.z-s.x)*a[m+p],a[m+p+1]=s.y+(s.w-s.y)*a[m+p+1],m+=2;break}}},n.ImportVertexData=function(t,e){var r=new n,i=t.positions;i&&r.set(i,_.PositionKind);var a=t.normals;a&&r.set(a,_.NormalKind);var o=t.tangents;o&&r.set(o,_.TangentKind);var s=t.uvs;s&&r.set(s,_.UVKind);var u=t.uv2s;u&&r.set(u,_.UV2Kind);var f=t.uv3s;f&&r.set(f,_.UV3Kind);var l=t.uv4s;l&&r.set(l,_.UV4Kind);var c=t.uv5s;c&&r.set(c,_.UV5Kind);var h=t.uv6s;h&&r.set(h,_.UV6Kind);var d=t.colors;d&&r.set(De.CheckColors4(d,i.length/3),_.ColorKind);var v=t.matricesIndices;v&&r.set(v,_.MatricesIndicesKind);var g=t.matricesWeights;g&&r.set(g,_.MatricesWeightsKind);var p=t.indices;p&&(r.indices=p),e.setAllVerticesData(r,t.updatable)},n.FRONTSIDE=0,n.BACKSIDE=1,n.DOUBLESIDE=2,n.DEFAULTSIDE=0,ge([We.filter(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=t[0];return!Array.isArray(r)})],n,"_TransformVector3Coordinates",null),ge([We.filter(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=t[0];return!Array.isArray(r)})],n,"_TransformVector3Normals",null),ge([We.filter(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=t[0];return!Array.isArray(r)})],n,"_TransformVector4Normals",null),ge([We.filter(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=t[0];return!Array.isArray(r)})],n,"_FlipFaces",null),n}(),pe=function(){function n(t,e,r,i,a,o,s,u,f){u===void 0&&(u=!0),f===void 0&&(f=!0),this.materialIndex=t,this.verticesStart=e,this.verticesCount=r,this.indexStart=i,this.indexCount=a,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=o,this._renderingMesh=s||o,f&&o.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=o.subMeshes.length-1,u&&(this.refreshBoundingInfo(),o.computeWorldMatrix(!0))}return Object.defineProperty(n.prototype,"materialDefines",{get:function(){var t;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:(t=this._getDrawWrapper())===null||t===void 0?void 0:t.defines},set:function(t){var e,r=(e=this._mainDrawWrapperOverride)!==null&&e!==void 0?e:this._getDrawWrapper(void 0,!0);r.defines=t},enumerable:!1,configurable:!0}),n.prototype._getDrawWrapper=function(t,e){e===void 0&&(e=!1),t=t!=null?t:this._engine.currentRenderPassId;var r=this._drawWrappers[t];return!r&&e&&(this._drawWrappers[t]=r=new xr(this._mesh.getScene().getEngine())),r},n.prototype._removeDrawWrapper=function(t,e){var r;e===void 0&&(e=!0),e&&((r=this._drawWrappers[t])===null||r===void 0||r.dispose()),this._drawWrappers[t]=void 0},Object.defineProperty(n.prototype,"effect",{get:function(){var t,e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:(e=(t=this._getDrawWrapper())===null||t===void 0?void 0:t.effect)!==null&&e!==void 0?e:null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"_drawWrapper",{get:function(){var t;return(t=this._mainDrawWrapperOverride)!==null&&t!==void 0?t:this._getDrawWrapper(void 0,!0)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"_drawWrapperOverride",{get:function(){return this._mainDrawWrapperOverride},enumerable:!1,configurable:!0}),n.prototype._setMainDrawWrapperOverride=function(t){this._mainDrawWrapperOverride=t},n.prototype.setEffect=function(t,e,r,i){e===void 0&&(e=null),i===void 0&&(i=!0);var a=this._drawWrapper;a.setEffect(t,e,i),r!==void 0&&(a.materialContext=r),t||(a.defines=null,a.materialContext=void 0)},n.prototype.resetDrawCache=function(t){if(this._drawWrappers)if(t!==void 0){this._removeDrawWrapper(t);return}else for(var e=0,r=this._drawWrappers;e<r.length;e++){var i=r[e];i==null||i.dispose()}this._drawWrappers=[]},n.AddToMesh=function(t,e,r,i,a,o,s,u){return u===void 0&&(u=!0),new n(t,e,r,i,a,o,s,u)},Object.defineProperty(n.prototype,"IsGlobal",{get:function(){return this.verticesStart===0&&this.verticesCount===this._mesh.getTotalVertices()&&this.indexStart===0&&this.indexCount===this._mesh.getTotalIndices()},enumerable:!1,configurable:!0}),n.prototype.getBoundingInfo=function(){return this.IsGlobal?this._mesh.getBoundingInfo():this._boundingInfo},n.prototype.setBoundingInfo=function(t){return this._boundingInfo=t,this},n.prototype.getMesh=function(){return this._mesh},n.prototype.getRenderingMesh=function(){return this._renderingMesh},n.prototype.getReplacementMesh=function(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null},n.prototype.getEffectiveMesh=function(){var t=this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null;return t||this._renderingMesh},n.prototype.getMaterial=function(t){var e;t===void 0&&(t=!0);var r=(e=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId))!==null&&e!==void 0?e:this._renderingMesh.material;if(r){if(this._isMultiMaterial(r)){var i=r.getSubMaterial(this.materialIndex);return this._currentMaterial!==i&&(this._currentMaterial=i,this.resetDrawCache()),i}}else return t?this._mesh.getScene().defaultMaterial:null;return r},n.prototype._isMultiMaterial=function(t){return t.getSubMaterial!==void 0},n.prototype.refreshBoundingInfo=function(t){if(t===void 0&&(t=null),this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(t||(t=this._renderingMesh.getVerticesData(_.PositionKind)),!t)return this._boundingInfo=this._mesh.getBoundingInfo(),this;var e=this._renderingMesh.getIndices(),r;if(this.indexStart===0&&this.indexCount===e.length){var i=this._renderingMesh.getBoundingInfo();r={minimum:i.minimum.clone(),maximum:i.maximum.clone()}}else r=cr(t,e,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(r.minimum,r.maximum):this._boundingInfo=new Pe(r.minimum,r.maximum),this},n.prototype._checkCollision=function(t){var e=this.getBoundingInfo();return e._checkCollision(t)},n.prototype.updateBoundingInfo=function(t){var e=this.getBoundingInfo();return e||(this.refreshBoundingInfo(),e=this.getBoundingInfo()),e&&e.update(t),this},n.prototype.isInFrustum=function(t){var e=this.getBoundingInfo();return e?e.isInFrustum(t,this._mesh.cullingStrategy):!1},n.prototype.isCompletelyInFrustum=function(t){var e=this.getBoundingInfo();return e?e.isCompletelyInFrustum(t):!1},n.prototype.render=function(t){return this._renderingMesh.render(this,t,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this},n.prototype._getLinesIndexBuffer=function(t,e){if(!this._linesIndexBuffer){for(var r=[],i=this.indexStart;i<this.indexStart+this.indexCount;i+=3)r.push(t[i],t[i+1],t[i+1],t[i+2],t[i+2],t[i]);this._linesIndexBuffer=e.createIndexBuffer(r),this._linesIndexCount=r.length}return this._linesIndexBuffer},n.prototype.canIntersects=function(t){var e=this.getBoundingInfo();return e?t.intersectsBox(e.boundingBox):!1},n.prototype.intersects=function(t,e,r,i,a){var o=this.getMaterial();if(!o)return null;var s=3,u=!1;switch(o.fillMode){case 3:case 5:case 6:case 8:return null;case 7:s=1,u=!0;break}return o.fillMode===4?r.length?this._intersectLines(t,e,r,this._mesh.intersectionThreshold,i):this._intersectUnIndexedLines(t,e,r,this._mesh.intersectionThreshold,i):!r.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(t,e,r,i,a):this._intersectTriangles(t,e,r,s,u,i,a)},n.prototype._intersectLines=function(t,e,r,i,a){for(var o=null,s=this.indexStart;s<this.indexStart+this.indexCount;s+=2){var u=e[r[s]],f=e[r[s+1]],l=t.intersectionSegment(u,f,i);if(!(l<0)&&(a||!o||l<o.distance)&&(o=new ht(null,null,l),o.faceId=s/2,a))break}return o},n.prototype._intersectUnIndexedLines=function(t,e,r,i,a){for(var o=null,s=this.verticesStart;s<this.verticesStart+this.verticesCount;s+=2){var u=e[s],f=e[s+1],l=t.intersectionSegment(u,f,i);if(!(l<0)&&(a||!o||l<o.distance)&&(o=new ht(null,null,l),o.faceId=s/2,a))break}return o},n.prototype._intersectTriangles=function(t,e,r,i,a,o,s){for(var u=null,f=-1,l=this.indexStart;l<this.indexStart+this.indexCount-(3-i);l+=i){f++;var c=r[l],h=r[l+1],d=r[l+2];if(a&&d===4294967295){l+=2;continue}var v=e[c],g=e[h],p=e[d];if(!(!v||!g||!p)&&!(s&&!s(v,g,p,t))){var m=t.intersectsTriangle(v,g,p);if(m){if(m.distance<0)continue;if((o||!u||m.distance<u.distance)&&(u=m,u.faceId=f,o))break}}}return u},n.prototype._intersectUnIndexedTriangles=function(t,e,r,i,a){for(var o=null,s=this.verticesStart;s<this.verticesStart+this.verticesCount;s+=3){var u=e[s],f=e[s+1],l=e[s+2];if(!(a&&!a(u,f,l,t))){var c=t.intersectsTriangle(u,f,l);if(c){if(c.distance<0)continue;if((i||!o||c.distance<o.distance)&&(o=c,o.faceId=s/3,i))break}}}return o},n.prototype._rebuild=function(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)},n.prototype.clone=function(t,e){var r=new n(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,t,e,!1);if(!this.IsGlobal){var i=this.getBoundingInfo();if(!i)return r;r._boundingInfo=new Pe(i.minimum,i.maximum)}return r},n.prototype.dispose=function(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);var t=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(t,1),this.resetDrawCache()},n.prototype.getClassName=function(){return"SubMesh"},n.CreateFromIndices=function(t,e,r,i,a,o){o===void 0&&(o=!0);for(var s=Number.MAX_VALUE,u=-Number.MAX_VALUE,f=a||i,l=f.getIndices(),c=e;c<e+r;c++){var h=l[c];h<s&&(s=h),h>u&&(u=h)}return new n(t,s,u-s+1,e,r,i,a,o)},n}(),Oe=function(){function n(t,e,r,i,a){i===void 0&&(i=!1),a===void 0&&(a=null),this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=e||Qe.LastCreatedScene,this._scene&&(this.id=t,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=i,r?this.setAllVerticesData(r,i):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),a&&(this.applyToMesh(a),a.computeWorldMatrix(!0)))}return Object.defineProperty(n.prototype,"boundingBias",{get:function(){return this._boundingBias},set:function(t){this._boundingBias?this._boundingBias.copyFrom(t):this._boundingBias=t.clone(),this._updateBoundingInfo(!0,null)},enumerable:!1,configurable:!0}),n.CreateGeometryForMesh=function(t){var e=new n(n.RandomId(),t.getScene());return e.applyToMesh(t),e},Object.defineProperty(n.prototype,"meshes",{get:function(){return this._meshes},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"extend",{get:function(){return this._extend},enumerable:!1,configurable:!0}),n.prototype.getScene=function(){return this._scene},n.prototype.getEngine=function(){return this._engine},n.prototype.isReady=function(){return this.delayLoadState===1||this.delayLoadState===0},Object.defineProperty(n.prototype,"doNotSerialize",{get:function(){for(var t=0;t<this._meshes.length;t++)if(!this._meshes[t].doNotSerialize)return!1;return!0},enumerable:!1,configurable:!0}),n.prototype._rebuild=function(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable));for(var t in this._vertexBuffers){var e=this._vertexBuffers[t];e._rebuild()}},n.prototype.setAllVerticesData=function(t,e){t.applyToGeometry(this,e),this._notifyUpdate()},n.prototype.setVerticesData=function(t,e,r,i){r===void 0&&(r=!1),r&&Array.isArray(e)&&(e=new Float32Array(e));var a=new _(this._engine,e,t,r,this._meshes.length===0,i);this.setVerticesBuffer(a)},n.prototype.removeVerticesData=function(t){this._vertexBuffers[t]&&(this._vertexBuffers[t].dispose(),delete this._vertexBuffers[t]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()},n.prototype.setVerticesBuffer=function(t,e,r){e===void 0&&(e=null),r===void 0&&(r=!0);var i=t.getKind();this._vertexBuffers[i]&&r&&this._vertexBuffers[i].dispose(),t._buffer&&t._buffer._increaseReferences(),this._vertexBuffers[i]=t;var a=this._meshes,o=a.length;if(i===_.PositionKind){var s=t.getData();e!=null?this._totalVertices=e:s!=null&&(this._totalVertices=s.length/(t.type===_.BYTE?t.byteStride:t.byteStride/4)),this._updateExtend(s),this._resetPointsArrayCache();for(var u=0;u<o;u++){var f=a[u];f.buildBoundingInfo(this._extend.minimum,this._extend.maximum),f._createGlobalSubMesh(f.isUnIndexed),f.computeWorldMatrix(!0),f.synchronizeInstances()}}this._notifyUpdate(i)},n.prototype.updateVerticesDataDirectly=function(t,e,r,i){i===void 0&&(i=!1);var a=this.getVertexBuffer(t);!a||(a.updateDirectly(e,r,i),this._notifyUpdate(t))},n.prototype.updateVerticesData=function(t,e,r){r===void 0&&(r=!1);var i=this.getVertexBuffer(t);!i||(i.update(e),t===_.PositionKind&&this._updateBoundingInfo(r,e),this._notifyUpdate(t))},n.prototype._updateBoundingInfo=function(t,e){if(t&&this._updateExtend(e),this._resetPointsArrayCache(),t)for(var r=this._meshes,i=0,a=r;i<a.length;i++){var o=a[i];o.hasBoundingInfo?o.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):o.buildBoundingInfo(this._extend.minimum,this._extend.maximum);for(var s=o.subMeshes,u=0,f=s;u<f.length;u++){var l=f[u];l.refreshBoundingInfo()}}},n.prototype._bind=function(t,e,r,i){if(!!t){e===void 0&&(e=this._indexBuffer);var a=this.getVertexBuffers();if(!!a){if(e!=this._indexBuffer||!this._vertexArrayObjects&&!i){this._engine.bindBuffers(a,e,t,r);return}var o=i||this._vertexArrayObjects;o[t.key]||(o[t.key]=this._engine.recordVertexArrayObject(a,e,t,r)),this._engine.bindVertexArrayObject(o[t.key],e)}}},n.prototype.getTotalVertices=function(){return this.isReady()?this._totalVertices:0},n.prototype.getVerticesData=function(t,e,r){var i=this.getVertexBuffer(t);return i?i.getFloatData(this._totalVertices,r||e&&this._meshes.length!==1):null},n.prototype.isVertexBufferUpdatable=function(t){var e=this._vertexBuffers[t];return e?e.isUpdatable():!1},n.prototype.getVertexBuffer=function(t){return this.isReady()?this._vertexBuffers[t]:null},n.prototype.getVertexBuffers=function(){return this.isReady()?this._vertexBuffers:null},n.prototype.isVerticesDataPresent=function(t){return this._vertexBuffers?this._vertexBuffers[t]!==void 0:this._delayInfo?this._delayInfo.indexOf(t)!==-1:!1},n.prototype.getVerticesDataKinds=function(){var t=[],e;if(!this._vertexBuffers&&this._delayInfo)for(e in this._delayInfo)t.push(e);else for(e in this._vertexBuffers)t.push(e);return t},n.prototype.updateIndices=function(t,e,r){if(r===void 0&&(r=!1),!!this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(t,null,!0);else{var i=t.length!==this._indices.length;if(r||(this._indices=t.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,t,e),i)for(var a=0,o=this._meshes;a<o.length;a++){var s=o[a];s._createGlobalSubMesh(!0)}}},n.prototype.setIndices=function(t,e,r){e===void 0&&(e=null),r===void 0&&(r=!1),this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=t,this._indexBufferIsUpdatable=r,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,r)),e!=null&&(this._totalVertices=e);for(var i=0,a=this._meshes;i<a.length;i++){var o=a[i];o._createGlobalSubMesh(!0),o.synchronizeInstances()}this._notifyUpdate()},n.prototype.getTotalIndices=function(){return this.isReady()?this._indices.length:0},n.prototype.getIndices=function(t,e){if(!this.isReady())return null;var r=this._indices;return!e&&(!t||this._meshes.length===1)?r:r.slice()},n.prototype.getIndexBuffer=function(){return this.isReady()?this._indexBuffer:null},n.prototype._releaseVertexArrayObject=function(t){t===void 0&&(t=null),!(!t||!this._vertexArrayObjects)&&this._vertexArrayObjects[t.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[t.key]),delete this._vertexArrayObjects[t.key])},n.prototype.releaseForMesh=function(t,e){var r=this._meshes,i=r.indexOf(t);i!==-1&&(r.splice(i,1),this._vertexArrayObjects&&t._invalidateInstanceVertexArrayObject(),t._geometry=null,r.length===0&&e&&this.dispose())},n.prototype.applyToMesh=function(t){if(t._geometry!==this){var e=t._geometry;e&&e.releaseForMesh(t),this._vertexArrayObjects&&t._invalidateInstanceVertexArrayObject();var r=this._meshes;t._geometry=this,t._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),r.push(t),this.isReady()?this._applyToMesh(t):this._boundingInfo&&t.setBoundingInfo(this._boundingInfo)}},n.prototype._updateExtend=function(t){if(t===void 0&&(t=null),this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!t&&(t=this.getVerticesData(_.PositionKind),!t))return;this._extend=dt(t,0,this._totalVertices,this.boundingBias,3)}},n.prototype._applyToMesh=function(t){var e=this._meshes.length;for(var r in this._vertexBuffers)e===1&&this._vertexBuffers[r].create(),r===_.PositionKind&&(this._extend||this._updateExtend(),t.buildBoundingInfo(this._extend.minimum,this._extend.maximum),t._createGlobalSubMesh(t.isUnIndexed),t._updateBoundingInfo());e===1&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),t._syncGeometryWithMorphTargetManager(),t.synchronizeInstances()},n.prototype._notifyUpdate=function(t){this.onGeometryUpdated&&this.onGeometryUpdated(this,t),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(var e=0,r=this._meshes;e<r.length;e++){var i=r[e];i._markSubMeshesAsAttributesDirty()}},n.prototype.load=function(t,e){if(this.delayLoadState!==2){if(this.isReady()){e&&e();return}this.delayLoadState=2,this._queueLoad(t,e)}},n.prototype._queueLoad=function(t,e){var r=this;!this.delayLoadingFile||(t.addPendingData(this),t._loadFile(this.delayLoadingFile,function(i){if(!!r._delayLoadingFunction){r._delayLoadingFunction(JSON.parse(i),r),r.delayLoadState=1,r._delayInfo=[],t.removePendingData(r);for(var a=r._meshes,o=a.length,s=0;s<o;s++)r._applyToMesh(a[s]);e&&e()}},void 0,!0))},n.prototype.toLeftHanded=function(){var t=this.getIndices(!1);if(t!=null&&t.length>0){for(var e=0;e<t.length;e+=3){var r=t[e+0];t[e+0]=t[e+2],t[e+2]=r}this.setIndices(t)}var i=this.getVerticesData(_.PositionKind,!1);if(i!=null&&i.length>0){for(var e=0;e<i.length;e+=3)i[e+2]=-i[e+2];this.setVerticesData(_.PositionKind,i,!1)}var a=this.getVerticesData(_.NormalKind,!1);if(a!=null&&a.length>0){for(var e=0;e<a.length;e+=3)a[e+2]=-a[e+2];this.setVerticesData(_.NormalKind,a,!1)}},n.prototype._resetPointsArrayCache=function(){this._positions=null},n.prototype._generatePointsArray=function(){if(this._positions)return!0;var t=this.getVerticesData(_.PositionKind);if(!t||t.length===0)return!1;for(var e=this._positionsCache.length*3,r=this._positionsCache.length;e<t.length;e+=3,++r)this._positionsCache[r]=O.FromArray(t,e);for(var e=0,r=0;e<t.length;e+=3,++r)this._positionsCache[r].set(t[0+e],t[1+e],t[2+e]);return this._positionsCache.length=t.length/3,this._positions=this._positionsCache,!0},n.prototype.isDisposed=function(){return this._isDisposed},n.prototype._disposeVertexArrayObjects=function(){if(this._vertexArrayObjects){for(var t in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[t]);this._vertexArrayObjects={};for(var e=this._meshes,r=e.length,i=0;i<r;i++)e[i]._invalidateInstanceVertexArrayObject()}},n.prototype.dispose=function(){var t=this._meshes,e=t.length,r;for(r=0;r<e;r++)this.releaseForMesh(t[r]);this._meshes.length=0,this._disposeVertexArrayObjects();for(var i in this._vertexBuffers)this._vertexBuffers[i].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){var a=this._parentContainer.geometries.indexOf(this);a>-1&&this._parentContainer.geometries.splice(a,1),this._parentContainer=null}this._isDisposed=!0},n.prototype.copy=function(t){var e=new Q;e.indices=[];var r=this.getIndices();if(r)for(var i=0;i<r.length;i++)e.indices.push(r[i]);var a=!1,o=!1,s;for(s in this._vertexBuffers){var u=this.getVerticesData(s);if(u&&(u instanceof Float32Array?e.set(new Float32Array(u),s):e.set(u.slice(0),s),!o)){var f=this.getVertexBuffer(s);f&&(a=f.isUpdatable(),o=!a)}}var l=new n(t,this._scene,e,a);l.delayLoadState=this.delayLoadState,l.delayLoadingFile=this.delayLoadingFile,l._delayLoadingFunction=this._delayLoadingFunction;for(s in this._delayInfo)l._delayInfo=l._delayInfo||[],l._delayInfo.push(s);return l._boundingInfo=new Pe(this._extend.minimum,this._extend.maximum),l},n.prototype.serialize=function(){var t={};return t.id=this.id,t.uniqueId=this.uniqueId,t.updatable=this._updatable,de&&de.HasTags(this)&&(t.tags=de.GetTags(this)),t},n.prototype._toNumberArray=function(t){return Array.isArray(t)?t:Array.prototype.slice.call(t)},n.prototype.clearCachedData=function(){this._indices=[],this._resetPointsArrayCache();for(var t in this._vertexBuffers)!Object.prototype.hasOwnProperty.call(this._vertexBuffers,t)||(this._vertexBuffers[t]._buffer._data=null)},n.prototype.serializeVerticeData=function(){var t=this.serialize();return this.isVerticesDataPresent(_.PositionKind)&&(t.positions=this._toNumberArray(this.getVerticesData(_.PositionKind)),this.isVertexBufferUpdatable(_.PositionKind)&&(t.positions._updatable=!0)),this.isVerticesDataPresent(_.NormalKind)&&(t.normals=this._toNumberArray(this.getVerticesData(_.NormalKind)),this.isVertexBufferUpdatable(_.NormalKind)&&(t.normals._updatable=!0)),this.isVerticesDataPresent(_.TangentKind)&&(t.tangents=this._toNumberArray(this.getVerticesData(_.TangentKind)),this.isVertexBufferUpdatable(_.TangentKind)&&(t.tangents._updatable=!0)),this.isVerticesDataPresent(_.UVKind)&&(t.uvs=this._toNumberArray(this.getVerticesData(_.UVKind)),this.isVertexBufferUpdatable(_.UVKind)&&(t.uvs._updatable=!0)),this.isVerticesDataPresent(_.UV2Kind)&&(t.uv2s=this._toNumberArray(this.getVerticesData(_.UV2Kind)),this.isVertexBufferUpdatable(_.UV2Kind)&&(t.uv2s._updatable=!0)),this.isVerticesDataPresent(_.UV3Kind)&&(t.uv3s=this._toNumberArray(this.getVerticesData(_.UV3Kind)),this.isVertexBufferUpdatable(_.UV3Kind)&&(t.uv3s._updatable=!0)),this.isVerticesDataPresent(_.UV4Kind)&&(t.uv4s=this._toNumberArray(this.getVerticesData(_.UV4Kind)),this.isVertexBufferUpdatable(_.UV4Kind)&&(t.uv4s._updatable=!0)),this.isVerticesDataPresent(_.UV5Kind)&&(t.uv5s=this._toNumberArray(this.getVerticesData(_.UV5Kind)),this.isVertexBufferUpdatable(_.UV5Kind)&&(t.uv5s._updatable=!0)),this.isVerticesDataPresent(_.UV6Kind)&&(t.uv6s=this._toNumberArray(this.getVerticesData(_.UV6Kind)),this.isVertexBufferUpdatable(_.UV6Kind)&&(t.uv6s._updatable=!0)),this.isVerticesDataPresent(_.ColorKind)&&(t.colors=this._toNumberArray(this.getVerticesData(_.ColorKind)),this.isVertexBufferUpdatable(_.ColorKind)&&(t.colors._updatable=!0)),this.isVerticesDataPresent(_.MatricesIndicesKind)&&(t.matricesIndices=this._toNumberArray(this.getVerticesData(_.MatricesIndicesKind)),t.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(_.MatricesIndicesKind)&&(t.matricesIndices._updatable=!0)),this.isVerticesDataPresent(_.MatricesWeightsKind)&&(t.matricesWeights=this._toNumberArray(this.getVerticesData(_.MatricesWeightsKind)),this.isVertexBufferUpdatable(_.MatricesWeightsKind)&&(t.matricesWeights._updatable=!0)),t.indices=this._toNumberArray(this.getIndices()),t},n.ExtractFromMesh=function(t,e){var r=t._geometry;return r?r.copy(e):null},n.RandomId=function(){return ye.RandomId()},n._GetGeometryByLoadedUniqueId=function(t,e){for(var r=0;r<e.geometries.length;r++)if(e.geometries[r]._loadedUniqueId===t)return e.geometries[r];return null},n._ImportGeometry=function(t,e){var r=e.getScene(),i=t.geometryUniqueId,a=t.geometryId;if(i||a){var o=i?this._GetGeometryByLoadedUniqueId(i,r):r.getGeometryById(a);o&&o.applyToMesh(e)}else if(t instanceof ArrayBuffer){var s=e._binaryInfo;if(s.positionsAttrDesc&&s.positionsAttrDesc.count>0){var u=new Float32Array(t,s.positionsAttrDesc.offset,s.positionsAttrDesc.count);e.setVerticesData(_.PositionKind,u,!1)}if(s.normalsAttrDesc&&s.normalsAttrDesc.count>0){var f=new Float32Array(t,s.normalsAttrDesc.offset,s.normalsAttrDesc.count);e.setVerticesData(_.NormalKind,f,!1)}if(s.tangetsAttrDesc&&s.tangetsAttrDesc.count>0){var l=new Float32Array(t,s.tangetsAttrDesc.offset,s.tangetsAttrDesc.count);e.setVerticesData(_.TangentKind,l,!1)}if(s.uvsAttrDesc&&s.uvsAttrDesc.count>0){var c=new Float32Array(t,s.uvsAttrDesc.offset,s.uvsAttrDesc.count);if(j.UseOpenGLOrientationForUV)for(var h=1;h<c.length;h+=2)c[h]=1-c[h];e.setVerticesData(_.UVKind,c,!1)}if(s.uvs2AttrDesc&&s.uvs2AttrDesc.count>0){var d=new Float32Array(t,s.uvs2AttrDesc.offset,s.uvs2AttrDesc.count);if(j.UseOpenGLOrientationForUV)for(var h=1;h<d.length;h+=2)d[h]=1-d[h];e.setVerticesData(_.UV2Kind,d,!1)}if(s.uvs3AttrDesc&&s.uvs3AttrDesc.count>0){var v=new Float32Array(t,s.uvs3AttrDesc.offset,s.uvs3AttrDesc.count);if(j.UseOpenGLOrientationForUV)for(var h=1;h<v.length;h+=2)v[h]=1-v[h];e.setVerticesData(_.UV3Kind,v,!1)}if(s.uvs4AttrDesc&&s.uvs4AttrDesc.count>0){var g=new Float32Array(t,s.uvs4AttrDesc.offset,s.uvs4AttrDesc.count);if(j.UseOpenGLOrientationForUV)for(var h=1;h<g.length;h+=2)g[h]=1-g[h];e.setVerticesData(_.UV4Kind,g,!1)}if(s.uvs5AttrDesc&&s.uvs5AttrDesc.count>0){var p=new Float32Array(t,s.uvs5AttrDesc.offset,s.uvs5AttrDesc.count);if(j.UseOpenGLOrientationForUV)for(var h=1;h<p.length;h+=2)p[h]=1-p[h];e.setVerticesData(_.UV5Kind,p,!1)}if(s.uvs6AttrDesc&&s.uvs6AttrDesc.count>0){var m=new Float32Array(t,s.uvs6AttrDesc.offset,s.uvs6AttrDesc.count);if(j.UseOpenGLOrientationForUV)for(var h=1;h<m.length;h+=2)m[h]=1-m[h];e.setVerticesData(_.UV6Kind,m,!1)}if(s.colorsAttrDesc&&s.colorsAttrDesc.count>0){var M=new Float32Array(t,s.colorsAttrDesc.offset,s.colorsAttrDesc.count);e.setVerticesData(_.ColorKind,M,!1,s.colorsAttrDesc.stride)}if(s.matricesIndicesAttrDesc&&s.matricesIndicesAttrDesc.count>0){for(var A=new Int32Array(t,s.matricesIndicesAttrDesc.offset,s.matricesIndicesAttrDesc.count),y=[],b=0;b<A.length;b++){var h=A[b];y.push(h&255),y.push((h&65280)>>8),y.push((h&16711680)>>16),y.push(h>>24&255)}e.setVerticesData(_.MatricesIndicesKind,y,!1)}if(s.matricesIndicesExtraAttrDesc&&s.matricesIndicesExtraAttrDesc.count>0){for(var A=new Int32Array(t,s.matricesIndicesExtraAttrDesc.offset,s.matricesIndicesExtraAttrDesc.count),y=[],b=0;b<A.length;b++){var h=A[b];y.push(h&255),y.push((h&65280)>>8),y.push((h&16711680)>>16),y.push(h>>24&255)}e.setVerticesData(_.MatricesIndicesExtraKind,y,!1)}if(s.matricesWeightsAttrDesc&&s.matricesWeightsAttrDesc.count>0){var x=new Float32Array(t,s.matricesWeightsAttrDesc.offset,s.matricesWeightsAttrDesc.count);e.setVerticesData(_.MatricesWeightsKind,x,!1)}if(s.indicesAttrDesc&&s.indicesAttrDesc.count>0){var I=new Int32Array(t,s.indicesAttrDesc.offset,s.indicesAttrDesc.count);e.setIndices(I,null)}if(s.subMeshesAttrDesc&&s.subMeshesAttrDesc.count>0){var D=new Int32Array(t,s.subMeshesAttrDesc.offset,s.subMeshesAttrDesc.count*5);e.subMeshes=[];for(var b=0;b<s.subMeshesAttrDesc.count;b++){var T=D[b*5+0],C=D[b*5+1],B=D[b*5+2],V=D[b*5+3],U=D[b*5+4];pe.AddToMesh(T,C,B,V,U,e)}}}else if(t.positions&&t.normals&&t.indices){if(e.setVerticesData(_.PositionKind,t.positions,t.positions._updatable),e.setVerticesData(_.NormalKind,t.normals,t.normals._updatable),t.tangents&&e.setVerticesData(_.TangentKind,t.tangents,t.tangents._updatable),t.uvs&&e.setVerticesData(_.UVKind,t.uvs,t.uvs._updatable),t.uvs2&&e.setVerticesData(_.UV2Kind,t.uvs2,t.uvs2._updatable),t.uvs3&&e.setVerticesData(_.UV3Kind,t.uvs3,t.uvs3._updatable),t.uvs4&&e.setVerticesData(_.UV4Kind,t.uvs4,t.uvs4._updatable),t.uvs5&&e.setVerticesData(_.UV5Kind,t.uvs5,t.uvs5._updatable),t.uvs6&&e.setVerticesData(_.UV6Kind,t.uvs6,t.uvs6._updatable),t.colors&&e.setVerticesData(_.ColorKind,De.CheckColors4(t.colors,t.positions.length/3),t.colors._updatable),t.matricesIndices)if(t.matricesIndices._isExpanded)delete t.matricesIndices._isExpanded,e.setVerticesData(_.MatricesIndicesKind,t.matricesIndices,t.matricesIndices._updatable);else{for(var y=[],b=0;b<t.matricesIndices.length;b++){var R=t.matricesIndices[b];y.push(R&255),y.push((R&65280)>>8),y.push((R&16711680)>>16),y.push(R>>24&255)}e.setVerticesData(_.MatricesIndicesKind,y,t.matricesIndices._updatable)}if(t.matricesIndicesExtra)if(t.matricesIndicesExtra._isExpanded)delete t.matricesIndices._isExpanded,e.setVerticesData(_.MatricesIndicesExtraKind,t.matricesIndicesExtra,t.matricesIndicesExtra._updatable);else{for(var y=[],b=0;b<t.matricesIndicesExtra.length;b++){var R=t.matricesIndicesExtra[b];y.push(R&255),y.push((R&65280)>>8),y.push((R&16711680)>>16),y.push(R>>24&255)}e.setVerticesData(_.MatricesIndicesExtraKind,y,t.matricesIndicesExtra._updatable)}t.matricesWeights&&(n._CleanMatricesWeights(t,e),e.setVerticesData(_.MatricesWeightsKind,t.matricesWeights,t.matricesWeights._updatable)),t.matricesWeightsExtra&&e.setVerticesData(_.MatricesWeightsExtraKind,t.matricesWeightsExtra,t.matricesWeights._updatable),e.setIndices(t.indices,null)}if(t.subMeshes){e.subMeshes=[];for(var F=0;F<t.subMeshes.length;F++){var W=t.subMeshes[F];pe.AddToMesh(W.materialIndex,W.verticesStart,W.verticesCount,W.indexStart,W.indexCount,e)}}e._shouldGenerateFlatShading&&(e.convertToFlatShadedMesh(),e._shouldGenerateFlatShading=!1),e.computeWorldMatrix(!0),r.onMeshImportedObservable.notifyObservers(e)},n._CleanMatricesWeights=function(t,e){var r=.001;if(!!yt.CleanBoneMatrixWeights){var i=0;if(t.skeletonId>-1){var a=e.getScene().getLastSkeletonById(t.skeletonId);if(!a)return;i=a.bones.length}else return;for(var o=e.getVerticesData(_.MatricesIndicesKind),s=e.getVerticesData(_.MatricesIndicesExtraKind),u=t.matricesWeights,f=t.matricesWeightsExtra,l=t.numBoneInfluencer,c=u.length,h=0;h<c;h+=4){for(var d=0,v=-1,g=0;g<4;g++){var p=u[h+g];d+=p,p<r&&v<0&&(v=g)}if(f)for(var g=0;g<4;g++){var p=f[h+g];d+=p,p<r&&v<0&&(v=g+4)}if((v<0||v>l-1)&&(v=l-1),d>r){for(var m=1/d,g=0;g<4;g++)u[h+g]*=m;if(f)for(var g=0;g<4;g++)f[h+g]*=m}else v>=4?(f[h+v-4]=1-d,s[h+v-4]=i):(u[h+v]=1-d,o[h+v]=i)}e.setVerticesData(_.MatricesIndicesKind,o),t.matricesWeightsExtra&&e.setVerticesData(_.MatricesIndicesExtraKind,s)}},n.Parse=function(t,e,r){var i=new n(t.id,e,void 0,t.updatable);return i._loadedUniqueId=t.uniqueId,de&&de.AddTagsTo(i,t.tags),t.delayLoadingFile?(i.delayLoadState=4,i.delayLoadingFile=r+t.delayLoadingFile,i._boundingInfo=new Pe(O.FromArray(t.boundingBoxMinimum),O.FromArray(t.boundingBoxMaximum)),i._delayInfo=[],t.hasUVs&&i._delayInfo.push(_.UVKind),t.hasUVs2&&i._delayInfo.push(_.UV2Kind),t.hasUVs3&&i._delayInfo.push(_.UV3Kind),t.hasUVs4&&i._delayInfo.push(_.UV4Kind),t.hasUVs5&&i._delayInfo.push(_.UV5Kind),t.hasUVs6&&i._delayInfo.push(_.UV6Kind),t.hasColors&&i._delayInfo.push(_.ColorKind),t.hasMatricesIndices&&i._delayInfo.push(_.MatricesIndicesKind),t.hasMatricesWeights&&i._delayInfo.push(_.MatricesWeightsKind),i._delayLoadingFunction=Q.ImportVertexData):Q.ImportVertexData(t,i),e.pushGeometry(i,!0),i},n}(),Me=function(n){_e(t,n);function t(e,r,i){r===void 0&&(r=null),i===void 0&&(i=!0);var a=n.call(this,e,r)||this;return a._forward=new O(0,0,1),a._up=new O(0,1,0),a._right=new O(1,0,0),a._position=O.Zero(),a._rotation=O.Zero(),a._rotationQuaternion=null,a._scaling=O.One(),a._transformToBoneReferal=null,a._isAbsoluteSynced=!1,a._billboardMode=t.BILLBOARDMODE_NONE,a._preserveParentRotationForBillboard=!1,a.scalingDeterminant=1,a._infiniteDistance=!1,a.ignoreNonUniformScaling=!1,a.reIntegrateRotationIntoRotationQuaternion=!1,a._poseMatrix=null,a._localMatrix=X.Zero(),a._usePivotMatrix=!1,a._absolutePosition=O.Zero(),a._absoluteScaling=O.Zero(),a._absoluteRotationQuaternion=ce.Identity(),a._pivotMatrix=X.Identity(),a._postMultiplyPivotMatrix=!1,a._isWorldMatrixFrozen=!1,a._indexInSceneTransformNodesArray=-1,a.onAfterWorldMatrixUpdateObservable=new me,a._nonUniformScaling=!1,i&&a.getScene().addTransformNode(a),a}return Object.defineProperty(t.prototype,"billboardMode",{get:function(){return this._billboardMode},set:function(e){this._billboardMode!==e&&(this._billboardMode=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"preserveParentRotationForBillboard",{get:function(){return this._preserveParentRotationForBillboard},set:function(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"infiniteDistance",{get:function(){return this._infiniteDistance},set:function(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"TransformNode"},Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(e){this._position=e,this._isDirty=!0},enumerable:!1,configurable:!0}),t.prototype.isUsingPivotMatrix=function(){return this._usePivotMatrix},Object.defineProperty(t.prototype,"rotation",{get:function(){return this._rotation},set:function(e){this._rotation=e,this._rotationQuaternion=null,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"scaling",{get:function(){return this._scaling},set:function(e){this._scaling=e,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rotationQuaternion",{get:function(){return this._rotationQuaternion},set:function(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"forward",{get:function(){return O.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"up",{get:function(){return O.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return O.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()},enumerable:!1,configurable:!0}),t.prototype.updatePoseMatrix=function(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)},t.prototype.getPoseMatrix=function(){return this._poseMatrix||(this._poseMatrix=X.Identity()),this._poseMatrix},t.prototype._isSynchronized=function(){var e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==t.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)},t.prototype._initCache=function(){n.prototype._initCache.call(this);var e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1},Object.defineProperty(t.prototype,"absolutePosition",{get:function(){return this.getAbsolutePosition()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"absoluteScaling",{get:function(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"absoluteRotationQuaternion",{get:function(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion},enumerable:!1,configurable:!0}),t.prototype.setPreTransformMatrix=function(e){return this.setPivotMatrix(e,!1)},t.prototype.setPivotMatrix=function(e,r){return r===void 0&&(r=!0),this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=r,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=X.Invert(this._pivotMatrix)),this},t.prototype.getPivotMatrix=function(){return this._pivotMatrix},t.prototype.instantiateHierarchy=function(e,r,i){e===void 0&&(e=null);var a=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);a&&i&&i(this,a);for(var o=0,s=this.getChildTransformNodes(!0);o<s.length;o++){var u=s[o];u.instantiateHierarchy(a,r,i)}return a},t.prototype.freezeWorldMatrix=function(e,r){return e===void 0&&(e=null),r===void 0&&(r=!1),e?r?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||ce.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this},t.prototype.unfreezeWorldMatrix=function(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this},Object.defineProperty(t.prototype,"isWorldMatrixFrozen",{get:function(){return this._isWorldMatrixFrozen},enumerable:!1,configurable:!0}),t.prototype.getAbsolutePosition=function(){return this.computeWorldMatrix(),this._absolutePosition},t.prototype.setAbsolutePosition=function(e){if(!e)return this;var r,i,a;if(e.x===void 0){if(arguments.length<3)return this;r=arguments[0],i=arguments[1],a=arguments[2]}else r=e.x,i=e.y,a=e.z;if(this.parent){var o=z.Matrix[0];this.parent.getWorldMatrix().invertToRef(o),O.TransformCoordinatesFromFloatsToRef(r,i,a,o,this.position)}else this.position.x=r,this.position.y=i,this.position.z=a;return this._absolutePosition.copyFrom(e),this},t.prototype.setPositionWithLocalVector=function(e){return this.computeWorldMatrix(),this.position=O.TransformNormal(e,this._localMatrix),this},t.prototype.getPositionExpressedInLocalSpace=function(){this.computeWorldMatrix();var e=z.Matrix[0];return this._localMatrix.invertToRef(e),O.TransformNormal(this.position,e)},t.prototype.locallyTranslate=function(e){return this.computeWorldMatrix(!0),this.position=O.TransformCoordinates(e,this._localMatrix),this},t.prototype.lookAt=function(e,r,i,a,o){r===void 0&&(r=0),i===void 0&&(i=0),a===void 0&&(a=0),o===void 0&&(o=Te.LOCAL);var s=t._LookAtVectorCache,u=o===Te.LOCAL?this.position:this.getAbsolutePosition();if(e.subtractToRef(u,s),this.setDirection(s,r,i,a),o===Te.WORLD&&this.parent)if(this.rotationQuaternion){var f=z.Matrix[0];this.rotationQuaternion.toRotationMatrix(f);var l=z.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(l),l.invert(),f.multiplyToRef(l,f),this.rotationQuaternion.fromRotationMatrix(f)}else{var c=z.Quaternion[0];ce.FromEulerVectorToRef(this.rotation,c);var f=z.Matrix[0];c.toRotationMatrix(f);var l=z.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(l),l.invert(),f.multiplyToRef(l,f),c.fromRotationMatrix(f),c.toEulerAnglesToRef(this.rotation)}return this},t.prototype.getDirection=function(e){var r=O.Zero();return this.getDirectionToRef(e,r),r},t.prototype.getDirectionToRef=function(e,r){return O.TransformNormalToRef(e,this.getWorldMatrix(),r),this},t.prototype.setDirection=function(e,r,i,a){r===void 0&&(r=0),i===void 0&&(i=0),a===void 0&&(a=0);var o=-Math.atan2(e.z,e.x)+Math.PI/2,s=Math.sqrt(e.x*e.x+e.z*e.z),u=-Math.atan2(e.y,s);return this.rotationQuaternion?ce.RotationYawPitchRollToRef(o+r,u+i,a,this.rotationQuaternion):(this.rotation.x=u+i,this.rotation.y=o+r,this.rotation.z=a),this},t.prototype.setPivotPoint=function(e,r){r===void 0&&(r=Te.LOCAL),this.getScene().getRenderId()==0&&this.computeWorldMatrix(!0);var i=this.getWorldMatrix();if(r==Te.WORLD){var a=z.Matrix[0];i.invertToRef(a),e=O.TransformCoordinates(e,a)}return this.setPivotMatrix(X.Translation(-e.x,-e.y,-e.z),!0)},t.prototype.getPivotPoint=function(){var e=O.Zero();return this.getPivotPointToRef(e),e},t.prototype.getPivotPointToRef=function(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this},t.prototype.getAbsolutePivotPoint=function(){var e=O.Zero();return this.getAbsolutePivotPointToRef(e),e},t.prototype.getAbsolutePivotPointToRef=function(e){return this.getPivotPointToRef(e),O.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this},t.prototype.markAsDirty=function(e){if(this._children)for(var r=0,i=this._children;r<i.length;r++){var a=i[r];a.markAsDirty(e)}return n.prototype.markAsDirty.call(this,e)},t.prototype.setParent=function(e,r){if(r===void 0&&(r=!1),!e&&!this.parent)return this;var i=z.Quaternion[0],a=z.Vector3[0],o=z.Vector3[1],s=z.Matrix[1];X.IdentityToRef(s);var u=z.Matrix[0];this.computeWorldMatrix(!0);var f=this.rotationQuaternion;return f||(f=t._TmpRotation,ce.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,f)),X.ComposeToRef(this.scaling,f,this.position,u),this.parent&&u.multiplyToRef(this.parent.computeWorldMatrix(!0),u),e&&(e.computeWorldMatrix(!0).invertToRef(s),u.multiplyToRef(s,u)),u.decompose(o,i,a,r?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(i):i.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(o),this.position.copyFrom(a),this.parent=e,this},Object.defineProperty(t.prototype,"nonUniformScaling",{get:function(){return this._nonUniformScaling},enumerable:!1,configurable:!0}),t.prototype._updateNonUniformScalingState=function(e){return this._nonUniformScaling===e?!1:(this._nonUniformScaling=e,!0)},t.prototype.attachToBone=function(e,r){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=r,this.parent=e,e.getSkeleton().prepare(),e.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this},t.prototype.detachFromBone=function(e){return e===void 0&&(e=!1),this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,e?this.parent=this._currentParentWhenAttachingToBone:this.parent=null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)},t.prototype.rotate=function(e,r,i){e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0));var a;if(!i||i===Te.LOCAL)a=ce.RotationAxisToRef(e,r,t._RotationAxisCache),this.rotationQuaternion.multiplyToRef(a,this.rotationQuaternion);else{if(this.parent){var o=z.Matrix[0];this.parent.getWorldMatrix().invertToRef(o),e=O.TransformNormal(e,o)}a=ce.RotationAxisToRef(e,r,t._RotationAxisCache),a.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this},t.prototype.rotateAround=function(e,r,i){r.normalize(),this.rotationQuaternion||(this.rotationQuaternion=ce.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));var a=z.Vector3[0],o=z.Vector3[1],s=z.Vector3[2],u=z.Quaternion[0],f=z.Matrix[0],l=z.Matrix[1],c=z.Matrix[2],h=z.Matrix[3];return e.subtractToRef(this.position,a),X.TranslationToRef(a.x,a.y,a.z,f),X.TranslationToRef(-a.x,-a.y,-a.z,l),X.RotationAxisToRef(r,i,c),l.multiplyToRef(c,h),h.multiplyToRef(f,h),h.decompose(o,u,s),this.position.addInPlace(s),u.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this},t.prototype.translate=function(e,r,i){var a=e.scale(r);if(!i||i===Te.LOCAL){var o=this.getPositionExpressedInLocalSpace().add(a);this.setPositionWithLocalVector(o)}else this.setAbsolutePosition(this.getAbsolutePosition().add(a));return this},t.prototype.addRotation=function(e,r,i){var a;this.rotationQuaternion?a=this.rotationQuaternion:(a=z.Quaternion[1],ce.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,a));var o=z.Quaternion[0];return ce.RotationYawPitchRollToRef(r,e,i,o),a.multiplyInPlace(o),this.rotationQuaternion||a.toEulerAnglesToRef(this.rotation),this},t.prototype._getEffectiveParent=function(){return this.parent},t.prototype.computeWorldMatrix=function(e){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;var r=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===r||this.isSynchronized()))return this._currentRenderId=r,this._worldMatrix;var i=this.getScene().activeCamera,a=(this._billboardMode&t.BILLBOARDMODE_USE_POSITION)!==0,o=this._billboardMode!==t.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard;this._updateCache();var s=this._cache;s.pivotMatrixUpdated=!1,s.billboardMode=this.billboardMode,s.infiniteDistance=this.infiniteDistance,s.parent=this._parentNode,this._currentRenderId=r,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;var u=this._getEffectiveParent(),f=t._TmpScaling,l=this._position;if(this._infiniteDistance&&!this.parent&&i){var c=i.getWorldMatrix(),h=new O(c.m[12],c.m[13],c.m[14]);l=t._TmpTranslation,l.copyFromFloats(this._position.x+h.x,this._position.y+h.y,this._position.z+h.z)}f.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant);var d;if(this._rotationQuaternion){if(this._rotationQuaternion._isDirty=!1,d=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion){var v=this.rotation.lengthSquared();v&&(this._rotationQuaternion.multiplyInPlace(ce.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))}}else d=t._TmpRotation,ce.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,d);if(this._usePivotMatrix){var g=z.Matrix[1];X.ScalingToRef(f.x,f.y,f.z,g);var p=z.Matrix[0];d.toRotationMatrix(p),this._pivotMatrix.multiplyToRef(g,z.Matrix[4]),z.Matrix[4].multiplyToRef(p,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(l.x,l.y,l.z)}else X.ComposeToRef(f,d,l,this._localMatrix);if(u&&u.getWorldMatrix){if(e&&u.computeWorldMatrix(e),o){this._transformToBoneReferal?u.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),z.Matrix[7]):z.Matrix[7].copyFrom(u.getWorldMatrix());var m=z.Vector3[5],M=z.Vector3[6];z.Matrix[7].decompose(M,void 0,m),X.ScalingToRef(M.x,M.y,M.z,z.Matrix[7]),z.Matrix[7].setTranslation(m),this._localMatrix.multiplyToRef(z.Matrix[7],this._worldMatrix)}else this._transformToBoneReferal?(this._localMatrix.multiplyToRef(u.getWorldMatrix(),z.Matrix[6]),z.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)):this._localMatrix.multiplyToRef(u.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(o&&i&&this.billboardMode&&!a){var A=z.Vector3[0];if(this._worldMatrix.getTranslationToRef(A),z.Matrix[1].copyFrom(i.getViewMatrix()),z.Matrix[1].setTranslationFromFloats(0,0,0),z.Matrix[1].invertToRef(z.Matrix[0]),(this.billboardMode&t.BILLBOARDMODE_ALL)!==t.BILLBOARDMODE_ALL){z.Matrix[0].decompose(void 0,z.Quaternion[0],void 0);var y=z.Vector3[1];z.Quaternion[0].toEulerAnglesToRef(y),(this.billboardMode&t.BILLBOARDMODE_X)!==t.BILLBOARDMODE_X&&(y.x=0),(this.billboardMode&t.BILLBOARDMODE_Y)!==t.BILLBOARDMODE_Y&&(y.y=0),(this.billboardMode&t.BILLBOARDMODE_Z)!==t.BILLBOARDMODE_Z&&(y.z=0),X.RotationYawPitchRollToRef(y.y,y.x,y.z,z.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(z.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(z.Vector3[0])}else if(o&&i&&this.billboardMode&&a){var A=z.Vector3[0];this._worldMatrix.getTranslationToRef(A);var b=i.globalPosition;this._worldMatrix.invertToRef(z.Matrix[1]);var x=z.Vector3[1];O.TransformCoordinatesToRef(b,z.Matrix[1],x),x.normalize();var I=-Math.atan2(x.z,x.x)+Math.PI/2,v=Math.sqrt(x.x*x.x+x.z*x.z),D=-Math.atan2(x.y,v);if(ce.RotationYawPitchRollToRef(I,D,0,z.Quaternion[0]),(this.billboardMode&t.BILLBOARDMODE_ALL)!==t.BILLBOARDMODE_ALL){var y=z.Vector3[1];z.Quaternion[0].toEulerAnglesToRef(y),(this.billboardMode&t.BILLBOARDMODE_X)!==t.BILLBOARDMODE_X&&(y.x=0),(this.billboardMode&t.BILLBOARDMODE_Y)!==t.BILLBOARDMODE_Y&&(y.y=0),(this.billboardMode&t.BILLBOARDMODE_Z)!==t.BILLBOARDMODE_Z&&(y.z=0),X.RotationYawPitchRollToRef(y.y,y.x,y.z,z.Matrix[0])}else X.FromQuaternionToRef(z.Quaternion[0],z.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(z.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(z.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):u&&u._nonUniformScaling?this._updateNonUniformScalingState(u._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=X.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix},t.prototype.resetLocalMatrix=function(e){if(e===void 0&&(e=!0),this.computeWorldMatrix(),e)for(var r=this.getChildren(),i=0;i<r.length;++i){var a=r[i];if(a){a.computeWorldMatrix();var o=z.Matrix[0];a._localMatrix.multiplyToRef(this._localMatrix,o);var s=z.Quaternion[0];o.decompose(a.scaling,s,a.position),a.rotationQuaternion?a.rotationQuaternion.copyFrom(s):s.toEulerAnglesToRef(a.rotation)}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=ce.Identity()),this._worldMatrix=X.Identity()},t.prototype._afterComputeWorldMatrix=function(){},t.prototype.registerAfterWorldMatrixUpdate=function(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this},t.prototype.unregisterAfterWorldMatrixUpdate=function(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this},t.prototype.getPositionInCameraSpace=function(e){return e===void 0&&(e=null),e||(e=this.getScene().activeCamera),O.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())},t.prototype.getDistanceToCamera=function(e){return e===void 0&&(e=null),e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()},t.prototype.clone=function(e,r,i){var a=this,o=Ue.Clone(function(){return new t(e,a.getScene())},this);if(o.name=e,o.id=e,r&&(o.parent=r),!i)for(var s=this.getDescendants(!0),u=0;u<s.length;u++){var f=s[u];f.clone&&f.clone(e+"."+f.name,o)}return o},t.prototype.serialize=function(e){var r=Ue.Serialize(this,e);return r.type=this.getClassName(),r.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(r),r.localMatrix=this.getPivotMatrix().asArray(),r.isEnabled=this.isEnabled(),r},t.Parse=function(e,r,i){var a=Ue.Parse(function(){return new t(e.name,r)},e,r,i);return e.localMatrix?a.setPreTransformMatrix(X.FromArray(e.localMatrix)):e.pivotMatrix&&a.setPivotMatrix(X.FromArray(e.pivotMatrix)),a.setEnabled(e.isEnabled),a._waitingParsedUniqueId=e.uniqueId,e.parentId!==void 0&&(a._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(a._waitingParentInstanceIndex=e.parentInstanceIndex),a},t.prototype.getChildTransformNodes=function(e,r){var i=[];return this._getDescendants(i,e,function(a){return(!r||r(a))&&a instanceof t}),i},t.prototype.dispose=function(e,r){if(r===void 0&&(r=!1),this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){var i=this._parentContainer.transformNodes.indexOf(this);i>-1&&this._parentContainer.transformNodes.splice(i,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e)for(var a=this.getChildTransformNodes(!0),o=0,s=a;o<s.length;o++){var u=s[o];u.parent=null,u.computeWorldMatrix(!0)}n.prototype.dispose.call(this,e,r)},t.prototype.normalizeToUnitCube=function(e,r,i){e===void 0&&(e=!0),r===void 0&&(r=!1);var a=null,o=null;r&&(this.rotationQuaternion?(o=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(a=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));var s=this.getHierarchyBoundingVectors(e,i),u=s.max.subtract(s.min),f=Math.max(u.x,u.y,u.z);if(f===0)return this;var l=1/f;return this.scaling.scaleInPlace(l),r&&(this.rotationQuaternion&&o?this.rotationQuaternion.copyFrom(o):this.rotation&&a&&this.rotation.copyFrom(a)),this},t.prototype._syncAbsoluteScalingAndRotation=function(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)},t.BILLBOARDMODE_NONE=0,t.BILLBOARDMODE_X=1,t.BILLBOARDMODE_Y=2,t.BILLBOARDMODE_Z=4,t.BILLBOARDMODE_ALL=7,t.BILLBOARDMODE_USE_POSITION=128,t._TmpRotation=ce.Zero(),t._TmpScaling=O.Zero(),t._TmpTranslation=O.Zero(),t._LookAtVectorCache=new O(0,0,0),t._RotationAxisCache=new ce,ge([Ge("position")],t.prototype,"_position",void 0),ge([Ge("rotation")],t.prototype,"_rotation",void 0),ge([pr("rotationQuaternion")],t.prototype,"_rotationQuaternion",void 0),ge([Ge("scaling")],t.prototype,"_scaling",void 0),ge([Re("billboardMode")],t.prototype,"_billboardMode",void 0),ge([Re()],t.prototype,"scalingDeterminant",void 0),ge([Re("infiniteDistance")],t.prototype,"_infiniteDistance",void 0),ge([Re()],t.prototype,"ignoreNonUniformScaling",void 0),ge([Re()],t.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0),t}(je),Br=function(){function n(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=O.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}return n}(),Or=function(){function n(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new Br,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._meshCollisionData=new Mr,this._enableDistantPicking=!1}return n}(),Ze=function(n){_e(t,n);function t(e,r){r===void 0&&(r=null);var i=n.call(this,e,r,!1)||this;return i._internalAbstractMeshDataInfo=new Or,i._waitingMaterialId=null,i.cullingStrategy=t.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,i.onCollideObservable=new me,i.onCollisionPositionChangeObservable=new me,i.onMaterialChangedObservable=new me,i.definedFacingForward=!0,i._occlusionQuery=null,i._renderingGroup=null,i.alphaIndex=Number.MAX_VALUE,i.isVisible=!0,i.isPickable=!0,i.isNearPickable=!1,i.isNearGrabbable=!1,i.showSubMeshesBoundingBox=!1,i.isBlocker=!1,i.enablePointerMoveEvents=!1,i.outlineColor=we.Red(),i.outlineWidth=.02,i.overlayColor=we.Red(),i.overlayAlpha=.5,i.useOctreeForRenderingSelection=!0,i.useOctreeForPicking=!0,i.useOctreeForCollisions=!0,i.alwaysSelectAsActiveMesh=!1,i.doNotSyncBoundingInfo=!1,i.actionManager=null,i.ellipsoid=new O(.5,1,.5),i.ellipsoidOffset=new O(0,0,0),i.edgesWidth=1,i.edgesColor=new De(1,0,0,1),i._edgesRenderer=null,i._masterMesh=null,i._boundingInfo=null,i._boundingInfoIsDirty=!0,i._renderId=0,i._intersectionsInProgress=new Array,i._unIndexed=!1,i._lightSources=new Array,i._waitingData={lods:null,actions:null,freezeWorldMatrix:null},i._bonesTransformMatrices=null,i._transformMatrixTexture=null,i.onRebuildObservable=new me,i._onCollisionPositionChange=function(a,o,s){s===void 0&&(s=null),o.subtractToRef(i._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,i._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),i._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>Dr.CollisionsEpsilon&&i.position.addInPlace(i._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),s&&i.onCollideObservable.notifyObservers(s),i.onCollisionPositionChangeObservable.notifyObservers(i.position)},i.getScene().addMesh(i),i._resyncLightSources(),i._uniformBuffer=new Ar(i.getScene().getEngine(),void 0,void 0,e,!i.getScene().getEngine().isWebGPU),i._buildUniformLayout(),i}return Object.defineProperty(t,"BILLBOARDMODE_NONE",{get:function(){return Me.BILLBOARDMODE_NONE},enumerable:!1,configurable:!0}),Object.defineProperty(t,"BILLBOARDMODE_X",{get:function(){return Me.BILLBOARDMODE_X},enumerable:!1,configurable:!0}),Object.defineProperty(t,"BILLBOARDMODE_Y",{get:function(){return Me.BILLBOARDMODE_Y},enumerable:!1,configurable:!0}),Object.defineProperty(t,"BILLBOARDMODE_Z",{get:function(){return Me.BILLBOARDMODE_Z},enumerable:!1,configurable:!0}),Object.defineProperty(t,"BILLBOARDMODE_ALL",{get:function(){return Me.BILLBOARDMODE_ALL},enumerable:!1,configurable:!0}),Object.defineProperty(t,"BILLBOARDMODE_USE_POSITION",{get:function(){return Me.BILLBOARDMODE_USE_POSITION},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"facetNb",{get:function(){return this._internalAbstractMeshDataInfo._facetData.facetNb},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"partitioningSubdivisions",{get:function(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions},set:function(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"partitioningBBoxRatio",{get:function(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio},set:function(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"mustDepthSortFacets",{get:function(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort},set:function(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"facetDepthSortFrom",{get:function(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom},set:function(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"collisionRetryCount",{get:function(){return this._internalAbstractMeshDataInfo._collisionRetryCount},set:function(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isFacetDataEnabled",{get:function(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"morphTargetManager",{get:function(){return this._internalAbstractMeshDataInfo._morphTargetManager},set:function(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bakedVertexAnimationManager",{get:function(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager},set:function(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),t.prototype._syncGeometryWithMorphTargetManager=function(){},t.prototype._updateNonUniformScalingState=function(e){return n.prototype._updateNonUniformScalingState.call(this,e)?(this._markSubMeshesAsMiscDirty(),!0):!1},Object.defineProperty(t.prototype,"onCollide",{set:function(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onCollisionPositionChange",{set:function(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"visibility",{get:function(){return this._internalAbstractMeshDataInfo._visibility},set:function(e){if(this._internalAbstractMeshDataInfo._visibility!==e){var r=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(r===1&&e!==1||r!==1&&e===1)&&this._markSubMeshesAsMiscDirty()}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"renderingGroupId",{get:function(){return this._internalAbstractMeshDataInfo._renderingGroupId},set:function(e){this._internalAbstractMeshDataInfo._renderingGroupId=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"material",{get:function(){return this._internalAbstractMeshDataInfo._material},set:function(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))},enumerable:!1,configurable:!0}),t.prototype.getMaterialForRenderPass=function(e){var r;return(r=this._internalAbstractMeshDataInfo._materialForRenderPass)===null||r===void 0?void 0:r[e]},t.prototype.setMaterialForRenderPass=function(e,r){this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=r},Object.defineProperty(t.prototype,"receiveShadows",{get:function(){return this._internalAbstractMeshDataInfo._receiveShadows},set:function(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasVertexAlpha",{get:function(){return this._internalAbstractMeshDataInfo._hasVertexAlpha},set:function(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"useVertexColors",{get:function(){return this._internalAbstractMeshDataInfo._useVertexColors},set:function(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"computeBonesUsingShaders",{get:function(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders},set:function(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"numBoneInfluencers",{get:function(){return this._internalAbstractMeshDataInfo._numBoneInfluencers},set:function(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"applyFog",{get:function(){return this._internalAbstractMeshDataInfo._applyFog},set:function(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"enableDistantPicking",{get:function(){return this._internalAbstractMeshDataInfo._enableDistantPicking},set:function(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"layerMask",{get:function(){return this._internalAbstractMeshDataInfo._layerMask},set:function(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"collisionMask",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask},set:function(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"collisionResponse",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse},set:function(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"collisionGroup",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup},set:function(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"surroundingMeshes",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes},set:function(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lightSources",{get:function(){return this._lightSources},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_positions",{get:function(){return null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"skeleton",{get:function(){return this._internalAbstractMeshDataInfo._skeleton},set:function(e){var r=this._internalAbstractMeshDataInfo._skeleton;r&&r.needInitialSkinMatrix&&r._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()},enumerable:!1,configurable:!0}),t.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()},t.prototype.transferToEffect=function(e){var r=this._uniformBuffer;r.updateMatrix("world",e),r.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),r.update()},t.prototype.getMeshUniformBuffer=function(){return this._uniformBuffer},t.prototype.getClassName=function(){return"AbstractMesh"},t.prototype.toString=function(e){var r="Name: "+this.name+", isInstance: "+(this.getClassName()!=="InstancedMesh"?"YES":"NO");r+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);var i=this._internalAbstractMeshDataInfo._skeleton;return i&&(r+=", skeleton: "+i.name),e&&(r+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],r+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),r},t.prototype._getEffectiveParent=function(){return this._masterMesh&&this.billboardMode!==Me.BILLBOARDMODE_NONE?this._masterMesh:n.prototype._getEffectiveParent.call(this)},t.prototype._getActionManagerForTrigger=function(e,r){if(r===void 0&&(r=!0),this.actionManager&&(r||this.actionManager.isRecursive))if(e){if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}else return this.actionManager;return this.parent?this.parent._getActionManagerForTrigger(e,!1):null},t.prototype._rebuild=function(e){if(this.onRebuildObservable.notifyObservers(this),this._occlusionQuery!==null&&(this._occlusionQuery=null),!!this.subMeshes)for(var r=0,i=this.subMeshes;r<i.length;r++){var a=i[r];a._rebuild()}},t.prototype._resyncLightSources=function(){this._lightSources.length=0;for(var e=0,r=this.getScene().lights;e<r.length;e++){var i=r[e];!i.isEnabled()||i.canAffectMesh(this)&&this._lightSources.push(i)}this._markSubMeshesAsLightDirty()},t.prototype._resyncLightSource=function(e){var r=e.isEnabled()&&e.canAffectMesh(this),i=this._lightSources.indexOf(e),a=!1;if(i===-1){if(!r)return;this._lightSources.push(e)}else{if(r)return;a=!0,this._lightSources.splice(i,1)}this._markSubMeshesAsLightDirty(a)},t.prototype._unBindEffect=function(){for(var e=0,r=this.subMeshes;e<r.length;e++){var i=r[e];i.setEffect(null)}},t.prototype._removeLightSource=function(e,r){var i=this._lightSources.indexOf(e);i!==-1&&(this._lightSources.splice(i,1),this._markSubMeshesAsLightDirty(r))},t.prototype._markSubMeshesAsDirty=function(e){if(!!this.subMeshes)for(var r=0,i=this.subMeshes;r<i.length;r++)for(var a=i[r],o=0;o<a._drawWrappers.length;++o){var s=a._drawWrappers[o];!s||!s.defines||!s.defines.markAllAsDirty||e(s.defines)}},t.prototype._markSubMeshesAsLightDirty=function(e){e===void 0&&(e=!1),this._markSubMeshesAsDirty(function(r){return r.markAsLightDirty(e)})},t.prototype._markSubMeshesAsAttributesDirty=function(){this._markSubMeshesAsDirty(function(e){return e.markAsAttributesDirty()})},t.prototype._markSubMeshesAsMiscDirty=function(){this._markSubMeshesAsDirty(function(e){return e.markAsMiscDirty()})},t.prototype.markAsDirty=function(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this},t.prototype.resetDrawCache=function(e){if(!!this.subMeshes)for(var r=0,i=this.subMeshes;r<i.length;r++){var a=i[r];a.resetDrawCache(e)}},Object.defineProperty(t.prototype,"isBlocked",{get:function(){return!1},enumerable:!1,configurable:!0}),t.prototype.getLOD=function(e){return this},t.prototype.getTotalVertices=function(){return 0},t.prototype.getTotalIndices=function(){return 0},t.prototype.getIndices=function(){return null},t.prototype.getVerticesData=function(e){return null},t.prototype.setVerticesData=function(e,r,i,a){return this},t.prototype.updateVerticesData=function(e,r,i,a){return this},t.prototype.setIndices=function(e,r){return this},t.prototype.isVerticesDataPresent=function(e){return!1},t.prototype.getBoundingInfo=function(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)},t.prototype.setBoundingInfo=function(e){return this._boundingInfo=e,this},Object.defineProperty(t.prototype,"hasBoundingInfo",{get:function(){return this._boundingInfo!==null},enumerable:!1,configurable:!0}),t.prototype.buildBoundingInfo=function(e,r,i){return this._boundingInfo=new Pe(e,r,i),this._boundingInfo},t.prototype.normalizeToUnitCube=function(e,r,i){return e===void 0&&(e=!0),r===void 0&&(r=!1),n.prototype.normalizeToUnitCube.call(this,e,r,i)},Object.defineProperty(t.prototype,"useBones",{get:function(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(_.MatricesIndicesKind)&&this.isVerticesDataPresent(_.MatricesWeightsKind)},enumerable:!1,configurable:!0}),t.prototype._preActivate=function(){},t.prototype._preActivateForIntermediateRendering=function(e){},t.prototype._activate=function(e,r){return this._renderId=e,!0},t.prototype._postActivate=function(){},t.prototype._freeze=function(){},t.prototype._unFreeze=function(){},t.prototype.getWorldMatrix=function(){return this._masterMesh&&this.billboardMode===Me.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():n.prototype.getWorldMatrix.call(this)},t.prototype._getWorldMatrixDeterminant=function(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():n.prototype._getWorldMatrixDeterminant.call(this)},Object.defineProperty(t.prototype,"isAnInstance",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasInstances",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasThinInstances",{get:function(){return!1},enumerable:!1,configurable:!0}),t.prototype.movePOV=function(e,r,i){return this.position.addInPlace(this.calcMovePOV(e,r,i)),this},t.prototype.calcMovePOV=function(e,r,i){var a=new X,o=this.rotationQuaternion?this.rotationQuaternion:ce.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z);o.toRotationMatrix(a);var s=O.Zero(),u=this.definedFacingForward?-1:1;return O.TransformCoordinatesFromFloatsToRef(e*u,r,i*u,a,s),s},t.prototype.rotatePOV=function(e,r,i){return this.rotation.addInPlace(this.calcRotatePOV(e,r,i)),this},t.prototype.calcRotatePOV=function(e,r,i){var a=this.definedFacingForward?1:-1;return new O(e*a,r,i*a)},t.prototype.refreshBoundingInfo=function(e,r){return e===void 0&&(e=!1),r===void 0&&(r=!1),this._boundingInfo&&this._boundingInfo.isLocked?this:(this._refreshBoundingInfo(this._getPositionData(e,r),null),this)},t.prototype._refreshBoundingInfo=function(e,r){if(e){var i=dt(e,0,this.getTotalVertices(),r);this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Pe(i.minimum,i.maximum)}if(this.subMeshes)for(var a=0;a<this.subMeshes.length;a++)this.subMeshes[a].refreshBoundingInfo(e);this._updateBoundingInfo()},t.prototype._getData=function(e,r,i,a){if(e===void 0&&(e=!1),r===void 0&&(r=!1),a===void 0&&(a=_.PositionKind),i=i!=null?i:this.getVerticesData(a).slice(),i&&r&&this.morphTargetManager)for(var o=0,s=0,u=0;u<i.length;u++){for(var f=0;f<this.morphTargetManager.numTargets;f++){var l=this.morphTargetManager.getTarget(f),c=l.influence;if(c>0){var h=l.getPositions();h&&(i[u]+=(h[u]-i[u])*c)}}if(o++,a===_.PositionKind&&this._positions&&o===3){o=0;var d=s*3;this._positions[s++].copyFromFloats(i[d],i[d+1],i[d+2])}}if(i&&e&&this.skeleton){var v=this.getVerticesData(_.MatricesIndicesKind),g=this.getVerticesData(_.MatricesWeightsKind);if(g&&v)for(var p=this.numBoneInfluencers>4,m=p?this.getVerticesData(_.MatricesIndicesExtraKind):null,M=p?this.getVerticesData(_.MatricesWeightsExtraKind):null,A=this.skeleton.getTransformMatrices(this),y=z.Vector3[0],b=z.Matrix[0],x=z.Matrix[1],I=0,d=0;d<i.length;d+=3,I+=4){b.reset();var D=void 0,T=void 0;for(D=0;D<4;D++)T=g[I+D],T>0&&(X.FromFloat32ArrayToRefScaled(A,Math.floor(v[I+D]*16),T,x),b.addToSelf(x));if(p)for(D=0;D<4;D++)T=M[I+D],T>0&&(X.FromFloat32ArrayToRefScaled(A,Math.floor(m[I+D]*16),T,x),b.addToSelf(x));a===_.NormalKind?O.TransformNormalFromFloatsToRef(i[d],i[d+1],i[d+2],b,y):O.TransformCoordinatesFromFloatsToRef(i[d],i[d+1],i[d+2],b,y),y.toArray(i,d),a===_.PositionKind&&this._positions&&this._positions[d/3].copyFrom(y)}}return i},t.prototype.getNormalsData=function(e,r){return e===void 0&&(e=!1),r===void 0&&(r=!1),this._getData(e,r,null,_.NormalKind)},t.prototype.getPositionData=function(e,r,i){return e===void 0&&(e=!1),r===void 0&&(r=!1),this._getData(e,r,i,_.PositionKind)},t.prototype._getPositionData=function(e,r){var i,a=this.getVerticesData(_.PositionKind);if(this._internalAbstractMeshDataInfo._positions&&(this._internalAbstractMeshDataInfo._positions=null),a&&(e&&this.skeleton||r&&this.morphTargetManager)){if(a=a.slice(),this._generatePointsArray(),this._positions){var o=this._positions;this._internalAbstractMeshDataInfo._positions=new Array(o.length);for(var s=0;s<o.length;s++)this._internalAbstractMeshDataInfo._positions[s]=((i=o[s])===null||i===void 0?void 0:i.clone())||new O}return this.getPositionData(e,r,a)}return a},t.prototype._updateBoundingInfo=function(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new Pe(O.Zero(),O.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this},t.prototype._updateSubMeshesBoundingInfo=function(e){if(!this.subMeshes)return this;for(var r=this.subMeshes.length,i=0;i<r;i++){var a=this.subMeshes[i];(r>1||!a.IsGlobal)&&a.updateBoundingInfo(e)}return this},t.prototype._afterComputeWorldMatrix=function(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)},t.prototype.isInFrustum=function(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)},t.prototype.isCompletelyInFrustum=function(e){return this.getBoundingInfo().isCompletelyInFrustum(e)},t.prototype.intersectsMesh=function(e,r,i){r===void 0&&(r=!1);var a=this.getBoundingInfo(),o=e.getBoundingInfo();if(a.intersects(o,r))return!0;if(i)for(var s=0,u=this.getChildMeshes();s<u.length;s++){var f=u[s];if(f.intersectsMesh(e,r,!0))return!0}return!1},t.prototype.intersectsPoint=function(e){return this.getBoundingInfo().intersectsPoint(e)},Object.defineProperty(t.prototype,"checkCollisions",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions},set:function(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"collider",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider},enumerable:!1,configurable:!0}),t.prototype.moveWithCollisions=function(e){var r=this.getAbsolutePosition();r.addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);var i=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=i.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,i.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this},t.prototype._collideForSubMesh=function(e,r,i){var a;if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(r)){e._lastColliderTransformMatrix=r.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];for(var o=e.verticesStart,s=e.verticesStart+e.verticesCount,u=o;u<s;u++)e._lastColliderWorldVertices.push(O.TransformCoordinates(this._positions[u],r))}return i._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),((a=e.getMaterial())===null||a===void 0?void 0:a.fillMode)===7),this},t.prototype._processCollisionsForSubMeshes=function(e,r){for(var i=this._scene.getCollidingSubMeshCandidates(this,e),a=i.length,o=0;o<a;o++){var s=i.data[o];a>1&&!s._checkCollision(e)||this._collideForSubMesh(s,r,e)}return this},t.prototype._shouldConvertRHS=function(){return!1},t.prototype._checkCollision=function(e){if(!this.getBoundingInfo()._checkCollision(e))return this;var r=z.Matrix[0],i=z.Matrix[1];return X.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,r),this.worldMatrixFromCache.multiplyToRef(r,i),this._processCollisionsForSubMeshes(e,i),this},t.prototype._generatePointsArray=function(){return!1},t.prototype.intersects=function(e,r,i,a,o,s){a===void 0&&(a=!1),s===void 0&&(s=!1);var u=new Ir,f=this.getClassName()==="InstancedLinesMesh"||this.getClassName()==="LinesMesh"?this.intersectionThreshold:0,l=this.getBoundingInfo();if(!this.subMeshes||!s&&(!e.intersectsSphere(l.boundingSphere,f)||!e.intersectsBox(l.boundingBox,f)))return u;if(a)return u.hit=!s,u.pickedMesh=s?null:this,u.distance=s?0:O.Distance(e.origin,l.boundingSphere.center),u.subMeshId=0,u;if(!this._generatePointsArray())return u;for(var c=null,h=this._scene.getIntersectingSubMeshCandidates(this,e),d=h.length,v=!1,g=0;g<d;g++){var p=h.data[g],m=p.getMaterial();if(!!m&&(m.fillMode==7||m.fillMode==0||m.fillMode==1||m.fillMode==2||m.fillMode==4)){v=!0;break}}if(!v)return u.hit=!0,u.pickedMesh=this,u.distance=O.Distance(e.origin,l.boundingSphere.center),u.subMeshId=-1,u;for(var g=0;g<d;g++){var p=h.data[g];if(!(d>1&&!p.canIntersects(e))){var M=p.intersects(e,this._positions,this.getIndices(),r,i);if(M&&(r||!c||M.distance<c.distance)&&(c=M,c.subMeshId=g,r))break}}if(c){var A=o!=null?o:this.getWorldMatrix(),y=z.Vector3[0],b=z.Vector3[1];O.TransformCoordinatesToRef(e.origin,A,y),e.direction.scaleToRef(c.distance,b);var x=O.TransformNormal(b,A),I=x.addInPlace(y);return u.hit=!0,u.distance=O.Distance(y,I),u.pickedPoint=I,u.pickedMesh=this,u.bu=c.bu||0,u.bv=c.bv||0,u.subMeshFaceId=c.faceId,u.faceId=c.faceId+h.data[c.subMeshId].indexStart/(this.getClassName().indexOf("LinesMesh")!==-1?2:3),u.subMeshId=c.subMeshId,u}return u},t.prototype.clone=function(e,r,i){return null},t.prototype.releaseSubMeshes=function(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=new Array;return this},t.prototype.dispose=function(e,r){var i=this;r===void 0&&(r=!1);var a;for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this.getScene().freeActiveMeshes(),this.getScene().freeRenderingGroups(),this.actionManager!==void 0&&this.actionManager!==null&&(this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),a=0;a<this._intersectionsInProgress.length;a++){var o=this._intersectionsInProgress[a],s=o._intersectionsInProgress.indexOf(this);o._intersectionsInProgress.splice(s,1)}this._intersectionsInProgress.length=0;var u=this.getScene().lights;u.forEach(function(c){var h=c.includedOnlyMeshes.indexOf(i);h!==-1&&c.includedOnlyMeshes.splice(h,1),h=c.excludedMeshes.indexOf(i),h!==-1&&c.excludedMeshes.splice(h,1);var d=c.getShadowGenerator();if(d){var v=d.getShadowMap();v&&v.renderList&&(h=v.renderList.indexOf(i),h!==-1&&v.renderList.splice(h,1))}}),(this.getClassName()!=="InstancedMesh"||this.getClassName()!=="InstancedLinesMesh")&&this.releaseSubMeshes();var f=this.getScene().getEngine();if(this._occlusionQuery!==null&&(this.isOcclusionQueryInProgress=!1,f.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),f.wipeCaches(),this.getScene().removeMesh(this),this._parentContainer){var l=this._parentContainer.meshes.indexOf(this);l>-1&&this._parentContainer.meshes.splice(l,1),this._parentContainer=null}if(r&&this.material&&(this.material.getClassName()==="MultiMaterial"?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(a=0;a<this.getScene().particleSystems.length;a++)this.getScene().particleSystems[a].emitter===this&&(this.getScene().particleSystems[a].dispose(),a--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),n.prototype.dispose.call(this,e,r)},t.prototype.addChild=function(e,r){return r===void 0&&(r=!1),e.setParent(this,r),this},t.prototype.removeChild=function(e,r){return r===void 0&&(r=!1),e.setParent(null,r),this},t.prototype._initFacetData=function(){var e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=new Array),e.facetPositions||(e.facetPositions=new Array),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(var r=0;r<e.facetNb;r++)e.facetNormals[r]=O.Zero(),e.facetPositions[r]=O.Zero();return e.facetDataEnabled=!0,this},t.prototype.updateFacetData=function(){var e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();var r=this.getVerticesData(_.PositionKind),i=this.getIndices(),a=this.getVerticesData(_.NormalKind),o=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,i instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(i);else if(i instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(i);else{for(var s=!1,u=0;u<i.length;u++)if(i[u]>65535){s=!0;break}s?e.depthSortedIndices=new Uint32Array(i):e.depthSortedIndices=new Uint16Array(i)}if(e.facetDepthSortFunction=function(g,p){return p.sqDistance-g.sqDistance},!e.facetDepthSortFrom){var f=this.getScene().activeCamera;e.facetDepthSortFrom=f?f.position:O.Zero()}e.depthSortedFacets=[];for(var l=0;l<e.facetNb;l++){var c={ind:l*3,sqDistance:0};e.depthSortedFacets.push(c)}e.invertedMatrix=X.Identity(),e.facetDepthSortOrigin=O.Zero()}e.bbSize.x=o.maximum.x-o.minimum.x>xe?o.maximum.x-o.minimum.x:xe,e.bbSize.y=o.maximum.y-o.minimum.y>xe?o.maximum.y-o.minimum.y:xe,e.bbSize.z=o.maximum.z-o.minimum.z>xe?o.maximum.z-o.minimum.z:xe;var h=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(h=h>e.bbSize.z?h:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/h),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/h),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/h),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=o,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),O.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,a&&Q.ComputeNormals(r,i,a,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);for(var d=e.depthSortedIndices.length/3|0,l=0;l<d;l++){var v=e.depthSortedFacets[l].ind;e.depthSortedIndices[l*3]=i[v],e.depthSortedIndices[l*3+1]=i[v+1],e.depthSortedIndices[l*3+2]=i[v+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this},t.prototype.getFacetLocalNormals=function(){var e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals},t.prototype.getFacetLocalPositions=function(){var e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions},t.prototype.getFacetLocalPartitioning=function(){var e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning},t.prototype.getFacetPosition=function(e){var r=O.Zero();return this.getFacetPositionToRef(e,r),r},t.prototype.getFacetPositionToRef=function(e,r){var i=this.getFacetLocalPositions()[e],a=this.getWorldMatrix();return O.TransformCoordinatesToRef(i,a,r),this},t.prototype.getFacetNormal=function(e){var r=O.Zero();return this.getFacetNormalToRef(e,r),r},t.prototype.getFacetNormalToRef=function(e,r){var i=this.getFacetLocalNormals()[e];return O.TransformNormalToRef(i,this.getWorldMatrix(),r),this},t.prototype.getFacetsAtLocalCoordinates=function(e,r,i){var a=this.getBoundingInfo(),o=this._internalAbstractMeshDataInfo._facetData,s=Math.floor((e-a.minimum.x*o.partitioningBBoxRatio)*o.subDiv.X*o.partitioningBBoxRatio/o.bbSize.x),u=Math.floor((r-a.minimum.y*o.partitioningBBoxRatio)*o.subDiv.Y*o.partitioningBBoxRatio/o.bbSize.y),f=Math.floor((i-a.minimum.z*o.partitioningBBoxRatio)*o.subDiv.Z*o.partitioningBBoxRatio/o.bbSize.z);return s<0||s>o.subDiv.max||u<0||u>o.subDiv.max||f<0||f>o.subDiv.max?null:o.facetPartitioning[s+o.subDiv.max*u+o.subDiv.max*o.subDiv.max*f]},t.prototype.getClosestFacetAtCoordinates=function(e,r,i,a,o,s){o===void 0&&(o=!1),s===void 0&&(s=!0);var u=this.getWorldMatrix(),f=z.Matrix[5];u.invertToRef(f);var l=z.Vector3[8];O.TransformCoordinatesFromFloatsToRef(e,r,i,f,l);var c=this.getClosestFacetAtLocalCoordinates(l.x,l.y,l.z,a,o,s);return a&&O.TransformCoordinatesFromFloatsToRef(a.x,a.y,a.z,u,a),c},t.prototype.getClosestFacetAtLocalCoordinates=function(e,r,i,a,o,s){o===void 0&&(o=!1),s===void 0&&(s=!0);var u=null,f=0,l=0,c=0,h=0,d=0,v=0,g=0,p=0,m=this.getFacetLocalPositions(),M=this.getFacetLocalNormals(),A=this.getFacetsAtLocalCoordinates(e,r,i);if(!A)return null;for(var y=Number.MAX_VALUE,b=y,x,I,D,T=0;T<A.length;T++)x=A[T],I=M[x],D=m[x],h=(e-D.x)*I.x+(r-D.y)*I.y+(i-D.z)*I.z,(!o||o&&s&&h>=0||o&&!s&&h<=0)&&(h=I.x*D.x+I.y*D.y+I.z*D.z,d=-(I.x*e+I.y*r+I.z*i-h)/(I.x*I.x+I.y*I.y+I.z*I.z),v=e+I.x*d,g=r+I.y*d,p=i+I.z*d,f=v-e,l=g-r,c=p-i,b=f*f+l*l+c*c,b<y&&(y=b,u=x,a&&(a.x=v,a.y=g,a.z=p)));return u},t.prototype.getFacetDataParameters=function(){return this._internalAbstractMeshDataInfo._facetData.facetParameters},t.prototype.disableFacetData=function(){var e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=new Array,e.facetNormals=new Array,e.facetPartitioning=new Array,e.facetParameters=null,e.depthSortedIndices=new Uint32Array(0)),this},t.prototype.updateIndices=function(e,r,i){return this},t.prototype.createNormals=function(e){var r=this.getVerticesData(_.PositionKind),i=this.getIndices(),a;return this.isVerticesDataPresent(_.NormalKind)?a=this.getVerticesData(_.NormalKind):a=[],Q.ComputeNormals(r,i,a,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(_.NormalKind,a,e),this},t.prototype.alignWithNormal=function(e,r){r||(r=vt.Y);var i=z.Vector3[0],a=z.Vector3[1];return O.CrossToRef(r,e,a),O.CrossToRef(e,a,i),this.rotationQuaternion?ce.RotationQuaternionFromAxisToRef(i,e,a,this.rotationQuaternion):O.RotationFromAxisToRef(i,e,a,this.rotation),this},t.prototype._checkOcclusionQuery=function(){return!1},t.prototype.disableEdgesRendering=function(){throw se("EdgesRenderer")},t.prototype.enableEdgesRendering=function(e,r,i){throw se("EdgesRenderer")},t.prototype.getConnectedParticleSystems=function(){var e=this;return this._scene.particleSystems.filter(function(r){return r.emitter===e})},t.OCCLUSION_TYPE_NONE=0,t.OCCLUSION_TYPE_OPTIMISTIC=1,t.OCCLUSION_TYPE_STRICT=2,t.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,t.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,t.CULLINGSTRATEGY_STANDARD=0,t.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,t.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,t.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,t}(Me);pt("BABYLON.AbstractMesh",Ze);var Cr=function(){function n(t,e){this.distanceOrScreenCoverage=t,this.mesh=e}return n}(),Dt=function(){function n(){}return n}(),Tr=function(){function n(){this.visibleInstances={},this.batchCache=new ct,this.batchCacheReplacementModeInFrozenMode=new ct,this.instancesBufferSize=32*16*4}return n}(),ct=function(){function n(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array,this.hardwareInstancedRendering=new Array}return n}(),Pr=function(){function n(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=32*16,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}return n}(),wr=function(){function n(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0}return n}(),S=function(n){_e(t,n);function t(e,r,i,a,o,s){r===void 0&&(r=null),i===void 0&&(i=null),a===void 0&&(a=null),s===void 0&&(s=!0);var u=n.call(this,e,r)||this;if(u._internalMeshDataInfo=new wr,u.delayLoadState=0,u.instances=new Array,u._creationDataStorage=null,u._geometry=null,u._instanceDataStorage=new Tr,u._thinInstanceDataStorage=new Pr,u._shouldGenerateFlatShading=!1,u._originalBuilderSideOrientation=t.DEFAULTSIDE,u.overrideMaterialSideOrientation=null,u.ignoreCameraMaxZ=!1,r=u.getScene(),u._onBeforeDraw=function(m,M,A){m&&A&&(u._uniformBuffer?u.transferToEffect(M):A.bindOnlyWorldMatrix(M))},a){if(a._geometry&&a._geometry.applyToMesh(u),mt.DeepCopy(a,u,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo"],["_poseMatrix"]),u._internalMeshDataInfo._source=a,r.useClonedMeshMap&&(a._internalMeshDataInfo.meshMap||(a._internalMeshDataInfo.meshMap={}),a._internalMeshDataInfo.meshMap[u.uniqueId]=u),u._originalBuilderSideOrientation=a._originalBuilderSideOrientation,u._creationDataStorage=a._creationDataStorage,a._ranges){var f=a._ranges;for(var l in f)!Object.prototype.hasOwnProperty.call(f,l)||!f[l]||u.createAnimationRange(l,f[l].from,f[l].to)}if(a.metadata&&a.metadata.clone?u.metadata=a.metadata.clone():u.metadata=a.metadata,de&&de.HasTags(a)&&de.AddTagsTo(u,de.GetTags(a,!0)),u.setEnabled(a.isEnabled(!1)),u.parent=a.parent,u.setPivotMatrix(a.getPivotMatrix()),u.id=e+"."+a.id,u.material=a.material,!o)for(var c=a.getDescendants(!0),h=0;h<c.length;h++){var d=c[h];d.clone&&d.clone(e+"."+d.name,u)}if(a.morphTargetManager&&(u.morphTargetManager=a.morphTargetManager),r.getPhysicsEngine){var v=r.getPhysicsEngine();if(s&&v){var g=v.getImpostorForPhysicsObject(a);g&&(u.physicsImpostor=g.clone(u))}}for(var h=0;h<r.particleSystems.length;h++){var p=r.particleSystems[h];p.emitter===a&&p.clone(p.name,u)}u.skeleton=a.skeleton,u.refreshBoundingInfo(!0,!0),u.computeWorldMatrix(!0)}return i!==null&&(u.parent=i),u._instanceDataStorage.hardwareInstancedRendering=u.getEngine().getCaps().instancedArrays,u._internalMeshDataInfo._onMeshReadyObserverAdded=function(m){m.unregisterOnNextCall=!0,u.isReady(!0)?u.onMeshReadyObservable.notifyObservers(u):u._internalMeshDataInfo._checkReadinessObserver||(u._internalMeshDataInfo._checkReadinessObserver=u._scene.onBeforeRenderObservable.add(function(){u.isReady(!0)&&(u._scene.onBeforeRenderObservable.remove(u._internalMeshDataInfo._checkReadinessObserver),u._internalMeshDataInfo._checkReadinessObserver=null,u.onMeshReadyObservable.notifyObservers(u))}))},u.onMeshReadyObservable=new me(u._internalMeshDataInfo._onMeshReadyObserverAdded),a&&a.onClonedObservable.notifyObservers(u),u}return t._GetDefaultSideOrientation=function(e){return e||t.FRONTSIDE},Object.defineProperty(t.prototype,"useLODScreenCoverage",{get:function(){return this._internalMeshDataInfo._useLODScreenCoverage},set:function(e){this._internalMeshDataInfo._useLODScreenCoverage=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"computeBonesUsingShaders",{get:function(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders},set:function(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(_.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(_.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onBeforeRenderObservable",{get:function(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new me),this._internalMeshDataInfo._onBeforeRenderObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onBeforeBindObservable",{get:function(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new me),this._internalMeshDataInfo._onBeforeBindObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onAfterRenderObservable",{get:function(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new me),this._internalMeshDataInfo._onAfterRenderObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onBetweenPassObservable",{get:function(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new me),this._internalMeshDataInfo._onBetweenPassObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onBeforeDrawObservable",{get:function(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new me),this._internalMeshDataInfo._onBeforeDrawObservable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onBeforeDraw",{set:function(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasInstances",{get:function(){return this.instances.length>0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasThinInstances",{get:function(){var e;return((e=this._thinInstanceDataStorage.instancesCount)!==null&&e!==void 0?e:0)>0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"forcedInstanceCount",{get:function(){return this._internalMeshDataInfo._forcedInstanceCount},set:function(e){this._internalMeshDataInfo._forcedInstanceCount=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"source",{get:function(){return this._internalMeshDataInfo._source},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cloneMeshMap",{get:function(){return this._internalMeshDataInfo.meshMap},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isUnIndexed",{get:function(){return this._unIndexed},set:function(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldMatrixInstancedBuffer",{get:function(){return this._instanceDataStorage.instancesData},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"previousWorldMatrixInstancedBuffer",{get:function(){return this._instanceDataStorage.instancesPreviousData},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"manualUpdateOfWorldMatrixInstancedBuffer",{get:function(){return this._instanceDataStorage.manualUpdate},set:function(e){this._instanceDataStorage.manualUpdate=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"manualUpdateOfPreviousWorldMatrixInstancedBuffer",{get:function(){return this._instanceDataStorage.previousManualUpdate},set:function(e){this._instanceDataStorage.previousManualUpdate=e},enumerable:!1,configurable:!0}),t.prototype.instantiateHierarchy=function(e,r,i){e===void 0&&(e=null);var a=this.getTotalVertices()===0||r&&r.doNotInstantiate&&(r.doNotInstantiate===!0||r.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));a.parent=e||this.parent,a.position=this.position.clone(),a.scaling=this.scaling.clone(),this.rotationQuaternion?a.rotationQuaternion=this.rotationQuaternion.clone():a.rotation=this.rotation.clone(),i&&i(this,a);for(var o=0,s=this.getChildTransformNodes(!0);o<s.length;o++){var u=s[o];u.instantiateHierarchy(a,r,i)}return a},t.prototype.getClassName=function(){return"Mesh"},Object.defineProperty(t.prototype,"_isMesh",{get:function(){return!0},enumerable:!1,configurable:!0}),t.prototype.toString=function(e){var r=n.prototype.toString.call(this,e);if(r+=", n vertices: "+this.getTotalVertices(),r+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(var i=0;i<this.animations.length;i++)r+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){var a=this.getIndices(),o=this.getVerticesData(_.PositionKind);o&&a&&(r+=", flat shading: "+(o.length/3===a.length?"YES":"NO"))}else r+=", flat shading: UNKNOWN";return r},t.prototype._unBindEffect=function(){n.prototype._unBindEffect.call(this);for(var e=0,r=this.instances;e<r.length;e++){var i=r[e];i._unBindEffect()}},Object.defineProperty(t.prototype,"hasLODLevels",{get:function(){return this._internalMeshDataInfo._LODLevels.length>0},enumerable:!1,configurable:!0}),t.prototype.getLODLevels=function(){return this._internalMeshDataInfo._LODLevels},t.prototype._sortLODLevels=function(){var e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort(function(r,i){return r.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:r.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0})},t.prototype.addLODLevel=function(e,r){if(r&&r._masterMesh)return ue.Warn("You cannot use a mesh as LOD level twice"),this;var i=new Cr(e,r);return this._internalMeshDataInfo._LODLevels.push(i),r&&(r._masterMesh=this),this._sortLODLevels(),this},t.prototype.getLODLevelAtDistance=function(e){for(var r=this._internalMeshDataInfo,i=0;i<r._LODLevels.length;i++){var a=r._LODLevels[i];if(a.distanceOrScreenCoverage===e)return a.mesh}return null},t.prototype.removeLODLevel=function(e){for(var r=this._internalMeshDataInfo,i=0;i<r._LODLevels.length;i++)r._LODLevels[i].mesh===e&&(r._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this},t.prototype.getLOD=function(e,r){var i=this._internalMeshDataInfo;if(!i._LODLevels||i._LODLevels.length===0)return this;var a;if(r)a=r;else{var o=this.getBoundingInfo();a=o.boundingSphere}var s=a.centerWorld.subtract(e.globalPosition).length(),u=i._useLODScreenCoverage,f=s,l=1;if(u){var c=e.screenArea,h=a.radiusWorld*e.minZ/s;h=h*h*Math.PI,f=h/c,l=-1}if(l*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>l*f)return this.onLODLevelSelection&&this.onLODLevelSelection(f,this,this),this;for(var d=0;d<i._LODLevels.length;d++){var v=i._LODLevels[d];if(l*v.distanceOrScreenCoverage<l*f){if(v.mesh){if(v.mesh.delayLoadState===4)return v.mesh._checkDelayState(),this;if(v.mesh.delayLoadState===2)return this;v.mesh._preActivate(),v.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(f,this,v.mesh),v.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(f,this,this),this},Object.defineProperty(t.prototype,"geometry",{get:function(){return this._geometry},enumerable:!1,configurable:!0}),t.prototype.getTotalVertices=function(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()},t.prototype.getVerticesData=function(e,r,i){var a,o;if(!this._geometry)return null;var s=(o=(a=this._userInstancedBuffersStorage)===null||a===void 0?void 0:a.vertexBuffers[e])===null||o===void 0?void 0:o.getFloatData(this._geometry.getTotalVertices(),i||r&&this._geometry.meshes.length!==1);return s||(s=this._geometry.getVerticesData(e,r,i)),s},t.prototype.getVertexBuffer=function(e){var r,i;return this._geometry?(i=(r=this._userInstancedBuffersStorage)===null||r===void 0?void 0:r.vertexBuffers[e])!==null&&i!==void 0?i:this._geometry.getVertexBuffer(e):null},t.prototype.isVerticesDataPresent=function(e){var r;return this._geometry?((r=this._userInstancedBuffersStorage)===null||r===void 0?void 0:r.vertexBuffers[e])!==void 0||this._geometry.isVerticesDataPresent(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1},t.prototype.isVertexBufferUpdatable=function(e){var r,i;return this._geometry?((i=(r=this._userInstancedBuffersStorage)===null||r===void 0?void 0:r.vertexBuffers[e])===null||i===void 0?void 0:i.isUpdatable())||this._geometry.isVertexBufferUpdatable(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1},t.prototype.getVerticesDataKinds=function(){if(!this._geometry){var e=new Array;return this._delayInfo&&this._delayInfo.forEach(function(a){e.push(a)}),e}var r=this._geometry.getVerticesDataKinds();if(this._userInstancedBuffersStorage)for(var i in this._userInstancedBuffersStorage.vertexBuffers)r.push(i);return r},t.prototype.getTotalIndices=function(){return this._geometry?this._geometry.getTotalIndices():0},t.prototype.getIndices=function(e,r){return this._geometry?this._geometry.getIndices(e,r):[]},Object.defineProperty(t.prototype,"isBlocked",{get:function(){return this._masterMesh!==null&&this._masterMesh!==void 0},enumerable:!1,configurable:!0}),t.prototype.isReady=function(e,r){var i,a,o,s,u,f;if(e===void 0&&(e=!1),r===void 0&&(r=!1),this.delayLoadState===2||!n.prototype.isReady.call(this,e))return!1;if(!this.subMeshes||this.subMeshes.length===0||!e)return!0;var l=this.getEngine(),c=this.getScene(),h=r||l.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();var d=this.material||c.defaultMaterial;if(d){if(d._storeEffectOnSubMeshes)for(var v=0,g=this.subMeshes;v<g.length;v++){var p=g[v],m=p.getMaterial();if(m){if(m._storeEffectOnSubMeshes){if(!m.isReadyForSubMesh(this,p,h))return!1}else if(!m.isReady(this,h))return!1}}else if(!d.isReady(this,h))return!1}for(var M=l.currentRenderPassId,A=0,y=this.lightSources;A<y.length;A++){var b=y[A],x=b.getShadowGenerator();if(x&&(!(!((i=x.getShadowMap())===null||i===void 0)&&i.renderList)||((a=x.getShadowMap())===null||a===void 0?void 0:a.renderList)&&((s=(o=x.getShadowMap())===null||o===void 0?void 0:o.renderList)===null||s===void 0?void 0:s.indexOf(this))!==-1)){x.getShadowMap()&&(l.currentRenderPassId=x.getShadowMap().renderPassId);for(var I=0,D=this.subMeshes;I<D.length;I++){var p=D[I];if(!x.isReady(p,h,(f=(u=p.getMaterial())===null||u===void 0?void 0:u.needAlphaBlendingForMesh(this))!==null&&f!==void 0?f:!1))return l.currentRenderPassId=M,!1}l.currentRenderPassId=M}}for(var T=0,C=this._internalMeshDataInfo._LODLevels;T<C.length;T++){var B=C[T];if(B.mesh&&!B.mesh.isReady(h))return!1}return!0},Object.defineProperty(t.prototype,"areNormalsFrozen",{get:function(){return this._internalMeshDataInfo._areNormalsFrozen},enumerable:!1,configurable:!0}),t.prototype.freezeNormals=function(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this},t.prototype.unfreezeNormals=function(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this},Object.defineProperty(t.prototype,"overridenInstanceCount",{set:function(e){this._instanceDataStorage.overridenInstanceCount=e},enumerable:!1,configurable:!0}),t.prototype._preActivate=function(){var e=this._internalMeshDataInfo,r=this.getScene().getRenderId();return e._preActivateId===r?this:(e._preActivateId=r,this._instanceDataStorage.visibleInstances=null,this)},t.prototype._preActivateForIntermediateRendering=function(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this},t.prototype._registerInstanceForRenderId=function(e,r){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:r,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[r]||(this._instanceDataStorage.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=r,this._instanceDataStorage.visibleInstances[r]=new Array),this._instanceDataStorage.visibleInstances[r].push(e),this},t.prototype._afterComputeWorldMatrix=function(){n.prototype._afterComputeWorldMatrix.call(this),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))},t.prototype._postActivate=function(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))},t.prototype.refreshBoundingInfo=function(e,r){if(e===void 0&&(e=!1),r===void 0&&(r=!1),this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;var i=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(e,r),i),this},t.prototype._createGlobalSubMesh=function(e){var r=this.getTotalVertices();if(!r||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){var i=this.getIndices();if(!i)return null;var a=i.length,o=!1;if(e)o=!0;else for(var s=0,u=this.subMeshes;s<u.length;s++){var f=u[s];if(f.indexStart+f.indexCount>a){o=!0;break}if(f.verticesStart+f.verticesCount>r){o=!0;break}}if(!o)return this.subMeshes[0]}return this.releaseSubMeshes(),new pe(0,0,r,0,this.getTotalIndices(),this)},t.prototype.subdivide=function(e){if(!(e<1)){for(var r=this.getTotalIndices(),i=r/e|0,a=0;i%3!==0;)i++;this.releaseSubMeshes();for(var o=0;o<e&&!(a>=r);o++)pe.CreateFromIndices(0,a,o===e-1?r-a:i,this),a+=i;this.synchronizeInstances()}},t.prototype.setVerticesData=function(e,r,i,a){if(i===void 0&&(i=!1),this._geometry)this._geometry.setVerticesData(e,r,i,a);else{var o=new Q;o.set(r,e);var s=this.getScene();new Oe(Oe.RandomId(),s,o,i,this)}return this},t.prototype.removeVerticesData=function(e){!this._geometry||this._geometry.removeVerticesData(e)},t.prototype.markVerticesDataAsUpdatable=function(e,r){r===void 0&&(r=!0);var i=this.getVertexBuffer(e);!i||i.isUpdatable()===r||this.setVerticesData(e,this.getVerticesData(e),r)},t.prototype.setVerticesBuffer=function(e,r){return r===void 0&&(r=!0),this._geometry||(this._geometry=Oe.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,r),this},t.prototype.updateVerticesData=function(e,r,i,a){return this._geometry?(a?(this.makeGeometryUnique(),this.updateVerticesData(e,r,i,!1)):this._geometry.updateVerticesData(e,r,i),this):this},t.prototype.updateMeshPositions=function(e,r){r===void 0&&(r=!0);var i=this.getVerticesData(_.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(_.PositionKind,i,!1,!1),r){var a=this.getIndices(),o=this.getVerticesData(_.NormalKind);if(!o)return this;Q.ComputeNormals(i,a,o),this.updateVerticesData(_.NormalKind,o,!1,!1)}return this},t.prototype.makeGeometryUnique=function(){if(!this._geometry)return this;if(this._geometry.meshes.length===1)return this;var e=this._geometry,r=this._geometry.copy(Oe.RandomId());return e.releaseForMesh(this,!0),r.applyToMesh(this),this},t.prototype.setIndices=function(e,r,i){if(r===void 0&&(r=null),i===void 0&&(i=!1),this._geometry)this._geometry.setIndices(e,r,i);else{var a=new Q;a.indices=e;var o=this.getScene();new Oe(Oe.RandomId(),o,a,i,this)}return this},t.prototype.updateIndices=function(e,r,i){return i===void 0&&(i=!1),this._geometry?(this._geometry.updateIndices(e,r,i),this):this},t.prototype.toLeftHanded=function(){return this._geometry?(this._geometry.toLeftHanded(),this):this},t.prototype._bind=function(e,r,i){if(!this._geometry)return this;var a=this.getScene().getEngine();this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(r);var o;if(this._unIndexed)o=null;else switch(i){case ve.PointFillMode:o=null;break;case ve.WireFrameFillMode:o=e._getLinesIndexBuffer(this.getIndices(),a);break;default:case ve.TriangleFillMode:o=this._geometry.getIndexBuffer();break}return!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(r,o):this._geometry._bind(r,o,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),this},t.prototype._draw=function(e,r,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);var a=this.getScene(),o=a.getEngine();return this._unIndexed||r==ve.PointFillMode?o.drawArraysType(r,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):r==ve.WireFrameFillMode?o.drawElementsType(r,0,e._linesIndexCount,this.forcedInstanceCount||i):o.drawElementsType(r,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this},t.prototype.registerBeforeRender=function(e){return this.onBeforeRenderObservable.add(e),this},t.prototype.unregisterBeforeRender=function(e){return this.onBeforeRenderObservable.removeCallback(e),this},t.prototype.registerAfterRender=function(e){return this.onAfterRenderObservable.add(e),this},t.prototype.unregisterAfterRender=function(e){return this.onAfterRenderObservable.removeCallback(e),this},t.prototype._getInstancesRenderList=function(e,r){if(r===void 0&&(r=!1),this._instanceDataStorage.isFrozen){if(r)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}var i=this.getScene(),a=i._isInIntermediateRendering(),o=a?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,s=this._instanceDataStorage.batchCache;if(s.mustReturn=!1,s.renderSelf[e]=r||!o&&this.isEnabled()&&this.isVisible,s.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!r){var u=this._instanceDataStorage.visibleInstances,f=i.getRenderId(),l=a?u.intermediateDefaultRenderId:u.defaultRenderId;s.visibleInstances[e]=u[f],!s.visibleInstances[e]&&l&&(s.visibleInstances[e]=u[l])}return s.hardwareInstancedRendering[e]=!r&&this._instanceDataStorage.hardwareInstancedRendering&&s.visibleInstances[e]!==null&&s.visibleInstances[e]!==void 0,this._instanceDataStorage.previousBatch=s,s},t.prototype._renderWithInstances=function(e,r,i,a,o){var s,u=i.visibleInstances[e._id];if(!u)return this;for(var f=this._instanceDataStorage,l=f.instancesBufferSize,c=f.instancesBuffer,h=f.instancesPreviousBuffer,d=u.length+1,v=d*16*4;f.instancesBufferSize<v;)f.instancesBufferSize*=2;(!f.instancesData||l!=f.instancesBufferSize)&&(f.instancesData=new Float32Array(f.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!f.instancesPreviousData||l!=f.instancesBufferSize)&&(f.instancesPreviousData=new Float32Array(f.instancesBufferSize/4));var g=0,p=0,m=i.renderSelf[e._id],M=!c||l!==f.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!f.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!f.isFrozen||M)){var A=this.getWorldMatrix();if(m&&(this._scene.needsPreviousWorldMatrices&&(f.masterMeshPreviousWorldMatrix?(f.masterMeshPreviousWorldMatrix.copyToArray(f.instancesPreviousData,g),f.masterMeshPreviousWorldMatrix.copyFrom(A)):(f.masterMeshPreviousWorldMatrix=A.clone(),f.masterMeshPreviousWorldMatrix.copyToArray(f.instancesPreviousData,g))),A.copyToArray(f.instancesData,g),g+=16,p++),u){if(t.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&((s=e.getMaterial())===null||s===void 0?void 0:s.needAlphaBlendingForMesh(e.getRenderingMesh()))){for(var y=this._scene.activeCamera.globalPosition,b=0;b<u.length;b++){var x=u[b];x._distanceToCamera=O.Distance(x.getBoundingInfo().boundingSphere.centerWorld,y)}u.sort(function(T,C){return T._distanceToCamera>C._distanceToCamera?-1:T._distanceToCamera<C._distanceToCamera?1:0})}for(var b=0;b<u.length;b++){var I=u[b],D=I.getWorldMatrix();D.copyToArray(f.instancesData,g),this._scene.needsPreviousWorldMatrices&&(I._previousWorldMatrix?(I._previousWorldMatrix.copyToArray(f.instancesPreviousData,g),I._previousWorldMatrix.copyFrom(D)):(I._previousWorldMatrix=D.clone(),I._previousWorldMatrix.copyToArray(f.instancesPreviousData,g))),g+=16,p++}}}else p=(m?1:0)+u.length;return M?(c&&c.dispose(),h&&h.dispose(),c=new ke(o,f.instancesData,!0,16,!1,!0),f.instancesBuffer=c,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=c.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=c.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=c.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=c.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(h=new ke(o,f.instancesPreviousData,!0,16,!1,!0),f.instancesPreviousBuffer=h,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=h.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=h.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=h.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=h.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):this._instanceDataStorage.isFrozen||(c.updateDirectly(f.instancesData,0,p),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&h.updateDirectly(f.instancesPreviousData,0,p)),this._processInstancedBuffers(u,m),this.getScene()._activeIndices.addCount(e.indexCount*p,!1),o._currentDrawContext&&(o._currentDrawContext.useInstancing=!0),this._bind(e,a,r),this._draw(e,r,p),this._scene.needsPreviousWorldMatrices&&!M&&this._instanceDataStorage.manualUpdate&&!this._instanceDataStorage.isFrozen&&!this._instanceDataStorage.previousManualUpdate&&h.updateDirectly(f.instancesData,0,p),o.unbindInstanceAttributes(),this},t.prototype._renderWithThinInstances=function(e,r,i,a){var o,s,u=(s=(o=this._thinInstanceDataStorage)===null||o===void 0?void 0:o.instancesCount)!==null&&s!==void 0?s:0;this.getScene()._activeIndices.addCount(e.indexCount*u,!1),a._currentDrawContext&&(a._currentDrawContext.useInstancing=!0),this._bind(e,i,r),this._draw(e,r,u),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,u):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),a.unbindInstanceAttributes()},t.prototype._processInstancedBuffers=function(e,r){},t.prototype._processRendering=function(e,r,i,a,o,s,u,f){var l=this.getScene(),c=l.getEngine();if(s&&r.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(r,a,i,c),this;if(s)this._renderWithInstances(r,a,o,i,c);else{c._currentDrawContext&&(c._currentDrawContext.useInstancing=!1);var h=0;o.renderSelf[r._id]&&(u&&u(!1,e.getWorldMatrix(),f),h++,this._draw(r,a,this._instanceDataStorage.overridenInstanceCount));var d=o.visibleInstances[r._id];if(d){var v=d.length;h+=v;for(var g=0;g<v;g++){var p=d[g],m=p.getWorldMatrix();u&&u(!0,m,f),this._draw(r,a)}}l._activeIndices.addCount(r.indexCount*h,!1)}return this},t.prototype._rebuild=function(e){if(e===void 0&&(e=!1),this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(var r in this._userInstancedBuffersStorage.vertexBuffers){var i=this._userInstancedBuffersStorage.vertexBuffers[r];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[r]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,n.prototype._rebuild.call(this,e)},t.prototype._freeze=function(){if(!!this.subMeshes){for(var e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}},t.prototype._unFreeze=function(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null},t.prototype.render=function(e,r,i){var a,o,s,u=this.getScene();if(this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1,this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;var f=this._getInstancesRenderList(e._id,!!i);if(f.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;var l=u.getEngine(),c=0,h=null;this.ignoreCameraMaxZ&&u.activeCamera&&!u._isInIntermediateRendering()&&(c=u.activeCamera.maxZ,h=u.activeCamera,u.activeCamera.maxZ=0,u.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);var d=f.hardwareInstancedRendering[e._id]||e.getRenderingMesh().hasThinInstances,v=this._instanceDataStorage,g=e.getMaterial();if(!g)return h&&(h.maxZ=c,u.updateTransformMatrix(!0)),this;if(!v.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==g){if(g._storeEffectOnSubMeshes){if(!g.isReadyForSubMesh(this,e,d))return h&&(h.maxZ=c,u.updateTransformMatrix(!0)),this}else if(!g.isReady(this,d))return h&&(h.maxZ=c,u.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=g}else if(g._storeEffectOnSubMeshes&&!(!((a=e.effect)===null||a===void 0)&&a._wasPreviouslyReady)||!g._storeEffectOnSubMeshes&&!(!((o=g.getEffect())===null||o===void 0)&&o._wasPreviouslyReady))return h&&(h.maxZ=c,u.updateTransformMatrix(!0)),this;r&&l.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode);var p;this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?p=e._drawWrapper:p=this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();for(var m=(s=p==null?void 0:p.effect)!==null&&s!==void 0?s:null,M=0,A=u._beforeRenderingMeshStage;M<A.length;M++){var y=A[M];y.action(this,e,f,m)}if(!p||!m)return h&&(h.maxZ=c,u.updateTransformMatrix(!0)),this;var b=i||this,x;if(!v.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this.overrideMaterialSideOrientation!==null)){var I=b._getWorldMatrixDeterminant();x=this.overrideMaterialSideOrientation,x==null&&(x=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),I<0&&(x=x===ve.ClockWiseSideOrientation?ve.CounterClockWiseSideOrientation:ve.ClockWiseSideOrientation),v.sideOrientation=x}else x=v.sideOrientation;var D=this._internalMeshDataInfo._effectiveMaterial._preBind(p,x);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&l.setDepthWrite(!0);var T=u.forcePointsCloud?ve.PointFillMode:u.forceWireframe?ve.WireFrameFillMode:this._internalMeshDataInfo._effectiveMaterial.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),d||this._bind(e,m,T);var C=this._internalMeshDataInfo._effectiveMaterial,B=b.getWorldMatrix();C._storeEffectOnSubMeshes?C.bindForSubMesh(B,this,e):C.bind(B,this),!C.backFaceCulling&&C.separateCullingPass&&(l.setState(!0,C.zOffset,!1,!D,C.cullBackFaces,C.stencil,C.zOffsetUnits),this._processRendering(this,e,m,T,f,d,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),l.setState(!0,C.zOffset,!1,D,C.cullBackFaces,C.stencil,C.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,m,T,f,d,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(var V=0,U=u._afterRenderingMeshStage;V<U.length;V++){var y=U[V];y.action(this,e,f,m)}return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),h&&(h.maxZ=c,u.updateTransformMatrix(!0)),this},t.prototype.cleanMatrixWeights=function(){this.isVerticesDataPresent(_.MatricesWeightsKind)&&(this.isVerticesDataPresent(_.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())},t.prototype._normalizeSkinFourWeights=function(){for(var e=this.getVerticesData(_.MatricesWeightsKind),r=e.length,i=0;i<r;i+=4){var a=e[i]+e[i+1]+e[i+2]+e[i+3];if(a===0)e[i]=1;else{var o=1/a;e[i]*=o,e[i+1]*=o,e[i+2]*=o,e[i+3]*=o}}this.setVerticesData(_.MatricesWeightsKind,e)},t.prototype._normalizeSkinWeightsAndExtra=function(){for(var e=this.getVerticesData(_.MatricesWeightsExtraKind),r=this.getVerticesData(_.MatricesWeightsKind),i=r.length,a=0;a<i;a+=4){var o=r[a]+r[a+1]+r[a+2]+r[a+3];if(o+=e[a]+e[a+1]+e[a+2]+e[a+3],o===0)r[a]=1;else{var s=1/o;r[a]*=s,r[a+1]*=s,r[a+2]*=s,r[a+3]*=s,e[a]*=s,e[a+1]*=s,e[a+2]*=s,e[a+3]*=s}}this.setVerticesData(_.MatricesWeightsKind,r),this.setVerticesData(_.MatricesWeightsKind,e)},t.prototype.validateSkinning=function(){var e=this.getVerticesData(_.MatricesWeightsExtraKind),r=this.getVerticesData(_.MatricesWeightsKind);if(r===null||this.skeleton==null)return{skinned:!1,valid:!0,report:"not skinned"};for(var i=r.length,a=0,o=0,s=0,u=0,f=e===null?4:8,l=new Array,c=0;c<=f;c++)l[c]=0;for(var h=.001,c=0;c<i;c+=4){for(var d=r[c],v=d,g=v===0?0:1,p=1;p<f;p++){var m=p<4?r[c+p]:e[c+p-4];m>d&&a++,m!==0&&g++,v+=m,d=m}if(l[g]++,g>s&&(s=g),v===0)o++;else{for(var M=1/v,A=0,p=0;p<f;p++)p<4?A+=Math.abs(r[c+p]-r[c+p]*M):A+=Math.abs(e[c+p-4]-e[c+p-4]*M);A>h&&u++}}for(var y=this.skeleton.bones.length,b=this.getVerticesData(_.MatricesIndicesKind),x=this.getVerticesData(_.MatricesIndicesExtraKind),I=0,c=0;c<i;c+=4)for(var p=0;p<f;p++){var D=p<4?b[c+p]:x[c+p-4];(D>=y||D<0)&&I++}var T="Number of Weights = "+i/4+`
Maximum influences = `+s+`
Missing Weights = `+o+`
Not Sorted = `+a+`
Not Normalized = `+u+`
WeightCounts = [`+l+`]
Number of bones = `+y+`
Bad Bone Indices = `+I;return{skinned:!0,valid:o===0&&u===0&&I===0,report:T}},t.prototype._checkDelayState=function(){var e=this.getScene();return this._geometry?this._geometry.load(e):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(e)),this},t.prototype._queueLoad=function(e){var r=this;e.addPendingData(this);var i=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;return ye.LoadFile(this.delayLoadingFile,function(a){a instanceof ArrayBuffer?r._delayLoadingFunction(a,r):r._delayLoadingFunction(JSON.parse(a),r),r.instances.forEach(function(o){o.refreshBoundingInfo(),o._syncSubMeshes()}),r.delayLoadState=1,e.removePendingData(r)},function(){},e.offlineProvider,i),this},t.prototype.isInFrustum=function(e){return this.delayLoadState===2||!n.prototype.isInFrustum.call(this,e)?!1:(this._checkDelayState(),!0)},t.prototype.setMaterialById=function(e){var r=this.getScene().materials,i;for(i=r.length-1;i>-1;i--)if(r[i].id===e)return this.material=r[i],this;var a=this.getScene().multiMaterials;for(i=a.length-1;i>-1;i--)if(a[i].id===e)return this.material=a[i],this;return this},t.prototype.getAnimatables=function(){var e=new Array;return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e},t.prototype.bakeTransformIntoVertices=function(e){if(!this.isVerticesDataPresent(_.PositionKind))return this;var r=this.subMeshes.splice(0);this._resetPointsArrayCache();var i=this.getVerticesData(_.PositionKind),a=new Array,o;for(o=0;o<i.length;o+=3)O.TransformCoordinates(O.FromArray(i,o),e).toArray(a,o);if(this.setVerticesData(_.PositionKind,a,this.getVertexBuffer(_.PositionKind).isUpdatable()),this.isVerticesDataPresent(_.NormalKind)){for(i=this.getVerticesData(_.NormalKind),a=[],o=0;o<i.length;o+=3)O.TransformNormal(O.FromArray(i,o),e).normalize().toArray(a,o);this.setVerticesData(_.NormalKind,a,this.getVertexBuffer(_.NormalKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=r,this},t.prototype.bakeCurrentTransformIntoVertices=function(e){return e===void 0&&(e=!0),this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this},Object.defineProperty(t.prototype,"_positions",{get:function(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null},enumerable:!1,configurable:!0}),t.prototype._resetPointsArrayCache=function(){return this._geometry&&this._geometry._resetPointsArrayCache(),this},t.prototype._generatePointsArray=function(){return this._geometry?this._geometry._generatePointsArray():!1},t.prototype.clone=function(e,r,i,a){return e===void 0&&(e=""),r===void 0&&(r=null),a===void 0&&(a=!0),new t(e,this.getScene(),r,this,i,a)},t.prototype.dispose=function(e,r){r===void 0&&(r=!1),this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);var i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(var a in i.meshMap){var o=i.meshMap[a];o&&(o._internalMeshDataInfo._source=null,i.meshMap[a]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else for(var s=this.getScene().meshes,u=0,f=s;u<f.length;u++){var l=f[u],o=l;o._internalMeshDataInfo&&o._internalMeshDataInfo._source&&o._internalMeshDataInfo._source===this&&(o._internalMeshDataInfo._source=null)}i._source=null,this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),n.prototype.dispose.call(this,e,r)},t.prototype._disposeInstanceSpecificData=function(){},t.prototype._disposeThinInstanceSpecificData=function(){},t.prototype._invalidateInstanceVertexArrayObject=function(){},t.prototype.applyDisplacementMap=function(e,r,i,a,o,s,u){var f=this;u===void 0&&(u=!1);var l=this.getScene(),c=function(h){var d=h.width,v=h.height,g=f.getEngine().createCanvas(d,v),p=g.getContext("2d");p.drawImage(h,0,0);var m=p.getImageData(0,0,d,v).data;f.applyDisplacementMapFromBuffer(m,d,v,r,i,o,s,u),a&&a(f)};return ye.LoadImage(e,c,function(){},l.offlineProvider),this},t.prototype.applyDisplacementMapFromBuffer=function(e,r,i,a,o,s,u,f){if(f===void 0&&(f=!1),!this.isVerticesDataPresent(_.PositionKind)||!this.isVerticesDataPresent(_.NormalKind)||!this.isVerticesDataPresent(_.UVKind))return ue.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;var l=this.getVerticesData(_.PositionKind,!0,!0),c=this.getVerticesData(_.NormalKind),h=this.getVerticesData(_.UVKind),d=O.Zero(),v=O.Zero(),g=le.Zero();s=s||le.Zero(),u=u||new le(1,1);for(var p=0;p<l.length;p+=3){O.FromArrayToRef(l,p,d),O.FromArrayToRef(c,p,v),le.FromArrayToRef(h,p/3*2,g);var m=Math.abs(g.x*u.x+s.x%1)*(r-1)%r|0,M=Math.abs(g.y*u.y+s.y%1)*(i-1)%i|0,A=(m+M*r)*4,y=e[A]/255,b=e[A+1]/255,x=e[A+2]/255,I=y*.3+b*.59+x*.11;v.normalize(),v.scaleInPlace(a+(o-a)*I),d=d.add(v),d.toArray(l,p)}return Q.ComputeNormals(l,this.getIndices(),c),f?(this.setVerticesData(_.PositionKind,l),this.setVerticesData(_.NormalKind,c),this.setVerticesData(_.UVKind,h)):(this.updateVerticesData(_.PositionKind,l),this.updateVerticesData(_.NormalKind,c)),this},t.prototype.convertToFlatShadedMesh=function(){var e=this.getVerticesDataKinds(),r={},i={},a={},o=!1,s,u;for(s=0;s<e.length;s++){u=e[s];var f=this.getVertexBuffer(u),l=f.getData();if(!((l instanceof Array||l instanceof Float32Array)&&l.length===0)){if(u===_.NormalKind){o=f.isUpdatable(),e.splice(s,1),s--;continue}r[u]=f,i[u]=this.getVerticesData(u),a[u]=[]}}var c=this.subMeshes.slice(0),h=this.getIndices(),d=this.getTotalIndices(),v;for(v=0;v<d;v++){var g=h[v];for(s=0;s<e.length;s++)if(u=e[s],!!r[u])for(var p=r[u].getStrideSize(),m=0;m<p;m++)a[u].push(i[u][g*p+m])}var M=[],A=a[_.PositionKind],y=this.getScene().useRightHandedSystem,b;for(y?b=this.overrideMaterialSideOrientation===1:b=this.overrideMaterialSideOrientation===0,v=0;v<d;v+=3){h[v]=v,h[v+1]=v+1,h[v+2]=v+2;var x=O.FromArray(A,v*3),I=O.FromArray(A,(v+1)*3),D=O.FromArray(A,(v+2)*3),T=x.subtract(I),C=D.subtract(I),B=O.Normalize(O.Cross(T,C));b&&B.scaleInPlace(-1);for(var V=0;V<3;V++)M.push(B.x),M.push(B.y),M.push(B.z)}for(this.setIndices(h),this.setVerticesData(_.NormalKind,M,o),s=0;s<e.length;s++)u=e[s],a[u]&&this.setVerticesData(u,a[u],r[u].isUpdatable());this.releaseSubMeshes();for(var U=0;U<c.length;U++){var R=c[U];pe.AddToMesh(R.materialIndex,R.indexStart,R.indexCount,R.indexStart,R.indexCount,this)}return this.synchronizeInstances(),this},t.prototype.convertToUnIndexedMesh=function(){var e=this.getVerticesDataKinds(),r={},i={},a={},o,s;for(o=0;o<e.length;o++){s=e[o];var u=this.getVertexBuffer(s);r[s]=u,i[s]=r[s].getData(),a[s]=[]}var f=this.subMeshes.slice(0),l=this.getIndices(),c=this.getTotalIndices(),h;for(h=0;h<c;h++){var d=l[h];for(o=0;o<e.length;o++){s=e[o];for(var v=r[s].getStrideSize(),g=0;g<v;g++)a[s].push(i[s][d*v+g])}}for(h=0;h<c;h+=3)l[h]=h,l[h+1]=h+1,l[h+2]=h+2;for(this.setIndices(l),o=0;o<e.length;o++)s=e[o],this.setVerticesData(s,a[s],r[s].isUpdatable(),r[s].getStrideSize());this.releaseSubMeshes();for(var p=0;p<f.length;p++){var m=f[p];pe.AddToMesh(m.materialIndex,m.indexStart,m.indexCount,m.indexStart,m.indexCount,this)}return this._unIndexed=!0,this.synchronizeInstances(),this},t.prototype.flipFaces=function(e){e===void 0&&(e=!1);var r=Q.ExtractFromMesh(this),i;if(e&&this.isVerticesDataPresent(_.NormalKind)&&r.normals)for(i=0;i<r.normals.length;i++)r.normals[i]*=-1;if(r.indices){var a=void 0;for(i=0;i<r.indices.length;i+=3)a=r.indices[i+1],r.indices[i+1]=r.indices[i+2],r.indices[i+2]=a}return r.applyToMesh(this,this.isVertexBufferUpdatable(_.PositionKind)),this},t.prototype.increaseVertices=function(e){e===void 0&&(e=1);var r=Q.ExtractFromMesh(this),i=r.indices&&!Array.isArray(r.indices)&&Array.from?Array.from(r.indices):r.indices,a=r.positions&&!Array.isArray(r.positions)&&Array.from?Array.from(r.positions):r.positions,o=r.uvs&&!Array.isArray(r.uvs)&&Array.from?Array.from(r.uvs):r.uvs,s=r.normals&&!Array.isArray(r.normals)&&Array.from?Array.from(r.normals):r.normals;if(!i||!a)ue.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions");else{r.indices=i,r.positions=a,o&&(r.uvs=o),s&&(r.normals=s);for(var u=e+1,f=new Array,l=0;l<u+1;l++)f[l]=new Array;var c=void 0,h=void 0,d=new O(0,0,0),v=new O(0,0,0),g=new le(0,0),p=new Array,m=new Array,M=new Array,A=void 0,y=a.length,b=void 0;o&&(b=o.length);var x=void 0;s&&(x=s.length);for(var l=0;l<i.length;l+=3){m[0]=i[l],m[1]=i[l+1],m[2]=i[l+2];for(var I=0;I<3;I++)if(c=m[I],h=m[(I+1)%3],M[c]===void 0&&M[h]===void 0?(M[c]=new Array,M[h]=new Array):(M[c]===void 0&&(M[c]=new Array),M[h]===void 0&&(M[h]=new Array)),M[c][h]===void 0&&M[h][c]===void 0){M[c][h]=[],d.x=(a[3*h]-a[3*c])/u,d.y=(a[3*h+1]-a[3*c+1])/u,d.z=(a[3*h+2]-a[3*c+2])/u,s&&(v.x=(s[3*h]-s[3*c])/u,v.y=(s[3*h+1]-s[3*c+1])/u,v.z=(s[3*h+2]-s[3*c+2])/u),o&&(g.x=(o[2*h]-o[2*c])/u,g.y=(o[2*h+1]-o[2*c+1])/u),M[c][h].push(c);for(var D=1;D<u;D++)M[c][h].push(a.length/3),a[y++]=a[3*c]+D*d.x,a[y++]=a[3*c+1]+D*d.y,a[y++]=a[3*c+2]+D*d.z,s&&(s[x++]=s[3*c]+D*v.x,s[x++]=s[3*c+1]+D*v.y,s[x++]=s[3*c+2]+D*v.z),o&&(o[b++]=o[2*c]+D*g.x,o[b++]=o[2*c+1]+D*g.y);M[c][h].push(h),M[h][c]=new Array,A=M[c][h].length;for(var T=0;T<A;T++)M[h][c][T]=M[c][h][A-1-T]}f[0][0]=i[l],f[1][0]=M[i[l]][i[l+1]][1],f[1][1]=M[i[l]][i[l+2]][1];for(var D=2;D<u;D++){f[D][0]=M[i[l]][i[l+1]][D],f[D][D]=M[i[l]][i[l+2]][D],d.x=(a[3*f[D][D]]-a[3*f[D][0]])/D,d.y=(a[3*f[D][D]+1]-a[3*f[D][0]+1])/D,d.z=(a[3*f[D][D]+2]-a[3*f[D][0]+2])/D,s&&(v.x=(s[3*f[D][D]]-s[3*f[D][0]])/D,v.y=(s[3*f[D][D]+1]-s[3*f[D][0]+1])/D,v.z=(s[3*f[D][D]+2]-s[3*f[D][0]+2])/D),o&&(g.x=(o[2*f[D][D]]-o[2*f[D][0]])/D,g.y=(o[2*f[D][D]+1]-o[2*f[D][0]+1])/D);for(var I=1;I<D;I++)f[D][I]=a.length/3,a[y++]=a[3*f[D][0]]+I*d.x,a[y++]=a[3*f[D][0]+1]+I*d.y,a[y++]=a[3*f[D][0]+2]+I*d.z,s&&(s[x++]=s[3*f[D][0]]+I*v.x,s[x++]=s[3*f[D][0]+1]+I*v.y,s[x++]=s[3*f[D][0]+2]+I*v.z),o&&(o[b++]=o[2*f[D][0]]+I*g.x,o[b++]=o[2*f[D][0]+1]+I*g.y)}f[u]=M[i[l+1]][i[l+2]],p.push(f[0][0],f[1][0],f[1][1]);for(var D=1;D<u;D++){var I=void 0;for(I=0;I<D;I++)p.push(f[D][I],f[D+1][I],f[D+1][I+1]),p.push(f[D][I],f[D+1][I+1],f[D][I+1]);p.push(f[D][I],f[D+1][I],f[D+1][I+1])}}r.indices=p,r.applyToMesh(this,this.isVertexBufferUpdatable(_.PositionKind))}},t.prototype.forceSharedVertices=function(){var e=Q.ExtractFromMesh(this),r=e.uvs,i=e.indices,a=e.positions,o=e.colors;if(i===void 0||a===void 0||i===null||a===null)ue.Warn("VertexData contains empty entries");else{for(var s=new Array,u=new Array,f=new Array,l=new Array,c=new Array,h=0,d={},v=void 0,g=void 0,p=0;p<i.length;p+=3){g=[i[p],i[p+1],i[p+2]],c=new Array;for(var m=0;m<3;m++){c[m]="";for(var M=0;M<3;M++)Math.abs(a[3*g[m]+M])<1e-8&&(a[3*g[m]+M]=0),c[m]+=a[3*g[m]+M]+"|"}if(!(c[0]==c[1]||c[0]==c[2]||c[1]==c[2]))for(var m=0;m<3;m++){if(v=d[c[m]],v===void 0){d[c[m]]=h,v=h++;for(var M=0;M<3;M++)s.push(a[3*g[m]+M]);if(o!=null)for(var M=0;M<4;M++)l.push(o[4*g[m]+M]);if(r!=null)for(var M=0;M<2;M++)f.push(r[2*g[m]+M])}u.push(v)}}var A=new Array;Q.ComputeNormals(s,u,A),e.positions=s,e.indices=u,e.normals=A,r!=null&&(e.uvs=f),o!=null&&(e.colors=l),e.applyToMesh(this,this.isVertexBufferUpdatable(_.PositionKind))}},t._instancedMeshFactory=function(e,r){throw se("InstancedMesh")},t._PhysicsImpostorParser=function(e,r,i){throw se("PhysicsImpostor")},t.prototype.createInstance=function(e){return t._instancedMeshFactory(e,this)},t.prototype.synchronizeInstances=function(){for(var e=0;e<this.instances.length;e++){var r=this.instances[e];r._syncSubMeshes()}return this},t.prototype.optimizeIndices=function(e){var r=this,i=this.getIndices(),a=this.getVerticesData(_.PositionKind);if(!a||!i)return this;for(var o=new Array,s=0;s<a.length;s=s+3)o.push(O.FromArray(a,s));var u=new Array;return Ae.SyncAsyncForLoop(o.length,40,function(f){for(var l=o.length-1-f,c=o[l],h=0;h<l;++h){var d=o[h];if(c.equals(d)){u[l]=h;break}}},function(){for(var f=0;f<i.length;++f)i[f]=u[i[f]]||i[f];var l=r.subMeshes.slice(0);r.setIndices(i),r.subMeshes=l,e&&e(r)}),this},t.prototype.serialize=function(e){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),de&&de.HasTags(this)&&(e.tags=de.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.checkCollisions=this.checkCollisions,e.isBlocker=this.isBlocker,e.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;var r=this._geometry;if(r&&this.subMeshes){e.geometryUniqueId=r.uniqueId,e.geometryId=r.id,e.subMeshes=[];for(var i=0;i<this.subMeshes.length;i++){var a=this.subMeshes[i];e.subMeshes.push({materialIndex:a.materialIndex,verticesStart:a.verticesStart,verticesCount:a.verticesCount,indexStart:a.indexStart,indexCount:a.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(ze.NAME_PHYSICSENGINE)){var o=this.getPhysicsImpostor();o&&(e.physicsMass=o.getParam("mass"),e.physicsFriction=o.getParam("friction"),e.physicsRestitution=o.getParam("mass"),e.physicsImpostor=o.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(var s=0;s<this.instances.length;s++){var u=this.instances[s];if(!u.doNotSerialize){var f={name:u.name,id:u.id,isEnabled:u.isEnabled(!1),isVisible:u.isVisible,isPickable:u.isPickable,checkCollisions:u.checkCollisions,position:u.position.asArray(),scaling:u.scaling.asArray()};if(u.parent&&u.parent._serializeAsParent(f),u.rotationQuaternion?f.rotationQuaternion=u.rotationQuaternion.asArray():u.rotation&&(f.rotation=u.rotation.asArray()),this.getScene()._getComponent(ze.NAME_PHYSICSENGINE)){var o=u.getPhysicsImpostor();o&&(f.physicsMass=o.getParam("mass"),f.physicsFriction=o.getParam("friction"),f.physicsRestitution=o.getParam("mass"),f.physicsImpostor=o.type)}u.metadata&&(f.metadata=u.metadata),e.instances.push(f),Ue.AppendSerializedAnimations(u,f),f.ranges=u.serializeAnimationRanges()}}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){var l={data:{},sizes:{},strides:{}};for(var c in this._userThinInstanceBuffersStorage.data)l.data[c]=Array.from(this._userThinInstanceBuffersStorage.data[c]),l.sizes[c]=this._userThinInstanceBuffersStorage.sizes[c],l.strides[c]=this._userThinInstanceBuffersStorage.strides[c];e.thinInstances.userThinInstance=l}Ue.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name))},t.prototype._syncGeometryWithMorphTargetManager=function(){if(!!this.geometry){this._markSubMeshesAsAttributesDirty();var e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices()){ue.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),this.morphTargetManager=null;return}if(e.isUsingTextureForTargets)return;for(var r=0;r<e.numInfluencers;r++){var i=e.getActiveTarget(r),a=i.getPositions();if(!a){ue.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(_.PositionKind+r,a,!1,3);var o=i.getNormals();o&&this.geometry.setVerticesData(_.NormalKind+r,o,!1,3);var s=i.getTangents();s&&this.geometry.setVerticesData(_.TangentKind+r,s,!1,3);var u=i.getUVs();u&&this.geometry.setVerticesData(_.UVKind+"_"+r,u,!1,2)}}else for(var r=0;this.geometry.isVerticesDataPresent(_.PositionKind+r);)this.geometry.removeVerticesData(_.PositionKind+r),this.geometry.isVerticesDataPresent(_.NormalKind+r)&&this.geometry.removeVerticesData(_.NormalKind+r),this.geometry.isVerticesDataPresent(_.TangentKind+r)&&this.geometry.removeVerticesData(_.TangentKind+r),this.geometry.isVerticesDataPresent(_.UVKind+r)&&this.geometry.removeVerticesData(_.UVKind+"_"+r),r++}},t.Parse=function(e,r,i){var a;if(e.type&&e.type==="LinesMesh"?a=t._LinesMeshParser(e,r):e.type&&e.type==="GroundMesh"?a=t._GroundMeshParser(e,r):e.type&&e.type==="GoldbergMesh"?a=t._GoldbergMeshParser(e,r):a=new t(e.name,r),a.id=e.id,a._waitingParsedUniqueId=e.uniqueId,de&&de.AddTagsTo(a,e.tags),a.position=O.FromArray(e.position),e.metadata!==void 0&&(a.metadata=e.metadata),e.rotationQuaternion?a.rotationQuaternion=ce.FromArray(e.rotationQuaternion):e.rotation&&(a.rotation=O.FromArray(e.rotation)),a.scaling=O.FromArray(e.scaling),e.localMatrix?a.setPreTransformMatrix(X.FromArray(e.localMatrix)):e.pivotMatrix&&a.setPivotMatrix(X.FromArray(e.pivotMatrix)),a.setEnabled(e.isEnabled),a.isVisible=e.isVisible,a.infiniteDistance=e.infiniteDistance,a.showBoundingBox=e.showBoundingBox,a.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,e.applyFog!==void 0&&(a.applyFog=e.applyFog),e.pickable!==void 0&&(a.isPickable=e.pickable),e.alphaIndex!==void 0&&(a.alphaIndex=e.alphaIndex),a.receiveShadows=e.receiveShadows,a.billboardMode=e.billboardMode,e.visibility!==void 0&&(a.visibility=e.visibility),a.checkCollisions=e.checkCollisions,a.overrideMaterialSideOrientation=e.overrideMaterialSideOrientation,e.isBlocker!==void 0&&(a.isBlocker=e.isBlocker),a._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(a._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),e.parentId!==void 0&&(a._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(a._waitingParentInstanceIndex=e.parentInstanceIndex),e.actions!==void 0&&(a._waitingData.actions=e.actions),e.overlayAlpha!==void 0&&(a.overlayAlpha=e.overlayAlpha),e.overlayColor!==void 0&&(a.overlayColor=we.FromArray(e.overlayColor)),e.renderOverlay!==void 0&&(a.renderOverlay=e.renderOverlay),a.isUnIndexed=!!e.isUnIndexed,a.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(a.delayLoadState=4,a.delayLoadingFile=i+e.delayLoadingFile,a.buildBoundingInfo(O.FromArray(e.boundingBoxMinimum),O.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(a._binaryInfo=e._binaryInfo),a._delayInfo=[],e.hasUVs&&a._delayInfo.push(_.UVKind),e.hasUVs2&&a._delayInfo.push(_.UV2Kind),e.hasUVs3&&a._delayInfo.push(_.UV3Kind),e.hasUVs4&&a._delayInfo.push(_.UV4Kind),e.hasUVs5&&a._delayInfo.push(_.UV5Kind),e.hasUVs6&&a._delayInfo.push(_.UV6Kind),e.hasColors&&a._delayInfo.push(_.ColorKind),e.hasMatricesIndices&&a._delayInfo.push(_.MatricesIndicesKind),e.hasMatricesWeights&&a._delayInfo.push(_.MatricesWeightsKind),a._delayLoadingFunction=Oe._ImportGeometry,yt.ForceFullSceneLoadingForIncremental&&a._checkDelayState()):Oe._ImportGeometry(e,a),e.materialUniqueId?a._waitingMaterialId=e.materialUniqueId:e.materialId&&(a._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(a.morphTargetManager=r.getMorphTargetManagerById(e.morphTargetManagerId)),e.skeletonId!==void 0&&e.skeletonId!==null&&(a.skeleton=r.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(a.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(var o=0;o<e.animations.length;o++){var s=e.animations[o],u=ft("BABYLON.Animation");u&&a.animations.push(u.Parse(s))}je.ParseAnimationRanges(a,e,r)}if(e.autoAnimate&&r.beginAnimation(a,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?a.layerMask=Math.abs(parseInt(e.layerMask)):a.layerMask=268435455,e.physicsImpostor&&t._PhysicsImpostorParser(r,a,e),e.lodMeshIds&&(a._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(var f=0;f<e.instances.length;f++){var l=e.instances[f],c=a.createInstance(l.name);if(l.id&&(c.id=l.id),de&&(l.tags?de.AddTagsTo(c,l.tags):de.AddTagsTo(c,e.tags)),c.position=O.FromArray(l.position),l.metadata!==void 0&&(c.metadata=l.metadata),l.parentId!==void 0&&(c._waitingParentId=l.parentId),l.parentInstanceIndex!==void 0&&(c._waitingParentInstanceIndex=l.parentInstanceIndex),l.isEnabled!==void 0&&l.isEnabled!==null&&c.setEnabled(l.isEnabled),l.isVisible!==void 0&&l.isVisible!==null&&(c.isVisible=l.isVisible),l.isPickable!==void 0&&l.isPickable!==null&&(c.isPickable=l.isPickable),l.rotationQuaternion?c.rotationQuaternion=ce.FromArray(l.rotationQuaternion):l.rotation&&(c.rotation=O.FromArray(l.rotation)),c.scaling=O.FromArray(l.scaling),l.checkCollisions!=null&&l.checkCollisions!=null&&(c.checkCollisions=l.checkCollisions),l.pickable!=null&&l.pickable!=null&&(c.isPickable=l.pickable),l.showBoundingBox!=null&&l.showBoundingBox!=null&&(c.showBoundingBox=l.showBoundingBox),l.showSubMeshesBoundingBox!=null&&l.showSubMeshesBoundingBox!=null&&(c.showSubMeshesBoundingBox=l.showSubMeshesBoundingBox),l.alphaIndex!=null&&l.showSubMeshesBoundingBox!=null&&(c.alphaIndex=l.alphaIndex),l.physicsImpostor&&t._PhysicsImpostorParser(r,c,l),l.animations){for(var o=0;o<l.animations.length;o++){var s=l.animations[o],u=ft("BABYLON.Animation");u&&c.animations.push(u.Parse(s))}je.ParseAnimationRanges(c,l,r),l.autoAnimate&&r.beginAnimation(c,l.autoAnimateFrom,l.autoAnimateTo,l.autoAnimateLoop,l.autoAnimateSpeed||1)}}if(e.thinInstances){var h=e.thinInstances;if(a.thinInstanceEnablePicking=!!h.enablePicking,h.matrixData?(a.thinInstanceSetBuffer("matrix",new Float32Array(h.matrixData),16,!1),a._thinInstanceDataStorage.matrixBufferSize=h.matrixBufferSize,a._thinInstanceDataStorage.instancesCount=h.instancesCount):a._thinInstanceDataStorage.matrixBufferSize=h.matrixBufferSize,e.thinInstances.userThinInstance){var d=e.thinInstances.userThinInstance;for(var v in d.data)a.thinInstanceSetBuffer(v,new Float32Array(d.data[v]),d.strides[v],!1),a._userThinInstanceBuffersStorage.sizes[v]=d.sizes[v]}}return a},t.prototype.setPositionsForCPUSkinning=function(){var e=this._internalMeshDataInfo;if(!e._sourcePositions){var r=this.getVerticesData(_.PositionKind);if(!r)return e._sourcePositions;e._sourcePositions=new Float32Array(r),this.isVertexBufferUpdatable(_.PositionKind)||this.setVerticesData(_.PositionKind,r,!0)}return e._sourcePositions},t.prototype.setNormalsForCPUSkinning=function(){var e=this._internalMeshDataInfo;if(!e._sourceNormals){var r=this.getVerticesData(_.NormalKind);if(!r)return e._sourceNormals;e._sourceNormals=new Float32Array(r),this.isVertexBufferUpdatable(_.NormalKind)||this.setVerticesData(_.NormalKind,r,!0)}return e._sourceNormals},t.prototype.applySkeleton=function(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(_.PositionKind))return this;if(!this.isVerticesDataPresent(_.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(_.MatricesWeightsKind))return this;var r=this.isVerticesDataPresent(_.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){var a=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=a}r&&!i._sourceNormals&&this.setNormalsForCPUSkinning();var o=this.getVerticesData(_.PositionKind);if(!o)return this;o instanceof Float32Array||(o=new Float32Array(o));var s=this.getVerticesData(_.NormalKind);if(r){if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s))}var u=this.getVerticesData(_.MatricesIndicesKind),f=this.getVerticesData(_.MatricesWeightsKind);if(!f||!u)return this;for(var l=this.numBoneInfluencers>4,c=l?this.getVerticesData(_.MatricesIndicesExtraKind):null,h=l?this.getVerticesData(_.MatricesWeightsExtraKind):null,d=e.getTransformMatrices(this),v=O.Zero(),g=new X,p=new X,m=0,M,A=0;A<o.length;A+=3,m+=4){var y=void 0;for(M=0;M<4;M++)y=f[m+M],y>0&&(X.FromFloat32ArrayToRefScaled(d,Math.floor(u[m+M]*16),y,p),g.addToSelf(p));if(l)for(M=0;M<4;M++)y=h[m+M],y>0&&(X.FromFloat32ArrayToRefScaled(d,Math.floor(c[m+M]*16),y,p),g.addToSelf(p));O.TransformCoordinatesFromFloatsToRef(i._sourcePositions[A],i._sourcePositions[A+1],i._sourcePositions[A+2],g,v),v.toArray(o,A),r&&(O.TransformNormalFromFloatsToRef(i._sourceNormals[A],i._sourceNormals[A+1],i._sourceNormals[A+2],g,v),v.toArray(s,A)),g.reset()}return this.updateVerticesData(_.PositionKind,o),r&&this.updateVerticesData(_.NormalKind,s),this},t.MinMax=function(e){var r=null,i=null;return e.forEach(function(a){var o=a.getBoundingInfo(),s=o.boundingBox;!r||!i?(r=s.minimumWorld,i=s.maximumWorld):(r.minimizeInPlace(s.minimumWorld),i.maximizeInPlace(s.maximumWorld))}),!r||!i?{min:O.Zero(),max:O.Zero()}:{min:r,max:i}},t.Center=function(e){var r=e instanceof Array?t.MinMax(e):e;return O.Center(r.min,r.max)},t.MergeMeshes=function(e,r,i,a,o,s){return r===void 0&&(r=!0),_t(t._MergeMeshesCoroutine(e,r,i,a,o,s,!1))},t.MergeMeshesAsync=function(e,r,i,a,o,s){return r===void 0&&(r=!0),mr(t._MergeMeshesCoroutine(e,r,i,a,o,s,!0),yr())},t._MergeMeshesCoroutine=function(e,r,i,a,o,s,u){var f,l,c,h,d,v,g,p,m,w,w,w,M,A,y,b,x,I,D,T,C,B,V,U,R,F,W,K,E,w;return r===void 0&&(r=!0),Xe(this,function(L){switch(L.label){case 0:if(e=e.filter(Boolean),e.length===0)return[2,null];if(!i){for(l=0,f=0;f<e.length;f++)if(l+=e[f].getTotalVertices(),l>=65536)return ue.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),[2,null]}for(s&&(o=!1),c=new Array,h=new Array,d=new Array,v=e[0].overrideMaterialSideOrientation,f=0;f<e.length;f++){if(g=e[f],g.isAnInstance)return ue.Warn("Cannot merge instance meshes."),[2,null];if(v!==g.overrideMaterialSideOrientation)return ue.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),[2,null];if(o&&d.push(g.getTotalIndices()),s)if(g.material)if(p=g.material,p instanceof lt){for(m=0;m<p.subMaterials.length;m++)c.indexOf(p.subMaterials[m])<0&&c.push(p.subMaterials[m]);for(w=0;w<g.subMeshes.length;w++)h.push(c.indexOf(p.subMaterials[g.subMeshes[w].materialIndex])),d.push(g.subMeshes[w].indexCount)}else for(c.indexOf(p)<0&&c.push(p),w=0;w<g.subMeshes.length;w++)h.push(c.indexOf(p)),d.push(g.subMeshes[w].indexCount);else for(w=0;w<g.subMeshes.length;w++)h.push(0),d.push(g.subMeshes[w].indexCount)}return M=e[0],A=function(P){var Y=P.computeWorldMatrix(!0),G=Q.ExtractFromMesh(P,!1,!1);return[G,Y]},y=A(M),b=y[0],x=y[1],u?[4]:[3,2];case 1:L.sent(),L.label=2;case 2:I=new Array(e.length-1),D=1,L.label=3;case 3:return D<e.length?(I[D-1]=A(e[D]),u?[4]:[3,5]):[3,6];case 4:L.sent(),L.label=5;case 5:return D++,[3,3];case 6:T=b._mergeCoroutine(x,I,i,u,!r),C=T.next(),L.label=7;case 7:return C.done?[3,10]:u?[4]:[3,9];case 8:L.sent(),L.label=9;case 9:return C=T.next(),[3,7];case 10:B=C.value,a||(a=new t(M.name+"_merged",M.getScene())),V=B._applyToCoroutine(a,void 0,u),U=V.next(),L.label=11;case 11:return U.done?[3,14]:u?[4]:[3,13];case 12:L.sent(),L.label=13;case 13:return U=V.next(),[3,11];case 14:if(a.checkCollisions=M.checkCollisions,a.overrideMaterialSideOrientation=M.overrideMaterialSideOrientation,r)for(f=0;f<e.length;f++)e[f].dispose();if(o||s){for(a.releaseSubMeshes(),f=0,R=0;f<d.length;)pe.CreateFromIndices(0,R,d[f],a,void 0,!1),R+=d[f],f++;for(F=0,W=a.subMeshes;F<W.length;F++)K=W[F],K.refreshBoundingInfo();a.computeWorldMatrix(!0)}if(s){for(E=new lt(M.name+"_merged",M.getScene()),E.subMaterials=c,w=0;w<a.subMeshes.length;w++)a.subMeshes[w].materialIndex=h[w];a.material=E}else a.material=M.material;return[2,a]}})},t.prototype.addInstance=function(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)},t.prototype.removeInstance=function(e){var r=e._indexInSourceMeshInstanceArray;if(r!=-1){if(r!==this.instances.length-1){var i=this.instances[this.instances.length-1];this.instances[r]=i,i._indexInSourceMeshInstanceArray=r}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}},t.prototype._shouldConvertRHS=function(){return this.overrideMaterialSideOrientation===ve.CounterClockWiseSideOrientation},t.FRONTSIDE=Q.FRONTSIDE,t.BACKSIDE=Q.BACKSIDE,t.DOUBLESIDE=Q.DOUBLESIDE,t.DEFAULTSIDE=Q.DEFAULTSIDE,t.NO_CAP=0,t.CAP_START=1,t.CAP_END=2,t.CAP_ALL=3,t.NO_FLIP=0,t.FLIP_TILE=1,t.ROTATE_TILE=2,t.FLIP_ROW=3,t.ROTATE_ROW=4,t.FLIP_N_ROTATE_TILE=5,t.FLIP_N_ROTATE_ROW=6,t.CENTER=0,t.LEFT=1,t.RIGHT=2,t.TOP=3,t.BOTTOM=4,t.INSTANCEDMESH_SORT_TRANSPARENT=!1,t._GroundMeshParser=function(e,r){throw se("GroundMesh")},t._GoldbergMeshParser=function(e,r){throw se("GoldbergMesh")},t._LinesMeshParser=function(e,r){throw se("LinesMesh")},t}(Ze);pt("BABYLON.Mesh",S);S.prototype.setMaterialByID=function(n){return this.setMaterialById(n)};S.CreateDisc=S.CreateDisc||function(){throw new Error("Import MeshBuilder to populate this function")};S.CreateBox=S.CreateBox||function(){throw new Error("Import MeshBuilder to populate this function")};S.CreateSphere=S.CreateSphere||function(){throw new Error("Import MeshBuilder to populate this function")};S.CreateCylinder=S.CreateCylinder||function(){throw new Error("Import MeshBuilder to populate this function")};S.CreateTorusKnot=S.CreateTorusKnot||function(){throw new Error("Import MeshBuilder to populate this function")};S.CreateTorus=S.CreateTorus||function(){throw new Error("Import MeshBuilder to populate this function")};S.CreatePlane=S.CreatePlane||function(){throw new Error("Import MeshBuilder to populate this function")};S.CreateGround=S.CreateGround||function(){throw new Error("Import MeshBuilder to populate this function")};S.CreateTiledGround=S.CreateTiledGround||function(){throw new Error("Import MeshBuilder to populate this function")};S.CreateGroundFromHeightMap=S.CreateGroundFromHeightMap||function(){throw new Error("Import MeshBuilder to populate this function")};S.CreateTube=S.CreateTube||function(){throw new Error("Import MeshBuilder to populate this function")};S.CreatePolyhedron=S.CreatePolyhedron||function(){throw new Error("Import MeshBuilder to populate this function")};S.CreateIcoSphere=S.CreateIcoSphere||function(){throw new Error("Import MeshBuilder to populate this function")};S.CreateDecal=S.CreateDecal||function(){throw new Error("Import MeshBuilder to populate this function")};S.CreateCapsule=S.CreateCapsule||function(){throw new Error("Import MeshBuilder to populate this function")};S.ExtendToGoldberg=S.ExtendToGoldberg||function(){throw new Error("Import MeshBuilder to populate this function")};function It(n){var t=[],e=[],r=[],i=[],a=n.width||n.size||1,o=n.height||n.size||1,s=n.sideOrientation===0?0:n.sideOrientation||Q.DEFAULTSIDE,u=a/2,f=o/2;e.push(-u,-f,0),r.push(0,0,-1),i.push(0,j.UseOpenGLOrientationForUV?1:0),e.push(u,-f,0),r.push(0,0,-1),i.push(1,j.UseOpenGLOrientationForUV?1:0),e.push(u,f,0),r.push(0,0,-1),i.push(1,j.UseOpenGLOrientationForUV?0:1),e.push(-u,f,0),r.push(0,0,-1),i.push(0,j.UseOpenGLOrientationForUV?0:1),t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),Q._ComputeSides(s,e,t,r,i,n.frontUVs,n.backUVs);var l=new Q;return l.indices=t,l.positions=e,l.normals=r,l.uvs=i,l}function Mt(n,t,e){t===void 0&&(t={}),e===void 0&&(e=null);var r=new S(n,e);t.sideOrientation=S._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;var i=It(t);return i.applyToMesh(r,t.updatable),t.sourcePlane&&(r.translate(t.sourcePlane.normal,-t.sourcePlane.d),r.setDirection(t.sourcePlane.normal.scale(-1))),r}Q.CreatePlane=It;S.CreatePlane=function(n,t,e,r,i){var a={size:t,width:t,height:t,sideOrientation:i,updatable:r};return Mt(n,a,e)};function xt(n){var t=n.sideOrientation||Q.DEFAULTSIDE,e=n.radius||1,r=n.flat===void 0?!0:n.flat,i=n.subdivisions||4,a=n.radiusX||e,o=n.radiusY||e,s=n.radiusZ||e,u=(1+Math.sqrt(5))/2,f=[-1,u,-0,1,u,0,-1,-u,0,1,-u,0,0,-1,-u,0,1,-u,0,-1,u,0,1,u,u,0,1,u,0,-1,-u,0,1,-u,0,-1],l=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],c=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],h=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],d=138/1024,v=239/1024,g=60/1024,p=26/1024,m=-40/1024,M=20/1024,A=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],y=new Array,b=new Array,x=new Array,I=new Array,D=0,T=new Array(3),C=new Array(3),B;for(B=0;B<3;B++)T[B]=O.Zero(),C[B]=le.Zero();for(var V=0;V<20;V++){for(B=0;B<3;B++){var U=l[3*V+B];T[B].copyFromFloats(f[3*c[U]],f[3*c[U]+1],f[3*c[U]+2]),T[B].normalize(),C[B].copyFromFloats(h[2*U]*d+g+A[V]*m,h[2*U+1]*v+p+A[V]*M)}for(var R=function(E,w,L,P){var Y=O.Lerp(T[0],T[2],w/i),G=O.Lerp(T[1],T[2],w/i),H=i===w?T[2]:O.Lerp(Y,G,E/(i-w));H.normalize();var Z;if(r){var q=O.Lerp(T[0],T[2],P/i),N=O.Lerp(T[1],T[2],P/i);Z=O.Lerp(q,N,L/(i-P))}else Z=new O(H.x,H.y,H.z);Z.x/=a,Z.y/=o,Z.z/=s,Z.normalize();var k=le.Lerp(C[0],C[2],w/i),ie=le.Lerp(C[1],C[2],w/i),J=i===w?C[2]:le.Lerp(k,ie,E/(i-w));b.push(H.x*a,H.y*o,H.z*s),x.push(Z.x,Z.y,Z.z),I.push(J.x,j.UseOpenGLOrientationForUV?1-J.y:J.y),y.push(D),D++},F=0;F<i;F++)for(var W=0;W+F<i;W++)R(W,F,W+1/3,F+1/3),R(W+1,F,W+1/3,F+1/3),R(W,F+1,W+1/3,F+1/3),W+F+1<i&&(R(W+1,F,W+2/3,F+2/3),R(W+1,F+1,W+2/3,F+2/3),R(W,F+1,W+2/3,F+2/3))}Q._ComputeSides(t,b,y,x,I,n.frontUVs,n.backUVs);var K=new Q;return K.indices=y,K.positions=b,K.normals=x,K.uvs=I,K}function At(n,t,e){t===void 0&&(t={}),e===void 0&&(e=null);var r=new S(n,e);t.sideOrientation=S._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;var i=xt(t);return i.applyToMesh(r,t.updatable),r}Q.CreateIcoSphere=xt;S.CreateIcoSphere=function(n,t,e){return At(n,t,e)};function St(n){var t=n.height||2,e=n.diameterTop===0?0:n.diameterTop||n.diameter||1,r=n.diameterBottom===0?0:n.diameterBottom||n.diameter||1;e=e||1e-5,r=r||1e-5;var i=n.tessellation||24,a=n.subdivisions||1,o=!!n.hasRings,s=!!n.enclose,u=n.cap===0?0:n.cap||S.CAP_ALL,f=n.arc&&(n.arc<=0||n.arc>1)?1:n.arc||1,l=n.sideOrientation===0?0:n.sideOrientation||Q.DEFAULTSIDE,c=n.faceUV||new Array(3),h=n.faceColors,d=f!==1&&s?2:0,v=o?a:1,g=2+(1+d)*v,p;for(p=0;p<g;p++)h&&h[p]===void 0&&(h[p]=new De(1,1,1,1));for(p=0;p<g;p++)c&&c[p]===void 0&&(c[p]=new be(0,0,1,1));var m=new Array,M=new Array,A=new Array,y=new Array,b=new Array,x=Math.PI*2*f/i,I,D,T,C=(r-e)/2/t,B=O.Zero(),V=O.Zero(),U=O.Zero(),R=O.Zero(),F=O.Zero(),W=vt.Y,K,E,w,L=1,P=1,Y=0,G=0;for(K=0;K<=a;K++)for(D=K/a,T=(D*(e-r)+r)/2,L=o&&K!==0&&K!==a?2:1,w=0;w<L;w++){for(o&&(P+=w),s&&(P+=2*w),E=0;E<=i;E++)I=E*x,B.x=Math.cos(-I)*T,B.y=-t/2+D*t,B.z=Math.sin(-I)*T,e===0&&K===a?(V.x=A[A.length-(i+1)*3],V.y=A[A.length-(i+1)*3+1],V.z=A[A.length-(i+1)*3+2]):(V.x=B.x,V.z=B.z,V.y=Math.sqrt(V.x*V.x+V.z*V.z)*C,V.normalize()),E===0&&(U.copyFrom(B),R.copyFrom(V)),M.push(B.x,B.y,B.z),A.push(V.x,V.y,V.z),o?G=Y!==P?c[P].y:c[P].w:G=c[P].y+(c[P].w-c[P].y)*D,y.push(c[P].x+(c[P].z-c[P].x)*E/i,j.UseOpenGLOrientationForUV?1-G:G),h&&b.push(h[P].r,h[P].g,h[P].b,h[P].a);f!==1&&s&&(M.push(B.x,B.y,B.z),M.push(0,B.y,0),M.push(0,B.y,0),M.push(U.x,U.y,U.z),O.CrossToRef(W,V,F),F.normalize(),A.push(F.x,F.y,F.z,F.x,F.y,F.z),O.CrossToRef(R,W,F),F.normalize(),A.push(F.x,F.y,F.z,F.x,F.y,F.z),o?G=Y!==P?c[P+1].y:c[P+1].w:G=c[P+1].y+(c[P+1].w-c[P+1].y)*D,y.push(c[P+1].x,j.UseOpenGLOrientationForUV?1-G:G),y.push(c[P+1].z,j.UseOpenGLOrientationForUV?1-G:G),o?G=Y!==P?c[P+2].y:c[P+2].w:G=c[P+2].y+(c[P+2].w-c[P+2].y)*D,y.push(c[P+2].x,j.UseOpenGLOrientationForUV?1-G:G),y.push(c[P+2].z,j.UseOpenGLOrientationForUV?1-G:G),h&&(b.push(h[P+1].r,h[P+1].g,h[P+1].b,h[P+1].a),b.push(h[P+1].r,h[P+1].g,h[P+1].b,h[P+1].a),b.push(h[P+2].r,h[P+2].g,h[P+2].b,h[P+2].a),b.push(h[P+2].r,h[P+2].g,h[P+2].b,h[P+2].a))),Y!==P&&(Y=P)}var H=f!==1&&s?i+4:i;for(K=0,P=0;P<a;P++){var Z=0,q=0,N=0,k=0;for(E=0;E<i;E++)Z=K*(H+1)+E,q=(K+1)*(H+1)+E,N=K*(H+1)+(E+1),k=(K+1)*(H+1)+(E+1),m.push(Z,q,N),m.push(k,N,q);f!==1&&s&&(m.push(Z+2,q+2,N+2),m.push(k+2,N+2,q+2),m.push(Z+4,q+4,N+4),m.push(k+4,N+4,q+4)),K=o?K+2:K+1}var ie=function(ee){var $=ee?e/2:r/2;if($!==0){var ae,te,re,fe=ee?c[g-1]:c[0],he=null;h&&(he=ee?h[g-1]:h[0]);var Se=M.length/3,Fe=ee?t/2:-t/2,Be=new O(0,Fe,0);M.push(Be.x,Be.y,Be.z),A.push(0,ee?1:-1,0);var Ce=fe.y+(fe.w-fe.y)*.5;y.push(fe.x+(fe.z-fe.x)*.5,j.UseOpenGLOrientationForUV?1-Ce:Ce),he&&b.push(he.r,he.g,he.b,he.a);var Ee=new le(.5,.5);for(re=0;re<=i;re++){ae=Math.PI*2*re*f/i;var Le=Math.cos(-ae),Ie=Math.sin(-ae);te=new O(Le*$,Fe,Ie*$);var nt=new le(Le*Ee.x+.5,Ie*Ee.y+.5);M.push(te.x,te.y,te.z),A.push(0,ee?1:-1,0);var st=fe.y+(fe.w-fe.y)*nt.y;y.push(fe.x+(fe.z-fe.x)*nt.x,j.UseOpenGLOrientationForUV?1-st:st),he&&b.push(he.r,he.g,he.b,he.a)}for(re=0;re<i;re++)ee?(m.push(Se),m.push(Se+(re+2)),m.push(Se+(re+1))):(m.push(Se),m.push(Se+(re+1)),m.push(Se+(re+2)))}};(u===S.CAP_START||u===S.CAP_ALL)&&ie(!1),(u===S.CAP_END||u===S.CAP_ALL)&&ie(!0),Q._ComputeSides(l,M,m,A,y,n.frontUVs,n.backUVs);var J=new Q;return J.indices=m,J.positions=M,J.normals=A,J.uvs=y,h&&(J.colors=b),J}function Bt(n,t,e){t===void 0&&(t={});var r=new S(n,e);t.sideOrientation=S._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;var i=St(t);return i.applyToMesh(r,t.updatable),r}Q.CreateCylinder=St;S.CreateCylinder=function(n,t,e,r,i,a,o,s,u){(o===void 0||!(o instanceof bt))&&(o!==void 0&&(u=s||S.DEFAULTSIDE,s=o),o=a,a=1);var f={height:t,diameterTop:e,diameterBottom:r,tessellation:i,subdivisions:a,sideOrientation:u,updatable:s};return Bt(n,f,o)};function Ot(n){for(var t=[],e=[],r=[],i=[],a=n.diameter||1,o=n.thickness||.5,s=n.tessellation||16,u=n.sideOrientation===0?0:n.sideOrientation||Q.DEFAULTSIDE,f=s+1,l=0;l<=s;l++)for(var c=l/s,h=l*Math.PI*2/s-Math.PI/2,d=X.Translation(a/2,0,0).multiply(X.RotationY(h)),v=0;v<=s;v++){var g=1-v/s,p=v*Math.PI*2/s+Math.PI,m=Math.cos(p),M=Math.sin(p),A=new O(m,M,0),y=A.scale(o/2),b=new le(c,g);y=O.TransformCoordinates(y,d),A=O.TransformNormal(A,d),e.push(y.x,y.y,y.z),r.push(A.x,A.y,A.z),i.push(b.x,j.UseOpenGLOrientationForUV?1-b.y:b.y);var x=(l+1)%f,I=(v+1)%f;t.push(l*f+v),t.push(l*f+I),t.push(x*f+v),t.push(l*f+I),t.push(x*f+I),t.push(x*f+v)}Q._ComputeSides(u,e,t,r,i,n.frontUVs,n.backUVs);var D=new Q;return D.indices=t,D.positions=e,D.normals=r,D.uvs=i,D}function Ct(n,t,e){t===void 0&&(t={});var r=new S(n,e);t.sideOrientation=S._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;var i=Ot(t);return i.applyToMesh(r,t.updatable),r}Q.CreateTorus=Ot;S.CreateTorus=function(n,t,e,r,i,a,o){var s={diameter:t,thickness:e,tessellation:r,sideOrientation:o,updatable:a};return Ct(n,s,i)};S._GroundMeshParser=function(n,t){return $e.Parse(n,t)};var $e=function(n){_e(t,n);function t(e,r){var i=n.call(this,e,r)||this;return i.generateOctree=!1,i}return t.prototype.getClassName=function(){return"GroundMesh"},Object.defineProperty(t.prototype,"subdivisions",{get:function(){return Math.min(this._subdivisionsX,this._subdivisionsY)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"subdivisionsX",{get:function(){return this._subdivisionsX},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"subdivisionsY",{get:function(){return this._subdivisionsY},enumerable:!1,configurable:!0}),t.prototype.optimize=function(e,r){r===void 0&&(r=32),this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e);var i=this;i.createOrUpdateSubmeshesOctree&&i.createOrUpdateSubmeshesOctree(r)},t.prototype.getHeightAtCoordinates=function(e,r){var i=this.getWorldMatrix(),a=z.Matrix[5];i.invertToRef(a);var o=z.Vector3[8];if(O.TransformCoordinatesFromFloatsToRef(e,0,r,a,o),e=o.x,r=o.z,e<this._minX||e>=this._maxX||r<=this._minZ||r>this._maxZ)return this.position.y;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());var s=this._getFacetAt(e,r),u=-(s.x*e+s.z*r+s.w)/s.y;return O.TransformCoordinatesFromFloatsToRef(0,u,0,i,o),o.y},t.prototype.getNormalAtCoordinates=function(e,r){var i=new O(0,1,0);return this.getNormalAtCoordinatesToRef(e,r,i),i},t.prototype.getNormalAtCoordinatesToRef=function(e,r,i){var a=this.getWorldMatrix(),o=z.Matrix[5];a.invertToRef(o);var s=z.Vector3[8];if(O.TransformCoordinatesFromFloatsToRef(e,0,r,o,s),e=s.x,r=s.z,e<this._minX||e>this._maxX||r<this._minZ||r>this._maxZ)return this;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());var u=this._getFacetAt(e,r);return O.TransformNormalFromFloatsToRef(u.x,u.y,u.z,a,i),this},t.prototype.updateCoordinateHeights=function(){return(!this._heightQuads||this._heightQuads.length==0)&&this._initHeightQuads(),this._computeHeightQuads(),this},t.prototype._getFacetAt=function(e,r){var i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),a=Math.floor(-(r+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),o=this._heightQuads[a*this._subdivisionsX+i],s;return r<o.slope.x*e+o.slope.y?s=o.facet1:s=o.facet2,s},t.prototype._initHeightQuads=function(){var e=this._subdivisionsX,r=this._subdivisionsY;this._heightQuads=new Array;for(var i=0;i<r;i++)for(var a=0;a<e;a++){var o={slope:le.Zero(),facet1:new be(0,0,0,0),facet2:new be(0,0,0,0)};this._heightQuads[i*e+a]=o}return this},t.prototype._computeHeightQuads=function(){var e=this.getVerticesData(_.PositionKind);if(!e)return this;for(var r=z.Vector3[3],i=z.Vector3[2],a=z.Vector3[1],o=z.Vector3[0],s=z.Vector3[4],u=z.Vector3[5],f=z.Vector3[6],l=z.Vector3[7],c=z.Vector3[8],h=0,d=0,v=0,g=0,p=0,m=0,M=0,A=this._subdivisionsX,y=this._subdivisionsY,b=0;b<y;b++)for(var x=0;x<A;x++){h=x*3,d=b*(A+1)*3,v=(b+1)*(A+1)*3,r.x=e[d+h],r.y=e[d+h+1],r.z=e[d+h+2],i.x=e[d+h+3],i.y=e[d+h+4],i.z=e[d+h+5],a.x=e[v+h],a.y=e[v+h+1],a.z=e[v+h+2],o.x=e[v+h+3],o.y=e[v+h+4],o.z=e[v+h+5],g=(o.z-r.z)/(o.x-r.x),p=r.z-g*r.x,i.subtractToRef(r,s),a.subtractToRef(r,u),o.subtractToRef(r,f),O.CrossToRef(f,u,l),O.CrossToRef(s,f,c),l.normalize(),c.normalize(),m=-(l.x*r.x+l.y*r.y+l.z*r.z),M=-(c.x*i.x+c.y*i.y+c.z*i.z);var I=this._heightQuads[b*A+x];I.slope.copyFromFloats(g,p),I.facet1.copyFromFloats(l.x,l.y,l.z,m),I.facet2.copyFromFloats(c.x,c.y,c.z,M)}return this},t.prototype.serialize=function(e){n.prototype.serialize.call(this,e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height},t.Parse=function(e,r){var i=new t(e.name,r);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i},t}(S);function Tt(n){var t=[],e=[],r=[],i=[],a,o,s=n.width||1,u=n.height||1,f=n.subdivisionsX||n.subdivisions||1,l=n.subdivisionsY||n.subdivisions||1;for(a=0;a<=l;a++)for(o=0;o<=f;o++){var c=new O(o*s/f-s/2,0,(l-a)*u/l-u/2),h=new O(0,1,0);e.push(c.x,c.y,c.z),r.push(h.x,h.y,h.z),i.push(o/f,j.UseOpenGLOrientationForUV?a/l:1-a/l)}for(a=0;a<l;a++)for(o=0;o<f;o++)t.push(o+1+(a+1)*(f+1)),t.push(o+1+a*(f+1)),t.push(o+a*(f+1)),t.push(o+(a+1)*(f+1)),t.push(o+1+(a+1)*(f+1)),t.push(o+a*(f+1));var d=new Q;return d.indices=t,d.positions=e,d.normals=r,d.uvs=i,d}function Pt(n){var t=n.xmin!==void 0&&n.xmin!==null?n.xmin:-1,e=n.zmin!==void 0&&n.zmin!==null?n.zmin:-1,r=n.xmax!==void 0&&n.xmax!==null?n.xmax:1,i=n.zmax!==void 0&&n.zmax!==null?n.zmax:1,a=n.subdivisions||{w:1,h:1},o=n.precision||{w:1,h:1},s=new Array,u=new Array,f=new Array,l=new Array,c,h,d,v;a.h=a.h<1?1:a.h,a.w=a.w<1?1:a.w,o.w=o.w<1?1:o.w,o.h=o.h<1?1:o.h;var g={w:(r-t)/a.w,h:(i-e)/a.h};function p(M,A,y,b){var x=u.length/3,I=o.w+1;for(c=0;c<o.h;c++)for(h=0;h<o.w;h++){var D=[x+h+c*I,x+(h+1)+c*I,x+(h+1)+(c+1)*I,x+h+(c+1)*I];s.push(D[1]),s.push(D[2]),s.push(D[3]),s.push(D[0]),s.push(D[1]),s.push(D[3])}var T=O.Zero(),C=new O(0,1,0);for(c=0;c<=o.h;c++)for(T.z=c*(b-A)/o.h+A,h=0;h<=o.w;h++)T.x=h*(y-M)/o.w+M,T.y=0,u.push(T.x,T.y,T.z),f.push(C.x,C.y,C.z),l.push(h/o.w,c/o.h)}for(d=0;d<a.h;d++)for(v=0;v<a.w;v++)p(t+v*g.w,e+d*g.h,t+(v+1)*g.w,e+(d+1)*g.h);var m=new Q;return m.indices=s,m.positions=u,m.normals=f,m.uvs=l,m}function wt(n){var t=[],e=[],r=[],i=[],a,o,s=n.colorFilter||new we(.3,.59,.11),u=n.alphaFilter||0,f=!1;if(n.minHeight>n.maxHeight){f=!0;var l=n.maxHeight;n.maxHeight=n.minHeight,n.minHeight=l}for(a=0;a<=n.subdivisions;a++)for(o=0;o<=n.subdivisions;o++){var c=new O(o*n.width/n.subdivisions-n.width/2,0,(n.subdivisions-a)*n.height/n.subdivisions-n.height/2),h=(c.x+n.width/2)/n.width*(n.bufferWidth-1)|0,d=(1-(c.z+n.height/2)/n.height)*(n.bufferHeight-1)|0,v=(h+d*n.bufferWidth)*4,g=n.buffer[v]/255,p=n.buffer[v+1]/255,m=n.buffer[v+2]/255,M=n.buffer[v+3]/255;f&&(g=1-g,p=1-p,m=1-m);var A=g*s.r+p*s.g+m*s.b;M>=u?c.y=n.minHeight+(n.maxHeight-n.minHeight)*A:c.y=n.minHeight-xe,e.push(c.x,c.y,c.z),r.push(0,0,0),i.push(o/n.subdivisions,1-a/n.subdivisions)}for(a=0;a<n.subdivisions;a++)for(o=0;o<n.subdivisions;o++){var y=o+1+(a+1)*(n.subdivisions+1),b=o+1+a*(n.subdivisions+1),x=o+a*(n.subdivisions+1),I=o+(a+1)*(n.subdivisions+1),D=e[y*3+1]>=n.minHeight,T=e[b*3+1]>=n.minHeight,C=e[x*3+1]>=n.minHeight;D&&T&&C&&(t.push(y),t.push(b),t.push(x));var B=e[I*3+1]>=n.minHeight;B&&D&&C&&(t.push(I),t.push(y),t.push(x))}Q.ComputeNormals(e,t,r);var V=new Q;return V.indices=t,V.positions=e,V.normals=r,V.uvs=i,V}function Vt(n,t,e){t===void 0&&(t={});var r=new $e(n,e);r._setReady(!1),r._subdivisionsX=t.subdivisionsX||t.subdivisions||1,r._subdivisionsY=t.subdivisionsY||t.subdivisions||1,r._width=t.width||1,r._height=t.height||1,r._maxX=r._width/2,r._maxZ=r._height/2,r._minX=-r._maxX,r._minZ=-r._maxZ;var i=Tt(t);return i.applyToMesh(r,t.updatable),r._setReady(!0),r}function Ft(n,t,e){e===void 0&&(e=null);var r=new S(n,e),i=Pt(t);return i.applyToMesh(r,t.updatable),r}function Lt(n,t,e,r){e===void 0&&(e={}),r===void 0&&(r=null);var i=e.width||10,a=e.height||10,o=e.subdivisions||1,s=e.minHeight||0,u=e.maxHeight||1,f=e.colorFilter||new we(.3,.59,.11),l=e.alphaFilter||0,c=e.updatable,h=e.onReady;r=r||Qe.LastCreatedScene;var d=new $e(n,r);d._subdivisionsX=o,d._subdivisionsY=o,d._width=i,d._height=a,d._maxX=d._width/2,d._maxZ=d._height/2,d._minX=-d._maxX,d._minZ=-d._maxZ,d._setReady(!1);var v=function(g){var p=g.width,m=g.height;if(!r.isDisposed){var M=r==null?void 0:r.getEngine().resizeImageBitmap(g,p,m),A=wt({width:i,height:a,subdivisions:o,minHeight:s,maxHeight:u,colorFilter:f,buffer:M,bufferWidth:p,bufferHeight:m,alphaFilter:l});A.applyToMesh(d,c),h&&h(d),d._setReady(!0)}};return ye.LoadImage(t,v,function(){},r.offlineProvider),d}Q.CreateGround=Tt;Q.CreateTiledGround=Pt;Q.CreateGroundFromHeightMap=wt;S.CreateGround=function(n,t,e,r,i,a){var o={width:t,height:e,subdivisions:r,updatable:a};return Vt(n,o,i)};S.CreateTiledGround=function(n,t,e,r,i,a,o,s,u){var f={xmin:t,zmin:e,xmax:r,zmax:i,subdivisions:a,precision:o,updatable:u};return Ft(n,f,s)};S.CreateGroundFromHeightMap=function(n,t,e,r,i,a,o,s,u,f,l){var c={width:e,height:r,subdivisions:i,minHeight:a,maxHeight:o,updatable:u,onReady:f,alphaFilter:l};return Lt(n,t,c,s)};function Et(n){var t=6,e=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],r=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],i=[],a=[],o=n.width||n.size||1,s=n.height||n.size||1,u=n.depth||n.size||1,f=n.wrap||!1,l=n.topBaseAt===void 0?1:n.topBaseAt,c=n.bottomBaseAt===void 0?0:n.bottomBaseAt;l=(l+4)%4,c=(c+4)%4;var h=[2,0,3,1],d=[2,0,1,3],v=h[l],g=d[c],p=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(f){e=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],p=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];for(var m=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],M=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]],A=[17,18,19,16],y=[22,23,20,21];v>0;)m.unshift(m.pop()),A.unshift(A.pop()),v--;for(;g>0;)M.unshift(M.pop()),y.unshift(y.pop()),g--;m=m.flat(),M=M.flat(),p=p.concat(m).concat(M),e.push(A[0],A[2],A[3],A[0],A[1],A[2]),e.push(y[0],y[2],y[3],y[0],y[1],y[2])}var b=[o/2,s/2,u/2];a=p.reduce(function(F,W,K){return F.concat(W*b[K%3])},[]);for(var x=n.sideOrientation===0?0:n.sideOrientation||Q.DEFAULTSIDE,I=n.faceUV||new Array(6),D=n.faceColors,T=[],C=0;C<6;C++)I[C]===void 0&&(I[C]=new be(0,0,1,1)),D&&D[C]===void 0&&(D[C]=new De(1,1,1,1));for(var B=0;B<t;B++)if(i.push(I[B].z,j.UseOpenGLOrientationForUV?1-I[B].w:I[B].w),i.push(I[B].x,j.UseOpenGLOrientationForUV?1-I[B].w:I[B].w),i.push(I[B].x,j.UseOpenGLOrientationForUV?1-I[B].y:I[B].y),i.push(I[B].z,j.UseOpenGLOrientationForUV?1-I[B].y:I[B].y),D)for(var V=0;V<4;V++)T.push(D[B].r,D[B].g,D[B].b,D[B].a);Q._ComputeSides(x,a,e,r,i,n.frontUVs,n.backUVs);var U=new Q;if(U.indices=e,U.positions=a,U.normals=r,U.uvs=i,D){var R=x===Q.DOUBLESIDE?T.concat(T):T;U.colors=R}return U}function Rt(n,t,e){t===void 0&&(t={}),e===void 0&&(e=null);var r=new S(n,e);t.sideOrientation=S._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;var i=Et(t);return i.applyToMesh(r,t.updatable),r}Q.CreateBox=Et;S.CreateBox=function(n,t,e,r,i){e===void 0&&(e=null);var a={size:t,sideOrientation:i,updatable:r};return Rt(n,a,e)};function Ut(n){for(var t=n.segments||32,e=n.diameterX||n.diameter||1,r=n.diameterY||n.diameter||1,i=n.diameterZ||n.diameter||1,a=n.arc&&(n.arc<=0||n.arc>1)?1:n.arc||1,o=n.slice&&n.slice<=0?1:n.slice||1,s=n.sideOrientation===0?0:n.sideOrientation||Q.DEFAULTSIDE,u=!!n.dedupTopBottomIndices,f=new O(e/2,r/2,i/2),l=2+t,c=2*l,h=[],d=[],v=[],g=[],p=0;p<=l;p++){for(var m=p/l,M=m*Math.PI*o,A=0;A<=c;A++){var y=A/c,b=y*Math.PI*2*a,x=X.RotationZ(-M),I=X.RotationY(b),D=O.TransformCoordinates(O.Up(),x),T=O.TransformCoordinates(D,I),C=T.multiply(f),B=T.divide(f).normalize();d.push(C.x,C.y,C.z),v.push(B.x,B.y,B.z),g.push(y,j.UseOpenGLOrientationForUV?1-m:m)}if(p>0)for(var V=d.length/3,U=V-2*(c+1);U+c+2<V;U++)u?(p>1&&(h.push(U),h.push(U+1),h.push(U+c+1)),(p<l||o<1)&&(h.push(U+c+1),h.push(U+1),h.push(U+c+2))):(h.push(U),h.push(U+1),h.push(U+c+1),h.push(U+c+1),h.push(U+1),h.push(U+c+2))}Q._ComputeSides(s,d,h,v,g,n.frontUVs,n.backUVs);var R=new Q;return R.indices=h,R.positions=d,R.normals=v,R.uvs=g,R}function et(n,t,e){t===void 0&&(t={}),e===void 0&&(e=null);var r=new S(n,e);t.sideOrientation=S._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;var i=Ut(t);return i.applyToMesh(r,t.updatable),r}Q.CreateSphere=Ut;S.CreateSphere=function(n,t,e,r,i,a){var o={segments:t,diameterX:e,diameterY:e,diameterZ:e,sideOrientation:a,updatable:i};return et(n,o,r)};function Nt(n){n===void 0&&(n={subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6});var t=Math.max(n.subdivisions?n.subdivisions:2,1),e=Math.max(n.tessellation?n.tessellation:16,3),r=Math.max(n.height?n.height:1,0),i=Math.max(n.radius?n.radius:.25,0),a=Math.max(n.capSubdivisions?n.capSubdivisions:6,1),o=e,s=t,u=Math.max(n.radiusTop?n.radiusTop:i,0),f=Math.max(n.radiusBottom?n.radiusBottom:i,0),l=r-(u+f),c=0,h=2*Math.PI,d=Math.max(n.topCapSubdivisions?n.topCapSubdivisions:a,1),v=Math.max(n.bottomCapSubdivisions?n.bottomCapSubdivisions:a,1),g=Math.acos((f-u)/r),p=[],m=[],M=[],A=[],y=0,b=[],x=l*.5,I=Math.PI*.5,D,T,C=O.Zero(),B=O.Zero(),V=Math.cos(g),U=Math.sin(g),R=new le(u*U,x+u*V).subtract(new le(f*U,-x+f*V)).length(),F=u*g+R+f*(I-g),W=0;for(T=0;T<=d;T++){var K=[],E=I-g*(T/d);W+=u*g/d;var w=Math.cos(E),L=Math.sin(E),P=w*u;for(D=0;D<=o;D++){var Y=D/o,G=Y*h+c,H=Math.sin(G),Z=Math.cos(G);B.x=P*H,B.y=x+L*u,B.z=P*Z,m.push(B.x,B.y,B.z),C.set(w*H,L,w*Z),M.push(C.x,C.y,C.z),A.push(Y,j.UseOpenGLOrientationForUV?W/F:1-W/F),K.push(y),y++}b.push(K)}var q=r-u-f+V*u-V*f,N=U*(f-u)/q;for(T=1;T<=s;T++){var K=[];W+=R/s;var P=U*(T*(f-u)/s+u);for(D=0;D<=o;D++){var Y=D/o,G=Y*h+c,H=Math.sin(G),Z=Math.cos(G);B.x=P*H,B.y=x+V*u-T*q/s,B.z=P*Z,m.push(B.x,B.y,B.z),C.set(H,N,Z).normalize(),M.push(C.x,C.y,C.z),A.push(Y,j.UseOpenGLOrientationForUV?W/F:1-W/F),K.push(y),y++}b.push(K)}for(T=1;T<=v;T++){var K=[],E=I-g-(Math.PI-g)*(T/v);W+=f*g/v;var w=Math.cos(E),L=Math.sin(E),P=w*f;for(D=0;D<=o;D++){var Y=D/o,G=Y*h+c,H=Math.sin(G),Z=Math.cos(G);B.x=P*H,B.y=-x+L*f,B.z=P*Z,m.push(B.x,B.y,B.z),C.set(w*H,L,w*Z),M.push(C.x,C.y,C.z),A.push(Y,j.UseOpenGLOrientationForUV?W/F:1-W/F),K.push(y),y++}b.push(K)}for(D=0;D<o;D++)for(T=0;T<d+s+v;T++){var k=b[T][D],ie=b[T+1][D],J=b[T+1][D+1],ee=b[T][D+1];p.push(k),p.push(ie),p.push(ee),p.push(ie),p.push(J),p.push(ee)}if(p=p.reverse(),n.orientation&&!n.orientation.equals(O.Up())){var $=new X;n.orientation.clone().scale(Math.PI*.5).cross(O.Up()).toQuaternion().toRotationMatrix($);for(var ae=O.Zero(),te=0;te<m.length;te+=3)ae.set(m[te],m[te+1],m[te+2]),O.TransformCoordinatesToRef(ae.clone(),$,ae),m[te]=ae.x,m[te+1]=ae.y,m[te+2]=ae.z}var re=new Q;return re.positions=m,re.normals=M,re.uvs=A,re.indices=p,re}function zt(n,t,e){t===void 0&&(t={orientation:O.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6,updatable:!1}),e===void 0&&(e=null);var r=new S(n,e),i=Nt(t);return i.applyToMesh(r,t.updatable),r}S.CreateCapsule=function(n,t,e){return zt(n,t,e)};Q.CreateCapsule=Nt;S._instancedMeshFactory=function(n,t){var e=new Wt(n,t);if(t.instancedBuffers){e.instancedBuffers={};for(var r in t.instancedBuffers)e.instancedBuffers[r]=t.instancedBuffers[r]}return e};var Wt=function(n){_e(t,n);function t(e,r){var i=n.call(this,e,r.getScene())||this;i._indexInSourceMeshInstanceArray=-1,i._distanceToCamera=0,r.addInstance(i),i._sourceMesh=r,i._unIndexed=r._unIndexed,i.position.copyFrom(r.position),i.rotation.copyFrom(r.rotation),i.scaling.copyFrom(r.scaling),r.rotationQuaternion&&(i.rotationQuaternion=r.rotationQuaternion.clone()),i.animations=r.animations.slice();for(var a=0,o=r.getAnimationRanges();a<o.length;a++){var s=o[a];s!=null&&i.createAnimationRange(s.name,s.from,s.to)}return i.infiniteDistance=r.infiniteDistance,i.setPivotMatrix(r.getPivotMatrix()),i.refreshBoundingInfo(!0,!0),i._syncSubMeshes(),i}return t.prototype.getClassName=function(){return"InstancedMesh"},Object.defineProperty(t.prototype,"lightSources",{get:function(){return this._sourceMesh._lightSources},enumerable:!1,configurable:!0}),t.prototype._resyncLightSources=function(){},t.prototype._resyncLightSource=function(){},t.prototype._removeLightSource=function(){},Object.defineProperty(t.prototype,"receiveShadows",{get:function(){return this._sourceMesh.receiveShadows},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"material",{get:function(){return this._sourceMesh.material},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"visibility",{get:function(){return this._sourceMesh.visibility},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"skeleton",{get:function(){return this._sourceMesh.skeleton},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"renderingGroupId",{get:function(){return this._sourceMesh.renderingGroupId},set:function(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||ue.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")},enumerable:!1,configurable:!0}),t.prototype.getTotalVertices=function(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0},t.prototype.getTotalIndices=function(){return this._sourceMesh.getTotalIndices()},Object.defineProperty(t.prototype,"sourceMesh",{get:function(){return this._sourceMesh},enumerable:!1,configurable:!0}),t.prototype.createInstance=function(e){return this._sourceMesh.createInstance(e)},t.prototype.isReady=function(e){return e===void 0&&(e=!1),this._sourceMesh.isReady(e,!0)},t.prototype.getVerticesData=function(e,r){return this._sourceMesh.getVerticesData(e,r)},t.prototype.setVerticesData=function(e,r,i,a){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,r,i,a),this.sourceMesh},t.prototype.updateVerticesData=function(e,r,i,a){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,r,i,a),this.sourceMesh},t.prototype.setIndices=function(e,r){return r===void 0&&(r=null),this.sourceMesh&&this.sourceMesh.setIndices(e,r),this.sourceMesh},t.prototype.isVerticesDataPresent=function(e){return this._sourceMesh.isVerticesDataPresent(e)},t.prototype.getIndices=function(){return this._sourceMesh.getIndices()},Object.defineProperty(t.prototype,"_positions",{get:function(){return this._sourceMesh._positions},enumerable:!1,configurable:!0}),t.prototype.refreshBoundingInfo=function(e,r){if(e===void 0&&(e=!1),r===void 0&&(r=!1),this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;var i=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getPositionData(e,r),i),this},t.prototype._preActivate=function(){return this._currentLOD&&this._currentLOD._preActivate(),this},t.prototype._activate=function(e,r){if(n.prototype._activate.call(this,e,r),this._sourceMesh.subMeshes||ue.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){var i=this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0;if(i)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),r){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1},t.prototype._postActivate=function(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)},t.prototype.getWorldMatrix=function(){if(this._currentLOD&&this._currentLOD.billboardMode!==Me.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new X);var e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,z.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(z.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return n.prototype.getWorldMatrix.call(this)},Object.defineProperty(t.prototype,"isAnInstance",{get:function(){return!0},enumerable:!1,configurable:!0}),t.prototype.getLOD=function(e){if(!e)return this;var r=this.sourceMesh.getLODLevels();if(!r||r.length===0)this._currentLOD=this.sourceMesh;else{var i=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,i.boundingSphere)}return this._currentLOD},t.prototype._preActivateForIntermediateRendering=function(e){return this.sourceMesh._preActivateForIntermediateRendering(e)},t.prototype._syncSubMeshes=function(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(var e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this},t.prototype._generatePointsArray=function(){return this._sourceMesh._generatePointsArray()},t.prototype._updateBoundingInfo=function(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this},t.prototype.clone=function(e,r,i){r===void 0&&(r=null);var a=this._sourceMesh.createInstance(e);if(mt.DeepCopy(this,a,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),r&&(a.parent=r),!i)for(var o=0;o<this.getScene().meshes.length;o++){var s=this.getScene().meshes[o];s.parent===this&&s.clone(s.name,a)}return a.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(a),a},t.prototype.dispose=function(e,r){r===void 0&&(r=!1),this._sourceMesh.removeInstance(this),n.prototype.dispose.call(this,e,r)},t.prototype._serializeAsParent=function(e){n.prototype._serializeAsParent.call(this,e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray},t}(Ze);S.prototype.registerInstancedBuffer=function(n,t){var e,r;if((r=(e=this._userInstancedBuffersStorage)===null||e===void 0?void 0:e.vertexBuffers[n])===null||r===void 0||r.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(var i=0,a=this.instances;i<a.length;i++){var o=a[i];o.instancedBuffers={}}this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0})}this.instancedBuffers[n]=null,this._userInstancedBuffersStorage.strides[n]=t,this._userInstancedBuffersStorage.sizes[n]=t*32,this._userInstancedBuffersStorage.data[n]=new Float32Array(this._userInstancedBuffersStorage.sizes[n]),this._userInstancedBuffersStorage.vertexBuffers[n]=new _(this.getEngine(),this._userInstancedBuffersStorage.data[n],n,!0,!1,t,!0);for(var s=0,u=this.instances;s<u.length;s++){var o=u[s];o.instancedBuffers[n]=null}this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()};S.prototype._processInstancedBuffers=function(n,t){var e=n.length;for(var r in this.instancedBuffers){for(var i=this._userInstancedBuffersStorage.sizes[r],a=this._userInstancedBuffersStorage.strides[r],o=(e+1)*a;i<o;)i*=2;this._userInstancedBuffersStorage.data[r].length!=i&&(this._userInstancedBuffersStorage.data[r]=new Float32Array(i),this._userInstancedBuffersStorage.sizes[r]=i,this._userInstancedBuffersStorage.vertexBuffers[r]&&(this._userInstancedBuffersStorage.vertexBuffers[r].dispose(),this._userInstancedBuffersStorage.vertexBuffers[r]=null));var s=this._userInstancedBuffersStorage.data[r],u=0;if(t){var f=this.instancedBuffers[r];f.toArray?f.toArray(s,u):f.copyToArray?f.copyToArray(s,u):s[u]=f,u+=a}for(var l=0;l<e;l++){var c=n[l],f=c.instancedBuffers[r];f.toArray?f.toArray(s,u):f.copyToArray?f.copyToArray(s,u):s[u]=f,u+=a}this._userInstancedBuffersStorage.vertexBuffers[r]?this._userInstancedBuffersStorage.vertexBuffers[r].updateDirectly(s,0):(this._userInstancedBuffersStorage.vertexBuffers[r]=new _(this.getEngine(),this._userInstancedBuffersStorage.data[r],r,!0,!1,a,!0),this._invalidateInstanceVertexArrayObject())}};S.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(var n in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[n]);this._userInstancedBuffersStorage.vertexArrayObjects={}}};S.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(var n in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[n]&&this._userInstancedBuffersStorage.vertexBuffers[n].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};S._LinesMeshParser=function(n,t){return tt.Parse(n,t)};var tt=function(n){_e(t,n);function t(e,r,i,a,o,s,u,f){r===void 0&&(r=null),i===void 0&&(i=null),a===void 0&&(a=null);var l=n.call(this,e,r,i,a,o)||this;l.useVertexColor=s,l.useVertexAlpha=u,l.color=new we(1,1,1),l.alpha=1,a&&(l.color=a.color.clone(),l.alpha=a.alpha,l.useVertexColor=a.useVertexColor,l.useVertexAlpha=a.useVertexAlpha),l.intersectionThreshold=.1;var c=[],h={attributes:[_.PositionKind],uniforms:["vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","world","viewProjection"],needAlphaBlending:!0,defines:c,useClipPlane:null};return u===!1?h.needAlphaBlending=!1:h.defines.push("#define VERTEXALPHA"),s?(h.defines.push("#define VERTEXCOLOR"),h.attributes.push(_.ColorKind)):(h.uniforms.push("color"),l._color4=new De),f?l.material=f:l.material=new Sr("colorShader",l.getScene(),"color",h,!1),l}return t.prototype._isShaderMaterial=function(e){return e.getClassName()==="ShaderMaterial"},t.prototype.isReady=function(){return this._lineMaterial.isReady(this,!!this._userInstancedBuffersStorage)?n.prototype.isReady.call(this):!1},t.prototype.getClassName=function(){return"LinesMesh"},Object.defineProperty(t.prototype,"material",{get:function(){return this._lineMaterial},set:function(e){this._lineMaterial=e,this._lineMaterial.fillMode=ve.LineListDrawMode},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"checkCollisions",{get:function(){return!1},set:function(e){},enumerable:!1,configurable:!0}),t.prototype._bind=function(){if(!this._geometry)return this;var e=this._lineMaterial.getEffect(),r=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(this._userInstancedBuffersStorage?this._geometry._bind(e,r,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects):this._geometry._bind(e,r),!this.useVertexColor&&this._isShaderMaterial(this._lineMaterial)){var i=this.color,a=i.r,o=i.g,s=i.b;this._color4.set(a,o,s,this.alpha),this._lineMaterial.setColor4("color",this._color4)}return this},t.prototype._draw=function(e,r,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;var a=this.getScene().getEngine();return this._unIndexed?a.drawArraysType(ve.LineListDrawMode,e.verticesStart,e.verticesCount,i):a.drawElementsType(ve.LineListDrawMode,e.indexStart,e.indexCount,i),this},t.prototype.dispose=function(e){this._lineMaterial.dispose(!1,!1,!0),n.prototype.dispose.call(this,e)},t.prototype.clone=function(e,r,i){return r===void 0&&(r=null),new t(e,this.getScene(),r,this,i)},t.prototype.createInstance=function(e){var r=new Vr(e,this);if(this.instancedBuffers){r.instancedBuffers={};for(var i in this.instancedBuffers)r.instancedBuffers[i]=this.instancedBuffers[i]}return r},t.prototype.serialize=function(e){n.prototype.serialize.call(this,e),e.color=this.color.asArray(),e.alpha=this.alpha},t.Parse=function(e,r){var i=new t(e.name,r);return i.color=we.FromArray(e.color),i.alpha=e.alpha,i},t}(S),Vr=function(n){_e(t,n);function t(e,r){var i=n.call(this,e,r)||this;return i.intersectionThreshold=r.intersectionThreshold,i}return t.prototype.getClassName=function(){return"InstancedLinesMesh"},t}(Wt);function Kt(n){for(var t=[],e=[],r=n.lines,i=n.colors,a=[],o=0,s=0;s<r.length;s++)for(var u=r[s],f=0;f<u.length;f++){if(e.push(u[f].x,u[f].y,u[f].z),i){var l=i[s];a.push(l[f].r,l[f].g,l[f].b,l[f].a)}f>0&&(t.push(o-1),t.push(o)),o++}var c=new Q;return c.indices=t,c.positions=e,i&&(c.colors=a),c}function Qt(n){var t=n.dashSize||3,e=n.gapSize||1,r=n.dashNb||200,i=n.points,a=new Array,o=new Array,s=O.Zero(),u=0,f=0,l=0,c=0,h=0,d=0,v=0;for(v=0;v<i.length-1;v++)i[v+1].subtractToRef(i[v],s),u+=s.length();for(l=u/r,c=t*l/(t+e),v=0;v<i.length-1;v++){i[v+1].subtractToRef(i[v],s),f=Math.floor(s.length()/l),s.normalize();for(var g=0;g<f;g++)h=l*g,a.push(i[v].x+h*s.x,i[v].y+h*s.y,i[v].z+h*s.z),a.push(i[v].x+(h+c)*s.x,i[v].y+(h+c)*s.y,i[v].z+(h+c)*s.z),o.push(d,d+1),d+=2}var p=new Q;return p.positions=a,p.indices=o,p}function Zt(n,t,e){var r=t.instance,i=t.lines,a=t.colors;if(r){var o=r.getVerticesData(_.PositionKind),s=void 0,u=void 0;a&&(s=r.getVerticesData(_.ColorKind));for(var f=0,l=0,c=0;c<i.length;c++)for(var h=i[c],d=0;d<h.length;d++)o[f]=h[d].x,o[f+1]=h[d].y,o[f+2]=h[d].z,a&&s&&(u=a[c],s[l]=u[d].r,s[l+1]=u[d].g,s[l+2]=u[d].b,s[l+3]=u[d].a,l+=4),f+=3;return r.updateVerticesData(_.PositionKind,o,!1,!1),a&&s&&r.updateVerticesData(_.ColorKind,s,!1,!1),r}var v=!!a,g=new tt(n,e,null,void 0,void 0,v,t.useVertexAlpha,t.material),p=Kt(t);return p.applyToMesh(g,t.updatable),g}function Gt(n,t,e){e===void 0&&(e=null);var r=t.colors?[t.colors]:null,i=Zt(n,{lines:[t.points],updatable:t.updatable,instance:t.instance,colors:r,useVertexAlpha:t.useVertexAlpha,material:t.material},e);return i}function Yt(n,t,e){e===void 0&&(e=null);var r=t.points,i=t.instance,a=t.gapSize||1,o=t.dashSize||3;if(i){var s=function(l){var c=O.Zero(),h=l.length/6,d=0,v=0,g=0,p=0,m=0,M=0,A=0,y=0;for(A=0;A<r.length-1;A++)r[A+1].subtractToRef(r[A],c),d+=c.length();g=d/h;var b=i._creationDataStorage.dashSize,x=i._creationDataStorage.gapSize;for(p=b*g/(b+x),A=0;A<r.length-1;A++)for(r[A+1].subtractToRef(r[A],c),v=Math.floor(c.length()/g),c.normalize(),y=0;y<v&&M<l.length;)m=g*y,l[M]=r[A].x+m*c.x,l[M+1]=r[A].y+m*c.y,l[M+2]=r[A].z+m*c.z,l[M+3]=r[A].x+(m+p)*c.x,l[M+4]=r[A].y+(m+p)*c.y,l[M+5]=r[A].z+(m+p)*c.z,M+=6,y++;for(;M<l.length;)l[M]=r[A].x,l[M+1]=r[A].y,l[M+2]=r[A].z,M+=3};return(t.dashNb||t.dashSize||t.gapSize||t.useVertexAlpha||t.material)&&ue.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),i.updateMeshPositions(s,!1),i}var u=new tt(n,e,null,void 0,void 0,void 0,t.useVertexAlpha,t.material),f=Qt(t);return f.applyToMesh(u,t.updatable),u._creationDataStorage=new Dt,u._creationDataStorage.dashSize=o,u._creationDataStorage.gapSize=a,u}Q.CreateLineSystem=Kt;Q.CreateDashedLines=Qt;S.CreateLines=function(n,t,e,r,i){e===void 0&&(e=null),r===void 0&&(r=!1),i===void 0&&(i=null);var a={points:t,updatable:r,instance:i};return Gt(n,a,e)};S.CreateDashedLines=function(n,t,e,r,i,a,o,s){a===void 0&&(a=null);var u={points:t,dashSize:e,gapSize:r,dashNb:i,updatable:o,instance:s};return Yt(n,u,a)};function Ht(n){var t=n.pathArray,e=n.closeArray||!1,r=n.closePath||!1,i=n.invertUV||!1,a=Math.floor(t[0].length/2),o=n.offset||a;o=o>a?a:Math.floor(o);var s=n.sideOrientation===0?0:n.sideOrientation||Q.DEFAULTSIDE,u=n.uvs,f=n.colors,l=[],c=[],h=[],d=[],v=[],g=[],p=[],m=[],M,A=[],y=[],b,x,I;if(t.length<2){var D=[],T=[];for(x=0;x<t[0].length-o;x++)D.push(t[0][x]),T.push(t[0][x+o]);t=[D,T]}var C=0,B=r?1:0,V,U;M=t[0].length;var R,F;for(b=0;b<t.length;b++){for(p[b]=0,v[b]=[0],V=t[b],U=V.length,M=M<U?M:U,I=0;I<U;)l.push(V[I].x,V[I].y,V[I].z),I>0&&(R=V[I].subtract(V[I-1]).length(),F=R+p[b],v[b].push(F),p[b]=F),I++;r&&(I--,l.push(V[0].x,V[0].y,V[0].z),R=V[I].subtract(V[0]).length(),F=R+p[b],v[b].push(F),p[b]=F),A[b]=U+B,y[b]=C,C+=U+B}var W,K,E=null,w=null;for(x=0;x<M+B;x++){for(m[x]=0,g[x]=[0],b=0;b<t.length-1;b++)W=t[b],K=t[b+1],x===M?(E=W[0],w=K[0]):(E=W[x],w=K[x]),R=w.subtract(E).length(),F=R+m[x],g[x].push(F),m[x]=F;e&&w&&E&&(W=t[b],K=t[0],x===M&&(w=K[0]),R=w.subtract(E).length(),F=R+m[x],m[x]=F)}var L,P;if(u)for(b=0;b<u.length;b++)d.push(u[b].x,j.UseOpenGLOrientationForUV?1-u[b].y:u[b].y);else for(b=0;b<t.length;b++)for(x=0;x<M+B;x++)L=p[b]!=0?v[b][x]/p[b]:0,P=m[x]!=0?g[x][b]/m[x]:0,i?d.push(P,L):d.push(L,j.UseOpenGLOrientationForUV?1-P:P);b=0;for(var Y=0,G=A[b]-1,H=A[b+1]-1,Z=G<H?G:H,q=y[1]-y[0],N=e?A.length:A.length-1;Y<=Z&&b<N;)c.push(Y,Y+q,Y+1),c.push(Y+q+1,Y+1,Y+q),Y+=1,Y===Z&&(b++,b===A.length-1?(q=y[0]-y[b],G=A[b]-1,H=A[0]-1):(q=y[b+1]-y[b],G=A[b]-1,H=A[b+1]-1),Y=y[b],Z=G<H?G+Y:H+Y);if(Q.ComputeNormals(l,c,h),r){var k=0,ie=0;for(b=0;b<t.length;b++)k=y[b]*3,b+1<t.length?ie=(y[b+1]-1)*3:ie=h.length-3,h[k]=(h[k]+h[ie])*.5,h[k+1]=(h[k+1]+h[ie+1])*.5,h[k+2]=(h[k+2]+h[ie+2])*.5,h[ie]=h[k],h[ie+1]=h[k+1],h[ie+2]=h[k+2]}Q._ComputeSides(s,l,c,h,d,n.frontUVs,n.backUVs);var J=null;if(f){J=new Float32Array(f.length*4);for(var ee=0;ee<f.length;ee++)J[ee*4]=f[ee].r,J[ee*4+1]=f[ee].g,J[ee*4+2]=f[ee].b,J[ee*4+3]=f[ee].a}var $=new Q,ae=new Float32Array(l),te=new Float32Array(h),re=new Float32Array(d);return $.indices=c,$.positions=ae,$.normals=te,$.uvs=re,J&&$.set(J,_.ColorKind),r&&($._idx=y),$}function Ve(n,t,e){e===void 0&&(e=null);var r=t.pathArray,i=t.closeArray,a=t.closePath,o=S._GetDefaultSideOrientation(t.sideOrientation),s=t.instance,u=t.updatable;if(s){var f=z.Vector3[0].setAll(Number.MAX_VALUE),l=z.Vector3[1].setAll(-Number.MAX_VALUE),c=function(B){for(var V=r[0].length,U=s,R=0,F=U._originalBuilderSideOrientation===S.DOUBLESIDE?2:1,W=1;W<=F;++W)for(var K=0;K<r.length;++K){var E=r[K],w=E.length;V=V<w?V:w;for(var L=0;L<V;++L){var P=E[L];B[R]=P.x,B[R+1]=P.y,B[R+2]=P.z,f.minimizeInPlaceFromFloats(P.x,P.y,P.z),l.maximizeInPlaceFromFloats(P.x,P.y,P.z),R+=3}if(U._creationDataStorage&&U._creationDataStorage.closePath){var P=E[0];B[R]=P.x,B[R+1]=P.y,B[R+2]=P.z,R+=3}}},h=s.getVerticesData(_.PositionKind);if(c(h),s.hasBoundingInfo?s.getBoundingInfo().reConstruct(f,l,s._worldMatrix):s.buildBoundingInfo(f,l,s._worldMatrix),s.updateVerticesData(_.PositionKind,h,!1,!1),t.colors){for(var d=s.getVerticesData(_.ColorKind),v=0,g=0;v<t.colors.length;v++,g+=4){var p=t.colors[v];d[g]=p.r,d[g+1]=p.g,d[g+2]=p.b,d[g+3]=p.a}s.updateVerticesData(_.ColorKind,d,!1,!1)}if(t.uvs){for(var m=s.getVerticesData(_.UVKind),M=0;M<t.uvs.length;M++)m[M*2]=t.uvs[M].x,m[M*2+1]=j.UseOpenGLOrientationForUV?1-t.uvs[M].y:t.uvs[M].y;s.updateVerticesData(_.UVKind,m,!1,!1)}if(!s.areNormalsFrozen||s.isFacetDataEnabled){var A=s.getIndices(),y=s.getVerticesData(_.NormalKind),b=s.isFacetDataEnabled?s.getFacetDataParameters():null;if(Q.ComputeNormals(h,A,y,b),s._creationDataStorage&&s._creationDataStorage.closePath)for(var x=0,I=0,D=0;D<r.length;D++)x=s._creationDataStorage.idx[D]*3,D+1<r.length?I=(s._creationDataStorage.idx[D+1]-1)*3:I=y.length-3,y[x]=(y[x]+y[I])*.5,y[x+1]=(y[x+1]+y[I+1])*.5,y[x+2]=(y[x+2]+y[I+2])*.5,y[I]=y[x],y[I+1]=y[x+1],y[I+2]=y[x+2];s.areNormalsFrozen||s.updateVerticesData(_.NormalKind,y,!1,!1)}return s}else{var T=new S(n,e);T._originalBuilderSideOrientation=o,T._creationDataStorage=new Dt;var C=Ht(t);return a&&(T._creationDataStorage.idx=C._idx),T._creationDataStorage.closePath=a,T._creationDataStorage.closeArray=i,C.applyToMesh(T,u),T}}Q.CreateRibbon=Ht;S.CreateRibbon=function(n,t,e,r,i,a,o,s,u){return e===void 0&&(e=!1),o===void 0&&(o=!1),Ve(n,{pathArray:t,closeArray:e,closePath:r,offset:i,updatable:o,sideOrientation:s,instance:u},a)};function kt(n,t,e){e===void 0&&(e=null);var r=t.path,i=t.shape,a=t.scale||1,o=t.rotation||0,s=t.cap===0?0:t.cap||S.NO_CAP,u=t.updatable,f=S._GetDefaultSideOrientation(t.sideOrientation),l=t.instance||null,c=t.invertUV||!1,h=t.closeShape||!1,d=t.closePath||!1;return jt(n,i,r,a,o,null,null,d,h,s,!1,e,!!u,f,l,c,t.frontUVs||null,t.backUVs||null,t.firstNormal||null,!!t.adjustFrame)}function Xt(n,t,e){e===void 0&&(e=null);var r=t.path,i=t.shape,a=t.scaleFunction||function(){return 1},o=t.rotationFunction||function(){return 0},s=t.closePath||t.ribbonCloseArray||!1,u=t.closeShape||t.ribbonClosePath||!1,f=t.cap===0?0:t.cap||S.NO_CAP,l=t.updatable,c=t.firstNormal||null,h=t.adjustFrame||!1,d=S._GetDefaultSideOrientation(t.sideOrientation),v=t.instance,g=t.invertUV||!1;return jt(n,i,r,null,null,a,o,s,u,f,!0,e,!!l,d,v||null,g,t.frontUVs||null,t.backUVs||null,c,h)}function jt(n,t,e,r,i,a,o,s,u,f,l,c,h,d,v,g,p,m,M,A){var y=function(C,B,V,U,R,F,W,K,E,w,L){var P=V.getTangents(),Y=V.getNormals(),G=V.getBinormals(),H=V.getDistances();if(L){for(var Z=0;Z<P.length;Z++)if(P[Z].x==0&&P[Z].y==0&&P[Z].z==0&&P[Z].copyFrom(P[Z-1]),Y[Z].x==0&&Y[Z].y==0&&Y[Z].z==0&&Y[Z].copyFrom(Y[Z-1]),G[Z].x==0&&G[Z].y==0&&G[Z].z==0&&G[Z].copyFrom(G[Z-1]),Z>0){var q=P[Z-1];O.Dot(q,P[Z])<0&&P[Z].scaleInPlace(-1),q=Y[Z-1],O.Dot(q,Y[Z])<0&&Y[Z].scaleInPlace(-1),q=G[Z-1],O.Dot(q,G[Z])<0&&G[Z].scaleInPlace(-1)}}for(var N=0,k=function(){return R!==null?R:1},ie=function(){return F!==null?F:0},J=w&&K?K:ie,ee=w&&W?W:k,$=E===S.NO_CAP||E===S.CAP_END?0:2,ae=z.Matrix[0],Z=0;Z<B.length;Z++){var te=new Array,re=J(Z,H[Z]),fe=ee(Z,H[Z]);X.RotationAxisToRef(P[Z],N,ae);for(var he=0;he<C.length;he++){var Se=P[Z].scale(C[he].z).add(Y[Z].scale(C[he].x)).add(G[Z].scale(C[he].y)),Fe=O.Zero();O.TransformCoordinatesToRef(Se,ae,Fe),Fe.scaleInPlace(fe).addInPlace(B[Z]),te[he]=Fe}U[$]=te,N+=re,$++}var Be=function(Ce){var Ee=Array(),Le=O.Zero(),Ie;for(Ie=0;Ie<Ce.length;Ie++)Le.addInPlace(Ce[Ie]);for(Le.scaleInPlace(1/Ce.length),Ie=0;Ie<Ce.length;Ie++)Ee.push(Le);return Ee};switch(E){case S.NO_CAP:break;case S.CAP_START:U[0]=Be(U[2]),U[1]=U[2];break;case S.CAP_END:U[$]=U[$-1],U[$+1]=Be(U[$-1]);break;case S.CAP_ALL:U[0]=Be(U[2]),U[1]=U[2],U[$]=U[$-1],U[$+1]=Be(U[$-1]);break}return U},b,x;if(v){var I=v._creationDataStorage;return b=M?I.path3D.update(e,M):I.path3D.update(e),x=y(t,e,I.path3D,I.pathArray,r,i,a,o,I.cap,l,A),v=Ve("",{pathArray:x,closeArray:!1,closePath:!1,offset:0,updatable:!1,sideOrientation:0,instance:v},c||void 0),v}b=M?new He(e,M):new He(e);var D=new Array;f=f<0||f>3?0:f,x=y(t,e,b,D,r,i,a,o,f,l,A);var T=Ve(n,{pathArray:x,closeArray:s,closePath:u,updatable:h,sideOrientation:d,invertUV:g,frontUVs:p||void 0,backUVs:m||void 0},c);return T._creationDataStorage.pathArray=x,T._creationDataStorage.path3D=b,T._creationDataStorage.cap=f,T}S.ExtrudeShape=function(n,t,e,r,i,a,o,s,u,f){o===void 0&&(o=null);var l={shape:t,path:e,scale:r,rotation:i,cap:a===0?0:a||S.NO_CAP,sideOrientation:u,instance:f,updatable:s};return kt(n,l,o)};S.ExtrudeShapeCustom=function(n,t,e,r,i,a,o,s,u,f,l,c){var h={shape:t,path:e,scaleFunction:r,rotationFunction:i,ribbonCloseArray:a,ribbonClosePath:o,cap:s===0?0:s||S.NO_CAP,sideOrientation:l,instance:c,updatable:f};return Xt(n,h,u)};var hi=function(n){_e(t,n);function t(e){var r=n.call(this)||this;return r._buffer=e,r}return Object.defineProperty(t.prototype,"underlyingResource",{get:function(){return this._buffer},enumerable:!1,configurable:!0}),t}(gt);function qt(n){var t=[];t[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},t[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},t[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},t[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},t[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},t[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},t[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},t[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},t[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},t[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},t[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},t[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},t[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},t[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},t[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};var e=n.type&&(n.type<0||n.type>=t.length)?0:n.type||0,r=n.size,i=n.sizeX||r||1,a=n.sizeY||r||1,o=n.sizeZ||r||1,s=n.custom||t[e],u=s.face.length,f=n.faceUV||new Array(u),l=n.faceColors,c=n.flat===void 0?!0:n.flat,h=n.sideOrientation===0?0:n.sideOrientation||Q.DEFAULTSIDE,d=new Array,v=new Array,g=new Array,p=new Array,m=new Array,M=0,A=0,y=new Array,b=0,x=0,I,D,T,C,B,V;if(c)for(x=0;x<u;x++)l&&l[x]===void 0&&(l[x]=new De(1,1,1,1)),f&&f[x]===void 0&&(f[x]=new be(0,0,1,1));if(c)for(x=0;x<u;x++){var U=s.face[x].length;for(T=2*Math.PI/U,C=.5*Math.tan(T/2),B=.5,b=0;b<U;b++)d.push(s.vertex[s.face[x][b]][0]*i,s.vertex[s.face[x][b]][1]*a,s.vertex[s.face[x][b]][2]*o),y.push(M),M++,I=f[x].x+(f[x].z-f[x].x)*(.5+C),D=f[x].y+(f[x].w-f[x].y)*(B-.5),p.push(I,j.UseOpenGLOrientationForUV?1-D:D),V=C*Math.cos(T)-B*Math.sin(T),B=C*Math.sin(T)+B*Math.cos(T),C=V,l&&m.push(l[x].r,l[x].g,l[x].b,l[x].a);for(b=0;b<U-2;b++)v.push(y[0+A],y[b+2+A],y[b+1+A]);A+=U}else{for(b=0;b<s.vertex.length;b++)d.push(s.vertex[b][0]*i,s.vertex[b][1]*a,s.vertex[b][2]*o),p.push(0,j.UseOpenGLOrientationForUV?1:0);for(x=0;x<u;x++)for(b=0;b<s.face[x].length-2;b++)v.push(s.face[x][0],s.face[x][b+2],s.face[x][b+1])}Q.ComputeNormals(d,v,g),Q._ComputeSides(h,d,v,g,p,n.frontUVs,n.backUVs);var R=new Q;return R.positions=d,R.indices=v,R.normals=g,R.uvs=p,l&&c&&(R.colors=m),R}function rt(n,t,e){t===void 0&&(t={}),e===void 0&&(e=null);var r=new S(n,e);t.sideOrientation=S._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;var i=qt(t);return i.applyToMesh(r,t.updatable),r}Q.CreatePolyhedron=qt;S.CreatePolyhedron=function(n,t,e){return rt(n,t,e)};function Jt(n){var t=new Array,e=new Array,r=new Array,i=new Array,a=n.radius||.5,o=n.tessellation||64,s=n.arc&&(n.arc<=0||n.arc>1)?1:n.arc||1,u=n.sideOrientation===0?0:n.sideOrientation||Q.DEFAULTSIDE;t.push(0,0,0),i.push(.5,.5);for(var f=Math.PI*2*s,l=s===1?f/o:f/(o-1),c=0,h=0;h<o;h++){var d=Math.cos(c),v=Math.sin(c),g=(d+1)/2,p=(1-v)/2;t.push(a*d,a*v,0),i.push(g,j.UseOpenGLOrientationForUV?1-p:p),c+=l}s===1&&(t.push(t[3],t[4],t[5]),i.push(i[2],j.UseOpenGLOrientationForUV?1-i[3]:i[3]));for(var m=t.length/3,M=1;M<m-1;M++)e.push(M+1,0,M);Q.ComputeNormals(t,e,r),Q._ComputeSides(u,t,e,r,i,n.frontUVs,n.backUVs);var A=new Q;return A.indices=e,A.positions=t,A.normals=r,A.uvs=i,A}function it(n,t,e){t===void 0&&(t={}),e===void 0&&(e=null);var r=new S(n,e);t.sideOrientation=S._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;var i=Jt(t);return i.applyToMesh(r,t.updatable),r}Q.CreateDisc=Jt;S.CreateDisc=function(n,t,e,r,i,a){r===void 0&&(r=null);var o={radius:t,tessellation:e,sideOrientation:a,updatable:i};return it(n,o,r)};function Fr(n,t,e){t===void 0&&(t={}),t.diameter||(t.diameter=1),t.segments||(t.segments=16);var r=et("",{slice:.5,diameter:t.diameter,segments:t.segments},e),i=it("",{radius:t.diameter/2,tessellation:t.segments*3+(4-t.segments)},e);i.rotation.x=-Math.PI/2,i.parent=r;var a=S.MergeMeshes([i,r],!0);return a.name=n,a}S.CreateHemisphere=function(n,t,e,r){var i={segments:t,diameter:e};return Fr(n,i,r)};pe.prototype._projectOnTrianglesToRef=function(n,t,e,r,i,a){for(var o=z.Vector3[0],s=z.Vector3[1],u=1/0,f=this.indexStart;f<this.indexStart+this.indexCount-(3-r);f+=r){var l=e[f],c=e[f+1],h=e[f+2];if(i&&h===4294967295){f+=2;continue}var d=t[l],v=t[c],g=t[h];if(!(!d||!v||!g)){var p=O.ProjectOnTriangleToRef(n,d,v,g,s);p<u&&(o.copyFrom(s),u=p)}}return a.copyFrom(o),u};pe.prototype._projectOnUnIndexedTrianglesToRef=function(n,t,e,r){for(var i=z.Vector3[0],a=z.Vector3[1],o=1/0,s=this.verticesStart;s<this.verticesStart+this.verticesCount;s+=3){var u=t[s],f=t[s+1],l=t[s+2],c=O.ProjectOnTriangleToRef(n,u,f,l,a);c<o&&(i.copyFrom(a),o=c)}return r.copyFrom(i),o};pe.prototype.projectToRef=function(n,t,e,r){var i=this.getMaterial();if(!i)return-1;var a=3,o=!1;switch(i.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:a=1,o=!0;break}return i.fillMode===4?-1:!e.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(n,t,e,r):this._projectOnTrianglesToRef(n,t,e,a,o,r)};function Lr(n){return new Promise(function(t){DracoDecoderModule({wasmBinary:n}).then(function(e){t({module:e})})})}function qe(n,t,e,r,i,a){var o=new n.DecoderBuffer;o.Init(t,t.byteLength);var s=new n.Decoder,u,f;try{var l=s.GetEncodedGeometryType(o);switch(l){case n.TRIANGULAR_MESH:u=new n.Mesh,f=s.DecodeBufferToMesh(o,u);break;case n.POINT_CLOUD:u=new n.PointCloud,f=s.DecodeBufferToPointCloud(o,u);break;default:throw new Error("Invalid geometry type ".concat(l))}if(!f.ok()||!u.ptr)throw new Error(f.error_msg());if(l===n.TRIANGULAR_MESH){var c=u.num_faces(),h=c*3,d=h*4,v=n._malloc(d);try{s.GetTrianglesUInt32Array(u,d,v);var g=new Uint32Array(h);g.set(new Uint32Array(n.HEAPF32.buffer,v,h)),r(g)}finally{n._free(v)}}var p=function(x,I,D){D===void 0&&(D=1);var T=I.num_components(),C=u.num_points(),B=C*T,V=B*Float32Array.BYTES_PER_ELEMENT,U=n._malloc(V);try{s.GetAttributeDataArrayForAllPoints(u,I,n.DT_FLOAT32,V,U);var R=new Float32Array(n.HEAPF32.buffer,U,B);if(x==="color"&&T===3){for(var F=new Float32Array(C*4),W=0,K=0;W<F.length;W+=4,K+=T)F[W+0]=R[K+0],F[W+1]=R[K+1],F[W+2]=R[K+2],F[W+3]=1;i(x,F)}else{var F=new Float32Array(B);if(F.set(new Float32Array(n.HEAPF32.buffer,U,B)),D!==1)for(var W=0;W<F.length;W++)F[W]=F[W]/D;i(x,F)}}finally{n._free(U)}};if(e)for(var m in e){var M=e[m],A=s.GetAttributeByUniqueId(u,M),y=a&&a[m]||1;p(m,A,y)}else{var b={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"};for(var m in b){var M=s.GetAttributeId(u,n[b[m]]);if(M!==-1){var A=s.GetAttribute(u,M);p(m,A)}}}}finally{u&&n.destroy(u),n.destroy(s),n.destroy(o)}}function Er(){var n;onmessage=function(t){var e=t.data;switch(e.id){case"init":{var r=e.decoder;r.url&&(importScripts(r.url),n=DracoDecoderModule({wasmBinary:r.wasmBinary})),postMessage("done");break}case"decodeMesh":{if(!n)throw new Error("Draco decoder module is not available");n.then(function(i){qe(i,e.dataView,e.attributes,function(a){postMessage({id:"indices",value:a},[a.buffer])},function(a,o){postMessage({id:a,value:o},[o.buffer])}),postMessage("done")});break}}}}var li=function(){function n(t){t===void 0&&(t=n.DefaultNumWorkers);var e=n.Configuration.decoder,r=e.wasmUrl&&e.wasmBinaryUrl&&typeof WebAssembly=="object"?{url:ye.GetAbsoluteUrl(e.wasmUrl),wasmBinaryPromise:ye.LoadFileAsync(ye.GetAbsoluteUrl(e.wasmBinaryUrl))}:{url:ye.GetAbsoluteUrl(e.fallbackUrl),wasmBinaryPromise:Promise.resolve(void 0)};t&&typeof Worker=="function"&&typeof URL=="function"?this._workerPoolPromise=r.wasmBinaryPromise.then(function(i){var a="".concat(qe,"(").concat(Er,")()"),o=URL.createObjectURL(new Blob([a],{type:"application/javascript"}));return new br(t,function(){return new Promise(function(s,u){var f=new Worker(o),l=function(h){f.removeEventListener("error",l),f.removeEventListener("message",c),u(h)},c=function(h){h.data==="done"&&(f.removeEventListener("error",l),f.removeEventListener("message",c),s(f))};f.addEventListener("error",l),f.addEventListener("message",c),f.postMessage({id:"init",decoder:{url:r.url,wasmBinary:i}})})})}):this._decoderModulePromise=r.wasmBinaryPromise.then(function(i){if(!r.url)throw new Error("Draco decoder module is not available");return ye.LoadScriptAsync(r.url).then(function(){return Lr(i)})})}return Object.defineProperty(n,"DecoderAvailable",{get:function(){var t=n.Configuration.decoder;return!!(t.wasmUrl&&t.wasmBinaryUrl&&typeof WebAssembly=="object"||t.fallbackUrl)},enumerable:!1,configurable:!0}),n.GetDefaultNumWorkers=function(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)},Object.defineProperty(n,"Default",{get:function(){return n._Default||(n._Default=new n),n._Default},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){this._workerPoolPromise&&this._workerPoolPromise.then(function(t){t.dispose()}),delete this._workerPoolPromise,delete this._decoderModulePromise},n.prototype.whenReadyAsync=function(){return this._workerPoolPromise?this._workerPoolPromise.then(function(){}):this._decoderModulePromise?this._decoderModulePromise.then(function(){}):Promise.resolve()},n.prototype.decodeMeshAsync=function(t,e,r){var i=t instanceof ArrayBuffer?new Uint8Array(t):t;if(this._workerPoolPromise)return this._workerPoolPromise.then(function(a){return new Promise(function(o,s){a.push(function(u,f){var l=new Q,c=function(v){u.removeEventListener("error",c),u.removeEventListener("message",h),s(v),f()},h=function(v){if(v.data==="done")u.removeEventListener("error",c),u.removeEventListener("message",h),o(l),f();else if(v.data.id==="indices")l.indices=v.data.value;else{var g=r&&r[v.data.id]?r[v.data.id]:1;if(g!==1)for(var p=0;p<v.data.value.length;p++)v.data.value[p]=v.data.value[p]/g;l.set(v.data.value,v.data.id)}};u.addEventListener("error",c),u.addEventListener("message",h);var d=new Uint8Array(i.byteLength);d.set(new Uint8Array(i.buffer,i.byteOffset,i.byteLength)),u.postMessage({id:"decodeMesh",dataView:d,attributes:e},[d.buffer])})})});if(this._decoderModulePromise)return this._decoderModulePromise.then(function(a){var o=new Q;return qe(a.module,i,e,function(s){o.indices=s},function(s,u){o.set(u,s)},r),o});throw new Error("Draco decoder module is not available")},n.Configuration={decoder:{wasmUrl:"https://preview.babylonjs.com/draco_wasm_wrapper_gltf.js",wasmBinaryUrl:"https://preview.babylonjs.com/draco_decoder_gltf.wasm",fallbackUrl:"https://preview.babylonjs.com/draco_decoder_gltf.js"}},n.DefaultNumWorkers=n.GetDefaultNumWorkers(),n._Default=null,n}(),ci=function(){function n(){var t=n.Configuration.decoder;this._decoderModulePromise=ye.LoadScriptAsync(ye.GetAbsoluteUrl(t.url)).then(function(){return MeshoptDecoder.ready})}return Object.defineProperty(n,"Default",{get:function(){return n._Default||(n._Default=new n),n._Default},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){delete this._decoderModulePromise},n.prototype.decodeGltfBufferAsync=function(t,e,r,i,a){return this._decoderModulePromise.then(function(){var o=new Uint8Array(e*r);return MeshoptDecoder.decodeGltfBuffer(o,e,r,t,i,a),o})},n.Configuration={decoder:{url:"https://preview.babylonjs.com/meshopt_decoder.js"}},n._Default=null,n}();S._GoldbergMeshParser=function(n,t){return $t.Parse(n,t)};var $t=function(n){_e(t,n);function t(){var e=n!==null&&n.apply(this,arguments)||this;return e.goldbergData={faceColors:[],faceCenters:[],faceZaxis:[],faceXaxis:[],faceYaxis:[],nbSharedFaces:0,nbUnsharedFaces:0,nbFaces:0,nbFacesAtPole:0,adjacentFaces:[]},e}return t.prototype.relatedGoldbergFace=function(e,r){return r===void 0?(e>this.goldbergData.nbUnsharedFaces-1&&(ue.Warn("Maximum number of unshared faces used"),e=this.goldbergData.nbUnsharedFaces-1),this.goldbergData.nbUnsharedFaces+e):(e>11&&(ue.Warn("Last pole used"),e=11),r>this.goldbergData.nbFacesAtPole-1&&(ue.Warn("Maximum number of faces at a pole used"),r=this.goldbergData.nbFacesAtPole-1),12+e*this.goldbergData.nbFacesAtPole+r)},t.prototype._changeGoldbergFaceColors=function(e){for(var r=0;r<e.length;r++)for(var i=e[r][0],a=e[r][1],o=e[r][2],s=i;s<a+1;s++)this.goldbergData.faceColors[s]=o;for(var u=[],s=0;s<12;s++)for(var r=0;r<5;r++)u.push(this.goldbergData.faceColors[s].r,this.goldbergData.faceColors[s].g,this.goldbergData.faceColors[s].b,this.goldbergData.faceColors[s].a);for(var s=12;s<this.goldbergData.faceColors.length;s++)for(var r=0;r<6;r++)u.push(this.goldbergData.faceColors[s].r,this.goldbergData.faceColors[s].g,this.goldbergData.faceColors[s].b,this.goldbergData.faceColors[s].a);return u},t.prototype.setGoldbergFaceColors=function(e){var r=this._changeGoldbergFaceColors(e);this.setVerticesData(_.ColorKind,r)},t.prototype.updateGoldbergFaceColors=function(e){var r=this._changeGoldbergFaceColors(e);this.updateVerticesData(_.ColorKind,r)},t.prototype._changeGoldbergFaceUVs=function(e){for(var r=this.getVerticesData(_.UVKind),i=0;i<e.length;i++){for(var a=e[i][0],o=e[i][1],s=e[i][2],u=e[i][3],f=e[i][4],l=[],c=[],h=void 0,d=void 0,v=0;v<5;v++)h=s.x+u*Math.cos(f+v*Math.PI/2.5),d=s.y+u*Math.sin(f+v*Math.PI/2.5),h<0&&(h=0),h>1&&(h=1),l.push(h,d);for(var v=0;v<6;v++)h=s.x+u*Math.cos(f+v*Math.PI/3),d=s.y+u*Math.sin(f+v*Math.PI/3),h<0&&(h=0),h>1&&(h=1),c.push(h,d);for(var g=a;g<Math.min(12,o+1);g++)for(var v=0;v<5;v++)r[10*g+2*v]=l[2*v],r[10*g+2*v+1]=l[2*v+1];for(var g=Math.max(12,a);g<o+1;g++)for(var v=0;v<6;v++)r[12*g-24+2*v]=c[2*v],r[12*g-23+2*v]=c[2*v+1]}return r},t.prototype.setGoldbergFaceUVs=function(e){var r=this._changeGoldbergFaceUVs(e);this.setVerticesData(_.UVKind,r)},t.prototype.updateGoldbergFaceUVs=function(e){var r=this._changeGoldbergFaceUVs(e);this.updateVerticesData(_.UVKind,r)},t.prototype.placeOnGoldbergFaceAt=function(e,r,i){var a=O.RotationFromAxis(this.goldbergData.faceXaxis[r],this.goldbergData.faceYaxis[r],this.goldbergData.faceZaxis[r]);e.rotation=a,e.position=this.goldbergData.faceCenters[r].add(this.goldbergData.faceXaxis[r].scale(i.x)).add(this.goldbergData.faceYaxis[r].scale(i.y)).add(this.goldbergData.faceZaxis[r].scale(i.z))},t.prototype.serialize=function(e){n.prototype.serialize.call(this,e),e.type="GoldbergMesh";var r={};if(r.adjacentFaces=this.goldbergData.adjacentFaces,r.nbSharedFaces=this.goldbergData.nbSharedFaces,r.nbUnsharedFaces=this.goldbergData.nbUnsharedFaces,r.nbFaces=this.goldbergData.nbFaces,r.nbFacesAtPole=this.goldbergData.nbFacesAtPole,this.goldbergData.faceColors){r.faceColors=[];for(var i=0,a=this.goldbergData.faceColors;i<a.length;i++){var o=a[i];r.faceColors.push(o.asArray())}}if(this.goldbergData.faceCenters){r.faceCenters=[];for(var s=0,u=this.goldbergData.faceCenters;s<u.length;s++){var f=u[s];r.faceCenters.push(f.asArray())}}if(this.goldbergData.faceZaxis){r.faceZaxis=[];for(var l=0,c=this.goldbergData.faceZaxis;l<c.length;l++){var f=c[l];r.faceZaxis.push(f.asArray())}}if(this.goldbergData.faceYaxis){r.faceYaxis=[];for(var h=0,d=this.goldbergData.faceYaxis;h<d.length;h++){var f=d[h];r.faceYaxis.push(f.asArray())}}if(this.goldbergData.faceXaxis){r.faceXaxis=[];for(var v=0,g=this.goldbergData.faceXaxis;v<g.length;v++){var f=g[v];r.faceXaxis.push(f.asArray())}}e.goldbergData=r},t.Parse=function(e,r){var i=e.goldbergData;i.faceColors=i.faceColors.map(function(o){return De.FromArray(o)}),i.faceCenters=i.faceCenters.map(function(o){return O.FromArray(o)}),i.faceZaxis=i.faceZaxis.map(function(o){return O.FromArray(o)}),i.faceXaxis=i.faceXaxis.map(function(o){return O.FromArray(o)}),i.faceYaxis=i.faceYaxis.map(function(o){return O.FromArray(o)});var a=new t(e.name,r);return a.goldbergData=i,a},t}(S);(function(n){_e(t,n);function t(e,r,i,a,o,s){a===void 0&&(a=1),o===void 0&&(o=60),s===void 0&&(s=!0);var u=n.call(this,e,i)||this;u._sectionPolygonPointsCount=4,u._running=!1,u._autoStart=s,u._generator=r,u._diameter=a,u._length=o,u._sectionVectors=[],u._sectionNormalVectors=[];for(var f=0;f<u._sectionPolygonPointsCount;f++)u._sectionVectors[f]=O.Zero(),u._sectionNormalVectors[f]=O.Zero();return u._createMesh(),u}return t.prototype.getClassName=function(){return"TrailMesh"},t.prototype._createMesh=function(){var e=new Q,r=[],i=[],a=[],o=O.Zero();this._generator instanceof Ze&&this._generator.hasBoundingInfo?o=this._generator.getBoundingInfo().boundingBox.centerWorld:o=this._generator.position;for(var s=2*Math.PI/this._sectionPolygonPointsCount,u=0;u<this._sectionPolygonPointsCount;u++)r.push(o.x+Math.cos(u*s)*this._diameter,o.y+Math.sin(u*s)*this._diameter,o.z);for(var u=1;u<=this._length;u++){for(var f=0;f<this._sectionPolygonPointsCount;f++)r.push(o.x+Math.cos(f*s)*this._diameter,o.y+Math.sin(f*s)*this._diameter,o.z);for(var l=r.length/3-2*this._sectionPolygonPointsCount,f=0;f<this._sectionPolygonPointsCount-1;f++)a.push(l+f,l+f+this._sectionPolygonPointsCount,l+f+this._sectionPolygonPointsCount+1),a.push(l+f,l+f+this._sectionPolygonPointsCount+1,l+f+1);a.push(l+this._sectionPolygonPointsCount-1,l+this._sectionPolygonPointsCount-1+this._sectionPolygonPointsCount,l+this._sectionPolygonPointsCount),a.push(l+this._sectionPolygonPointsCount-1,l+this._sectionPolygonPointsCount,l)}Q.ComputeNormals(r,a,i),e.positions=r,e.normals=i,e.indices=a,e.applyToMesh(this,!0),this._autoStart&&this.start()},t.prototype.start=function(){var e=this;this._running||(this._running=!0,this._beforeRenderObserver=this.getScene().onBeforeRenderObservable.add(function(){e.update()}))},t.prototype.stop=function(){this._beforeRenderObserver&&this._running&&(this._running=!1,this.getScene().onBeforeRenderObservable.remove(this._beforeRenderObserver))},t.prototype.update=function(){var e=this.getVerticesData(_.PositionKind),r=this.getVerticesData(_.NormalKind),i=this._generator.getWorldMatrix();if(e&&r){for(var a=3*this._sectionPolygonPointsCount;a<e.length;a++)e[a-3*this._sectionPolygonPointsCount]=e[a]-r[a]/this._length*this._diameter;for(var a=3*this._sectionPolygonPointsCount;a<r.length;a++)r[a-3*this._sectionPolygonPointsCount]=r[a];for(var o=e.length-3*this._sectionPolygonPointsCount,s=2*Math.PI/this._sectionPolygonPointsCount,a=0;a<this._sectionPolygonPointsCount;a++)this._sectionVectors[a].copyFromFloats(Math.cos(a*s)*this._diameter,Math.sin(a*s)*this._diameter,0),this._sectionNormalVectors[a].copyFromFloats(Math.cos(a*s),Math.sin(a*s),0),O.TransformCoordinatesToRef(this._sectionVectors[a],i,this._sectionVectors[a]),O.TransformNormalToRef(this._sectionNormalVectors[a],i,this._sectionNormalVectors[a]);for(var a=0;a<this._sectionPolygonPointsCount;a++)e[o+3*a]=this._sectionVectors[a].x,e[o+3*a+1]=this._sectionVectors[a].y,e[o+3*a+2]=this._sectionVectors[a].z,r[o+3*a]=this._sectionNormalVectors[a].x,r[o+3*a+1]=this._sectionNormalVectors[a].y,r[o+3*a+2]=this._sectionNormalVectors[a].z;this.updateVerticesData(_.PositionKind,e,!0,!1),this.updateVerticesData(_.NormalKind,r,!0,!1)}},t.prototype.clone=function(e,r){return e===void 0&&(e=""),new t(e,r===void 0?this._generator:r,this.getScene(),this._diameter,this._length,this._autoStart)},t.prototype.serialize=function(e){n.prototype.serialize.call(this,e)},t.Parse=function(e,r){return new t(e.name,e._generator,r,e._diameter,e._length,e._autoStart)},t})(S);function Ne(n){var t=n.pattern||S.NO_FLIP,e=n.tileWidth||n.tileSize||1,r=n.tileHeight||n.tileSize||1,i=n.alignHorizontal||0,a=n.alignVertical||0,o=n.width||n.size||1,s=Math.floor(o/e),u=o-s*e,f=n.height||n.size||1,l=Math.floor(f/r),c=f-l*r,h=e*s/2,d=r*l/2,v=0,g=0,p=0,m=0,M=0,A=0;if(u>0||c>0){switch(p=-h,m=-d,M=h,A=d,i){case S.CENTER:u/=2,p-=u,M+=u;break;case S.LEFT:M+=u,v=-u/2;break;case S.RIGHT:p-=u,v=u/2;break}switch(a){case S.CENTER:c/=2,m-=c,A+=c;break;case S.BOTTOM:A+=c,g=-c/2;break;case S.TOP:m-=c,g=c/2;break}}var y=[],b=[],x=[];x[0]=[0,0,1,0,1,1,0,1],x[1]=[0,0,1,0,1,1,0,1],(t===S.ROTATE_TILE||t===S.ROTATE_ROW)&&(x[1]=[1,1,0,1,0,0,1,0]),(t===S.FLIP_TILE||t===S.FLIP_ROW)&&(x[1]=[1,0,0,0,0,1,1,1]),(t===S.FLIP_N_ROTATE_TILE||t===S.FLIP_N_ROTATE_ROW)&&(x[1]=[0,1,1,1,1,0,0,0]);for(var I=[],D=[],T=[],C=0,B=0;B<l;B++)for(var V=0;V<s;V++)y.push(-h+V*e+v,-d+B*r+g,0),y.push(-h+(V+1)*e+v,-d+B*r+g,0),y.push(-h+(V+1)*e+v,-d+(B+1)*r+g,0),y.push(-h+V*e+v,-d+(B+1)*r+g,0),T.push(C,C+1,C+3,C+1,C+2,C+3),t===S.FLIP_TILE||t===S.ROTATE_TILE||t===S.FLIP_N_ROTATE_TILE?I=I.concat(x[(V%2+B%2)%2]):t===S.FLIP_ROW||t===S.ROTATE_ROW||t===S.FLIP_N_ROTATE_ROW?I=I.concat(x[B%2]):I=I.concat(x[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1),C+=4;if(u>0||c>0){var U=c>0&&(a===S.CENTER||a===S.TOP),R=c>0&&(a===S.CENTER||a===S.BOTTOM),F=u>0&&(i===S.CENTER||i===S.RIGHT),W=u>0&&(i===S.CENTER||i===S.LEFT),K=[],E=void 0,w=void 0,L=void 0,P=void 0;if(U&&F&&(y.push(p+v,m+g,0),y.push(-h+v,m+g,0),y.push(-h+v,m+c+g,0),y.push(p+v,m+c+g,0),T.push(C,C+1,C+3,C+1,C+2,C+3),C+=4,E=1-u/e,w=1-c/r,L=1,P=1,K=[E,w,L,w,L,P,E,P],t===S.ROTATE_ROW&&(K=[1-E,1-w,1-L,1-w,1-L,1-P,1-E,1-P]),t===S.FLIP_ROW&&(K=[1-E,w,1-L,w,1-L,P,1-E,P]),t===S.FLIP_N_ROTATE_ROW&&(K=[E,1-w,L,1-w,L,1-P,E,1-P]),I=I.concat(K),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),U&&W&&(y.push(h+v,m+g,0),y.push(M+v,m+g,0),y.push(M+v,m+c+g,0),y.push(h+v,m+c+g,0),T.push(C,C+1,C+3,C+1,C+2,C+3),C+=4,E=0,w=1-c/r,L=u/e,P=1,K=[E,w,L,w,L,P,E,P],(t===S.ROTATE_ROW||t===S.ROTATE_TILE&&s%2===0)&&(K=[1-E,1-w,1-L,1-w,1-L,1-P,1-E,1-P]),(t===S.FLIP_ROW||t===S.FLIP_TILE&&s%2===0)&&(K=[1-E,w,1-L,w,1-L,P,1-E,P]),(t===S.FLIP_N_ROTATE_ROW||t===S.FLIP_N_ROTATE_TILE&&s%2===0)&&(K=[E,1-w,L,1-w,L,1-P,E,1-P]),I=I.concat(K),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),R&&F&&(y.push(p+v,d+g,0),y.push(-h+v,d+g,0),y.push(-h+v,A+g,0),y.push(p+v,A+g,0),T.push(C,C+1,C+3,C+1,C+2,C+3),C+=4,E=1-u/e,w=0,L=1,P=c/r,K=[E,w,L,w,L,P,E,P],(t===S.ROTATE_ROW&&l%2===1||t===S.ROTATE_TILE&&l%1===0)&&(K=[1-E,1-w,1-L,1-w,1-L,1-P,1-E,1-P]),(t===S.FLIP_ROW&&l%2===1||t===S.FLIP_TILE&&l%2===0)&&(K=[1-E,w,1-L,w,1-L,P,1-E,P]),(t===S.FLIP_N_ROTATE_ROW&&l%2===1||t===S.FLIP_N_ROTATE_TILE&&l%2===0)&&(K=[E,1-w,L,1-w,L,1-P,E,1-P]),I=I.concat(K),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),R&&W&&(y.push(h+v,d+g,0),y.push(M+v,d+g,0),y.push(M+v,A+g,0),y.push(h+v,A+g,0),T.push(C,C+1,C+3,C+1,C+2,C+3),C+=4,E=0,w=0,L=u/e,P=c/r,K=[E,w,L,w,L,P,E,P],(t===S.ROTATE_ROW&&l%2===1||t===S.ROTATE_TILE&&(l+s)%2===1)&&(K=[1-E,1-w,1-L,1-w,1-L,1-P,1-E,1-P]),(t===S.FLIP_ROW&&l%2===1||t===S.FLIP_TILE&&(l+s)%2===1)&&(K=[1-E,w,1-L,w,1-L,P,1-E,P]),(t===S.FLIP_N_ROTATE_ROW&&l%2===1||t===S.FLIP_N_ROTATE_TILE&&(l+s)%2===1)&&(K=[E,1-w,L,1-w,L,1-P,E,1-P]),I=I.concat(K),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),U){var Y=[];E=0,w=1-c/r,L=1,P=1,Y[0]=[E,w,L,w,L,P,E,P],Y[1]=[E,w,L,w,L,P,E,P],(t===S.ROTATE_TILE||t===S.ROTATE_ROW)&&(Y[1]=[1-E,1-w,1-L,1-w,1-L,1-P,1-E,1-P]),(t===S.FLIP_TILE||t===S.FLIP_ROW)&&(Y[1]=[1-E,w,1-L,w,1-L,P,1-E,P]),(t===S.FLIP_N_ROTATE_TILE||t===S.FLIP_N_ROTATE_ROW)&&(Y[1]=[E,1-w,L,1-w,L,1-P,E,1-P]);for(var V=0;V<s;V++)y.push(-h+V*e+v,m+g,0),y.push(-h+(V+1)*e+v,m+g,0),y.push(-h+(V+1)*e+v,m+c+g,0),y.push(-h+V*e+v,m+c+g,0),T.push(C,C+1,C+3,C+1,C+2,C+3),C+=4,t===S.FLIP_TILE||t===S.ROTATE_TILE||t===S.FLIP_N_ROTATE_TILE?I=I.concat(Y[(V+1)%2]):t===S.FLIP_ROW||t===S.ROTATE_ROW||t===S.FLIP_N_ROTATE_ROW?I=I.concat(Y[1]):I=I.concat(Y[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(R){var G=[];E=0,w=0,L=1,P=c/r,G[0]=[E,w,L,w,L,P,E,P],G[1]=[E,w,L,w,L,P,E,P],(t===S.ROTATE_TILE||t===S.ROTATE_ROW)&&(G[1]=[1-E,1-w,1-L,1-w,1-L,1-P,1-E,1-P]),(t===S.FLIP_TILE||t===S.FLIP_ROW)&&(G[1]=[1-E,w,1-L,w,1-L,P,1-E,P]),(t===S.FLIP_N_ROTATE_TILE||t===S.FLIP_N_ROTATE_ROW)&&(G[1]=[E,1-w,L,1-w,L,1-P,E,1-P]);for(var V=0;V<s;V++)y.push(-h+V*e+v,A-c+g,0),y.push(-h+(V+1)*e+v,A-c+g,0),y.push(-h+(V+1)*e+v,A+g,0),y.push(-h+V*e+v,A+g,0),T.push(C,C+1,C+3,C+1,C+2,C+3),C+=4,t===S.FLIP_TILE||t===S.ROTATE_TILE||t===S.FLIP_N_ROTATE_TILE?I=I.concat(G[(V+l)%2]):t===S.FLIP_ROW||t===S.ROTATE_ROW||t===S.FLIP_N_ROTATE_ROW?I=I.concat(G[l%2]):I=I.concat(G[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(F){var H=[];E=1-u/e,w=0,L=1,P=1,H[0]=[E,w,L,w,L,P,E,P],H[1]=[E,w,L,w,L,P,E,P],(t===S.ROTATE_TILE||t===S.ROTATE_ROW)&&(H[1]=[1-E,1-w,1-L,1-w,1-L,1-P,1-E,1-P]),(t===S.FLIP_TILE||t===S.FLIP_ROW)&&(H[1]=[1-E,w,1-L,w,1-L,P,1-E,P]),(t===S.FLIP_N_ROTATE_TILE||t===S.FLIP_N_ROTATE_ROW)&&(H[1]=[E,1-w,L,1-w,L,1-P,E,1-P]);for(var B=0;B<l;B++)y.push(p+v,-d+B*r+g,0),y.push(p+u+v,-d+B*r+g,0),y.push(p+u+v,-d+(B+1)*r+g,0),y.push(p+v,-d+(B+1)*r+g,0),T.push(C,C+1,C+3,C+1,C+2,C+3),C+=4,t===S.FLIP_TILE||t===S.ROTATE_TILE||t===S.FLIP_N_ROTATE_TILE?I=I.concat(H[(B+1)%2]):t===S.FLIP_ROW||t===S.ROTATE_ROW||t===S.FLIP_N_ROTATE_ROW?I=I.concat(H[B%2]):I=I.concat(H[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(W){var Z=[];E=0,w=0,L=u/r,P=1,Z[0]=[E,w,L,w,L,P,E,P],Z[1]=[E,w,L,w,L,P,E,P],(t===S.ROTATE_TILE||t===S.ROTATE_ROW)&&(Z[1]=[1-E,1-w,1-L,1-w,1-L,1-P,1-E,1-P]),(t===S.FLIP_TILE||t===S.FLIP_ROW)&&(Z[1]=[1-E,w,1-L,w,1-L,P,1-E,P]),(t===S.FLIP_N_ROTATE_TILE||t===S.FLIP_N_ROTATE_ROW)&&(Z[1]=[E,1-w,L,1-w,L,1-P,E,1-P]);for(var B=0;B<l;B++)y.push(M-u+v,-d+B*r+g,0),y.push(M+v,-d+B*r+g,0),y.push(M+v,-d+(B+1)*r+g,0),y.push(M-u+v,-d+(B+1)*r+g,0),T.push(C,C+1,C+3,C+1,C+2,C+3),C+=4,t===S.FLIP_TILE||t===S.ROTATE_TILE||t===S.FLIP_N_ROTATE_TILE?I=I.concat(Z[(B+s)%2]):t===S.FLIP_ROW||t===S.ROTATE_ROW||t===S.FLIP_N_ROTATE_ROW?I=I.concat(Z[B%2]):I=I.concat(Z[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}}var q=n.sideOrientation===0?0:n.sideOrientation||Q.DEFAULTSIDE;Q._ComputeSides(q,y,T,b,I,n.frontUVs,n.backUVs);var N=new Q;N.indices=T,N.positions=y,N.normals=b,N.uvs=I;var k=q===Q.DOUBLESIDE?D.concat(D):D;return N.colors=k,N}function Rr(n,t,e){e===void 0&&(e=null);var r=new S(n,e);t.sideOrientation=S._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;var i=Ne(t);return i.applyToMesh(r,t.updatable),r}Q.CreateTiledPlane=Ne;function er(n){for(var t=6,e=n.faceUV||new Array(6),r=n.faceColors,i=n.pattern||S.NO_FLIP,a=n.width||n.size||1,o=n.height||n.size||1,s=n.depth||n.size||1,u=n.tileWidth||n.tileSize||1,f=n.tileHeight||n.tileSize||1,l=n.alignHorizontal||0,c=n.alignVertical||0,h=n.sideOrientation===0?0:n.sideOrientation||Q.DEFAULTSIDE,d=0;d<t;d++)e[d]===void 0&&(e[d]=new be(0,0,1,1)),r&&r[d]===void 0&&(r[d]=new De(1,1,1,1));for(var v=a/2,g=o/2,p=s/2,m=[],d=0;d<2;d++)m[d]=Ne({pattern:i,tileWidth:u,tileHeight:f,width:a,height:o,alignVertical:c,alignHorizontal:l,sideOrientation:h});for(var d=2;d<4;d++)m[d]=Ne({pattern:i,tileWidth:u,tileHeight:f,width:s,height:o,alignVertical:c,alignHorizontal:l,sideOrientation:h});var M=c;c===S.BOTTOM?M=S.TOP:c===S.TOP&&(M=S.BOTTOM);for(var d=4;d<6;d++)m[d]=Ne({pattern:i,tileWidth:u,tileHeight:f,width:a,height:s,alignVertical:M,alignHorizontal:l,sideOrientation:h});for(var A=[],y=[],b=[],x=[],I=[],D=[],T=[],C=[],B=0,V=0,d=0;d<t;d++){var U=m[d].positions.length;D[d]=[],T[d]=[];for(var R=0;R<U/3;R++)D[d].push(new O(m[d].positions[3*R],m[d].positions[3*R+1],m[d].positions[3*R+2])),T[d].push(new O(m[d].normals[3*R],m[d].normals[3*R+1],m[d].normals[3*R+2]));B=m[d].uvs.length,C[d]=[];for(var F=0;F<B;F+=2)C[d][F]=e[d].x+(e[d].z-e[d].x)*m[d].uvs[F],C[d][F+1]=e[d].y+(e[d].w-e[d].y)*m[d].uvs[F+1],j.UseOpenGLOrientationForUV&&(C[d][F+1]=1-C[d][F+1]);if(b=b.concat(C[d]),x=x.concat(m[d].indices.map(function(k){return k+V})),V+=D[d].length,r)for(var W=0;W<4;W++)I.push(r[d].r,r[d].g,r[d].b,r[d].a)}var K=new O(0,0,p),E=X.RotationY(Math.PI);A=D[0].map(function(N){return O.TransformNormal(N,E).add(K)}).map(function(N){return[N.x,N.y,N.z]}).reduce(function(N,k){return N.concat(k)},[]),y=T[0].map(function(N){return O.TransformNormal(N,E)}).map(function(N){return[N.x,N.y,N.z]}).reduce(function(N,k){return N.concat(k)},[]),A=A.concat(D[1].map(function(N){return N.subtract(K)}).map(function(N){return[N.x,N.y,N.z]}).reduce(function(N,k){return N.concat(k)},[])),y=y.concat(T[1].map(function(N){return[N.x,N.y,N.z]}).reduce(function(N,k){return N.concat(k)},[]));var w=new O(v,0,0),L=X.RotationY(-Math.PI/2);A=A.concat(D[2].map(function(N){return O.TransformNormal(N,L).add(w)}).map(function(N){return[N.x,N.y,N.z]}).reduce(function(N,k){return N.concat(k)},[])),y=y.concat(T[2].map(function(N){return O.TransformNormal(N,L)}).map(function(N){return[N.x,N.y,N.z]}).reduce(function(N,k){return N.concat(k)},[]));var P=X.RotationY(Math.PI/2);A=A.concat(D[3].map(function(N){return O.TransformNormal(N,P).subtract(w)}).map(function(N){return[N.x,N.y,N.z]}).reduce(function(N,k){return N.concat(k)},[])),y=y.concat(T[3].map(function(N){return O.TransformNormal(N,P)}).map(function(N){return[N.x,N.y,N.z]}).reduce(function(N,k){return N.concat(k)},[]));var Y=new O(0,g,0),G=X.RotationX(Math.PI/2);A=A.concat(D[4].map(function(N){return O.TransformNormal(N,G).add(Y)}).map(function(N){return[N.x,N.y,N.z]}).reduce(function(N,k){return N.concat(k)},[])),y=y.concat(T[4].map(function(N){return O.TransformNormal(N,G)}).map(function(N){return[N.x,N.y,N.z]}).reduce(function(N,k){return N.concat(k)},[]));var H=X.RotationX(-Math.PI/2);A=A.concat(D[5].map(function(N){return O.TransformNormal(N,H).subtract(Y)}).map(function(N){return[N.x,N.y,N.z]}).reduce(function(N,k){return N.concat(k)},[])),y=y.concat(T[5].map(function(N){return O.TransformNormal(N,H)}).map(function(N){return[N.x,N.y,N.z]}).reduce(function(N,k){return N.concat(k)},[])),Q._ComputeSides(h,A,x,y,b);var Z=new Q;if(Z.indices=x,Z.positions=A,Z.normals=y,Z.uvs=b,r){var q=h===Q.DOUBLESIDE?I.concat(I):I;Z.colors=q}return Z}function Ur(n,t,e){e===void 0&&(e=null);var r=new S(n,e);t.sideOrientation=S._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;var i=er(t);return i.applyToMesh(r,t.updatable),r}Q.CreateTiledBox=er;function tr(n){var t=new Array,e=new Array,r=new Array,i=new Array,a=n.radius||2,o=n.tube||.5,s=n.radialSegments||32,u=n.tubularSegments||32,f=n.p||2,l=n.q||3,c=n.sideOrientation===0?0:n.sideOrientation||Q.DEFAULTSIDE,h=function(W){var K=Math.cos(W),E=Math.sin(W),w=l/f*W,L=Math.cos(w),P=a*(2+L)*.5*K,Y=a*(2+L)*E*.5,G=a*Math.sin(w)*.5;return new O(P,Y,G)},d,v;for(d=0;d<=s;d++){var g=d%s,p=g/s*2*f*Math.PI,m=h(p),M=h(p+.01),A=M.subtract(m),y=M.add(m),b=O.Cross(A,y);for(y=O.Cross(b,A),b.normalize(),y.normalize(),v=0;v<u;v++){var x=v%u,I=x/u*2*Math.PI,D=-o*Math.cos(I),T=o*Math.sin(I);e.push(m.x+D*y.x+T*b.x),e.push(m.y+D*y.y+T*b.y),e.push(m.z+D*y.z+T*b.z),i.push(d/s),i.push(j.UseOpenGLOrientationForUV?1-v/u:v/u)}}for(d=0;d<s;d++)for(v=0;v<u;v++){var C=(v+1)%u,B=d*u+v,V=(d+1)*u+v,U=(d+1)*u+C,R=d*u+C;t.push(R),t.push(V),t.push(B),t.push(R),t.push(U),t.push(V)}Q.ComputeNormals(e,t,r),Q._ComputeSides(c,e,t,r,i,n.frontUVs,n.backUVs);var F=new Q;return F.indices=t,F.positions=e,F.normals=r,F.uvs=i,F}function rr(n,t,e){t===void 0&&(t={});var r=new S(n,e);t.sideOrientation=S._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;var i=tr(t);return i.applyToMesh(r,t.updatable),r}Q.CreateTorusKnot=tr;S.CreateTorusKnot=function(n,t,e,r,i,a,o,s,u,f){var l={radius:t,tube:e,radialSegments:r,tubularSegments:i,p:a,q:o,sideOrientation:f,updatable:u};return rr(n,l,s)};var Nr=function(n){_e(t,n);function t(e,r){var i=n.call(this,e.x,e.y)||this;return i.index=r,i}return t}(le),Ye=function(){function n(){this.elements=new Array}return n.prototype.add=function(t){var e=this,r=new Array;return t.forEach(function(i){var a=new Nr(i,e.elements.length);r.push(a),e.elements.push(a)}),r},n.prototype.computeBounds=function(){var t=new le(this.elements[0].x,this.elements[0].y),e=new le(this.elements[0].x,this.elements[0].y);return this.elements.forEach(function(r){r.x<t.x?t.x=r.x:r.x>e.x&&(e.x=r.x),r.y<t.y?t.y=r.y:r.y>e.y&&(e.y=r.y)}),{min:t,max:e,width:e.x-t.x,height:e.y-t.y}},n}(),zr=function(){function n(t,e,r,i){i===void 0&&(i=earcut),this._points=new Ye,this._outlinepoints=new Ye,this._holes=new Array,this._epoints=new Array,this._eholes=new Array,this.bjsEarcut=i,this._name=t,this._scene=r||Qe.LastCreatedScene;var a;e instanceof dr?a=e.getPoints():a=e,this._addToepoint(a),this._points.add(a),this._outlinepoints.add(a),typeof this.bjsEarcut=="undefined"&&ue.Warn("Earcut was not found, the polygon will not be built.")}return n.prototype._addToepoint=function(t){for(var e=0,r=t;e<r.length;e++){var i=r[e];this._epoints.push(i.x,i.y)}},n.prototype.addHole=function(t){this._points.add(t);var e=new Ye;return e.add(t),this._holes.push(e),this._eholes.push(this._epoints.length/2),this._addToepoint(t),this},n.prototype.build=function(t,e,r){t===void 0&&(t=!1),e===void 0&&(e=0),r===void 0&&(r=2);var i=new S(this._name,this._scene),a=this.buildVertexData(e,r);return i.setVerticesData(_.PositionKind,a.positions,t),i.setVerticesData(_.NormalKind,a.normals,t),i.setVerticesData(_.UVKind,a.uvs,t),i.setIndices(a.indices),i},n.prototype.buildVertexData=function(t,e){var r=this;t===void 0&&(t=0),e===void 0&&(e=2);var i=new Q,a=new Array,o=new Array,s=new Array,u=this._points.computeBounds();this._points.elements.forEach(function(m){a.push(0,1,0),o.push(m.x,0,m.y),s.push((m.x-u.min.x)/u.width,(m.y-u.min.y)/u.height)});for(var f=new Array,l=this.bjsEarcut(this._epoints,this._eholes,2),c=0;c<l.length;c++)f.push(l[c]);if(t>0){var h=o.length/3;this._points.elements.forEach(function(m){a.push(0,-1,0),o.push(m.x,-t,m.y),s.push(1-(m.x-u.min.x)/u.width,1-(m.y-u.min.y)/u.height)});for(var d=f.length,c=0;c<d;c+=3){var v=f[c+0],g=f[c+1],p=f[c+2];f.push(p+h),f.push(g+h),f.push(v+h)}this._addSide(o,a,s,f,u,this._outlinepoints,t,!1,e),this._holes.forEach(function(m){r._addSide(o,a,s,f,u,m,t,!0,e)})}return i.indices=f,i.positions=o,i.normals=a,i.uvs=s,i},n.prototype._addSide=function(t,e,r,i,a,o,s,u,f){for(var l=t.length/3,c=0,h=0;h<o.elements.length;h++){var d=o.elements[h],v=o.elements[(h+1)%o.elements.length];t.push(d.x,0,d.y),t.push(d.x,-s,d.y),t.push(v.x,0,v.y),t.push(v.x,-s,v.y);var g=o.elements[(h+o.elements.length-1)%o.elements.length],p=o.elements[(h+2)%o.elements.length],m=new O(-(v.y-d.y),0,v.x-d.x),M=new O(-(d.y-g.y),0,d.x-g.x),A=new O(-(p.y-v.y),0,p.x-v.x);u||(m=m.scale(-1),M=M.scale(-1),A=A.scale(-1));var y=m.normalizeToNew(),b=M.normalizeToNew(),x=A.normalizeToNew(),I=O.Dot(b,y);I>f?I<xe-1?b=new O(d.x,0,d.y).subtract(new O(v.x,0,v.y)).normalize():b=M.add(m).normalize():b=y;var D=O.Dot(A,m);D>f?D<xe-1?x=new O(v.x,0,v.y).subtract(new O(d.x,0,d.y)).normalize():x=A.add(m).normalize():x=y,r.push(c/a.width,0),r.push(c/a.width,1),c+=m.length(),r.push(c/a.width,0),r.push(c/a.width,1),e.push(b.x,b.y,b.z),e.push(b.x,b.y,b.z),e.push(x.x,x.y,x.z),e.push(x.x,x.y,x.z),u?(i.push(l),i.push(l+2),i.push(l+1),i.push(l+1),i.push(l+2),i.push(l+3)):(i.push(l),i.push(l+1),i.push(l+2),i.push(l+1),i.push(l+3),i.push(l+2)),l+=4}},n}();function ir(n,t,e,r,i,a,o){for(var s=e||new Array(3),u=r,f=[],l=o||!1,c=0;c<3;c++)s[c]===void 0&&(s[c]=new be(0,0,1,1)),u&&u[c]===void 0&&(u[c]=new De(1,1,1,1));var h=n.getVerticesData(_.PositionKind),d=n.getVerticesData(_.NormalKind),v=n.getVerticesData(_.UVKind),g=n.getIndices(),p=h.length/9,m=0,M=0,A=0,y=0,b=0,x=[0];if(l)for(var I=p;I<h.length/3;I+=4)M=h[3*(I+2)]-h[3*I],A=h[3*(I+2)+2]-h[3*I+2],y=Math.sqrt(M*M+A*A),b+=y,x.push(b);for(var D=0,T=0,C=0;C<d.length;C+=3)Math.abs(d[C+1])<.001&&(T=1),Math.abs(d[C+1]-1)<.001&&(T=0),Math.abs(d[C+1]+1)<.001&&(T=2),D=C/3,T===1?(m=D-p,m%4<1.5?l?v[2*D]=s[T].x+(s[T].z-s[T].x)*x[Math.floor(m/4)]/b:v[2*D]=s[T].x:l?v[2*D]=s[T].x+(s[T].z-s[T].x)*x[Math.floor(m/4)+1]/b:v[2*D]=s[T].z,m%2===0?v[2*D+1]=j.UseOpenGLOrientationForUV?1-s[T].w:s[T].w:v[2*D+1]=j.UseOpenGLOrientationForUV?1-s[T].y:s[T].y):(v[2*D]=(1-v[2*D])*s[T].x+v[2*D]*s[T].z,v[2*D+1]=(1-v[2*D+1])*s[T].y+v[2*D+1]*s[T].w,j.UseOpenGLOrientationForUV&&(v[2*D+1]=1-v[2*D+1])),u&&f.push(u[T].r,u[T].g,u[T].b,u[T].a);Q._ComputeSides(t,h,g,d,v,i,a);var B=new Q;if(B.indices=g,B.positions=h,B.normals=d,B.uvs=v,u){var V=t===Q.DOUBLESIDE?f.concat(f):f;B.colors=V}return B}function at(n,t,e,r){e===void 0&&(e=null),r===void 0&&(r=earcut),t.sideOrientation=S._GetDefaultSideOrientation(t.sideOrientation);for(var i=t.shape,a=t.holes||[],o=t.depth||0,s=t.smoothingThreshold||2,u=[],f=[],l=0;l<i.length;l++)u[l]=new le(i[l].x,i[l].z);var c=1e-8;u[0].equalsWithEpsilon(u[u.length-1],c)&&u.pop();for(var h=new zr(n,u,e||Qe.LastCreatedScene,r),d=0;d<a.length;d++){f=[];for(var v=0;v<a[d].length;v++)f.push(new le(a[d][v].x,a[d][v].z));h.addHole(f)}var g=h.build(!1,o,s);g._originalBuilderSideOrientation=t.sideOrientation;var p=ir(g,t.sideOrientation,t.faceUV,t.faceColors,t.frontUVs,t.backUVs,t.wrap);return p.applyToMesh(g,t.updatable),g}function ar(n,t,e,r){return e===void 0&&(e=null),r===void 0&&(r=earcut),at(n,t,e,r)}Q.CreatePolygon=ir;S.CreatePolygon=function(n,t,e,r,i,a,o){o===void 0&&(o=earcut);var s={shape:t,holes:r,updatable:i,sideOrientation:a};return at(n,s,e,o)};S.ExtrudePolygon=function(n,t,e,r,i,a,o,s){s===void 0&&(s=earcut);var u={shape:t,holes:i,depth:e,updatable:a,sideOrientation:o};return ar(n,u,r,s)};function nr(n,t,e){e===void 0&&(e=null);var r=t.arc?t.arc<=0||t.arc>1?1:t.arc:1,i=t.closed===void 0?!0:t.closed,a=t.shape,o=t.radius||1,s=t.tessellation||64,u=t.clip||0,f=t.updatable,l=S._GetDefaultSideOrientation(t.sideOrientation),c=t.cap||S.NO_CAP,h=Math.PI*2,d=new Array,v=t.invertUV||!1,g=0,p=0,m=h/s*r,M,A;for(g=0;g<=s-u;g++){for(A=[],(c==S.CAP_START||c==S.CAP_ALL)&&(A.push(new O(0,a[0].y,0)),A.push(new O(Math.cos(g*m)*a[0].x*o,a[0].y,Math.sin(g*m)*a[0].x*o))),p=0;p<a.length;p++)M=new O(Math.cos(g*m)*a[p].x*o,a[p].y,Math.sin(g*m)*a[p].x*o),A.push(M);(c==S.CAP_END||c==S.CAP_ALL)&&(A.push(new O(Math.cos(g*m)*a[a.length-1].x*o,a[a.length-1].y,Math.sin(g*m)*a[a.length-1].x*o)),A.push(new O(0,a[a.length-1].y,0))),d.push(A)}var y=Ve(n,{pathArray:d,closeArray:i,sideOrientation:l,updatable:f,invertUV:v,frontUVs:t.frontUVs,backUVs:t.backUVs},e);return y}S.CreateLathe=function(n,t,e,r,i,a,o){var s={shape:t,radius:e,tessellation:r,sideOrientation:o,updatable:a};return nr(n,s,i)};function sr(n,t,e){e===void 0&&(e=null);var r=t.path,i=t.instance,a=1;t.radius!==void 0?a=t.radius:i&&(a=i._creationDataStorage.radius);var o=t.tessellation||64,s=t.radiusFunction||null,u=t.cap||S.NO_CAP,f=t.invertUV||!1,l=t.updatable,c=S._GetDefaultSideOrientation(t.sideOrientation);t.arc=t.arc&&(t.arc<=0||t.arc>1)?1:t.arc||1;var h=function(A,y,b,x,I,D,T,C){for(var B=y.getTangents(),V=y.getNormals(),U=y.getDistances(),R=Math.PI*2,F=R/I*C,W=function(){return x},K=D||W,E,w,L,P,Y=z.Matrix[0],G=T===S.NO_CAP||T===S.CAP_END?0:2,H=0;H<A.length;H++){w=K(H,U[H]),E=Array(),L=V[H];for(var Z=0;Z<I;Z++)X.RotationAxisToRef(B[H],F*Z,Y),P=E[Z]?E[Z]:O.Zero(),O.TransformCoordinatesToRef(L,Y,P),P.scaleInPlace(w).addInPlace(A[H]),E[Z]=P;b[G]=E,G++}var q=function(N,k){for(var ie=Array(),J=0;J<N;J++)ie.push(A[k]);return ie};switch(T){case S.NO_CAP:break;case S.CAP_START:b[0]=q(I,0),b[1]=b[2].slice(0);break;case S.CAP_END:b[G]=b[G-1].slice(0),b[G+1]=q(I,A.length-1);break;case S.CAP_ALL:b[0]=q(I,0),b[1]=b[2].slice(0),b[G]=b[G-1].slice(0),b[G+1]=q(I,A.length-1);break}return b},d,v;if(i){var g=i._creationDataStorage,p=t.arc||g.arc;return d=g.path3D.update(r),v=h(r,d,g.pathArray,a,g.tessellation,s,g.cap,p),i=Ve("",{pathArray:v,instance:i}),g.path3D=d,g.pathArray=v,g.arc=p,g.radius=a,i}d=new He(r);var m=new Array;u=u<0||u>3?0:u,v=h(r,d,m,a,o,s,u,t.arc);var M=Ve(n,{pathArray:v,closePath:!0,closeArray:!1,updatable:l,sideOrientation:c,invertUV:f,frontUVs:t.frontUVs,backUVs:t.backUVs},e);return M._creationDataStorage.pathArray=v,M._creationDataStorage.path3D=d,M._creationDataStorage.tessellation=o,M._creationDataStorage.cap=u,M._creationDataStorage.arc=t.arc,M._creationDataStorage.radius=a,M}S.CreateTube=function(n,t,e,r,i,a,o,s,u,f){var l={path:t,radius:e,tessellation:r,radiusFunction:i,arc:1,cap:a,updatable:s,sideOrientation:u,instance:f};return sr(n,l,o)};function or(n,t,e){var r=t.getIndices(),i=t.getVerticesData(_.PositionKind),a=t.getVerticesData(_.NormalKind),o=t.getVerticesData(_.UVKind),s=e.position||O.Zero(),u=e.normal||O.Up(),f=e.size||O.One(),l=e.angle||0;if(!u){var c=new O(0,0,1),h=t.getScene().activeCamera,d=O.TransformCoordinates(c,h.getWorldMatrix());u=h.globalPosition.subtract(d)}var v=-Math.atan2(u.z,u.x)-Math.PI/2,g=Math.sqrt(u.x*u.x+u.z*u.z),p=Math.atan2(u.y,g),m=X.RotationYawPitchRoll(v,p,l).multiply(X.Translation(s.x,s.y,s.z)),M=X.Invert(m),A=t.getWorldMatrix(),y=A.multiply(M),b=new Q;b.indices=[],b.positions=[],b.normals=[],b.uvs=[];for(var x=0,I=function(F){var W=new ot;if(!r||!i||!a)return W;var K=r[F];if(W.position=new O(i[K*3],i[K*3+1],i[K*3+2]),W.position=O.TransformCoordinates(W.position,y),W.normal=new O(a[K*3],a[K*3+1],a[K*3+2]),W.normal=O.TransformNormal(W.normal,y),e.captureUVS&&o){var E=o[K*2+1];W.uv=new le(o[K*2],j.UseOpenGLOrientationForUV?1-E:E)}return W},D=function(F,W){if(F.length===0)return F;for(var K=.5*Math.abs(O.Dot(f,W)),E=function($,ae){var te=O.GetClipFactor($.position,ae.position,W,K);return new ot(O.Lerp($.position,ae.position,te),O.Lerp($.normal,ae.normal,te))},w=new Array,L=0;L<F.length;L+=3){var P=0,Y=null,G=null,H=null,Z=null,q=O.Dot(F[L].position,W)-K,N=O.Dot(F[L+1].position,W)-K,k=O.Dot(F[L+2].position,W)-K,ie=q>0,J=N>0,ee=k>0;switch(P=(ie?1:0)+(J?1:0)+(ee?1:0),P){case 0:w.push(F[L]),w.push(F[L+1]),w.push(F[L+2]);break;case 1:if(ie&&(Y=F[L+1],G=F[L+2],H=E(F[L],Y),Z=E(F[L],G)),J){Y=F[L],G=F[L+2],H=E(F[L+1],Y),Z=E(F[L+1],G),w.push(H),w.push(G.clone()),w.push(Y.clone()),w.push(G.clone()),w.push(H.clone()),w.push(Z);break}ee&&(Y=F[L],G=F[L+1],H=E(F[L+2],Y),Z=E(F[L+2],G)),Y&&G&&H&&Z&&(w.push(Y.clone()),w.push(G.clone()),w.push(H),w.push(Z),w.push(H.clone()),w.push(G.clone()));break;case 2:ie||(Y=F[L].clone(),G=E(Y,F[L+1]),H=E(Y,F[L+2]),w.push(Y),w.push(G),w.push(H)),J||(Y=F[L+1].clone(),G=E(Y,F[L+2]),H=E(Y,F[L]),w.push(Y),w.push(G),w.push(H)),ee||(Y=F[L+2].clone(),G=E(Y,F[L]),H=E(Y,F[L+1]),w.push(Y),w.push(G),w.push(H));break}}return w},T=0;T<r.length;T+=3){var C=new Array;if(C.push(I(T)),C.push(I(T+1)),C.push(I(T+2)),C=D(C,new O(1,0,0)),C=D(C,new O(-1,0,0)),C=D(C,new O(0,1,0)),C=D(C,new O(0,-1,0)),C=D(C,new O(0,0,1)),C=D(C,new O(0,0,-1)),C.length!==0)for(var B=0;B<C.length;B++){var V=C[B];if(b.indices.push(x),V.position.toArray(b.positions,x*3),V.normal.toArray(b.normals,x*3),e.captureUVS)V.uv.toArray(b.uvs,x*2);else{b.uvs.push(.5+V.position.x/f.x);var U=.5+V.position.y/f.y;b.uvs.push(j.UseOpenGLOrientationForUV?1-U:U)}x++}}var R=new S(n,t.getScene());return b.applyToMesh(R),R.position=s.clone(),R.rotation=new O(p,v,l),R}S.CreateDecal=function(n,t,e,r,i,a){var o={position:e,normal:r,size:i,angle:a};return or(n,t,o)};var ur=function(){function n(){this.cartesian=[],this.vertices=[],this.max=[],this.min=[],this.closestTo=[],this.innerFacets=[],this.isoVecsABOB=[],this.isoVecsOBOA=[],this.isoVecsBAOA=[],this.vertexTypes=[],this.IDATA=new Je("icosahedron","Regular",[[0,oe,-1],[-oe,1,0],[-1,0,-oe],[1,0,-oe],[oe,1,0],[0,oe,1],[-1,0,oe],[-oe,-1,0],[0,-oe,-1],[oe,-1,0],[1,0,oe],[0,-oe,1]],[[0,2,1],[0,3,2],[0,4,3],[0,5,4],[0,1,5],[7,6,1],[8,7,2],[9,8,3],[10,9,4],[6,10,5],[2,7,1],[3,8,2],[4,9,3],[5,10,4],[1,6,5],[11,6,7],[11,7,8],[11,8,9],[11,9,10],[11,10,6]])}return n.prototype.setIndices=function(){var t=12,e={},r=this.m,i=this.n,a=r,o=1,s=0;i!==0&&(a=ut.HCF(r,i)),o=r/a,s=i/a;var u,f,l,c,h,d=ne.Zero(),v=new ne(r,i),g=new ne(-i,r+i),p=ne.Zero(),m=ne.Zero(),M=ne.Zero(),A=[],y,b,x,I,D=[],T=this.vertByDist,C=function(U,R,F,W){y=U+"|"+F,b=R+"|"+W,y in e||b in e?y in e&&!(b in e)?e[b]=e[y]:b in e&&!(y in e)&&(e[y]=e[b]):(e[y]=t,e[b]=t,t++),T[F][0]>2?D[e[y]]=[-T[F][0],T[F][1],e[y]]:D[e[y]]=[A[T[F][0]],T[F][1],e[y]]};this.IDATA.edgematch=[[1,"B"],[2,"B"],[3,"B"],[4,"B"],[0,"B"],[10,"O",14,"A"],[11,"O",10,"A"],[12,"O",11,"A"],[13,"O",12,"A"],[14,"O",13,"A"],[0,"O"],[1,"O"],[2,"O"],[3,"O"],[4,"O"],[19,"B",5,"A"],[15,"B",6,"A"],[16,"B",7,"A"],[17,"B",8,"A"],[18,"B",9,"A"]];for(var B=0;B<20;B++){if(A=this.IDATA.face[B],l=A[2],c=A[1],h=A[0],x=d.x+"|"+d.y,y=B+"|"+x,y in e||(e[y]=l,D[l]=[A[T[x][0]],T[x][1]]),x=v.x+"|"+v.y,y=B+"|"+x,y in e||(e[y]=c,D[c]=[A[T[x][0]],T[x][1]]),x=g.x+"|"+g.y,y=B+"|"+x,y in e||(e[y]=h,D[h]=[A[T[x][0]],T[x][1]]),u=this.IDATA.edgematch[B][0],f=this.IDATA.edgematch[B][1],f==="B")for(var V=1;V<a;V++)m.x=r-V*(o+s),m.y=i+V*o,M.x=-V*s,M.y=V*(o+s),x=m.x+"|"+m.y,I=M.x+"|"+M.y,C(B,u,x,I);if(f==="O")for(var V=1;V<a;V++)M.x=-V*s,M.y=V*(o+s),p.x=V*o,p.y=V*s,x=M.x+"|"+M.y,I=p.x+"|"+p.y,C(B,u,x,I);if(u=this.IDATA.edgematch[B][2],f=this.IDATA.edgematch[B][3],f&&f==="A")for(var V=1;V<a;V++)p.x=V*o,p.y=V*s,m.x=r-(a-V)*(o+s),m.y=i+(a-V)*o,x=p.x+"|"+p.y,I=m.x+"|"+m.y,C(B,u,x,I);for(var V=0;V<this.vertices.length;V++)x=this.vertices[V].x+"|"+this.vertices[V].y,y=B+"|"+x,y in e||(e[y]=t++,T[x][0]>2?D[e[y]]=[-T[x][0],T[x][1],e[y]]:D[e[y]]=[A[T[x][0]],T[x][1],e[y]])}this.closestTo=D,this.vecToidx=e},n.prototype.calcCoeffs=function(){var t=this.m,e=this.n,r=Math.sqrt(3)/3,i=t*t+e*e+t*e;this.coau=(t+e)/i,this.cobu=-e/i,this.coav=-r*(t-e)/i,this.cobv=r*(2*t+e)/i},n.prototype.createInnerFacets=function(){for(var t=this.m,e=this.n,r=0;r<e+t+1;r++)for(var i=this.min[r];i<this.max[r]+1;i++)i<this.max[r]&&i<this.max[r+1]+1&&this.innerFacets.push(["|"+i+"|"+r,"|"+i+"|"+(r+1),"|"+(i+1)+"|"+r]),r>0&&i<this.max[r-1]&&i+1<this.max[r]+1&&this.innerFacets.push(["|"+i+"|"+r,"|"+(i+1)+"|"+r,"|"+(i+1)+"|"+(r-1)])},n.prototype.edgeVecsABOB=function(){for(var t=this.m,e=this.n,r=new ne(-e,t+e),i=1;i<t+e;i++){var a=new ne(this.min[i],i),o=new ne(this.min[i-1],i-1),s=new ne(this.min[i+1],i+1),u=a.clone(),f=o.clone(),l=s.clone();u.rotate60About(r),f.rotate60About(r),l.rotate60About(r);var c=new ne(this.max[u.y],u.y),h=new ne(this.max[u.y-1],u.y-1),d=new ne(this.max[u.y-1]-1,u.y-1);(u.x!==c.x||u.y!==c.y)&&(u.x!==h.x?(this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([a,h,d]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([a,d,c])):u.y===l.y?(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([a,o,h]),this.vertexTypes.push([1,0,1]),this.isoVecsABOB.push([a,h,s])):(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([a,o,h]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([a,h,c])))}},n.prototype.mapABOBtoOBOA=function(){for(var t=new ne(0,0),e=0;e<this.isoVecsABOB.length;e++){for(var r=[],i=0;i<3;i++)t.x=this.isoVecsABOB[e][i].x,t.y=this.isoVecsABOB[e][i].y,this.vertexTypes[e][i]===0&&t.rotateNeg120(this.m,this.n),r.push(t.clone());this.isoVecsOBOA.push(r)}},n.prototype.mapABOBtoBAOA=function(){for(var t=new ne(0,0),e=0;e<this.isoVecsABOB.length;e++){for(var r=[],i=0;i<3;i++)t.x=this.isoVecsABOB[e][i].x,t.y=this.isoVecsABOB[e][i].y,this.vertexTypes[e][i]===1&&t.rotate120(this.m,this.n),r.push(t.clone());this.isoVecsBAOA.push(r)}},n.prototype.MapToFace=function(t,e){for(var r=this.IDATA.face[t],i=r[2],a=r[1],o=r[0],s=O.FromArray(this.IDATA.vertex[i]),u=O.FromArray(this.IDATA.vertex[a]),f=O.FromArray(this.IDATA.vertex[o]),l=u.subtract(s),c=f.subtract(s),h=l.scale(this.coau).add(c.scale(this.cobu)),d=l.scale(this.coav).add(c.scale(this.cobv)),v,g=z.Vector3[0],p=0;p<this.cartesian.length;p++)g=h.scale(this.cartesian[p].x).add(d.scale(this.cartesian[p].y)).add(s),g.x,g.y,g.z,v=t+"|"+this.vertices[p].x+"|"+this.vertices[p].y,e.vertex[this.vecToidx[v]]=[g.x,g.y,g.z]},n.prototype.build=function(t,e){var r=new Array,i=ne.Zero(),a=new ne(t,e),o=new ne(-e,t+e);r.push(i,a,o);for(var s=e;s<t+1;s++)for(var u=0;u<t+1-s;u++)r.push(new ne(u,s));if(e>0){for(var f=ut.HCF(t,e),l=t/f,c=e/f,h=1;h<f;h++)r.push(new ne(h*l,h*c)),r.push(new ne(-h*c,h*(l+c))),r.push(new ne(t-h*(l+c),e+h*l));for(var d=t/e,v=1;v<e;v++)for(var g=0;g<v*d;g++)r.push(new ne(g,v)),r.push(new ne(g,v).rotate120(t,e)),r.push(new ne(g,v).rotateNeg120(t,e))}r.sort(function(F,W){return F.x-W.x}),r.sort(function(F,W){return F.y-W.y});for(var p=new Array(t+e+1),m=new Array(t+e+1),h=0;h<p.length;h++)p[h]=1/0,m[h]=-1/0;for(var M=0,A=0,y=r.length,h=0;h<y;h++)A=r[h].x,M=r[h].y,p[M]=Math.min(A,p[M]),m[M]=Math.max(A,m[M]);for(var b=function(F,W){var K=F.clone();return W==="A"&&K.rotateNeg120(t,e),W==="B"&&K.rotate120(t,e),K.x<0?K.y:K.x+K.y},x=[],I=[],D=[],T=[],C={},B=[],V=-1,U=-1,h=0;h<y;h++)x[h]=r[h].toCartesianOrigin(new ne(0,0),.5),I[h]=b(r[h],"O"),D[h]=b(r[h],"A"),T[h]=b(r[h],"B"),I[h]===D[h]&&D[h]===T[h]?(V=3,U=I[h]):I[h]===D[h]?(V=4,U=I[h]):D[h]===T[h]?(V=5,U=D[h]):T[h]===I[h]&&(V=6,U=I[h]),I[h]<D[h]&&I[h]<T[h]&&(V=2,U=I[h]),D[h]<I[h]&&D[h]<T[h]&&(V=1,U=D[h]),T[h]<D[h]&&T[h]<I[h]&&(V=0,U=T[h]),B.push([V,U,r[h].x,r[h].y]);B.sort(function(F,W){return F[2]-W[2]}),B.sort(function(F,W){return F[3]-W[3]}),B.sort(function(F,W){return F[1]-W[1]}),B.sort(function(F,W){return F[0]-W[0]});for(var R=0;R<B.length;R++)C[B[R][2]+"|"+B[R][3]]=[B[R][0],B[R][1],R];return this.m=t,this.n=e,this.vertices=r,this.vertByDist=C,this.cartesian=x,this.min=p,this.max=m,this},n}(),Je=function(){function n(t,e,r,i){this.name=t,this.category=e,this.vertex=r,this.face=i}return n}(),fr=function(n){_e(t,n);function t(){return n!==null&&n.apply(this,arguments)||this}return t.prototype.innerToData=function(e,r){for(var i=0;i<r.innerFacets.length;i++)this.face.push(r.innerFacets[i].map(function(a){return r.vecToidx[e+a]}))},t.prototype.mapABOBtoDATA=function(e,r){for(var i=r.IDATA.edgematch[e][0],a=0;a<r.isoVecsABOB.length;a++){for(var o=[],s=0;s<3;s++)r.vertexTypes[a][s]===0?o.push(e+"|"+r.isoVecsABOB[a][s].x+"|"+r.isoVecsABOB[a][s].y):o.push(i+"|"+r.isoVecsABOB[a][s].x+"|"+r.isoVecsABOB[a][s].y);this.face.push([r.vecToidx[o[0]],r.vecToidx[o[1]],r.vecToidx[o[2]]])}},t.prototype.mapOBOAtoDATA=function(e,r){for(var i=r.IDATA.edgematch[e][0],a=0;a<r.isoVecsOBOA.length;a++){for(var o=[],s=0;s<3;s++)r.vertexTypes[a][s]===1?o.push(e+"|"+r.isoVecsOBOA[a][s].x+"|"+r.isoVecsOBOA[a][s].y):o.push(i+"|"+r.isoVecsOBOA[a][s].x+"|"+r.isoVecsOBOA[a][s].y);this.face.push([r.vecToidx[o[0]],r.vecToidx[o[1]],r.vecToidx[o[2]]])}},t.prototype.mapBAOAtoDATA=function(e,r){for(var i=r.IDATA.edgematch[e][2],a=0;a<r.isoVecsBAOA.length;a++){for(var o=[],s=0;s<3;s++)r.vertexTypes[a][s]===1?o.push(e+"|"+r.isoVecsBAOA[a][s].x+"|"+r.isoVecsBAOA[a][s].y):o.push(i+"|"+r.isoVecsBAOA[a][s].x+"|"+r.isoVecsBAOA[a][s].y);this.face.push([r.vecToidx[o[0]],r.vecToidx[o[1]],r.vecToidx[o[2]]])}},t.prototype.orderData=function(e){for(var r=[],i=0;i<13;i++)r[i]=[];for(var a=e.closestTo,i=0;i<a.length;i++)a[i][0]>-1?a[i][1]>0&&r[a[i][0]].push([i,a[i][1]]):r[12].push([i,a[i][0]]);for(var o=[],i=0;i<12;i++)o[i]=i;for(var s=12,i=0;i<12;i++){r[i].sort(function(l,c){return l[1]-c[1]});for(var u=0;u<r[i].length;u++)o[r[i][u][0]]=s++}for(var u=0;u<r[12].length;u++)o[r[12][u][0]]=s++;for(var i=0;i<this.vertex.length;i++)this.vertex[i].push(o[i]);this.vertex.sort(function(f,l){return f[3]-l[3]});for(var i=0;i<this.vertex.length;i++)this.vertex[i].pop();for(var i=0;i<this.face.length;i++)for(var u=0;u<this.face[i].length;u++)this.face[i][u]=o[this.face[i][u]];this.sharedNodes=r[12].length,this.poleNodes=this.vertex.length-this.sharedNodes},t.prototype.setOrder=function(e,r){var i=[],a=[],o=r.pop();a.push(o);var s=this.face[o].indexOf(e);s=(s+2)%3;var u=this.face[o][s];i.push(u);for(var f=0;r.length>0;)o=r[f],this.face[o].indexOf(u)>-1?(s=(this.face[o].indexOf(u)+1)%3,u=this.face[o][s],i.push(u),a.push(o),r.splice(f,1),f=0):f++;return this.adjacentFaces.push(i),a},t.prototype.toGoldbergPolyhedronData=function(){var e=this,r=new Je("GeoDual","Goldberg",[],[]);r.name="GD dual";for(var i=this.vertex.length,a=new Array(i),o=0;o<i;o++)a[o]=[];for(var s=0;s<this.face.length;s++)for(var u=0;u<3;u++)a[this.face[s][u]].push(s);var f=0,l=0,c=0,h=[],d=[];this.adjacentFaces=[];for(var v=0;v<a.length;v++)r.face[v]=this.setOrder(v,a[v].concat([])),a[v].forEach(function(g){f=0,l=0,c=0,h=e.face[g];for(var p=0;p<3;p++)d=e.vertex[h[p]],f+=d[0],l+=d[1],c+=d[2];r.vertex[g]=[f/3,l/3,c/3]});return r},t.BuildGeodesicData=function(e){var r=new t("Geodesic-m-n","Geodesic",[[0,oe,-1],[-oe,1,0],[-1,0,-oe],[1,0,-oe],[oe,1,0],[0,oe,1],[-1,0,oe],[-oe,-1,0],[0,-oe,-1],[oe,-1,0],[1,0,oe],[0,-oe,1]],[]);e.setIndices(),e.calcCoeffs(),e.createInnerFacets(),e.edgeVecsABOB(),e.mapABOBtoOBOA(),e.mapABOBtoBAOA();for(var i=0;i<e.IDATA.face.length;i++)e.MapToFace(i,r),r.innerToData(i,e),e.IDATA.edgematch[i][1]==="B"&&r.mapABOBtoDATA(i,e),e.IDATA.edgematch[i][1]==="O"&&r.mapOBOAtoDATA(i,e),e.IDATA.edgematch[i][3]==="A"&&r.mapBAOAtoDATA(i,e);r.orderData(e);var a=1;return r.vertex=r.vertex.map(function(o){var s=o[0],u=o[1],f=o[2],l=Math.sqrt(s*s+u*u+f*f);return o[0]*=a/l,o[1]*=a/l,o[2]*=a/l,o}),r},t}(Je);function Wr(n,t,e){e===void 0&&(e=null);var r=t.m||1;r!==Math.floor(r)&&ue.Warn("m not an integer only floor(m) used");var i=t.n||0;if(i!==Math.floor(i)&&ue.Warn("n not an integer only floor(n) used"),i>r){var a=i;i=r,r=a,ue.Warn("n > m therefore m and n swapped")}var o=new ur;o.build(r,i);var s=fr.BuildGeodesicData(o),u={custom:s,size:t.size,sizeX:t.sizeX,sizeY:t.sizeY,sizeZ:t.sizeZ,faceUV:t.faceUV,faceColors:t.faceColors,flat:t.flat,updatable:t.updatable,sideOrientation:t.sideOrientation,frontUVs:t.frontUVs,backUVs:t.backUVs},f=rt(n,u,e);return f}function Kr(n,t){for(var e=n.size,r=n.sizeX||e||1,i=n.sizeY||e||1,a=n.sizeZ||e||1,o=n.sideOrientation===0?0:n.sideOrientation||Q.DEFAULTSIDE,s=new Array,u=new Array,f=new Array,l=new Array,c=1/0,h=-1/0,d=1/0,v=-1/0,g=0;g<t.vertex.length;g++)c=Math.min(c,t.vertex[g][0]*r),h=Math.max(h,t.vertex[g][0]*r),d=Math.min(d,t.vertex[g][1]*i),v=Math.max(v,t.vertex[g][1]*i);for(var p=0,m=0;m<t.face.length;m++){for(var M=t.face[m],A=O.FromArray(t.vertex[M[0]]),y=O.FromArray(t.vertex[M[2]]),b=O.FromArray(t.vertex[M[1]]),x=y.subtract(A),I=b.subtract(A),D=O.Cross(I,x).normalize(),g=0;g<M.length;g++){f.push(D.x,D.y,D.z);var T=t.vertex[M[g]];s.push(T[0]*r,T[1]*i,T[2]*a);var C=(T[1]*i-d)/(v-d);l.push((T[0]*r-c)/(h-c),j.UseOpenGLOrientationForUV?1-C:C)}for(var g=0;g<M.length-2;g++)u.push(p,p+g+2,p+g+1);p+=M.length}Q._ComputeSides(o,s,u,f,l);var B=new Q;return B.positions=s,B.indices=u,B.normals=f,B.uvs=l,B}function hr(n,t,e){e===void 0&&(e=null);var r=t.size,i=t.sizeX||r||1,a=t.sizeY||r||1,o=t.sizeZ||r||1,s=t.m||1;s!==Math.floor(s)&&ue.Warn("m not an integer only floor(m) used");var u=t.n||0;if(u!==Math.floor(u)&&ue.Warn("n not an integer only floor(n) used"),u>s){var f=u;u=s,s=f,ue.Warn("n > m therefore m and n swapped")}var l=new ur;l.build(s,u);var c=fr.BuildGeodesicData(l),h=c.toGoldbergPolyhedronData(),d=new $t(n,e);t.sideOrientation=S._GetDefaultSideOrientation(t.sideOrientation),d._originalBuilderSideOrientation=t.sideOrientation;var v=Kr(t,h);v.applyToMesh(d,t.updatable),d.goldbergData.nbSharedFaces=c.sharedNodes,d.goldbergData.nbUnsharedFaces=c.poleNodes,d.goldbergData.adjacentFaces=c.adjacentFaces,d.goldbergData.nbFaces=d.goldbergData.nbSharedFaces+d.goldbergData.nbUnsharedFaces,d.goldbergData.nbFacesAtPole=(d.goldbergData.nbUnsharedFaces-12)/12;for(var g=0;g<c.vertex.length;g++)d.goldbergData.faceCenters.push(O.FromArray(c.vertex[g])),d.goldbergData.faceCenters[g].x*=i,d.goldbergData.faceCenters[g].y*=a,d.goldbergData.faceCenters[g].z*=o,d.goldbergData.faceColors.push(new De(1,1,1,1));for(var g=0;g<h.face.length;g++){var p=h.face[g],m=O.FromArray(h.vertex[p[0]]),M=O.FromArray(h.vertex[p[2]]),A=O.FromArray(h.vertex[p[1]]),y=M.subtract(m),b=A.subtract(m),x=O.Cross(b,y).normalize(),I=O.Cross(b,x).normalize();d.goldbergData.faceXaxis.push(b.normalize()),d.goldbergData.faceYaxis.push(x),d.goldbergData.faceZaxis.push(I)}return d}S.CreateGoldberg=hr;var di={CreateBox:Rt,CreateTiledBox:Ur,CreateSphere:et,CreateDisc:it,CreateIcoSphere:At,CreateRibbon:Ve,CreateCylinder:Bt,CreateTorus:Ct,CreateTorusKnot:rr,CreateLineSystem:Zt,CreateLines:Gt,CreateDashedLines:Yt,ExtrudeShape:kt,ExtrudeShapeCustom:Xt,CreateLathe:nr,CreateTiledPlane:Rr,CreatePlane:Mt,CreateGround:Vt,CreateTiledGround:Ft,CreateGroundFromHeightMap:Lt,CreatePolygon:at,ExtrudePolygon:ar,CreateTube:sr,CreatePolyhedron:rt,CreateGeodesic:Wr,CreateGoldberg:hr,CreateDecal:or,CreateCapsule:zt},Qr=function(){function n(){this.running=!1,this._simplificationArray=[]}return n.prototype.addTask=function(t){this._simplificationArray.push(t)},n.prototype.executeNext=function(){var t=this._simplificationArray.pop();t?(this.running=!0,this.runSimplification(t)):this.running=!1},n.prototype.runSimplification=function(t){var e=this;if(t.parallelProcessing)t.settings.forEach(function(a){var o=e._getSimplifier(t);o.simplify(a,function(s){a.distance!==void 0&&t.mesh.addLODLevel(a.distance,s),s.isVisible=!0,a.quality===t.settings[t.settings.length-1].quality&&t.successCallback&&t.successCallback(),e.executeNext()})});else{var r=this._getSimplifier(t),i=function(a,o){r.simplify(a,function(s){a.distance!==void 0&&t.mesh.addLODLevel(a.distance,s),s.isVisible=!0,o()})};Ae.Run(t.settings.length,function(a){i(t.settings[a.index],function(){a.executeNext()})},function(){t.successCallback&&t.successCallback(),e.executeNext()})}},n.prototype._getSimplifier=function(t){switch(t.simplificationType){case Ke.QUADRATIC:default:return new Hr(t.mesh)}},n}(),Ke;(function(n){n[n.QUADRATIC=0]="QUADRATIC"})(Ke||(Ke={}));var Zr=function(){function n(t){this._vertices=t,this.error=new Array(4),this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}return n}(),Gr=function(){function n(t,e){this.position=t,this.id=e,this.isBorder=!0,this.q=new lr,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}return n.prototype.updatePosition=function(t){this.position.copyFrom(t)},n}(),lr=function(){function n(t){this.data=new Array(10);for(var e=0;e<10;++e)t&&t[e]?this.data[e]=t[e]:this.data[e]=0}return n.prototype.det=function(t,e,r,i,a,o,s,u,f){var l=this.data[t]*this.data[a]*this.data[f]+this.data[r]*this.data[i]*this.data[u]+this.data[e]*this.data[o]*this.data[s]-this.data[r]*this.data[a]*this.data[s]-this.data[t]*this.data[o]*this.data[u]-this.data[e]*this.data[i]*this.data[f];return l},n.prototype.addInPlace=function(t){for(var e=0;e<10;++e)this.data[e]+=t.data[e]},n.prototype.addArrayInPlace=function(t){for(var e=0;e<10;++e)this.data[e]+=t[e]},n.prototype.add=function(t){for(var e=new n,r=0;r<10;++r)e.data[r]=this.data[r]+t.data[r];return e},n.FromData=function(t,e,r,i){return new n(n.DataFromNumbers(t,e,r,i))},n.DataFromNumbers=function(t,e,r,i){return[t*t,t*e,t*r,t*i,e*e,e*r,e*i,r*r,r*i,i*i]},n}(),Yr=function(){function n(t,e){this.vertexId=t,this.triangleId=e}return n}(),Hr=function(){function n(t){this._mesh=t,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=xe}return n.prototype.simplify=function(t,e){var r=this;this._initDecimatedMesh(),Ae.Run(this._mesh.subMeshes.length,function(i){r._initWithMesh(i.index,function(){r._runDecimation(t,i.index,function(){i.executeNext()})},t.optimizeMesh)},function(){setTimeout(function(){e(r._reconstructedMesh)},0)})},n.prototype._runDecimation=function(t,e,r){var i=this,a=~~(this._triangles.length*t.quality),o=0,s=this._triangles.length,u=function(f,l){setTimeout(function(){f%5===0&&i._updateMesh(f===0);for(var c=0;c<i._triangles.length;++c)i._triangles[c].isDirty=!1;var h=1e-9*Math.pow(f+3,i.aggressiveness),d=function(v){var g=~~((i._triangles.length/2+v)%i._triangles.length),p=i._triangles[g];if(!!p&&!(p.error[3]>h||p.deleted||p.isDirty))for(var m=function(y){if(p.error[y]<h){var b=[],x=[],I=p._vertices[y],D=p._vertices[(y+1)%3];if(I.isBorder||D.isBorder)return"continue";var T=O.Zero();i._calculateError(I,D,T);var C=new Array;if(i._isFlipped(I,D,T,b,C)||i._isFlipped(D,I,T,x,C)||b.indexOf(!0)<0||x.indexOf(!0)<0)return"continue";var B=new Array;if(C.forEach(function(F){B.indexOf(F)===-1&&(F.deletePending=!0,B.push(F))}),B.length%2!==0)return"continue";I.q=D.q.add(I.q),I.updatePosition(T);var V=i._references.length;o=i._updateTriangles(I,I,b,o),o=i._updateTriangles(I,D,x,o);var U=i._references.length-V;if(U<=I.triangleCount){if(U)for(var R=0;R<U;R++)i._references[I.triangleStart+R]=i._references[V+R]}else I.triangleStart=V;return I.triangleCount=U,"break"}},M=0;M<3;++M){var A=m(M);if(A==="break")break}};Ae.SyncAsyncForLoop(i._triangles.length,i.syncIterations,d,l,function(){return s-o<=a})},0)};Ae.Run(this.decimationIterations,function(f){s-o<=a?f.breakLoop():u(f.index,function(){f.executeNext()})},function(){setTimeout(function(){i._reconstructMesh(e),r()},0)})},n.prototype._initWithMesh=function(t,e,r){var i=this;this._vertices=[],this._triangles=[];var a=this._mesh.getVerticesData(_.PositionKind),o=this._mesh.getIndices(),s=this._mesh.subMeshes[t],u=function(h){if(r){for(var d=0;d<i._vertices.length;++d)if(i._vertices[d].position.equalsWithEpsilon(h,1e-4))return i._vertices[d]}return null},f=[],l=function(h){if(!!a){var d=h+s.verticesStart,v=O.FromArray(a,d*3),g=u(v)||new Gr(v,i._vertices.length);g.originalOffsets.push(d),g.id===i._vertices.length&&i._vertices.push(g),f.push(g.id)}},c=s.verticesCount;Ae.SyncAsyncForLoop(c,this.syncIterations/4>>0,l,function(){var h=function(d){if(!!o){var v=s.indexStart/3+d,g=v*3,p=o[g+0],m=o[g+1],M=o[g+2],A=i._vertices[f[p-s.verticesStart]],y=i._vertices[f[m-s.verticesStart]],b=i._vertices[f[M-s.verticesStart]],x=new Zr([A,y,b]);x.originalOffset=g,i._triangles.push(x)}};Ae.SyncAsyncForLoop(s.indexCount/3,i.syncIterations,h,function(){i._init(e)})})},n.prototype._init=function(t){var e=this,r=function(i){var a=e._triangles[i];a.normal=O.Cross(a._vertices[1].position.subtract(a._vertices[0].position),a._vertices[2].position.subtract(a._vertices[0].position)).normalize();for(var o=0;o<3;o++)a._vertices[o].q.addArrayInPlace(lr.DataFromNumbers(a.normal.x,a.normal.y,a.normal.z,-O.Dot(a.normal,a._vertices[0].position)))};Ae.SyncAsyncForLoop(this._triangles.length,this.syncIterations,r,function(){var i=function(a){for(var o=e._triangles[a],s=0;s<3;++s)o.error[s]=e._calculateError(o._vertices[s],o._vertices[(s+1)%3]);o.error[3]=Math.min(o.error[0],o.error[1],o.error[2])};Ae.SyncAsyncForLoop(e._triangles.length,e.syncIterations,i,function(){t()})})},n.prototype._reconstructMesh=function(t){var e=[],r;for(r=0;r<this._vertices.length;++r)this._vertices[r].triangleCount=0;var i,a;for(r=0;r<this._triangles.length;++r)if(!this._triangles[r].deleted){for(i=this._triangles[r],a=0;a<3;++a)i._vertices[a].triangleCount=1;e.push(i)}var o=this._reconstructedMesh.getVerticesData(_.PositionKind)||[],s=this._reconstructedMesh.getVerticesData(_.NormalKind)||[],u=this._reconstructedMesh.getVerticesData(_.UVKind)||[],f=this._reconstructedMesh.getVerticesData(_.ColorKind)||[],l=this._mesh.getVerticesData(_.NormalKind),c=this._mesh.getVerticesData(_.UVKind),h=this._mesh.getVerticesData(_.ColorKind),d=0,v=function(){var x=g._vertices[r];x.id=d,x.triangleCount&&x.originalOffsets.forEach(function(I){o.push(x.position.x),o.push(x.position.y),o.push(x.position.z),l&&l.length&&(s.push(l[I*3]),s.push(l[I*3+1]),s.push(l[I*3+2])),c&&c.length&&(u.push(c[I*2]),u.push(c[I*2+1])),h&&h.length&&(f.push(h[I*4]),f.push(h[I*4+1]),f.push(h[I*4+2]),f.push(h[I*4+3])),++d})},g=this;for(r=0;r<this._vertices.length;++r)v();var p=this._reconstructedMesh.getTotalIndices(),m=this._reconstructedMesh.getTotalVertices(),M=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];var A=this._reconstructedMesh.getIndices(),y=this._mesh.getIndices();for(r=0;r<e.length;++r)i=e[r],[0,1,2].forEach(function(x){var I=y[i.originalOffset+x],D=i._vertices[x].originalOffsets.indexOf(I);D<0&&(D=0),A.push(i._vertices[x].id+D+m)});this._reconstructedMesh.setIndices(A),this._reconstructedMesh.setVerticesData(_.PositionKind,o),s.length>0&&this._reconstructedMesh.setVerticesData(_.NormalKind,s),u.length>0&&this._reconstructedMesh.setVerticesData(_.UVKind,u),f.length>0&&this._reconstructedMesh.setVerticesData(_.ColorKind,f);var b=this._mesh.subMeshes[t];t>0&&(this._reconstructedMesh.subMeshes=[],M.forEach(function(x){pe.AddToMesh(x.materialIndex,x.verticesStart,x.verticesCount,x.indexStart,x.indexCount,x.getMesh())}),pe.AddToMesh(b.materialIndex,m,d,p,e.length*3,this._reconstructedMesh))},n.prototype._initDecimatedMesh=function(){this._reconstructedMesh=new S(this._mesh.name+"Decimated",this._mesh.getScene()),this._reconstructedMesh.material=this._mesh.material,this._reconstructedMesh.parent=this._mesh.parent,this._reconstructedMesh.isVisible=!1,this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId},n.prototype._isFlipped=function(t,e,r,i,a){for(var o=0;o<t.triangleCount;++o){var s=this._triangles[this._references[t.triangleStart+o].triangleId];if(!s.deleted){var u=this._references[t.triangleStart+o].vertexId,f=s._vertices[(u+1)%3],l=s._vertices[(u+2)%3];if(f===e||l===e){i[o]=!0,a.push(s);continue}var c=f.position.subtract(r);c=c.normalize();var h=l.position.subtract(r);if(h=h.normalize(),Math.abs(O.Dot(c,h))>.999)return!0;var d=O.Cross(c,h).normalize();if(i[o]=!1,O.Dot(d,s.normal)<.2)return!0}}return!1},n.prototype._updateTriangles=function(t,e,r,i){for(var a=i,o=0;o<e.triangleCount;++o){var s=this._references[e.triangleStart+o],u=this._triangles[s.triangleId];if(!u.deleted){if(r[o]&&u.deletePending){u.deleted=!0,a++;continue}u._vertices[s.vertexId]=t,u.isDirty=!0,u.error[0]=this._calculateError(u._vertices[0],u._vertices[1])+u.borderFactor/2,u.error[1]=this._calculateError(u._vertices[1],u._vertices[2])+u.borderFactor/2,u.error[2]=this._calculateError(u._vertices[2],u._vertices[0])+u.borderFactor/2,u.error[3]=Math.min(u.error[0],u.error[1],u.error[2]),this._references.push(s)}}return a},n.prototype._identifyBorder=function(){for(var t=0;t<this._vertices.length;++t){var e=[],r=[],i=this._vertices[t],a=void 0;for(a=0;a<i.triangleCount;++a)for(var o=this._triangles[this._references[i.triangleStart+a].triangleId],s=0;s<3;s++){for(var u=0,f=o._vertices[s];u<e.length&&r[u]!==f.id;)++u;u===e.length?(e.push(1),r.push(f.id)):e[u]++}for(a=0;a<e.length;++a)e[a]===1?this._vertices[r[a]].isBorder=!0:this._vertices[r[a]].isBorder=!1}},n.prototype._updateMesh=function(t){t===void 0&&(t=!1);var e;if(!t){var r=[];for(e=0;e<this._triangles.length;++e)this._triangles[e].deleted||r.push(this._triangles[e]);this._triangles=r}for(e=0;e<this._vertices.length;++e)this._vertices[e].triangleCount=0,this._vertices[e].triangleStart=0;var i,a,o;for(e=0;e<this._triangles.length;++e)for(i=this._triangles[e],a=0;a<3;++a)o=i._vertices[a],o.triangleCount++;var s=0;for(e=0;e<this._vertices.length;++e)this._vertices[e].triangleStart=s,s+=this._vertices[e].triangleCount,this._vertices[e].triangleCount=0;var u=new Array(this._triangles.length*3);for(e=0;e<this._triangles.length;++e)for(i=this._triangles[e],a=0;a<3;++a)o=i._vertices[a],u[o.triangleStart+o.triangleCount]=new Yr(a,e),o.triangleCount++;this._references=u,t&&this._identifyBorder()},n.prototype._vertexError=function(t,e){var r=e.x,i=e.y,a=e.z;return t.data[0]*r*r+2*t.data[1]*r*i+2*t.data[2]*r*a+2*t.data[3]*r+t.data[4]*i*i+2*t.data[5]*i*a+2*t.data[6]*i+t.data[7]*a*a+2*t.data[8]*a+t.data[9]},n.prototype._calculateError=function(t,e,r){var i=t.q.add(e.q),a=t.isBorder&&e.isBorder,o=0,s=i.det(0,1,2,1,4,5,2,5,7);if(s!==0&&!a)r||(r=O.Zero()),r.x=-1/s*i.det(1,2,3,4,5,6,5,7,8),r.y=1/s*i.det(0,2,3,1,5,6,2,7,8),r.z=-1/s*i.det(0,1,3,1,4,6,2,5,8),o=this._vertexError(i,r);else{var u=t.position.add(e.position).divide(new O(2,2,2)),f=this._vertexError(i,t.position),l=this._vertexError(i,e.position),c=this._vertexError(i,u);o=Math.min(f,l,c),o===f?r&&r.copyFrom(t.position):o===l?r&&r.copyFrom(e.position):r&&r.copyFrom(u)}return o},n}();Object.defineProperty(bt.prototype,"simplificationQueue",{get:function(){if(!this._simplificationQueue){this._simplificationQueue=new Qr;var n=this._getComponent(ze.NAME_SIMPLIFICATIONQUEUE);n||(n=new kr(this),this._addComponent(n))}return this._simplificationQueue},set:function(n){this._simplificationQueue=n},enumerable:!0,configurable:!0});S.prototype.simplify=function(n,t,e,r){return t===void 0&&(t=!0),e===void 0&&(e=Ke.QUADRATIC),this.getScene().simplificationQueue.addTask({settings:n,parallelProcessing:t,mesh:this,simplificationType:e,successCallback:r}),this};var kr=function(){function n(t){this.name=ze.NAME_SIMPLIFICATIONQUEUE,this.scene=t}return n.prototype.register=function(){this.scene._beforeCameraUpdateStage.registerStep(ze.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE,this,this._beforeCameraUpdate)},n.prototype.rebuild=function(){},n.prototype.dispose=function(){},n.prototype._beforeCameraUpdate=function(){this.scene._simplificationQueue&&!this.scene._simplificationQueue.running&&this.scene._simplificationQueue.executeNext()},n}();S.prototype.thinInstanceAdd=function(n,t){if(t===void 0&&(t=!0),!this.getScene().getEngine().getCaps().instancedArrays)return ue.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(n)?n.length:1);var e=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(n))for(var r=0;r<n.length;++r)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,n[r],r===n.length-1&&t);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,n,t);return e};S.prototype.thinInstanceAddSelf=function(n){return n===void 0&&(n=!0),this.thinInstanceAdd(X.IdentityReadOnly,n)};S.prototype.thinInstanceRegisterAttribute=function(n,t){n===_.ColorKind&&(n=_.ColorInstanceKind),this.removeVerticesData(n),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[n]=t,this._userThinInstanceBuffersStorage.sizes[n]=t*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[n]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[n]),this._userThinInstanceBuffersStorage.vertexBuffers[n]=new _(this.getEngine(),this._userThinInstanceBuffersStorage.data[n],n,!0,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[n])};S.prototype.thinInstanceSetMatrixAt=function(n,t,e){if(e===void 0&&(e=!0),!this._thinInstanceDataStorage.matrixData||n>=this._thinInstanceDataStorage.instancesCount)return!1;var r=this._thinInstanceDataStorage.matrixData;return t.copyToArray(r,n*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[n]=t),e&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0};S.prototype.thinInstanceSetAttributeAt=function(n,t,e,r){return r===void 0&&(r=!0),n===_.ColorKind&&(n=_.ColorInstanceKind),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[n]||t>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(n,0),this._userThinInstanceBuffersStorage.data[n].set(e,t*this._userThinInstanceBuffersStorage.strides[n]),r&&this.thinInstanceBufferUpdated(n),!0)};Object.defineProperty(S.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(n){var t,e,r=(t=this._thinInstanceDataStorage.matrixData)!==null&&t!==void 0?t:(e=this.source)===null||e===void 0?void 0:e._thinInstanceDataStorage.matrixData,i=r?r.length/16:0;n<=i&&(this._thinInstanceDataStorage.instancesCount=n)},enumerable:!0,configurable:!0});S.prototype._thinInstanceCreateMatrixBuffer=function(n,t,e){e===void 0&&(e=!1),n===_.ColorKind&&(n=_.ColorInstanceKind);for(var r=new ke(this.getEngine(),t,!e,16,!1,!0),i=0;i<4;i++)this.setVerticesBuffer(r.createVertexBuffer(n+i,i*4,4));return r};S.prototype.thinInstanceSetBuffer=function(n,t,e,r){var i,a,o;e===void 0&&(e=0),r===void 0&&(r=!1),e=e||16,n==="matrix"?((i=this._thinInstanceDataStorage.matrixBuffer)===null||i===void 0||i.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=t?t.length:32*e,this._thinInstanceDataStorage.matrixData=t,this._thinInstanceDataStorage.worldMatrices=null,t!==null?(this._thinInstanceDataStorage.instancesCount=t.length/e,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",t,r),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):n==="previousMatrix"?((a=this._thinInstanceDataStorage.previousMatrixBuffer)===null||a===void 0||a.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=t,t!==null&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",t,r))):(n===_.ColorKind&&(n=_.ColorInstanceKind),t===null?!((o=this._userThinInstanceBuffersStorage)===null||o===void 0)&&o.data[n]&&(this.removeVerticesData(n),delete this._userThinInstanceBuffersStorage.data[n],delete this._userThinInstanceBuffersStorage.strides[n],delete this._userThinInstanceBuffersStorage.sizes[n],delete this._userThinInstanceBuffersStorage.vertexBuffers[n]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[n]=t,this._userThinInstanceBuffersStorage.strides[n]=e,this._userThinInstanceBuffersStorage.sizes[n]=t.length,this._userThinInstanceBuffersStorage.vertexBuffers[n]=new _(this.getEngine(),t,n,!r,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[n])))};S.prototype.thinInstanceBufferUpdated=function(n){var t,e,r;n==="matrix"?(t=this._thinInstanceDataStorage.matrixBuffer)===null||t===void 0||t.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount):n==="previousMatrix"?(e=this._thinInstanceDataStorage.previousMatrixBuffer)===null||e===void 0||e.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount):(n===_.ColorKind&&(n=_.ColorInstanceKind),!((r=this._userThinInstanceBuffersStorage)===null||r===void 0)&&r.vertexBuffers[n]&&this._userThinInstanceBuffersStorage.vertexBuffers[n].updateDirectly(this._userThinInstanceBuffersStorage.data[n],0))};S.prototype.thinInstancePartialBufferUpdate=function(n,t,e){var r;n==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(t,e):(n===_.ColorKind&&(n=_.ColorInstanceKind),!((r=this._userThinInstanceBuffersStorage)===null||r===void 0)&&r.vertexBuffers[n]&&this._userThinInstanceBuffersStorage.vertexBuffers[n].updateDirectly(t,e))};S.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];var n=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=new Array;for(var t=0;t<this._thinInstanceDataStorage.instancesCount;++t)this._thinInstanceDataStorage.worldMatrices[t]=X.FromArray(n,t*16)}return this._thinInstanceDataStorage.worldMatrices};S.prototype.thinInstanceRefreshBoundingInfo=function(n,t,e){if(n===void 0&&(n=!1),t===void 0&&(t=!1),e===void 0&&(e=!1),!(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)){var r=this._thinInstanceDataStorage.boundingVectors;n&&(r.length=0,this.refreshBoundingInfo(t,e));var i=this.getBoundingInfo(),a=this._thinInstanceDataStorage.matrixData;if(r.length===0)for(var o=0;o<i.boundingBox.vectors.length;++o)r.push(i.boundingBox.vectors[o].clone());z.Vector3[0].setAll(Number.POSITIVE_INFINITY),z.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(var s=0;s<this._thinInstanceDataStorage.instancesCount;++s){X.FromArrayToRef(a,s*16,z.Matrix[0]);for(var o=0;o<r.length;++o)O.TransformCoordinatesToRef(r[o],z.Matrix[0],z.Vector3[2]),z.Vector3[0].minimizeInPlace(z.Vector3[2]),z.Vector3[1].maximizeInPlace(z.Vector3[2])}i.reConstruct(z.Vector3[0],z.Vector3[1]),this._updateBoundingInfo()}};S.prototype._thinInstanceUpdateBufferSize=function(n,t){var e,r,i;t===void 0&&(t=1),n===_.ColorKind&&(n=_.ColorInstanceKind);var a=n==="matrix";if(!(!a&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[n]))){for(var o=a?16:this._userThinInstanceBuffersStorage.strides[n],s=a?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[n],u=a?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[n],f=(this._thinInstanceDataStorage.instancesCount+t)*o,l=s;l<f;)l*=2;if(!u||s!=l){if(!u)u=new Float32Array(l);else{var c=new Float32Array(l);c.set(u,0),u=c}a?((e=this._thinInstanceDataStorage.matrixBuffer)===null||e===void 0||e.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",u,!1),this._thinInstanceDataStorage.matrixData=u,this._thinInstanceDataStorage.matrixBufferSize=l,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&((r=this._thinInstanceDataStorage.previousMatrixBuffer)===null||r===void 0||r.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",u,!1))):((i=this._userThinInstanceBuffersStorage.vertexBuffers[n])===null||i===void 0||i.dispose(),this._userThinInstanceBuffersStorage.data[n]=u,this._userThinInstanceBuffersStorage.sizes[n]=l,this._userThinInstanceBuffersStorage.vertexBuffers[n]=new _(this.getEngine(),u,n,!0,!1,o,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[n]))}}};S.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})};S.prototype._disposeThinInstanceSpecificData=function(){var n;!((n=this._thinInstanceDataStorage)===null||n===void 0)&&n.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)};export{Ze as A,Mt as C,li as D,Xt as E,Oe as G,Vr as I,tt as L,S as M,pe as S,Me as T,Q as V,fi as W,Vt as a,Ct as b,Bt as c,et as d,Zt as e,Gt as f,hi as g,Rt as h,rt as i,Fr as j,it as k,kt as l,Et as m,At as n,ci as o,di as p};
