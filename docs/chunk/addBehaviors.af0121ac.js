import{A as q,V as u,x as I,M as V,P as b,T as d,o as X,J as A,aj as B,ak as Y,i as Q}from"./test1.990751a6.js";import{D as j}from"./directionalLight.f3b3f7c1.js";import{S as K}from"./standardMaterial.fe3baa28.js";import{A as $,C as tt}from"./animation.d3a7fda1.js";import{P as it}from"./physicsImpostor.7ec1beab.js";import{T as rt}from"./clipPlaneVertex.58e6a1d5.js";import{P as et}from"./physicsJoint.16ce030f.js";import{I as ot}from"./material.4eb4d890.js";import{C as H}from"./materialHelper.19d69264.js";import{F as nt,C as at}from"./FollowMouseObj.a4dc814e.js";import"../entry/index.a3769e15.js";import"./node.0c51c0e0.js";import"./light.40a4b08b.js";import"./math.axis.aa7ca8fa.js";import"./effectFallbacks.db57095f.js";import"./imageProcessingFunctions.117736a4.js";import"./instancesDeclaration.872520ba.js";import"./math.size.f34aa5eb.js";import"./abstractMesh.8bf71ac2.js";import"./boundingInfo.71d69726.js";import"./math.functions.ef221795.js";import"./mesh.7b1ddb4e.js";import"./thinMaterialHelper.ab63cfd8.js";var x=function(){function t(r,n,i){i===void 0&&(i=Number.MAX_VALUE),this.origin=r,this.direction=n,this.length=i}return t.prototype.clone=function(){return new t(this.origin.clone(),this.direction.clone(),this.length)},t.prototype.intersectsBoxMinMax=function(r,n,i){i===void 0&&(i=0);var e=t._TmpVector3[0].copyFromFloats(r.x-i,r.y-i,r.z-i),o=t._TmpVector3[1].copyFromFloats(n.x+i,n.y+i,n.z+i),a=0,s=Number.MAX_VALUE,p,c,l,v;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<e.x||this.origin.x>o.x)return!1}else if(p=1/this.direction.x,c=(e.x-this.origin.x)*p,l=(o.x-this.origin.x)*p,l===-1/0&&(l=1/0),c>l&&(v=c,c=l,l=v),a=Math.max(c,a),s=Math.min(l,s),a>s)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<e.y||this.origin.y>o.y)return!1}else if(p=1/this.direction.y,c=(e.y-this.origin.y)*p,l=(o.y-this.origin.y)*p,l===-1/0&&(l=1/0),c>l&&(v=c,c=l,l=v),a=Math.max(c,a),s=Math.min(l,s),a>s)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<e.z||this.origin.z>o.z)return!1}else if(p=1/this.direction.z,c=(e.z-this.origin.z)*p,l=(o.z-this.origin.z)*p,l===-1/0&&(l=1/0),c>l&&(v=c,c=l,l=v),a=Math.max(c,a),s=Math.min(l,s),a>s)return!1;return!0},t.prototype.intersectsBox=function(r,n){return n===void 0&&(n=0),this.intersectsBoxMinMax(r.minimum,r.maximum,n)},t.prototype.intersectsSphere=function(r,n){n===void 0&&(n=0);var i=r.center.x-this.origin.x,e=r.center.y-this.origin.y,o=r.center.z-this.origin.z,a=i*i+e*e+o*o,s=r.radius+n,p=s*s;if(a<=p)return!0;var c=i*this.direction.x+e*this.direction.y+o*this.direction.z;if(c<0)return!1;var l=a-c*c;return l<=p},t.prototype.intersectsTriangle=function(r,n,i){var e=t._TmpVector3[0],o=t._TmpVector3[1],a=t._TmpVector3[2],s=t._TmpVector3[3],p=t._TmpVector3[4];n.subtractToRef(r,e),i.subtractToRef(r,o),u.CrossToRef(this.direction,o,a);var c=u.Dot(e,a);if(c===0)return null;var l=1/c;this.origin.subtractToRef(r,s);var v=u.Dot(s,a)*l;if(v<0||v>1)return null;u.CrossToRef(s,e,p);var y=u.Dot(this.direction,p)*l;if(y<0||v+y>1)return null;var P=u.Dot(o,p)*l;return P>this.length?null:new ot(1-v-y,v,P)},t.prototype.intersectsPlane=function(r){var n,i=u.Dot(r.normal,this.direction);if(Math.abs(i)<999999997475243e-21)return null;var e=u.Dot(r.normal,this.origin);return n=(-r.d-e)/i,n<0?n<-999999997475243e-21?null:0:n},t.prototype.intersectsAxis=function(r,n){switch(n===void 0&&(n=0),r){case"y":{var i=(this.origin.y-n)/this.direction.y;return i>0?null:new u(this.origin.x+this.direction.x*-i,n,this.origin.z+this.direction.z*-i)}case"x":{var i=(this.origin.x-n)/this.direction.x;return i>0?null:new u(n,this.origin.y+this.direction.y*-i,this.origin.z+this.direction.z*-i)}case"z":{var i=(this.origin.z-n)/this.direction.z;return i>0?null:new u(this.origin.x+this.direction.x*-i,this.origin.y+this.direction.y*-i,n)}default:return null}},t.prototype.intersectsMesh=function(r,n){var i=d.Matrix[0];return r.getWorldMatrix().invertToRef(i),this._tmpRay?t.TransformToRef(this,i,this._tmpRay):this._tmpRay=t.Transform(this,i),r.intersects(this._tmpRay,n)},t.prototype.intersectsMeshes=function(r,n,i){i?i.length=0:i=[];for(var e=0;e<r.length;e++){var o=this.intersectsMesh(r[e],n);o.hit&&i.push(o)}return i.sort(this._comparePickingInfo),i},t.prototype._comparePickingInfo=function(r,n){return r.distance<n.distance?-1:r.distance>n.distance?1:0},t.prototype.intersectionSegment=function(r,n,i){var e=this.origin,o=d.Vector3[0],a=d.Vector3[1],s=d.Vector3[2],p=d.Vector3[3];n.subtractToRef(r,o),this.direction.scaleToRef(t._Rayl,s),e.addToRef(s,a),r.subtractToRef(e,p);var c=u.Dot(o,o),l=u.Dot(o,s),v=u.Dot(s,s),y=u.Dot(o,p),P=u.Dot(s,p),w=c*v-l*l,T,E=w,_,h=w;w<t._Smallnum?(T=0,E=1,_=P,h=v):(T=l*P-v*y,_=c*P-l*y,T<0?(T=0,_=P,h=v):T>E&&(T=E,_=P+l,h=v)),_<0?(_=0,-y<0?T=0:-y>c?T=E:(T=-y,E=c)):_>h&&(_=h,-y+l<0?T=0:-y+l>c?T=E:(T=-y+l,E=c));var g=Math.abs(T)<t._Smallnum?0:T/E,k=Math.abs(_)<t._Smallnum?0:_/h,z=d.Vector3[4];s.scaleToRef(k,z);var f=d.Vector3[5];o.scaleToRef(g,f),f.addInPlace(p);var R=d.Vector3[6];f.subtractToRef(z,R);var M=k>0&&k<=this.length&&R.lengthSquared()<i*i;return M?f.length():-1},t.prototype.update=function(r,n,i,e,o,a,s,p){if(p===void 0&&(p=!1),p){t._RayDistant||(t._RayDistant=t.Zero()),t._RayDistant.unprojectRayToRef(r,n,i,e,V.IdentityReadOnly,a,s);var c=d.Matrix[0];o.invertToRef(c),t.TransformToRef(t._RayDistant,c,this)}else this.unprojectRayToRef(r,n,i,e,o,a,s);return this},t.Zero=function(){return new t(u.Zero(),u.Zero())},t.CreateNew=function(r,n,i,e,o,a,s){var p=t.Zero();return p.update(r,n,i,e,o,a,s)},t.CreateNewFromTo=function(r,n,i){i===void 0&&(i=V.IdentityReadOnly);var e=n.subtract(r),o=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);return e.normalize(),t.Transform(new t(r,e,o),i)},t.Transform=function(r,n){var i=new t(new u(0,0,0),new u(0,0,0));return t.TransformToRef(r,n,i),i},t.TransformToRef=function(r,n,i){u.TransformCoordinatesToRef(r.origin,n,i.origin),u.TransformNormalToRef(r.direction,n,i.direction),i.length=r.length;var e=i.direction,o=e.length();if(!(o===0||o===1)){var a=1/o;e.x*=a,e.y*=a,e.z*=a,i.length*=o}},t.prototype.unprojectRayToRef=function(r,n,i,e,o,a,s){var p,c=d.Matrix[0];o.multiplyToRef(a,c),c.multiplyToRef(s,c),c.invert();var l=d.Vector3[0];l.x=r/i*2-1,l.y=-(n/e*2-1),l.z=!((p=X.LastCreatedEngine)===null||p===void 0)&&p.isNDCHalfZRange?0:-1;var v=d.Vector3[1].copyFromFloats(l.x,l.y,1-1e-8),y=d.Vector3[2],P=d.Vector3[3];u._UnprojectFromInvertedMatrixToRef(l,c,y),u._UnprojectFromInvertedMatrixToRef(v,c,P),this.origin.copyFrom(y),P.subtractToRef(y,this.direction),this.direction.normalize()},t._TmpVector3=q.BuildArray(6,u.Zero),t._RayDistant=t.Zero(),t._Smallnum=1e-8,t._Rayl=1e9,t}();I.prototype.createPickingRay=function(t,r,n,i,e){e===void 0&&(e=!1);var o=x.Zero();return this.createPickingRayToRef(t,r,n,o,i,e),o};I.prototype.createPickingRayToRef=function(t,r,n,i,e,o,a){o===void 0&&(o=!1),a===void 0&&(a=!1);var s=this.getEngine();if(!e){if(!this.activeCamera)return this;e=this.activeCamera}var p=e.viewport,c=p.toGlobal(s.getRenderWidth(),s.getRenderHeight());return t=t/s.getHardwareScalingLevel()-c.x,r=r/s.getHardwareScalingLevel()-(s.getRenderHeight()-c.y-c.height),i.update(t,r,c.width,c.height,n||V.IdentityReadOnly,o?V.IdentityReadOnly:e.getViewMatrix(),e.getProjectionMatrix(),a),this};I.prototype.createPickingRayInCameraSpace=function(t,r,n){var i=x.Zero();return this.createPickingRayInCameraSpaceToRef(t,r,i,n),i};I.prototype.createPickingRayInCameraSpaceToRef=function(t,r,n,i){if(!b)return this;var e=this.getEngine();if(!i){if(!this.activeCamera)throw new Error("Active camera not set");i=this.activeCamera}var o=i.viewport,a=o.toGlobal(e.getRenderWidth(),e.getRenderHeight()),s=V.Identity();return t=t/e.getHardwareScalingLevel()-a.x,r=r/e.getHardwareScalingLevel()-(e.getRenderHeight()-a.y-a.height),n.update(t,r,a.width,a.height,s,s,i.getProjectionMatrix()),this};I.prototype._internalPickForMesh=function(t,r,n,i,e,o,a,s){var p=r(i,n.enableDistantPicking),c=n.intersects(p,e,a,o,i,s);return!c||!c.hit||!e&&t!=null&&c.distance>=t.distance?null:c};I.prototype._internalPick=function(t,r,n,i,e){if(!b)return null;for(var o=null,a=0;a<this.meshes.length;a++){var s=this.meshes[a];if(r){if(!r(s))continue}else if(!s.isEnabled()||!s.isVisible||!s.isPickable)continue;var p=s.getWorldMatrix();if(s.hasThinInstances&&s.thinInstanceEnablePicking){var c=this._internalPickForMesh(o,t,s,p,!0,!0,e);if(c){if(i)return c;for(var l=d.Matrix[1],v=s.thinInstanceGetWorldMatrices(),y=0;y<v.length;y++){var P=v[y];P.multiplyToRef(p,l);var w=this._internalPickForMesh(o,t,s,l,n,i,e,!0);if(w&&(o=w,o.thinInstanceIndex=y,n))return o}}}else{var c=this._internalPickForMesh(o,t,s,p,n,i,e);if(c&&(o=c,n))return o}}return o||new b};I.prototype._internalMultiPick=function(t,r,n){if(!b)return null;for(var i=new Array,e=0;e<this.meshes.length;e++){var o=this.meshes[e];if(r){if(!r(o))continue}else if(!o.isEnabled()||!o.isVisible||!o.isPickable)continue;var a=o.getWorldMatrix();if(o.hasThinInstances&&o.thinInstanceEnablePicking){var s=this._internalPickForMesh(null,t,o,a,!0,!0,n);if(s)for(var p=d.Matrix[1],c=o.thinInstanceGetWorldMatrices(),l=0;l<c.length;l++){var v=c[l];v.multiplyToRef(a,p);var y=this._internalPickForMesh(null,t,o,p,!1,!1,n,!0);y&&(y.thinInstanceIndex=l,i.push(y))}}else{var s=this._internalPickForMesh(null,t,o,a,!1,!1,n);s&&i.push(s)}}return i};I.prototype.pickWithBoundingInfo=function(t,r,n,i,e){var o=this;if(!b)return null;var a=this._internalPick(function(s){return o._tempPickingRay||(o._tempPickingRay=x.Zero()),o.createPickingRayToRef(t,r,s,o._tempPickingRay,e||null),o._tempPickingRay},n,i,!0);return a&&(a.ray=this.createPickingRay(t,r,V.Identity(),e||null)),a};I.prototype.pick=function(t,r,n,i,e,o,a){var s=this;if(!b)return null;var p=this._internalPick(function(c,l){return s._tempPickingRay||(s._tempPickingRay=x.Zero()),s.createPickingRayToRef(t,r,c,s._tempPickingRay,e||null,!1,l),s._tempPickingRay},n,i,!1,o);return p&&(p.ray=this.createPickingRay(t,r,V.Identity(),e||null)),p};I.prototype.pickWithRay=function(t,r,n,i){var e=this,o=this._internalPick(function(a){return e._pickWithRayInverseMatrix||(e._pickWithRayInverseMatrix=V.Identity()),a.invertToRef(e._pickWithRayInverseMatrix),e._cachedRayForTransform||(e._cachedRayForTransform=x.Zero()),x.TransformToRef(t,e._pickWithRayInverseMatrix,e._cachedRayForTransform),e._cachedRayForTransform},r,n,!1,i);return o&&(o.ray=t),o};I.prototype.multiPick=function(t,r,n,i,e){var o=this;return this._internalMultiPick(function(a){return o.createPickingRay(t,r,a,i||null)},n,e)};I.prototype.multiPickWithRay=function(t,r,n){var i=this;return this._internalMultiPick(function(e){return i._pickWithRayInverseMatrix||(i._pickWithRayInverseMatrix=V.Identity()),e.invertToRef(i._pickWithRayInverseMatrix),i._cachedRayForTransform||(i._cachedRayForTransform=x.Zero()),x.TransformToRef(t,i._pickWithRayInverseMatrix,i._cachedRayForTransform),i._cachedRayForTransform},r,n)};H.prototype.getForwardRay=function(t,r,n){return t===void 0&&(t=100),this.getForwardRayToRef(new x(u.Zero(),u.Zero(),t),t,r,n)};H.prototype.getForwardRayToRef=function(t,r,n,i){return r===void 0&&(r=100),n||(n=this.getWorldMatrix()),t.length=r,i?t.origin.copyFrom(i):t.origin.copyFrom(this.position),d.Vector3[2].set(0,0,this._scene.useRightHandedSystem?-1:1),u.TransformNormalToRef(d.Vector3[2],n,d.Vector3[3]),u.NormalizeToRef(d.Vector3[3],t.direction),t};const st={CreateSphere:at},m={Color3:Q,Vector3:u,DirectionalLight:j,StandardMaterial:K,MeshBuilder:st,Animation:$,CubicEase:tt,PhysicsImpostor:it,Texture:rt,PhysicsJoint:et,PointerEventTypes:A};var Ft=(t,r,n)=>{let i;(h=>{h[h.None=0]="None",h[h.Static=1]="Static",h[h.Spring=2]="Spring"})(i||(i={}));let e=0;const o=nt.getInstance(t);let a,s=0,p,c=!1,l;t.onPointerObservable.add(h=>{var g,k,z;if(e===2||e===0)switch(h.type){case A.POINTERDOWN:(a==null?void 0:a.physicsImpostor)&&o.mesh.physicsImpostor&&l&&((g=t.getPhysicsEngine())==null||g.removeJoint(a.physicsImpostor,o.mesh.physicsImpostor,l),c=!1);const f=t.pick(t.pointerX,t.pointerY,R=>r.some(M=>M.mesh===R),!1);if(a=(f==null?void 0:f.pickedMesh)||null,a&&a.rotationQuaternion&&(f==null?void 0:f.pickedPoint)){let R=f.pickedPoint.subtract(a.getAbsolutePosition()).applyRotationQuaternion(a.rotationQuaternion.invert());l=new m.PhysicsJoint(m.PhysicsJoint.SpringJoint,{length:0,stiffness:-B*3,damping:-B,collision:!1,mainPivot:R}),p=()=>{var M;c||o.mesh.physicsImpostor&&l&&((M=a==null?void 0:a.physicsImpostor)==null||M.addJoint(o.mesh.physicsImpostor,l),c=!0)}}break;case m.PointerEventTypes.POINTERMOVE:a&&p();break;case m.PointerEventTypes.POINTERUP:(a==null?void 0:a.physicsImpostor)&&o.mesh.physicsImpostor&&l&&((k=t.getPhysicsEngine())==null||k.removeJoint(a.physicsImpostor,o.mesh.physicsImpostor,l),c=!1),a=null;break}switch(h.type){case m.PointerEventTypes.POINTERDOWN:s=performance.now();break;case m.PointerEventTypes.POINTERUP:if(performance.now()-s<150){const f=t.pick(t.pointerX,t.pointerY,R=>r.some(M=>M.mesh===R),!1);(f==null?void 0:f.pickedMesh)&&f.ray&&(f==null?void 0:f.pickedPoint)&&t.activeCamera&&((z=f.pickedMesh.physicsImpostor)==null||z.applyImpulse(f.ray.origin.normalize().scale(-15),f.pickedPoint),n.particleSystem.emitter=o.mesh.position.clone().add(t.activeCamera.position.subtract(f.pickedPoint).normalize().scale(Y/2)),n.particleSystem.start())}break}if(e===1)switch(h.type){case m.PointerEventTypes.POINTERDOWN:const f=t.pick(t.pointerX,t.pointerY,R=>r.some(M=>M.mesh===R),!1);(f==null?void 0:f.pickedMesh)&&(f==null?void 0:f.pickedPoint)&&(a=f==null?void 0:f.pickedMesh);break;case m.PointerEventTypes.POINTERMOVE:a&&(a.position=o.mesh.position.clone());break;case m.PointerEventTypes.POINTERUP:a=null;break}});const v=[[0,11,-3],[0,11,-1],[0,9,1],[0,9,-1],[0,7,1],[0,7,3],[0,11,-5],[0,9,-5],[0,7,-5],[0,11,5],[0,9,5],[0,7,5]],y=h=>{e=h?1:2,h?r.forEach((g,k)=>{g.lockObj({position:v[k],rotation:[0,0,0]})}):r.forEach(g=>{g.lockObj()})},P=()=>{var g;const h=document.createElement("input");h.type="button",h.id="lockStaticPositionBtn",h.style.display="block",h.value="\u9759\u6001\u9489\u4F4F",h.onclick=()=>{y(!0)},(g=document.getElementById("controls"))==null||g.append(h)};setTimeout(()=>{P()},3e3);let w=[];const T=h=>{var k,z;if(e=2,w.forEach(f=>{var R,M;f.mainMesh.physicsImpostor&&f.pointMesh.physicsImpostor&&f.joint&&((R=t.getPhysicsEngine())==null||R.removeJoint(f.mainMesh.physicsImpostor,f.pointMesh.physicsImpostor,f.joint)),(M=f.pointMesh)==null||M.dispose(),f.mainMesh.physicsImpostor&&(f.mainMesh.physicsImpostor.friction=1)}),(k=t.getPhysicsEngine())==null||k.setGravity(new m.Vector3(0,B,0)),t.getEngine(),!h)return;(z=t.getPhysicsEngine())==null||z.setGravity(new m.Vector3(0,0,0)),[new m.Vector3(0,12,-6),new m.Vector3(0,12,0),new m.Vector3(0,12,6),new m.Vector3(0,8,-4),new m.Vector3(0,8,4),new m.Vector3(0,4,0)].forEach((f,R)=>{const D=f.clone();D.y+=4,D.z-=4;const N=f.clone();N.y+=4,N.z+=4;const C=f.clone();C.y-=4,C.z-=4;const W=f.clone();W.y-=4,W.z+=4;const L=[D,N,C,W],S=1,O=[new m.Vector3(0,S,-S),new m.Vector3(0,S,S),new m.Vector3(0,-S,-S),new m.Vector3(0,-S,S)];L.forEach((U,G)=>{var J;const Z=new m.PhysicsJoint(m.PhysicsJoint.SpringJoint,{length:0,stiffness:4,damping:3,collision:!1,mainPivot:O[G]}),F=m.MeshBuilder.CreateSphere("FollowMouseObj",{segments:1},t);F.isVisible=!1,F.physicsImpostor=new m.PhysicsImpostor(F,m.PhysicsImpostor.NoImpostor,{mass:0,restitution:0},t),F.physicsImpostor.physicsBody.collisionFilterMask=0,F.position=U,F.physicsImpostor&&((J=r[R].mesh.physicsImpostor)==null||J.addJoint(F.physicsImpostor,Z)),r[R].mesh.physicsImpostor&&(r[R].mesh.physicsImpostor.friction=0),w.push({mainMesh:r[R].mesh,pointMesh:F,joint:Z})})})},E=()=>{var g;const h=document.createElement("input");h.type="button",h.id="stickPositionBtn",h.style.display="block",h.value="\u5F39\u6027\u9489\u4F4F+\u65E0\u91CD\u529B\u6F02\u6D6E",h.onclick=()=>{y(!1),T(!0)},(g=document.getElementById("controls"))==null||g.append(h)};setTimeout(()=>{E()},3e3);const _=()=>{var g;const h=document.createElement("input");h.type="button",h.id="addNormalPhysicsControl",h.style.display="block",h.value="\u6389\u843D",h.onclick=()=>{T(!1),y(!1)},(g=document.getElementById("controls"))==null||g.append(h)};setTimeout(()=>{_()},3e3)};export{Ft as default};
