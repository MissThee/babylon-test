import{P as m,T as d,_ as v,a as R,I as p,W as A,b as P,c as F,L as b,d as y,e as S,O as E}from"./precisionDate.1704d4c6.js";import{E as T}from"./performanceConfigurator.ee04355d.js";import{P as L}from"./perfCounter.4442bbd7.js";import"./engine.dynamicBuffer.fe9de623.js";var C=function(){function c(e){e===void 0&&(e=30),this._enabled=!0,this._rollingFrameTime=new U(e)}return c.prototype.sampleFrame=function(e){if(e===void 0&&(e=m.Now),!!this._enabled){if(this._lastFrameTimeMs!=null){var t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}},Object.defineProperty(c.prototype,"averageFrameTime",{get:function(){return this._rollingFrameTime.average},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"averageFrameTimeVariance",{get:function(){return this._rollingFrameTime.variance},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"instantaneousFrameTime",{get:function(){return this._rollingFrameTime.history(0)},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"averageFPS",{get:function(){return 1e3/this._rollingFrameTime.average},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"instantaneousFPS",{get:function(){var e=this._rollingFrameTime.history(0);return e===0?0:1e3/e},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"isSaturated",{get:function(){return this._rollingFrameTime.isSaturated()},enumerable:!1,configurable:!0}),c.prototype.enable=function(){this._enabled=!0},c.prototype.disable=function(){this._enabled=!1,this._lastFrameTimeMs=null},Object.defineProperty(c.prototype,"isEnabled",{get:function(){return this._enabled},enumerable:!1,configurable:!0}),c.prototype.reset=function(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()},c}(),U=function(){function c(e){this._samples=new Array(e),this.reset()}return c.prototype.add=function(e){var t;if(this.isSaturated()){var r=this._samples[this._pos];t=r-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(r-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length},c.prototype.history=function(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;var t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]},c.prototype.isSaturated=function(){return this._sampleCount>=this._samples.length},c.prototype.reset=function(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0},c.prototype._wrapPosition=function(e){var t=this._samples.length;return(e%t+t)%t},c}();function I(c,e,t,r){switch(t===void 0&&(t=!1),c){case 3:{var i=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e);return r&&i.set(new Int8Array(r)),i}case 0:{var o=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return r&&o.set(new Uint8Array(r)),o}case 4:{var n=e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(t?e/2:e);return r&&n.set(new Int16Array(r)),n}case 5:case 8:case 9:case 10:case 2:{var s=e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(t?e/2:e);return r&&s.set(new Uint16Array(r)),s}case 6:{var a=e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(t?e/4:e);return r&&a.set(new Int32Array(r)),a}case 7:case 11:case 12:case 13:case 14:case 15:{var l=e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(t?e/4:e);return r&&l.set(new Uint32Array(r)),l}case 1:{var _=e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(t?e/4:e);return r&&_.set(new Float32Array(r)),_}}var h=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return r&&h.set(new Uint8Array(r)),h}d.prototype._readTexturePixelsSync=function(c,e,t,r,i,o,n,s,a,l){var _,h;r===void 0&&(r=-1),i===void 0&&(i=0),o===void 0&&(o=null),n===void 0&&(n=!0),s===void 0&&(s=!1),a===void 0&&(a=0),l===void 0&&(l=0);var u=this._gl;if(!u)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){var g=u.createFramebuffer();if(!g)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=g}u.bindFramebuffer(u.FRAMEBUFFER,this._dummyFramebuffer),r>-1?u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_CUBE_MAP_POSITIVE_X+r,(_=c._hardwareTexture)===null||_===void 0?void 0:_.underlyingResource,i):u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_2D,(h=c._hardwareTexture)===null||h===void 0?void 0:h.underlyingResource,i);var f=c.type!==void 0?this._getWebGLTextureType(c.type):u.UNSIGNED_BYTE;if(s)o||(o=I(c.type,4*e*t));else switch(f){case u.UNSIGNED_BYTE:o||(o=new Uint8Array(4*e*t)),f=u.UNSIGNED_BYTE;break;default:o||(o=new Float32Array(4*e*t)),f=u.FLOAT;break}return n&&this.flushFramebuffer(),u.readPixels(a,l,e,t,u.RGBA,f,o),u.bindFramebuffer(u.FRAMEBUFFER,this._currentFramebuffer),o};d.prototype._readTexturePixels=function(c,e,t,r,i,o,n,s,a,l){return r===void 0&&(r=-1),i===void 0&&(i=0),o===void 0&&(o=null),n===void 0&&(n=!0),s===void 0&&(s=!1),a===void 0&&(a=0),l===void 0&&(l=0),Promise.resolve(this._readTexturePixelsSync(c,e,t,r,i,o,n,s,a,l))};var D=function(c){v(e,c);function e(t,r,i,o){o===void 0&&(o=!1);var n=c.call(this,t,r,i,o)||this;if(n.enableOfflineSupport=!1,n.disableManifestCheck=!1,n.disableContextMenu=!0,n.scenes=new Array,n._virtualScenes=new Array,n.onNewSceneAddedObservable=new E,n.postProcesses=new Array,n.isPointerLock=!1,n.onResizeObservable=new E,n.onCanvasBlurObservable=new E,n.onCanvasFocusObservable=new E,n.onCanvasPointerOutObservable=new E,n.onBeginFrameObservable=new E,n.customAnimationFrameRequester=null,n.onEndFrameObservable=new E,n.onBeforeShaderCompilationObservable=new E,n.onAfterShaderCompilationObservable=new E,n._deterministicLockstep=!1,n._lockstepMaxSteps=4,n._timeStep=1/60,n._fps=60,n._deltaTime=0,n._drawCalls=new L,n.canvasTabIndex=1,n.disablePerformanceMonitorInBackground=!1,n._performanceMonitor=new C,n._compatibilityMode=!0,n.currentRenderPassId=0,n._renderPassNames=["main"],e.Instances.push(n),!t)return n;if(n._features.supportRenderPasses=!0,i=n._creationOptions,t.getContext){var s=t;if(n._sharedInit(s,!!i.doNotHandleTouchAction,i.audioEngine),p()){var a=document;n._onFullscreenChange=function(){a.fullscreen!==void 0?n.isFullscreen=a.fullscreen:a.mozFullScreen!==void 0?n.isFullscreen=a.mozFullScreen:a.webkitIsFullScreen!==void 0?n.isFullscreen=a.webkitIsFullScreen:a.msIsFullScreen!==void 0&&(n.isFullscreen=a.msIsFullScreen),n.isFullscreen&&n._pointerLockRequested&&s&&e._RequestPointerlock(s)},document.addEventListener("fullscreenchange",n._onFullscreenChange,!1),document.addEventListener("mozfullscreenchange",n._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",n._onFullscreenChange,!1),document.addEventListener("msfullscreenchange",n._onFullscreenChange,!1),n._onPointerLockChange=function(){n.isPointerLock=a.mozPointerLockElement===s||a.webkitPointerLockElement===s||a.msPointerLockElement===s||a.pointerLockElement===s},document.addEventListener("pointerlockchange",n._onPointerLockChange,!1),document.addEventListener("mspointerlockchange",n._onPointerLockChange,!1),document.addEventListener("mozpointerlockchange",n._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",n._onPointerLockChange,!1),!e.audioEngine&&i.audioEngine&&e.AudioEngineFactory&&(e.audioEngine=e.AudioEngineFactory(n.getRenderingCanvas(),n.getAudioContext(),n.getAudioDestination()))}n._connectVREvents(),n.enableOfflineSupport=e.OfflineProviderFactory!==void 0,n._deterministicLockstep=!!i.deterministicLockstep,n._lockstepMaxSteps=i.lockstepMaxSteps||0,n._timeStep=i.timeStep||1/60}return n._prepareVRComponent(),i.autoEnableWebVR&&n.initWebVR(),n}return Object.defineProperty(e,"NpmPackage",{get:function(){return d.NpmPackage},enumerable:!1,configurable:!0}),Object.defineProperty(e,"Version",{get:function(){return d.Version},enumerable:!1,configurable:!0}),Object.defineProperty(e,"Instances",{get:function(){return T.Instances},enumerable:!1,configurable:!0}),Object.defineProperty(e,"LastCreatedEngine",{get:function(){return T.LastCreatedEngine},enumerable:!1,configurable:!0}),Object.defineProperty(e,"LastCreatedScene",{get:function(){return T.LastCreatedScene},enumerable:!1,configurable:!0}),e.prototype._createImageBitmapFromSource=function(t,r){var i=this,o=new Promise(function(n,s){var a=new Image;a.onload=function(){a.decode().then(function(){i.createImageBitmap(a,r).then(function(l){n(l)})})},a.onerror=function(){s("Error loading image ".concat(a.src))},a.src=t});return o},e.prototype.createImageBitmap=function(t,r){return createImageBitmap(t,r)},e.prototype.resizeImageBitmap=function(t,r,i){var o=this.createCanvas(r,i),n=o.getContext("2d");if(!n)throw new Error("Unable to get 2d context for resizeImageBitmap");n.drawImage(t,0,0);var s=n.getImageData(0,0,r,i).data;return s},e.MarkAllMaterialsAsDirty=function(t,r){for(var i=0;i<e.Instances.length;i++)for(var o=e.Instances[i],n=0;n<o.scenes.length;n++)o.scenes[n].markAllMaterialsAsDirty(t,r)},e.DefaultLoadingScreenFactory=function(t){throw R("LoadingScreen")},Object.defineProperty(e.prototype,"_supportsHardwareTextureRescaling",{get:function(){return!!e._RescalePostProcessFactory},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"performanceMonitor",{get:function(){return this._performanceMonitor},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"compatibilityMode",{get:function(){return this._compatibilityMode},set:function(t){this._compatibilityMode=!0},enumerable:!1,configurable:!0}),e.prototype.getInputElement=function(){return this._renderingCanvas},e.prototype._sharedInit=function(t,r,i){var o=this;if(c.prototype._sharedInit.call(this,t,r,i),this._onCanvasFocus=function(){o.onCanvasFocusObservable.notifyObservers(o)},this._onCanvasBlur=function(){o.onCanvasBlurObservable.notifyObservers(o)},this._onCanvasContextMenu=function(s){o.disableContextMenu&&s.preventDefault()},t.addEventListener("focus",this._onCanvasFocus),t.addEventListener("blur",this._onCanvasBlur),t.addEventListener("contextmenu",this._onCanvasContextMenu),this._onBlur=function(){o.disablePerformanceMonitorInBackground&&o._performanceMonitor.disable(),o._windowIsBackground=!0},this._onFocus=function(){o.disablePerformanceMonitorInBackground&&o._performanceMonitor.enable(),o._windowIsBackground=!1},this._onCanvasPointerOut=function(s){document.elementFromPoint(s.clientX,s.clientY)!==t&&o.onCanvasPointerOutObservable.notifyObservers(s)},p()){var n=this.getHostWindow();n&&(n.addEventListener("blur",this._onBlur),n.addEventListener("focus",this._onFocus))}t.addEventListener("pointerout",this._onCanvasPointerOut),r||this._disableTouchAction(),!e.audioEngine&&i&&e.AudioEngineFactory&&(e.audioEngine=e.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination()))},e.prototype.getAspectRatio=function(t,r){r===void 0&&(r=!1);var i=t.viewport;return this.getRenderWidth(r)*i.width/(this.getRenderHeight(r)*i.height)},e.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},e.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},e.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},e.prototype.isDeterministicLockStep=function(){return this._deterministicLockstep},e.prototype.getLockstepMaxSteps=function(){return this._lockstepMaxSteps},e.prototype.getTimeStep=function(){return this._timeStep*1e3},e.prototype.generateMipMapsForCubemap=function(t,r){if(r===void 0&&(r=!0),t.generateMipMaps){var i=this._gl;this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,t,!0),i.generateMipmap(i.TEXTURE_CUBE_MAP),r&&this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)}},e.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},e.prototype.setDepthWrite=function(t){this._depthCullingState.depthMask=t},e.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},e.prototype.setStencilBuffer=function(t){this._stencilState.stencilTest=t},e.prototype.getStencilMask=function(){return this._stencilState.stencilMask},e.prototype.setStencilMask=function(t){this._stencilState.stencilMask=t},e.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},e.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},e.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},e.prototype.setStencilFunction=function(t){this._stencilState.stencilFunc=t},e.prototype.setStencilFunctionReference=function(t){this._stencilState.stencilFuncRef=t},e.prototype.setStencilFunctionMask=function(t){this._stencilState.stencilFuncMask=t},e.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},e.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},e.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},e.prototype.setStencilOperationFail=function(t){this._stencilState.stencilOpStencilFail=t},e.prototype.setStencilOperationDepthFail=function(t){this._stencilState.stencilOpDepthFail=t},e.prototype.setStencilOperationPass=function(t){this._stencilState.stencilOpStencilDepthPass=t},e.prototype.setDitheringState=function(t){t?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)},e.prototype.setRasterizerState=function(t){t?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)},e.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},e.prototype.setDepthFunction=function(t){this._depthCullingState.depthFunc=t},e.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},e.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},e.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},e.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},e.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},e.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)},e.prototype.setDirectViewport=function(t,r,i,o){var n=this._cachedViewport;return this._cachedViewport=null,this._viewport(t,r,i,o),n},e.prototype.scissorClear=function(t,r,i,o,n){this.enableScissor(t,r,i,o),this.clear(n,!0,!0,!0),this.disableScissor()},e.prototype.enableScissor=function(t,r,i,o){var n=this._gl;n.enable(n.SCISSOR_TEST),n.scissor(t,r,i,o)},e.prototype.disableScissor=function(){var t=this._gl;t.disable(t.SCISSOR_TEST)},e.prototype._reportDrawCall=function(t){t===void 0&&(t=1),this._drawCalls.addCount(t,!1)},e.prototype.initWebVR=function(){throw R("WebVRCamera")},e.prototype._prepareVRComponent=function(){},e.prototype._connectVREvents=function(t,r){},e.prototype._submitVRFrame=function(){},e.prototype.disableVR=function(){},e.prototype.isVRPresenting=function(){return!1},e.prototype._requestVRFrame=function(){},e.prototype._loadFileAsync=function(t,r,i){var o=this;return new Promise(function(n,s){o._loadFile(t,function(a){n(a)},void 0,r,i,function(a,l){s(l)})})},e.prototype.getVertexShaderSource=function(t){var r=this._gl.getAttachedShaders(t);return r?this._gl.getShaderSource(r[0]):null},e.prototype.getFragmentShaderSource=function(t){var r=this._gl.getAttachedShaders(t);return r?this._gl.getShaderSource(r[1]):null},e.prototype.setDepthStencilTexture=function(t,r,i,o){t!==void 0&&(r&&(this._boundUniforms[t]=r),!i||!i.depthStencilTexture?this._setTexture(t,null,void 0,void 0,o):this._setTexture(t,i,!1,!0,o))},e.prototype.setTextureFromPostProcess=function(t,r,i){var o,n=null;r&&(r._textures.data[r._currentRenderTextureInd]?n=r._textures.data[r._currentRenderTextureInd]:r._forcedOutputTexture&&(n=r._forcedOutputTexture)),this._bindTexture(t,(o=n==null?void 0:n.texture)!==null&&o!==void 0?o:null,i)},e.prototype.setTextureFromPostProcessOutput=function(t,r,i){var o,n;this._bindTexture(t,(n=(o=r==null?void 0:r._outputTexture)===null||o===void 0?void 0:o.texture)!==null&&n!==void 0?n:null,i)},e.prototype._rebuildBuffers=function(){for(var t=0,r=this.scenes;t<r.length;t++){var i=r[t];i.resetCachedMaterial(),i._rebuildGeometries(),i._rebuildTextures()}for(var o=0,n=this._virtualScenes;o<n.length;o++){var i=n[o];i.resetCachedMaterial(),i._rebuildGeometries(),i._rebuildTextures()}c.prototype._rebuildBuffers.call(this)},e.prototype._renderFrame=function(){for(var t=0;t<this._activeRenderLoops.length;t++){var r=this._activeRenderLoops[t];r()}},e.prototype._renderLoop=function(){if(!this._contextWasLost){var t=!0;!this.renderEvenInBackground&&this._windowIsBackground&&(t=!1),t&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this.isVRPresenting()?this._requestVRFrame():this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1},e.prototype._renderViews=function(){return!1},e.prototype.switchFullscreen=function(t){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(t)},e.prototype.enterFullscreen=function(t){this.isFullscreen||(this._pointerLockRequested=t,this._renderingCanvas&&e._RequestFullscreen(this._renderingCanvas))},e.prototype.exitFullscreen=function(){this.isFullscreen&&e._ExitFullscreen()},e.prototype.enterPointerlock=function(){this._renderingCanvas&&e._RequestPointerlock(this._renderingCanvas)},e.prototype.exitPointerlock=function(){e._ExitPointerlock()},e.prototype.beginFrame=function(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),c.prototype.beginFrame.call(this)},e.prototype.endFrame=function(){c.prototype.endFrame.call(this),this._submitVRFrame(),this.onEndFrameObservable.notifyObservers(this)},e.prototype.resize=function(t){t===void 0&&(t=!1),!this.isVRPresenting()&&c.prototype.resize.call(this,t)},e.prototype.setSize=function(t,r,i){if(i===void 0&&(i=!1),!this._renderingCanvas||!c.prototype.setSize.call(this,t,r,i))return!1;if(this.scenes){for(var o=0;o<this.scenes.length;o++)for(var n=this.scenes[o],s=0;s<n.cameras.length;s++){var a=n.cameras[s];a._currentRenderId=0}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0},e.prototype._deletePipelineContext=function(t){var r=t;r&&r.program&&r.transformFeedback&&(this.deleteTransformFeedback(r.transformFeedback),r.transformFeedback=null),c.prototype._deletePipelineContext.call(this,t)},e.prototype.createShaderProgram=function(t,r,i,o,n,s){s===void 0&&(s=null),n=n||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);var a=c.prototype.createShaderProgram.call(this,t,r,i,o,n,s);return this.onAfterShaderCompilationObservable.notifyObservers(this),a},e.prototype._createShaderProgram=function(t,r,i,o,n){n===void 0&&(n=null);var s=o.createProgram();if(t.program=s,!s)throw new Error("Unable to create program");if(o.attachShader(s,r),o.attachShader(s,i),this.webGLVersion>1&&n){var a=this.createTransformFeedback();this.bindTransformFeedback(a),this.setTranformFeedbackVaryings(s,n),t.transformFeedback=a}return o.linkProgram(s),this.webGLVersion>1&&n&&this.bindTransformFeedback(null),t.context=o,t.vertexShader=r,t.fragmentShader=i,t.isParallelCompiled||this._finalizePipelineContext(t),s},e.prototype._releaseTexture=function(t){c.prototype._releaseTexture.call(this,t)},e.prototype._releaseRenderTargetWrapper=function(t){c.prototype._releaseRenderTargetWrapper.call(this,t),this.scenes.forEach(function(r){r.postProcesses.forEach(function(i){i._outputTexture===t&&(i._outputTexture=null)}),r.cameras.forEach(function(i){i._postProcesses.forEach(function(o){o&&o._outputTexture===t&&(o._outputTexture=null)})})})},e.prototype.getRenderPassNames=function(){return this._renderPassNames},e.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},e.prototype.createRenderPassId=function(t){var r=++e._RenderPassIdCounter;return this._renderPassNames[r]=t!=null?t:"NONAME",r},e.prototype.releaseRenderPassId=function(t){this._renderPassNames[t]=void 0;for(var r=0;r<this.scenes.length;++r)for(var i=this.scenes[r],o=0;o<i.meshes.length;++o){var n=i.meshes[o];if(n.subMeshes)for(var s=0;s<n.subMeshes.length;++s){var a=n.subMeshes[s];a._removeDrawWrapper(t)}}},e.prototype._rescaleTexture=function(t,r,i,o,n){var s=this;this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);var a=this.createRenderTargetTexture({width:r.width,height:r.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&e._RescalePostProcessFactory&&(this._rescalePostProcess=e._RescalePostProcessFactory(this)),this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled(function(){s._rescalePostProcess.onApply=function(_){_._bindTexture("textureSampler",t)};var l=i;l||(l=s.scenes[s.scenes.length-1]),l.postProcessManager.directRender([s._rescalePostProcess],a,!0),s._bindTextureDirectly(s._gl.TEXTURE_2D,r,!0),s._gl.copyTexImage2D(s._gl.TEXTURE_2D,0,o,0,0,r.width,r.height,0),s.unBindFramebuffer(a),a.dispose(),n&&n()})},e.prototype.getFps=function(){return this._fps},e.prototype.getDeltaTime=function(){return this._deltaTime},e.prototype._measureFps=function(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0},e.prototype.wrapWebGLTexture=function(t){var r=new A(t,this._gl),i=new P(this,F.Unknown,!0);return i._hardwareTexture=r,i.isReady=!0,i},e.prototype._uploadImageToTexture=function(t,r,i,o){i===void 0&&(i=0),o===void 0&&(o=0);var n=this._gl,s=this._getWebGLTextureType(t.type),a=this._getInternalFormat(t.format),l=this._getRGBABufferInternalSizedFormat(t.type,a),_=t.isCube?n.TEXTURE_CUBE_MAP:n.TEXTURE_2D;this._bindTextureDirectly(_,t,!0),this._unpackFlipY(t.invertY);var h=n.TEXTURE_2D;t.isCube&&(h=n.TEXTURE_CUBE_MAP_POSITIVE_X+i),n.texImage2D(h,o,l,a,s,r),this._bindTextureDirectly(_,null,!0)},e.prototype.updateTextureComparisonFunction=function(t,r){if(this.webGLVersion===1){b.Error("WebGL 1 does not support texture comparison.");return}var i=this._gl;t.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,t,!0),r===0?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,r),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),r===0?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),t._comparisonFunction=r},e.prototype.createInstancesBuffer=function(t){var r=this._gl.createBuffer();if(!r)throw new Error("Unable to create instance buffer");var i=new y(r);return i.capacity=t,this.bindArrayBuffer(i),this._gl.bufferData(this._gl.ARRAY_BUFFER,t,this._gl.DYNAMIC_DRAW),i.references=1,i},e.prototype.deleteInstancesBuffer=function(t){this._gl.deleteBuffer(t)},e.prototype._clientWaitAsync=function(t,r,i){r===void 0&&(r=0),i===void 0&&(i=10);var o=this._gl;return new Promise(function(n,s){var a=function(){var l=o.clientWaitSync(t,r,0);if(l==o.WAIT_FAILED){s();return}if(l==o.TIMEOUT_EXPIRED){setTimeout(a,i);return}n()};a()})},e.prototype._readPixelsAsync=function(t,r,i,o,n,s,a){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");var l=this._gl,_=l.createBuffer();l.bindBuffer(l.PIXEL_PACK_BUFFER,_),l.bufferData(l.PIXEL_PACK_BUFFER,a.byteLength,l.STREAM_READ),l.readPixels(t,r,i,o,n,s,0),l.bindBuffer(l.PIXEL_PACK_BUFFER,null);var h=l.fenceSync(l.SYNC_GPU_COMMANDS_COMPLETE,0);return h?(l.flush(),this._clientWaitAsync(h,0,10).then(function(){return l.deleteSync(h),l.bindBuffer(l.PIXEL_PACK_BUFFER,_),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,a),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),l.deleteBuffer(_),a})):null},e.prototype.dispose=function(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();e.Instances.length===1&&e.audioEngine&&(e.audioEngine.dispose(),e.audioEngine=null),this.disableVR(),p()&&(window.removeEventListener("blur",this._onBlur),window.removeEventListener("focus",this._onFocus),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut),this._renderingCanvas.removeEventListener("contextmenu",this._onCanvasContextMenu)),S()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange))),c.prototype.dispose.call(this);var t=e.Instances.indexOf(this);t>=0&&e.Instances.splice(t,1),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()},e.prototype._disableTouchAction=function(){!this._renderingCanvas||!this._renderingCanvas.setAttribute||(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.msTouchAction="none",this._renderingCanvas.style.webkitTapHighlightColor="transparent")},e.prototype.displayLoadingUI=function(){if(!!p()){var t=this.loadingScreen;t&&t.displayLoadingUI()}},e.prototype.hideLoadingUI=function(){if(!!p()){var t=this._loadingScreen;t&&t.hideLoadingUI()}},Object.defineProperty(e.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=e.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(t){this._loadingScreen=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loadingUIText",{set:function(t){this.loadingScreen.loadingUIText=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loadingUIBackgroundColor",{set:function(t){this.loadingScreen.loadingUIBackgroundColor=t},enumerable:!1,configurable:!0}),e.prototype.createVideoElement=function(t){return document.createElement("video")},e._RequestPointerlock=function(t){t.requestPointerLock=t.requestPointerLock||t.msRequestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock,t.requestPointerLock&&(t.requestPointerLock(),t.focus())},e._ExitPointerlock=function(){var t=document;document.exitPointerLock=document.exitPointerLock||t.msExitPointerLock||t.mozExitPointerLock||t.webkitExitPointerLock,document.exitPointerLock&&document.exitPointerLock()},e._RequestFullscreen=function(t){var r=t.requestFullscreen||t.msRequestFullscreen||t.webkitRequestFullscreen||t.mozRequestFullScreen;!r||r.call(t)},e._ExitFullscreen=function(){var t=document;document.exitFullscreen?document.exitFullscreen():t.mozCancelFullScreen?t.mozCancelFullScreen():t.webkitCancelFullScreen?t.webkitCancelFullScreen():t.msCancelFullScreen&&t.msCancelFullScreen()},e.prototype.getFontOffset=function(t){var r=document.createElement("span");r.innerHTML="Hg",r.setAttribute("style","font: ".concat(t," !important"));var i=document.createElement("div");i.style.display="inline-block",i.style.width="1px",i.style.height="0px",i.style.verticalAlign="bottom";var o=document.createElement("div");o.style.whiteSpace="nowrap",o.appendChild(r),o.appendChild(i),document.body.appendChild(o);var n=0,s=0;try{s=i.getBoundingClientRect().top-r.getBoundingClientRect().top,i.style.verticalAlign="baseline",n=i.getBoundingClientRect().top-r.getBoundingClientRect().top}finally{document.body.removeChild(o)}return{ascent:n,height:s,descent:s-n}},e.ALPHA_DISABLE=0,e.ALPHA_ADD=1,e.ALPHA_COMBINE=2,e.ALPHA_SUBTRACT=3,e.ALPHA_MULTIPLY=4,e.ALPHA_MAXIMIZED=5,e.ALPHA_ONEONE=6,e.ALPHA_PREMULTIPLIED=7,e.ALPHA_PREMULTIPLIED_PORTERDUFF=8,e.ALPHA_INTERPOLATE=9,e.ALPHA_SCREENMODE=10,e.DELAYLOADSTATE_NONE=0,e.DELAYLOADSTATE_LOADED=1,e.DELAYLOADSTATE_LOADING=2,e.DELAYLOADSTATE_NOTLOADED=4,e.NEVER=512,e.ALWAYS=519,e.LESS=513,e.EQUAL=514,e.LEQUAL=515,e.GREATER=516,e.GEQUAL=518,e.NOTEQUAL=517,e.KEEP=7680,e.REPLACE=7681,e.INCR=7682,e.DECR=7683,e.INVERT=5386,e.INCR_WRAP=34055,e.DECR_WRAP=34056,e.TEXTURE_CLAMP_ADDRESSMODE=0,e.TEXTURE_WRAP_ADDRESSMODE=1,e.TEXTURE_MIRROR_ADDRESSMODE=2,e.TEXTUREFORMAT_ALPHA=0,e.TEXTUREFORMAT_LUMINANCE=1,e.TEXTUREFORMAT_LUMINANCE_ALPHA=2,e.TEXTUREFORMAT_RGB=4,e.TEXTUREFORMAT_RGBA=5,e.TEXTUREFORMAT_RED=6,e.TEXTUREFORMAT_R=6,e.TEXTUREFORMAT_RG=7,e.TEXTUREFORMAT_RED_INTEGER=8,e.TEXTUREFORMAT_R_INTEGER=8,e.TEXTUREFORMAT_RG_INTEGER=9,e.TEXTUREFORMAT_RGB_INTEGER=10,e.TEXTUREFORMAT_RGBA_INTEGER=11,e.TEXTURETYPE_UNSIGNED_BYTE=0,e.TEXTURETYPE_UNSIGNED_INT=0,e.TEXTURETYPE_FLOAT=1,e.TEXTURETYPE_HALF_FLOAT=2,e.TEXTURETYPE_BYTE=3,e.TEXTURETYPE_SHORT=4,e.TEXTURETYPE_UNSIGNED_SHORT=5,e.TEXTURETYPE_INT=6,e.TEXTURETYPE_UNSIGNED_INTEGER=7,e.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,e.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,e.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,e.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,e.TEXTURETYPE_UNSIGNED_INT_24_8=12,e.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,e.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,e.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,e.TEXTURE_NEAREST_SAMPLINGMODE=1,e.TEXTURE_BILINEAR_SAMPLINGMODE=2,e.TEXTURE_TRILINEAR_SAMPLINGMODE=3,e.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,e.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,e.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,e.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,e.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,e.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,e.TEXTURE_NEAREST_LINEAR=7,e.TEXTURE_NEAREST_NEAREST=1,e.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,e.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,e.TEXTURE_LINEAR_LINEAR=2,e.TEXTURE_LINEAR_NEAREST=12,e.TEXTURE_EXPLICIT_MODE=0,e.TEXTURE_SPHERICAL_MODE=1,e.TEXTURE_PLANAR_MODE=2,e.TEXTURE_CUBIC_MODE=3,e.TEXTURE_PROJECTION_MODE=4,e.TEXTURE_SKYBOX_MODE=5,e.TEXTURE_INVCUBIC_MODE=6,e.TEXTURE_EQUIRECTANGULAR_MODE=7,e.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,e.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,e.SCALEMODE_FLOOR=1,e.SCALEMODE_NEAREST=2,e.SCALEMODE_CEILING=3,e._RescalePostProcessFactory=null,e._RenderPassIdCounter=0,e}(d);export{D as Engine};
