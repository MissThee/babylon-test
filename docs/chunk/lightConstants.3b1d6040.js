import{T as s,d,L as p}from"./precisionDate.911053b8.js";import{T as h}from"./decorators.033fe02c.js";s.prototype.createUniformBuffer=function(e){var r=this._gl.createBuffer();if(!r)throw new Error("Unable to create uniform buffer");var t=new d(r);return this.bindUniformBuffer(t),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),t.references=1,t};s.prototype.createDynamicUniformBuffer=function(e){var r=this._gl.createBuffer();if(!r)throw new Error("Unable to create dynamic uniform buffer");var t=new d(r);return this.bindUniformBuffer(t),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),t.references=1,t};s.prototype.updateUniformBuffer=function(e,r,t,f){this.bindUniformBuffer(e),t===void 0&&(t=0),f===void 0?r instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,r):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,new Float32Array(r)):r instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,r.subarray(t,t+f)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(r).subarray(t,t+f)),this.bindUniformBuffer(null)};s.prototype.bindUniformBuffer=function(e){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,e?e.underlyingResource:null)};s.prototype.bindUniformBufferBase=function(e,r,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,r,e?e.underlyingResource:null)};s.prototype.bindUniformBlock=function(e,r,t){var f=e.program,i=this._gl.getUniformBlockIndex(f,r);i!==4294967295&&this._gl.uniformBlockBinding(f,i,t)};var l=function(){function e(r,t,f,i,n){n===void 0&&(n=!1),this._valueCache={},this._engine=r,this._noUBO=!r.supportsUniformBuffers||n,this._dynamic=f,this._name=i!=null?i:"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform)}return Object.defineProperty(e.prototype,"useUbo",{get:function(){return!this._noUBO},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isSync",{get:function(){return!this._needSync},enumerable:!1,configurable:!0}),e.prototype.isDynamic=function(){return this._dynamic!==void 0},e.prototype.getData=function(){return this._bufferData},e.prototype.getBuffer=function(){return this._buffer},e.prototype._fillAlignment=function(r){var t;if(r<=2?t=r:t=4,this._uniformLocationPointer%t!==0){var f=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;for(var i=this._uniformLocationPointer-f,n=0;n<i;n++)this._data.push(0)}},e.prototype.addUniform=function(r,t,f){if(f===void 0&&(f=0),!this._noUBO&&this._uniformLocations[r]===void 0){var i;if(f>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+r;if(this._fillAlignment(4),this._uniformArraySizes[r]={strideSize:t,arraySize:f},t==16)t=t*f;else{var n=4-t,o=n*f;t=t*f+o}i=[];for(var u=0;u<t;u++)i.push(0)}else{if(t instanceof Array)i=t,t=i.length;else{t=t,i=[];for(var u=0;u<t;u++)i.push(0)}this._fillAlignment(t)}this._uniformSizes[r]=t,this._uniformLocations[r]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(var u=0;u<t;u++)this._data.push(i[u]);this._needSync=!0}},e.prototype.addMatrix=function(r,t){this.addUniform(r,Array.prototype.slice.call(t.toArray()))},e.prototype.addFloat2=function(r,t,f){var i=[t,f];this.addUniform(r,i)},e.prototype.addFloat3=function(r,t,f,i){var n=[t,f,i];this.addUniform(r,n)},e.prototype.addColor3=function(r,t){var f=[t.r,t.g,t.b];this.addUniform(r,f)},e.prototype.addColor4=function(r,t,f){var i=[t.r,t.g,t.b,f];this.addUniform(r,i)},e.prototype.addVector3=function(r,t){var f=[t.x,t.y,t.z];this.addUniform(r,f)},e.prototype.addMatrix3x3=function(r){this.addUniform(r,12)},e.prototype.addMatrix2x2=function(r){this.addUniform(r,8)},e.prototype.create=function(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)},e.prototype._rebuild=function(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData):this._buffer=this._engine.createUniformBuffer(this._bufferData),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))},Object.defineProperty(e.prototype,"_numBuffers",{get:function(){return this._buffers.length},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_indexBuffer",{get:function(){return this._bufferIndex},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),e.prototype._buffersEqual=function(r,t){for(var f=0;f<r.length;++f)if(r[f]!==t[f])return!1;return!0},e.prototype._copyBuffer=function(r,t){for(var f=0;f<r.length;++f)t[f]=r[f]},e.prototype.update=function(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(e._UpdatedUbosInFrame[this._name]||(e._UpdatedUbosInFrame[this._name]=0),e._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}},e.prototype._createNewBuffer=function(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()},e.prototype._checkNewFrame=function(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)},e.prototype.updateUniform=function(r,t,f){this._checkNewFrame();var i=this._uniformLocations[r];if(i===void 0){if(this._buffer){p.Error("Cannot add an uniform after UBO has been created.");return}this.addUniform(r,f),i=this._uniformLocations[r]}if(this._buffer||this.create(),this._dynamic)for(var o=0;o<f;o++)this._bufferData[i+o]=t[o];else{for(var n=!1,o=0;o<f;o++)(f===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[i+o]!==h.FloatRound(t[o]))&&(n=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[i+o]=t[o]);this._needSync=this._needSync||n}},e.prototype.updateUniformArray=function(r,t,f){this._checkNewFrame();var i=this._uniformLocations[r];if(i===void 0){p.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform.");return}this._buffer||this.create();var n=this._uniformArraySizes[r];if(this._dynamic)for(var a=0;a<f;a++)this._bufferData[i+a]=t[a];else{for(var o=!1,u=0,_=0,a=0;a<f;a++)if(this._bufferData[i+_*4+u]!==h.FloatRound(t[a])&&(o=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[i+_*4+u]=t[a]),u++,u===n.strideSize){for(;u<4;u++)this._bufferData[i+_*4+u]=0;u=0,_++}this._needSync=this._needSync||o}},e.prototype._cacheMatrix=function(r,t){this._checkNewFrame();var f=this._valueCache[r],i=t.updateFlag;return f!==void 0&&f===i?!1:(this._valueCache[r]=i,!0)},e.prototype._updateMatrix3x3ForUniform=function(r,t){for(var f=0;f<3;f++)e._TempBuffer[f*4]=t[f*3],e._TempBuffer[f*4+1]=t[f*3+1],e._TempBuffer[f*4+2]=t[f*3+2],e._TempBuffer[f*4+3]=0;this.updateUniform(r,e._TempBuffer,12)},e.prototype._updateMatrix3x3ForEffect=function(r,t){this._currentEffect.setMatrix3x3(r,t)},e.prototype._updateMatrix2x2ForEffect=function(r,t){this._currentEffect.setMatrix2x2(r,t)},e.prototype._updateMatrix2x2ForUniform=function(r,t){for(var f=0;f<2;f++)e._TempBuffer[f*4]=t[f*2],e._TempBuffer[f*4+1]=t[f*2+1],e._TempBuffer[f*4+2]=0,e._TempBuffer[f*4+3]=0;this.updateUniform(r,e._TempBuffer,8)},e.prototype._updateFloatForEffect=function(r,t){this._currentEffect.setFloat(r,t)},e.prototype._updateFloatForUniform=function(r,t){e._TempBuffer[0]=t,this.updateUniform(r,e._TempBuffer,1)},e.prototype._updateFloat2ForEffect=function(r,t,f,i){i===void 0&&(i=""),this._currentEffect.setFloat2(r+i,t,f)},e.prototype._updateFloat2ForUniform=function(r,t,f){e._TempBuffer[0]=t,e._TempBuffer[1]=f,this.updateUniform(r,e._TempBuffer,2)},e.prototype._updateFloat3ForEffect=function(r,t,f,i,n){n===void 0&&(n=""),this._currentEffect.setFloat3(r+n,t,f,i)},e.prototype._updateFloat3ForUniform=function(r,t,f,i){e._TempBuffer[0]=t,e._TempBuffer[1]=f,e._TempBuffer[2]=i,this.updateUniform(r,e._TempBuffer,3)},e.prototype._updateFloat4ForEffect=function(r,t,f,i,n,o){o===void 0&&(o=""),this._currentEffect.setFloat4(r+o,t,f,i,n)},e.prototype._updateFloat4ForUniform=function(r,t,f,i,n){e._TempBuffer[0]=t,e._TempBuffer[1]=f,e._TempBuffer[2]=i,e._TempBuffer[3]=n,this.updateUniform(r,e._TempBuffer,4)},e.prototype._updateFloatArrayForEffect=function(r,t){this._currentEffect.setFloatArray(r,t)},e.prototype._updateFloatArrayForUniform=function(r,t){this.updateUniformArray(r,t,t.length)},e.prototype._updateArrayForEffect=function(r,t){this._currentEffect.setArray(r,t)},e.prototype._updateArrayForUniform=function(r,t){this.updateUniformArray(r,t,t.length)},e.prototype._updateIntArrayForEffect=function(r,t){this._currentEffect.setIntArray(r,t)},e.prototype._updateIntArrayForUniform=function(r,t){e._TempBufferInt32View.set(t),this.updateUniformArray(r,e._TempBuffer,t.length)},e.prototype._updateMatrixForEffect=function(r,t){this._currentEffect.setMatrix(r,t)},e.prototype._updateMatrixForUniform=function(r,t){this._cacheMatrix(r,t)&&this.updateUniform(r,t.toArray(),16)},e.prototype._updateMatricesForEffect=function(r,t){this._currentEffect.setMatrices(r,t)},e.prototype._updateMatricesForUniform=function(r,t){this.updateUniform(r,t,t.length)},e.prototype._updateVector3ForEffect=function(r,t){this._currentEffect.setVector3(r,t)},e.prototype._updateVector3ForUniform=function(r,t){e._TempBuffer[0]=t.x,e._TempBuffer[1]=t.y,e._TempBuffer[2]=t.z,this.updateUniform(r,e._TempBuffer,3)},e.prototype._updateVector4ForEffect=function(r,t){this._currentEffect.setVector4(r,t)},e.prototype._updateVector4ForUniform=function(r,t){e._TempBuffer[0]=t.x,e._TempBuffer[1]=t.y,e._TempBuffer[2]=t.z,e._TempBuffer[3]=t.w,this.updateUniform(r,e._TempBuffer,4)},e.prototype._updateColor3ForEffect=function(r,t,f){f===void 0&&(f=""),this._currentEffect.setColor3(r+f,t)},e.prototype._updateColor3ForUniform=function(r,t){e._TempBuffer[0]=t.r,e._TempBuffer[1]=t.g,e._TempBuffer[2]=t.b,this.updateUniform(r,e._TempBuffer,3)},e.prototype._updateColor4ForEffect=function(r,t,f,i){i===void 0&&(i=""),this._currentEffect.setColor4(r+i,t,f)},e.prototype._updateDirectColor4ForEffect=function(r,t,f){f===void 0&&(f=""),this._currentEffect.setDirectColor4(r+f,t)},e.prototype._updateColor4ForUniform=function(r,t,f){e._TempBuffer[0]=t.r,e._TempBuffer[1]=t.g,e._TempBuffer[2]=t.b,e._TempBuffer[3]=f,this.updateUniform(r,e._TempBuffer,4)},e.prototype._updateDirectColor4ForUniform=function(r,t){e._TempBuffer[0]=t.r,e._TempBuffer[1]=t.g,e._TempBuffer[2]=t.b,e._TempBuffer[3]=t.a,this.updateUniform(r,e._TempBuffer,4)},e.prototype._updateIntForEffect=function(r,t,f){f===void 0&&(f=""),this._currentEffect.setInt(r+f,t)},e.prototype._updateIntForUniform=function(r,t){e._TempBufferInt32View[0]=t,this.updateUniform(r,e._TempBuffer,1)},e.prototype._updateInt2ForEffect=function(r,t,f,i){i===void 0&&(i=""),this._currentEffect.setInt2(r+i,t,f)},e.prototype._updateInt2ForUniform=function(r,t,f){e._TempBufferInt32View[0]=t,e._TempBufferInt32View[1]=f,this.updateUniform(r,e._TempBuffer,2)},e.prototype._updateInt3ForEffect=function(r,t,f,i,n){n===void 0&&(n=""),this._currentEffect.setInt3(r+n,t,f,i)},e.prototype._updateInt3ForUniform=function(r,t,f,i){e._TempBufferInt32View[0]=t,e._TempBufferInt32View[1]=f,e._TempBufferInt32View[2]=i,this.updateUniform(r,e._TempBuffer,3)},e.prototype._updateInt4ForEffect=function(r,t,f,i,n,o){o===void 0&&(o=""),this._currentEffect.setInt4(r+o,t,f,i,n)},e.prototype._updateInt4ForUniform=function(r,t,f,i,n){e._TempBufferInt32View[0]=t,e._TempBufferInt32View[1]=f,e._TempBufferInt32View[2]=i,e._TempBufferInt32View[3]=n,this.updateUniform(r,e._TempBuffer,4)},e.prototype.setTexture=function(r,t){this._currentEffect.setTexture(r,t)},e.prototype.updateUniformDirectly=function(r,t){this.updateUniform(r,t,t.length),this.update()},e.prototype.bindToEffect=function(r,t){this._currentEffect=r,this._currentEffectName=t},e.prototype.bindUniformBuffer=function(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)},e.prototype.unbindEffect=function(){this._currentEffect=void 0,this._currentEffectName=void 0},e.prototype.setDataBuffer=function(r){if(!this._buffers)return this._buffer===r;for(var t=0;t<this._buffers.length;++t){var f=this._buffers[t];if(f[0]===r)return this._bufferIndex=t,this._buffer=r,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0}return!1},e.prototype.dispose=function(){if(!this._noUBO){var r=this._engine._uniformBuffers,t=r.indexOf(this);if(t!==-1&&(r[t]=r[r.length-1],r.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(var f=0;f<this._buffers.length;++f){var i=this._buffers[f][0];this._engine._releaseBuffer(i)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}},e._UpdatedUbosInFrame={},e._MAX_UNIFORM_SIZE=256,e._TempBuffer=new Float32Array(e._MAX_UNIFORM_SIZE),e._TempBufferInt32View=new Uint32Array(e._TempBuffer.buffer),e}(),F=function(){function e(){}return e.CompareLightsPriority=function(r,t){return r.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(r.shadowEnabled?1:0):t.renderPriority-r.renderPriority},e.FALLOFF_DEFAULT=0,e.FALLOFF_PHYSICAL=1,e.FALLOFF_GLTF=2,e.FALLOFF_STANDARD=3,e.LIGHTMAP_DEFAULT=0,e.LIGHTMAP_SPECULAR=1,e.LIGHTMAP_SHADOWSONLY=2,e.INTENSITYMODE_AUTOMATIC=0,e.INTENSITYMODE_LUMINOUSPOWER=1,e.INTENSITYMODE_LUMINOUSINTENSITY=2,e.INTENSITYMODE_ILLUMINANCE=3,e.INTENSITYMODE_LUMINANCE=4,e.LIGHTTYPEID_POINTLIGHT=0,e.LIGHTTYPEID_DIRECTIONALLIGHT=1,e.LIGHTTYPEID_SPOTLIGHT=2,e.LIGHTTYPEID_HEMISPHERICLIGHT=3,e}();export{F as L,l as U};
