import{a as s,E as w}from"./@babylonjscore_Engines.77a493e8.js";import{L as g,O as x,I as M,_ as O,a as N,P as R}from"./@babylonjscore_Misc.5aaba58d.js";import{a as b,M as U}from"./@babylonjscore_Maths.4b8bfdd1.js";import{S as v}from"./@babylonjscore_sceneComponent.5f0854c6.js";import{S as P}from"./@babylonjscore_scene.c0faa314.js";import{A as I}from"./@babylonjscore_abstractScene.a7cd866f.js";s.AudioEngineFactory=function(i,e,t){return new F(i,e,t)};var F=function(){function i(e,t,o){e===void 0&&(e=null),t===void 0&&(t=null),o===void 0&&(o=null);var n=this;if(this._audioContext=null,this._audioContextInitialized=!1,this._muteButton=null,this._audioDestination=null,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!0,this.useCustomUnlockedButton=!1,this.onAudioUnlockedObservable=new x,this.onAudioLockedObservable=new x,this._tryToRun=!1,this._onResize=function(){n._moveButtonToTopLeft()},!!M()){(typeof window.AudioContext!="undefined"||typeof window.webkitAudioContext!="undefined")&&(window.AudioContext=window.AudioContext||window.webkitAudioContext,this.canUseWebAudio=!0);var a=document.createElement("audio");this._hostElement=e,this._audioContext=t,this._audioDestination=o;try{a&&!!a.canPlayType&&(a.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")||a.canPlayType("audio/mp3").replace(/^no$/,""))&&(this.isMP3supported=!0)}catch{}try{a&&!!a.canPlayType&&a.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0)}catch{}}}return Object.defineProperty(i.prototype,"audioContext",{get:function(){return this._audioContextInitialized?!this.unlocked&&!this._muteButton&&this._displayMuteButton():this._initializeAudioContext(),this._audioContext},enumerable:!1,configurable:!0}),i.prototype.lock=function(){this._triggerSuspendedState()},i.prototype.unlock=function(){this._triggerRunningState()},i.prototype._resumeAudioContext=function(){var e;return this._audioContext.resume!==void 0&&(e=this._audioContext.resume()),e||Promise.resolve()},i.prototype._initializeAudioContext=function(){try{this.canUseWebAudio&&(this._audioContext||(this._audioContext=new AudioContext),this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this._audioDestination||(this._audioDestination=this._audioContext.destination),this.masterGain.connect(this._audioDestination),this._audioContextInitialized=!0,this._audioContext.state==="running"&&this._triggerRunningState())}catch(e){this.canUseWebAudio=!1,g.Error("Web Audio: "+e.message)}},i.prototype._triggerRunningState=function(){var e=this;this._tryToRun||(this._tryToRun=!0,this._resumeAudioContext().then(function(){e._tryToRun=!1,e._muteButton&&e._hideMuteButton(),e.unlocked=!0,e.onAudioUnlockedObservable.notifyObservers(e)}).catch(function(){e._tryToRun=!1,e.unlocked=!1}))},i.prototype._triggerSuspendedState=function(){this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this),this._displayMuteButton()},i.prototype._displayMuteButton=function(){var e=this;if(!(this.useCustomUnlockedButton||this._muteButton)){this._muteButton=document.createElement("BUTTON"),this._muteButton.className="babylonUnmuteIcon",this._muteButton.id="babylonUnmuteIconBtn",this._muteButton.title="Unmute";var t=window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E":"https://cdn.babylonjs.com/Assets/audio.png",o=".babylonUnmuteIcon { position: absolute; left: 20px; top: 20px; height: 40px; width: 60px; background-color: rgba(51,51,51,0.7); background-image: url("+t+");  background-size: 80%; background-repeat:no-repeat; background-position: center; background-position-y: 4px; border: none; outline: none; transition: transform 0.125s ease-out; cursor: pointer; z-index: 9999; } .babylonUnmuteIcon:hover { transform: scale(1.05) } .babylonUnmuteIcon:active { background-color: rgba(51,51,51,1) }",n=document.createElement("style");n.appendChild(document.createTextNode(o)),document.getElementsByTagName("head")[0].appendChild(n),document.body.appendChild(this._muteButton),this._moveButtonToTopLeft(),this._muteButton.addEventListener("touchend",function(){e._triggerRunningState()},!0),this._muteButton.addEventListener("click",function(){e._triggerRunningState()},!0),window.addEventListener("resize",this._onResize)}},i.prototype._moveButtonToTopLeft=function(){this._hostElement&&this._muteButton&&(this._muteButton.style.top=this._hostElement.offsetTop+20+"px",this._muteButton.style.left=this._hostElement.offsetLeft+20+"px")},i.prototype._hideMuteButton=function(){this._muteButton&&(document.body.removeChild(this._muteButton),this._muteButton=null)},i.prototype.dispose=function(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&this._audioContext&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1,this._hideMuteButton(),window.removeEventListener("resize",this._onResize),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()},i.prototype.getGlobalVolume=function(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1},i.prototype.setGlobalVolume=function(e){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=e)},i.prototype.connectToAnalyser=function(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this.canUseWebAudio&&this._audioContextInitialized&&this._audioContext&&(this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))},i}(),k=function(){function i(e,t,o,n,a){n===void 0&&(n=null);var r=this,d,u,l,f,_;if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new x,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._startOffset=0,this._position=b.Zero(),this._localDirection=new b(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=e,o=o||w.LastCreatedScene,!!o)if(this._scene=o,i._SceneComponentInitialization(o),this._readyToPlayCallback=n,this._customAttenuationFunction=function(E,c,C,G,z){return c<C?E*(1-c/C):0},a&&(this.autoplay=a.autoplay||!1,this._loop=a.loop||!1,a.volume!==void 0&&(this._volume=a.volume),this._spatialSound=(d=a.spatialSound)!==null&&d!==void 0?d:!1,this.maxDistance=(u=a.maxDistance)!==null&&u!==void 0?u:100,this.useCustomAttenuation=(l=a.useCustomAttenuation)!==null&&l!==void 0?l:!1,this.rolloffFactor=a.rolloffFactor||1,this.refDistance=a.refDistance||1,this.distanceModel=a.distanceModel||"linear",this._playbackRate=a.playbackRate||1,this._streaming=(f=a.streaming)!==null&&f!==void 0?f:!1,this._length=a.length,this._offset=a.offset),((_=s.audioEngine)===null||_===void 0?void 0:_.canUseWebAudio)&&s.audioEngine.audioContext){this._soundGain=s.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);var h=!0;if(t)try{typeof t=="string"?this._urlType="String":t instanceof ArrayBuffer?this._urlType="ArrayBuffer":t instanceof HTMLMediaElement?this._urlType="MediaElement":t instanceof MediaStream?this._urlType="MediaStream":Array.isArray(t)&&(this._urlType="Array");var m=[],y=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=s.audioEngine.audioContext.createMediaElementSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=s.audioEngine.audioContext.createMediaStreamSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":t.byteLength>0&&(y=!0,this._soundLoaded(t));break;case"String":m.push(t);case"Array":m.length===0&&(m=t);for(var T=function(E){var c=m[E];if(y=a&&a.skipCodecCheck||c.indexOf(".mp3",c.length-4)!==-1&&s.audioEngine.isMP3supported||c.indexOf(".ogg",c.length-4)!==-1&&s.audioEngine.isOGGsupported||c.indexOf(".wav",c.length-4)!==-1||c.indexOf(".m4a",c.length-4)!==-1||c.indexOf(".mp4",c.length-4)!==-1||c.indexOf("blob:")!==-1,y)return p._streaming?(p._htmlAudioElement=new Audio(c),p._htmlAudioElement.controls=!1,p._htmlAudioElement.loop=p.loop,N.SetCorsBehavior(c,p._htmlAudioElement),p._htmlAudioElement.preload="auto",p._htmlAudioElement.addEventListener("canplaythrough",function(){r._isReadyToPlay=!0,r.autoplay&&r.play(0,r._offset,r._length),r._readyToPlayCallback&&r._readyToPlayCallback()}),document.body.appendChild(p._htmlAudioElement),p._htmlAudioElement.load()):p._scene._loadFile(c,function(C){r._soundLoaded(C)},void 0,!0,!0,function(C){C&&g.Error("XHR "+C.status+" error on: "+c+"."),g.Error("Sound creation aborted."),r._scene.mainSoundTrack.removeSound(r)}),"break"},p=this,S=0;S<m.length;S++){var D=T(S);if(D==="break")break}break;default:h=!1;break}h?y||(this._isReadyToPlay=!0,this._readyToPlayCallback&&window.setTimeout(function(){r._readyToPlayCallback&&r._readyToPlayCallback()},1e3)):g.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch{g.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),s.audioEngine&&!s.audioEngine.WarnedWebAudioUnsupported&&(g.Error("Web Audio is not supported by your browser."),s.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&window.setTimeout(function(){r._readyToPlayCallback&&r._readyToPlayCallback()},1e3)}return Object.defineProperty(i.prototype,"loop",{get:function(){return this._loop},set:function(e){e!==this._loop&&(this._loop=e,this.updateOptions({loop:e}))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"currentTime",{get:function(){var e;if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;var t=this._startOffset;return this.isPlaying&&((e=s.audioEngine)===null||e===void 0?void 0:e.audioContext)&&(t+=s.audioEngine.audioContext.currentTime-this._startTime),t},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"spatialSound",{get:function(){return this._spatialSound},set:function(e){var t;this._spatialSound=e,this._spatialSound&&((t=s.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&s.audioEngine.audioContext&&this._createSpatialParameters()},enumerable:!1,configurable:!0}),i.prototype.dispose=function(){var e;!((e=s.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement)),this._streamingSource&&this._streamingSource.disconnect(),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null))},i.prototype.isReady=function(){return this._isReadyToPlay},i.prototype.getClassName=function(){return"Sound"},i.prototype._soundLoaded=function(e){var t=this,o;!(!((o=s.audioEngine)===null||o===void 0)&&o.audioContext)||s.audioEngine.audioContext.decodeAudioData(e,function(n){t._audioBuffer=n,t._isReadyToPlay=!0,t.autoplay&&t.play(0,t._offset,t._length),t._readyToPlayCallback&&t._readyToPlayCallback()},function(n){g.Error("Error while decoding audio data for: "+t.name+" / Error: "+n)})},i.prototype.setAudioBuffer=function(e){var t;!((t=s.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&(this._audioBuffer=e,this._isReadyToPlay=!0)},i.prototype.updateOptions=function(e){var t,o,n,a,r,d,u,l,f,_;e&&(this.loop=(t=e.loop)!==null&&t!==void 0?t:this.loop,this.maxDistance=(o=e.maxDistance)!==null&&o!==void 0?o:this.maxDistance,this.useCustomAttenuation=(n=e.useCustomAttenuation)!==null&&n!==void 0?n:this.useCustomAttenuation,this.rolloffFactor=(a=e.rolloffFactor)!==null&&a!==void 0?a:this.rolloffFactor,this.refDistance=(r=e.refDistance)!==null&&r!==void 0?r:this.refDistance,this.distanceModel=(d=e.distanceModel)!==null&&d!==void 0?d:this.distanceModel,this._playbackRate=(u=e.playbackRate)!==null&&u!==void 0?u:this._playbackRate,this._length=(l=e.length)!==null&&l!==void 0?l:void 0,this._offset=(f=e.offset)!==null&&f!==void 0?f:void 0,this.setVolume((_=e.volume)!==null&&_!==void 0?_:this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),this._offset!==void 0&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),this._length!==void 0&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(this._offset|0)+this._length))))},i.prototype._createSpatialParameters=function(){var e,t;((e=s.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&s.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=(t=this._soundPanner)!==null&&t!==void 0?t:s.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))},i.prototype._updateSpatialParameters=function(){this._spatialSound&&this._soundPanner&&(this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel))},i.prototype.switchPanningModelToHRTF=function(){this._panningModel="HRTF",this._switchPanningModel()},i.prototype.switchPanningModelToEqualPower=function(){this._panningModel="equalpower",this._switchPanningModel()},i.prototype._switchPanningModel=function(){var e;((e=s.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)},i.prototype.connectToSoundTrackAudioNode=function(e){var t;((t=s.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(e),this._isOutputConnected=!0)},i.prototype.setDirectionalCone=function(e,t,o){if(t<e){g.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,this._coneOuterAngle=t,this._coneOuterGain=o,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))},Object.defineProperty(i.prototype,"directionalConeInnerAngle",{get:function(){return this._coneInnerAngle},set:function(e){var t;if(e!=this._coneInnerAngle){if(this._coneOuterAngle<e){g.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,((t=s.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"directionalConeOuterAngle",{get:function(){return this._coneOuterAngle},set:function(e){var t;if(e!=this._coneOuterAngle){if(e<this._coneInnerAngle){g.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e,((t=s.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}},enumerable:!1,configurable:!0}),i.prototype.setPosition=function(e){var t;e.equals(this._position)||(this._position.copyFrom(e),((t=s.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))},i.prototype.setLocalDirectionToMesh=function(e){var t;this._localDirection=e,((t=s.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()},i.prototype._updateDirection=function(){if(!(!this._connectedTransformNode||!this._soundPanner)){var e=this._connectedTransformNode.getWorldMatrix(),t=b.TransformNormal(this._localDirection,e);t.normalize(),this._soundPanner.orientationX.value=t.x,this._soundPanner.orientationY.value=t.y,this._soundPanner.orientationZ.value=t.z}},i.prototype.updateDistanceFromListener=function(){var e;if(((e=s.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){var t=this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}},i.prototype.setAttenuationFunction=function(e){this._customAttenuationFunction=e},i.prototype.play=function(e,t,o){var n=this,a,r,d,u;if(this._isReadyToPlay&&this._scene.audioEnabled&&((a=s.audioEngine)===null||a===void 0?void 0:a.audioContext))try{this._startOffset<0&&(e=-this._startOffset,this._startOffset=0);var l=e?((r=s.audioEngine)===null||r===void 0?void 0:r.audioContext.currentTime)+e:(d=s.audioEngine)===null||d===void 0?void 0:d.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this._spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(this._streamingSource||(this._streamingSource=s.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=function(){n._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode),this._htmlAudioElement){var f=function(){var h,m;if(!((h=s.audioEngine)===null||h===void 0)&&h.unlocked){var y=n._htmlAudioElement.play();y!==void 0&&y.catch(function(){var T,p;(T=s.audioEngine)===null||T===void 0||T.lock(),(n.loop||n.autoplay)&&((p=s.audioEngine)===null||p===void 0||p.onAudioUnlockedObservable.addOnce(function(){f()}))})}else(n.loop||n.autoplay)&&((m=s.audioEngine)===null||m===void 0||m.onAudioUnlockedObservable.addOnce(function(){f()}))};f()}}else{var _=function(){var h,m,y;if(!((h=s.audioEngine)===null||h===void 0)&&h.audioContext){if(o=o||n._length,t=t||n._offset,n._soundSource){var T=n._soundSource;T.onended=function(){T.disconnect()}}if(n._soundSource=(m=s.audioEngine)===null||m===void 0?void 0:m.audioContext.createBufferSource(),n._soundSource&&n._inputAudioNode){n._soundSource.buffer=n._audioBuffer,n._soundSource.connect(n._inputAudioNode),n._soundSource.loop=n.loop,t!==void 0&&(n._soundSource.loopStart=t),o!==void 0&&(n._soundSource.loopEnd=(t|0)+o),n._soundSource.playbackRate.value=n._playbackRate,n._soundSource.onended=function(){n._onended()},l=e?((y=s.audioEngine)===null||y===void 0?void 0:y.audioContext.currentTime)+e:s.audioEngine.audioContext.currentTime;var p=n.isPaused?n._startOffset%n._soundSource.buffer.duration:t||0;n._soundSource.start(l,p,n.loop?void 0:o)}}};((u=s.audioEngine)===null||u===void 0?void 0:u.audioContext.state)==="suspended"?setTimeout(function(){var h;((h=s.audioEngine)===null||h===void 0?void 0:h.audioContext.state)==="suspended"?(s.audioEngine.lock(),(n.loop||n.autoplay)&&s.audioEngine.onAudioUnlockedObservable.addOnce(function(){_()})):_()},500):_()}this._startTime=l,this.isPlaying=!0,this.isPaused=!1}catch(h){g.Error("Error while trying to play audio: "+this.name+", "+h.message)}},i.prototype._onended=function(){this.isPlaying=!1,this._startOffset=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)},i.prototype.stop=function(e){var t=this,o;if(this.isPlaying){if(this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource.disconnect(),this.isPlaying=!1;else if(((o=s.audioEngine)===null||o===void 0?void 0:o.audioContext)&&this._soundSource){var n=e?s.audioEngine.audioContext.currentTime+e:void 0;this._soundSource.stop(n),n===void 0?(this.isPlaying=!1,this._soundSource.onended=function(){}):this._soundSource.onended=function(){t.isPlaying=!1},this.isPaused||(this._startOffset=0)}}},i.prototype.pause=function(){var e;this.isPlaying&&(this.isPaused=!0,this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource.disconnect(),this.isPlaying=!1):!((e=s.audioEngine)===null||e===void 0)&&e.audioContext&&(this.stop(0),this._startOffset+=s.audioEngine.audioContext.currentTime-this._startTime))},i.prototype.setVolume=function(e,t){var o;((o=s.audioEngine)===null||o===void 0?void 0:o.canUseWebAudio)&&this._soundGain&&(t&&s.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(s.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,s.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,s.audioEngine.audioContext.currentTime+t)):this._soundGain.gain.value=e),this._volume=e},i.prototype.setPlaybackRate=function(e){this._playbackRate=e,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))},i.prototype.getVolume=function(){return this._volume},i.prototype.attachToMesh=function(e){var t=this;this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=function(o){return t._onRegisterAfterWorldMatrixUpdate(o)},this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)},i.prototype.detachFromMesh=function(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)},i.prototype._onRegisterAfterWorldMatrixUpdate=function(e){var t;if(!e.getBoundingInfo)this.setPosition(e.absolutePosition);else{var o=e,n=o.getBoundingInfo();this.setPosition(n.boundingSphere.centerWorld)}((t=s.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._isDirectional&&this.isPlaying&&this._updateDirection()},i.prototype.clone=function(){var e=this;if(this._streaming)return null;var t=function(){e._isReadyToPlay?(n._audioBuffer=e.getAudioBuffer(),n._isReadyToPlay=!0,n.autoplay&&n.play(0,e._offset,e._length)):window.setTimeout(t,300)},o={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},n=new i(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,o);return this.useCustomAttenuation&&n.setAttenuationFunction(this._customAttenuationFunction),n.setPosition(this._position),n.setPlaybackRate(this._playbackRate),t(),n},i.prototype.getAudioBuffer=function(){return this._audioBuffer},i.prototype.getSoundSource=function(){return this._soundSource},i.prototype.getSoundGain=function(){return this._soundGain},i.prototype.serialize=function(){var e={name:this.name,url:this.name,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this._coneInnerAngle,e.coneOuterAngle=this._coneOuterAngle,e.coneOuterGain=this._coneOuterGain),e},i.Parse=function(e,t,o,n){var a=e.name,r;e.url?r=o+e.url:r=o+a;var d={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate},u;if(!n)u=new i(a,r,t,function(){t.removePendingData(u)},d),t.addPendingData(u);else{var l=function(){n._isReadyToPlay?(u._audioBuffer=n.getAudioBuffer(),u._isReadyToPlay=!0,u.autoplay&&u.play(0,u._offset,u._length)):window.setTimeout(l,300)};u=new i(a,new ArrayBuffer(0),t,null,d),l()}if(e.position){var f=b.FromArray(e.position);u.setPosition(f)}if(e.isDirectional&&(u.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){var _=b.FromArray(e.localDirectionToMesh);u.setLocalDirectionToMesh(_)}if(e.connectedMeshId){var h=t.getMeshById(e.connectedMeshId);h&&u.attachToMesh(h)}return e.metadata&&(u.metadata=e.metadata),u},i._SceneComponentInitialization=function(e){throw O("AudioSceneComponent")},i}(),W=function(){function i(e,t){t===void 0&&(t={}),this.id=-1,this._isInitialized=!1,e=e||w.LastCreatedScene,e&&(this._scene=e,this.soundCollection=new Array,this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}return i.prototype._initializeSoundTrackAudioGraph=function(){var e;((e=s.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&s.audioEngine.audioContext&&(this._outputAudioNode=s.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(s.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)},i.prototype.dispose=function(){if(s.audioEngine&&s.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}},i.prototype.addSound=function(e){var t;this._isInitialized||this._initializeSoundTrackAudioGraph(),((t=s.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),e.soundTrackId&&(e.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(e):this._scene.soundTracks&&this._scene.soundTracks[e.soundTrackId].removeSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id},i.prototype.removeSound=function(e){var t=this.soundCollection.indexOf(e);t!==-1&&this.soundCollection.splice(t,1)},i.prototype.setVolume=function(e){var t;((t=s.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)},i.prototype.switchPanningModelToHRTF=function(){var e;if(!((e=s.audioEngine)===null||e===void 0)&&e.canUseWebAudio)for(var t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToHRTF()},i.prototype.switchPanningModelToEqualPower=function(){var e;if(!((e=s.audioEngine)===null||e===void 0)&&e.canUseWebAudio)for(var t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToEqualPower()},i.prototype.connectToAnalyser=function(e){var t;this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,((t=s.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,s.audioEngine.masterGain))},i}();I.AddParser(v.NAME_AUDIO,function(i,e,t,o){var n,a=[],r;if(t.sounds=t.sounds||[],i.sounds!==void 0&&i.sounds!==null)for(var d=0,u=i.sounds.length;d<u;d++){var l=i.sounds[d];!((n=s.audioEngine)===null||n===void 0)&&n.canUseWebAudio?(l.url||(l.url=l.name),a[l.url]?t.sounds.push(k.Parse(l,e,o,a[l.url])):(r=k.Parse(l,e,o),a[l.url]=r,t.sounds.push(r))):t.sounds.push(new k(l.name,null,e))}a=[]});Object.defineProperty(P.prototype,"mainSoundTrack",{get:function(){var i=this._getComponent(v.NAME_AUDIO);return i||(i=new A(this),this._addComponent(i)),this._mainSoundTrack||(this._mainSoundTrack=new W(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0});P.prototype.getSoundByName=function(i){var e;for(e=0;e<this.mainSoundTrack.soundCollection.length;e++)if(this.mainSoundTrack.soundCollection[e].name===i)return this.mainSoundTrack.soundCollection[e];if(this.soundTracks){for(var t=0;t<this.soundTracks.length;t++)for(e=0;e<this.soundTracks[t].soundCollection.length;e++)if(this.soundTracks[t].soundCollection[e].name===i)return this.soundTracks[t].soundCollection[e]}return null};Object.defineProperty(P.prototype,"audioEnabled",{get:function(){var i=this._getComponent(v.NAME_AUDIO);return i||(i=new A(this),this._addComponent(i)),i.audioEnabled},set:function(i){var e=this._getComponent(v.NAME_AUDIO);e||(e=new A(this),this._addComponent(e)),i?e.enableAudio():e.disableAudio()},enumerable:!0,configurable:!0});Object.defineProperty(P.prototype,"headphone",{get:function(){var i=this._getComponent(v.NAME_AUDIO);return i||(i=new A(this),this._addComponent(i)),i.headphone},set:function(i){var e=this._getComponent(v.NAME_AUDIO);e||(e=new A(this),this._addComponent(e)),i?e.switchAudioModeForHeadphones():e.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0});Object.defineProperty(P.prototype,"audioListenerPositionProvider",{get:function(){var i=this._getComponent(v.NAME_AUDIO);return i||(i=new A(this),this._addComponent(i)),i.audioListenerPositionProvider},set:function(i){var e=this._getComponent(v.NAME_AUDIO);if(e||(e=new A(this),this._addComponent(e)),typeof i!="function")throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");e.audioListenerPositionProvider=i},enumerable:!0,configurable:!0});Object.defineProperty(P.prototype,"audioPositioningRefreshRate",{get:function(){var i=this._getComponent(v.NAME_AUDIO);return i||(i=new A(this),this._addComponent(i)),i.audioPositioningRefreshRate},set:function(i){var e=this._getComponent(v.NAME_AUDIO);e||(e=new A(this),this._addComponent(e)),e.audioPositioningRefreshRate=i},enumerable:!0,configurable:!0});var A=function(){function i(e){this.name=v.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this._audioListenerPositionProvider=null,this._cachedCameraDirection=new b,this._cachedCameraPosition=new b,this._lastCheck=0,this._invertMatrixTemp=new U,this._cameraDirectionTemp=new b,e=e||w.LastCreatedScene,e&&(this.scene=e,e.soundTracks=new Array,e.sounds=new Array)}return Object.defineProperty(i.prototype,"audioEnabled",{get:function(){return this._audioEnabled},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"headphone",{get:function(){return this._headphone},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"audioListenerPositionProvider",{get:function(){return this._audioListenerPositionProvider},set:function(e){this._audioListenerPositionProvider=e},enumerable:!1,configurable:!0}),i.prototype.register=function(){this.scene._afterRenderStage.registerStep(v.STEP_AFTERRENDER_AUDIO,this,this._afterRender)},i.prototype.rebuild=function(){},i.prototype.serialize=function(e){if(e.sounds=[],this.scene.soundTracks)for(var t=0;t<this.scene.soundTracks.length;t++)for(var o=this.scene.soundTracks[t],n=0;n<o.soundCollection.length;n++)e.sounds.push(o.soundCollection[n].serialize())},i.prototype.addFromContainer=function(e){var t=this;!e.sounds||e.sounds.forEach(function(o){o.play(),o.autoplay=!0,t.scene.mainSoundTrack.addSound(o)})},i.prototype.removeFromContainer=function(e,t){var o=this;t===void 0&&(t=!1),e.sounds&&e.sounds.forEach(function(n){n.stop(),n.autoplay=!1,o.scene.mainSoundTrack.removeSound(n),t&&n.dispose()})},i.prototype.dispose=function(){var e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(var t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()},i.prototype.disableAudio=function(){var e=this.scene;this._audioEnabled=!1,s.audioEngine&&s.audioEngine.audioContext&&s.audioEngine.audioContext.suspend();var t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].pause();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(var o=0;o<e.soundTracks[t].soundCollection.length;o++)e.soundTracks[t].soundCollection[o].pause()},i.prototype.enableAudio=function(){var e=this.scene;this._audioEnabled=!0,s.audioEngine&&s.audioEngine.audioContext&&s.audioEngine.audioContext.resume();var t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].isPaused&&e.mainSoundTrack.soundCollection[t].play();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(var o=0;o<e.soundTracks[t].soundCollection.length;o++)e.soundTracks[t].soundCollection[o].isPaused&&e.soundTracks[t].soundCollection[o].play()},i.prototype.switchAudioModeForHeadphones=function(){var e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(var t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()},i.prototype.switchAudioModeForNormalSpeakers=function(){var e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(var t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()},i.prototype._afterRender=function(){var e=R.Now;if(!(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)){this._lastCheck=e;var t=this.scene;if(!(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||t._mainSoundTrack.soundCollection.length===0&&t.soundTracks.length===1)){var o=s.audioEngine;if(!!o&&o.audioContext){if(this._audioListenerPositionProvider){var n=this._audioListenerPositionProvider();n.x=n.x||0,n.y=n.y||0,n.z=n.z||0,o.audioContext.listener.setPosition(n.x,n.y,n.z)}else{var a=void 0;t.activeCameras&&t.activeCameras.length>0?a=t.activeCameras[0]:a=t.activeCamera,a?(this._cachedCameraPosition.equals(a.globalPosition)||(this._cachedCameraPosition.copyFrom(a.globalPosition),o.audioContext.listener.setPosition(a.globalPosition.x,a.globalPosition.y,a.globalPosition.z)),a.rigCameras&&a.rigCameras.length>0&&(a=a.rigCameras[0]),a.getViewMatrix().invertToRef(this._invertMatrixTemp),b.TransformNormalToRef(i._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),!isNaN(this._cameraDirectionTemp.x)&&!isNaN(this._cameraDirectionTemp.y)&&!isNaN(this._cameraDirectionTemp.z)&&(this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),o.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0)))):o.audioContext.listener.setPosition(0,0,0)}var r=void 0;for(r=0;r<t.mainSoundTrack.soundCollection.length;r++){var d=t.mainSoundTrack.soundCollection[r];d.useCustomAttenuation&&d.updateDistanceFromListener()}if(t.soundTracks)for(r=0;r<t.soundTracks.length;r++)for(var u=0;u<t.soundTracks[r].soundCollection.length;u++){var d=t.soundTracks[r].soundCollection[u];d.useCustomAttenuation&&d.updateDistanceFromListener()}}}}},i._CameraDirection=new b(0,0,-1),i}();k._SceneComponentInitialization=function(i){var e=i._getComponent(v.NAME_AUDIO);e||(e=new A(i),i._addComponent(e))};var X=Object.freeze(Object.defineProperty({__proto__:null,AudioSceneComponent:A},Symbol.toStringTag,{value:"Module"})),Z=function(){function i(e,t,o){var n=this;if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],t.length!==o.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=o;for(var a=0,r=0,d=o;r<d.length;r++){var u=d[r];a+=u}for(var l=a>0?1/a:0,f=0;f<this._weights.length;f++)this._weights[f]*=l;this._sounds=t;for(var _=0,h=this._sounds;_<h.length;_++){var m=h[_];m.onEndedObservable.add(function(){n._onended()})}}return Object.defineProperty(i.prototype,"directionalConeInnerAngle",{get:function(){return this._coneInnerAngle},set:function(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e){g.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e;for(var t=0,o=this._sounds;t<o.length;t++){var n=o[t];n.directionalConeInnerAngle=e}}},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"directionalConeOuterAngle",{get:function(){return this._coneOuterAngle},set:function(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle){g.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e;for(var t=0,o=this._sounds;t<o.length;t++){var n=o[t];n.directionalConeOuterAngle=e}}},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"volume",{get:function(){return this._volume},set:function(e){if(e!==this._volume)for(var t=0,o=this._sounds;t<o.length;t++){var n=o[t];n.setVolume(e)}},enumerable:!1,configurable:!0}),i.prototype._onended=function(){this._currentIndex!==void 0&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1},i.prototype.pause=function(){this.isPaused=!0,this._currentIndex!==void 0&&this._sounds[this._currentIndex].pause()},i.prototype.stop=function(){this.isPlaying=!1,this._currentIndex!==void 0&&this._sounds[this._currentIndex].stop()},i.prototype.play=function(e){if(!this.isPaused){this.stop();for(var t=Math.random(),o=0,n=0;n<this._weights.length;n++)if(o+=this._weights[n],t<=o){this._currentIndex=n;break}}var a=this._sounds[this._currentIndex];a.isReady()?a.play(0,this.isPaused?void 0:e):a.autoplay=!0,this.isPlaying=!0,this.isPaused=!1},i}();export{k as S,Z as W,X as a};
