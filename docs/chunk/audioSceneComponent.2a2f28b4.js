import{S as m}from"./sound.aa4d323e.js";import{Engine as a}from"./engine.535c373a.js";import{E as g}from"./performanceConfigurator.ee04355d.js";import{Vector3 as p,Matrix as v}from"./math.vector.560c6bc4.js";import{A as T,S as u,a as l}from"./scene.7f90ce88.js";import{L as C,O as _,I as y,P as A}from"./precisionDate.1704d4c6.js";import"./decorators.5af14a95.js";import"./arrayTools.49279cc5.js";import"./math.color.d29cb8ed.js";import"./perfCounter.4442bbd7.js";import"./engine.dynamicBuffer.fe9de623.js";import"./math.plane.7ea68d04.js";import"./lightConstants.176abcb0.js";var b=function(){function o(t,e){e===void 0&&(e={}),this.id=-1,this._isInitialized=!1,t=t||g.LastCreatedScene,t&&(this._scene=t,this.soundCollection=new Array,this._options=e,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}return o.prototype._initializeSoundTrackAudioGraph=function(){var t;((t=a.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&a.audioEngine.audioContext&&(this._outputAudioNode=a.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(a.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)},o.prototype.dispose=function(){if(a.audioEngine&&a.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}},o.prototype.addSound=function(t){var e;this._isInitialized||this._initializeSoundTrackAudioGraph(),((e=a.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&this._outputAudioNode&&t.connectToSoundTrackAudioNode(this._outputAudioNode),t.soundTrackId&&(t.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(t):this._scene.soundTracks&&this._scene.soundTracks[t.soundTrackId].removeSound(t)),this.soundCollection.push(t),t.soundTrackId=this.id},o.prototype.removeSound=function(t){var e=this.soundCollection.indexOf(t);e!==-1&&this.soundCollection.splice(e,1)},o.prototype.setVolume=function(t){var e;((e=a.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&this._outputAudioNode&&(this._outputAudioNode.gain.value=t)},o.prototype.switchPanningModelToHRTF=function(){var t;if(!((t=a.audioEngine)===null||t===void 0)&&t.canUseWebAudio)for(var e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToHRTF()},o.prototype.switchPanningModelToEqualPower=function(){var t;if(!((t=a.audioEngine)===null||t===void 0)&&t.canUseWebAudio)for(var e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToEqualPower()},o.prototype.connectToAnalyser=function(t){var e;this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=t,((e=a.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,a.audioEngine.masterGain))},o}();a.AudioEngineFactory=function(o,t,e){return new k(o,t,e)};var k=function(){function o(t,e,i){t===void 0&&(t=null),e===void 0&&(e=null),i===void 0&&(i=null);var n=this;if(this._audioContext=null,this._audioContextInitialized=!1,this._muteButton=null,this._audioDestination=null,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!0,this.useCustomUnlockedButton=!1,this.onAudioUnlockedObservable=new _,this.onAudioLockedObservable=new _,this._tryToRun=!1,this._onResize=function(){n._moveButtonToTopLeft()},!!y()){(typeof window.AudioContext!="undefined"||typeof window.webkitAudioContext!="undefined")&&(window.AudioContext=window.AudioContext||window.webkitAudioContext,this.canUseWebAudio=!0);var s=document.createElement("audio");this._hostElement=t,this._audioContext=e,this._audioDestination=i;try{s&&!!s.canPlayType&&(s.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")||s.canPlayType("audio/mp3").replace(/^no$/,""))&&(this.isMP3supported=!0)}catch{}try{s&&!!s.canPlayType&&s.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0)}catch{}}}return Object.defineProperty(o.prototype,"audioContext",{get:function(){return this._audioContextInitialized?!this.unlocked&&!this._muteButton&&this._displayMuteButton():this._initializeAudioContext(),this._audioContext},enumerable:!1,configurable:!0}),o.prototype.lock=function(){this._triggerSuspendedState()},o.prototype.unlock=function(){this._triggerRunningState()},o.prototype._resumeAudioContext=function(){var t;return this._audioContext.resume!==void 0&&(t=this._audioContext.resume()),t||Promise.resolve()},o.prototype._initializeAudioContext=function(){try{this.canUseWebAudio&&(this._audioContext||(this._audioContext=new AudioContext),this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this._audioDestination||(this._audioDestination=this._audioContext.destination),this.masterGain.connect(this._audioDestination),this._audioContextInitialized=!0,this._audioContext.state==="running"&&this._triggerRunningState())}catch(t){this.canUseWebAudio=!1,C.Error("Web Audio: "+t.message)}},o.prototype._triggerRunningState=function(){var t=this;this._tryToRun||(this._tryToRun=!0,this._resumeAudioContext().then(function(){t._tryToRun=!1,t._muteButton&&t._hideMuteButton(),t.unlocked=!0,t.onAudioUnlockedObservable.notifyObservers(t)}).catch(function(){t._tryToRun=!1,t.unlocked=!1}))},o.prototype._triggerSuspendedState=function(){this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this),this._displayMuteButton()},o.prototype._displayMuteButton=function(){var t=this;if(!(this.useCustomUnlockedButton||this._muteButton)){this._muteButton=document.createElement("BUTTON"),this._muteButton.className="babylonUnmuteIcon",this._muteButton.id="babylonUnmuteIconBtn",this._muteButton.title="Unmute";var e=window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E":"https://cdn.babylonjs.com/Assets/audio.png",i=".babylonUnmuteIcon { position: absolute; left: 20px; top: 20px; height: 40px; width: 60px; background-color: rgba(51,51,51,0.7); background-image: url("+e+");  background-size: 80%; background-repeat:no-repeat; background-position: center; background-position-y: 4px; border: none; outline: none; transition: transform 0.125s ease-out; cursor: pointer; z-index: 9999; } .babylonUnmuteIcon:hover { transform: scale(1.05) } .babylonUnmuteIcon:active { background-color: rgba(51,51,51,1) }",n=document.createElement("style");n.appendChild(document.createTextNode(i)),document.getElementsByTagName("head")[0].appendChild(n),document.body.appendChild(this._muteButton),this._moveButtonToTopLeft(),this._muteButton.addEventListener("touchend",function(){t._triggerRunningState()},!0),this._muteButton.addEventListener("click",function(){t._triggerRunningState()},!0),window.addEventListener("resize",this._onResize)}},o.prototype._moveButtonToTopLeft=function(){this._hostElement&&this._muteButton&&(this._muteButton.style.top=this._hostElement.offsetTop+20+"px",this._muteButton.style.left=this._hostElement.offsetLeft+20+"px")},o.prototype._hideMuteButton=function(){this._muteButton&&(document.body.removeChild(this._muteButton),this._muteButton=null)},o.prototype.dispose=function(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&this._audioContext&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1,this._hideMuteButton(),window.removeEventListener("resize",this._onResize),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()},o.prototype.getGlobalVolume=function(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1},o.prototype.setGlobalVolume=function(t){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=t)},o.prototype.connectToAnalyser=function(t){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this.canUseWebAudio&&this._audioContextInitialized&&this._audioContext&&(this._connectedAnalyser=t,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))},o}();T.AddParser(u.NAME_AUDIO,function(o,t,e,i){var n,s=[],r;if(e.sounds=e.sounds||[],o.sounds!==void 0&&o.sounds!==null)for(var c=0,f=o.sounds.length;c<f;c++){var h=o.sounds[c];!((n=a.audioEngine)===null||n===void 0)&&n.canUseWebAudio?(h.url||(h.url=h.name),s[h.url]?e.sounds.push(m.Parse(h,t,i,s[h.url])):(r=m.Parse(h,t,i),s[h.url]=r,e.sounds.push(r))):e.sounds.push(new m(h.name,null,t))}s=[]});Object.defineProperty(l.prototype,"mainSoundTrack",{get:function(){var o=this._getComponent(u.NAME_AUDIO);return o||(o=new d(this),this._addComponent(o)),this._mainSoundTrack||(this._mainSoundTrack=new b(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0});l.prototype.getSoundByName=function(o){var t;for(t=0;t<this.mainSoundTrack.soundCollection.length;t++)if(this.mainSoundTrack.soundCollection[t].name===o)return this.mainSoundTrack.soundCollection[t];if(this.soundTracks){for(var e=0;e<this.soundTracks.length;e++)for(t=0;t<this.soundTracks[e].soundCollection.length;t++)if(this.soundTracks[e].soundCollection[t].name===o)return this.soundTracks[e].soundCollection[t]}return null};Object.defineProperty(l.prototype,"audioEnabled",{get:function(){var o=this._getComponent(u.NAME_AUDIO);return o||(o=new d(this),this._addComponent(o)),o.audioEnabled},set:function(o){var t=this._getComponent(u.NAME_AUDIO);t||(t=new d(this),this._addComponent(t)),o?t.enableAudio():t.disableAudio()},enumerable:!0,configurable:!0});Object.defineProperty(l.prototype,"headphone",{get:function(){var o=this._getComponent(u.NAME_AUDIO);return o||(o=new d(this),this._addComponent(o)),o.headphone},set:function(o){var t=this._getComponent(u.NAME_AUDIO);t||(t=new d(this),this._addComponent(t)),o?t.switchAudioModeForHeadphones():t.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0});Object.defineProperty(l.prototype,"audioListenerPositionProvider",{get:function(){var o=this._getComponent(u.NAME_AUDIO);return o||(o=new d(this),this._addComponent(o)),o.audioListenerPositionProvider},set:function(o){var t=this._getComponent(u.NAME_AUDIO);if(t||(t=new d(this),this._addComponent(t)),typeof o!="function")throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");t.audioListenerPositionProvider=o},enumerable:!0,configurable:!0});Object.defineProperty(l.prototype,"audioPositioningRefreshRate",{get:function(){var o=this._getComponent(u.NAME_AUDIO);return o||(o=new d(this),this._addComponent(o)),o.audioPositioningRefreshRate},set:function(o){var t=this._getComponent(u.NAME_AUDIO);t||(t=new d(this),this._addComponent(t)),t.audioPositioningRefreshRate=o},enumerable:!0,configurable:!0});var d=function(){function o(t){this.name=u.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this._audioListenerPositionProvider=null,this._cachedCameraDirection=new p,this._cachedCameraPosition=new p,this._lastCheck=0,this._invertMatrixTemp=new v,this._cameraDirectionTemp=new p,t=t||g.LastCreatedScene,t&&(this.scene=t,t.soundTracks=new Array,t.sounds=new Array)}return Object.defineProperty(o.prototype,"audioEnabled",{get:function(){return this._audioEnabled},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"headphone",{get:function(){return this._headphone},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"audioListenerPositionProvider",{get:function(){return this._audioListenerPositionProvider},set:function(t){this._audioListenerPositionProvider=t},enumerable:!1,configurable:!0}),o.prototype.register=function(){this.scene._afterRenderStage.registerStep(u.STEP_AFTERRENDER_AUDIO,this,this._afterRender)},o.prototype.rebuild=function(){},o.prototype.serialize=function(t){if(t.sounds=[],this.scene.soundTracks)for(var e=0;e<this.scene.soundTracks.length;e++)for(var i=this.scene.soundTracks[e],n=0;n<i.soundCollection.length;n++)t.sounds.push(i.soundCollection[n].serialize())},o.prototype.addFromContainer=function(t){var e=this;!t.sounds||t.sounds.forEach(function(i){i.play(),i.autoplay=!0,e.scene.mainSoundTrack.addSound(i)})},o.prototype.removeFromContainer=function(t,e){var i=this;e===void 0&&(e=!1),t.sounds&&t.sounds.forEach(function(n){n.stop(),n.autoplay=!1,i.scene.mainSoundTrack.removeSound(n),e&&n.dispose()})},o.prototype.dispose=function(){var t=this.scene;if(t._mainSoundTrack&&t.mainSoundTrack.dispose(),t.soundTracks)for(var e=0;e<t.soundTracks.length;e++)t.soundTracks[e].dispose()},o.prototype.disableAudio=function(){var t=this.scene;this._audioEnabled=!1,a.audioEngine&&a.audioEngine.audioContext&&a.audioEngine.audioContext.suspend();var e;for(e=0;e<t.mainSoundTrack.soundCollection.length;e++)t.mainSoundTrack.soundCollection[e].pause();if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(var i=0;i<t.soundTracks[e].soundCollection.length;i++)t.soundTracks[e].soundCollection[i].pause()},o.prototype.enableAudio=function(){var t=this.scene;this._audioEnabled=!0,a.audioEngine&&a.audioEngine.audioContext&&a.audioEngine.audioContext.resume();var e;for(e=0;e<t.mainSoundTrack.soundCollection.length;e++)t.mainSoundTrack.soundCollection[e].isPaused&&t.mainSoundTrack.soundCollection[e].play();if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(var i=0;i<t.soundTracks[e].soundCollection.length;i++)t.soundTracks[e].soundCollection[i].isPaused&&t.soundTracks[e].soundCollection[i].play()},o.prototype.switchAudioModeForHeadphones=function(){var t=this.scene;if(this._headphone=!0,t.mainSoundTrack.switchPanningModelToHRTF(),t.soundTracks)for(var e=0;e<t.soundTracks.length;e++)t.soundTracks[e].switchPanningModelToHRTF()},o.prototype.switchAudioModeForNormalSpeakers=function(){var t=this.scene;if(this._headphone=!1,t.mainSoundTrack.switchPanningModelToEqualPower(),t.soundTracks)for(var e=0;e<t.soundTracks.length;e++)t.soundTracks[e].switchPanningModelToEqualPower()},o.prototype._afterRender=function(){var t=A.Now;if(!(this._lastCheck&&t-this._lastCheck<this.audioPositioningRefreshRate)){this._lastCheck=t;var e=this.scene;if(!(!this._audioEnabled||!e._mainSoundTrack||!e.soundTracks||e._mainSoundTrack.soundCollection.length===0&&e.soundTracks.length===1)){var i=a.audioEngine;if(!!i&&i.audioContext){if(this._audioListenerPositionProvider){var n=this._audioListenerPositionProvider();n.x=n.x||0,n.y=n.y||0,n.z=n.z||0,i.audioContext.listener.setPosition(n.x,n.y,n.z)}else{var s=void 0;e.activeCameras&&e.activeCameras.length>0?s=e.activeCameras[0]:s=e.activeCamera,s?(this._cachedCameraPosition.equals(s.globalPosition)||(this._cachedCameraPosition.copyFrom(s.globalPosition),i.audioContext.listener.setPosition(s.globalPosition.x,s.globalPosition.y,s.globalPosition.z)),s.rigCameras&&s.rigCameras.length>0&&(s=s.rigCameras[0]),s.getViewMatrix().invertToRef(this._invertMatrixTemp),p.TransformNormalToRef(o._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),!isNaN(this._cameraDirectionTemp.x)&&!isNaN(this._cameraDirectionTemp.y)&&!isNaN(this._cameraDirectionTemp.z)&&(this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),i.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0)))):i.audioContext.listener.setPosition(0,0,0)}var r=void 0;for(r=0;r<e.mainSoundTrack.soundCollection.length;r++){var c=e.mainSoundTrack.soundCollection[r];c.useCustomAttenuation&&c.updateDistanceFromListener()}if(e.soundTracks)for(r=0;r<e.soundTracks.length;r++)for(var f=0;f<e.soundTracks[r].soundCollection.length;f++){var c=e.soundTracks[r].soundCollection[f];c.useCustomAttenuation&&c.updateDistanceFromListener()}}}}},o._CameraDirection=new p(0,0,-1),o}();m._SceneComponentInitialization=function(o){var t=o._getComponent(u.NAME_AUDIO);t||(t=new d(o),o._addComponent(t))};export{d as AudioSceneComponent};
