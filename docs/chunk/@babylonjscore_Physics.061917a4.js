import{a as l,Q as B,e as E,M as w,d as J,E as C}from"./@babylonjscore_Maths.42afce42.js";import{L as v,A as G,_ as K,O as k}from"./@babylonjscore_Misc.329df4d9.js";import{M as Y,A as V,f as X,l as $,V as N}from"./@babylonjscore_Meshes.896ebf22.js";import{S as H}from"./@babylonjscore_sceneComponent.5f0854c6.js";import{S as I}from"./@babylonjscore_scene.b072ee35.js";import{_ as R}from"./tslibtslib.b6e59fa7.js";import"./@babylonjscore_Culling.f738e368.js";import{V as x}from"./@babylonjscore_Buffers.c351261b.js";var b=function(){function s(t,e){this.type=t,this.jointData=e,e.nativeParams=e.nativeParams||{}}return Object.defineProperty(s.prototype,"physicsJoint",{get:function(){return this._physicsJoint},set:function(t){this._physicsJoint,this._physicsJoint=t},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"physicsPlugin",{set:function(t){this._physicsPlugin=t},enumerable:!1,configurable:!0}),s.prototype.executeNativeFunction=function(t){t(this._physicsPlugin.world,this._physicsJoint)},s.DistanceJoint=0,s.HingeJoint=1,s.BallAndSocketJoint=2,s.WheelJoint=3,s.SliderJoint=4,s.PrismaticJoint=5,s.UniversalJoint=6,s.Hinge2Joint=s.WheelJoint,s.PointToPointJoint=8,s.SpringJoint=9,s.LockJoint=10,s}();(function(s){R(t,s);function t(e){return s.call(this,b.DistanceJoint,e)||this}return t.prototype.updateDistance=function(e,i){this._physicsPlugin.updateDistanceJoint(this,e,i)},t})(b);var U=function(s){R(t,s);function t(e,i){return s.call(this,e,i)||this}return t.prototype.setMotor=function(e,i){this._physicsPlugin.setMotor(this,e||0,i)},t.prototype.setLimit=function(e,i){this._physicsPlugin.setLimit(this,e,i)},t}(b);(function(s){R(t,s);function t(e){return s.call(this,b.HingeJoint,e)||this}return t.prototype.setMotor=function(e,i){this._physicsPlugin.setMotor(this,e||0,i)},t.prototype.setLimit=function(e,i){this._physicsPlugin.setLimit(this,e,i)},t})(U);(function(s){R(t,s);function t(e){return s.call(this,b.Hinge2Joint,e)||this}return t.prototype.setMotor=function(e,i,n){n===void 0&&(n=0),this._physicsPlugin.setMotor(this,e||0,i,n)},t.prototype.setLimit=function(e,i,n){n===void 0&&(n=0),this._physicsPlugin.setLimit(this,e,i,n)},t})(U);Y._PhysicsImpostorParser=function(s,t,e){return new d(t,e.physicsImpostor,{mass:e.physicsMass,friction:e.physicsFriction,restitution:e.physicsRestitution},s)};var d=function(){function s(t,e,i,n){i===void 0&&(i={mass:0});var o=this;if(this.object=t,this.type=e,this._options=i,this._scene=n,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=l.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new B,this._tmpQuat2=new B,this.beforeStep=function(){!o._physicsEngine||(o.object.translate(o._deltaPosition,-1),o._deltaRotationConjugated&&o.object.rotationQuaternion&&o.object.rotationQuaternion.multiplyToRef(o._deltaRotationConjugated,o.object.rotationQuaternion),o.object.computeWorldMatrix(!1),o.object.parent&&o.object.rotationQuaternion?(o.getParentsRotation(),o._tmpQuat.multiplyToRef(o.object.rotationQuaternion,o._tmpQuat)):o._tmpQuat.copyFrom(o.object.rotationQuaternion||new B),o._options.disableBidirectionalTransformation||o.object.rotationQuaternion&&o._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(o,o.object.getAbsolutePosition(),o._tmpQuat),o._onBeforePhysicsStepCallbacks.forEach(function(r){r(o)}))},this.afterStep=function(){!o._physicsEngine||(o._onAfterPhysicsStepCallbacks.forEach(function(r){r(o)}),o._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(o),o.object.parent&&o.object.rotationQuaternion&&(o.getParentsRotation(),o._tmpQuat.conjugateInPlace(),o._tmpQuat.multiplyToRef(o.object.rotationQuaternion,o.object.rotationQuaternion)),o.object.setAbsolutePosition(o.object.position),o._deltaRotation?(o.object.rotationQuaternion&&o.object.rotationQuaternion.multiplyToRef(o._deltaRotation,o.object.rotationQuaternion),o._deltaPosition.applyRotationQuaternionToRef(o._deltaRotation,s._TmpVecs[0]),o.object.translate(s._TmpVecs[0],1)):o.object.translate(o._deltaPosition,1),o.object.computeWorldMatrix(!0))},this.onCollideEvent=null,this.onCollide=function(r){if(!(!o._onPhysicsCollideCallbacks.length&&!o.onCollideEvent)&&!!o._physicsEngine){var a=o._physicsEngine.getImpostorWithPhysicsBody(r.body);a&&(o.onCollideEvent&&o.onCollideEvent(o,a),o._onPhysicsCollideCallbacks.filter(function(c){return c.otherImpostors.indexOf(a)!==-1}).forEach(function(c){c.callback(o,a,r.point)}))}},!this.object){v.Error("No object was provided. A physics object is obligatory");return}this.object.parent&&i.mass!==0&&v.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&t.getScene&&(this._scene=t.getScene()),this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=B.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new B),this._options.mass=i.mass===void 0?0:i.mass,this._options.friction=i.friction===void 0?.2:i.friction,this._options.restitution=i.restitution===void 0?.2:i.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=i.pressure===void 0?200:i.pressure,this._options.stiffness=i.stiffness===void 0?1:i.stiffness,this._options.velocityIterations=i.velocityIterations===void 0?20:i.velocityIterations,this._options.positionIterations=i.positionIterations===void 0?20:i.positionIterations,this._options.fixedPoints=i.fixedPoints===void 0?0:i.fixedPoints,this._options.margin=i.margin===void 0?0:i.margin,this._options.damping=i.damping===void 0?0:i.damping,this._options.path=i.path===void 0?null:i.path,this._options.shape=i.shape===void 0?null:i.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&v.Warn("You must affect impostors to children before affecting impostor to parent.")):v.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))}return Object.defineProperty(s.prototype,"isDisposed",{get:function(){return this._isDisposed},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"mass",{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0},set:function(t){this.setMass(t)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"friction",{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0},set:function(t){!this._physicsEngine||this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,t)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"restitution",{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0},set:function(t){!this._physicsEngine||this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,t)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"pressure",{get:function(){if(!this._physicsEngine)return 0;var t=this._physicsEngine.getPhysicsPlugin();return t.setBodyPressure?t.getBodyPressure(this):0},set:function(t){if(!!this._physicsEngine){var e=this._physicsEngine.getPhysicsPlugin();!e.setBodyPressure||e.setBodyPressure(this,t)}},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"stiffness",{get:function(){if(!this._physicsEngine)return 0;var t=this._physicsEngine.getPhysicsPlugin();return t.getBodyStiffness?t.getBodyStiffness(this):0},set:function(t){if(!!this._physicsEngine){var e=this._physicsEngine.getPhysicsPlugin();!e.setBodyStiffness||e.setBodyStiffness(this,t)}},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"velocityIterations",{get:function(){if(!this._physicsEngine)return 0;var t=this._physicsEngine.getPhysicsPlugin();return t.getBodyVelocityIterations?t.getBodyVelocityIterations(this):0},set:function(t){if(!!this._physicsEngine){var e=this._physicsEngine.getPhysicsPlugin();!e.setBodyVelocityIterations||e.setBodyVelocityIterations(this,t)}},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"positionIterations",{get:function(){if(!this._physicsEngine)return 0;var t=this._physicsEngine.getPhysicsPlugin();return t.getBodyPositionIterations?t.getBodyPositionIterations(this):0},set:function(t){if(!!this._physicsEngine){var e=this._physicsEngine.getPhysicsPlugin();!e.setBodyPositionIterations||e.setBodyPositionIterations(this,t)}},enumerable:!1,configurable:!0}),s.prototype._init=function(){!this._physicsEngine||(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),!this._isDisposed&&(!this.parent||this._options.ignoreParent)&&this._physicsEngine.addImpostor(this))},s.prototype._getPhysicsParent=function(){if(this.object.parent instanceof V){var t=this.object.parent;return t.physicsImpostor}return null},s.prototype.isBodyInitRequired=function(){return this._bodyUpdateRequired||!this._physicsBody&&(!this._parent||!!this._options.ignoreParent)},s.prototype.setScalingUpdated=function(){this.forceUpdate()},s.prototype.forceUpdate=function(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()},Object.defineProperty(s.prototype,"physicsBody",{get:function(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody},set:function(t){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=t,this.resetUpdateFlags()},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"parent",{get:function(){return!this._options.ignoreParent&&this._parent?this._parent:null},set:function(t){this._parent=t},enumerable:!1,configurable:!0}),s.prototype.resetUpdateFlags=function(){this._bodyUpdateRequired=!1},s.prototype.getObjectExtents=function(){if(this.object.getBoundingInfo){var t=this.object.rotationQuaternion,e=this.object.scaling.clone();this.object.rotationQuaternion=s.IDENTITY_QUATERNION;var i=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);i&&i.decompose(e,void 0,void 0);var n=this.object.getBoundingInfo(),o=n.boundingBox.extendSize.scale(2).multiplyInPlace(e);return o.x=Math.abs(o.x),o.y=Math.abs(o.y),o.z=Math.abs(o.z),this.object.rotationQuaternion=t,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),o}else return s.DEFAULT_OBJECT_SIZE},s.prototype.getObjectCenter=function(){if(this.object.getBoundingInfo){var t=this.object.getBoundingInfo();return t.boundingBox.centerWorld}else return this.object.position},s.prototype.getParam=function(t){return this._options[t]},s.prototype.setParam=function(t,e){this._options[t]=e,this._bodyUpdateRequired=!0},s.prototype.setMass=function(t){this.getParam("mass")!==t&&this.setParam("mass",t),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,t)},s.prototype.getLinearVelocity=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):l.Zero()},s.prototype.setLinearVelocity=function(t){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,t)},s.prototype.getAngularVelocity=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):l.Zero()},s.prototype.setAngularVelocity=function(t){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,t)},s.prototype.executeNativeFunction=function(t){this._physicsEngine&&t(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)},s.prototype.registerBeforePhysicsStep=function(t){this._onBeforePhysicsStepCallbacks.push(t)},s.prototype.unregisterBeforePhysicsStep=function(t){var e=this._onBeforePhysicsStepCallbacks.indexOf(t);e>-1?this._onBeforePhysicsStepCallbacks.splice(e,1):v.Warn("Function to remove was not found")},s.prototype.registerAfterPhysicsStep=function(t){this._onAfterPhysicsStepCallbacks.push(t)},s.prototype.unregisterAfterPhysicsStep=function(t){var e=this._onAfterPhysicsStepCallbacks.indexOf(t);e>-1?this._onAfterPhysicsStepCallbacks.splice(e,1):v.Warn("Function to remove was not found")},s.prototype.registerOnPhysicsCollide=function(t,e){var i=t instanceof Array?t:[t];this._onPhysicsCollideCallbacks.push({callback:e,otherImpostors:i})},s.prototype.unregisterOnPhysicsCollide=function(t,e){var i=t instanceof Array?t:[t],n=-1,o=this._onPhysicsCollideCallbacks.some(function(r,a){if(r.callback===e&&r.otherImpostors.length===i.length){var c=r.otherImpostors.every(function(h){return i.indexOf(h)>-1});return c&&(n=a),c}return!1});o?this._onPhysicsCollideCallbacks.splice(n,1):v.Warn("Function to remove was not found")},s.prototype.getParentsRotation=function(){var t=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);t;)t.rotationQuaternion?this._tmpQuat2.copyFrom(t.rotationQuaternion):B.RotationYawPitchRollToRef(t.rotation.y,t.rotation.x,t.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),t=t.parent;return this._tmpQuat},s.prototype.applyForce=function(t,e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,t,e),this},s.prototype.applyImpulse=function(t,e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,t,e),this},s.prototype.createJoint=function(t,e,i){var n=new b(e,i);return this.addJoint(t,n),this},s.prototype.addJoint=function(t,e){return this._joints.push({otherImpostor:t,joint:e}),this._physicsEngine&&this._physicsEngine.addJoint(this,t,e),this},s.prototype.addAnchor=function(t,e,i,n,o){if(!this._physicsEngine)return this;var r=this._physicsEngine.getPhysicsPlugin();return r.appendAnchor?(this._physicsEngine&&r.appendAnchor(this,t,e,i,n,o),this):this},s.prototype.addHook=function(t,e,i,n){if(!this._physicsEngine)return this;var o=this._physicsEngine.getPhysicsPlugin();return o.appendAnchor?(this._physicsEngine&&o.appendHook(this,t,e,i,n),this):this},s.prototype.sleep=function(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this},s.prototype.wakeUp=function(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this},s.prototype.clone=function(t){return t?new s(t,this.type,this._options,this._scene):null},s.prototype.dispose=function(){var t=this;!this._physicsEngine||(this._joints.forEach(function(e){t._physicsEngine&&t._physicsEngine.removeJoint(t,e.otherImpostor,e.joint)}),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)},s.prototype.setDeltaPosition=function(t){this._deltaPosition.copyFrom(t)},s.prototype.setDeltaRotation=function(t){this._deltaRotation||(this._deltaRotation=new B),this._deltaRotation.copyFrom(t),this._deltaRotationConjugated=this._deltaRotation.conjugate()},s.prototype.getBoxSizeToRef=function(t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,t),this},s.prototype.getRadius=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0},s.prototype.syncBoneWithImpostor=function(t,e,i,n,o){var r=s._TmpVecs[0],a=this.object;if(a.rotationQuaternion)if(o){var c=s._TmpQuat;a.rotationQuaternion.multiplyToRef(o,c),t.setRotationQuaternion(c,E.WORLD,e)}else t.setRotationQuaternion(a.rotationQuaternion,E.WORLD,e);r.x=0,r.y=0,r.z=0,i&&(r.x=i.x,r.y=i.y,r.z=i.z,t.getDirectionToRef(r,e,r),n==null&&(n=i.length()),r.x*=n,r.y*=n,r.z*=n),t.getParent()?(r.addInPlace(a.getAbsolutePosition()),t.setAbsolutePosition(r,e)):(e.setAbsolutePosition(a.getAbsolutePosition()),e.position.x-=r.x,e.position.y-=r.y,e.position.z-=r.z)},s.prototype.syncImpostorWithBone=function(t,e,i,n,o,r){var a=this.object;if(a.rotationQuaternion)if(o){var c=s._TmpQuat;t.getRotationQuaternionToRef(E.WORLD,e,c),c.multiplyToRef(o,a.rotationQuaternion)}else t.getRotationQuaternionToRef(E.WORLD,e,a.rotationQuaternion);var h=s._TmpVecs[0],p=s._TmpVecs[1];r||(r=s._TmpVecs[2],r.x=0,r.y=1,r.z=0),t.getDirectionToRef(r,e,p),t.getAbsolutePositionToRef(e,h),n==null&&i&&(n=i.length()),n!=null&&(h.x+=p.x*n,h.y+=p.y*n,h.z+=p.z*n),a.setAbsolutePosition(h)},s.DEFAULT_OBJECT_SIZE=new l(1,1,1),s.IDENTITY_QUATERNION=B.Identity(),s._TmpVecs=G.BuildArray(3,l.Zero),s._TmpQuat=B.Identity(),s.NoImpostor=0,s.SphereImpostor=1,s.BoxImpostor=2,s.PlaneImpostor=3,s.MeshImpostor=4,s.CapsuleImpostor=6,s.CylinderImpostor=7,s.ParticleImpostor=8,s.HeightmapImpostor=9,s.ConvexHullImpostor=10,s.CustomImpostor=100,s.RopeImpostor=101,s.ClothImpostor=102,s.SoftbodyImpostor=103,s}(),O=function(){function s(t,e){if(e===void 0&&(e=s.DefaultPluginFactory()),this._physicsPlugin=e,this._impostors=[],this._joints=[],this._subTimeStep=0,this._uniqueIdCounter=0,!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");t=t||new l(0,-9.807,0),this.setGravity(t),this.setTimeStep()}return s.DefaultPluginFactory=function(){throw K("CannonJSPlugin")},s.prototype.setGravity=function(t){this.gravity=t,this._physicsPlugin.setGravity(this.gravity)},s.prototype.setTimeStep=function(t){t===void 0&&(t=1/60),this._physicsPlugin.setTimeStep(t)},s.prototype.getTimeStep=function(){return this._physicsPlugin.getTimeStep()},s.prototype.setSubTimeStep=function(t){t===void 0&&(t=0),this._subTimeStep=t},s.prototype.getSubTimeStep=function(){return this._subTimeStep},s.prototype.dispose=function(){this._impostors.forEach(function(t){t.dispose()}),this._physicsPlugin.dispose()},s.prototype.getPhysicsPluginName=function(){return this._physicsPlugin.name},s.prototype.addImpostor=function(t){this._impostors.push(t),t.uniqueId=this._uniqueIdCounter++,t.parent||this._physicsPlugin.generatePhysicsBody(t)},s.prototype.removeImpostor=function(t){var e=this._impostors.indexOf(t);if(e>-1){var i=this._impostors.splice(e,1);i.length&&this.getPhysicsPlugin().removePhysicsBody(t)}},s.prototype.addJoint=function(t,e,i){var n={mainImpostor:t,connectedImpostor:e,joint:i};i.physicsPlugin=this._physicsPlugin,this._joints.push(n),this._physicsPlugin.generateJoint(n)},s.prototype.removeJoint=function(t,e,i){var n=this._joints.filter(function(o){return o.connectedImpostor===e&&o.joint===i&&o.mainImpostor===t});n.length&&this._physicsPlugin.removeJoint(n[0])},s.prototype._step=function(t){var e=this;this._impostors.forEach(function(i){i.isBodyInitRequired()&&e._physicsPlugin.generatePhysicsBody(i)}),t>.1?t=.1:t<=0&&(t=1/60),this._physicsPlugin.executeStep(t,this._impostors)},s.prototype.getPhysicsPlugin=function(){return this._physicsPlugin},s.prototype.getImpostors=function(){return this._impostors},s.prototype.getImpostorForPhysicsObject=function(t){for(var e=0;e<this._impostors.length;++e)if(this._impostors[e].object===t)return this._impostors[e];return null},s.prototype.getImpostorWithPhysicsBody=function(t){for(var e=0;e<this._impostors.length;++e)if(this._impostors[e].physicsBody===t)return this._impostors[e];return null},s.prototype.raycast=function(t,e){return this._physicsPlugin.raycast(t,e)},s.Epsilon=.001,s}(),T=function(){function s(){this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=l.Zero(),this._hitPointWorld=l.Zero(),this._rayFromWorld=l.Zero(),this._rayToWorld=l.Zero()}return Object.defineProperty(s.prototype,"hasHit",{get:function(){return this._hasHit},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"hitDistance",{get:function(){return this._hitDistance},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"hitNormalWorld",{get:function(){return this._hitNormalWorld},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"hitPointWorld",{get:function(){return this._hitPointWorld},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"rayFromWorld",{get:function(){return this._rayFromWorld},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"rayToWorld",{get:function(){return this._rayToWorld},enumerable:!1,configurable:!0}),s.prototype.setHitData=function(t,e){this._hasHit=!0,this._hitNormalWorld=new l(t.x,t.y,t.z),this._hitPointWorld=new l(e.x,e.y,e.z)},s.prototype.setHitDistance=function(t){this._hitDistance=t},s.prototype.calculateHitDistance=function(){this._hitDistance=l.Distance(this._rayFromWorld,this._hitPointWorld)},s.prototype.reset=function(t,e){t===void 0&&(t=l.Zero()),e===void 0&&(e=l.Zero()),this._rayFromWorld=t,this._rayToWorld=e,this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=l.Zero(),this._hitPointWorld=l.Zero()},s}(),tt=function(){function s(t,e,i){if(t===void 0&&(t=!0),e===void 0&&(e=10),i===void 0&&(i=CANNON),this._useDeltaForWorldStep=t,this.name="CannonJSPlugin",this._physicsMaterials=new Array,this._fixedTimeStep=1/60,this._physicsBodiesToRemoveAfterStep=new Array,this._firstFrame=!0,this._tmpQuaternion=new B,this._minus90X=new B(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new B(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=l.Zero(),this._tmpDeltaPosition=l.Zero(),this._tmpUnityRotation=new B,this.BJSCANNON=i,!this.isSupported()){v.Error("CannonJS is not available. Please make sure you included the js file.");return}this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=e,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new T}return s.prototype.setGravity=function(t){var e=t;this.world.gravity.set(e.x,e.y,e.z)},s.prototype.setTimeStep=function(t){this._fixedTimeStep=t},s.prototype.getTimeStep=function(){return this._fixedTimeStep},s.prototype.executeStep=function(t,e){if(this._firstFrame){this._firstFrame=!1;for(var i=0,n=e;i<n.length;i++){var o=n[i];o.type==d.HeightmapImpostor||o.type===d.PlaneImpostor||o.beforeStep()}}this.world.step(this._useDeltaForWorldStep?t:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()},s.prototype._removeMarkedPhysicsBodiesFromWorld=function(){var t=this;this._physicsBodiesToRemoveAfterStep.length>0&&(this._physicsBodiesToRemoveAfterStep.forEach(function(e){typeof t.world.removeBody=="function"?t.world.removeBody(e):t.world.remove(e)}),this._physicsBodiesToRemoveAfterStep.length=0)},s.prototype.applyImpulse=function(t,e,i){var n=new this.BJSCANNON.Vec3(i.x,i.y,i.z),o=new this.BJSCANNON.Vec3(e.x,e.y,e.z);t.physicsBody.applyImpulse(o,n)},s.prototype.applyForce=function(t,e,i){var n=new this.BJSCANNON.Vec3(i.x,i.y,i.z),o=new this.BJSCANNON.Vec3(e.x,e.y,e.z);t.physicsBody.applyForce(o,n)},s.prototype.generatePhysicsBody=function(t){if(this._removeMarkedPhysicsBodiesFromWorld(),t.parent){t.physicsBody&&(this.removePhysicsBody(t),t.forceUpdate());return}if(t.isBodyInitRequired()){var e=this._createShape(t);if(!e){v.Warn("It was not possible to create a physics body for this object.");return}var i=t.physicsBody;i&&this.removePhysicsBody(t);var n=this._addMaterial("mat-"+t.uniqueId,t.getParam("friction"),t.getParam("restitution")),o={mass:t.getParam("mass"),material:n},r=t.getParam("nativeOptions");for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(o[a]=r[a]);t.physicsBody=new this.BJSCANNON.Body(o),t.physicsBody.addEventListener("collide",t.onCollide),this.world.addEventListener("preStep",t.beforeStep),this.world.addEventListener("postStep",t.afterStep),t.physicsBody.addShape(e),typeof this.world.addBody=="function"?this.world.addBody(t.physicsBody):this.world.add(t.physicsBody),i&&["force","torque","velocity","angularVelocity"].forEach(function(c){var h=i[c];t.physicsBody[c].set(h.x,h.y,h.z)}),this._processChildMeshes(t)}this._updatePhysicsBodyTransformation(t)},s.prototype._processChildMeshes=function(t){var e=this,i=t.object.getChildMeshes?t.object.getChildMeshes(!0):[],n=t.object.rotationQuaternion;if(n?n.conjugateToRef(this._tmpQuaternion):this._tmpQuaternion.set(0,0,0,1),i.length){var o=function(r){if(!!r.rotationQuaternion){var a=r.getPhysicsImpostor();if(a){var c=a.parent;if(c!==t&&r.parent){var h=r.getAbsolutePosition().subtract(r.parent.getAbsolutePosition()),p=r.rotationQuaternion.multiply(e._tmpQuaternion);a.physicsBody&&(e.removePhysicsBody(a),a.physicsBody=null),a.parent=t,a.resetUpdateFlags(),t.physicsBody.addShape(e._createShape(a),new e.BJSCANNON.Vec3(h.x,h.y,h.z),new e.BJSCANNON.Quaternion(p.x,p.y,p.z,p.w)),t.physicsBody.mass+=a.getParam("mass")}}r.getChildMeshes(!0).filter(function(u){return!!u.physicsImpostor}).forEach(o)}};i.filter(function(r){return!!r.physicsImpostor}).forEach(o)}},s.prototype.removePhysicsBody=function(t){t.physicsBody.removeEventListener("collide",t.onCollide),this.world.removeEventListener("preStep",t.beforeStep),this.world.removeEventListener("postStep",t.afterStep),this._physicsBodiesToRemoveAfterStep.indexOf(t.physicsBody)===-1&&this._physicsBodiesToRemoveAfterStep.push(t.physicsBody)},s.prototype.generateJoint=function(t){var e=t.mainImpostor.physicsBody,i=t.connectedImpostor.physicsBody;if(!(!e||!i)){var n,o=t.joint.jointData,r={pivotA:o.mainPivot?new this.BJSCANNON.Vec3().set(o.mainPivot.x,o.mainPivot.y,o.mainPivot.z):null,pivotB:o.connectedPivot?new this.BJSCANNON.Vec3().set(o.connectedPivot.x,o.connectedPivot.y,o.connectedPivot.z):null,axisA:o.mainAxis?new this.BJSCANNON.Vec3().set(o.mainAxis.x,o.mainAxis.y,o.mainAxis.z):null,axisB:o.connectedAxis?new this.BJSCANNON.Vec3().set(o.connectedAxis.x,o.connectedAxis.y,o.connectedAxis.z):null,maxForce:o.nativeParams.maxForce,collideConnected:!!o.collision};switch(t.joint.type){case b.HingeJoint:case b.Hinge2Joint:n=new this.BJSCANNON.HingeConstraint(e,i,r);break;case b.DistanceJoint:n=new this.BJSCANNON.DistanceConstraint(e,i,o.maxDistance||2);break;case b.SpringJoint:{var a=o;n=new this.BJSCANNON.Spring(e,i,{restLength:a.length,stiffness:a.stiffness,damping:a.damping,localAnchorA:r.pivotA,localAnchorB:r.pivotB});break}case b.LockJoint:n=new this.BJSCANNON.LockConstraint(e,i,r);break;case b.PointToPointJoint:case b.BallAndSocketJoint:default:n=new this.BJSCANNON.PointToPointConstraint(e,r.pivotA,i,r.pivotB,r.maxForce);break}n.collideConnected=!!o.collision,t.joint.physicsJoint=n,t.joint.type!==b.SpringJoint?this.world.addConstraint(n):(t.joint.jointData.forceApplicationCallback=t.joint.jointData.forceApplicationCallback||function(){n.applyForce()},t.mainImpostor.registerAfterPhysicsStep(t.joint.jointData.forceApplicationCallback))}},s.prototype.removeJoint=function(t){t.joint.type!==b.SpringJoint?this.world.removeConstraint(t.joint.physicsJoint):t.mainImpostor.unregisterAfterPhysicsStep(t.joint.jointData.forceApplicationCallback)},s.prototype._addMaterial=function(t,e,i){var n,o;for(n=0;n<this._physicsMaterials.length;n++)if(o=this._physicsMaterials[n],o.friction===e&&o.restitution===i)return o;var r=new this.BJSCANNON.Material(t);return r.friction=e,r.restitution=i,this._physicsMaterials.push(r),r},s.prototype._checkWithEpsilon=function(t){return t<O.Epsilon?O.Epsilon:t},s.prototype._createShape=function(t){var e=t.object,i,n=t.getObjectExtents();switch(t.type){case d.SphereImpostor:{var o=n.x,r=n.y,a=n.z;i=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(o),this._checkWithEpsilon(r),this._checkWithEpsilon(a))/2);break}case d.CylinderImpostor:{var c=t.getParam("nativeOptions");c||(c={});var h=c.radiusTop!==void 0?c.radiusTop:this._checkWithEpsilon(n.x)/2,p=c.radiusBottom!==void 0?c.radiusBottom:this._checkWithEpsilon(n.x)/2,u=c.height!==void 0?c.height:this._checkWithEpsilon(n.y),g=c.numSegments!==void 0?c.numSegments:16;i=new this.BJSCANNON.Cylinder(h,p,u,g);var f=new this.BJSCANNON.Quaternion;f.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);var y=new this.BJSCANNON.Vec3(0,0,0);i.transformAllPoints(y,f);break}case d.BoxImpostor:{var _=n.scale(.5);i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(_.x),this._checkWithEpsilon(_.y),this._checkWithEpsilon(_.z)));break}case d.PlaneImpostor:v.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),i=new this.BJSCANNON.Plane;break;case d.MeshImpostor:{var m=e.getVerticesData?e.getVerticesData(x.PositionKind):[],A=e.getIndices?e.getIndices():[];if(!m){v.Warn("Tried to create a MeshImpostor for an object without vertices. This will fail.");return}var P=e.position.clone(),S=e.rotation&&e.rotation.clone(),M=e.rotationQuaternion&&e.rotationQuaternion.clone();e.position.copyFromFloats(0,0,0),e.rotation&&e.rotation.copyFromFloats(0,0,0),e.rotationQuaternion&&e.rotationQuaternion.copyFrom(t.getParentsRotation()),e.rotationQuaternion&&e.parent&&e.rotationQuaternion.conjugateInPlace();var z=e.computeWorldMatrix(!0),D=new Array,j=void 0;for(j=0;j<m.length;j+=3)l.TransformCoordinates(l.FromArray(m,j),z).toArray(D,j);v.Warn("MeshImpostor only collides against spheres."),i=new this.BJSCANNON.Trimesh(D,A),e.position.copyFrom(P),S&&e.rotation&&e.rotation.copyFrom(S),M&&e.rotationQuaternion&&e.rotationQuaternion.copyFrom(M);break}case d.HeightmapImpostor:{var Z=e.position.clone(),W=e.rotation&&e.rotation.clone(),Q=e.rotationQuaternion&&e.rotationQuaternion.clone();e.position.copyFromFloats(0,0,0),e.rotation&&e.rotation.copyFromFloats(0,0,0),e.rotationQuaternion&&e.rotationQuaternion.copyFrom(t.getParentsRotation()),e.rotationQuaternion&&e.parent&&e.rotationQuaternion.conjugateInPlace(),e.rotationQuaternion&&e.rotationQuaternion.multiplyInPlace(this._minus90X),i=this._createHeightmap(e),e.position.copyFrom(Z),W&&e.rotation&&e.rotation.copyFrom(W),Q&&e.rotationQuaternion&&e.rotationQuaternion.copyFrom(Q),e.computeWorldMatrix(!0);break}case d.ParticleImpostor:i=new this.BJSCANNON.Particle;break;case d.NoImpostor:i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0));break}return i},s.prototype._createHeightmap=function(t,e){var i=t.getVerticesData(x.PositionKind),n=t.computeWorldMatrix(!0),o=new Array,r;for(r=0;r<i.length;r+=3)l.TransformCoordinates(l.FromArray(i,r),n).toArray(o,r);i=o;for(var a=new Array,c=e||~~(Math.sqrt(i.length/3)-1),h=t.getBoundingInfo(),p=Math.min(h.boundingBox.extendSizeWorld.x,h.boundingBox.extendSizeWorld.y),u=h.boundingBox.extendSizeWorld.z,g=p*2/c,f=0;f<i.length;f=f+3){var y=Math.round(i[f+0]/g+c/2),_=Math.round((i[f+1]/g-c/2)*-1),m=-i[f+2]+u;a[y]||(a[y]=[]),a[y][_]||(a[y][_]=m),a[y][_]=Math.max(m,a[y][_])}for(var y=0;y<=c;++y){if(!a[y]){for(var A=1;!a[(y+A)%c];)A++;a[y]=a[(y+A)%c].slice()}for(var _=0;_<=c;++_)if(!a[y][_]){for(var A=1,P=void 0;P===void 0;)P=a[y][(_+A++)%c];a[y][_]=P}}var S=new this.BJSCANNON.Heightfield(a,{elementSize:g});return S.minY=u,S},s.prototype._updatePhysicsBodyTransformation=function(t){var e=t.object;if(e.computeWorldMatrix&&e.computeWorldMatrix(!0),!!e.getBoundingInfo()){var i=t.getObjectCenter();this._tmpDeltaPosition.copyFrom(e.getAbsolutePivotPoint().subtract(i)),this._tmpDeltaPosition.divideInPlace(t.object.scaling),this._tmpPosition.copyFrom(i);var n=e.rotationQuaternion;if(!!n){if((t.type===d.PlaneImpostor||t.type===d.HeightmapImpostor)&&(n=n.multiply(this._minus90X),t.setDeltaRotation(this._plus90X)),t.type===d.HeightmapImpostor){var o=e,r=o.getBoundingInfo(),a=o.rotationQuaternion;o.rotationQuaternion=this._tmpUnityRotation,o.computeWorldMatrix(!0);var c=i.clone(),h=o.getPivotMatrix();h?h=h.clone():h=w.Identity();var p=w.Translation(r.boundingBox.extendSizeWorld.x,0,-r.boundingBox.extendSizeWorld.z);o.setPreTransformMatrix(p),o.computeWorldMatrix(!0),r=o.getBoundingInfo();var u=r.boundingBox.centerWorld.subtract(i).subtract(o.position).negate();this._tmpPosition.copyFromFloats(u.x,u.y-r.boundingBox.extendSizeWorld.y,u.z),this._tmpDeltaPosition.copyFrom(r.boundingBox.centerWorld.subtract(c)),this._tmpDeltaPosition.y+=r.boundingBox.extendSizeWorld.y,o.rotationQuaternion=a,o.setPreTransformMatrix(h),o.computeWorldMatrix(!0)}else t.type===d.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);t.setDeltaPosition(this._tmpDeltaPosition),t.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),t.physicsBody.quaternion.set(n.x,n.y,n.z,n.w)}}},s.prototype.setTransformationFromPhysicsBody=function(t){if(t.object.position.set(t.physicsBody.position.x,t.physicsBody.position.y,t.physicsBody.position.z),t.object.rotationQuaternion){var e=t.physicsBody.quaternion;t.object.rotationQuaternion.set(e.x,e.y,e.z,e.w)}},s.prototype.setPhysicsBodyTransformation=function(t,e,i){t.physicsBody.position.set(e.x,e.y,e.z),t.physicsBody.quaternion.set(i.x,i.y,i.z,i.w)},s.prototype.isSupported=function(){return this.BJSCANNON!==void 0},s.prototype.setLinearVelocity=function(t,e){t.physicsBody.velocity.set(e.x,e.y,e.z)},s.prototype.setAngularVelocity=function(t,e){t.physicsBody.angularVelocity.set(e.x,e.y,e.z)},s.prototype.getLinearVelocity=function(t){var e=t.physicsBody.velocity;return e?new l(e.x,e.y,e.z):null},s.prototype.getAngularVelocity=function(t){var e=t.physicsBody.angularVelocity;return e?new l(e.x,e.y,e.z):null},s.prototype.setBodyMass=function(t,e){t.physicsBody.mass=e,t.physicsBody.updateMassProperties()},s.prototype.getBodyMass=function(t){return t.physicsBody.mass},s.prototype.getBodyFriction=function(t){return t.physicsBody.material.friction},s.prototype.setBodyFriction=function(t,e){t.physicsBody.material.friction=e},s.prototype.getBodyRestitution=function(t){return t.physicsBody.material.restitution},s.prototype.setBodyRestitution=function(t,e){t.physicsBody.material.restitution=e},s.prototype.sleepBody=function(t){t.physicsBody.sleep()},s.prototype.wakeUpBody=function(t){t.physicsBody.wakeUp()},s.prototype.updateDistanceJoint=function(t,e){t.physicsJoint.distance=e},s.prototype.setMotor=function(t,e,i,n){n||(t.physicsJoint.enableMotor(),t.physicsJoint.setMotorSpeed(e),i&&this.setLimit(t,i))},s.prototype.setLimit=function(t,e,i){t.physicsJoint.motorEquation.maxForce=i,t.physicsJoint.motorEquation.minForce=e===void 0?-e:e},s.prototype.syncMeshWithImpostor=function(t,e){var i=e.physicsBody;t.position.x=i.position.x,t.position.y=i.position.y,t.position.z=i.position.z,t.rotationQuaternion&&(t.rotationQuaternion.x=i.quaternion.x,t.rotationQuaternion.y=i.quaternion.y,t.rotationQuaternion.z=i.quaternion.z,t.rotationQuaternion.w=i.quaternion.w)},s.prototype.getRadius=function(t){var e=t.physicsBody.shapes[0];return e.boundingSphereRadius},s.prototype.getBoxSizeToRef=function(t,e){var i=t.physicsBody.shapes[0];e.x=i.halfExtents.x*2,e.y=i.halfExtents.y*2,e.z=i.halfExtents.z*2},s.prototype.dispose=function(){},s.prototype._extendNamespace=function(){var t=new this.BJSCANNON.Vec3,e=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(i,n,o){if(o=o||10,n=n||0,n===0)this.internalStep(i),this.time+=i;else{var r=Math.floor((this.time+n)/i)-Math.floor(this.time/i);r=Math.min(r,o)||1;for(var a=performance.now(),c=0;c!==r&&(this.internalStep(i),!(performance.now()-a>i*1e3));c++);this.time+=n;for(var h=this.time%i,p=h/i,u=t,g=this.bodies,f=0;f!==g.length;f++){var y=g[f];y.type!==e.Body.STATIC&&y.sleepState!==e.Body.SLEEPING?(y.position.vsub(y.previousPosition,u),u.scale(p,u),y.position.vadd(u,y.interpolatedPosition)):(y.interpolatedPosition.set(y.position.x,y.position.y,y.position.z),y.interpolatedQuaternion.set(y.quaternion.x,y.quaternion.y,y.quaternion.z,y.quaternion.w))}}}},s.prototype.raycast=function(t,e){return this._cannonRaycastResult.reset(),this.world.raycastClosest(t,e,{},this._cannonRaycastResult),this._raycastResult.reset(t,e),this._cannonRaycastResult.hasHit&&(this._raycastResult.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),this._raycastResult.setHitDistance(this._cannonRaycastResult.distance)),this._raycastResult},s}();O.DefaultPluginFactory=function(){return new tt};var ht=function(){function s(t,e,i){t===void 0&&(t=!0),i===void 0&&(i=OIMO),this._useDeltaForWorldStep=t,this.name="OimoJSPlugin",this._fixedTimeStep=1/60,this._tmpImpostorsArray=[],this._tmpPositionVector=l.Zero(),this.BJSOIMO=i,this.world=new this.BJSOIMO.World({iterations:e}),this.world.clear(),this._raycastResult=new T}return s.prototype.setGravity=function(t){this.world.gravity.set(t.x,t.y,t.z)},s.prototype.setTimeStep=function(t){this.world.timeStep=t},s.prototype.getTimeStep=function(){return this.world.timeStep},s.prototype.executeStep=function(t,e){var i=this;e.forEach(function(a){a.beforeStep()}),this.world.timeStep=this._useDeltaForWorldStep?t:this._fixedTimeStep,this.world.step(),e.forEach(function(a){a.afterStep(),i._tmpImpostorsArray[a.uniqueId]=a});for(var n=this.world.contacts;n!==null;){if(n.touching&&!n.body1.sleeping&&!n.body2.sleeping){n=n.next;continue}var o=this._tmpImpostorsArray[+n.body1.name],r=this._tmpImpostorsArray[+n.body2.name];if(!o||!r){n=n.next;continue}o.onCollide({body:r.physicsBody,point:null}),r.onCollide({body:o.physicsBody,point:null}),n=n.next}},s.prototype.applyImpulse=function(t,e,i){var n=t.physicsBody.mass;t.physicsBody.applyImpulse(i.scale(this.world.invScale),e.scale(this.world.invScale*n))},s.prototype.applyForce=function(t,e,i){v.Warn("Oimo doesn't support applying force. Using impule instead."),this.applyImpulse(t,e,i)},s.prototype.generatePhysicsBody=function(t){var e=this;if(t.parent){t.physicsBody&&(this.removePhysicsBody(t),t.forceUpdate());return}if(t.isBodyInitRequired()){var i={name:t.uniqueId,config:[t.getParam("mass")||.001,t.getParam("friction"),t.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:t.getParam("mass")!==0,density:t.getParam("mass"),friction:t.getParam("friction"),restitution:t.getParam("restitution"),world:this.world},n=[t],o=function(c){!c.getChildMeshes||c.getChildMeshes().forEach(function(h){h.physicsImpostor&&n.push(h.physicsImpostor)})};o(t.object);var r=function(c){return Math.max(c,O.Epsilon)},a=new B;n.forEach(function(c){if(!!c.object.rotationQuaternion){var h=c.object.rotationQuaternion;a.copyFrom(h),c.object.rotationQuaternion.set(0,0,0,1),c.object.computeWorldMatrix(!0);var p=a.toEulerAngles(),u=c.getObjectExtents(),g=57.29577951308232;if(c===t){var f=t.getObjectCenter();t.object.getAbsolutePivotPoint().subtractToRef(f,e._tmpPositionVector),e._tmpPositionVector.divideInPlace(t.object.scaling),i.pos.push(f.x),i.pos.push(f.y),i.pos.push(f.z),i.posShape.push(0,0,0),i.rotShape.push(0,0,0)}else{var y=c.object.position.clone();i.posShape.push(y.x),i.posShape.push(y.y),i.posShape.push(y.z),i.rotShape.push(p.x*g,p.y*g,p.z*g)}switch(c.object.rotationQuaternion.copyFrom(a),c.type){case d.ParticleImpostor:v.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case d.SphereImpostor:{var _=u.x,m=u.y,A=u.z,P=Math.max(r(_),r(m),r(A))/2;i.type.push("sphere"),i.size.push(P),i.size.push(P),i.size.push(P);break}case d.CylinderImpostor:{var S=r(u.x)/2,M=r(u.y);i.type.push("cylinder"),i.size.push(S),i.size.push(M),i.size.push(M);break}case d.PlaneImpostor:case d.BoxImpostor:default:{var S=r(u.x),M=r(u.y),z=r(u.z);i.type.push("box"),i.size.push(S),i.size.push(M),i.size.push(z);break}}c.object.rotationQuaternion=h}}),t.physicsBody=this.world.add(i),t.physicsBody.resetQuaternion(a),t.physicsBody.updatePosition(0)}else this._tmpPositionVector.copyFromFloats(0,0,0);t.setDeltaPosition(this._tmpPositionVector)},s.prototype.removePhysicsBody=function(t){this.world.removeRigidBody(t.physicsBody)},s.prototype.generateJoint=function(t){var e=t.mainImpostor.physicsBody,i=t.connectedImpostor.physicsBody;if(!(!e||!i)){var n=t.joint.jointData,o=n.nativeParams||{},r,a={body1:e,body2:i,axe1:o.axe1||(n.mainAxis?n.mainAxis.asArray():null),axe2:o.axe2||(n.connectedAxis?n.connectedAxis.asArray():null),pos1:o.pos1||(n.mainPivot?n.mainPivot.asArray():null),pos2:o.pos2||(n.connectedPivot?n.connectedPivot.asArray():null),min:o.min,max:o.max,collision:o.collision||n.collision,spring:o.spring,world:this.world};switch(t.joint.type){case b.BallAndSocketJoint:r="jointBall";break;case b.SpringJoint:{v.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");var c=n;a.min=c.length||a.min,a.max=Math.max(a.min,a.max)}case b.DistanceJoint:r="jointDistance",a.max=n.maxDistance;break;case b.PrismaticJoint:r="jointPrisme";break;case b.SliderJoint:r="jointSlide";break;case b.WheelJoint:r="jointWheel";break;case b.HingeJoint:default:r="jointHinge";break}a.type=r,t.joint.physicsJoint=this.world.add(a)}},s.prototype.removeJoint=function(t){try{this.world.removeJoint(t.joint.physicsJoint)}catch(e){v.Warn(e)}},s.prototype.isSupported=function(){return this.BJSOIMO!==void 0},s.prototype.setTransformationFromPhysicsBody=function(t){if(!t.physicsBody.sleeping){if(t.physicsBody.shapes.next){for(var e=t.physicsBody.shapes;e.next;)e=e.next;t.object.position.set(e.position.x,e.position.y,e.position.z)}else{var i=t.physicsBody.getPosition();t.object.position.set(i.x,i.y,i.z)}if(t.object.rotationQuaternion){var n=t.physicsBody.getQuaternion();t.object.rotationQuaternion.set(n.x,n.y,n.z,n.w)}}},s.prototype.setPhysicsBodyTransformation=function(t,e,i){var n=t.physicsBody;t.physicsBody.shapes.next||(n.position.set(e.x,e.y,e.z),n.orientation.set(i.x,i.y,i.z,i.w),n.syncShapes(),n.awake())},s.prototype.setLinearVelocity=function(t,e){t.physicsBody.linearVelocity.set(e.x,e.y,e.z)},s.prototype.setAngularVelocity=function(t,e){t.physicsBody.angularVelocity.set(e.x,e.y,e.z)},s.prototype.getLinearVelocity=function(t){var e=t.physicsBody.linearVelocity;return e?new l(e.x,e.y,e.z):null},s.prototype.getAngularVelocity=function(t){var e=t.physicsBody.angularVelocity;return e?new l(e.x,e.y,e.z):null},s.prototype.setBodyMass=function(t,e){var i=e===0;t.physicsBody.shapes.density=i?1:e,t.physicsBody.setupMass(i?2:1)},s.prototype.getBodyMass=function(t){return t.physicsBody.shapes.density},s.prototype.getBodyFriction=function(t){return t.physicsBody.shapes.friction},s.prototype.setBodyFriction=function(t,e){t.physicsBody.shapes.friction=e},s.prototype.getBodyRestitution=function(t){return t.physicsBody.shapes.restitution},s.prototype.setBodyRestitution=function(t,e){t.physicsBody.shapes.restitution=e},s.prototype.sleepBody=function(t){t.physicsBody.sleep()},s.prototype.wakeUpBody=function(t){t.physicsBody.awake()},s.prototype.updateDistanceJoint=function(t,e,i){t.physicsJoint.limitMotor.upperLimit=e,i!==void 0&&(t.physicsJoint.limitMotor.lowerLimit=i)},s.prototype.setMotor=function(t,e,i,n){i!==void 0?v.Warn("OimoJS plugin currently has unexpected behavior when using setMotor with force parameter"):i=1e6,e*=-1;var o=n?t.physicsJoint.rotationalLimitMotor2:t.physicsJoint.rotationalLimitMotor1||t.physicsJoint.rotationalLimitMotor||t.physicsJoint.limitMotor;o&&o.setMotor(e,i)},s.prototype.setLimit=function(t,e,i,n){var o=n?t.physicsJoint.rotationalLimitMotor2:t.physicsJoint.rotationalLimitMotor1||t.physicsJoint.rotationalLimitMotor||t.physicsJoint.limitMotor;o&&o.setLimit(e,i===void 0?-e:i)},s.prototype.syncMeshWithImpostor=function(t,e){var i=e.physicsBody;t.position.x=i.position.x,t.position.y=i.position.y,t.position.z=i.position.z,t.rotationQuaternion&&(t.rotationQuaternion.x=i.orientation.x,t.rotationQuaternion.y=i.orientation.y,t.rotationQuaternion.z=i.orientation.z,t.rotationQuaternion.w=i.orientation.w)},s.prototype.getRadius=function(t){return t.physicsBody.shapes.radius},s.prototype.getBoxSizeToRef=function(t,e){var i=t.physicsBody.shapes;e.x=i.halfWidth*2,e.y=i.halfHeight*2,e.z=i.halfDepth*2},s.prototype.dispose=function(){this.world.clear()},s.prototype.raycast=function(t,e){return v.Warn("raycast is not currently supported by the Oimo physics plugin"),this._raycastResult.reset(t,e),this._raycastResult},s}(),pt=function(){function s(t,e,i){t===void 0&&(t=!0),e===void 0&&(e=Ammo),i===void 0&&(i=null);var n=this;if(this._useDeltaForWorldStep=t,this.bjsAMMO={},this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new B,this._tmpContactCallbackResult=!1,this._tmpContactPoint=new l,this._tmpVec3=new l,this._tmpMatrix=new w,typeof e=="function"){v.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.");return}else this.bjsAMMO=e;if(!this.isSupported()){v.Error("AmmoJS is not available. Please make sure you included the js file.");return}this._collisionConfiguration=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=i||new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this._softBodySolver=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration,this._softBodySolver),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=function(o){o=n.bjsAMMO.wrapPointer(o,n.bjsAMMO.btManifoldPoint);var r=o.getPositionWorldOnA();n._tmpContactPoint.x=r.x(),n._tmpContactPoint.y=r.y(),n._tmpContactPoint.z=r.z(),n._tmpContactCallbackResult=!0},this._raycastResult=new T,this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorD=new this.bjsAMMO.btVector3(0,0,0)}return s.prototype.setGravity=function(t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),this.world.setGravity(this._tmpAmmoVectorA),this.world.getWorldInfo().set_m_gravity(this._tmpAmmoVectorA)},s.prototype.setTimeStep=function(t){this._timeStep=t},s.prototype.setFixedTimeStep=function(t){this._fixedTimeStep=t},s.prototype.setMaxSteps=function(t){this._maxSteps=t},s.prototype.getTimeStep=function(){return this._timeStep},s.prototype._isImpostorInContact=function(t){return this._tmpContactCallbackResult=!1,this.world.contactTest(t.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult},s.prototype._isImpostorPairInContact=function(t,e){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(t.physicsBody,e.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult},s.prototype._stepSimulation=function(t,e,i){if(t===void 0&&(t=1/60),e===void 0&&(e=10),i===void 0&&(i=1/60),e==0)this.world.stepSimulation(t,0);else for(;e>0&&t>0;)t-i<i?(this.world.stepSimulation(t,0),t=0):(t-=i,this.world.stepSimulation(i,0)),e--},s.prototype.executeStep=function(t,e){for(var i=0,n=e;i<n.length;i++){var o=n[i];o.soft||o.beforeStep()}this._stepSimulation(this._useDeltaForWorldStep?t:this._timeStep,this._maxSteps,this._fixedTimeStep);for(var r=0,a=e;r<a.length;r++){var c=a[r];if(c.soft?this._afterSoftStep(c):c.afterStep(),c._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(c))for(var h=0,p=c._onPhysicsCollideCallbacks;h<p.length;h++)for(var u=p[h],g=0,f=u.otherImpostors;g<f.length;g++){var y=f[g];(c.physicsBody.isActive()||y.physicsBody.isActive())&&this._isImpostorPairInContact(c,y)&&(c.onCollide({body:y.physicsBody,point:this._tmpContactPoint}),y.onCollide({body:c.physicsBody,point:this._tmpContactPoint}))}}},s.prototype._afterSoftStep=function(t){t.type===d.RopeImpostor?this._ropeStep(t):this._softbodyOrClothStep(t)},s.prototype._ropeStep=function(t){for(var e=t.physicsBody.get_m_nodes(),i=e.size(),n,o,r,a,c,h=new Array,p=0;p<i;p++)n=e.at(p),o=n.get_m_x(),r=o.x(),a=o.y(),c=o.z(),h.push(new l(r,a,c));var u=t.object,g=t.getParam("shape");t._isFromLine?t.object=X("lines",{points:h,instance:u}):t.object=$("ext",{shape:g,path:h,instance:u})},s.prototype._softbodyOrClothStep=function(t){var e=t.type===d.ClothImpostor?1:-1,i=t.object,n=i.getVerticesData(x.PositionKind);n||(n=[]);var o=i.getVerticesData(x.NormalKind);o||(o=[]);for(var r=n.length/3,a=t.physicsBody.get_m_nodes(),c,h,p,u,g,f,y,_,m=0;m<r;m++){c=a.at(m),h=c.get_m_x(),p=h.x(),u=h.y(),g=h.z()*e;var A=c.get_m_n();f=A.x(),y=A.y(),_=A.z()*e,n[3*m]=p,n[3*m+1]=u,n[3*m+2]=g,o[3*m]=f,o[3*m+1]=y,o[3*m+2]=_}var P=new N;P.positions=n,P.normals=o,P.uvs=i.getVerticesData(x.UVKind),P.colors=i.getVerticesData(x.ColorKind),i&&i.getIndices&&(P.indices=i.getIndices()),P.applyToMesh(i)},s.prototype.applyImpulse=function(t,e,i){if(t.soft)v.Warn("Cannot be applied to a soft body");else{t.physicsBody.activate();var n=this._tmpAmmoVectorA,o=this._tmpAmmoVectorB;t.object&&t.object.getWorldMatrix&&i.subtractInPlace(t.object.getWorldMatrix().getTranslation()),n.setValue(i.x,i.y,i.z),o.setValue(e.x,e.y,e.z),t.physicsBody.applyImpulse(o,n)}},s.prototype.applyForce=function(t,e,i){if(t.soft)v.Warn("Cannot be applied to a soft body");else{t.physicsBody.activate();var n=this._tmpAmmoVectorA,o=this._tmpAmmoVectorB;if(t.object&&t.object.getWorldMatrix){var r=t.object.getWorldMatrix().getTranslation();n.setValue(i.x-r.x,i.y-r.y,i.z-r.z)}else n.setValue(i.x,i.y,i.z);o.setValue(e.x,e.y,e.z),t.physicsBody.applyForce(o,n)}},s.prototype.generatePhysicsBody=function(t){if(t._pluginData.toDispose=[],t.parent){t.physicsBody&&(this.removePhysicsBody(t),t.forceUpdate());return}if(t.isBodyInitRequired()){var e=this._createShape(t),i=t.getParam("mass");if(t._pluginData.mass=i,t.soft)e.get_m_cfg().set_collisions(17),e.get_m_cfg().set_kDP(t.getParam("damping")),this.bjsAMMO.castObject(e,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(t.getParam("margin")),e.setActivationState(s._DISABLE_DEACTIVATION_FLAG),this.world.addSoftBody(e,1,-1),t.physicsBody=e,t._pluginData.toDispose.push(e),this.setBodyPressure(t,0),t.type===d.SoftbodyImpostor&&this.setBodyPressure(t,t.getParam("pressure")),this.setBodyStiffness(t,t.getParam("stiffness")),this.setBodyVelocityIterations(t,t.getParam("velocityIterations")),this.setBodyPositionIterations(t,t.getParam("positionIterations"));else{var n=new this.bjsAMMO.btVector3(0,0,0),o=new this.bjsAMMO.btTransform;t.object.computeWorldMatrix(!0),o.setIdentity(),i!==0&&e.calculateLocalInertia(i,n),this._tmpAmmoVectorA.setValue(t.object.position.x,t.object.position.y,t.object.position.z),this._tmpAmmoQuaternion.setValue(t.object.rotationQuaternion.x,t.object.rotationQuaternion.y,t.object.rotationQuaternion.z,t.object.rotationQuaternion.w),o.setOrigin(this._tmpAmmoVectorA),o.setRotation(this._tmpAmmoQuaternion);var r=new this.bjsAMMO.btDefaultMotionState(o),a=new this.bjsAMMO.btRigidBodyConstructionInfo(i,r,e,n),c=new this.bjsAMMO.btRigidBody(a);if(i===0&&(c.setCollisionFlags(c.getCollisionFlags()|s._KINEMATIC_FLAG),c.setActivationState(s._DISABLE_DEACTIVATION_FLAG)),t.type==d.NoImpostor&&!e.getChildShape&&c.setCollisionFlags(c.getCollisionFlags()|s._DISABLE_COLLISION_FLAG),t.type!==d.MeshImpostor&&t.type!==d.NoImpostor){var h=t.object.getBoundingInfo();this._tmpVec3.copyFrom(t.object.getAbsolutePosition()),this._tmpVec3.subtractInPlace(h.boundingBox.centerWorld),this._tmpVec3.x/=t.object.scaling.x,this._tmpVec3.y/=t.object.scaling.y,this._tmpVec3.z/=t.object.scaling.z,t.setDeltaPosition(this._tmpVec3)}var p=t.getParam("group"),u=t.getParam("mask");p&&u?this.world.addRigidBody(c,p,u):this.world.addRigidBody(c),t.physicsBody=c,t._pluginData.toDispose=t._pluginData.toDispose.concat([c,a,r,o,n,e])}this.setBodyRestitution(t,t.getParam("restitution")),this.setBodyFriction(t,t.getParam("friction"))}},s.prototype.removePhysicsBody=function(t){var e=this;this.world&&(t.soft?this.world.removeSoftBody(t.physicsBody):this.world.removeRigidBody(t.physicsBody),t._pluginData&&(t._pluginData.toDispose.forEach(function(i){e.bjsAMMO.destroy(i)}),t._pluginData.toDispose=[]))},s.prototype.generateJoint=function(t){var e=t.mainImpostor.physicsBody,i=t.connectedImpostor.physicsBody;if(!(!e||!i)){var n=t.joint.jointData;n.mainPivot||(n.mainPivot=new l(0,0,0)),n.connectedPivot||(n.connectedPivot=new l(0,0,0));var o;switch(t.joint.type){case b.DistanceJoint:{var r=n.maxDistance;r&&(n.mainPivot=new l(0,-r/2,0),n.connectedPivot=new l(0,r/2,0)),o=new this.bjsAMMO.btPoint2PointConstraint(e,i,new this.bjsAMMO.btVector3(n.mainPivot.x,n.mainPivot.y,n.mainPivot.z),new this.bjsAMMO.btVector3(n.connectedPivot.x,n.connectedPivot.y,n.connectedPivot.z));break}case b.HingeJoint:{n.mainAxis||(n.mainAxis=new l(0,0,0)),n.connectedAxis||(n.connectedAxis=new l(0,0,0));var a=new this.bjsAMMO.btVector3(n.mainAxis.x,n.mainAxis.y,n.mainAxis.z),c=new this.bjsAMMO.btVector3(n.connectedAxis.x,n.connectedAxis.y,n.connectedAxis.z);o=new this.bjsAMMO.btHingeConstraint(e,i,new this.bjsAMMO.btVector3(n.mainPivot.x,n.mainPivot.y,n.mainPivot.z),new this.bjsAMMO.btVector3(n.connectedPivot.x,n.connectedPivot.y,n.connectedPivot.z),a,c);break}case b.BallAndSocketJoint:o=new this.bjsAMMO.btPoint2PointConstraint(e,i,new this.bjsAMMO.btVector3(n.mainPivot.x,n.mainPivot.y,n.mainPivot.z),new this.bjsAMMO.btVector3(n.connectedPivot.x,n.connectedPivot.y,n.connectedPivot.z));break;default:v.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint"),o=new this.bjsAMMO.btPoint2PointConstraint(e,i,new this.bjsAMMO.btVector3(n.mainPivot.x,n.mainPivot.y,n.mainPivot.z),new this.bjsAMMO.btVector3(n.connectedPivot.x,n.connectedPivot.y,n.connectedPivot.z));break}this.world.addConstraint(o,!t.joint.jointData.collision),t.joint.physicsJoint=o}},s.prototype.removeJoint=function(t){this.world&&this.world.removeConstraint(t.joint.physicsJoint)},s.prototype._addMeshVerts=function(t,e,i){var n=this,o=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){var r=i.getIndices();r||(r=[]);var a=i.getVerticesData(x.PositionKind);a||(a=[]);var c=void 0;if(e&&e!==i){var h=void 0;e.rotationQuaternion?h=e.rotationQuaternion:e.rotation?h=B.FromEulerAngles(e.rotation.x,e.rotation.y,e.rotation.z):h=B.Identity();var p=w.Compose(l.One(),h,e.position);p.invertToRef(this._tmpMatrix);var u=i.computeWorldMatrix(!1);c=u.multiply(this._tmpMatrix)}else w.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),c=this._tmpMatrix;for(var g=r.length/3,f=0;f<g;f++){for(var y=[],_=0;_<3;_++){var m=new l(a[r[f*3+_]*3+0],a[r[f*3+_]*3+1],a[r[f*3+_]*3+2]);m=l.TransformCoordinates(m,c);var A=void 0;_==0?A=this._tmpAmmoVectorA:_==1?A=this._tmpAmmoVectorB:A=this._tmpAmmoVectorC,A.setValue(m.x,m.y,m.z),y.push(A)}t.addTriangle(y[0],y[1],y[2]),o++}i.getChildMeshes().forEach(function(P){o+=n._addMeshVerts(t,e,P)})}return o},s.prototype._softVertexData=function(t){var e=t.object;if(e&&e.getIndices&&e.getWorldMatrix&&e.getChildMeshes){e.getIndices();var i=e.getVerticesData(x.PositionKind);i||(i=[]);var n=e.getVerticesData(x.NormalKind);n||(n=[]),e.computeWorldMatrix(!1);for(var o=[],r=[],a=0;a<i.length;a+=3){var c=new l(i[a],i[a+1],i[a+2]),h=new l(n[a],n[a+1],n[a+2]);c=l.TransformCoordinates(c,e.getWorldMatrix()),h=l.TransformNormal(h,e.getWorldMatrix()),o.push(c.x,c.y,c.z),r.push(h.x,h.y,h.z)}var p=new N;return p.positions=o,p.normals=r,p.uvs=e.getVerticesData(x.UVKind),p.colors=e.getVerticesData(x.ColorKind),e&&e.getIndices&&(p.indices=e.getIndices()),p.applyToMesh(e),e.position=l.Zero(),e.rotationQuaternion=null,e.rotation=l.Zero(),e.computeWorldMatrix(!0),p}return N.ExtractFromMesh(e)},s.prototype._createSoftbody=function(t){var e=t.object;if(e&&e.getIndices){var i=e.getIndices();i||(i=[]);var n=this._softVertexData(t),o=n.positions,r=n.normals;if(o===null||r===null)return new this.bjsAMMO.btCompoundShape;for(var a=[],c=[],h=0;h<o.length;h+=3){var p=new l(o[h],o[h+1],o[h+2]),u=new l(r[h],r[h+1],r[h+2]);a.push(p.x,p.y,-p.z),c.push(u.x,u.y,-u.z)}for(var g=new this.bjsAMMO.btSoftBodyHelpers().CreateFromTriMesh(this.world.getWorldInfo(),a,e.getIndices(),i.length/3,!0),f=o.length/3,y=g.get_m_nodes(),_=void 0,m=void 0,h=0;h<f;h++)_=y.at(h),m=_.get_m_n(),m.setX(c[3*h]),m.setY(c[3*h+1]),m.setZ(c[3*h+2]);return g}},s.prototype._createCloth=function(t){var e=t.object;if(e&&e.getIndices){e.getIndices();var i=this._softVertexData(t),n=i.positions,o=i.normals;if(n===null||o===null)return new this.bjsAMMO.btCompoundShape;var r=n.length,a=Math.sqrt(r/3);t.segments=a;var c=a-1;this._tmpAmmoVectorA.setValue(n[0],n[1],n[2]),this._tmpAmmoVectorB.setValue(n[3*c],n[3*c+1],n[3*c+2]),this._tmpAmmoVectorD.setValue(n[r-3],n[r-2],n[r-1]),this._tmpAmmoVectorC.setValue(n[r-3-3*c],n[r-2-3*c],n[r-1-3*c]);var h=new this.bjsAMMO.btSoftBodyHelpers().CreatePatch(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,this._tmpAmmoVectorC,this._tmpAmmoVectorD,a,a,t.getParam("fixedPoints"),!0);return h}},s.prototype._createRope=function(t){var e,i,n=this._softVertexData(t),o=n.positions,r=n.normals;if(o===null||r===null)return new this.bjsAMMO.btCompoundShape;n.applyToMesh(t.object,!0),t._isFromLine=!0;var a=r.map(function(y){return y*y}),c=function(y,_){return y+_},h=a.reduce(c);if(h===0)e=o.length,i=e/3-1,this._tmpAmmoVectorA.setValue(o[0],o[1],o[2]),this._tmpAmmoVectorB.setValue(o[e-3],o[e-2],o[e-1]);else{t._isFromLine=!1;var p=t.getParam("path"),u=t.getParam("shape");if(u===null)return v.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;e=p.length,i=e-1,this._tmpAmmoVectorA.setValue(p[0].x,p[0].y,p[0].z),this._tmpAmmoVectorB.setValue(p[e-1].x,p[e-1].y,p[e-1].z)}t.segments=i;var g=t.getParam("fixedPoints");g=g>3?3:g;var f=new this.bjsAMMO.btSoftBodyHelpers().CreateRope(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,i-1,g);return f.get_m_cfg().set_collisions(17),f},s.prototype._createCustom=function(t){var e=null;return this.onCreateCustomShape&&(e=this.onCreateCustomShape(t)),e==null&&(e=new this.bjsAMMO.btCompoundShape),e},s.prototype._addHullVerts=function(t,e,i){var n=this,o=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){var r=i.getIndices();r||(r=[]);var a=i.getVerticesData(x.PositionKind);a||(a=[]),i.computeWorldMatrix(!1);for(var c=r.length/3,h=0;h<c;h++){for(var p=[],u=0;u<3;u++){var g=new l(a[r[h*3+u]*3+0],a[r[h*3+u]*3+1],a[r[h*3+u]*3+2]);w.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),g=l.TransformCoordinates(g,this._tmpMatrix);var f=void 0;u==0?f=this._tmpAmmoVectorA:u==1?f=this._tmpAmmoVectorB:f=this._tmpAmmoVectorC,f.setValue(g.x,g.y,g.z),p.push(f)}t.addPoint(p[0],!0),t.addPoint(p[1],!0),t.addPoint(p[2],!0),o++}i.getChildMeshes().forEach(function(y){o+=n._addHullVerts(t,e,y)})}return o},s.prototype._createShape=function(t,e){var i=this;e===void 0&&(e=!1);var n=t.object,o,r=t.getObjectExtents();if(!e){var a=t.object.getChildMeshes?t.object.getChildMeshes(!0):[];o=new this.bjsAMMO.btCompoundShape;var c=0;if(a.forEach(function(m){var A=m.getPhysicsImpostor();if(A){if(A.type==d.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";var P=i._createShape(A),S=m.parent.getWorldMatrix().clone(),M=new l;S.decompose(M),i._tmpAmmoTransform.getOrigin().setValue(m.position.x*M.x,m.position.y*M.y,m.position.z*M.z),i._tmpAmmoQuaternion.setValue(m.rotationQuaternion.x,m.rotationQuaternion.y,m.rotationQuaternion.z,m.rotationQuaternion.w),i._tmpAmmoTransform.setRotation(i._tmpAmmoQuaternion),o.addChildShape(i._tmpAmmoTransform,P),A.dispose(),c++}}),c>0){if(t.type!=d.NoImpostor){var h=this._createShape(t,!0);h&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),o.addChildShape(this._tmpAmmoTransform,h))}return o}else this.bjsAMMO.destroy(o),o=null}switch(t.type){case d.SphereImpostor:if(J.WithinEpsilon(r.x,r.y,1e-4)&&J.WithinEpsilon(r.x,r.z,1e-4))o=new this.bjsAMMO.btSphereShape(r.x/2);else{var p=[new this.bjsAMMO.btVector3(0,0,0)],u=[1];o=new this.bjsAMMO.btMultiSphereShape(p,u,1),o.setLocalScaling(new this.bjsAMMO.btVector3(r.x/2,r.y/2,r.z/2))}break;case d.CapsuleImpostor:{var g=r.x/2;o=new this.bjsAMMO.btCapsuleShape(g,r.y-g*2)}break;case d.CylinderImpostor:this._tmpAmmoVectorA.setValue(r.x/2,r.y/2,r.z/2),o=new this.bjsAMMO.btCylinderShape(this._tmpAmmoVectorA);break;case d.PlaneImpostor:case d.BoxImpostor:this._tmpAmmoVectorA.setValue(r.x/2,r.y/2,r.z/2),o=new this.bjsAMMO.btBoxShape(this._tmpAmmoVectorA);break;case d.MeshImpostor:if(t.getParam("mass")==0){if(this.onCreateCustomMeshImpostor)o=this.onCreateCustomMeshImpostor(t);else{var f=new this.bjsAMMO.btTriangleMesh;t._pluginData.toDispose.push(f);var y=this._addMeshVerts(f,n,n);y==0?o=new this.bjsAMMO.btCompoundShape:o=new this.bjsAMMO.btBvhTriangleMeshShape(f)}break}case d.ConvexHullImpostor:{if(this.onCreateCustomConvexHullImpostor)o=this.onCreateCustomConvexHullImpostor(t);else{var _=new this.bjsAMMO.btConvexHullShape,y=this._addHullVerts(_,n,n);y==0?(t._pluginData.toDispose.push(_),o=new this.bjsAMMO.btCompoundShape):o=_}break}case d.NoImpostor:o=new this.bjsAMMO.btSphereShape(r.x/2);break;case d.CustomImpostor:o=this._createCustom(t);break;case d.SoftbodyImpostor:o=this._createSoftbody(t);break;case d.ClothImpostor:o=this._createCloth(t);break;case d.RopeImpostor:o=this._createRope(t);break;default:v.Warn("The impostor type is not currently supported by the ammo plugin.");break}return o},s.prototype.setTransformationFromPhysicsBody=function(t){t.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),t.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),t.object.rotationQuaternion?t.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):t.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(t.object.rotation))},s.prototype.setPhysicsBodyTransformation=function(t,e,i){var n=t.physicsBody.getWorldTransform();if(Math.abs(n.getOrigin().x()-e.x)>C||Math.abs(n.getOrigin().y()-e.y)>C||Math.abs(n.getOrigin().z()-e.z)>C||Math.abs(n.getRotation().x()-i.x)>C||Math.abs(n.getRotation().y()-i.y)>C||Math.abs(n.getRotation().z()-i.z)>C||Math.abs(n.getRotation().w()-i.w)>C)if(this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),n.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(i.x,i.y,i.z,i.w),n.setRotation(this._tmpAmmoQuaternion),t.physicsBody.setWorldTransform(n),t.mass==0){var o=t.physicsBody.getMotionState();o&&o.setWorldTransform(n)}else t.physicsBody.activate()},s.prototype.isSupported=function(){return this.bjsAMMO!==void 0},s.prototype.setLinearVelocity=function(t,e){this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),t.soft?t.physicsBody.linearVelocity(this._tmpAmmoVectorA):t.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)},s.prototype.setAngularVelocity=function(t,e){this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),t.soft?t.physicsBody.angularVelocity(this._tmpAmmoVectorA):t.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)},s.prototype.getLinearVelocity=function(t){var e;if(t.soft?e=t.physicsBody.linearVelocity():e=t.physicsBody.getLinearVelocity(),!e)return null;var i=new l(e.x(),e.y(),e.z());return this.bjsAMMO.destroy(e),i},s.prototype.getAngularVelocity=function(t){var e;if(t.soft?e=t.physicsBody.angularVelocity():e=t.physicsBody.getAngularVelocity(),!e)return null;var i=new l(e.x(),e.y(),e.z());return this.bjsAMMO.destroy(e),i},s.prototype.setBodyMass=function(t,e){t.soft?t.physicsBody.setTotalMass(e,!1):t.physicsBody.setMassProps(e),t._pluginData.mass=e},s.prototype.getBodyMass=function(t){return t._pluginData.mass||0},s.prototype.getBodyFriction=function(t){return t._pluginData.friction||0},s.prototype.setBodyFriction=function(t,e){t.soft?t.physicsBody.get_m_cfg().set_kDF(e):t.physicsBody.setFriction(e),t._pluginData.friction=e},s.prototype.getBodyRestitution=function(t){return t._pluginData.restitution||0},s.prototype.setBodyRestitution=function(t,e){t.physicsBody.setRestitution(e),t._pluginData.restitution=e},s.prototype.getBodyPressure=function(t){return t.soft?t._pluginData.pressure||0:(v.Warn("Pressure is not a property of a rigid body"),0)},s.prototype.setBodyPressure=function(t,e){t.soft?t.type===d.SoftbodyImpostor?(t.physicsBody.get_m_cfg().set_kPR(e),t._pluginData.pressure=e):(t.physicsBody.get_m_cfg().set_kPR(0),t._pluginData.pressure=0):v.Warn("Pressure can only be applied to a softbody")},s.prototype.getBodyStiffness=function(t){return t.soft?t._pluginData.stiffness||0:(v.Warn("Stiffness is not a property of a rigid body"),0)},s.prototype.setBodyStiffness=function(t,e){t.soft?(e=e<0?0:e,e=e>1?1:e,t.physicsBody.get_m_materials().at(0).set_m_kLST(e),t._pluginData.stiffness=e):v.Warn("Stiffness cannot be applied to a rigid body")},s.prototype.getBodyVelocityIterations=function(t){return t.soft?t._pluginData.velocityIterations||0:(v.Warn("Velocity iterations is not a property of a rigid body"),0)},s.prototype.setBodyVelocityIterations=function(t,e){t.soft?(e=e<0?0:e,t.physicsBody.get_m_cfg().set_viterations(e),t._pluginData.velocityIterations=e):v.Warn("Velocity iterations cannot be applied to a rigid body")},s.prototype.getBodyPositionIterations=function(t){return t.soft?t._pluginData.positionIterations||0:(v.Warn("Position iterations is not a property of a rigid body"),0)},s.prototype.setBodyPositionIterations=function(t,e){t.soft?(e=e<0?0:e,t.physicsBody.get_m_cfg().set_piterations(e),t._pluginData.positionIterations=e):v.Warn("Position iterations cannot be applied to a rigid body")},s.prototype.appendAnchor=function(t,e,i,n,o,r){o===void 0&&(o=1),r===void 0&&(r=!1);var a=t.segments,c=Math.round((a-1)*i),h=Math.round((a-1)*n),p=a-1-h,u=c+a*p;t.physicsBody.appendAnchor(u,e.physicsBody,r,o)},s.prototype.appendHook=function(t,e,i,n,o){n===void 0&&(n=1),o===void 0&&(o=!1);var r=Math.round(t.segments*i);t.physicsBody.appendAnchor(r,e.physicsBody,o,n)},s.prototype.sleepBody=function(t){t.physicsBody.forceActivationState(0)},s.prototype.wakeUpBody=function(t){t.physicsBody.activate()},s.prototype.updateDistanceJoint=function(){v.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")},s.prototype.setMotor=function(t,e,i){t.physicsJoint.enableAngularMotor(!0,e,i)},s.prototype.setLimit=function(){v.Warn("setLimit is not currently supported by the Ammo physics plugin")},s.prototype.syncMeshWithImpostor=function(t,e){var i=e.physicsBody;i.getMotionState().getWorldTransform(this._tmpAmmoTransform),t.position.x=this._tmpAmmoTransform.getOrigin().x(),t.position.y=this._tmpAmmoTransform.getOrigin().y(),t.position.z=this._tmpAmmoTransform.getOrigin().z(),t.rotationQuaternion&&(t.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),t.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),t.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),t.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())},s.prototype.getRadius=function(t){var e=t.getObjectExtents();return e.x/2},s.prototype.getBoxSizeToRef=function(t,e){var i=t.getObjectExtents();e.x=i.x,e.y=i.y,e.z=i.z},s.prototype.dispose=function(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this._solver),this.bjsAMMO.destroy(this._overlappingPairCache),this.bjsAMMO.destroy(this._dispatcher),this.bjsAMMO.destroy(this._collisionConfiguration),this.bjsAMMO.destroy(this._tmpAmmoVectorA),this.bjsAMMO.destroy(this._tmpAmmoVectorB),this.bjsAMMO.destroy(this._tmpAmmoVectorC),this.bjsAMMO.destroy(this._tmpAmmoTransform),this.bjsAMMO.destroy(this._tmpAmmoQuaternion),this.bjsAMMO.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null},s.prototype.raycast=function(t,e){this._tmpAmmoVectorRCA=new this.bjsAMMO.btVector3(t.x,t.y,t.z),this._tmpAmmoVectorRCB=new this.bjsAMMO.btVector3(e.x,e.y,e.z);var i=new this.bjsAMMO.ClosestRayResultCallback(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB);return this.world.rayTest(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB,i),this._raycastResult.reset(t,e),i.hasHit()&&(this._raycastResult.setHitData({x:i.get_m_hitNormalWorld().x(),y:i.get_m_hitNormalWorld().y(),z:i.get_m_hitNormalWorld().z()},{x:i.get_m_hitPointWorld().x(),y:i.get_m_hitPointWorld().y(),z:i.get_m_hitPointWorld().z()}),this._raycastResult.calculateHitDistance()),this.bjsAMMO.destroy(i),this.bjsAMMO.destroy(this._tmpAmmoVectorRCA),this.bjsAMMO.destroy(this._tmpAmmoVectorRCB),this._raycastResult},s._DISABLE_COLLISION_FLAG=4,s._KINEMATIC_FLAG=2,s._DISABLE_DEACTIVATION_FLAG=4,s}();I.prototype.getPhysicsEngine=function(){return this._physicsEngine};I.prototype.enablePhysics=function(s,t){if(s===void 0&&(s=null),this._physicsEngine)return!0;var e=this._getComponent(H.NAME_PHYSICSENGINE);e||(e=new q(this),this._addComponent(e));try{return this._physicsEngine=new O(s,t),this._physicsTimeAccumulator=0,!0}catch(i){return v.Error(i.message),!1}};I.prototype.disablePhysicsEngine=function(){!this._physicsEngine||(this._physicsEngine.dispose(),this._physicsEngine=null)};I.prototype.isPhysicsEnabled=function(){return this._physicsEngine!==void 0};I.prototype.deleteCompoundImpostor=function(s){var t=s.parts[0].mesh;t.physicsImpostor&&(t.physicsImpostor.dispose(),t.physicsImpostor=null)};I.prototype._advancePhysicsEngineStep=function(s){if(this._physicsEngine){var t=this._physicsEngine.getSubTimeStep();if(t>0)for(this._physicsTimeAccumulator+=s;this._physicsTimeAccumulator>t;)this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(t/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this._physicsTimeAccumulator-=t;else this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(s/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}};Object.defineProperty(V.prototype,"physicsImpostor",{get:function(){return this._physicsImpostor},set:function(s){var t=this;this._physicsImpostor!==s&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsImpostor=s,s&&(this._disposePhysicsObserver=this.onDisposeObservable.add(function(){t.physicsImpostor&&(t.physicsImpostor.dispose(),t.physicsImpostor=null)})))},enumerable:!0,configurable:!0});V.prototype.getPhysicsImpostor=function(){return this.physicsImpostor};V.prototype.applyImpulse=function(s,t){return this.physicsImpostor?(this.physicsImpostor.applyImpulse(s,t),this):this};V.prototype.setPhysicsLinkWith=function(s,t,e,i){return!this.physicsImpostor||!s.physicsImpostor?this:(this.physicsImpostor.createJoint(s.physicsImpostor,b.HingeJoint,{mainPivot:t,connectedPivot:e,nativeParams:i}),this)};var q=function(){function s(t){var e=this;this.name=H.NAME_PHYSICSENGINE,this.scene=t,this.scene.onBeforePhysicsObservable=new k,this.scene.onAfterPhysicsObservable=new k,this.scene.getDeterministicFrameTime=function(){return e.scene._physicsEngine?e.scene._physicsEngine.getTimeStep()*1e3:1e3/60}}return s.prototype.register=function(){},s.prototype.rebuild=function(){},s.prototype.dispose=function(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()},s}(),yt=Object.freeze(Object.defineProperty({__proto__:null,PhysicsEngineSceneComponent:q},Symbol.toStringTag,{value:"Module"})),F;(function(s){s[s.Constant=0]="Constant",s[s.Linear=1]="Linear"})(F||(F={}));var L;(function(s){s[s.Center=0]="Center",s[s.Perpendicular=1]="Perpendicular"})(L||(L={}));export{pt as A,tt as C,ht as O,d as P,b as a,yt as p};
