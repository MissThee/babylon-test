import{_ as O,j as h}from"./precisionDate.1704d4c6.js";import{S as T,k as L,s as l,l as m}from"./decorators.5af14a95.js";import{Vector3 as S}from"./math.vector.560c6bc4.js";import{TmpColors as M,Color3 as g}from"./math.color.d29cb8ed.js";import{N as E}from"./node.3cceef8b.js";import{L as a,U as N}from"./lightConstants.176abcb0.js";import{G as A}from"./arrayTools.49279cc5.js";var F=function(I){O(t,I);function t(e,n){var i=I.call(this,e,n)||this;return i.diffuse=new g(1,1,1),i.specular=new g(1,1,1),i.falloffType=t.FALLOFF_DEFAULT,i.intensity=1,i._range=Number.MAX_VALUE,i._inverseSquaredRange=0,i._photometricScale=1,i._intensityMode=t.INTENSITYMODE_AUTOMATIC,i._radius=1e-5,i.renderPriority=0,i._shadowEnabled=!0,i._excludeWithLayerMask=0,i._includeOnlyWithLayerMask=0,i._lightmapMode=0,i._excludedMeshesIds=new Array,i._includedOnlyMeshesIds=new Array,i._isLight=!0,i.getScene().addLight(i),i._uniformBuffer=new N(i.getScene().getEngine(),void 0,void 0,e),i._buildUniformLayout(),i.includedOnlyMeshes=new Array,i.excludedMeshes=new Array,i._resyncMeshes(),i}return Object.defineProperty(t.prototype,"range",{get:function(){return this._range},set:function(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"intensityMode",{get:function(){return this._intensityMode},set:function(e){this._intensityMode=e,this._computePhotometricScale()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"radius",{get:function(){return this._radius},set:function(e){this._radius=e,this._computePhotometricScale()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shadowEnabled",{get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"includedOnlyMeshes",{get:function(){return this._includedOnlyMeshes},set:function(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"excludedMeshes",{get:function(){return this._excludedMeshes},set:function(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"excludeWithLayerMask",{get:function(){return this._excludeWithLayerMask},set:function(e){this._excludeWithLayerMask=e,this._resyncMeshes()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"includeOnlyWithLayerMask",{get:function(){return this._includeOnlyWithLayerMask},set:function(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lightmapMode",{get:function(){return this._lightmapMode},set:function(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),t.prototype.transferTexturesToEffect=function(e,n){return this},t.prototype._bindLight=function(e,n,i,r,s){s===void 0&&(s=!0);var o=e.toString(),u=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+o),this._renderId!==n.getRenderId()||this._lastUseSpecular!==r||!this._uniformBuffer.useUbo){this._renderId=n.getRenderId(),this._lastUseSpecular=r;var d=this.getScaledIntensity();this.transferToEffect(i,o),this.diffuse.scaleToRef(d,M.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",M.Color3[0],this.range,o),r&&(this.specular.scaleToRef(d,M.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",M.Color3[1],this.radius,o)),u=!0}if(this.transferTexturesToEffect(i,o),n.shadowsEnabled&&this.shadowEnabled&&s){var c=this.getShadowGenerator();c&&(c.bindShadowLight(o,i),u=!0)}u?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()},t.prototype.getClassName=function(){return"Light"},t.prototype.toString=function(e){var n="Name: "+this.name;if(n+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(var i=0;i<this.animations.length;i++)n+=", animation[0]: "+this.animations[i].toString(e);return n},t.prototype._syncParentEnabledState=function(){I.prototype._syncParentEnabledState.call(this),this.isDisposed()||this._resyncMeshes()},t.prototype.setEnabled=function(e){I.prototype.setEnabled.call(this,e),this._resyncMeshes()},t.prototype.getShadowGenerator=function(){return this._shadowGenerator},t.prototype.getAbsolutePosition=function(){return S.Zero()},t.prototype.canAffectMesh=function(e){return e?!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(e)===-1||this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1||this.includeOnlyWithLayerMask!==0&&(this.includeOnlyWithLayerMask&e.layerMask)===0||this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&e.layerMask):!0},t.prototype.dispose=function(e,n){if(n===void 0&&(n=!1),this._shadowGenerator&&(this._shadowGenerator.dispose(),this._shadowGenerator=null),this.getScene().stopAnimation(this),this._parentContainer){var i=this._parentContainer.lights.indexOf(this);i>-1&&this._parentContainer.lights.splice(i,1),this._parentContainer=null}for(var r=0,s=this.getScene().meshes;r<s.length;r++){var o=s[r];o._removeLightSource(this,!0)}this._uniformBuffer.dispose(),this.getScene().removeLight(this),I.prototype.dispose.call(this,e,n)},t.prototype.getTypeID=function(){return 0},t.prototype.getScaledIntensity=function(){return this._photometricScale*this.intensity},t.prototype.clone=function(e,n){n===void 0&&(n=null);var i=t.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;var r=T.Clone(i,this);return e&&(r.name=e),n&&(r.parent=n),r.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(r),r},t.prototype.serialize=function(){var e=T.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach(function(n){e.excludedMeshesIds.push(n.id)})),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(function(n){e.includedOnlyMeshesIds.push(n.id)})),T.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e},t.GetConstructorFromName=function(e,n,i){var r=E.Construct("Light_Type_"+e,n,i);return r||null},t.Parse=function(e,n){var i=t.GetConstructorFromName(e.type,e.name,n);if(!i)return null;var r=T.Parse(i,e,n);if(e.excludedMeshesIds&&(r._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(r._includedOnlyMeshesIds=e.includedOnlyMeshesIds),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.falloffType!==void 0&&(r.falloffType=e.falloffType),e.lightmapMode!==void 0&&(r.lightmapMode=e.lightmapMode),e.animations){for(var s=0;s<e.animations.length;s++){var o=e.animations[s],u=A("BABYLON.Animation");u&&r.animations.push(u.Parse(o))}E.ParseAnimationRanges(r,e,n)}return e.autoAnimate&&n.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&r.setEnabled(e.isEnabled),r},t.prototype._hookArrayForExcluded=function(e){var n=this,i=e.push;e.push=function(){for(var d=[],c=0;c<arguments.length;c++)d[c]=arguments[c];for(var y=i.apply(e,d),f=0,p=d;f<p.length;f++){var _=p[f];_._resyncLightSource(n)}return y};var r=e.splice;e.splice=function(d,c){for(var y=r.apply(e,[d,c]),f=0,p=y;f<p.length;f++){var _=p[f];_._resyncLightSource(n)}return y};for(var s=0,o=e;s<o.length;s++){var u=o[s];u._resyncLightSource(this)}},t.prototype._hookArrayForIncludedOnly=function(e){var n=this,i=e.push;e.push=function(){for(var s=[],o=0;o<arguments.length;o++)s[o]=arguments[o];var u=i.apply(e,s);return n._resyncMeshes(),u};var r=e.splice;e.splice=function(s,o){var u=r.apply(e,[s,o]);return n._resyncMeshes(),u},this._resyncMeshes()},t.prototype._resyncMeshes=function(){for(var e=0,n=this.getScene().meshes;e<n.length;e++){var i=n[e];i._resyncLightSource(this)}},t.prototype._markMeshesAsLightDirty=function(){for(var e=0,n=this.getScene().meshes;e<n.length;e++){var i=n[e];i.lightSources.indexOf(this)!==-1&&i._markSubMeshesAsLightDirty()}},t.prototype._computePhotometricScale=function(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()},t.prototype._getPhotometricScale=function(){var e=0,n=this.getTypeID(),i=this.intensityMode;switch(i===t.INTENSITYMODE_AUTOMATIC&&(n===t.LIGHTTYPEID_DIRECTIONALLIGHT?i=t.INTENSITYMODE_ILLUMINANCE:i=t.INTENSITYMODE_LUMINOUSINTENSITY),n){case t.LIGHTTYPEID_POINTLIGHT:case t.LIGHTTYPEID_SPOTLIGHT:switch(i){case t.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case t.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case t.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius;break}break;case t.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case t.INTENSITYMODE_ILLUMINANCE:e=1;break;case t.INTENSITYMODE_LUMINANCE:{var r=this.radius;r=Math.max(r,.001);var s=2*Math.PI*(1-Math.cos(r));e=s;break}}break;case t.LIGHTTYPEID_HEMISPHERICLIGHT:e=1;break}return e},t.prototype._reorderLightsInScene=function(){var e=this.getScene();this._renderPriority!=0&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()},t.FALLOFF_DEFAULT=a.FALLOFF_DEFAULT,t.FALLOFF_PHYSICAL=a.FALLOFF_PHYSICAL,t.FALLOFF_GLTF=a.FALLOFF_GLTF,t.FALLOFF_STANDARD=a.FALLOFF_STANDARD,t.LIGHTMAP_DEFAULT=a.LIGHTMAP_DEFAULT,t.LIGHTMAP_SPECULAR=a.LIGHTMAP_SPECULAR,t.LIGHTMAP_SHADOWSONLY=a.LIGHTMAP_SHADOWSONLY,t.INTENSITYMODE_AUTOMATIC=a.INTENSITYMODE_AUTOMATIC,t.INTENSITYMODE_LUMINOUSPOWER=a.INTENSITYMODE_LUMINOUSPOWER,t.INTENSITYMODE_LUMINOUSINTENSITY=a.INTENSITYMODE_LUMINOUSINTENSITY,t.INTENSITYMODE_ILLUMINANCE=a.INTENSITYMODE_ILLUMINANCE,t.INTENSITYMODE_LUMINANCE=a.INTENSITYMODE_LUMINANCE,t.LIGHTTYPEID_POINTLIGHT=a.LIGHTTYPEID_POINTLIGHT,t.LIGHTTYPEID_DIRECTIONALLIGHT=a.LIGHTTYPEID_DIRECTIONALLIGHT,t.LIGHTTYPEID_SPOTLIGHT=a.LIGHTTYPEID_SPOTLIGHT,t.LIGHTTYPEID_HEMISPHERICLIGHT=a.LIGHTTYPEID_HEMISPHERICLIGHT,h([L()],t.prototype,"diffuse",void 0),h([L()],t.prototype,"specular",void 0),h([l()],t.prototype,"falloffType",void 0),h([l()],t.prototype,"intensity",void 0),h([l()],t.prototype,"range",null),h([l()],t.prototype,"intensityMode",null),h([l()],t.prototype,"radius",null),h([l()],t.prototype,"_renderPriority",void 0),h([m("_reorderLightsInScene")],t.prototype,"renderPriority",void 0),h([l("shadowEnabled")],t.prototype,"_shadowEnabled",void 0),h([l("excludeWithLayerMask")],t.prototype,"_excludeWithLayerMask",void 0),h([l("includeOnlyWithLayerMask")],t.prototype,"_includeOnlyWithLayerMask",void 0),h([l("lightmapMode")],t.prototype,"_lightmapMode",void 0),t}(E);export{F as L};
